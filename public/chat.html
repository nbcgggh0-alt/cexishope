<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Support Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .msg-enter {
            animation: slideUp 0.3s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Beautiful subtle pattern background for the chat area */
        .chat-bg {
            background-color: #e5e5f7;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }
    </style>
</head>

<body class="h-screen flex flex-col items-center justify-center p-0 sm:p-4">

    <!-- Main App Container -->
    <div
        class="w-full h-full sm:h-[90vh] sm:max-w-md bg-white sm:rounded-3xl shadow-2xl flex flex-col overflow-hidden relative">

        <!-- Header -->
        <header
            class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-5 py-4 flex items-center shadow-md z-10 w-full">
            <div
                class="relative w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl font-bold shadow-inner mr-3 shrink-0">
                üéß
                <div id="online-indicator"
                    class="absolute bottom-0 right-0 w-3 h-3 bg-red-400 border-2 border-indigo-600 rounded-full transition-colors duration-300">
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <h1 class="text-lg font-semibold truncate tracking-tight">CexiStore Support</h1>
                <p class="text-xs text-blue-100 font-medium tracking-wide" id="status-text">Connecting to server...</p>
            </div>
            <div class="text-[10px] uppercase font-bold tracking-wider bg-white/20 px-2 py-1 rounded">
                Ticket: <br><span id="token-display" class="font-mono text-white">...</span>
            </div>
        </header>

        <!-- Chat Area -->
        <main class="flex-1 overflow-y-auto p-4 chat-bg flex flex-col gap-4 relative" id="chat-box">
            <div class="text-center w-full flex justify-center mt-2">
                <span
                    class="bg-white/80 text-gray-500 text-xs px-3 py-1 rounded-full shadow-sm glass-panel font-medium">
                    Loading chat history...
                </span>
            </div>
        </main>

        <!-- Input Area -->
        <footer class="p-3 bg-white border-t border-gray-100 z-10">
            <form id="chat-form" class="flex items-end gap-2 relative">
                <div
                    class="flex-1 bg-gray-100 rounded-2xl border border-transparent focus-within:border-blue-400 focus-within:bg-white focus-within:ring-4 focus-within:ring-blue-50 transition-all duration-200">
                    <textarea id="msg-input" rows="1" disabled
                        class="w-full bg-transparent px-4 py-3 text-sm focus:outline-none resize-none max-h-32"
                        placeholder="Type a message..." style="min-height: 44px;"></textarea>
                </div>
                <button type="submit" id="send-btn" disabled
                    class="bg-blue-600 hover:bg-indigo-600 text-white rounded-full w-11 h-11 flex items-center justify-center shrink-0 transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed shadow-md">
                    <svg class="w-5 h-5 translate-x-[1px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </form>
        </footer>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        const role = params.get('role') || 'user';

        const chatBox = document.getElementById('chat-box');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('msg-input');
        const btn = document.getElementById('send-btn');
        const statusText = document.getElementById('status-text');
        const indicator = document.getElementById('online-indicator');

        // Auto-resize textarea
        input.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight < 120 ? this.scrollHeight : 120) + 'px';
            if (this.value.trim() === '') this.style.height = '44px';
        });

        // Submit on Enter (prevent default new line), Shift+Enter for new line
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                form.dispatchEvent(new Event('submit'));
            }
        });

        if (!token) {
            chatBox.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-center px-4">
                    <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center text-3xl mb-4 shadow-inner">‚ö†Ô∏è</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Invalid Link</h2>
                    <p class="text-gray-500 text-sm">Token is missing from the URL. Please use the link provided in the Telegram bot.</p>
                </div>`;
        } else {
            document.getElementById('token-display').innerText = token.substring(0, 6);

            const socket = io();

            socket.on('connect', () => {
                statusText.innerText = 'Online - Ready to help';
                indicator.classList.replace('bg-red-400', 'bg-green-400');
                input.disabled = false;
                btn.disabled = false;
                socket.emit('join_session', token);
                loadHistory();
            });

            socket.on('disconnect', () => {
                statusText.innerText = 'Disconnected - Reconnecting...';
                indicator.classList.replace('bg-green-400', 'bg-red-400');
                input.disabled = true;
                btn.disabled = true;
            });

            socket.on('error', (msg) => {
                statusText.innerText = 'Session Error';
                indicator.classList.replace('bg-green-400', 'bg-red-400');
                alert('System Error: ' + msg);
                input.disabled = true;
                btn.disabled = true;
            });

            socket.on('new_message', (msg) => {
                appendMessage(msg);
            });

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = input.value.trim();
                if (!text) return;

                socket.emit('send_message', {
                    token: token,
                    text: text,
                    sender: role
                });

                input.value = '';
                input.style.height = '44px';
                input.focus();
            });
        }

        async function loadHistory() {
            try {
                const res = await fetch(`/api/session/${token}`);
                if (!res.ok) throw new Error('Session not found');
                const session = await res.json();

                chatBox.innerHTML = '';

                if (session.messages.length === 0) {
                    const heroText = role === 'admin'
                        ? 'Support session opened. Type a message to reply to the user.'
                        : 'How can we help you today? An agent will be with you shortly.';

                    chatBox.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-center px-6 opacity-60">
                            <h3 class="font-semibold text-gray-700 mb-1">CexiStore Support</h3>
                            <p class="text-xs text-gray-500 leading-relaxed">${heroText}</p>
                        </div>`;
                } else {
                    session.messages.forEach(msg => appendMessage(msg));
                }
                setTimeout(scrollToBottom, 100);
            } catch (err) {
                chatBox.innerHTML = `
                    <div class="flex justify-center mt-4">
                        <span class="bg-red-50 text-red-600 text-xs px-4 py-2 rounded-lg border border-red-100 shadow-sm">
                            Failed to load history
                        </span>
                    </div>`;
            }
        }

        function appendMessage(msg) {
            // Clear placeholder if exists
            if (chatBox.innerHTML.includes('CexiStore Support</h3>')) {
                chatBox.innerHTML = '';
            }

            const isSystem = msg.from === 'system';
            const isMe = msg.from === role;

            const div = document.createElement('div');
            div.className = `flex w-full ${isSystem ? 'justify-center' : (isMe ? 'justify-end' : 'justify-start')} msg-enter`;

            const timeStr = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            let innerHtml = '';

            if (isSystem) {
                innerHtml = `
                    <div class="glass-panel text-gray-600 text-[11px] font-medium px-4 py-1.5 rounded-full flex items-center shadow-sm border border-gray-200 mt-2 mb-2">
                        ${msg.text}
                    </div>
                `;
            } else {
                const bgColor = isMe ? 'bg-blue-600 text-white' : 'bg-white text-gray-800 border border-gray-100';
                const corners = isMe ? 'rounded-2xl rounded-tr-sm' : 'rounded-2xl rounded-tl-sm';
                const shadow = isMe ? 'shadow-blue-500/20 shadow-md' : 'shadow-sm';

                let contentHtml = '';
                if (msg.type === 'media') {
                    contentHtml = `
                        <div class="text-[10px] mb-1.5 opacity-70 font-medium flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Telegram Media
                        </div>
                        <div class="whitespace-pre-wrap leading-relaxed text-sm">${escapeHTML(msg.caption || '')}</div>
                    `;
                } else {
                    contentHtml = `<div class="whitespace-pre-wrap leading-relaxed text-[14px]">${escapeHTML(msg.text || '')}</div>`;
                }

                innerHtml = `
                    <div class="max-w-[85%] sm:max-w-[75%] ${corners} ${bgColor} ${shadow} px-4 py-2.5 relative group">
                        ${contentHtml}
                        <div class="text-[10px] font-medium mt-1 ${isMe ? 'text-blue-200 text-right' : 'text-gray-400 text-right'}">${timeStr}</div>
                    </div>
                `;
            }

            div.innerHTML = innerHtml;
            chatBox.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatBox.scrollTo({
                top: chatBox.scrollHeight,
                behavior: 'smooth'
            });
        }

        function escapeHTML(str) {
            return str.replace(/[&<>'"]/g,
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag] || tag)
            );
        }
    </script>
</body>

</html>