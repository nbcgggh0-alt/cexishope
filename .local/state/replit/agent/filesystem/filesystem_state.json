{"file_contents":{"config.js":{"content":"module.exports = {\n  // Telegram Bot Token (WAJIB / REQUIRED)\n  // Dapatkan dari @BotFather di Telegram\n  TELEGRAM_BOT_TOKEN: process.env.TELEGRAM_BOT_TOKEN || '8285430975:AAFOYKVIW4RYY7dIIe16dtLSZoATYp5m8WU',\n  \n  // Dropbox Token (OPTIONAL - untuk backup)\n  // Dapatkan dari https://www.dropbox.com/developers/apps\n  // Tutorial: Baca DROPBOX_SETUP.md\n  DROPBOX_TOKEN: process.env.DROPBOX_TOKEN || '',\n  \n  // Google Drive Token (OPTIONAL - untuk backup failover)\n  GOOGLE_DRIVE_TOKEN: process.env.GOOGLE_DRIVE_TOKEN || '',\n  \n  // Owner Telegram ID (tukar dengan ID anda)\n  OWNER_ID: 8253048034,\n  \n  store: {\n    name: 'CexiStore Ultimate Pro',\n    currency: 'RM',\n    sessionTimeout: 14400000\n  },\n  \n  backup: {\n    interval: 300000,\n    enabled: true,\n    maxBackupFiles: 50\n  },\n  \n  autoPromote: {\n    enabled: true,\n    defaultInterval: 3600000\n  },\n  \n  paths: {\n    data: './data',\n    media: './media',\n    qr: './qr',\n    logs: './logs'\n  }\n};\n","size_bytes":958},"utils/helpers.js":{"content":"const { v4: uuidv4 } = require('uuid');\n\nfunction generateId(prefix = '') {\n  const uuid = uuidv4().split('-')[0].toUpperCase();\n  return prefix ? `${prefix}-${uuid}` : uuid;\n}\n\nfunction generateOrderId() {\n  return generateId('ORD');\n}\n\nfunction generateSessionToken() {\n  return generateId('SES');\n}\n\nfunction formatPrice(price) {\n  return `RM ${parseFloat(price).toFixed(2)}`;\n}\n\nfunction formatDate(date) {\n  return new Date(date).toLocaleString('en-MY', {\n    year: 'numeric',\n    month: 'short',\n    day: 'numeric',\n    hour: '2-digit',\n    minute: '2-digit'\n  });\n}\n\nfunction isSessionExpired(createdAt, timeout = 14400000) {\n  const now = Date.now();\n  const sessionTime = new Date(createdAt).getTime();\n  return (now - sessionTime) > timeout;\n}\n\nasync function delay(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nfunction sanitizeText(text) {\n  return text.replace(/[_*[\\]()~`>#+=|{}.!-]/g, '\\\\$&');\n}\n\nmodule.exports = {\n  generateId,\n  generateOrderId,\n  generateSessionToken,\n  formatPrice,\n  formatDate,\n  isSessionExpired,\n  delay,\n  sanitizeText\n};\n","size_bytes":1085},"README.md":{"content":"# CexiStore Ultimate Pro - Telegram Bot\n\nA comprehensive bilingual (Malay/English) Telegram e-commerce bot with 120+ functions for digital product sales, complete with FAQ, templates, and advanced features.\n\n## üöÄ Quick Start\n\n### 1. Get Your Telegram Bot Token\n\n1. Open Telegram and search for `@BotFather`\n2. Send `/newbot` to create a new bot\n3. Follow instructions to set name and username\n4. Copy the bot token you receive\n\n### 2. Configure Bot\n\nEdit `config.js` and add your bot token:\n\n```javascript\nmodule.exports = {\n  TELEGRAM_BOT_TOKEN: 'YOUR_BOT_TOKEN_HERE',  // Paste your token here\n  DROPBOX_TOKEN: 'YOUR_DROPBOX_TOKEN',         // For primary backup storage\n  OWNER_ID: null,\n  // ... rest of config\n};\n```\n\n**Optional - Secondary Backup (Google Drive):**\n```bash\nexport GOOGLE_DRIVE_TOKEN='your_google_drive_token_here'\n```\nThis enables automatic failover when Dropbox storage is full.\n\n### 3. Run the Bot\n\n```bash\nnpm start\n```\n\n## üìã Initial Setup\n\n### Set Yourself as Owner\n\n1. Start your bot in Telegram by searching for your bot username\n2. Send `/start` \n3. Send `/setowner` to become the owner\n4. You can now access Owner Panel\n\n### Add Admins\n\n```\n/addadmin [user_id]\n```\n\nGet user_id by having the user send `/start` to the bot, then check `data/users.json`\n\n## üõçÔ∏è Store Management\n\n### Add Categories\n\n```\n/addcategory Netflix\n/addcategory CapCut Premium\n```\n\n### Add Products\n\n```\n/addproduct [category_id] | [name] | [price] | [stock] | [description]\n\nExample:\n/addproduct CAT-ABC123 | Netflix Premium | 15.00 | 10 | 1 month subscription\n```\n\n**All products are manual delivery** - Admin will deliver items to customers after verification.\n\n### Upload QR Payment\n\nPlace your payment QR code image in the `qr/` folder and update `data/settings.json`:\n\n```json\n{\n  \"qrPayment\": {\n    \"path\": \"./qr/payment.jpg\"\n  }\n}\n```\n\n## üë§ User Features\n\n- üõí Browse and buy products\n- üí≥ QR code payment with proof upload (`/send` command)\n- üì¶ Order history and status tracking\n- üéÅ Access purchased digital items\n- üí¨ Live chat support with session system\n- üåê Switch language (Malay/English/Chinese/Tamil)\n- ‚ùì FAQ - View frequently asked questions\n- üìñ User Guide - Complete bot usage guide\n- üìã `/list` - View all available commands with buttons\n\n## üë®‚Äçüíº Admin Features\n\n### Order Management\n- üì• View and verify pending orders\n- ‚úÖ Approve orders: `/verify [order_id]`\n- ‚ùå Reject orders: `/reject [order_id]`\n- üîç Advanced order search: `/searchorder [query]`\n- üìä Filter orders: `/filterorders`\n- ‚úÖ Check all order IDs: `/checkallorderid`\n\n### Product Management\n- üì¶ Add/manage products and categories\n- üîÑ Duplicate products: `/duplicate [product_id]`\n- üìä View inventory history: `/inventory [product_id]`\n- üìà Adjust stock: `/adjuststock [product_id] [+/-num] [note]`\n- üìã List all products: `/listproducts`\n\n### User Management\n- üö´ Ban user: `/ban [user_id] [reason]`\n- ‚úÖ Unban user: `/unban [user_id]`\n- üè∑Ô∏è Tag user: `/tag [user_id] [tag]`\n- ‚ùå Remove tag: `/untag [user_id] [tag]`\n- üìã List banned users: `/bannedlist`\n\n### Quick Reply & FAQ System\n- üìù Add template: `/addtemplate [keyword] | [response]`\n- ‚ö° Quick template: `/qt [keyword]`\n- üìã List templates: `/templates`\n- üóëÔ∏è Delete template: `/deletetemplate [keyword]`\n- ‚ùì Add FAQ: `/addfaq [question] | [answer]`\n- üìã List FAQs: `/listfaqs`\n- üóëÔ∏è Delete FAQ: `/deletefaq [faq_id]`\n\n### Communication & Support\n- üí¨ Join support sessions: `/join [token]`\n- üö™ Leave session: `/leave`\n- üîö Close session: `/close`\n- üì¢ Broadcast messages to users\n- üìä View user feedbacks: `/feedbacks`\n\n### Other Admin Tools\n- üí± Change currency: `/currency`\n- üìã View all commands: `/list`\n\n## üëë Owner Features\n\n- üë• Manage admins\n  - `/setowner` - Set yourself as owner\n  - `/addadmin [user_id]` - Add admin\n  - `/removeadmin [user_id]` - Remove admin\n- ‚öôÔ∏è Store settings\n- üíæ Backup & restore\n- üîß Full system control\n- üìä Analytics and reports\n\n## üìÅ Project Structure\n\n```\n‚îú‚îÄ‚îÄ index.js              # Main bot file\n‚îú‚îÄ‚îÄ config.js             # Configuration (tokens, settings)\n‚îú‚îÄ‚îÄ handlers/             # Bot command handlers\n‚îÇ   ‚îú‚îÄ‚îÄ start.js          # Welcome & main menu\n‚îÇ   ‚îú‚îÄ‚îÄ products.js       # Product browsing & purchase\n‚îÇ   ‚îú‚îÄ‚îÄ payment.js        # Payment proof handling\n‚îÇ   ‚îú‚îÄ‚îÄ orders.js         # Order history\n‚îÇ   ‚îú‚îÄ‚îÄ admin.js          # Admin panel & functions\n‚îÇ   ‚îú‚îÄ‚îÄ owner.js          # Owner panel & management\n‚îÇ   ‚îú‚îÄ‚îÄ session.js        # Live chat support\n‚îÇ   ‚îú‚îÄ‚îÄ userManagement.js # Ban/unban/tag users\n‚îÇ   ‚îú‚îÄ‚îÄ orderSearch.js    # Advanced order search\n‚îÇ   ‚îú‚îÄ‚îÄ productManagement.js # Product operations\n‚îÇ   ‚îú‚îÄ‚îÄ autoReply.js      # Templates & FAQ system\n‚îÇ   ‚îú‚îÄ‚îÄ currency.js       # Currency settings\n‚îÇ   ‚îî‚îÄ‚îÄ feedback.js       # User feedback system\n‚îú‚îÄ‚îÄ utils/                # Utility functions\n‚îÇ   ‚îú‚îÄ‚îÄ database.js       # JSON database operations\n‚îÇ   ‚îú‚îÄ‚îÄ translations.js   # Multi-language support\n‚îÇ   ‚îú‚îÄ‚îÄ helpers.js        # Helper functions\n‚îÇ   ‚îî‚îÄ‚îÄ messageHelper.js  # Safe message editing\n‚îú‚îÄ‚îÄ data/                 # JSON database files\n‚îÇ   ‚îú‚îÄ‚îÄ users.json        # User accounts\n‚îÇ   ‚îú‚îÄ‚îÄ products.json     # Product catalog\n‚îÇ   ‚îú‚îÄ‚îÄ categories.json   # Product categories\n‚îÇ   ‚îú‚îÄ‚îÄ transactions.json # Order history\n‚îÇ   ‚îú‚îÄ‚îÄ sessions.json     # Support sessions\n‚îÇ   ‚îú‚îÄ‚îÄ admins.json       # Admin & owner list\n‚îÇ   ‚îú‚îÄ‚îÄ settings.json     # Store settings\n‚îÇ   ‚îú‚îÄ‚îÄ templates.json    # Quick reply templates (30+ templates)\n‚îÇ   ‚îú‚îÄ‚îÄ faqs.json         # FAQ database (15+ FAQs)\n‚îÇ   ‚îî‚îÄ‚îÄ feedbacks.json    # User feedback\n‚îú‚îÄ‚îÄ media/                # Media files\n‚îú‚îÄ‚îÄ qr/                   # QR code images\n‚îî‚îÄ‚îÄ logs/                 # Log files & receipts\n```\n\n## üîê Payment Flow\n\n1. User browses products and clicks \"Buy Now\"\n2. Bot sends QR payment code\n3. User makes payment\n4. User sends payment proof using `/send` (reply with photo)\n5. Admin receives notification\n6. Admin verifies: `/verify [order_id]`\n7. Admin manually delivers item to customer\n\n## üí¨ Support Session System\n\n- User clicks \"Live Chat Support\"\n- System creates session with unique token\n- Admin joins: `/join [token]`\n- Messages are forwarded between user and admin\n- Session auto-expires after 4 hours\n\n## üìä Data Files\n\nAll data stored in `data/` folder as JSON:\n\n- `users.json` - User accounts\n- `products.json` - Product catalog\n- `categories.json` - Product categories\n- `transactions.json` - Order history\n- `sessions.json` - Support chat sessions\n- `admins.json` - Admin & owner list\n- `settings.json` - Store settings\n- `templates.json` - Quick reply templates (30+ pre-loaded)\n- `faqs.json` - Frequently asked questions (15+ pre-loaded)\n- `feedbacks.json` - User feedback & ratings\n\n## üåê Multi-Language Support\n\nBot supports:\n- üá≤üáæ Bahasa Melayu (Default) - Full support\n- üá¨üáß English - Full support\n- üá®üá≥ ‰∏≠Êñá (Mandarin) - Partial support (UI translations only)\n- üáÆüá≥ ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil) - Partial support (UI translations only)\n\n**Note:** FAQ and Quick Reply templates are available in Malay and English only.\n\nUsers can toggle language from main menu.\n\n## üìù Complete Commands Reference\n\n### User Commands\n- `/start` - Start bot and show main menu\n- `/send` - Upload payment proof (reply with photo)\n- `/searchorder [order_id]` - Search specific order\n- `/faq` - View FAQ list\n- `/list` - View all available commands with buttons\n\n### Admin Commands\n\n**Order Management:**\n- `/verify [order_id]` - Approve order\n- `/reject [order_id]` - Reject order\n- `/checkallorderid` - View all order IDs\n- `/searchorder [query]` - Advanced search (ID/User/Status/Date)\n- `/filterorders` - Filter orders by status\n\n**Product Management:**\n- `/addcategory [name]` - Add category\n- `/addproduct [...]` - Add product (shows format)\n- `/listproducts` - List all products\n- `/duplicate [product_id]` - Duplicate product\n- `/inventory [product_id]` - View inventory history\n- `/adjuststock [product_id] [+/-num] [note]` - Adjust stock\n\n**User Management:**\n- `/ban [user_id] [reason]` - Ban user\n- `/unban [user_id]` - Unban user\n- `/tag [user_id] [tag]` - Tag user\n- `/untag [user_id] [tag]` - Remove user tag\n- `/bannedlist` - List banned users\n\n**Quick Reply & FAQ:**\n- `/addtemplate [keyword] | [response]` - Add quick reply template\n- `/qt [keyword]` - Use quick template\n- `/templates` - List all templates\n- `/deletetemplate [keyword]` - Delete template\n- `/addfaq [question] | [answer]` - Add FAQ\n- `/listfaqs` - List all FAQs\n- `/deletefaq [faq_id]` - Delete FAQ\n\n**Support & Communication:**\n- `/join [token]` - Join support session\n- `/leave` - Leave current session\n- `/close` - Close support session\n- `/feedbacks` - View user feedbacks\n\n**Other:**\n- `/currency` - Change store currency\n- `/list` - View all commands\n\n### Owner Commands\n- `/setowner` - Set yourself as owner\n- `/addadmin [user_id]` - Add admin\n- `/removeadmin [user_id]` - Remove admin\n\n## ‚ú® Pre-loaded Features\n\n### 14 FAQs Included:\n1. How to place order\n2. Payment methods\n3. Delivery time\n4. Contact admin\n5. Refund policy\n6. Available products\n7. Order status\n8. Safety & security\n9. Language settings\n10. Warranty & guarantee\n11. Gift purchases\n12. Using /send command\n13. Order rejection reasons\n14. Viewing purchased items\n\n### 30+ Templates Included:\n- Welcome messages (MS/EN)\n- Order received confirmations\n- Processing notifications\n- Payment reminders\n- Stock availability updates\n- Thank you messages\n- Error handling responses\n- Operating hours info\n- Login instructions\n- Help & support guides\n- And more...\n\n## üéØ Advanced Features\n\n### Auto-Reply System\n- FAQ auto-response based on keywords\n- Quick reply templates for admins\n- Bilingual support for all responses\n\n### Order Search & Filter\n- Search by Order ID, User ID, Status, Date\n- Advanced filtering options\n- Export order history\n\n### User Management\n- Ban/unban users with reasons\n- Tag system for user categorization\n- Track user activity\n\n### Session Management\n- Live chat between users and admins\n- Session tokens for secure access\n- Auto-expiry after 4 hours\n- Message history tracking\n\n### Feedback System\n- User ratings (1-5 stars)\n- Comment collection\n- Admin review dashboard\n\n### Analytics (Owner Panel)\n- Sales reports\n- User statistics\n- Product performance\n- Revenue tracking\n\n## üõ†Ô∏è Tech Stack\n\n- Node.js\n- Telegraf (Telegram Bot Framework)\n- Dropbox API (Primary backup storage)\n- Google Drive API (Secondary backup storage)\n- PDFKit (Receipt generation)\n- Sharp (Image processing)\n- UUID (ID generation)\n- Archiver (ZIP compression for backups)\n- JSON file-based database\n\n## üîß Maintenance & Updates\n\n### üíæ Dual API Backup System\n\nBot ini dilengkapi dengan sistem backup dual API yang automatik! This bot includes an automatic dual API backup system!\n\n#### üöÄ Automatic Backup Features:\n- ‚è±Ô∏è **Auto Backup setiap 20 saat** / Auto backup every 20 seconds\n- ‚òÅÔ∏è **Dual Cloud Storage**: Dropbox (Primary) + Google Drive (Secondary)\n- üîÑ **Auto-Failover**: Automatic switch when storage is full\n- üì• **Auto-Restore**: Load new data from cloud automatically\n- üí™ **No Data Loss**: Always backed up to available storage\n\n#### üìã How It Works:\n\n1. **Primary Storage (Dropbox)**:\n   - System uploads backups to Dropbox every 20 seconds\n   - Automatically checks for new data and restores it\n   - Creates ZIP archives of all data files\n\n2. **Automatic Failover**:\n   - If Dropbox storage is full, system automatically detects it\n   - Switches to Google Drive (secondary storage) immediately\n   - Logs: `üîÑ FAILOVER: Switched from dropbox to googleDrive`\n   - Continues backing up without interruption\n\n3. **Active Provider Tracking**:\n   - Current active provider saved in `data/backup/sync_state.json`\n   - Check which provider is active: `cat data/backup/sync_state.json`\n   - Shows: `\"activeProvider\": \"dropbox\"` or `\"googleDrive\"`\n\n#### ‚öôÔ∏è Configuration:\n\n**Dropbox Setup** (Primary):\n```javascript\n// config.js\nDROPBOX_TOKEN: 'your_dropbox_token_here'\n```\n\n**Google Drive Setup** (Secondary):\n```bash\n# Set environment variable or add to config\nexport GOOGLE_DRIVE_TOKEN='your_google_drive_token_here'\n```\n\nTo get Google Drive token:\n1. Go to Google Cloud Console\n2. Enable Google Drive API\n3. Create OAuth 2.0 credentials\n4. Get access token\n\n#### üìä Backup Logs:\n\nView backup activity:\n```bash\ncat data/backup/backup.log\n```\n\nLog format:\n```\n[2025-10-10 19:07:23] UPLOAD (dropbox): backup-xxx.zip ‚Üí /backups/backup-xxx.zip\n[2025-10-10 19:07:25] DOWNLOAD (dropbox): /backups/backup-xxx.zip ‚Üí local\n[2025-10-10 19:07:26] RESTORE: backup-xxx.zip\n```\n\n#### üîß Manual Backup:\n\nOwner can trigger manual backup:\n```\n/backupnow\n```\n\n#### üõ°Ô∏è Storage Full Protection:\n\nWhen Dropbox is full:\n1. ‚ùå System detects: `insufficient_space` error\n2. üîÑ Auto-switches to Google Drive\n3. ‚úÖ Backup continues on Google Drive\n4. üìù Updates `activeProvider` in sync_state.json\n5. üéâ No data loss!\n\n#### üìÅ Backup Files Location:\n\n- Local: `./data/backup/backup-*.zip`\n- Dropbox: `/backups/backup-*.zip`\n- Google Drive: `/backups/backup-*.zip`\n\n### Backup Data\nAll data files in `data/` folder are automatically backed up every 20 seconds to cloud storage with dual API failover protection.\n\n### Adding New FAQs\n```\n/addfaq How to reset password? | Contact admin via Support to reset your password\n```\n\n### Adding New Templates\n```\n/addtemplate reset | To reset your password, please contact admin via Support\n```\n\n## üì± User Interface\n\n### Main Menu Buttons:\n- üõçÔ∏è Buy Products\n- üìã My Orders / üì¶ My Items\n- üí¨ Support\n- üìã Search Order / ‚ùì FAQ\n- üìñ Guide\n- üåê Language\n- (Admin Panel - for admins)\n- (Owner Panel - for owner)\n\n### Command List (/list):\n- For Users: Interactive buttons for all features + Back button\n- For Admins/Owner: Complete text list of all commands\n\n## üöÄ Next Features (Roadmap)\n\n- Reward points system\n- Voucher/promo codes\n- Product reviews & ratings\n- Advanced statistics & reports\n- Wishlist functionality\n- Automated backup scheduling\n- Broadcast scheduling\n- Multi-admin chat sessions\n- Product bundles & packages\n- Subscription management\n\n## üìû Support\n\nFor issues or questions:\n1. Use the in-bot Support feature\n2. Check FAQ section\n3. Review the User Guide\n4. Contact bot owner/admin\n\n---\n\n**CexiStore Ultimate Pro** - Your complete digital store solution on Telegram! üöÄ\n\nBuilt with ‚ù§Ô∏è for seamless e-commerce experience.\n","size_bytes":14766},"handlers/products.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { t } = require('../utils/translations');\nconst { generateOrderId, generateSessionToken, isSessionExpired } = require('../utils/helpers');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst fs = require('fs').promises;\nconst path = require('path');\n\nasync function handleBuyProducts(ctx) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const categories = await db.getCategories();\n  \n  if (categories.length === 0) {\n    await safeEditMessage(ctx, t('noProducts', lang), {\n      parse_mode: 'Markdown',\n      ...Markup.inlineKeyboard([\n        [Markup.button.callback(t('btnBack', lang), 'main_menu')]\n      ])\n    });\n    return;\n  }\n  \n  const buttons = categories.map(cat => [\n    Markup.button.callback(`${cat.icon || 'üì¶'} ${cat.name[lang] || cat.name['ms']}`, `cat_${cat.id}`)\n  ]);\n  \n  buttons.push([Markup.button.callback(t('btnBack', lang), 'main_menu')]);\n  \n  await safeEditMessage(ctx, t('selectCategory', lang), {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleCategory(ctx, categoryId, page = 0) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const categories = await db.getCategories();\n  const category = categories.find(c => c.id === categoryId);\n  const categoryProducts = products.filter(p => p.categoryId === categoryId && p.active && p.stock > 0);\n  \n  if (categoryProducts.length === 0) {\n    await safeEditMessage(ctx, t('noProducts', lang), {\n      parse_mode: 'Markdown',\n      ...Markup.inlineKeyboard([\n        [Markup.button.callback(t('btnBack', lang), 'buy_products')]\n      ])\n    });\n    return;\n  }\n  \n  const categoryName = category ? (category.name[lang] || category.name['ms']) : 'Category';\n  const categoryIcon = category?.icon || 'üì¶';\n  \n  // Pagination settings\n  const ITEMS_PER_PAGE = 5;\n  const totalPages = Math.ceil(categoryProducts.length / ITEMS_PER_PAGE);\n  const currentPage = Math.max(0, Math.min(page, totalPages - 1));\n  const startIndex = currentPage * ITEMS_PER_PAGE;\n  const endIndex = startIndex + ITEMS_PER_PAGE;\n  const pageProducts = categoryProducts.slice(startIndex, endIndex);\n  \n  let headerText = lang === 'ms' \n    ? `${categoryIcon} *${categoryName}*\\n\\nüìä ${categoryProducts.length} produk tersedia | Halaman ${currentPage + 1}/${totalPages}\\n\\n`\n    : `${categoryIcon} *${categoryName}*\\n\\nüìä ${categoryProducts.length} products available | Page ${currentPage + 1}/${totalPages}\\n\\n`;\n  \n  const buttons = pageProducts.map(prod => {\n    const stockIndicator = prod.stock < 5 ? ' ‚ö†Ô∏è' : '';\n    return [Markup.button.callback(`${prod.name[lang] || prod.name['ms']} - RM${prod.price}${stockIndicator}`, `prod_${prod.id}`)];\n  });\n  \n  // Add pagination buttons\n  const navButtons = [];\n  if (currentPage > 0) {\n    navButtons.push(Markup.button.callback(lang === 'ms' ? '‚¨ÖÔ∏è Sebelum' : '‚¨ÖÔ∏è Back', `catpage_${categoryId}_${currentPage - 1}`));\n  }\n  if (currentPage < totalPages - 1) {\n    navButtons.push(Markup.button.callback(lang === 'ms' ? 'Seterus ‚û°Ô∏è' : 'Next ‚û°Ô∏è', `catpage_${categoryId}_${currentPage + 1}`));\n  }\n  \n  if (navButtons.length > 0) {\n    buttons.push(navButtons);\n  }\n  \n  buttons.push([Markup.button.callback(t('btnBack', lang), 'buy_products')]);\n  \n  await safeEditMessage(ctx, headerText + (lang === 'ms' ? 'Pilih produk:' : 'Select a product:'), {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleProductView(ctx, productId) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product) {\n    await ctx.answerCbQuery('Product not found');\n    return;\n  }\n  \n  const stockStatus = product.stock < 5 \n    ? (lang === 'ms' ? '‚ö†Ô∏è Stok terhad!' : '‚ö†Ô∏è Limited stock!') \n    : (lang === 'ms' ? '‚úÖ Tersedia' : '‚úÖ Available');\n  \n  const text = lang === 'ms'\n    ? `üì¶ *${product.name[lang] || product.name['ms']}*\\n\\n` +\n      `üí∞ *Harga:* RM${product.price}\\n` +\n      `üìä *Stok:* ${product.stock} unit - ${stockStatus}\\n` +\n      `üîÑ *Jenis:* ${product.deliveryType === 'auto' ? 'Auto Delivery' : 'Manual Delivery'}\\n\\n` +\n      `üìù *Penerangan:*\\n${product.description[lang] || product.description['ms']}\\n\\n` +\n      `üÜî ID: \\`${product.id}\\``\n    : `üì¶ *${product.name[lang] || product.name['ms']}*\\n\\n` +\n      `üí∞ *Price:* RM${product.price}\\n` +\n      `üìä *Stock:* ${product.stock} units - ${stockStatus}\\n` +\n      `üîÑ *Type:* ${product.deliveryType === 'auto' ? 'Auto Delivery' : 'Manual Delivery'}\\n\\n` +\n      `üìù *Description:*\\n${product.description[lang] || product.description['ms']}\\n\\n` +\n      `üÜî ID: \\`${product.id}\\``;\n  \n  const buttons = [\n    [Markup.button.callback(t('btnBuyNow', lang), `buy_${productId}`)],\n    [Markup.button.callback(t('btnBack', lang), `cat_${product.categoryId}`)]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleBuyProduct(ctx, productId) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const settings = await db.getSettings();\n  const isStoreOpen = settings.storeOpen !== false;\n  \n  if (!isStoreOpen) {\n    const message = lang === 'en' \n      ? 'üî¥ *Store is Currently Closed*\\n\\nSorry, the store is not accepting orders at the moment. Please try again later.'\n      : 'üî¥ *Kedai Sedang Tutup*\\n\\nMaaf, kedai tidak menerima pesanan buat masa ini. Sila cuba lagi kemudian.';\n    await ctx.answerCbQuery(lang === 'en' ? 'Store is closed' : 'Kedai tutup');\n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product || product.stock <= 0) {\n    await ctx.answerCbQuery('Product not available');\n    return;\n  }\n  \n  // Ensure price is a valid number\n  if (!product.price || isNaN(product.price) || product.price <= 0) {\n    const errorMsg = lang === 'ms' \n      ? '‚ùå Harga produk tidak sah. Sila hubungi admin.'\n      : '‚ùå Invalid product price. Please contact admin.';\n    await ctx.reply(errorMsg);\n    return;\n  }\n  \n  const { applyVoucherToOrder } = require('./voucher');\n  const voucherResult = await applyVoucherToOrder(userId, product.price);\n  \n  // Ensure finalAmount is valid\n  const finalAmount = voucherResult.finalAmount || product.price;\n  const discount = voucherResult.discount || 0;\n  \n  const orderId = generateOrderId();\n  const transactions = await db.getTransactions();\n  \n  const newTransaction = {\n    id: orderId,\n    userId: userId,\n    productId: productId,\n    productName: product.name,\n    originalPrice: product.price,\n    price: finalAmount,\n    discount: discount,\n    voucherCode: voucherResult.voucherCode || null,\n    discountPercentage: voucherResult.discountPercentage || 0,\n    status: 'pending',\n    createdAt: new Date().toISOString(),\n    paymentProof: null,\n    deliveredItem: null\n  };\n  \n  transactions.push(newTransaction);\n  \n  await db.saveTransactions(transactions);\n  \n  const sessions = await db.getSessions();\n  let activeSession = sessions.find(s => s.userId === userId && s.status === 'active');\n  \n  if (activeSession && isSessionExpired(activeSession.createdAt)) {\n    activeSession.status = 'expired';\n    activeSession.endedAt = new Date().toISOString();\n    await db.saveSessions(sessions);\n    activeSession = null;\n  }\n  \n  let sessionToken;\n  if (!activeSession) {\n    sessionToken = generateSessionToken();\n    \n    const newSession = {\n      token: sessionToken,\n      userId: userId,\n      adminId: null,\n      status: 'active',\n      createdAt: new Date().toISOString(),\n      messages: []\n    };\n    \n    sessions.push(newSession);\n    await db.saveSessions(sessions);\n  } else {\n    sessionToken = activeSession.token;\n  }\n  \n  const qrPath = settings.qrPayment.path;\n  \n  let voucherInfo = '';\n  if (voucherResult.voucherCode && discount > 0) {\n    const discountPct = voucherResult.discountPercentage || 0;\n    voucherInfo = lang === 'ms'\n      ? `\\n\\nüé´ *Baucher Digunakan!*\\nüí≥ Kod: ${voucherResult.voucherCode}\\nüí∞ Harga Asal: RM${product.price.toFixed(2)}\\nüéâ Diskaun ${discountPct}%: -RM${discount.toFixed(2)}\\n‚úÖ Harga Akhir: RM${finalAmount.toFixed(2)}`\n      : `\\n\\nüé´ *Voucher Applied!*\\nüí≥ Code: ${voucherResult.voucherCode}\\nüí∞ Original Price: RM${product.price.toFixed(2)}\\nüéâ Discount ${discountPct}%: -RM${discount.toFixed(2)}\\n‚úÖ Final Price: RM${finalAmount.toFixed(2)}`;\n  }\n  \n  const orderMessage = lang === 'ms'\n    ? `‚úÖ *Order Dibuat!*\\n\\nüÜî ID Order: \\`${orderId}\\`\\nüì¶ Produk: ${product.name.ms}\\nüí∞ Harga: RM${finalAmount.toFixed(2)}${voucherInfo}\\n\\n*Sila lengkapkan pembayaran dan muat naik bukti.*`\n    : `‚úÖ *Order Created!*\\n\\nüÜî Order ID: \\`${orderId}\\`\\nüì¶ Product: ${product.name.en || product.name.ms}\\nüí∞ Price: RM${finalAmount.toFixed(2)}${voucherInfo}\\n\\n*Please complete payment and upload proof.*`;\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üí¨ Chat dengan Admin' : 'üí¨ Chat with Admin', 'support')],\n    [Markup.button.callback(lang === 'ms' ? 'üì¶ Lihat Order Saya' : 'üì¶ View My Orders', 'my_orders')],\n    [Markup.button.callback(t('btnHome', lang), 'main_menu')]\n  ];\n  \n  await ctx.reply(orderMessage, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n  \n  try {\n    if (qrPath && await fs.access(qrPath).then(() => true).catch(() => false)) {\n      await ctx.replyWithPhoto(\n        { source: qrPath },\n        {\n          caption: t('paymentQR', lang),\n          parse_mode: 'Markdown'\n        }\n      );\n    } else {\n      const noQrMessage = lang === 'ms' \n        ? `‚ö†Ô∏è *Maklumat Pembayaran:*\\n\\nKod QR tidak tersedia pada masa ini.\\nSila tekan butang \"üí¨ Chat dengan Admin\" di atas untuk mendapat maklumat pembayaran.\\n\\nAdmin akan berikan detail pembayaran kepada anda!`\n        : `‚ö†Ô∏è *Payment Information:*\\n\\nQR code not available at the moment.\\nPlease click \"üí¨ Chat with Admin\" button above to get payment details.\\n\\nAdmin will provide you with payment information!`;\n      \n      await ctx.reply(noQrMessage, {\n        parse_mode: 'Markdown'\n      });\n    }\n  } catch (error) {\n    const noQrMessage = lang === 'ms' \n      ? `‚ö†Ô∏è *Maklumat Pembayaran:*\\n\\nKod QR tidak tersedia pada masa ini.\\nSila tekan butang \"üí¨ Chat dengan Admin\" di atas untuk mendapat maklumat pembayaran.\\n\\nAdmin akan berikan detail pembayaran kepada anda!`\n      : `‚ö†Ô∏è *Payment Information:*\\n\\nQR code not available at the moment.\\nPlease click \"üí¨ Chat with Admin\" button above to get payment details.\\n\\nAdmin will provide you with payment information!`;\n    \n    await ctx.reply(noQrMessage, {\n      parse_mode: 'Markdown'\n    });\n  }\n  \n  await notifyAdmins(ctx, orderId, product, userId, sessionToken);\n}\n\nasync function notifyAdmins(ctx, orderId, product, userId, sessionToken) {\n  const admins = await db.getAdmins();\n  const allAdmins = [admins.owner, ...admins.admins].filter(Boolean);\n  \n  const transactions = await db.getTransactions();\n  const transaction = transactions.find(t => t.id === orderId);\n  \n  const priceInfo = transaction && transaction.voucherCode && transaction.discount > 0\n    ? `Original Price: RM${(transaction.originalPrice || 0).toFixed(2)}\\nVoucher: ${transaction.voucherCode} (-RM${(transaction.discount || 0).toFixed(2)})\\nFinal Price: RM${(transaction.price || 0).toFixed(2)}`\n    : `Price: RM${(product.price || 0).toFixed(2)}`;\n  \n  const message = `üîî *New Order Alert*\\n\\nOrder ID: \\`${orderId}\\`\\nProduct: ${product.name.ms}\\n${priceInfo}\\nCustomer ID: ${userId}\\nSession Token: \\`${sessionToken}\\``;\n  \n  const buttons = Markup.inlineKeyboard([\n    [Markup.button.callback('üí¨ Join Session', `join_session_${sessionToken}`)],\n    [Markup.button.callback('‚úÖ Verify Order', `verify_order_${orderId}`)],\n    [Markup.button.callback('‚ùå Reject Order', `reject_order_${orderId}`)]\n  ]);\n  \n  for (const adminId of allAdmins) {\n    try {\n      await ctx.telegram.sendMessage(\n        adminId,\n        message,\n        { \n          parse_mode: 'Markdown',\n          ...buttons\n        }\n      );\n    } catch (error) {\n      console.error(`Failed to notify admin ${adminId}:`, error.message);\n    }\n  }\n}\n\nmodule.exports = {\n  handleBuyProducts,\n  handleCategory,\n  handleProductView,\n  handleBuyProduct\n};\n","size_bytes":12826},"handlers/session.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { t } = require('../utils/translations');\nconst { generateSessionToken, isSessionExpired } = require('../utils/helpers');\nconst { safeEditMessage } = require('../utils/messageHelper');\n\nasync function handleSupport(ctx) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const sessions = await db.getSessions();\n  let activeSession = sessions.find(s => s.userId === userId && s.status === 'active');\n  \n  if (activeSession && isSessionExpired(activeSession.createdAt)) {\n    activeSession.status = 'expired';\n    activeSession.endedAt = new Date().toISOString();\n    await db.saveSessions(sessions);\n    activeSession = null;\n  }\n  \n  if (!activeSession) {\n    const token = generateSessionToken();\n    \n    const newSession = {\n      token: token,\n      userId: userId,\n      adminId: null,\n      status: 'active',\n      createdAt: new Date().toISOString(),\n      messages: []\n    };\n    \n    sessions.push(newSession);\n    await db.saveSessions(sessions);\n    \n    await safeEditMessage(ctx, t('sessionCreated', lang, token), {\n      parse_mode: 'Markdown',\n      ...Markup.inlineKeyboard([\n        [Markup.button.callback(t('btnBack', lang), 'main_menu')]\n      ])\n    });\n    \n    const admins = await db.getAdmins();\n    const allAdmins = [admins.owner, ...admins.admins].filter(Boolean);\n    \n    for (const adminId of allAdmins) {\n      try {\n        await ctx.telegram.sendMessage(\n          adminId,\n          `üí¨ *New Support Session*\\n\\nToken: \\`${token}\\`\\nUser: ${userId}\\n\\nUse /join ${token} to enter session`,\n          { parse_mode: 'Markdown' }\n        );\n      } catch (error) {\n        console.error(`Failed to notify admin ${adminId}:`, error.message);\n      }\n    }\n  } else {\n    await safeEditMessage(ctx, \n      `üí¨ You already have an active session.\\n\\nToken: \\`${activeSession.token}\\`\\n\\nType your message to chat with admin.`,\n      {\n        parse_mode: 'Markdown',\n        ...Markup.inlineKeyboard([\n          [Markup.button.callback('üîö End Session', `end_session_${activeSession.token}`)],\n          [Markup.button.callback(t('btnBack', lang), 'main_menu')]\n        ])\n      }\n    );\n  }\n}\n\nasync function handleJoinSession(ctx, token) {\n  const userId = ctx.from.id;\n  const { isAdmin } = require('./admin');\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('Unauthorized');\n    return;\n  }\n  \n  const sessions = await db.getSessions();\n  const session = sessions.find(s => s.token === token);\n  \n  if (!session) {\n    await ctx.reply('Session not found');\n    return;\n  }\n  \n  if (session.status !== 'active') {\n    await ctx.reply('Session is not active');\n    return;\n  }\n  \n  const adminSessions = sessions.filter(s => s.adminId === userId && s.status === 'active');\n  \n  if (!session.adminId) {\n    session.adminId = userId;\n  }\n  \n  session.lastActiveAt = new Date().toISOString();\n  await db.saveSessions(sessions);\n  \n  const totalActiveSessions = adminSessions.length + 1;\n  let replyMessage = `‚úÖ Joined session ${token}\\n\\nUser: ${session.userId}\\nActive Sessions: ${totalActiveSessions}\\n\\n`;\n  \n  if (totalActiveSessions > 1) {\n    replyMessage += `üìã Managing multiple sessions:\\n`;\n    replyMessage += `‚Ä¢ Use /sessions to view all active sessions\\n`;\n    replyMessage += `‚Ä¢ Use /active ${token} to set this as active session\\n`;\n    replyMessage += `‚Ä¢ Use /msg ${token} [message] to send to specific session\\n`;\n    replyMessage += `‚Ä¢ Use /leave ${token} to leave this session\\n\\n`;\n    replyMessage += `üí° Tip: Set active session to send messages directly`;\n  } else {\n    replyMessage += `Use /leave to exit session`;\n  }\n  \n  await ctx.reply(replyMessage);\n  \n  try {\n    await ctx.telegram.sendMessage(\n      session.userId,\n      '‚úÖ Admin has joined your support session! You can now chat.'\n    );\n  } catch (error) {\n    console.error('Failed to notify user:', error.message);\n  }\n}\n\nasync function handleEndSession(ctx, token) {\n  const sessions = await db.getSessions();\n  const session = sessions.find(s => s.token === token);\n  \n  if (!session) {\n    await ctx.answerCbQuery('Session not found');\n    return;\n  }\n  \n  session.status = 'ended';\n  session.endedAt = new Date().toISOString();\n  await db.saveSessions(sessions);\n  \n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  await safeEditMessage(ctx, t('sessionEnded', lang), {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([\n      [Markup.button.callback(t('btnHome', lang), 'main_menu')]\n    ])\n  });\n  \n  if (session.adminId) {\n    try {\n      await ctx.telegram.sendMessage(session.adminId, `Session ${token} ended by user`);\n    } catch (error) {\n      console.error('Failed to notify admin:', error.message);\n    }\n  }\n}\n\nasync function handleLeaveSession(ctx, specificToken = null) {\n  const userId = ctx.from.id;\n  const { isAdmin } = require('./admin');\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('Unauthorized');\n    return;\n  }\n  \n  const sessions = await db.getSessions();\n  let adminSession;\n  \n  if (specificToken) {\n    adminSession = sessions.find(s => s.token === specificToken && s.adminId === userId && s.status === 'active');\n  } else {\n    const activeSessions = sessions.filter(s => s.adminId === userId && s.status === 'active');\n    \n    if (activeSessions.length === 0) {\n      await ctx.reply('You are not in any active session');\n      return;\n    }\n    \n    if (activeSessions.length > 1) {\n      await ctx.reply('‚ö†Ô∏è You are in multiple sessions. Please specify which session to leave:\\n\\n`/leave [session_token]`\\n\\nUse /sessions to see all active sessions.', { parse_mode: 'Markdown' });\n      return;\n    }\n    \n    adminSession = activeSessions[0];\n  }\n  \n  if (!adminSession) {\n    await ctx.reply('‚ùå Session not found or you are not in this session');\n    return;\n  }\n  \n  const token = adminSession.token;\n  adminSession.adminId = null;\n  adminSession.isActiveSession = false;\n  await db.saveSessions(sessions);\n  \n  const remainingSessions = sessions.filter(s => s.adminId === userId && s.status === 'active').length;\n  let replyMsg = `‚úÖ You have left session ${token}`;\n  \n  if (remainingSessions > 0) {\n    replyMsg += `\\n\\nRemaining active sessions: ${remainingSessions}\\nUse /sessions to view them`;\n  }\n  \n  await ctx.reply(replyMsg);\n  \n  try {\n    await ctx.telegram.sendMessage(\n      adminSession.userId,\n      'üë®‚Äçüíº Admin has left the support session.'\n    );\n  } catch (error) {\n    console.error('Failed to notify user:', error.message);\n  }\n}\n\nasync function handleCloseSession(ctx) {\n  const userId = ctx.from.id;\n  const { isAdmin } = require('./admin');\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('Unauthorized');\n    return;\n  }\n  \n  const sessions = await db.getSessions();\n  const adminSession = sessions.find(s => s.adminId === userId && s.status === 'active');\n  \n  if (!adminSession) {\n    await ctx.reply('You are not in any active session');\n    return;\n  }\n  \n  const token = adminSession.token;\n  adminSession.status = 'ended';\n  adminSession.endedAt = new Date().toISOString();\n  await db.saveSessions(sessions);\n  \n  await ctx.reply(`‚úÖ Session ${token} has been closed successfully`);\n  \n  try {\n    await ctx.telegram.sendMessage(\n      adminSession.userId,\n      '‚úÖ Support session has been closed by admin. Issue resolved!\\n\\nThank you for contacting support.'\n    );\n  } catch (error) {\n    console.error('Failed to notify user:', error.message);\n  }\n}\n\nasync function handleSessionMessage(ctx) {\n  const userId = ctx.from.id;\n  const sessions = await db.getSessions();\n  \n  const userSession = sessions.find(s => s.userId === userId && s.status === 'active');\n  const adminSessions = sessions.filter(s => s.adminId === userId && s.status === 'active');\n  \n  let adminSession = null;\n  \n  if (adminSessions.length > 0) {\n    adminSession = adminSessions.find(s => s.isActiveSession === true);\n    \n    if (!adminSession && adminSessions.length === 1) {\n      adminSession = adminSessions[0];\n    } else if (!adminSession && adminSessions.length > 1) {\n      await ctx.reply(\n        '‚ö†Ô∏è *Multiple Active Sessions Detected*\\n\\n' +\n        'You are in multiple support sessions. Please choose an option:\\n\\n' +\n        '1Ô∏è‚É£ Set active session: `/active [token]`\\n' +\n        '2Ô∏è‚É£ Send to specific session: `/msg [token] [message]`\\n' +\n        '3Ô∏è‚É£ View all sessions: `/sessions`\\n\\n' +\n        'üí° Tip: Setting an active session allows you to send messages directly without specifying the token each time.',\n        { parse_mode: 'Markdown' }\n      );\n      return;\n    }\n  }\n  \n  const messageText = ctx.message.text;\n  const messagePhoto = ctx.message.photo;\n  const messageDocument = ctx.message.document;\n  const messageAudio = ctx.message.audio;\n  const messageVoice = ctx.message.voice;\n  const messageVideo = ctx.message.video;\n  const messageLocation = ctx.message.location;\n  \n  if (adminSession) {\n    const messageData = {\n      from: 'admin',\n      timestamp: new Date().toISOString()\n    };\n    \n    if (messageText) {\n      messageData.text = messageText;\n      messageData.type = 'text';\n    } else if (messagePhoto) {\n      messageData.photo = messagePhoto[messagePhoto.length - 1].file_id;\n      messageData.type = 'photo';\n      messageData.caption = ctx.message.caption || '';\n    } else if (messageDocument) {\n      messageData.document = messageDocument.file_id;\n      messageData.fileName = messageDocument.file_name;\n      messageData.mimeType = messageDocument.mime_type;\n      messageData.type = 'document';\n      messageData.caption = ctx.message.caption || '';\n    } else if (messageAudio) {\n      messageData.audio = messageAudio.file_id;\n      messageData.duration = messageAudio.duration;\n      messageData.type = 'audio';\n      messageData.caption = ctx.message.caption || '';\n    } else if (messageVoice) {\n      messageData.voice = messageVoice.file_id;\n      messageData.duration = messageVoice.duration;\n      messageData.type = 'voice';\n    } else if (messageVideo) {\n      messageData.video = messageVideo.file_id;\n      messageData.duration = messageVideo.duration;\n      messageData.type = 'video';\n      messageData.caption = ctx.message.caption || '';\n    } else if (messageLocation) {\n      messageData.location = {\n        latitude: messageLocation.latitude,\n        longitude: messageLocation.longitude\n      };\n      messageData.type = 'location';\n    }\n    \n    adminSession.messages.push(messageData);\n    await db.saveSessions(sessions);\n    \n    try {\n      if (messageText) {\n        await ctx.telegram.sendMessage(\n          adminSession.userId,\n          `üë®‚Äçüíº Admin: ${messageText}`\n        );\n      } else if (messagePhoto) {\n        await ctx.telegram.sendPhoto(\n          adminSession.userId,\n          messagePhoto[messagePhoto.length - 1].file_id,\n          {\n            caption: `üë®‚Äçüíº Admin sent a photo${ctx.message.caption ? ':\\n' + ctx.message.caption : ''}`\n          }\n        );\n      } else if (messageDocument) {\n        await ctx.telegram.sendDocument(\n          adminSession.userId,\n          messageDocument.file_id,\n          {\n            caption: `üë®‚Äçüíº Admin sent a file${ctx.message.caption ? ':\\n' + ctx.message.caption : ''}`\n          }\n        );\n      } else if (messageAudio) {\n        await ctx.telegram.sendAudio(\n          adminSession.userId,\n          messageAudio.file_id,\n          {\n            caption: `üë®‚Äçüíº Admin sent an audio${ctx.message.caption ? ':\\n' + ctx.message.caption : ''}`\n          }\n        );\n      } else if (messageVoice) {\n        await ctx.telegram.sendVoice(\n          adminSession.userId,\n          messageVoice.file_id,\n          {\n            caption: `üë®‚Äçüíº Admin sent a voice message`\n          }\n        );\n      } else if (messageVideo) {\n        await ctx.telegram.sendVideo(\n          adminSession.userId,\n          messageVideo.file_id,\n          {\n            caption: `üë®‚Äçüíº Admin sent a video${ctx.message.caption ? ':\\n' + ctx.message.caption : ''}`\n          }\n        );\n      } else if (messageLocation) {\n        await ctx.telegram.sendLocation(\n          adminSession.userId,\n          messageLocation.latitude,\n          messageLocation.longitude\n        );\n        await ctx.telegram.sendMessage(\n          adminSession.userId,\n          `üë®‚Äçüíº Admin shared a location`\n        );\n      }\n    } catch (error) {\n      console.error('Failed to forward message:', error.message);\n    }\n  } else if (userSession) {\n    const messageData = {\n      from: 'user',\n      timestamp: new Date().toISOString()\n    };\n    \n    if (messageText) {\n      messageData.text = messageText;\n      messageData.type = 'text';\n    } else if (messagePhoto) {\n      messageData.photo = messagePhoto[messagePhoto.length - 1].file_id;\n      messageData.type = 'photo';\n      messageData.caption = ctx.message.caption || '';\n    } else if (messageDocument) {\n      messageData.document = messageDocument.file_id;\n      messageData.fileName = messageDocument.file_name;\n      messageData.mimeType = messageDocument.mime_type;\n      messageData.type = 'document';\n      messageData.caption = ctx.message.caption || '';\n    } else if (messageAudio) {\n      messageData.audio = messageAudio.file_id;\n      messageData.duration = messageAudio.duration;\n      messageData.type = 'audio';\n      messageData.caption = ctx.message.caption || '';\n    } else if (messageVoice) {\n      messageData.voice = messageVoice.file_id;\n      messageData.duration = messageVoice.duration;\n      messageData.type = 'voice';\n    } else if (messageVideo) {\n      messageData.video = messageVideo.file_id;\n      messageData.duration = messageVideo.duration;\n      messageData.type = 'video';\n      messageData.caption = ctx.message.caption || '';\n    } else if (messageLocation) {\n      messageData.location = {\n        latitude: messageLocation.latitude,\n        longitude: messageLocation.longitude\n      };\n      messageData.type = 'location';\n    }\n    \n    userSession.messages.push(messageData);\n    await db.saveSessions(sessions);\n    \n    if (userSession.adminId) {\n      try {\n        if (messageText) {\n          await ctx.telegram.sendMessage(\n            userSession.adminId,\n            `üë§ User ${userId}: ${messageText}`\n          );\n        } else if (messagePhoto) {\n          await ctx.telegram.sendPhoto(\n            userSession.adminId,\n            messagePhoto[messagePhoto.length - 1].file_id,\n            {\n              caption: `üë§ User ${userId} sent a photo${ctx.message.caption ? ':\\n' + ctx.message.caption : ''}`\n            }\n          );\n        } else if (messageDocument) {\n          await ctx.telegram.sendDocument(\n            userSession.adminId,\n            messageDocument.file_id,\n            {\n              caption: `üë§ User ${userId} sent a file${ctx.message.caption ? ':\\n' + ctx.message.caption : ''}`\n            }\n          );\n        } else if (messageAudio) {\n          await ctx.telegram.sendAudio(\n            userSession.adminId,\n            messageAudio.file_id,\n            {\n              caption: `üë§ User ${userId} sent an audio${ctx.message.caption ? ':\\n' + ctx.message.caption : ''}`\n            }\n          );\n        } else if (messageVoice) {\n          await ctx.telegram.sendVoice(\n            userSession.adminId,\n            messageVoice.file_id,\n            {\n              caption: `üë§ User ${userId} sent a voice message`\n            }\n          );\n        } else if (messageVideo) {\n          await ctx.telegram.sendVideo(\n            userSession.adminId,\n            messageVideo.file_id,\n            {\n              caption: `üë§ User ${userId} sent a video${ctx.message.caption ? ':\\n' + ctx.message.caption : ''}`\n            }\n          );\n        } else if (messageLocation) {\n          await ctx.telegram.sendLocation(\n            userSession.adminId,\n            messageLocation.latitude,\n            messageLocation.longitude\n          );\n          await ctx.telegram.sendMessage(\n            userSession.adminId,\n            `üë§ User ${userId} shared a location`\n          );\n        }\n      } catch (error) {\n        console.error('Failed to forward message:', error.message);\n      }\n    } else {\n      try {\n        await ctx.reply('‚è≥ Your message has been saved. Waiting for an admin to join the session...');\n      } catch (error) {\n        console.error('Failed to send waiting message:', error.message);\n      }\n    }\n  }\n}\n\nasync function handleListSessions(ctx) {\n  const userId = ctx.from.id;\n  const { isAdmin } = require('./admin');\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('Unauthorized');\n    return;\n  }\n  \n  const sessions = await db.getSessions();\n  const adminSessions = sessions.filter(s => s.adminId === userId && s.status === 'active');\n  \n  if (adminSessions.length === 0) {\n    await ctx.reply('‚ùå You are not in any active sessions');\n    return;\n  }\n  \n  let message = `üìã *Your Active Sessions (${adminSessions.length})*\\n\\n`;\n  \n  for (const session of adminSessions) {\n    const isActive = session.isActiveSession ? '‚úÖ ' : '';\n    message += `${isActive}Token: \\`${session.token}\\`\\n`;\n    message += `User: ${session.userId}\\n`;\n    message += `Messages: ${session.messages.length}\\n`;\n    message += `Started: ${new Date(session.createdAt).toLocaleString()}\\n\\n`;\n  }\n  \n  message += `\\nüí° *Commands:*\\n`;\n  message += `‚Ä¢ /active [token] - Set active session\\n`;\n  message += `‚Ä¢ /msg [token] [message] - Send to specific session\\n`;\n  message += `‚Ä¢ /leave [token] - Leave specific session`;\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function handleSetActiveSession(ctx, token) {\n  const userId = ctx.from.id;\n  const { isAdmin } = require('./admin');\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('Unauthorized');\n    return;\n  }\n  \n  const sessions = await db.getSessions();\n  const session = sessions.find(s => s.token === token && s.adminId === userId && s.status === 'active');\n  \n  if (!session) {\n    await ctx.reply('‚ùå Session not found or you are not in this session');\n    return;\n  }\n  \n  sessions.forEach(s => {\n    if (s.adminId === userId) {\n      s.isActiveSession = false;\n    }\n  });\n  \n  session.isActiveSession = true;\n  session.lastActiveAt = new Date().toISOString();\n  await db.saveSessions(sessions);\n  \n  await ctx.reply(`‚úÖ Active session set to ${token}\\n\\nYou can now send messages directly to this session.`);\n}\n\nasync function handleSendToSession(ctx, token, message) {\n  const userId = ctx.from.id;\n  const { isAdmin } = require('./admin');\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('Unauthorized');\n    return;\n  }\n  \n  const sessions = await db.getSessions();\n  const session = sessions.find(s => s.token === token && s.adminId === userId && s.status === 'active');\n  \n  if (!session) {\n    await ctx.reply('‚ùå Session not found or you are not in this session');\n    return;\n  }\n  \n  const messageData = {\n    from: 'admin',\n    text: message,\n    type: 'text',\n    timestamp: new Date().toISOString()\n  };\n  \n  session.messages.push(messageData);\n  session.lastActiveAt = new Date().toISOString();\n  await db.saveSessions(sessions);\n  \n  try {\n    await ctx.telegram.sendMessage(\n      session.userId,\n      `üë®‚Äçüíº Admin: ${message}`\n    );\n    await ctx.reply(`‚úÖ Message sent to session ${token}`);\n  } catch (error) {\n    console.error('Failed to send message:', error.message);\n    await ctx.reply('‚ùå Failed to send message');\n  }\n}\n\nmodule.exports = {\n  handleSupport,\n  handleJoinSession,\n  handleLeaveSession,\n  handleCloseSession,\n  handleEndSession,\n  handleSessionMessage,\n  handleListSessions,\n  handleSetActiveSession,\n  handleSendToSession\n};\n","size_bytes":19902},"utils/translations.js":{"content":"const translations = {\n  mainMenu: {\n    en: 'üè† *Main Menu*\\n\\nWelcome to CexiStore! Choose an option below:',\n    ms: 'üè† *Menu Utama*\\n\\nSelamat datang ke CexiStore! Pilih pilihan di bawah:',\n    zh: 'üè† *‰∏ªËèúÂçï*\\n\\nÊ¨¢ËøéÊù•Âà∞CexiStoreÔºÅËØ∑ÈÄâÊã©‰ª•‰∏ãÈÄâÈ°πÔºö',\n    ta: 'üè† *‡Æ™‡Æø‡Æ∞‡Æ§‡Ææ‡Æ© ‡ÆÆ‡ØÜ‡Æ©‡ØÅ*\\n\\nCexiStore ‡Æï‡Øç‡Æï‡ØÅ ‡Æµ‡Æ∞‡Æµ‡Øá‡Æ±‡Øç‡Æï‡Æø‡Æ±‡Øã‡ÆÆ‡Øç! ‡Æï‡ØÄ‡Æ¥‡Øá ‡Æí‡Æ∞‡ØÅ ‡Æµ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æ§‡Øç‡Æ§‡Øà ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç:'\n  },\n  btnBuyProducts: {\n    en: 'üõí Buy Products',\n    ms: 'üõí Beli Produk',\n    zh: 'üõí Ë¥≠‰π∞‰∫ßÂìÅ',\n    ta: 'üõí ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà ‡Æµ‡Ææ‡Æô‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç'\n  },\n  btnMyOrders: {\n    en: 'üì¶ My Orders',\n    ms: 'üì¶ Order Saya',\n    zh: 'üì¶ ÊàëÁöÑËÆ¢Âçï',\n    ta: 'üì¶ ‡Æé‡Æ©‡Æ§‡ØÅ ‡ÆÜ‡Æ∞‡Øç‡Æü‡Æ∞‡Øç‡Æï‡Æ≥‡Øç'\n  },\n  btnMyItems: {\n    en: 'üéÅ My Items',\n    ms: 'üéÅ Item Saya',\n    zh: 'üéÅ ÊàëÁöÑÁâ©ÂìÅ',\n    ta: 'üéÅ ‡Æé‡Æ©‡Æ§‡ØÅ ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æü‡Øç‡Æï‡Æ≥‡Øç'\n  },\n  btnSupport: {\n    en: 'üí¨ Live Chat Support',\n    ms: 'üí¨ Sokongan Live Chat',\n    zh: 'üí¨ Âú®Á∫øÂÆ¢ÊúçÊîØÊåÅ',\n    ta: 'üí¨ ‡Æ®‡Øá‡Æ∞‡Æü‡Æø ‡ÆÖ‡Æ∞‡Æü‡Øç‡Æü‡Øà ‡ÆÜ‡Æ§‡Æ∞‡Æµ‡ØÅ'\n  },\n  btnLanguage: {\n    en: 'üåê Language: English',\n    ms: 'üåê Bahasa: Melayu',\n    zh: 'üåê ËØ≠Ë®ÄÔºö‰∏≠Êñá',\n    ta: 'üåê ‡ÆÆ‡Øä‡Æ¥‡Æø: ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç'\n  },\n  btnAdminPanel: {\n    en: 'üë®‚Äçüíº Admin Panel',\n    ms: 'üë®‚Äçüíº Panel Admin',\n    zh: 'üë®‚Äçüíº ÁÆ°ÁêÜÈù¢Êùø',\n    ta: 'üë®‚Äçüíº ‡Æ®‡Æø‡Æ∞‡Øç‡Æµ‡Ææ‡Æï ‡Æ™‡Øá‡Æ©‡Æ≤‡Øç'\n  },\n  btnOwnerPanel: {\n    en: 'üëë Owner Panel',\n    ms: 'üëë Panel Owner',\n    zh: 'üëë ÊâÄÊúâËÄÖÈù¢Êùø',\n    ta: 'üëë ‡Æâ‡Æ∞‡Æø‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æ™‡Øá‡Æ©‡Æ≤‡Øç'\n  },\n  btnBack: {\n    en: '‚óÄÔ∏è Back',\n    ms: '‚óÄÔ∏è Kembali',\n    zh: '‚óÄÔ∏è ËøîÂõû',\n    ta: '‚óÄÔ∏è ‡Æ§‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ'\n  },\n  btnHome: {\n    en: 'üè† Home',\n    ms: 'üè† Utama',\n    zh: 'üè† ‰∏ªÈ°µ',\n    ta: 'üè† ‡ÆÆ‡ØÅ‡Æï‡Æ™‡Øç‡Æ™‡ØÅ'\n  },\n  selectCategory: {\n    en: 'üìÇ *Select Category*\\n\\nChoose a product category:',\n    ms: 'üìÇ *Pilih Kategori*\\n\\nPilih kategori produk:',\n    zh: 'üìÇ *ÈÄâÊã©Á±ªÂà´*\\n\\nÈÄâÊã©‰∫ßÂìÅÁ±ªÂà´Ôºö',\n    ta: 'üìÇ *‡Æµ‡Æï‡Øà‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç*\\n\\n‡Æ§‡ÆØ‡Ææ‡Æ∞‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡Æµ‡Æï‡Øà‡ÆØ‡Øà ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç:'\n  },\n  noProducts: {\n    en: '‚ùå No products available in this category.',\n    ms: '‚ùå Tiada produk tersedia dalam kategori ini.',\n    zh: '‚ùå Ê≠§Á±ªÂà´‰∏≠Ê≤°ÊúâÂèØÁî®ÁöÑ‰∫ßÂìÅ„ÄÇ',\n    ta: '‚ùå ‡Æá‡Æ®‡Øç‡Æ§ ‡Æµ‡Æï‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà.'\n  },\n  productDetail: {\n    en: (name, price, stock, desc) => `üõçÔ∏è *${name}*\\n\\nüí∞ Price: RM ${price}\\nüì¶ Stock: ${stock}\\n\\nüìù ${desc}`,\n    ms: (name, price, stock, desc) => `üõçÔ∏è *${name}*\\n\\nüí∞ Harga: RM ${price}\\nüì¶ Stok: ${stock}\\n\\nüìù ${desc}`\n  },\n  btnBuyNow: {\n    en: 'üí≥ Buy Now',\n    ms: 'üí≥ Beli Sekarang'\n  },\n  paymentQR: {\n    en: 'üí≥ *Payment*\\n\\nPlease scan the QR code above to make payment.\\n\\nüì∏ *How to send payment proof:*\\n1. Take a screenshot of your payment receipt\\n2. Reply to this message\\n3. Attach the screenshot/photo\\n4. Type: /send\\n\\n‚úÖ Admin will verify within 5-10 minutes!',\n    ms: 'üí≥ *Pembayaran*\\n\\nSila imbas kod QR di atas untuk membuat pembayaran.\\n\\nüì∏ *Cara hantar bukti pembayaran:*\\n1. Screenshot resit pembayaran anda\\n2. Balas mesej ini\\n3. Attach screenshot/gambar\\n4. Taip: /send\\n\\n‚úÖ Admin akan sahkan dalam 5-10 minit!'\n  },\n  orderCreated: {\n    en: (orderId) => `‚úÖ *Order Created Successfully!*\\n\\nüÜî Order ID: \\`${orderId}\\`\\n\\nüí¨ Need help? Click \"Support\" button or contact admin directly via Live Chat!`,\n    ms: (orderId) => `‚úÖ *Order Berjaya Dibuat!*\\n\\nüÜî ID Order: \\`${orderId}\\`\\n\\nüí¨ Perlu bantuan? Tekan butang \"Sokongan\" atau hubungi admin terus melalui Live Chat!`\n  },\n  paymentProofReceived: {\n    en: '‚úÖ Payment proof received! Admin will verify your payment shortly.',\n    ms: '‚úÖ Bukti pembayaran diterima! Admin akan sahkan pembayaran anda tidak lama lagi.'\n  },\n  noOrders: {\n    en: '‚ùå You have no orders yet.',\n    ms: '‚ùå Anda belum mempunyai sebarang order.'\n  },\n  myOrders: {\n    en: 'üì¶ *My Orders*\\n\\nYour order history:',\n    ms: 'üì¶ *Order Saya*\\n\\nSejarah pesanan anda:'\n  },\n  orderStatus: {\n    pending: { en: '‚è≥ Pending', ms: '‚è≥ Menunggu' },\n    paid: { en: '‚úÖ Paid', ms: '‚úÖ Dibayar' },\n    completed: { en: '‚úÖ Completed', ms: '‚úÖ Selesai' },\n    rejected: { en: '‚ùå Rejected', ms: '‚ùå Ditolak' }\n  },\n  adminPanel: {\n    en: 'üë®‚Äçüíº *Admin Panel*\\n\\nSelect an option:',\n    ms: 'üë®‚Äçüíº *Panel Admin*\\n\\nPilih pilihan:'\n  },\n  btnNewOrders: {\n    en: 'üì• New Orders',\n    ms: 'üì• Order Baru'\n  },\n  btnManageProducts: {\n    en: 'üì¶ Manage Products',\n    ms: 'üì¶ Urus Produk'\n  },\n  btnBroadcast: {\n    en: 'üì¢ Broadcast',\n    ms: 'üì¢ Siarkan'\n  },\n  btnActiveSessions: {\n    en: 'üí¨ Active Sessions',\n    ms: 'üí¨ Sesi Aktif'\n  },\n  ownerPanel: {\n    en: 'üëë *Owner Panel*\\n\\nSelect an option:',\n    ms: 'üëë *Panel Owner*\\n\\nPilih pilihan:'\n  },\n  btnManageAdmins: {\n    en: 'üë• Manage Admins',\n    ms: 'üë• Urus Admin'\n  },\n  btnStoreSettings: {\n    en: '‚öôÔ∏è Store Settings',\n    ms: '‚öôÔ∏è Tetapan Kedai'\n  },\n  btnBackup: {\n    en: 'üíæ Backup & Restore',\n    ms: 'üíæ Backup & Pulih'\n  },\n  unauthorized: {\n    en: '‚ùå You are not authorized to access this feature.',\n    ms: '‚ùå Anda tidak dibenarkan mengakses ciri ini.'\n  },\n  sessionCreated: {\n    en: (token) => `üí¨ *Live Chat Session Created*\\n\\nSession Token: \\`${token}\\`\\n\\nAn admin will join shortly. Session will auto-expire in 4 hours.`,\n    ms: (token) => `üí¨ *Sesi Live Chat Dibuat*\\n\\nToken Sesi: \\`${token}\\`\\n\\nAdmin akan join tidak lama lagi. Sesi akan tamat automatik dalam 4 jam.`\n  },\n  sessionEnded: {\n    en: '‚úÖ Chat session has ended.',\n    ms: '‚úÖ Sesi chat telah tamat.'\n  },\n  itemDelivered: {\n    en: (item) => `üéÅ *Your Digital Product*\\n\\n${item}\\n\\nThank you for your purchase!`,\n    ms: (item) => `üéÅ *Produk Digital Anda*\\n\\n${item}\\n\\nTerima kasih atas pembelian anda!`\n  }\n};\n\nfunction t(key, lang = 'ms', ...args) {\n  const translation = translations[key];\n  if (!translation) return key;\n  \n  const text = translation[lang] || translation['ms'];\n  \n  if (typeof text === 'function') {\n    return text(...args);\n  }\n  \n  return text;\n}\n\nmodule.exports = { translations, t };\n","size_bytes":6544},"handlers/owner.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { t } = require('../utils/translations');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { reloadProviders } = require('../autoBackupManager');\nconst { logAdminAction } = require('../utils/adminLogger');\n\nasync function isOwner(userId) {\n  const admins = await db.getAdmins();\n  return admins.owner === userId;\n}\n\nasync function handleOwnerPanel(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    const user = await db.getUser(userId);\n    const lang = user?.language || 'ms';\n    await ctx.answerCbQuery(t('unauthorized', lang));\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üìä Dashboard' : 'üìä Dashboard', 'owner_dashboard')],\n    [Markup.button.callback(t('btnManageAdmins', lang), 'owner_admins')],\n    [Markup.button.callback(lang === 'ms' ? 'üîê Admin Permissions' : 'üîê Admin Permissions', 'perm_management')],\n    [Markup.button.callback(t('btnStoreSettings', lang), 'owner_settings')],\n    [Markup.button.callback(t('btnBackup', lang), 'owner_backup')],\n    [\n      Markup.button.callback(lang === 'en' ? 'üì¢ Auto Promote' : 'üì¢ Auto Promosi', 'auto_promote_panel'),\n      Markup.button.callback(lang === 'en' ? '‚öôÔ∏è System Functions' : '‚öôÔ∏è Fungsi Sistem', 'system_panel')\n    ],\n    [Markup.button.callback('üìä Analytics / Analitik', 'owner_analytics'), Markup.button.callback('üîß Advanced Settings / Tetapan Lanjutan', 'owner_advanced')],\n    [Markup.button.callback(t('btnBack', lang), 'main_menu')]\n  ];\n  \n  await safeEditMessage(ctx, t('ownerPanel', lang), {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleOwnerAdmins(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  const admins = await db.getAdmins();\n  \n  let text = 'üë• *Admin Management*\\n\\n';\n  text += `üëë Owner: ${admins.owner || 'Not set'}\\n\\n`;\n  \n  if (admins.admins.length > 0) {\n    text += 'üë®‚Äçüíº Admins:\\n';\n    admins.admins.forEach(adminId => {\n      text += `‚Ä¢ ${adminId}\\n`;\n    });\n  } else {\n    text += 'No admins added yet.\\n';\n  }\n  \n  text += '\\n*Commands:*\\n';\n  text += '/setowner - Set yourself as owner\\n';\n  text += '/addadmin [user_id] - Add admin\\n';\n  text += '/removeadmin [user_id] - Remove admin';\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([\n      [Markup.button.callback(t('btnBack', lang), 'owner_panel')]\n    ])\n  });\n}\n\nasync function handleSetOwner(ctx) {\n  const userId = ctx.from.id;\n  const admins = await db.getAdmins();\n  \n  if (admins.owner && admins.owner !== userId) {\n    await ctx.reply('Owner already set. Only current owner can change this.');\n    return;\n  }\n  \n  admins.owner = userId;\n  await db.saveAdmins(admins);\n  \n  await ctx.reply(`‚úÖ You are now set as the owner!`);\n}\n\nasync function handleAddAdmin(ctx, adminId) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.reply('Unauthorized');\n    return;\n  }\n  \n  const admins = await db.getAdmins();\n  \n  if (admins.admins.includes(parseInt(adminId))) {\n    await ctx.reply('User is already an admin');\n    return;\n  }\n  \n  admins.admins.push(parseInt(adminId));\n  await db.saveAdmins(admins);\n  \n  await logAdminAction(userId, 'Added Admin', `User ${adminId} was added as admin`);\n  \n  await ctx.reply(`‚úÖ Admin ${adminId} added successfully!`);\n}\n\nasync function handleRemoveAdmin(ctx, adminId) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.reply('Unauthorized');\n    return;\n  }\n  \n  const admins = await db.getAdmins();\n  admins.admins = admins.admins.filter(id => id !== parseInt(adminId));\n  await db.saveAdmins(admins);\n  \n  await logAdminAction(userId, 'Removed Admin', `User ${adminId} was removed as admin`);\n  \n  await ctx.reply(`‚úÖ Admin ${adminId} removed successfully!`);\n}\n\nasync function handleOwnerSettings(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const settings = await db.getSettings();\n  \n  const welcomeMediaStatus = settings.welcomeMedia?.path ? '‚úÖ Enabled' : '‚ùå Disabled';\n  const qrPaymentStatus = settings.qrPayment?.path ? '‚úÖ Enabled' : '‚ùå Disabled';\n  const sessionTimeoutHours = (settings.sessionTimeout / 3600000).toFixed(1);\n  \n  const text = lang === 'en'\n    ? `‚öôÔ∏è *Store Settings*\\n\\n` +\n      `üè™ Store Name: ${settings.storeName}\\n\\n` +\n      `üì∏ Welcome Media: ${welcomeMediaStatus}\\n` +\n      `üí≥ QR Payment: ${qrPaymentStatus}\\n` +\n      `‚è±Ô∏è Session Timeout: ${sessionTimeoutHours} hours\\n` +\n      `üåê Default Language: ${settings.defaultLanguage.toUpperCase()}\\n` +\n      `üîß Maintenance Mode: ${settings.maintenanceMode ? 'ON' : 'OFF'}`\n    : `‚öôÔ∏è *Tetapan Kedai*\\n\\n` +\n      `üè™ Nama Kedai: ${settings.storeName}\\n\\n` +\n      `üì∏ Media Alu-aluan: ${welcomeMediaStatus}\\n` +\n      `üí≥ Pembayaran QR: ${qrPaymentStatus}\\n` +\n      `‚è±Ô∏è Tamat Sesi: ${sessionTimeoutHours} jam\\n` +\n      `üåê Bahasa Lalai: ${settings.defaultLanguage.toUpperCase()}\\n` +\n      `üîß Mod Penyelenggaraan: ${settings.maintenanceMode ? 'HIDUP' : 'MATI'}`;\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([\n      [Markup.button.callback(t('btnBack', lang), 'owner_panel')]\n    ])\n  });\n}\n\nasync function handleOwnerBackup(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const text = lang === 'en'\n    ? 'üíæ *Backup & Restore*\\n\\n' +\n      'üì• *Download Backup*\\n' +\n      'Use these commands to download data:\\n\\n' +\n      '/backup\\\\_users - Download users data\\n' +\n      '/backup\\\\_products - Download products data\\n' +\n      '/backup\\\\_transactions - Download transactions\\n' +\n      '/backup\\\\_settings - Download settings\\n' +\n      '/backup\\\\_all - Download all data\\n\\n' +\n      'üì§ *Restore*\\n' +\n      'Contact developer for restore assistance.'\n    : 'üíæ *Backup & Pulih*\\n\\n' +\n      'üì• *Muat Turun Backup*\\n' +\n      'Guna arahan ini untuk muat turun data:\\n\\n' +\n      '/backup\\\\_users - Muat turun data pengguna\\n' +\n      '/backup\\\\_products - Muat turun data produk\\n' +\n      '/backup\\\\_transactions - Muat turun transaksi\\n' +\n      '/backup\\\\_settings - Muat turun tetapan\\n' +\n      '/backup\\\\_all - Muat turun semua data\\n\\n' +\n      'üì§ *Pulih*\\n' +\n      'Hubungi pembangun untuk bantuan pulih.';\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([\n      [Markup.button.callback(t('btnBack', lang), 'owner_panel')]\n    ])\n  });\n}\n\nasync function handleAddApi(ctx, token) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.reply('‚ùå Unauthorized / Tidak dibenarkan');\n    return;\n  }\n  \n  if (!token) {\n    const user = await db.getUser(userId);\n    const lang = user?.language || 'ms';\n    const message = lang === 'en' \n      ? '‚ùå Please provide Dropbox API token\\n\\n*Usage:* /addapi [token]'\n      : '‚ùå Sila berikan token API Dropbox\\n\\n*Penggunaan:* /addapi [token]';\n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    return;\n  }\n  \n  try {\n    const settings = await db.getSettings();\n    settings.dropboxToken = token;\n    await db.saveSettings(settings);\n    \n    await reloadProviders();\n    \n    const user = await db.getUser(userId);\n    const lang = user?.language || 'ms';\n    const message = lang === 'en'\n      ? '‚úÖ *Dropbox API token updated successfully!*\\n\\nüîÑ Storage providers have been reloaded with the new token.'\n      : '‚úÖ *Token API Dropbox berjaya dikemaskini!*\\n\\nüîÑ Provider storan telah dimuat semula dengan token baharu.';\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n  } catch (error) {\n    console.error('Error updating Dropbox token:', error);\n    const user = await db.getUser(userId);\n    const lang = user?.language || 'ms';\n    const message = lang === 'en'\n      ? '‚ùå *Error updating Dropbox token*\\n\\nPlease try again or contact support.'\n      : '‚ùå *Ralat mengemaskini token Dropbox*\\n\\nSila cuba lagi atau hubungi sokongan.';\n    await ctx.reply(message, { parse_mode: 'Markdown' });\n  }\n}\n\nasync function handleOwnerAnalytics(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const users = await db.getUsers();\n  const transactions = await db.getTransactions();\n  const products = await db.getProducts();\n  \n  const totalUsers = users.length;\n  const totalOrders = transactions.length;\n  const completedOrders = transactions.filter(t => t.status === 'completed').length;\n  const pendingOrders = transactions.filter(t => t.status === 'awaiting_verification').length;\n  const totalRevenue = transactions\n    .filter(t => t.status === 'completed')\n    .reduce((sum, t) => sum + t.price, 0);\n  const totalProducts = products.length;\n  const activeProducts = products.filter(p => p.active).length;\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const text = lang === 'ms'\n    ? `üìä *Analitik Kedai*\\n\\n` +\n      `üë• Jumlah Pengguna: ${totalUsers}\\n` +\n      `üì¶ Jumlah Produk: ${totalProducts} (${activeProducts} aktif)\\n` +\n      `üìã Jumlah Pesanan: ${totalOrders}\\n` +\n      `‚úÖ Pesanan Selesai: ${completedOrders}\\n` +\n      `‚è≥ Pesanan Pending: ${pendingOrders}\\n` +\n      `üí∞ Jumlah Hasil: RM${totalRevenue.toFixed(2)}\\n` +\n      `üìà Kadar Kejayaan: ${totalOrders > 0 ? ((completedOrders/totalOrders)*100).toFixed(1) : 0}%`\n    : `üìä *Store Analytics*\\n\\n` +\n      `üë• Total Users: ${totalUsers}\\n` +\n      `üì¶ Total Products: ${totalProducts} (${activeProducts} active)\\n` +\n      `üìã Total Orders: ${totalOrders}\\n` +\n      `‚úÖ Completed Orders: ${completedOrders}\\n` +\n      `‚è≥ Pending Orders: ${pendingOrders}\\n` +\n      `üí∞ Total Revenue: RM${totalRevenue.toFixed(2)}\\n` +\n      `üìà Success Rate: ${totalOrders > 0 ? ((completedOrders/totalOrders)*100).toFixed(1) : 0}%`;\n  \n  await ctx.answerCbQuery();\n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[Markup.button.callback(t('btnBack', lang), 'owner_panel')]])\n  });\n}\n\nasync function handleOwnerAdvanced(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const text = lang === 'ms'\n    ? 'üîß *Tetapan Lanjutan*\\n\\n' +\n      '*Pengurusan Produk Lanjutan:*\\n' +\n      '`/duplicate [product_id]` - Salin produk\\n' +\n      '`/inventory [product_id]` - Sejarah inventori\\n' +\n      '`/adjuststock [product_id] [+/-number] [note]` - Laraskan stok\\n\\n' +\n      '*Pengurusan Mata Wang:*\\n' +\n      '`/currency` - Tukar mata wang kedai\\n\\n' +\n      '*Maklum Balas Pelanggan:*\\n' +\n      '`/feedbacks` - Lihat semua maklum balas'\n    : 'üîß *Advanced Settings*\\n\\n' +\n      '*Advanced Product Management:*\\n' +\n      '`/duplicate [product_id]` - Duplicate product\\n' +\n      '`/inventory [product_id]` - Inventory history\\n' +\n      '`/adjuststock [product_id] [+/-number] [note]` - Adjust stock\\n\\n' +\n      '*Currency Management:*\\n' +\n      '`/currency` - Change store currency\\n\\n' +\n      '*Customer Feedback:*\\n' +\n      '`/feedbacks` - View all feedbacks';\n  \n  await ctx.answerCbQuery();\n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[Markup.button.callback(t('btnBack', lang), 'owner_panel')]])\n  });\n}\n\nmodule.exports = {\n  isOwner,\n  handleOwnerPanel,\n  handleOwnerAdmins,\n  handleSetOwner,\n  handleAddAdmin,\n  handleRemoveAdmin,\n  handleOwnerSettings,\n  handleOwnerBackup,\n  handleAddApi,\n  handleOwnerAnalytics,\n  handleOwnerAdvanced\n};\n","size_bytes":12392},"setup.js":{"content":"const db = require('./utils/database');\nconst { generateId } = require('./utils/helpers');\n\nasync function setupExampleData() {\n  console.log('Setting up example data...\\n');\n  \n  const categories = [\n    {\n      id: generateId('CAT'),\n      name: { ms: 'Streaming Premium', en: 'Premium Streaming' },\n      icon: 'üé¨',\n      createdAt: new Date().toISOString()\n    },\n    {\n      id: generateId('CAT'),\n      name: { ms: 'Aplikasi Premium', en: 'Premium Apps' },\n      icon: 'üì±',\n      createdAt: new Date().toISOString()\n    },\n    {\n      id: generateId('CAT'),\n      name: { ms: 'Akaun Gaming', en: 'Gaming Accounts' },\n      icon: 'üéÆ',\n      createdAt: new Date().toISOString()\n    }\n  ];\n  \n  await db.saveCategories(categories);\n  console.log('‚úÖ Categories created:');\n  categories.forEach(cat => {\n    console.log(`   ${cat.icon} ${cat.name.ms} (${cat.id})`);\n  });\n  \n  const exampleProducts = [\n    {\n      id: generateId('PROD'),\n      categoryId: categories[0].id,\n      name: { ms: 'Netflix Premium', en: 'Netflix Premium' },\n      description: { \n        ms: 'Akaun Netflix Premium untuk 1 bulan. 4K Ultra HD, 4 peranti serentak.',\n        en: 'Netflix Premium account for 1 month. 4K Ultra HD, 4 simultaneous devices.'\n      },\n      price: 15.00,\n      stock: 5,\n      active: true,\n      deliveryType: 'auto',\n      items: [\n        'Email: netflix1@example.com | Pass: demo123',\n        'Email: netflix2@example.com | Pass: demo456'\n      ],\n      createdAt: new Date().toISOString()\n    },\n    {\n      id: generateId('PROD'),\n      categoryId: categories[1].id,\n      name: { ms: 'CapCut Pro', en: 'CapCut Pro' },\n      description: { \n        ms: 'Akaun CapCut Pro dengan semua ciri premium. 1 tahun.',\n        en: 'CapCut Pro account with all premium features. 1 year.'\n      },\n      price: 25.00,\n      stock: 10,\n      active: true,\n      deliveryType: 'auto',\n      items: [\n        'Invite Link: https://capcut.com/invite/xxx',\n        'Invite Link: https://capcut.com/invite/yyy'\n      ],\n      createdAt: new Date().toISOString()\n    },\n    {\n      id: generateId('PROD'),\n      categoryId: categories[1].id,\n      name: { ms: 'Canva Pro', en: 'Canva Pro' },\n      description: { \n        ms: 'Akses Canva Pro penuh. Semua template premium, 1TB storage.',\n        en: 'Full Canva Pro access. All premium templates, 1TB storage.'\n      },\n      price: 20.00,\n      stock: 8,\n      active: true,\n      deliveryType: 'manual',\n      items: [],\n      createdAt: new Date().toISOString()\n    }\n  ];\n  \n  await db.saveProducts(exampleProducts);\n  console.log('\\n‚úÖ Example products created:');\n  exampleProducts.forEach(prod => {\n    console.log(`   üì¶ ${prod.name.ms} - RM${prod.price} (${prod.deliveryType})`);\n  });\n  \n  console.log('\\n‚úÖ Setup complete!');\n  console.log('\\nNext steps:');\n  console.log('1. Add your bot token to config.js');\n  console.log('2. Run: npm start');\n  console.log('3. Open Telegram and search for your bot');\n  console.log('4. Send /start and then /setowner');\n  console.log('5. Upload your payment QR to qr/ folder');\n}\n\nif (require.main === module) {\n  setupExampleData().catch(console.error);\n}\n\nmodule.exports = { setupExampleData };\n","size_bytes":3206},"handlers/payment.js":{"content":"const db = require('../utils/database');\nconst { t } = require('../utils/translations');\nconst { Markup } = require('telegraf');\n\nasync function handleSendPayment(ctx) {\n  const userId = ctx.from.id;\n  const orderId = ctx.message.text.split(' ')[1];\n\n  if (!orderId) {\n    await ctx.reply('‚ùå Invalid command format.\\n\\nUsage: /send [order_id]\\n\\nExample: /send ORD-ABC123');\n    return;\n  }\n\n  const transactions = await db.getTransactions();\n  const order = transactions.find(t => (t.id === orderId || t.id.toLowerCase() === orderId.toLowerCase()) && t.userId === userId);\n\n  if (!order) {\n    const user = await db.getUser(userId);\n    const lang = user?.language || 'ms';\n    const msg = lang === 'ms'\n      ? `‚ùå Pesanan tidak dijumpai atau bukan milik anda!\\n\\nüÜî Order ID: \\`${orderId}\\`\\n\\nüí° Tip: Gunakan \"Pesanan Saya\" di menu utama untuk lihat order anda.`\n      : `‚ùå Order not found or does not belong to you!\\n\\nüÜî Order ID: \\`${orderId}\\`\\n\\nüí° Tip: Use \"My Orders\" in main menu to view your orders.`;\n    await ctx.reply(msg, { parse_mode: 'Markdown' });\n    return;\n  }\n\n  let photo = null;\n  let document = null;\n\n  if (ctx.message.photo) {\n    photo = ctx.message.photo[ctx.message.photo.length - 1];\n  } else if (ctx.message.reply_to_message?.photo) {\n    photo = ctx.message.reply_to_message.photo[ctx.message.reply_to_message.photo.length - 1];\n  } else if (ctx.message.document && ctx.message.document.mime_type?.startsWith('image/')) {\n    document = ctx.message.document;\n  } else if (ctx.message.reply_to_message?.document && ctx.message.reply_to_message.document.mime_type?.startsWith('image/')) {\n    document = ctx.message.reply_to_message.document;\n  }\n\n  if (!photo && !document) {\n    const user = await db.getUser(userId);\n    const lang = user?.language || 'ms';\n    const message = lang === 'ms'\n      ? `üì∏ *Cara Hantar Bukti Pembayaran:*\n\nüì± *Cara 1 (Mudah):*\n1. Ambil screenshot resit pembayaran\n2. Hantar gambar dengan caption \\`/send\\`\n\nüì± *Cara 2:*\n1. Hantar gambar resit dahulu\n2. Reply gambar tersebut\n3. Taip: \\`/send\\`\n\n‚ö†Ô∏è *Penting:*\n‚Ä¢ Pastikan gambar jelas dan boleh dibaca\n‚Ä¢ Pastikan jumlah pembayaran betul\n‚Ä¢ Admin akan sahkan dalam 5-10 minit\n\nüí° Jika ada masalah, hubungi support!`\n      : `üì∏ *How to Send Payment Proof:*\n\nüì± *Method 1 (Easy):*\n1. Take screenshot of payment receipt\n2. Send photo with caption \\`/send\\`\n\nüì± *Method 2:*\n1. Send receipt photo first\n2. Reply to that photo\n3. Type: \\`/send\\`\n\n‚ö†Ô∏è *Important:*\n‚Ä¢ Ensure photo is clear and readable\n‚Ä¢ Ensure payment amount is correct\n‚Ä¢ Admin will verify within 5-10 minutes\n\nüí° If you have issues, contact support!`;\n\n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    return;\n  }\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  const pendingOrders = transactions.filter(t => t.userId === userId && t.status === 'pending');\n\n  if (pendingOrders.length === 0) {\n    const message = lang === 'ms'\n      ? `‚ùå *Tiada Order Pending*\n\nAnda tidak mempunyai order yang menunggu pembayaran.\n\nüìù *Langkah Seterusnya:*\n1Ô∏è‚É£ Buat order baru dahulu\n2Ô∏è‚É£ Lengkapkan pembayaran\n3Ô∏è‚É£ Kemudian hantar bukti pembayaran\n\nüõí Tekan /start untuk ke menu utama dan buat order.`\n      : `‚ùå *No Pending Order*\n\nYou don't have any orders waiting for payment.\n\nüìù *Next Steps:*\n1Ô∏è‚É£ Create a new order first\n2Ô∏è‚É£ Complete payment\n3Ô∏è‚É£ Then send payment proof\n\nüõí Press /start to go to main menu and create order.`;\n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    return;\n  }\n\n  if (pendingOrders.length > 1) {\n    const message = lang === 'ms'\n      ? `üìã *Pilih Order untuk Bayar*\\n\\nAnda mempunyai ${pendingOrders.length} order yang menunggu pembayaran.\\nSila pilih order:`\n      : `üìã *Select Order to Pay*\\n\\nYou have ${pendingOrders.length} pending orders.\\nPlease select an order:`;\n\n    const buttons = pendingOrders.map(order => {\n      const productName = typeof order.productName === 'object'\n        ? (order.productName.ms || order.productName.en)\n        : order.productName;\n      return [Markup.button.callback(\n        `${order.id} - ${productName} (RM${order.price})`,\n        `send_payment_${order.id}`\n      )];\n    });\n\n    ctx.session = ctx.session || {};\n    ctx.session.pendingPaymentProof = photo?.file_id || document?.file_id;\n    ctx.session.isDocument = !!document;\n\n    await ctx.reply(message, {\n      parse_mode: 'Markdown',\n      ...Markup.inlineKeyboard(buttons)\n    });\n    return;\n  }\n\n  const pendingOrder = pendingOrders[0];\n\n  pendingOrder.paymentProof = photo?.file_id || document?.file_id;\n  pendingOrder.status = 'awaiting_verification';\n  pendingOrder.paymentSubmittedAt = new Date().toISOString();\n\n  await db.saveTransactions(transactions);\n\n  const successMessage = lang === 'ms'\n    ? `‚úÖ *Bukti Pembayaran Diterima!*\n\nüÜî Order ID: \\`${pendingOrder.id}\\`\n‚è∞ Diserahkan: ${new Date().toLocaleString('ms-MY')}\n\nAdmin kami akan sahkan pembayaran anda tidak lama lagi (biasanya dalam 5-10 minit).\n\nAnda akan terima notifikasi sebaik sahaja order disahkan!\n\nüí¨ Ada soalan? Hubungi support kami.`\n    : `‚úÖ *Payment Proof Received!*\n\nüÜî Order ID: \\`${pendingOrder.id}\\`\n‚è∞ Submitted: ${new Date().toLocaleString('en-MY')}\n\nOur admin will verify your payment shortly (usually within 5-10 minutes).\n\nYou will receive a notification once the order is verified!\n\nüí¨ Any questions? Contact our support.`;\n\n  await ctx.reply(successMessage, { parse_mode: 'Markdown' });\n\n  await sendPaymentProofToAdmins(ctx, pendingOrder, userId, photo, document);\n}\n\nasync function handlePaymentSelection(ctx, orderId) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const transactions = await db.getTransactions();\n  const order = transactions.find(t => t.id === orderId && t.userId === userId);\n\n  if (!order || order.status !== 'pending') {\n    await ctx.answerCbQuery(lang === 'ms' ? '‚ùå Order tidak sah' : '‚ùå Invalid order');\n    return;\n  }\n\n  ctx.session = ctx.session || {};\n  const proofFileId = ctx.session.pendingPaymentProof;\n  const isDocument = ctx.session.isDocument;\n\n  if (!proofFileId) {\n    await ctx.answerCbQuery(lang === 'ms' ? '‚ùå Bukti pembayaran tidak dijumpai' : '‚ùå Payment proof not found');\n    return;\n  }\n\n  order.paymentProof = proofFileId;\n  order.status = 'awaiting_verification';\n  order.paymentSubmittedAt = new Date().toISOString();\n\n  // Update the transactions array with the modified order\n  const orderIndex = transactions.findIndex(t => t.id === orderId);\n  if (orderIndex !== -1) {\n    transactions[orderIndex] = order;\n  }\n\n  await db.saveTransactions(transactions);\n\n  delete ctx.session.pendingPaymentProof;\n  delete ctx.session.isDocument;\n\n  const successMessage = lang === 'ms'\n    ? `‚úÖ *Bukti Pembayaran Diterima!*\n\nüÜî Order ID: \\`${order.id}\\`\n‚è∞ Diserahkan: ${new Date().toLocaleString('ms-MY')}\n\nAdmin kami akan sahkan pembayaran anda tidak lama lagi (biasanya dalam 5-10 minit).\n\nAnda akan terima notifikasi sebaik sahaja order disahkan!\n\nüí¨ Ada soalan? Hubungi support kami.`\n    : `‚úÖ *Payment Proof Received!*\n\nüÜî Order ID: \\`${order.id}\\`\n‚è∞ Submitted: ${new Date().toLocaleString('en-MY')}\n\nOur admin will verify your payment shortly (usually within 5-10 minutes).\n\nYou will receive a notification once the order is verified!\n\nüí¨ Any questions? Contact our support.`;\n\n  await ctx.answerCbQuery(lang === 'ms' ? '‚úÖ Bukti diterima' : '‚úÖ Proof received');\n  await ctx.reply(successMessage, { parse_mode: 'Markdown' });\n\n  const photo = !isDocument ? { file_id: proofFileId } : null;\n  const document = isDocument ? { file_id: proofFileId } : null;\n\n  await sendPaymentProofToAdmins(ctx, order, userId, photo, document);\n}\n\nasync function sendPaymentProofToAdmins(ctx, order, userId, photo, document) {\n  const admins = await db.getAdmins();\n  const allAdmins = [admins.owner, ...admins.admins].filter(Boolean);\n\n  let voucherInfo = '';\n  if (order.voucherCode && order.discount != null && order.originalPrice != null) {\n    voucherInfo = `\\nüí≥ Voucher: ${order.voucherCode}\\nüí∞ Original: RM${order.originalPrice}\\nüéâ Discount: -RM${order.discount.toFixed(2)}\\n‚úÖ Final: RM${order.price.toFixed(2)}`;\n  } else {\n    const amount = typeof order.price === 'number' ? order.price.toFixed(2) : order.price;\n    voucherInfo = `\\nüí∞ Amount: RM${amount}`;\n  }\n\n  const productName = typeof order.productName === 'object'\n    ? (order.productName.ms || order.productName.en || 'Product')\n    : (order.productName || 'Product');\n\n  const caption = `üí≥ *Payment Proof Received*\\n\\nüÜî Order ID: \\`${order.id}\\`\\nüë§ Customer ID: \\`${userId}\\`\\nüì¶ Product: ${productName}${voucherInfo}\\n‚è∞ Time: ${new Date().toLocaleString('ms-MY')}\\n\\n‚úÖ Use /verify ${order.id} to approve\\n‚ùå Use /reject ${order.id} to reject`;\n\n  const buttons = Markup.inlineKeyboard([\n    [Markup.button.callback('‚úÖ Verify', `verify_order_${order.id}`)],\n    [Markup.button.callback('‚ùå Reject', `reject_order_${order.id}`)]\n  ]);\n\n  for (const adminId of allAdmins) {\n    try {\n      if (photo) {\n        await ctx.telegram.sendPhoto(adminId, photo.file_id, {\n          caption,\n          parse_mode: 'Markdown',\n          ...buttons\n        });\n      } else if (document) {\n        await ctx.telegram.sendDocument(adminId, document.file_id, {\n          caption,\n          parse_mode: 'Markdown',\n          ...buttons\n        });\n      }\n    } catch (error) {\n      console.error(`Failed to notify admin ${adminId}:`, error.message);\n    }\n  }\n}\n\nasync function handleViewPendingOrders(ctx) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const transactions = await db.getTransactions();\n  const pendingOrders = transactions.filter(t => t.userId === userId && t.status === 'pending');\n\n  if (pendingOrders.length === 0) {\n    const message = lang === 'ms'\n      ? '‚úÖ *Tiada Order Pending*\\n\\nAnda tidak mempunyai order yang menunggu pembayaran.'\n      : '‚úÖ *No Pending Orders*\\n\\nYou have no orders waiting for payment.';\n\n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    return;\n  }\n\n  let message = lang === 'ms'\n    ? `üìã *Order Pending Pembayaran*\\n\\nAnda mempunyai ${pendingOrders.length} order:\\n\\n`\n    : `üìã *Orders Pending Payment*\\n\\nYou have ${pendingOrders.length} orders:\\n\\n`;\n\n  pendingOrders.forEach((order, index) => {\n    const productName = typeof order.productName === 'object'\n      ? (order.productName.ms || order.productName.en)\n      : order.productName;\n\n    message += `${index + 1}. üÜî \\`${order.id}\\`\\n`;\n    message += `   üì¶ ${productName}\\n`;\n    message += `   üí∞ RM${order.price}\\n`;\n    message += `   üìÖ ${new Date(order.createdAt).toLocaleString(lang === 'ms' ? 'ms-MY' : 'en-MY')}\\n\\n`;\n  });\n\n  message += lang === 'ms'\n    ? '\\nüí° *Hantar bukti pembayaran:*\\n1. Ambil screenshot resit\\n2. Hantar gambar dengan caption `/send`'\n    : '\\nüí° *Send payment proof:*\\n1. Take screenshot of receipt\\n2. Send photo with caption `/send`';\n\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nmodule.exports = {\n  handleSendPayment,\n  handlePaymentSelection,\n  handleViewPendingOrders\n};","size_bytes":11308},"utils/database.js":{"content":"const fs = require('fs').promises;\nconst path = require('path');\n\nclass Database {\n  constructor(dataDir = 'data') {\n    this.dataDir = dataDir;\n  }\n\n  async read(file) {\n    try {\n      const filePath = path.join(this.dataDir, file);\n      const data = await fs.readFile(filePath, 'utf8');\n      return JSON.parse(data);\n    } catch (error) {\n      console.error(`Error reading ${file}:`, error.message);\n      return file.includes('.json') ? (file === 'admins.json' ? { owner: null, admins: [] } : []) : {};\n    }\n  }\n\n  async write(file, data) {\n    try {\n      const filePath = path.join(this.dataDir, file);\n      await fs.writeFile(filePath, JSON.stringify(data, null, 2), 'utf8');\n      return true;\n    } catch (error) {\n      console.error(`Error writing ${file}:`, error.message);\n      return false;\n    }\n  }\n\n  async getUsers() {\n    return await this.read('users.json');\n  }\n\n  async saveUsers(users) {\n    return await this.write('users.json', users);\n  }\n\n  async getUser(userId) {\n    const users = await this.getUsers();\n    return users.find(u => u.id === userId);\n  }\n\n  async addUser(user) {\n    const users = await this.getUsers();\n    const existing = users.find(u => u.id === user.id);\n    if (!existing) {\n      const newUser = {\n        ...user,\n        createdAt: new Date().toISOString(),\n        language: 'ms',\n        points: 0\n      };\n      users.push(newUser);\n      await this.saveUsers(users);\n      return newUser;\n    }\n    return existing;\n  }\n\n  async updateUser(userId, updates) {\n    const users = await this.getUsers();\n    const index = users.findIndex(u => u.id === userId);\n    if (index !== -1) {\n      users[index] = { ...users[index], ...updates };\n      await this.saveUsers(users);\n      return users[index];\n    }\n    return null;\n  }\n\n  async getProducts() {\n    return await this.read('products.json');\n  }\n\n  async saveProducts(products) {\n    return await this.write('products.json', products);\n  }\n\n  async getCategories() {\n    return await this.read('categories.json');\n  }\n\n  async saveCategories(categories) {\n    return await this.write('categories.json', categories);\n  }\n\n  async getTransactions() {\n    return await this.read('transactions.json');\n  }\n\n  async saveTransactions(transactions) {\n    return await this.write('transactions.json', transactions);\n  }\n\n  async getSessions() {\n    return await this.read('sessions.json');\n  }\n\n  async saveSessions(sessions) {\n    return await this.write('sessions.json', sessions);\n  }\n\n  async getAdmins() {\n    return await this.read('admins.json');\n  }\n\n  async saveAdmins(admins) {\n    return await this.write('admins.json', admins);\n  }\n\n  async getSettings() {\n    return await this.read('settings.json');\n  }\n\n  async saveSettings(settings) {\n    return await this.write('settings.json', settings);\n  }\n\n  async getVouchers() {\n    return await this.read('vouchers.json');\n  }\n\n  async saveVouchers(vouchers) {\n    return await this.write('vouchers.json', vouchers);\n  }\n\n  async getVoucher(code) {\n    const vouchers = await this.getVouchers();\n    return vouchers.find(v => v.code.toUpperCase() === code.toUpperCase());\n  }\n}\n\nmodule.exports = new Database();\n","size_bytes":3178},"QUICK_START.md":{"content":"# üöÄ Quick Start Guide - CexiStore Bot\n\n## Step 1: Get Bot Token (2 minutes)\n\n1. Open Telegram\n2. Search for: **@BotFather**\n3. Send: `/newbot`\n4. Choose a name: **My Store Bot**\n5. Choose username: **mystorebot** (must end with 'bot')\n6. Copy the token you receive (looks like: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)\n\n## Step 2: Configure Bot (1 minute)\n\n1. Open `config.js`\n2. Replace `YOUR_BOT_TOKEN_HERE` with your token:\n\n```javascript\nTELEGRAM_BOT_TOKEN: '123456789:ABCdefGHIjklMNOpqrsTUVwxyz',\n```\n\n3. Save the file\n\n## Step 3: Setup Example Data (Optional)\n\nRun this to create example categories and products:\n\n```bash\nnode setup.js\n```\n\n## Step 4: Start Bot\n\n```bash\nnpm start\n```\n\nYou should see: `üöÄ CexiStore Bot is running!`\n\n## Step 5: Configure on Telegram (3 minutes)\n\n1. Open Telegram\n2. Search for your bot username\n3. Send: `/start`\n4. Send: `/setowner` (makes you the owner)\n5. Upload your payment QR code to `qr/` folder\n6. Done! üéâ\n\n## Step 6: Test the Bot\n\n### Add a Category\n```\n/addcategory Netflix Premium\n```\n\n### Add a Product\n```\n/addproduct CAT-XXXXX | Netflix Account | 15.00 | 5 | Premium account 1 month | auto\n```\n(Replace CAT-XXXXX with the category ID from step above)\n\n### Test Order Flow\n1. Click \"üõí Beli Produk\"\n2. Select category\n3. Select product\n4. Click \"üí≥ Beli Sekarang\"\n5. Bot sends QR code\n6. User uploads payment proof with `/send`\n7. Admin verifies with `/verify ORD-XXXXX`\n\n## Admin Commands Cheatsheet\n\n```bash\n/verify [order_id]     # Approve order\n/reject [order_id]     # Reject order\n/join [token]          # Join support chat\n/addadmin [user_id]    # Add admin\n/addcategory [name]    # Add category\n/listproducts          # List all products\n```\n\n## üìù Important Notes\n\n- **Token Location**: All config in `config.js` (not .env)\n- **Data Storage**: JSON files in `data/` folder\n- **QR Codes**: Upload to `qr/` folder\n- **Language**: Default is Malay, users can toggle to English\n- **Session Timeout**: 4 hours for support chats\n- **Auto Delivery**: Set product type to \"auto\" with items array\n\n## üîß Troubleshooting\n\n**Bot won't start?**\n- Check if token is correct in config.js\n- Make sure token doesn't have spaces\n\n**No products showing?**\n- Check stock is > 0\n- Check product is set to active: true\n\n**Payment not working?**\n- Add QR image to qr/ folder\n- Update path in data/settings.json\n\n## üì± User Experience Flow\n\n1. User sends `/start`\n2. Sees main menu with inline buttons\n3. Browses products by category\n4. Makes purchase\n5. Gets QR payment\n6. Uploads proof with `/send`\n7. Receives item after admin verification\n\n## üëë Owner Functions\n\n- Set owner: `/setowner`\n- Add admin: `/addadmin [telegram_id]`\n- Remove admin: `/removeadmin [telegram_id]`\n- Access owner panel from main menu\n\n---\n\n**Need help?** Check README.md for full documentation.\n","size_bytes":2831},"index.js":{"content":"const { Telegraf, Markup } = require('telegraf');\nconst { handleStart, handleMainMenu, handleLanguageToggle, handleLanguageSelect } = require('./handlers/start');\nconst { handleBuyProducts, handleCategory, handleProductView, handleBuyProduct } = require('./handlers/products');\nconst { handleSendPayment, handlePaymentSelection, handleViewPendingOrders } = require('./handlers/payment');\nconst { handleMyOrders, handleMyItems } = require('./handlers/orders');\nconst { handleCreateVoucher, handleRedeemVoucher, handleListVouchers, handleToggleVoucher, handleCheckVoucher } = require('./handlers/voucher');\nconst { handleAdminPanel, handleAdminOrders, handleVerifyOrder, handleRejectOrder, handleAdminProducts, handleAdminSessions, handleAdminBroadcast, handleBroadcastMessage, handleCheckAllOrderId, handleAdminStatistics, handleAllOrders, handleViewOrder, handleDeleteOrderConfirm, handleDeleteOrder } = require('./handlers/admin');\nconst { handleCategoryManagement, handleCategoryDetail, handleDeleteCategory, handleEditCategoryName, handleEditCategoryIcon, processCategoryEdit } = require('./handlers/categoryManagement');\nconst { handleProductManagementMenu, handleProductList, handleProductDetail, handleToggleProduct, handleDeleteProductConfirm, handleDeleteProduct, handleEditProductField, processProductEdit, handleLowStockProducts } = require('./handlers/productManagementImproved');\nconst { handleOwnerPanel, handleOwnerAdmins, handleSetOwner, handleAddAdmin, handleRemoveAdmin, handleOwnerSettings, handleOwnerBackup, handleAddApi, handleOwnerAnalytics, handleOwnerAdvanced } = require('./handlers/owner');\nconst { handleSupport, handleJoinSession, handleLeaveSession, handleCloseSession, handleEndSession, handleSessionMessage, handleListSessions, handleSetActiveSession, handleSendToSession } = require('./handlers/session');\nconst { handleBanUser, handleUnbanUser, handleTagUser, handleUntagUser, handleListBannedUsers, checkIfBanned } = require('./handlers/userManagement');\nconst { handleSearchOrders, handleFilterOrders, handleFilterCallback } = require('./handlers/orderSearch');\nconst { handleDuplicateProduct, handleInventoryHistory, handleStockAdjustment } = require('./handlers/productManagement');\nconst { handleAddTemplate, handleQuickTemplate, handleListTemplates, handleDeleteTemplate, handleAddFAQ, handleFAQList, handleListFAQs, handleDeleteFAQ, checkFAQResponse } = require('./handlers/autoReply');\nconst { handleSetCurrency, handleCurrencySelect } = require('./handlers/currency');\nconst { handleRating, handleFeedbackComment, handleSkipFeedback, handleViewFeedbacks } = require('./handlers/feedback');\nconst { handlePing } = require('./handlers/ping');\nconst { handleAutoPromotePanel, handleCreateBroadcast, handleScheduleMessage, handlePromoTemplates, handleUserTargeting, handlePromoAnalytics, handleABTesting, handleDiscountCodes, handleFlashSales, handleRepeatCampaigns, handleActiveCampaigns, handleBroadcastAll, handleBroadcastActive, handleBroadcastTagged, handleTargetAll, handleTargetActive, handleTargetTagged, handleTargetBuyers, handlePromoDetailedReport, handleCreateABTest, handleABTestResults, handlePauseAllCampaigns, handleViewSchedule, handleUsePromoTemplate, handleViewDiscount, handleViewFlash, handleViewRepeat, handleScheduleMsg, handleAddPromoTemplate, handleCreateABTestCommand, handleCreateDiscount, handleCreateFlash, handleRepeatCampaign } = require('./handlers/autoPromote');\nconst { handleSystemPanel, handleUserStats, handleSalesAnalytics, handleAdminLogs, handleHealthCheck, handleStorageUsage, handleExportData, handleMaintenanceMode, handleBackupUI, handleErrorMonitor, handlePerformance, handleAPILimits, handleWebhookLogs, handleTransactionReports, handleInventoryAlerts, handleSessionAnalytics, handleEngagement, handleRevenue, handleImportData, handleSystemSettings, handleCacheManagement, handleExportUsers, handleExportProducts, handleExportTransactions, handleExportAll, handleStoreStatus, handleToggleStoreStatus, handleToggleMaintenance } = require('./handlers/systemFunctions');\n\n// NEW IMPROVEMENTS\nconst { handleBulkOperations, handleBulkActivateAll, handleBulkDeactivateAll, handleBulkPriceByCategory, handleBulkPriceCategorySelect, handleBulkStockByCategory, handleBulkStockCategorySelect, processBulkEdit, handleBulkDeleteInactive, handleBulkDeleteConfirm } = require('./handlers/productBulkOperations');\nconst { handleProductSearch, processProductSearch, handleProductFilter, handleFilterCallback: handleProductFilterCallback } = require('./handlers/productSearch');\nconst { handleCategorySort, handleCategorySortCallback, handleCategoryAnalytics, handleCategoryIconSelector, handleSetCategoryIcon } = require('./handlers/categoryAdvanced');\nconst { handleOwnerDashboard, handleDetailedReport, handleTrendAnalysis } = require('./handlers/ownerDashboard');\nconst { handleQuickActionsMenu, handleQuickVerify, handleQuickVerifyOrder, handleQuickRejectOrder, handleQuickVerifyAll, handleQuickStock, processQuickStock, handleQuickPrice, processQuickPrice } = require('./handlers/adminQuickActions');\nconst { initializeStockAlerts, sendManualStockAlert } = require('./handlers/stockAlerts');\nconst { handleProductStats, handleAllProductsStats } = require('./handlers/productStats');\nconst { exportProductsCSV, exportTransactionsCSV, exportUsersCSV, exportSalesReport, handleExportMenu } = require('./handlers/exportReports');\nconst { handlePermissionsManagement, handleAdminPermissionsEdit, handleTogglePermission, handleAdminActivityLog } = require('./handlers/adminPermissions');\n\n// NEWEST FEATURES (November 2025)\nconst { handleProductOptions, handleAddOption, handleOptionDetail, handleToggleOptionRequired, handleDeleteOption, processOptionInput, handleOptionRequired } = require('./handlers/productOptions');\nconst { handleScheduledProducts, handleScheduleProduct, processScheduleInput, handleCancelSchedule, checkScheduledProducts } = require('./handlers/scheduledPublishing');\nconst { handleCategoryDiscounts, handleCategoryDiscountDetail, handleAddCategoryDiscount, processDiscountInput, handleRemoveCategoryDiscount, getDiscountedPrice } = require('./handlers/categoryDiscounts');\nconst { handleProductReviews, requestReview, handleRatingSelect, processReviewComment, handleViewAllReviews } = require('./handlers/reviewRating');\nconst { handleAdvancedOrderFilters, handleDateFilter, processCustomDateInput } = require('./handlers/advancedOrderFilter');\nconst { handleQuickEditMenu, handleQuickEditAction, processQuickEditInput } = require('./handlers/quickEditProduct');\nconst { handleProductImages, handleAddProductImage, processProductImage, handleViewProductImages, handleDeleteProductImage } = require('./handlers/productImageManagement');\n\nconst { runBackup } = require('./autoBackupManager');\nconst db = require('./utils/database');\nconst { generateId } = require('./utils/helpers');\nconst { safeEditMessage } = require('./utils/messageHelper');\nconst { t } = require('./utils/translations');\nconst config = require('./config');\n\nconst bot = new Telegraf(config.TELEGRAM_BOT_TOKEN);\n\n// Safe wrapper for callback handlers to prevent crashes\nfunction safeHandler(handler) {\n  return async (ctx) => {\n    try {\n      await handler(ctx);\n    } catch (error) {\n      console.error('Handler error:', error.message);\n      console.error('Stack:', error.stack);\n      console.error('Handler:', handler.name);\n\n      try {\n        if (ctx.callbackQuery) {\n          await ctx.answerCbQuery('Error occurred. Please try again.').catch(() => {});\n        }\n\n        const user = await db.getUser(ctx?.from?.id);\n        const lang = user?.language || 'ms';\n        const msg = lang === 'ms' ? '‚ùå Ralat. Sila cuba lagi.' : '‚ùå Error. Please try again.';\n        await ctx.reply(msg);\n      } catch (replyErr) {\n        console.error('Failed to send error response:', replyErr);\n      }\n    }\n  };\n}\n\n// Middleware to check if user is banned\nbot.use(async (ctx, next) => {\n  if (ctx.from) {\n    const isBanned = await checkIfBanned(ctx.from.id);\n    if (isBanned) {\n      const user = await db.getUser(ctx.from.id);\n      await ctx.reply(\n        `üö´ *You are banned from using this store.*\\n\\nüìù Reason: ${user.bannedReason || 'No reason provided'}\\n\\nPlease contact admin if you think this is a mistake.`,\n        { parse_mode: 'Markdown' }\n      );\n      return;\n    }\n  }\n  return next();\n});\n\nbot.start(safeHandler(handleStart));\n\nbot.command('send', safeHandler(handleSendPayment));\n\nbot.command('pendingorders', safeHandler(handleViewPendingOrders));\n\nbot.command('verify', safeHandler(async (ctx) => {\n  const orderId = ctx.message.text.split(' ')[1];\n  if (!orderId) {\n    await ctx.reply('Usage: /verify [order_id]');\n    return;\n  }\n  await handleVerifyOrder(ctx, orderId);\n}));\n\nbot.command('reject', safeHandler(async (ctx) => {\n  const orderId = ctx.message.text.split(' ')[1];\n  if (!orderId) {\n    await ctx.reply('Usage: /reject [order_id]');\n    return;\n  }\n  await handleRejectOrder(ctx, orderId);\n}));\n\nbot.command('checkallorderid', safeHandler(handleCheckAllOrderId));\n\nbot.command('setowner', safeHandler(handleSetOwner));\n\nbot.command('addadmin', safeHandler(async (ctx) => {\n  const adminId = ctx.message.text.split(' ')[1];\n  if (!adminId) {\n    await ctx.reply('Usage: /addadmin [user_id]');\n    return;\n  }\n  await handleAddAdmin(ctx, adminId);\n}));\n\nbot.command('removeadmin', safeHandler(async (ctx) => {\n  const adminId = ctx.message.text.split(' ')[1];\n  if (!adminId) {\n    await ctx.reply('Usage: /removeadmin [user_id]');\n    return;\n  }\n  await handleRemoveAdmin(ctx, adminId);\n}));\n\nbot.command('addapi', safeHandler(async (ctx) => {\n  const token = ctx.message.text.split(' ').slice(1).join(' ');\n  await handleAddApi(ctx, token);\n}));\n\nbot.command('join', safeHandler(async (ctx) => {\n  const token = ctx.message.text.split(' ')[1];\n  if (!token) {\n    await ctx.reply('Usage: /join [session_token]');\n    return;\n  }\n  await handleJoinSession(ctx, token);\n}));\n\nbot.command('leave', safeHandler(async (ctx) => {\n  const token = ctx.message.text.split(' ')[1];\n  await handleLeaveSession(ctx, token);\n}));\n\nbot.command('close', safeHandler(handleCloseSession));\n\nbot.command('sessions', safeHandler(handleListSessions));\n\nbot.command('active', safeHandler(async (ctx) => {\n  const token = ctx.message.text.split(' ')[1];\n  if (!token) {\n    await ctx.reply('Usage: /active [session_token]\\n\\nExample: /active SES-ABC123');\n    return;\n  }\n  await handleSetActiveSession(ctx, token);\n}));\n\nbot.command('msg', safeHandler(async (ctx) => {\n  const parts = ctx.message.text.split(' ');\n  const token = parts[1];\n  const message = parts.slice(2).join(' ');\n\n  if (!token || !message) {\n    await ctx.reply('Usage: /msg [session_token] [message]\\n\\nExample: /msg SES-ABC123 Hello, how can I help you?');\n    return;\n  }\n\n  await handleSendToSession(ctx, token, message);\n}));\n\n// User Management Commands\nbot.command('ban', safeHandler(async (ctx) => {\n  const parts = ctx.message.text.split(' ');\n  const userId = parts[1];\n  const reason = parts.slice(2).join(' ') || 'No reason provided';\n  await handleBanUser(ctx, userId, reason);\n}));\n\nbot.command('unban', safeHandler(async (ctx) => {\n  const userId = ctx.message.text.split(' ')[1];\n  await handleUnbanUser(ctx, userId);\n}));\n\nbot.command('tag', safeHandler(async (ctx) => {\n  const parts = ctx.message.text.split(' ');\n  const userId = parts[1];\n  const tag = parts[2];\n  await handleTagUser(ctx, userId, tag);\n}));\n\nbot.command('untag', safeHandler(async (ctx) => {\n  const parts = ctx.message.text.split(' ');\n  const userId = parts[1];\n  const tag = parts[2];\n  await handleUntagUser(ctx, userId, tag);\n}));\n\nbot.command('bannedlist', safeHandler(handleListBannedUsers));\n\n// Advanced Order Search\nbot.command('searchorder', safeHandler(async (ctx) => {\n  const query = ctx.message.text.replace('/searchorder', '').trim();\n\n  // Check if user is searching their own order\n  const { isAdmin } = require('./handlers/admin');\n  const { isOwner } = require('./handlers/owner');\n  const userId = ctx.from.id;\n  const isAdminUser = await isAdmin(userId) || await isOwner(userId);\n\n  if (!isAdminUser && query) {\n    // Allow users to search their own orders\n    const transactions = await db.getTransactions();\n    const userOrder = transactions.find(t => \n      (t.id === query || t.id.toLowerCase() === query.toLowerCase()) && \n      t.userId === userId\n    );\n\n    if (userOrder) {\n      const user = await db.getUser(userId);\n      const lang = user?.language || 'ms';\n      const statusEmoji = {\n        'pending': '‚è≥',\n        'awaiting_verification': 'üí≥',\n        'completed': '‚úÖ',\n        'rejected': '‚ùå'\n      };\n\n      let message = lang === 'ms' ? 'üîç *Maklumat Pesanan*\\n\\n' : 'üîç *Order Details*\\n\\n';\n      message += `üÜî Order ID: \\`${userOrder.id}\\`\\n`;\n      message += `üì¶ Produk: ${userOrder.productName?.ms || userOrder.productName}\\n`;\n      message += `üí∞ Harga: RM${userOrder.price}\\n`;\n      message += `${statusEmoji[userOrder.status] || 'üìå'} Status: ${userOrder.status}\\n`;\n      message += `üìÖ Tarikh: ${new Date(userOrder.createdAt).toLocaleString('ms-MY')}\\n\\n`;\n\n      if (userOrder.status === 'pending') {\n        message += lang === 'ms'\n          ? 'üí° Gunakan `/send ${userOrder.id}` untuk hantar bukti pembayaran.'\n          : 'üí° Use `/send ${userOrder.id}` to submit payment proof.';\n      }\n\n      await ctx.reply(message, { parse_mode: 'Markdown' });\n      return;\n    } else if (query) {\n      const user = await db.getUser(userId);\n      const lang = user?.language || 'ms';\n      const msg = lang === 'ms'\n        ? `‚ùå Pesanan tidak dijumpai!\\n\\nüÜî Order ID: \\`${query}\\`\\n\\nüí° Pastikan ID pesanan betul atau lihat \"Pesanan Saya\" di menu utama.`\n        : `‚ùå Order not found!\\n\\nüÜî Order ID: \\`${query}\\`\\n\\nüí° Make sure the order ID is correct or check \"My Orders\" in main menu.`;\n      await ctx.reply(msg, { parse_mode: 'Markdown' });\n      return;\n    }\n  }\n\n  await handleSearchOrders(ctx, query);\n}));\n\nbot.command('filterorders', safeHandler(handleFilterOrders));\n\n// Product Management\nbot.command('duplicate', safeHandler(async (ctx) => {\n  const productId = ctx.message.text.split(' ')[1];\n  await handleDuplicateProduct(ctx, productId);\n}));\n\nbot.command('inventory', safeHandler(async (ctx) => {\n  const productId = ctx.message.text.split(' ')[1];\n  await handleInventoryHistory(ctx, productId);\n}));\n\nbot.command('adjuststock', safeHandler(async (ctx) => {\n  const parts = ctx.message.text.split(' ');\n  const productId = parts[1];\n  const adjustment = parts[2];\n  const note = parts.slice(3).join(' ');\n  await handleStockAdjustment(ctx, productId, adjustment, note);\n}));\n\n// Auto-Reply Templates & FAQ\nbot.command('addtemplate', safeHandler(async (ctx) => {\n  const input = ctx.message.text.replace('/addtemplate', '').trim();\n  const parts = input.split('|').map(p => p.trim());\n  await handleAddTemplate(ctx, parts[0], parts[1]);\n}));\n\nbot.command('qt', safeHandler(async (ctx) => {\n  const keyword = ctx.message.text.replace('/qt', '').trim();\n  await handleQuickTemplate(ctx, keyword);\n}));\n\nbot.command('templates', safeHandler(handleListTemplates));\n\nbot.command('deletetemplate', safeHandler(async (ctx) => {\n  const keyword = ctx.message.text.split(' ')[1];\n  await handleDeleteTemplate(ctx, keyword);\n}));\n\nbot.command('addfaq', safeHandler(async (ctx) => {\n  const input = ctx.message.text.replace('/addfaq', '').trim();\n  const parts = input.split('|').map(p => p.trim());\n  await handleAddFAQ(ctx, parts[0], parts[1]);\n}));\n\nbot.command('faq', safeHandler(handleFAQList));\n\nbot.command('listfaqs', safeHandler(handleListFAQs));\n\nbot.command('deletefaq', safeHandler(async (ctx) => {\n  const faqId = ctx.message.text.split(' ')[1];\n  await handleDeleteFAQ(ctx, faqId);\n}));\n\n// Currency & Feedback\nbot.command('currency', safeHandler(handleSetCurrency));\n\nbot.command('skipfeedback', safeHandler(async (ctx) => {\n  const userId = ctx.from.id;\n  const { clearFeedbackState } = require('./handlers/feedback');\n\n  clearFeedbackState(userId);\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  const messages = {\n    ms: '‚úÖ Feedback dilangkau. Anda boleh teruskan menggunakan bot seperti biasa.',\n    en: '‚úÖ Feedback skipped. You can continue using the bot normally.',\n    zh: '‚úÖ Â∑≤Ë∑≥ËøáÂèçÈ¶à„ÄÇÊÇ®ÂèØ‰ª•Ê≠£Â∏∏ÁªßÁª≠‰ΩøÁî®Êú∫Âô®‰∫∫„ÄÇ',\n    ta: '‚úÖ ‡Æï‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ. ‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡ÆØ‡Æ≤‡Øç‡Æ™‡Ææ‡Æï ‡Æ™‡Ææ‡Æü‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§ ‡Æ§‡Øä‡Æü‡Æ∞‡Æ≤‡Ææ‡ÆÆ‡Øç.'\n  };\n  await ctx.reply(messages[lang] || messages.en);\n}));\n\nbot.command('feedbacks', safeHandler(handleViewFeedbacks));\n\nbot.command('ping', safeHandler(handlePing));\n\n// Auto Promotion Commands\nbot.command('schedulemsg', safeHandler(handleScheduleMsg));\n\nbot.command('addpromotemplate', safeHandler(handleAddPromoTemplate));\n\nbot.command('createabtest', safeHandler(handleCreateABTestCommand));\n\nbot.command('creatediscount', safeHandler(handleCreateDiscount));\n\nbot.command('createflash', safeHandler(handleCreateFlash));\n\nbot.command('repeatcampaign', safeHandler(handleRepeatCampaign));\n\nbot.command('createvoucher', safeHandler(handleCreateVoucher));\n\nbot.command('redeem', safeHandler(handleRedeemVoucher));\n\nbot.command('listvouchers', safeHandler(handleListVouchers));\n\nbot.command('togglevoucher', safeHandler(handleToggleVoucher));\n\nbot.command('checkvoucher', safeHandler(handleCheckVoucher));\n\nbot.command('backupnow', safeHandler(async (ctx) => {\n  const { isOwner } = require('./handlers/owner');\n  const userId = ctx.from.id;\n\n  if (!await isOwner(userId)) {\n    const user = await db.getUser(userId);\n    const lang = user?.language || 'ms';\n    const message = lang === 'ms' \n      ? 'üö´ Arahan ini hanya untuk owner sahaja.'\n      : 'üö´ This command is only for owner.';\n    await ctx.reply(message);\n    return;\n  }\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const processingMsg = lang === 'ms'\n    ? 'üì¶ Membuat backup manual...'\n    : 'üì¶ Creating manual backup...';\n\n  await ctx.reply(processingMsg);\n  await runBackup();\n\n  const successMsg = lang === 'ms'\n    ? '‚úÖ Backup dimuat naik ke cloud storage dengan jayanya!'\n    : '‚úÖ Backup uploaded to cloud storage successfully!';\n\n  await ctx.reply(successMsg);\n}));\n\nbot.command('list', safeHandler(async (ctx) => {\n  const { Markup } = require('telegraf');\n  const { isAdmin } = require('./handlers/admin');\n  const { isOwner } = require('./handlers/owner');\n\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const isUserAdmin = await isAdmin(userId);\n  const isUserOwner = await isOwner(userId);\n\n  if (isUserAdmin || isUserOwner) {\n    const commandsText = lang === 'ms' \n      ? `üìã *SENARAI ARAHAN*\n\nüë§ *ARAHAN PENGGUNA:*\n‚Ä¢ \\`/start\\` - Menu utama\n‚Ä¢ \\`/send [order_id]\\` - Hantar bukti pembayaran\n‚Ä¢ \\`/searchorder [order_id]\\` - Cari pesanan\n‚Ä¢ \\`/faq\\` - Lihat soalan lazim\n‚Ä¢ \\`/ping\\` - Semak maklumat runtime sistem\n‚Ä¢ \\`/list\\` - Senarai arahan\n\n‚öôÔ∏è *ARAHAN ADMIN:*\n‚Ä¢ \\`/verify [order_id]\\` - Sahkan pesanan\n‚Ä¢ \\`/reject [order_id]\\` - Tolak pesanan\n‚Ä¢ \\`/checkallorderid\\` - Semua ID pesanan\n‚Ä¢ \\`/searchorder [query]\\` - Cari pesanan (ID/User/Status)\n‚Ä¢ \\`/filterorders\\` - Tapis pesanan mengikut status\n‚Ä¢ \\`/ban [user_id] [reason]\\` - Sekat pengguna\n‚Ä¢ \\`/unban [user_id]\\` - Nyahsekat pengguna\n‚Ä¢ \\`/bannedlist\\` - Senarai pengguna disekat\n‚Ä¢ \\`/tag [user_id] [tag]\\` - Tag pengguna\n‚Ä¢ \\`/untag [user_id] [tag]\\` - Buang tag pengguna\n‚Ä¢ \\`/addtemplate [keyword] | [msg]\\` - Tambah template\n‚Ä¢ \\`/qt [keyword]\\` - Guna template pantas\n‚Ä¢ \\`/templates\\` - Senarai template\n‚Ä¢ \\`/deletetemplate [keyword]\\` - Padam template\n‚Ä¢ \\`/addfaq [soalan] | [jawapan]\\` - Tambah FAQ\n‚Ä¢ \\`/listfaqs\\` - Senarai FAQ\n‚Ä¢ \\`/deletefaq [faq_id]\\` - Padam FAQ\n‚Ä¢ \\`/duplicate [product_id]\\` - Duplicate produk\n‚Ä¢ \\`/inventory [product_id]\\` - Sejarah inventori\n‚Ä¢ \\`/adjuststock [id] [+/-num] [note]\\` - Adjust stok\n‚Ä¢ \\`/addcategory [name]\\` - Tambah kategori\n‚Ä¢ \\`/addproduct [...]\\` - Tambah produk\n‚Ä¢ \\`/additem [product_id] | [data]\\` - Tambah item\n‚Ä¢ \\`/listproducts\\` - Senarai produk\n‚Ä¢ \\`/currency\\` - Tukar matawang\n‚Ä¢ \\`/feedbacks\\` - Lihat maklumbalas\n‚Ä¢ \\`/createvoucher [kod] | [%] | [max]\\` - Buat baucher\n‚Ä¢ \\`/listvouchers\\` - Senarai baucher\n‚Ä¢ \\`/togglevoucher [kod]\\` - Aktif/nyahaktif baucher\n‚Ä¢ \\`/join [token]\\` - Sertai sesi support\n‚Ä¢ \\`/leave\\` - Keluar dari sesi\n‚Ä¢ \\`/close\\` - Tutup sesi support${isUserOwner ? `\n\nüëë *ARAHAN OWNER:*\n‚Ä¢ \\`/setowner\\` - Set owner baru\n‚Ä¢ \\`/addadmin [user_id]\\` - Tambah admin\n‚Ä¢ \\`/removeadmin [user_id]\\` - Buang admin` : ''}`\n      : `üìã *COMMANDS LIST*\n\nüë§ *USER COMMANDS:*\n‚Ä¢ \\`/start\\` - Main menu\n‚Ä¢ \\`/send [order_id]\\` - Send payment proof\n‚Ä¢ \\`/searchorder [order_id]\\` - Search order\n‚Ä¢ \\`/faq\\` - View FAQ\n‚Ä¢ \\`/ping\\` - Check system runtime info\n‚Ä¢ \\`/list\\` - List commands\n\n‚öôÔ∏è *ADMIN COMMANDS:*\n‚Ä¢ \\`/verify [order_id]\\` - Verify order\n‚Ä¢ \\`/reject [order_id]\\` - Reject order\n‚Ä¢ \\`/checkallorderid\\` - All order IDs\n‚Ä¢ \\`/searchorder [query]\\` - Search orders (ID/User/Status)\n‚Ä¢ \\`/filterorders\\` - Filter orders by status\n‚Ä¢ \\`/ban [user_id] [reason]\\` - Ban user\n‚Ä¢ \\`/unban [user_id]\\` - Unban user\n‚Ä¢ \\`/bannedlist\\` - List banned users\n‚Ä¢ \\`/tag [user_id] [tag]\\` - Tag user\n‚Ä¢ \\`/untag [user_id] [tag]\\` - Remove tag\n‚Ä¢ \\`/addtemplate [keyword] | [msg]\\` - Add template\n‚Ä¢ \\`/qt [keyword]\\` - Quick template\n‚Ä¢ \\`/templates\\` - List templates\n‚Ä¢ \\`/deletetemplate [keyword]\\` - Delete template\n‚Ä¢ \\`/addfaq [question] | [answer]\\` - Add FAQ\n‚Ä¢ \\`/listfaqs\\` - List FAQs\n‚Ä¢ \\`/deletefaq [faq_id]\\` - Delete FAQ\n‚Ä¢ \\`/duplicate [product_id]\\` - Duplicate product\n‚Ä¢ \\`/inventory [product_id]\\` - Inventory history\n‚Ä¢ \\`/adjuststock [id] [+/-num] [note]\\` - Adjust stock\n‚Ä¢ \\`/addcategory [name]\\` - Add category\n‚Ä¢ \\`/addproduct [...]\\` - Add product\n‚Ä¢ \\`/additem [product_id] | [data]\\` - Add item\n‚Ä¢ \\`/listproducts\\` - List products\n‚Ä¢ \\`/currency\\` - Change currency\n‚Ä¢ \\`/feedbacks\\` - View feedbacks\n‚Ä¢ \\`/createvoucher [code] | [%] | [max]\\` - Create voucher\n‚Ä¢ \\`/listvouchers\\` - List vouchers\n‚Ä¢ \\`/togglevoucher [code]\\` - Toggle voucher\n‚Ä¢ \\`/join [token]\\` - Join support session\n‚Ä¢ \\`/leave\\` - Leave session\n‚Ä¢ \\`/close\\` - Close support session${isUserOwner ? `\n\nüëë *OWNER COMMANDS:*\n‚Ä¢ \\`/setowner\\` - Set new owner\n‚Ä¢ \\`/addadmin [user_id]\\` - Add admin\n‚Ä¢ \\`/removeadmin [user_id]\\` - Remove admin\n‚Ä¢ \\`/addapi [token]\\` - Update Dropbox API token` : ''}`;\n\n    await ctx.reply(commandsText, { parse_mode: 'Markdown' });\n  } else {\n    const buttonText = lang === 'ms' \n      ? 'üìã *ARAHAN YANG ADA*\\n\\nPilih arahan yang anda mahu gunakan:'\n      : 'üìã *AVAILABLE COMMANDS*\\n\\nSelect the command you want to use:';\n\n    const buttons = [\n      [Markup.button.callback(lang === 'ms' ? 'üõçÔ∏è Beli Produk' : 'üõçÔ∏è Buy Products', 'buy_products')],\n      [Markup.button.callback(lang === 'ms' ? 'üìã Pesanan Saya' : 'üìã My Orders', 'my_orders'), Markup.button.callback(lang === 'ms' ? 'üì¶ Item Saya' : 'üì¶ My Items', 'my_items')],\n      [Markup.button.callback(lang === 'ms' ? 'üé´ Guna Baucher' : 'üé´ Use Voucher', 'use_voucher'), Markup.button.callback(lang === 'ms' ? 'üí¨ Support' : 'üí¨ Support', 'support')],\n      [Markup.button.callback(lang === 'ms' ? 'üîç Cari Pesanan' : 'üîç Search Order', 'search_orders')],\n      [Markup.button.callback('‚ùì FAQ', 'view_faq'), Markup.button.callback(lang === 'ms' ? 'üìñ Panduan' : 'üìñ Guide', 'user_guide')],\n      [Markup.button.callback(lang === 'ms' ? 'üîô Kembali ke Menu Utama' : 'üîô Back to Main Menu', 'main_menu')]\n    ];\n\n    await ctx.reply(buttonText, {\n      parse_mode: 'Markdown',\n      ...Markup.inlineKeyboard(buttons)\n    });\n  }\n}));\n\nbot.command('addcategory', safeHandler(async (ctx) => {\n  const { isAdmin } = require('./handlers/admin');\n  if (!await isAdmin(ctx.from.id)) {\n    await ctx.reply('Unauthorized');\n    return;\n  }\n\n  const name = ctx.message.text.replace('/addcategory', '').trim();\n  if (!name) {\n    await ctx.reply('Usage: /addcategory [name]');\n    return;\n  }\n\n  const categories = await db.getCategories();\n  const newCategory = {\n    id: generateId('CAT'),\n    name: { ms: name, en: name },\n    icon: 'üì¶',\n    createdAt: new Date().toISOString()\n  };\n\n  categories.push(newCategory);\n  await db.saveCategories(categories);\n\n  await ctx.reply(`‚úÖ Category \"${name}\" added with ID: ${newCategory.id}`);\n}));\n\nbot.command('addproduct', safeHandler(async (ctx) => {\n  const { isAdmin } = require('./handlers/admin');\n  if (!await isAdmin(ctx.from.id)) {\n    await ctx.reply('Unauthorized');\n    return;\n  }\n\n  const input = ctx.message.text.replace('/addproduct', '').trim();\n\n  if (!input) {\n    await ctx.reply(\n      'üì¶ *Add New Product*\\n\\n' +\n      'Format:\\n' +\n      '/addproduct [category_id] | [name] | [price] | [stock] | [description]\\n\\n' +\n      'Example:\\n' +\n      '/addproduct CAT-ABC123 | Netflix Premium | 15.00 | 10 | 1 month subscription\\n\\n' +\n      '‚ö†Ô∏è All products are manual delivery. Admin will deliver items to customers.',\n      { parse_mode: 'Markdown' }\n    );\n    return;\n  }\n\n  const parts = input.split('|').map(p => p.trim());\n\n  if (parts.length < 5) {\n    await ctx.reply('‚ùå Invalid format. Please provide all required fields.');\n    return;\n  }\n\n  const [categoryId, name, priceStr, stockStr, description] = parts;\n  const price = parseFloat(priceStr);\n  const stock = parseInt(stockStr);\n\n  if (isNaN(price) || isNaN(stock)) {\n    await ctx.reply('‚ùå Invalid price or stock value.');\n    return;\n  }\n\n  const categories = await db.getCategories();\n  if (!categories.find(c => c.id === categoryId)) {\n    await ctx.reply('‚ùå Category not found. Use /listcategories to see available categories.');\n    return;\n  }\n\n  const products = await db.getProducts();\n  const newProduct = {\n    id: generateId('PROD'),\n    categoryId,\n    name: { ms: name, en: name },\n    price,\n    stock,\n    description: { ms: description, en: description },\n    deliveryType: 'manual',\n    items: [],\n    active: true,\n    createdAt: new Date().toISOString()\n  };\n\n  products.push(newProduct);\n  await db.saveProducts(products);\n\n  await ctx.reply(\n    `‚úÖ Product created successfully!\\n\\n` +\n    `üÜî ID: ${newProduct.id}\\n` +\n    `üì¶ Name: ${name}\\n` +\n    `üí∞ Price: RM${price}\\n` +\n    `üìä Stock: ${stock}\\n` +\n    `üîÑ Type: Manual Delivery\\n\\n` +\n    `Admin will manually deliver this product to customers.`\n  );\n}));\n\nbot.command('listproducts', safeHandler(async (ctx) => {\n  const { isAdmin } = require('./handlers/admin');\n  if (!await isAdmin(ctx.from.id)) {\n    await ctx.reply('Unauthorized');\n    return;\n  }\n\n  const products = await db.getProducts();\n\n  if (products.length === 0) {\n    await ctx.reply('No products found');\n    return;\n  }\n\n  let text = 'üì¶ *All Products*\\n\\n';\n  products.forEach(p => {\n    text += `üÜî ${p.id}\\n`;\n    text += `üì¶ ${p.name.ms || p.name}\\n`;\n    text += `üí∞ RM${p.price}\\n`;\n    const itemsCount = p.items ? p.items.length : 0;\n    if (p.deliveryType === 'auto') {\n      text += `üìä Stock: ${p.stock} (${itemsCount} items available)\\n`;\n    } else {\n      text += `üìä Stock: ${p.stock}\\n`;\n    }\n    text += `üîÑ Type: ${p.deliveryType}\\n`;\n    text += `‚úÖ Active: ${p.active ? 'Yes' : 'No'}\\n\\n`;\n  });\n\n  await ctx.reply(text, { parse_mode: 'Markdown' });\n}));\n\nbot.command('deleteproduct', safeHandler(async (ctx) => {\n  const { isAdmin } = require('./handlers/admin');\n  if (!await isAdmin(ctx.from.id)) {\n    await ctx.reply('‚ùå Unauthorized / Tidak dibenarkan');\n    return;\n  }\n\n  const productId = ctx.message.text.split(' ')[1];\n\n  if (!productId) {\n    await ctx.reply('‚ùå Usage: /deleteproduct [product_id]\\n\\nExample: /deleteproduct prod_123');\n    return;\n  }\n\n  const products = await db.getProducts();\n  const productIndex = products.findIndex(p => p.id === productId);\n\n  if (productIndex === -1) {\n    await ctx.reply('‚ùå Product not found');\n    return;\n  }\n\n  const product = products[productIndex];\n  products.splice(productIndex, 1);\n  await db.saveProducts(products);\n\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n\n  const message = lang === 'ms'\n    ? `‚úÖ *Produk berjaya dipadam!*\\n\\n` +\n      `üÜî ID: ${product.id}\\n` +\n      `üì¶ Nama: ${product.name.ms || product.name}\\n` +\n      `üí∞ Harga: RM${product.price}`\n    : `‚úÖ *Product deleted successfully!*\\n\\n` +\n      `üÜî ID: ${product.id}\\n` +\n      `üì¶ Name: ${product.name.en || product.name.ms || product.name}\\n` +\n      `üí∞ Price: RM${product.price}`;\n\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}));\n\nbot.action('main_menu', safeHandler(handleMainMenu));\nbot.action('toggle_language', safeHandler(handleLanguageToggle));\nbot.action('buy_products', safeHandler(handleBuyProducts));\nbot.action('my_orders', safeHandler(handleMyOrders));\nbot.action('my_items', safeHandler(handleMyItems));\nbot.action('use_voucher', safeHandler(async (ctx) => {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const message = lang === 'ms'\n    ? `üé´ *Cara Guna Baucher*\n\nüìù *Langkah 1:* Dapatkan kod baucher dari admin/promosi\n\nüìù *Langkah 2:* Taip command untuk tebus baucher:\n\\`/redeem [KOD_BAUCHER]\\`\n\n*Contoh:*\n\\`/redeem JIMAT50\\`\n\nüí° *Tips:*\n‚Ä¢ Kod baucher tidak case-sensitive (huruf besar/kecil sama)\n‚Ä¢ Satu baucher hanya boleh digunakan sekali sahaja oleh setiap user\n‚Ä¢ Baucher akan digunakan automatik pada order seterusnya\n‚Ä¢ Diskaun akan ditolak semasa checkout\n\nüìä *Semak Baucher Aktif:*\nGunakan \\`/checkvoucher\\` untuk lihat baucher yang sedang aktif\n\nüõçÔ∏è Lepas tebus baucher, terus ke \"Beli Produk\" untuk shopping!`\n    : `üé´ *How to Use Voucher*\n\nüìù *Step 1:* Get voucher code from admin/promotion\n\nüìù *Step 2:* Type command to redeem voucher:\n\\`/redeem [VOUCHER_CODE]\\`\n\n*Example:*\n\\`/redeem SAVE50\\`\n\nüí° *Tips:*\n‚Ä¢ Voucher codes are not case-sensitive\n‚Ä¢ Each voucher can only be used once per user\n‚Ä¢ Voucher will be applied automatically to your next order\n‚Ä¢ Discount will be deducted at checkout\n\nüìä *Check Active Voucher:*\nUse \\`/checkvoucher\\` to see your active voucher\n\nüõçÔ∏è After redeeming voucher, go to \"Buy Products\" to shop!`;\n\n  await ctx.answerCbQuery();\n  await safeEditMessage(ctx, message, { parse_mode: 'Markdown' });\n}));\nbot.action('support', safeHandler(handleSupport));\nbot.action('admin_panel', safeHandler(handleAdminPanel));\nbot.action('admin_orders', safeHandler(handleAdminOrders));\nbot.action('admin_products', safeHandler(handleAdminProducts));\nbot.action('admin_products_menu', safeHandler(handleProductManagementMenu));\nbot.action('admin_sessions', safeHandler(handleAdminSessions));\nbot.action('admin_broadcast', safeHandler(handleAdminBroadcast));\nbot.action('admin_statistics', safeHandler(handleAdminStatistics));\nbot.action('all_orders', safeHandler(handleAllOrders));\n\nbot.action(/^view_order_(.+)$/, safeHandler(async (ctx) => {\n  const orderId = ctx.match[1];\n  await handleViewOrder(ctx, orderId);\n}));\n\nbot.action(/^delete_order_confirm_(.+)$/, safeHandler(async (ctx) => {\n  const orderId = ctx.match[1];\n  await handleDeleteOrderConfirm(ctx, orderId);\n}));\n\nbot.action(/^delete_order_(.+)$/, safeHandler(async (ctx) => {\n  const orderId = ctx.match[1];\n  await handleDeleteOrder(ctx, orderId);\n}));\n\nbot.action('cat_management', safeHandler(handleCategoryManagement));\nbot.action('cat_add_new', safeHandler(async (ctx) => {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  const message = lang === 'ms'\n    ? '‚ûï *Tambah Kategori Baru*\\n\\nGunakan command:\\n`/addcategory [nama]`\\n\\nContoh:\\n`/addcategory Streaming Premium`'\n    : '‚ûï *Add New Category*\\n\\nUse command:\\n`/addcategory [name]`\\n\\nExample:\\n`/addcategory Premium Streaming`';\n  await ctx.answerCbQuery();\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}));\n\nbot.action('prod_add_new', safeHandler(async (ctx) => {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  const message = lang === 'ms'\n    ? '‚ûï *Tambah Produk Baru*\\n\\nGunakan command:\\n`/addproduct`\\n\\nFormat:\\n`/addproduct [category_id] | [nama] | [harga] | [stok] | [penerangan]`\\n\\nContoh:\\n`/addproduct CAT-ABC123 | Netflix Premium | 15.00 | 10 | 1 bulan subscription`'\n    : '‚ûï *Add New Product*\\n\\nUse command:\\n`/addproduct`\\n\\nFormat:\\n`/addproduct [category_id] | [name] | [price] | [stock] | [description]`\\n\\nExample:\\n`/addproduct CAT-ABC123 | Netflix Premium | 15.00 | 10 | 1 month subscription`';\n  await ctx.answerCbQuery();\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}));\n\nbot.action('prod_low_stock', safeHandler(handleLowStockProducts));\n\nbot.action(/^cat_manage_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleCategoryDetail(ctx, categoryId);\n}));\n\nbot.action(/^cat_delete_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleDeleteCategory(ctx, categoryId);\n}));\n\nbot.action(/^cat_edit_name_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleEditCategoryName(ctx, categoryId);\n}));\n\nbot.action(/^cat_edit_icon_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleEditCategoryIcon(ctx, categoryId);\n}));\n\nbot.action(/^prod_list_page_(\\d+)$/, safeHandler(async (ctx) => {\n  const page = parseInt(ctx.match[1]);\n  await handleProductList(ctx, page);\n}));\n\nbot.action(/^prod_detail_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleProductDetail(ctx, productId);\n}));\n\nbot.action(/^prod_toggle_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleToggleProduct(ctx, productId);\n}));\n\nbot.action(/^prod_delete_confirm_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleDeleteProductConfirm(ctx, productId);\n}));\n\nbot.action(/^prod_delete_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleDeleteProduct(ctx, productId);\n}));\n\nbot.action(/^prod_edit_price_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleEditProductField(ctx, productId, 'price');\n}));\n\nbot.action(/^prod_edit_stock_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleEditProductField(ctx, productId, 'stock');\n}));\n\nbot.action(/^prod_edit_name_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleEditProductField(ctx, productId, 'name');\n}));\n\nbot.action(/^prod_edit_desc_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleEditProductField(ctx, productId, 'description');\n}));\n\n// Product Options Actions\nbot.action(/^prod_options_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleProductOptions(ctx, productId);\n}));\n\nbot.action(/^opt_add_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleAddOption(ctx, productId);\n}));\n\nbot.action(/^opt_detail_(.+)_(\\d+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  const optionIndex = parseInt(ctx.match[2]);\n  await handleOptionDetail(ctx, productId, optionIndex);\n}));\n\nbot.action(/^opt_toggle_req_(.+)_(\\d+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  const optionIndex = parseInt(ctx.match[2]);\n  await handleToggleOptionRequired(ctx, productId, optionIndex);\n}));\n\nbot.action(/^opt_delete_(.+)_(\\d+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  const optionIndex = parseInt(ctx.match[2]);\n  await handleDeleteOption(ctx, productId, optionIndex);\n}));\n\nbot.action(/^opt_req_(yes|no)_(.+)$/, safeHandler(async (ctx) => {\n  const required = ctx.match[1] === 'yes';\n  const productId = ctx.match[2];\n  await handleOptionRequired(ctx, productId, required);\n}));\n\n// Scheduled Publishing Actions\nbot.action('scheduled_products', safeHandler(handleScheduledProducts));\n\nbot.action(/^schedule_prod_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleScheduleProduct(ctx, productId);\n}));\n\nbot.action(/^sched_detail_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleScheduleProduct(ctx, productId);\n}));\n\nbot.action(/^cancel_schedule_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleCancelSchedule(ctx, productId);\n}));\n\n// Category Discounts Actions\nbot.action('category_discounts', safeHandler(handleCategoryDiscounts));\n\nbot.action(/^cat_disc_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleCategoryDiscountDetail(ctx, categoryId);\n}));\n\nbot.action(/^cat_disc_add_pct_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleAddCategoryDiscount(ctx, categoryId, 'percentage');\n}));\n\nbot.action(/^cat_disc_add_fix_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleAddCategoryDiscount(ctx, categoryId, 'fixed');\n}));\n\nbot.action(/^cat_disc_remove_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleRemoveCategoryDiscount(ctx, categoryId);\n}));\n\nbot.action(/^cat_disc_edit_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  await ctx.answerCbQuery();\n  await ctx.reply(\n    lang === 'ms'\n      ? 'Untuk edit diskaun, padam yang sedia ada dan tambah yang baru.'\n      : 'To edit discount, remove the existing one and add a new one.'\n  );\n}));\n\n// Review & Rating Actions\nbot.action(/^prod_reviews_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleProductReviews(ctx, productId);\n}));\n\nbot.action(/^review_rate_(.+)_(\\d+)$/, safeHandler(async (ctx) => {\n  const orderId = ctx.match[1];\n  const rating = parseInt(ctx.match[2]);\n  await handleRatingSelect(ctx, orderId, rating);\n}));\n\nbot.action('view_all_reviews', safeHandler(handleViewAllReviews));\n\n// Advanced Order Filter Actions\nbot.action('adv_order_filters', safeHandler(handleAdvancedOrderFilters));\n\nbot.action(/^filter_date_(.+)$/, safeHandler(async (ctx) => {\n  const filterType = ctx.match[1];\n  await handleDateFilter(ctx, filterType);\n}));\n\n// Quick Edit Actions\nbot.action('quick_edit_menu', safeHandler(handleQuickEditMenu));\n\nbot.action(/^qedit_(.+)$/, safeHandler(async (ctx) => {\n  const action = ctx.match[1];\n  await handleQuickEditAction(ctx, action);\n}));\n\n// Product Image Management Actions\nbot.action(/^prod_images_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleProductImages(ctx, productId);\n}));\n\nbot.action(/^img_add_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleAddProductImage(ctx, productId);\n}));\n\nbot.action(/^img_view_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleViewProductImages(ctx, productId);\n}));\n\nbot.action(/^img_delete_(.+)_(\\d+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  const imageIndex = parseInt(ctx.match[2]);\n  await handleDeleteProductImage(ctx, productId, imageIndex);\n}));\n\nbot.action(/^send_payment_(.+)$/, safeHandler(async (ctx) => {\n  const orderId = ctx.match[1];\n  await handlePaymentSelection(ctx, orderId);\n}));\nbot.action('owner_panel', safeHandler(handleOwnerPanel));\nbot.action('owner_admins', safeHandler(handleOwnerAdmins));\nbot.action('owner_settings', safeHandler(handleOwnerSettings));\nbot.action('owner_backup', safeHandler(handleOwnerBackup));\n\nbot.action('auto_promote_panel', safeHandler(handleAutoPromotePanel));\nbot.action('promo_create_broadcast', safeHandler(handleCreateBroadcast));\nbot.action('promo_schedule', safeHandler(handleScheduleMessage));\nbot.action('promo_templates', safeHandler(handlePromoTemplates));\nbot.action('promo_targeting', safeHandler(handleUserTargeting));\nbot.action('promo_analytics', safeHandler(handlePromoAnalytics));\nbot.action('promo_ab_test', safeHandler(handleABTesting));\nbot.action('promo_discounts', safeHandler(handleDiscountCodes));\nbot.action('promo_flash_sales', safeHandler(handleFlashSales));\nbot.action('promo_repeat', safeHandler(handleRepeatCampaigns));\nbot.action('promo_active', safeHandler(handleActiveCampaigns));\nbot.action('promo_panel', safeHandler(handleAutoPromotePanel));\n\nbot.action('broadcast_all', safeHandler(handleBroadcastAll));\nbot.action('broadcast_active', safeHandler(handleBroadcastActive));\nbot.action('broadcast_tagged', safeHandler(handleBroadcastTagged));\nbot.action('target_all', safeHandler(handleTargetAll));\nbot.action('target_active', safeHandler(handleTargetActive));\nbot.action('target_tagged', safeHandler(handleTargetTagged));\nbot.action('target_buyers', safeHandler(handleTargetBuyers));\nbot.action('promo_detailed_report', safeHandler(handlePromoDetailedReport));\nbot.action('create_ab_test', safeHandler(handleCreateABTest));\nbot.action('ab_test_results', safeHandler(handleABTestResults));\nbot.action('pause_all_campaigns', safeHandler(handlePauseAllCampaigns));\n\nbot.action('system_panel', safeHandler(handleSystemPanel));\nbot.action('sys_user_stats', safeHandler(handleUserStats));\nbot.action('sys_sales_analytics', safeHandler(handleSalesAnalytics));\nbot.action('sys_admin_logs', safeHandler(handleAdminLogs));\nbot.action('sys_health_check', safeHandler(handleHealthCheck));\nbot.action('sys_storage', safeHandler(handleStorageUsage));\nbot.action('sys_export', safeHandler(handleExportData));\nbot.action('sys_maintenance', safeHandler(handleMaintenanceMode));\nbot.action('sys_backup_ui', safeHandler(handleBackupUI));\nbot.action('sys_error_monitor', safeHandler(handleErrorMonitor));\nbot.action('sys_performance', safeHandler(handlePerformance));\nbot.action('sys_api_limits', safeHandler(handleAPILimits));\nbot.action('sys_webhook_logs', safeHandler(handleWebhookLogs));\nbot.action('sys_transaction_reports', safeHandler(handleTransactionReports));\nbot.action('sys_inventory_alerts', safeHandler(handleInventoryAlerts));\nbot.action('sys_session_analytics', safeHandler(handleSessionAnalytics));\nbot.action('sys_engagement', safeHandler(handleEngagement));\nbot.action('sys_revenue', safeHandler(handleRevenue));\nbot.action('sys_import', safeHandler(handleImportData));\nbot.action('sys_settings', safeHandler(handleSystemSettings));\nbot.action('sys_cache', safeHandler(handleCacheManagement));\n\nbot.action('export_users', safeHandler(handleExportUsers));\nbot.action('export_products', safeHandler(handleExportProducts));\nbot.action('export_transactions', safeHandler(handleExportTransactions));\nbot.action('export_all', safeHandler(handleExportAll));\nbot.action('store_status', safeHandler(handleStoreStatus));\nbot.action('toggle_store_status', safeHandler(handleToggleStoreStatus));\nbot.action('toggle_maintenance', safeHandler(handleToggleMaintenance));\n\nbot.action('clear_admin_logs', safeHandler(async (ctx) => {\n  const { clearAdminLogs, logAdminAction } = require('./utils/adminLogger');\n  const { isOwner } = require('./handlers/owner');\n  const userId = ctx.from.id;\n\n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n\n  await clearAdminLogs();\n  await logAdminAction(userId, 'Cleared Admin Logs', 'All admin activity logs were cleared');\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  const msg = lang === 'ms' ? '‚úÖ Log admin telah dipadam!' : '‚úÖ Admin logs cleared!';\n  await ctx.answerCbQuery(msg);\n  await handleAdminLogs(ctx);\n}));\n\nbot.action('edit_system_settings', safeHandler(async (ctx) => {\n  const { isOwner } = require('./handlers/owner');\n  const userId = ctx.from.id;\n\n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  const msg = lang === 'ms' \n    ? '‚ÑπÔ∏è Gunakan panel Owner Settings untuk edit tetapan'\n    : '‚ÑπÔ∏è Use Owner Settings panel to edit settings';\n  await ctx.answerCbQuery(msg);\n  await ctx.reply(msg);\n}));\n\nbot.action('broadcast_buyers', safeHandler(async (ctx) => {\n  const { isAdmin } = require('./handlers/admin');\n  const userId = ctx.from.id;\n\n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const transactions = await db.getTransactions();\n  const buyerIds = [...new Set(transactions.filter(t => t.status === 'completed' || t.status === 'verified').map(t => t.userId))];\n\n  const message = lang === 'en'\n    ? `üõçÔ∏è *Broadcast to Buyers*\\n\\nTotal Buyers: ${buyerIds.length}\\n\\nPlease send your broadcast message now:`\n    : `üõçÔ∏è *Siaran ke Pembeli*\\n\\nJumlah Pembeli: ${buyerIds.length}\\n\\nSila hantar mesej siaran anda sekarang:`;\n\n  ctx.session = ctx.session || {};\n  ctx.session.awaitingBroadcastBuyers = true;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Cancel' : 'üîô Batal', callback_data: 'promo_create_broadcast' }]\n      ]\n    }\n  });\n}));\n\nbot.action('detailed_revenue_report', safeHandler(async (ctx) => {\n  const { isOwner } = require('./handlers/owner');\n  const userId = ctx.from.id;\n\n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const transactions = await db.getTransactions();\n  const completed = transactions.filter(t => t.status === 'completed');\n  const totalRevenue = completed.reduce((sum, t) => sum + (t.price || 0), 0);\n\n  const last7Days = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();\n  const last30Days = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();\n\n  const revenue7Days = completed.filter(t => t.createdAt >= last7Days).reduce((sum, t) => sum + (t.price || 0), 0);\n  const revenue30Days = completed.filter(t => t.createdAt >= last30Days).reduce((sum, t) => sum + (t.price || 0), 0);\n\n  const message = lang === 'en'\n    ? `üìà *Detailed Revenue Report*\\n\\nüí∞ Total Revenue: ${config.store.currency} ${totalRevenue.toFixed(2)}\\n\\nüìä Last 7 Days: ${config.store.currency} ${revenue7Days.toFixed(2)}\\nüìä Last 30 Days: ${config.store.currency} ${revenue30Days.toFixed(2)}\\n\\nüì¶ Total Orders: ${completed.length}\\nüìà Avg Order Value: ${config.store.currency} ${(completed.length > 0 ? totalRevenue / completed.length : 0).toFixed(2)}`\n    : `üìà *Laporan Hasil Terperinci*\\n\\nüí∞ Jumlah Hasil: ${config.store.currency} ${totalRevenue.toFixed(2)}\\n\\nüìä 7 Hari Lepas: ${config.store.currency} ${revenue7Days.toFixed(2)}\\nüìä 30 Hari Lepas: ${config.store.currency} ${revenue30Days.toFixed(2)}\\n\\nüì¶ Jumlah Pesanan: ${completed.length}\\nüìà Nilai Purata Pesanan: ${config.store.currency} ${(completed.length > 0 ? totalRevenue / completed.length : 0).toFixed(2)}`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'sys_revenue' }]\n      ]\n    }\n  });\n}));\n\nbot.action('search_orders', safeHandler(async (ctx) => {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  const text = lang === 'ms' \n    ? 'üîç *Cari Pesanan*\\n\\nGunakan arahan berikut untuk mencari pesanan anda:\\n\\n`/searchorder [order_id]` - Cari pesanan mengikut ID\\n\\nContoh:\\n`/searchorder ORD-ABC123`'\n    : 'üîç *Search Order*\\n\\nUse the following command to search for your orders:\\n\\n`/searchorder [order_id]` - Search order by ID\\n\\nExample:\\n`/searchorder ORD-ABC123`';\n  await ctx.answerCbQuery();\n  await ctx.reply(text, { parse_mode: 'Markdown' });\n}));\n\nbot.action('view_faq', safeHandler(handleFAQList));\n\nbot.action('user_guide', safeHandler(async (ctx) => {\n  const { Markup } = require('telegraf');\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n\n  const guideText = lang === 'ms' \n    ? `üìñ *PANDUAN PENGGUNAAN BOT*\n\nüõçÔ∏è *Cara Membeli Produk:*\n1. Klik butang \"Beli Produk\" di menu utama\n2. Pilih kategori produk yang anda inginkan\n3. Pilih produk yang anda mahu beli\n4. Klik \"Beli Sekarang\"\n5. Ikut arahan untuk membuat pembayaran\n\nüí≥ *Cara Membuat Pembayaran:*\n1. Selepas klik \"Beli Sekarang\", anda akan terima maklumat pembayaran\n2. Buat pembayaran melalui online banking atau e-wallet\n3. Ambil screenshot bukti pembayaran anda\n\nüì∏ *Cara Hantar Bukti Pembayaran:*\n1. Gunakan arahan: \\`/send [order_id]\\`\n2. Contoh: \\`/send ORD-ABC123\\`\n3. Attach gambar bukti pembayaran anda\n4. Admin akan sahkan pembayaran anda\n\nüìã *Cara Lihat Pesanan:*\n‚Ä¢ Klik \"Pesanan Saya\" di menu utama\n‚Ä¢ Atau gunakan \\`/searchorder [order_id]\\` untuk cari pesanan tertentu\n\nüí¨ *Cara Hubungi Support:*\n‚Ä¢ Klik butang \"Support\" di menu utama\n‚Ä¢ Hantar mesej anda kepada admin\n‚Ä¢ Untuk keluar, klik \"Keluar dari Sesi\"\n\n‚ö° *Arahan Yang Ada Untuk Pengguna:*\n‚Ä¢ \\`/start\\` - Kembali ke menu utama\n‚Ä¢ \\`/send [order_id]\\` - Hantar bukti pembayaran\n‚Ä¢ \\`/searchorder [order_id]\\` - Cari pesanan\n‚Ä¢ \\`/faq\\` - Lihat soalan lazim\n‚Ä¢ \\`/ping\\` - Semak maklumat runtime sistem\n‚Ä¢ \\`/list\\` - Lihat semua arahan\n\n‚ùì Jika ada masalah, sila hubungi admin melalui Support!`\n    : `üìñ *BOT USAGE GUIDE*\n\nüõçÔ∏è *How to Buy Products:*\n1. Click \"Buy Products\" button in main menu\n2. Select the product category you want\n3. Choose the product you want to buy\n4. Click \"Buy Now\"\n5. Follow the instructions to make payment\n\nüí≥ *How to Make Payment:*\n1. After clicking \"Buy Now\", you will receive payment information\n2. Make payment via online banking or e-wallet\n3. Take a screenshot of your payment proof\n\nüì∏ *How to Send Payment Proof:*\n1. Use command: \\`/send [order_id]\\`\n2. Example: \\`/send ORD-ABC123\\`\n3. Attach your payment proof image\n4. Admin will verify your payment\n\nüìã *How to View Orders:*\n‚Ä¢ Click \"My Orders\" in main menu\n‚Ä¢ Or use \\`/searchorder [order_id]\\` to search specific order\n\nüí¨ *How to Contact Support:*\n‚Ä¢ Click \"Support\" button in main menu\n‚Ä¢ Send your message to admin\n‚Ä¢ To exit, click \"Leave Session\"\n\n‚ö° *Available Commands for Users:*\n‚Ä¢ \\`/start\\` - Return to main menu\n‚Ä¢ \\`/send [order_id]\\` - Send payment proof\n‚Ä¢ \\`/searchorder [order_id]\\` - Search order\n‚Ä¢ \\`/faq\\` - View FAQ\n‚Ä¢ \\`/ping\\` - Check system runtime info\n‚Ä¢ \\`/list\\` - View all commands\n\n‚ùì If you have any issues, please contact admin via Support!`;\n\n  await safeEditMessage(ctx, guideText, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([\n      [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'main_menu')]\n    ])\n  });\n}));\n\nbot.action('all_orders', safeHandler(handleCheckAllOrderId));\n\nbot.action('admin_search_orders', safeHandler(async (ctx) => {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  const text = lang === 'ms' \n    ? 'üîç *Cari Pesanan Admin*\\n\\nGunakan arahan berikut:\\n\\n`/searchorder [query]` - Cari pesanan (ID/User ID/Status)\\n`/filterorders` - Tapis pesanan mengikut status'\n    : 'üîç *Admin Order Search*\\n\\nUse the following commands:\\n\\n`/searchorder [query]` - Search orders (ID/User ID/Status)\\n`/filterorders` - Filter orders by status';\n  await ctx.answerCbQuery();\n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[Markup.button.callback(t('btnBack', lang), 'admin_panel')]])\n  });\n}));\n\n// NEW IMPROVEMENTS - Bulk Operations\nbot.action('bulk_operations', safeHandler(handleBulkOperations));\nbot.action('bulk_activate_all', safeHandler(handleBulkActivateAll));\nbot.action('bulk_deactivate_all', safeHandler(handleBulkDeactivateAll));\nbot.action('bulk_price_category', safeHandler(handleBulkPriceByCategory));\nbot.action('bulk_stock_category', safeHandler(handleBulkStockByCategory));\nbot.action('bulk_delete_inactive', safeHandler(handleBulkDeleteInactive));\nbot.action('bulk_delete_confirm', safeHandler(handleBulkDeleteConfirm));\n\nbot.action(/^bulk_price_cat_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleBulkPriceCategorySelect(ctx, categoryId);\n}));\n\nbot.action(/^bulk_stock_cat_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleBulkStockCategorySelect(ctx, categoryId);\n}));\n\n// Product Search & Filter\nbot.action('product_search', safeHandler(handleProductSearch));\nbot.action('product_filter', safeHandler(handleProductFilter));\nbot.action(/^filter_(.+)$/, safeHandler(async (ctx) => {\n  const filterType = ctx.match[1];\n  await handleProductFilterCallback(ctx, filterType);\n}));\n\n// Category Advanced\nbot.action('category_sort', safeHandler(handleCategorySort));\nbot.action(/^sort_cat_(.+)$/, safeHandler(async (ctx) => {\n  const sortType = ctx.match[1];\n  await handleCategorySortCallback(ctx, sortType);\n}));\nbot.action(/^cat_analytics_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleCategoryAnalytics(ctx, categoryId);\n}));\nbot.action(/^cat_icon_select_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleCategoryIconSelector(ctx, categoryId);\n}));\nbot.action(/^set_cat_icon_(.+)_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  const icon = ctx.match[2];\n  await handleSetCategoryIcon(ctx, categoryId, icon);\n}));\n\n// Owner Dashboard\nbot.action('owner_dashboard', safeHandler(handleOwnerDashboard));\nbot.action('owner_detailed_report', safeHandler(handleDetailedReport));\nbot.action('owner_trend_analysis', safeHandler(handleTrendAnalysis));\nbot.action('owner_analytics', safeHandler(handleOwnerAnalytics));\n\n// Quick Actions\nbot.action('quick_actions', safeHandler(handleQuickActionsMenu));\nbot.action('qa_quick_verify', safeHandler(handleQuickVerify));\nbot.action('qa_quick_stock', safeHandler(handleQuickStock));\nbot.action('qa_quick_price', safeHandler(handleQuickPrice));\nbot.action('qa_verify_all', safeHandler(handleQuickVerifyAll));\nbot.action(/^qa_verify_(.+)$/, safeHandler(async (ctx) => {\n  const orderId = ctx.match[1];\n  await handleQuickVerifyOrder(ctx, orderId);\n}));\nbot.action(/^qa_reject_(.+)$/, safeHandler(async (ctx) => {\n  const orderId = ctx.match[1];\n  await handleQuickRejectOrder(ctx, orderId);\n}));\n\n// Product Stats\nbot.action(/^prod_stats_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleProductStats(ctx, productId);\n}));\nbot.action('all_products_stats', safeHandler(handleAllProductsStats));\n\n// Export Reports\nbot.action('export_menu', safeHandler(handleExportMenu));\nbot.action('export_products', safeHandler(async (ctx) => {\n  await ctx.answerCbQuery();\n  await exportProductsCSV(ctx);\n}));\nbot.action('export_transactions', safeHandler(async (ctx) => {\n  await ctx.answerCbQuery();\n  await exportTransactionsCSV(ctx);\n}));\nbot.action('export_users', safeHandler(async (ctx) => {\n  await ctx.answerCbQuery();\n  await exportUsersCSV(ctx);\n}));\nbot.action('export_sales', safeHandler(async (ctx) => {\n  await ctx.answerCbQuery();\n  await exportSalesReport(ctx);\n}));\n\n// Admin Permissions (using short callbacks to avoid 64-byte limit)\nbot.action('perm_mgmt', safeHandler(handlePermissionsManagement));\nbot.action('perm_management', safeHandler(handlePermissionsManagement));\nbot.action(/^pm_(.+)$/, safeHandler(async (ctx) => {\n  const adminId = ctx.match[1];\n  await handleAdminPermissionsEdit(ctx, adminId);\n}));\nbot.action(/^pt_(.+)_(.+)$/, safeHandler(async (ctx) => {\n  const adminId = ctx.match[1];\n  const permission = ctx.match[2];\n  await handleTogglePermission(ctx, adminId, permission);\n}));\nbot.action(/^admin_activity_(.+)$/, safeHandler(async (ctx) => {\n  const adminId = ctx.match[1];\n  await handleAdminActivityLog(ctx, adminId);\n}));\n\nbot.action('admin_ban_user', safeHandler(async (ctx) => {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  const text = lang === 'ms' \n    ? 'üö´ *Sekat Pengguna*\\n\\nGunakan arahan berikut:\\n\\n`/ban [user_id] [reason]` - Sekat pengguna\\n`/unban [user_id]` - Nyahsekat pengguna\\n`/bannedlist` - Senarai pengguna yang disekat\\n\\nContoh:\\n`/ban 123456789 Spam`'\n    : 'üö´ *Ban User*\\n\\nUse the following commands:\\n\\n`/ban [user_id] [reason]` - Ban a user\\n`/unban [user_id]` - Unban a user\\n`/bannedlist` - List banned users\\n\\nExample:\\n`/ban 123456789 Spam`';\n  await ctx.answerCbQuery();\n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[Markup.button.callback(t('btnBack', lang), 'admin_panel')]])\n  });\n}));\n\nbot.action('admin_user_mgmt', safeHandler(async (ctx) => {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  const text = lang === 'ms' \n    ? 'üë• *Pengurusan Pengguna*\\n\\nGunakan arahan berikut:\\n\\n`/tag [user_id] [tag]` - Tag pengguna (vip/regular/etc)\\n`/untag [user_id] [tag]` - Buang tag pengguna\\n`/ban [user_id] [reason]` - Sekat pengguna\\n`/unban [user_id]` - Nyahsekat pengguna\\n`/bannedlist` - Senarai pengguna disekat'\n    : 'üë• *User Management*\\n\\nUse the following commands:\\n\\n`/tag [user_id] [tag]` - Tag a user (vip/regular/etc)\\n`/untag [user_id] [tag]` - Remove user tag\\n`/ban [user_id] [reason]` - Ban a user\\n`/unban [user_id]` - Unban a user\\n`/bannedlist` - List banned users';\n  await ctx.answerCbQuery();\n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[Markup.button.callback(t('btnBack', lang), 'admin_panel')]])\n  });\n}));\n\nbot.action('admin_quick_reply', safeHandler(async (ctx) => {\n  const { Markup } = require('telegraf');\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  const text = lang === 'ms' \n    ? 'üí¨ *Balas Pantas*\\n\\nGunakan arahan berikut:\\n\\n`/addtemplate [keyword] | [message]` - Tambah template\\n`/qt [keyword]` - Guna template pantas\\n`/templates` - Senarai semua template\\n`/deletetemplate [keyword]` - Padam template\\n\\nContoh:\\n`/addtemplate terima_kasih | Terima kasih kerana membeli!`\\n`/qt terima_kasih`'\n    : 'üí¨ *Quick Reply*\\n\\nUse the following commands:\\n\\n`/addtemplate [keyword] | [message]` - Add template\\n`/qt [keyword]` - Use quick template\\n`/templates` - List all templates\\n`/deletetemplate [keyword]` - Delete template\\n\\nExample:\\n`/addtemplate thank_you | Thank you for your purchase!`\\n`/qt thank_you`';\n  await ctx.answerCbQuery();\n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[Markup.button.callback(t('btnBack', lang), 'admin_panel')]])\n  });\n}));\n\nbot.action('admin_manage_faq', safeHandler(async (ctx) => {\n  const { Markup } = require('telegraf');\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  const text = lang === 'ms' \n    ? '‚ùì *Pengurusan FAQ*\\n\\nGunakan arahan berikut:\\n\\n`/addfaq [soalan] | [jawapan]` - Tambah FAQ\\n`/listfaqs` - Senarai semua FAQ\\n`/deletefaq [faq_id]` - Padam FAQ\\n\\nContoh:\\n`/addfaq Berapa lama penghantaran? | Penghantaran mengambil masa 1-24 jam`'\n    : '‚ùì *Manage FAQ*\\n\\nUse the following commands:\\n\\n`/addfaq [question] | [answer]` - Add FAQ\\n`/listfaqs` - List all FAQs\\n`/deletefaq [faq_id]` - Delete FAQ\\n\\nExample:\\n`/addfaq How long is delivery? | Delivery takes 1-24 hours`';\n  await ctx.answerCbQuery();\n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[Markup.button.callback(t('btnBack', lang), 'admin_panel')]])\n  });\n}));\n\nbot.action('owner_analytics', safeHandler(handleOwnerAnalytics));\n\nbot.action('owner_advanced', safeHandler(handleOwnerAdvanced));\n\nbot.action(/^catpage_(.+)_(\\d+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  const page = parseInt(ctx.match[2]);\n  await handleCategory(ctx, categoryId, page);\n}));\n\nbot.action(/^cat_(.+)$/, safeHandler(async (ctx) => {\n  const categoryId = ctx.match[1];\n  await handleCategory(ctx, categoryId);\n}));\n\nbot.action(/^prod_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleProductView(ctx, productId);\n}));\n\nbot.action(/^buy_(.+)$/, safeHandler(async (ctx) => {\n  const productId = ctx.match[1];\n  await handleBuyProduct(ctx, productId);\n}));\n\nbot.action(/^end_session_(.+)$/, safeHandler(async (ctx) => {\n  const token = ctx.match[1];\n  await handleEndSession(ctx, token);\n}));\n\nbot.action(/^join_session_(.+)$/, safeHandler(async (ctx) => {\n  const token = ctx.match[1];\n  await handleJoinSession(ctx, token);\n}));\n\nbot.action(/^filter_(.+)$/, safeHandler(async (ctx) => {\n  const filter = ctx.match[1];\n  await handleFilterCallback(ctx, filter);\n}));\n\nbot.action(/^lang_(.+)$/, safeHandler(async (ctx) => {\n  const lang = ctx.match[1];\n  await handleLanguageSelect(ctx, lang);\n}));\n\nbot.action(/^currency_(.+)$/, safeHandler(async (ctx) => {\n  const currency = ctx.match[1];\n  await handleCurrencySelect(ctx, currency);\n}));\n\nbot.action(/^rating_(.+)_(\\d+)$/, safeHandler(async (ctx) => {\n  const orderId = ctx.match[1];\n  const rating = parseInt(ctx.match[2]);\n  await handleRating(ctx, orderId, rating);\n}));\n\nbot.action(/^feedback_skip_(.+)$/, safeHandler(async (ctx) => {\n  const orderId = ctx.match[1];\n  await handleSkipFeedback(ctx, orderId);\n}));\n\nbot.action(/^verify_order_(.+)$/, safeHandler(async (ctx) => {\n  const orderId = ctx.match[1];\n  await handleVerifyOrder(ctx, orderId);\n  await ctx.answerCbQuery();\n}));\n\nbot.action(/^reject_order_(.+)$/, safeHandler(async (ctx) => {\n  const orderId = ctx.match[1];\n  await handleRejectOrder(ctx, orderId);\n  await ctx.answerCbQuery();\n}));\n\nbot.action(/^view_schedule_(.+)$/, safeHandler(async (ctx) => {\n  const scheduleId = ctx.match[1];\n  await handleViewSchedule(ctx, scheduleId);\n}));\n\nbot.action(/^use_promo_template_(.+)$/, safeHandler(async (ctx) => {\n  const templateId = ctx.match[1];\n  await handleUsePromoTemplate(ctx, templateId);\n}));\n\nbot.action(/^view_discount_(.+)$/, safeHandler(async (ctx) => {\n  const discountCode = ctx.match[1];\n  await handleViewDiscount(ctx, discountCode);\n}));\n\nbot.action(/^view_flash_(.+)$/, safeHandler(async (ctx) => {\n  const flashId = ctx.match[1];\n  await handleViewFlash(ctx, flashId);\n}));\n\nbot.action(/^view_repeat_(.+)$/, safeHandler(async (ctx) => {\n  const repeatId = ctx.match[1];\n  await handleViewRepeat(ctx, repeatId);\n}));\n\nbot.on('text', async (ctx) => {\n  // Check for category edit processing\n  const categoryEdited = await processCategoryEdit(ctx);\n  if (categoryEdited) {\n    return;\n  }\n\n  // Check for product edit processing\n  const productEdited = await processProductEdit(ctx);\n  if (productEdited) {\n    return;\n  }\n\n  // NEW IMPROVEMENTS - Check for bulk edit processing\n  const bulkEdited = await processBulkEdit(ctx);\n  if (bulkEdited) {\n    return;\n  }\n\n  // NEW IMPROVEMENTS - Check for product search\n  const productSearched = await processProductSearch(ctx);\n  if (productSearched) {\n    return;\n  }\n\n  // NEW IMPROVEMENTS - Check for quick stock update\n  const quickStockUpdated = await processQuickStock(ctx);\n  if (quickStockUpdated) {\n    return;\n  }\n\n  // NEW IMPROVEMENTS - Check for quick price update\n  const quickPriceUpdated = await processQuickPrice(ctx);\n  if (quickPriceUpdated) {\n    return;\n  }\n\n  // NEW FEATURES - Process inputs\n  await processOptionInput(ctx);\n  await processScheduleInput(ctx);\n  await processDiscountInput(ctx);\n  await processReviewComment(ctx);\n  await processCustomDateInput(ctx);\n  await processQuickEditInput(ctx);\n  await processProductImage(ctx);\n\n  // Check for feedback comment first\n  const feedbackHandled = await handleFeedbackComment(ctx);\n  if (feedbackHandled) {\n    return;\n  }\n\n  // Check for FAQ auto-response\n  if (ctx.message.text && !ctx.message.text.startsWith('/')) {\n    const faqResponse = await checkFAQResponse(ctx.message.text, ctx.from.id);\n    if (faqResponse) {\n      await ctx.reply(`üí° *Auto FAQ Response:*\\n\\n${faqResponse}\\n\\n_Still need help? Use /support to chat with admin._`, { parse_mode: 'Markdown' });\n      return;\n    }\n  }\n\n  const broadcasted = await handleBroadcastMessage(ctx);\n  if (!broadcasted) {\n    await handleSessionMessage(ctx);\n  }\n});\n\nbot.on('photo', async (ctx) => {\n  if (ctx.message.caption && ctx.message.caption.startsWith('/')) {\n    return;\n  }\n\n  // Check if photo is for product image upload\n  await processProductImage(ctx);\n\n  await handleSessionMessage(ctx);\n});\n\nbot.on('document', async (ctx) => {\n  await handleSessionMessage(ctx);\n});\n\nbot.on('audio', async (ctx) => {\n  await handleSessionMessage(ctx);\n});\n\nbot.on('voice', async (ctx) => {\n  await handleSessionMessage(ctx);\n});\n\nbot.on('video', async (ctx) => {\n  await handleSessionMessage(ctx);\n});\n\nbot.on('location', async (ctx) => {\n  await handleSessionMessage(ctx);\n});\n\nbot.catch(async (err, ctx) => {\n  console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  console.error('üî¥ BOT ERROR OCCURRED:');\n  console.error('Error:', err.message || err);\n  console.error('Stack:', err.stack);\n  console.error('User ID:', ctx?.from?.id);\n  console.error('Username:', ctx?.from?.username);\n  console.error('Update type:', ctx?.updateType);\n  console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n\n  try {\n    const user = await db.getUser(ctx?.from?.id);\n    const lang = user?.language || 'ms';\n\n    const errorMsg = lang === 'ms' \n      ? '‚ùå *Ralat berlaku!*\\n\\nSila cuba lagi atau hubungi admin jika masalah berterusan.\\n\\n_Kod ralat telah dilog untuk pembaikan._'\n      : '‚ùå *An error occurred!*\\n\\nPlease try again or contact admin if the problem persists.\\n\\n_Error has been logged for fixing._';\n\n    if (ctx?.reply) {\n      await ctx.reply(errorMsg, { parse_mode: 'Markdown' });\n    }\n  } catch (replyErr) {\n    console.error('Failed to send error message to user:', replyErr);\n  }\n});\n\nbot.launch()\n  .then(() => {\n    console.log('üöÄ CexiStore Bot is running!');\n    console.log('Bot username:', bot.botInfo.username);\n    console.log('üì¶ Dropbox auto-backup scheduled (daily at midnight)');\n\n    // Initialize stock alerts system\n    initializeStockAlerts(bot);\n    console.log('üìä Stock alert system initialized');\n\n    // Check scheduled products every 5 minutes\n    setInterval(() => {\n      checkScheduledProducts(bot);\n    }, 5 * 60 * 1000);\n    console.log('üìÖ Scheduled publishing system initialized');\n  })\n  .catch((err) => {\n    console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n    console.error('‚ö†Ô∏è  Failed to start Telegram bot:', err.message);\n    console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n    console.log('üí° Add valid TELEGRAM_BOT_TOKEN to start the bot');\n  });\n\nprocess.once('SIGINT', () => {\n  bot.stop('SIGINT');\n});\nprocess.once('SIGTERM', () => {\n  bot.stop('SIGTERM');\n});","size_bytes":67659},"handlers/admin.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { t } = require('../utils/translations');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { sendFeedbackRequest } = require('./feedback');\nconst { logAdminAction } = require('../utils/adminLogger');\n\nconst broadcastMode = new Map();\n\nasync function isAdmin(userId) {\n  const admins = await db.getAdmins();\n  return admins.owner === userId || admins.admins.includes(userId);\n}\n\nasync function handleAdminPanel(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    const user = await db.getUser(userId);\n    const lang = user?.language || 'ms';\n    await ctx.answerCbQuery(t('unauthorized', lang));\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const pendingOrders = transactions.filter(t => t.status === 'awaiting_verification');\n  const todayOrders = transactions.filter(t => {\n    const today = new Date().toDateString();\n    const orderDate = new Date(t.createdAt).toDateString();\n    return today === orderDate;\n  });\n  const completedToday = todayOrders.filter(t => t.status === 'completed');\n  \n  const products = await db.getProducts();\n  const lowStock = products.filter(p => p.stock < 5 && p.active);\n  \n  const statsText = lang === 'ms'\n    ? `\\n\\nüìä *Statistik Hari Ini:*\\nüí≥ Pending: ${pendingOrders.length}\\n‚úÖ Selesai: ${completedToday.length}\\n‚ö†Ô∏è Stok Rendah: ${lowStock.length}`\n    : `\\n\\nüìä *Today's Statistics:*\\nüí≥ Pending: ${pendingOrders.length}\\n‚úÖ Completed: ${completedToday.length}\\n‚ö†Ô∏è Low Stock: ${lowStock.length}`;\n  \n  const buttons = [\n    [Markup.button.callback(\n      lang === 'ms' ? `üí≥ Order Baru (${pendingOrders.length})` : `üí≥ New Orders (${pendingOrders.length})`, \n      'admin_orders'\n    )],\n    [Markup.button.callback(t('btnManageProducts', lang), 'admin_products_menu')],\n    [Markup.button.callback(lang === 'ms' ? '‚ö° Quick Actions' : '‚ö° Quick Actions', 'quick_actions')],\n    [Markup.button.callback(t('btnActiveSessions', lang), 'admin_sessions')],\n    [Markup.button.callback(t('btnBroadcast', lang), 'admin_broadcast')],\n    [\n      Markup.button.callback(lang === 'ms' ? '‚úÖ Semua Order' : '‚úÖ All Orders', 'all_orders'), \n      Markup.button.callback(lang === 'ms' ? 'üîç Cari Order' : 'üîç Search', 'admin_search_orders')\n    ],\n    [\n      Markup.button.callback(lang === 'ms' ? 'üë• Urus User' : 'üë• User Mgmt', 'admin_user_mgmt'),\n      Markup.button.callback(lang === 'ms' ? 'üí¨ Quick Reply' : 'üí¨ Quick Reply', 'admin_quick_reply')\n    ],\n    [\n      Markup.button.callback(lang === 'ms' ? 'üìä Statistik' : 'üìä Statistics', 'admin_statistics'),\n      Markup.button.callback(lang === 'ms' ? 'üì• Export' : 'üì• Export', 'export_menu')\n    ],\n    [Markup.button.callback(t('btnBack', lang), 'main_menu')]\n  ];\n  \n  await safeEditMessage(ctx, t('adminPanel', lang) + statsText, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleAdminStatistics(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const users = await db.getUsers();\n  const products = await db.getProducts();\n  \n  const totalOrders = transactions.length;\n  const completedOrders = transactions.filter(t => t.status === 'completed');\n  const totalRevenue = completedOrders.reduce((sum, t) => sum + parseFloat(t.price || 0), 0);\n  \n  const today = new Date();\n  const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());\n  const todayOrders = transactions.filter(t => new Date(t.createdAt) >= todayStart);\n  const todayRevenue = todayOrders\n    .filter(t => t.status === 'completed')\n    .reduce((sum, t) => sum + parseFloat(t.price || 0), 0);\n  \n  const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);\n  const weekOrders = transactions.filter(t => new Date(t.createdAt) >= lastWeek);\n  const weekRevenue = weekOrders\n    .filter(t => t.status === 'completed')\n    .reduce((sum, t) => sum + parseFloat(t.price || 0), 0);\n  \n  const activeProducts = products.filter(p => p.active);\n  const lowStockProducts = products.filter(p => p.stock < 5 && p.active);\n  \n  const text = lang === 'ms'\n    ? `üìä *Statistik Kedai*\\n\\n` +\n      `üë• *Pengguna:*\\n` +\n      `Total: ${users.length}\\n\\n` +\n      `üì¶ *Produk:*\\n` +\n      `Total: ${products.length}\\n` +\n      `Aktif: ${activeProducts.length}\\n` +\n      `‚ö†Ô∏è Stok Rendah: ${lowStockProducts.length}\\n\\n` +\n      `üí∞ *Jualan:*\\n` +\n      `Hari Ini: RM${todayRevenue.toFixed(2)} (${todayOrders.filter(t => t.status === 'completed').length} order)\\n` +\n      `7 Hari: RM${weekRevenue.toFixed(2)} (${weekOrders.filter(t => t.status === 'completed').length} order)\\n` +\n      `Semua: RM${totalRevenue.toFixed(2)} (${completedOrders.length} order)\\n\\n` +\n      `üìã *Order:*\\n` +\n      `Total: ${totalOrders}\\n` +\n      `‚úÖ Selesai: ${completedOrders.length}\\n` +\n      `üí≥ Pending Verification: ${transactions.filter(t => t.status === 'awaiting_verification').length}\\n` +\n      `‚è≥ Pending Payment: ${transactions.filter(t => t.status === 'pending').length}\\n` +\n      `‚ùå Ditolak: ${transactions.filter(t => t.status === 'rejected').length}`\n    : `üìä *Store Statistics*\\n\\n` +\n      `üë• *Users:*\\n` +\n      `Total: ${users.length}\\n\\n` +\n      `üì¶ *Products:*\\n` +\n      `Total: ${products.length}\\n` +\n      `Active: ${activeProducts.length}\\n` +\n      `‚ö†Ô∏è Low Stock: ${lowStockProducts.length}\\n\\n` +\n      `üí∞ *Sales:*\\n` +\n      `Today: RM${todayRevenue.toFixed(2)} (${todayOrders.filter(t => t.status === 'completed').length} orders)\\n` +\n      `7 Days: RM${weekRevenue.toFixed(2)} (${weekOrders.filter(t => t.status === 'completed').length} orders)\\n` +\n      `All Time: RM${totalRevenue.toFixed(2)} (${completedOrders.length} orders)\\n\\n` +\n      `üìã *Orders:*\\n` +\n      `Total: ${totalOrders}\\n` +\n      `‚úÖ Completed: ${completedOrders.length}\\n` +\n      `üí≥ Pending Verification: ${transactions.filter(t => t.status === 'awaiting_verification').length}\\n` +\n      `‚è≥ Pending Payment: ${transactions.filter(t => t.status === 'pending').length}\\n` +\n      `‚ùå Rejected: ${transactions.filter(t => t.status === 'rejected').length}`;\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([\n      [Markup.button.callback(lang === 'ms' ? 'üîÑ Refresh' : 'üîÑ Refresh', 'admin_statistics')],\n      [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_panel')]\n    ])\n  });\n}\n\nasync function handleAdminOrders(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const pendingOrders = transactions.filter(t => t.status === 'awaiting_verification');\n  \n  if (pendingOrders.length === 0) {\n    const message = lang === 'ms'\n      ? '‚úÖ *Tiada Order Pending*\\n\\nSemua order telah diproses.'\n      : '‚úÖ *No Pending Orders*\\n\\nAll orders have been processed.';\n    \n    await safeEditMessage(ctx, message, {\n      parse_mode: 'Markdown',\n      ...Markup.inlineKeyboard([\n        [Markup.button.callback(t('btnBack', lang), 'admin_panel')]\n      ])\n    });\n    return;\n  }\n  \n  const recentOrders = pendingOrders.slice(-5).reverse();\n  \n  let text = lang === 'ms'\n    ? `üì• *Order Menunggu Pengesahan*\\n\\nJumlah: ${pendingOrders.length} order\\n\\n`\n    : `üì• *Orders Pending Verification*\\n\\nTotal: ${pendingOrders.length} orders\\n\\n`;\n  \n  const buttons = [];\n  \n  recentOrders.forEach((order, index) => {\n    const productName = typeof order.productName === 'object' \n      ? (order.productName.ms || order.productName.en)\n      : order.productName;\n    \n    text += `${index + 1}. üÜî \\`${order.id}\\`\\n`;\n    text += `   üì¶ ${productName}\\n`;\n    text += `   üí∞ RM${order.price}\\n`;\n    text += `   üë§ User: ${order.userId}\\n\\n`;\n    \n    buttons.push([\n      Markup.button.callback(`‚úÖ ${order.id}`, `verify_order_${order.id}`),\n      Markup.button.callback(`‚ùå`, `reject_order_${order.id}`)\n    ]);\n  });\n  \n  if (pendingOrders.length > 5) {\n    text += lang === 'ms'\n      ? `\\n_Menunjukkan 5 order terkini. Gunakan /allorders untuk lihat semua._`\n      : `\\n_Showing 5 most recent orders. Use /allorders to see all._`;\n  }\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîÑ Refresh' : 'üîÑ Refresh', 'admin_orders')]);\n  buttons.push([Markup.button.callback(t('btnBack', lang), 'admin_panel')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleVerifyOrder(ctx, orderId) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized / Tidak dibenarkan');\n    return;\n  }\n  \n  const transactions = await db.getTransactions();\n  const order = transactions.find(t => t.id === orderId || t.id.toLowerCase() === orderId.toLowerCase());\n  \n  if (!order) {\n    await ctx.reply(`‚ùå Order not found / Pesanan tidak dijumpai!\\n\\nüÜî Order ID: \\`${orderId}\\`\\n\\nüí° Tip: Gunakan /checkallorderid untuk lihat semua order ID yang sah.`, { parse_mode: 'Markdown' });\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === order.productId);\n  \n  if (!product) {\n    await ctx.reply('Product not found');\n    return;\n  }\n  \n  // Manual delivery - reduce stock\n  if (product.stock > 0) {\n    product.stock -= 1;\n    await db.saveProducts(products);\n    await ctx.reply(`‚úÖ Order ${orderId} verified!\\n\\nüìù Manual delivery - Please deliver the item to the customer.\\nüì¶ Stock updated: ${product.stock} remaining`);\n  } else {\n    await ctx.reply(`‚ùå Cannot verify order ${orderId}!\\n\\n‚ö†Ô∏è Product stock is 0!\\n\\nPlease update stock first or reject this order.`);\n    return;\n  }\n  \n  order.status = 'completed';\n  await db.saveTransactions(transactions);\n  \n  await logAdminAction(userId, 'Order Verified', `Order ${orderId} for user ${order.userId}`);\n  \n  const user = await db.getUser(order.userId);\n  const lang = user?.language || 'ms';\n  \n  try {\n    await ctx.telegram.sendMessage(\n      order.userId,\n      lang === 'ms' \n        ? `‚úÖ Pesanan ${orderId} anda telah disahkan! Admin akan hantar item anda tidak lama lagi.`\n        : `‚úÖ Your order ${orderId} has been verified! Admin will deliver your item shortly.`\n    );\n    \n    // Send feedback request after order completion\n    setTimeout(() => {\n      sendFeedbackRequest(ctx, orderId, order.userId);\n    }, 5000); // 5 seconds delay\n    \n  } catch (error) {\n    console.error('Failed to notify customer:', error.message);\n  }\n}\n\nasync function handleRejectOrder(ctx, orderId) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized / Tidak dibenarkan');\n    return;\n  }\n  \n  const transactions = await db.getTransactions();\n  const order = transactions.find(t => t.id === orderId || t.id.toLowerCase() === orderId.toLowerCase());\n  \n  if (!order) {\n    await ctx.reply(`‚ùå Order not found / Pesanan tidak dijumpai!\\n\\nüÜî Order ID: \\`${orderId}\\`\\n\\nüí° Tip: Gunakan /checkallorderid untuk lihat semua order ID yang sah.`, { parse_mode: 'Markdown' });\n    return;\n  }\n  \n  order.status = 'rejected';\n  await db.saveTransactions(transactions);\n  \n  await logAdminAction(userId, 'Order Rejected', `Order ${orderId} for user ${order.userId}`);\n  \n  await ctx.reply(`‚ùå Order ${orderId} rejected`);\n  \n  try {\n    await ctx.telegram.sendMessage(\n      order.userId,\n      `‚ùå Your order ${orderId} was rejected. Please contact support for more information.`\n    );\n  } catch (error) {\n    console.error('Failed to notify customer:', error.message);\n  }\n}\n\nasync function handleAdminProducts(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  await ctx.answerCbQuery();\n  \n  const { handleProductManagementMenu } = require('./productManagementImproved');\n  await handleProductManagementMenu(ctx);\n}\n\nasync function handleAdminSessions(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const sessions = await db.getSessions();\n  const activeSessions = sessions.filter(s => s.status === 'active');\n  \n  if (activeSessions.length === 0) {\n    await safeEditMessage(ctx, 'üí¨ *Active Support Sessions*\\n\\nNo active sessions at the moment.', {\n      parse_mode: 'Markdown',\n      ...Markup.inlineKeyboard([\n        [Markup.button.callback(t('btnBack', lang), 'admin_panel')]\n      ])\n    });\n    return;\n  }\n  \n  let text = 'üí¨ *Active Support Sessions*\\n\\n';\n  \n  const buttons = [];\n  activeSessions.forEach((session, index) => {\n    const adminStatus = session.adminId ? `üë®‚Äçüíº Admin: ${session.adminId}` : '‚è≥ Waiting for admin';\n    text += `${index + 1}. üé´ Token: \\`${session.token}\\`\\n`;\n    text += `   üë§ User: ${session.userId}\\n`;\n    text += `   ${adminStatus}\\n\\n`;\n    \n    buttons.push([Markup.button.callback(`Join ${session.token}`, `join_session_${session.token}`)]);\n  });\n  \n  text += '\\nClick a button to join a session or use:\\n/join [token]';\n  \n  buttons.push([Markup.button.callback(t('btnBack', lang), 'admin_panel')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleAdminBroadcast(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  broadcastMode.set(userId, true);\n  \n  const text = lang === 'en' \n    ? 'üì¢ *Broadcast Mode*\\n\\nSend your next message and it will be broadcast to all users.\\n\\nThe message will be sent to all registered users in the system.'\n    : 'üì¢ *Mod Siar*\\n\\nHantar mesej seterusnya dan ia akan disiarkan kepada semua pengguna.\\n\\nMesej akan dihantar kepada semua pengguna berdaftar dalam sistem.';\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([\n      [Markup.button.callback(t('btnBack', lang), 'admin_panel')]\n    ])\n  });\n}\n\nasync function handleBroadcastMessage(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!broadcastMode.has(userId)) {\n    return false;\n  }\n  \n  broadcastMode.delete(userId);\n  \n  const message = ctx.message.text;\n  const users = await db.getUsers();\n  \n  let successCount = 0;\n  let failCount = 0;\n  \n  for (const user of users) {\n    try {\n      await ctx.telegram.sendMessage(user.id, `üì¢ *Broadcast Message*\\n\\n${message}`, { parse_mode: 'Markdown' });\n      successCount++;\n    } catch (error) {\n      console.error(`Failed to send broadcast to ${user.id}:`, error.message);\n      failCount++;\n    }\n  }\n  \n  await ctx.reply(`‚úÖ Broadcast sent!\\n\\n‚úì Success: ${successCount}\\n‚úó Failed: ${failCount}`);\n  \n  return true;\n}\n\nasync function handleCheckAllOrderId(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('Unauthorized');\n    return;\n  }\n  \n  const transactions = await db.getTransactions();\n  const products = await db.getProducts();\n  \n  if (transactions.length === 0) {\n    await ctx.reply('üì≠ No orders found in the system.');\n    return;\n  }\n  \n  const statusEmoji = {\n    'pending': '‚è≥',\n    'awaiting_verification': 'üí≥',\n    'completed': '‚úÖ',\n    'rejected': '‚ùå'\n  };\n  \n  let text = 'üìã *All Orders*\\n\\n';\n  \n  transactions.slice(-20).reverse().forEach(order => {\n    const product = products.find(p => p.id === order.productId);\n    const productName = product ? product.name.ms : 'Unknown Product';\n    const status = statusEmoji[order.status] || '‚ùì';\n    \n    text += `${status} \\`${order.id}\\`\\n`;\n    text += `üì¶ ${productName}\\n`;\n    text += `üë§ User: ${order.userId}\\n`;\n    text += `üí∞ RM${order.price}\\n`;\n    text += `üìÖ ${new Date(order.createdAt).toLocaleString('en-MY', { dateStyle: 'short', timeStyle: 'short' })}\\n\\n`;\n  });\n  \n  text += '\\n*Commands:*\\n';\n  text += '`/verify [order_id]` - Approve order\\n';\n  text += '`/reject [order_id]` - Reject order\\n\\n';\n  text += '_Showing last 20 orders_';\n  \n  await ctx.reply(text, { parse_mode: 'Markdown' });\n}\n\nasync function handleAllOrders(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const products = await db.getProducts();\n  \n  if (transactions.length === 0) {\n    await safeEditMessage(ctx, \n      lang === 'ms' ? 'üì≠ *Tiada Order*\\n\\nTiada order dalam sistem.' : 'üì≠ *No Orders*\\n\\nNo orders in the system.', \n      {\n        parse_mode: 'Markdown',\n        ...Markup.inlineKeyboard([\n          [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_panel')]\n        ])\n      }\n    );\n    return;\n  }\n  \n  const statusEmoji = {\n    'pending': '‚è≥',\n    'awaiting_verification': 'üí≥',\n    'completed': '‚úÖ',\n    'rejected': '‚ùå'\n  };\n  \n  const recentOrders = transactions.slice(-10).reverse();\n  const completedOrders = transactions.filter(t => t.status === 'completed');\n  const totalRevenue = completedOrders.reduce((sum, t) => sum + parseFloat(t.price || 0), 0);\n  \n  let text = lang === 'ms'\n    ? `üìã *Semua Order History*\\n\\n` +\n      `üìä Total: ${transactions.length} order\\n` +\n      `üí∞ Keuntungan: RM${totalRevenue.toFixed(2)}\\n\\n` +\n      `üîΩ *10 Order Terkini:*\\n\\n`\n    : `üìã *All Order History*\\n\\n` +\n      `üìä Total: ${transactions.length} orders\\n` +\n      `üí∞ Revenue: RM${totalRevenue.toFixed(2)}\\n\\n` +\n      `üîΩ *Recent 10 Orders:*\\n\\n`;\n  \n  const buttons = [];\n  \n  recentOrders.forEach((order, index) => {\n    const product = products.find(p => p.id === order.productId);\n    const productName = product ? (product.name.ms || product.name) : 'Unknown';\n    const status = statusEmoji[order.status] || '‚ùì';\n    \n    text += `${index + 1}. ${status} \\`${order.id}\\`\\n`;\n    text += `   üì¶ ${productName}\\n`;\n    text += `   üí∞ RM${order.price} | üë§ ${order.userId}\\n`;\n    text += `   üìÖ ${new Date(order.createdAt).toLocaleString('en-MY', { dateStyle: 'short', timeStyle: 'short' })}\\n\\n`;\n    \n    buttons.push([\n      Markup.button.callback(`üîç ${order.id}`, `view_order_${order.id}`),\n      Markup.button.callback(`üóëÔ∏è`, `delete_order_confirm_${order.id}`)\n    ]);\n  });\n  \n  if (transactions.length > 10) {\n    text += lang === 'ms'\n      ? `\\n_Menunjukkan 10 order terkini sahaja._`\n      : `\\n_Showing only 10 most recent orders._`;\n  }\n  \n  buttons.push([\n    Markup.button.callback(lang === 'ms' ? 'üîÑ Refresh' : 'üîÑ Refresh', 'all_orders'),\n    Markup.button.callback(lang === 'ms' ? 'üîç Cari' : 'üîç Search', 'admin_search_orders')\n  ]);\n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_panel')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleViewOrder(ctx, orderId) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const order = transactions.find(t => t.id === orderId);\n  \n  if (!order) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Order tidak dijumpai' : 'Order not found', { show_alert: true });\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === order.productId);\n  const productName = product ? (product.name.ms || product.name) : 'Unknown Product';\n  \n  const statusEmoji = {\n    'pending': '‚è≥',\n    'awaiting_verification': 'üí≥',\n    'completed': '‚úÖ',\n    'rejected': '‚ùå'\n  };\n  \n  const statusText = statusEmoji[order.status] || '‚ùì';\n  \n  let text = lang === 'ms'\n    ? `üì¶ *Butiran Order*\\n\\n` +\n      `üÜî Order ID: \\`${order.id}\\`\\n` +\n      `üì¶ Produk: ${productName}\\n` +\n      `üí∞ Harga: RM${order.price}\\n` +\n      `üë§ User ID: ${order.userId}\\n` +\n      `üìä Status: ${statusText} ${order.status}\\n` +\n      `üìÖ Tarikh: ${new Date(order.createdAt).toLocaleString('en-MY')}\\n`\n    : `üì¶ *Order Details*\\n\\n` +\n      `üÜî Order ID: \\`${order.id}\\`\\n` +\n      `üì¶ Product: ${productName}\\n` +\n      `üí∞ Price: RM${order.price}\\n` +\n      `üë§ User ID: ${order.userId}\\n` +\n      `üìä Status: ${statusText} ${order.status}\\n` +\n      `üìÖ Date: ${new Date(order.createdAt).toLocaleString('en-MY')}\\n`;\n  \n  if (order.paymentProof) {\n    text += lang === 'ms' ? `\\nüì∏ Bukti Bayaran: Ada` : `\\nüì∏ Payment Proof: Available`;\n  }\n  \n  const buttons = [];\n  \n  if (order.status === 'awaiting_verification') {\n    buttons.push([\n      Markup.button.callback(lang === 'ms' ? '‚úÖ Sahkan' : '‚úÖ Verify', `verify_order_${orderId}`),\n      Markup.button.callback(lang === 'ms' ? '‚ùå Tolak' : '‚ùå Reject', `reject_order_${orderId}`)\n    ]);\n  }\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üóëÔ∏è Padam Order' : 'üóëÔ∏è Delete Order', `delete_order_confirm_${orderId}`)]);\n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'all_orders')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleDeleteOrderConfirm(ctx, orderId) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const order = transactions.find(t => t.id === orderId);\n  \n  if (!order) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Order tidak dijumpai' : 'Order not found', { show_alert: true });\n    return;\n  }\n  \n  const text = lang === 'ms'\n    ? `‚ö†Ô∏è *Pengesahan Padam*\\n\\n` +\n      `Adakah anda pasti mahu padam order ini?\\n\\n` +\n      `üÜî Order ID: \\`${orderId}\\`\\n` +\n      `üí∞ Nilai: RM${order.price}\\n` +\n      `üìä Status: ${order.status}\\n\\n` +\n      `‚ö†Ô∏è Tindakan ini tidak boleh dibatalkan!`\n    : `‚ö†Ô∏è *Delete Confirmation*\\n\\n` +\n      `Are you sure you want to delete this order?\\n\\n` +\n      `üÜî Order ID: \\`${orderId}\\`\\n` +\n      `üí∞ Value: RM${order.price}\\n` +\n      `üìä Status: ${order.status}\\n\\n` +\n      `‚ö†Ô∏è This action cannot be undone!`;\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([\n      [\n        Markup.button.callback(lang === 'ms' ? '‚úÖ Ya, Padam' : '‚úÖ Yes, Delete', `delete_order_${orderId}`),\n        Markup.button.callback(lang === 'ms' ? '‚ùå Batal' : '‚ùå Cancel', 'all_orders')\n      ]\n    ])\n  });\n}\n\nasync function handleDeleteOrder(ctx, orderId) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const orderIndex = transactions.findIndex(t => t.id === orderId);\n  \n  if (orderIndex === -1) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Order tidak dijumpai' : 'Order not found', { show_alert: true });\n    return;\n  }\n  \n  const deletedOrder = transactions[orderIndex];\n  \n  transactions.splice(orderIndex, 1);\n  await db.saveTransactions(transactions);\n  \n  await logAdminAction(userId, 'Order Deleted', `Order ${orderId} deleted (Value: RM${deletedOrder.price}, Status: ${deletedOrder.status})`);\n  \n  await ctx.answerCbQuery(\n    lang === 'ms' ? `‚úÖ Order ${orderId} telah dipadam` : `‚úÖ Order ${orderId} deleted`,\n    { show_alert: true }\n  );\n  \n  await handleAllOrders(ctx);\n}\n\nmodule.exports = {\n  isAdmin,\n  handleAdminPanel,\n  handleAdminOrders,\n  handleVerifyOrder,\n  handleRejectOrder,\n  handleAdminProducts,\n  handleAdminSessions,\n  handleAdminBroadcast,\n  handleBroadcastMessage,\n  handleCheckAllOrderId,\n  handleAdminStatistics,\n  handleAllOrders,\n  handleViewOrder,\n  handleDeleteOrderConfirm,\n  handleDeleteOrder\n};\n","size_bytes":24896},"handlers/start.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { t } = require('../utils/translations');\nconst { safeEditMessage } = require('../utils/messageHelper');\n\nasync function handleStart(ctx) {\n  const userId = ctx.from.id;\n  const username = ctx.from.username || ctx.from.first_name;\n  \n  let user = await db.getUser(userId);\n  \n  if (!user) {\n    user = await db.addUser({\n      id: userId,\n      username: username,\n      firstName: ctx.from.first_name,\n      lastName: ctx.from.last_name\n    });\n  }\n  \n  if (!user) {\n    await ctx.reply('Error creating user account. Please try again.');\n    return;\n  }\n  \n  const lang = user.language || 'ms';\n  const settings = await db.getSettings();\n  const admins = await db.getAdmins();\n  \n  const isOwner = admins.owner === userId;\n  const isAdmin = admins.admins.includes(userId);\n  \n  const welcomeText = settings?.welcomeMedia?.caption?.[lang] || \n    (lang === 'ms' ? 'Selamat datang ke CexiStore Ultimate Pro! üõçÔ∏è' : 'Welcome to CexiStore Ultimate Pro! üõçÔ∏è');\n  \n  const buttons = [\n    [Markup.button.callback(t('btnBuyProducts', lang), 'buy_products')],\n    [Markup.button.callback(t('btnMyOrders', lang), 'my_orders'), Markup.button.callback(t('btnMyItems', lang), 'my_items')],\n    [Markup.button.callback(t('btnSupport', lang), 'support')],\n    [Markup.button.callback('üìã Search Order / Cari Pesanan', 'search_orders'), Markup.button.callback('‚ùì FAQ', 'view_faq')],\n    [Markup.button.callback('üìñ Guide / Panduan', 'user_guide')],\n    [Markup.button.callback(t('btnLanguage', lang), 'toggle_language')]\n  ];\n  \n  if (isAdmin || isOwner) {\n    buttons.push([Markup.button.callback(t('btnAdminPanel', lang), 'admin_panel')]);\n  }\n  \n  if (isOwner) {\n    buttons.push([Markup.button.callback(t('btnOwnerPanel', lang), 'owner_panel')]);\n  }\n  \n  try {\n    const videoPath = './attached_assets/VID-20251016-WA0053_1760629558789.mp4';\n    const fs = require('fs');\n    \n    if (fs.existsSync(videoPath)) {\n      await ctx.replyWithVideo(\n        { source: videoPath },\n        {\n          caption: welcomeText,\n          parse_mode: 'Markdown',\n          ...Markup.inlineKeyboard(buttons)\n        }\n      );\n    } else if (settings.welcomeMedia?.path && settings.welcomeMedia?.type === 'image') {\n      await ctx.replyWithPhoto(\n        { source: settings.welcomeMedia.path },\n        {\n          caption: welcomeText,\n          parse_mode: 'Markdown',\n          ...Markup.inlineKeyboard(buttons)\n        }\n      );\n    } else if (settings.welcomeMedia?.path && settings.welcomeMedia?.type === 'video') {\n      await ctx.replyWithVideo(\n        { source: settings.welcomeMedia.path },\n        {\n          caption: welcomeText,\n          parse_mode: 'Markdown',\n          ...Markup.inlineKeyboard(buttons)\n        }\n      );\n    } else {\n      await ctx.reply(welcomeText, {\n        parse_mode: 'Markdown',\n        ...Markup.inlineKeyboard(buttons)\n      });\n    }\n  } catch (error) {\n    console.error('Error sending welcome media:', error);\n    await ctx.reply(welcomeText, {\n      parse_mode: 'Markdown',\n      ...Markup.inlineKeyboard(buttons)\n    });\n  }\n}\n\nasync function handleMainMenu(ctx) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  const admins = await db.getAdmins();\n  \n  const isOwner = admins.owner === userId;\n  const isAdmin = admins.admins.includes(userId);\n  \n  const buttons = [\n    [Markup.button.callback(t('btnBuyProducts', lang), 'buy_products')],\n    [Markup.button.callback(t('btnMyOrders', lang), 'my_orders'), Markup.button.callback(t('btnMyItems', lang), 'my_items')],\n    [Markup.button.callback(t('btnSupport', lang), 'support')],\n    [Markup.button.callback('üìã Search Order / Cari Pesanan', 'search_orders'), Markup.button.callback('‚ùì FAQ', 'view_faq')],\n    [Markup.button.callback('üìñ Guide / Panduan', 'user_guide')],\n    [Markup.button.callback(t('btnLanguage', lang), 'toggle_language')]\n  ];\n  \n  if (isAdmin || isOwner) {\n    buttons.push([Markup.button.callback(t('btnAdminPanel', lang), 'admin_panel')]);\n  }\n  \n  if (isOwner) {\n    buttons.push([Markup.button.callback(t('btnOwnerPanel', lang), 'owner_panel')]);\n  }\n  \n  await safeEditMessage(ctx, t('mainMenu', lang), {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleLanguageToggle(ctx) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const currentLang = user?.language || 'ms';\n  \n  const buttons = [\n    [Markup.button.callback('üá≤üáæ Bahasa Melayu', 'lang_ms')],\n    [Markup.button.callback('üá¨üáß English', 'lang_en')],\n    [Markup.button.callback('üá®üá≥ ‰∏≠Êñá (Mandarin)', 'lang_zh')],\n    [Markup.button.callback('üáÆüá≥ ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)', 'lang_ta')],\n    [Markup.button.callback(t('btnBack', currentLang), 'main_menu')]\n  ];\n  \n  const message = {\n    ms: 'üåê *Pilih Bahasa*\\n\\nSila pilih bahasa pilihan anda:',\n    en: 'üåê *Select Language*\\n\\nPlease select your preferred language:',\n    zh: 'üåê *ÈÄâÊã©ËØ≠Ë®Ä*\\n\\nËØ∑ÈÄâÊã©ÊÇ®ÁöÑÈ¶ñÈÄâËØ≠Ë®ÄÔºö',\n    ta: 'üåê *‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç*\\n\\n‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™ ‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç:'\n  }[currentLang] || 'üåê *Select Language*\\n\\nPlease select your preferred language:';\n  \n  await safeEditMessage(ctx, message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleLanguageSelect(ctx, lang) {\n  const userId = ctx.from.id;\n  await db.updateUser(userId, { language: lang });\n  \n  const message = {\n    ms: '‚úÖ Bahasa telah ditukar kepada Bahasa Melayu',\n    en: '‚úÖ Language changed to English',\n    zh: '‚úÖ ËØ≠Ë®ÄÂ∑≤Êõ¥Êîπ‰∏∫‰∏≠Êñá',\n    ta: '‚úÖ ‡ÆÆ‡Øä‡Æ¥‡Æø ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Ææ‡Æï ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ'\n  }[lang];\n  \n  await ctx.answerCbQuery(message);\n  await handleMainMenu(ctx);\n}\n\nmodule.exports = {\n  handleStart,\n  handleMainMenu,\n  handleLanguageToggle,\n  handleLanguageSelect\n};\n","size_bytes":6111},"replit.md":{"content":"# CexiStore Ultimate Pro - Project Documentation\n\n## Overview\nCexiStore Ultimate Pro is a comprehensive bilingual (Malay/English) Telegram e-commerce bot designed for digital product sales. It offers over 110 functions for users, administrators, and owners, facilitating product browsing, ordering, QR-based payments, live chat support, and manual digital product delivery. The project aims to provide a robust and user-friendly platform for e-commerce within the Telegram ecosystem, with a focus on ease of use and efficient management of digital goods.\n\n## Recent Changes (November 2025)\n- **Telegram-Only Architecture (Nov 20)**: Removed all web components (admin panel, web server, public folder). All features now accessible exclusively via Telegram bot for streamlined management.\n- **Product Options/Variants System (NEW - Nov 1)**: Comprehensive product options system allowing admins to add variants like size, color, subscription duration to products. Features include required/optional options, price modifiers per option, and bilingual support. Accessible via Product Detail ‚Üí Product Options.\n- **Scheduled Product Publishing (NEW - Nov 1)**: Auto-publish products at scheduled date/time. Set future publish dates for products, and they will automatically activate when the scheduled time arrives. Includes auto-notification to owner. Accessible via Product Detail ‚Üí Schedule Publish or Product Management ‚Üí Scheduled Products.\n- **Category-Based Discounts (NEW - Nov 1)**: Apply percentage or fixed amount discounts to entire categories. All products in a category automatically receive the category discount. Supports both percentage (e.g., 10% off) and fixed amount (e.g., RM5 off) discounts. Accessible via Category Management ‚Üí Category Discounts.\n- **Review & Rating System (NEW - Nov 1)**: Complete product review and rating system (1-5 stars). Customers can rate and review products after verified purchases. Displays average ratings, rating distribution, and recent reviews. Accessible via Product Detail ‚Üí View Reviews.\n- **Advanced Order Filtering by Date (NEW - Nov 1)**: Filter orders by date ranges including Today, Yesterday, This Week, This Month, Last 7 Days, Last 30 Days, or Custom Range. Shows detailed statistics including total revenue, order counts by status, and order lists. Accessible via Admin Panel ‚Üí Advanced Order Filters.\n- **Quick Edit for Products (NEW - Nov 1)**: Streamlined product editing without full edit flow. Quickly update price, stock, name, description, or toggle status using simple inline format (e.g., PROD-XXX | 25.50). Accessible via Product Management ‚Üí Quick Edit.\n- **Product Image Management (NEW - Nov 1)**: Upload, view, and delete product images. Supports multiple images per product with automatic file management. Images stored in media/products/ folder. Accessible via Product Detail ‚Üí Product Images.\n- **Admin Activity Logging (Oct 16)**: Implemented comprehensive admin activity logging system that tracks all critical admin operations including order verification/rejection, admin management (add/remove), user ban/unban actions, and log clearing. System shows accurate total count and displays recent activities with admin names, timestamps, and action details. Logs stored in `admin_logs.json` with automatic rotation.\n- **Data Export Feature**: Implemented fully functional data export system with 4 export options - users, products, transactions, and complete export (all data). Exports are delivered as JSON files with proper bilingual support.\n- **Store Status Control**: Added store open/close functionality separate from maintenance mode. When store is closed, customers cannot place orders but can still browse products and access other features. Accessible via System Panel ‚Üí Store Status.\n- **Dropbox Manual Token Support**: Simplified token management via `/addapi` command for external hosting. No environment variables needed - just use /addapi command to set token directly\n- **Auto Promote System (10 Functions)**: Added comprehensive promotional campaign management including broadcast, scheduling, templates, targeting, analytics, A/B testing, discount codes, flash sales, and repeat campaigns\n- **System Functions (20 Functions)**: Implemented advanced system management including user stats, sales analytics, admin logs, health checks, performance monitoring, storage usage, data export/import, maintenance mode, and cache management\n\n## User Preferences\n- **Hosting**: Designed for external hosting (Render, Pterodactyl Panel, etc.)\n- **Dropbox Authentication**: Manual token via `/addapi` command - simple setup tanpa environment variables\n- **Telegram-Only**: All features accessible via Telegram bot - no web interface\n- Backup interval: 5 minutes (configurable in `config.js`)\n- JSON file-based storage (no external database)\n- Bilingual support (Malay primary, English secondary)\n- QR-based payment (no gateway integration)\n- Manual payment verification workflow\n\n## System Architecture\n\n### UI/UX Decisions\n- **Bilingual Interface**: Supports Malay and English with a toggle option.\n- **Interactive Buttons**: Extensive use of inline and reply keyboard buttons for intuitive navigation and quick actions.\n- **Clear Notifications**: Users receive timely updates on order status, payment verification, and support session progress.\n- **Media Support**: QR codes are sent as images, and live chat supports photo exchange for better communication.\n- **Pre-loaded content**: Includes pre-loaded FAQs and message templates to enhance user experience and streamline support.\n\n### Technical Implementations\n- **Bot Framework**: Built on Node.js using the Telegraf framework.\n- **JSON-based Database**: All project data (users, products, transactions, sessions, etc.) is stored in local JSON files within the `data/` directory.\n- **Modular Handlers**: Functionality is organized into distinct handlers (e.g., `start.js`, `products.js`, `admin.js`, `session.js`) for maintainability.\n- **Utility Functions**: Common tasks like database operations, translations, and message handling are encapsulated in `utils/` for reusability.\n- **Safe Message Editing**: Implemented a `safeEditMessage` helper to gracefully handle editing both text and media messages, preventing \"Bad Request\" errors.\n- **Session Management**: Token-based live chat sessions with a 4-hour auto-timeout feature. Admins can join, leave, and close sessions.\n- **Multi-session Handling**: Admins can only be in one active support session at a time, with automatic context switching to prevent message routing issues.\n- **Auto-Backup System**: Automated backups every 5 minutes that create ZIP archives of all data files (excluding backup folder to prevent loops) and upload to Dropbox. The system also automatically checks for and restores new data from Dropbox API. Manual backup available via `/backupnow` command with bilingual support and comprehensive error handling.\n- **Admin Activity Logging**: Complete audit trail system (`utils/adminLogger.js`) that tracks all critical admin operations with timestamps, admin IDs, actions, and details. Integrated into order verification/rejection, admin management, user ban/unban operations, and system maintenance tasks.\n\n### Feature Specifications\n- **User System**: Product browsing, ordering, QR payment proof upload, order history, digital item access, live chat, language toggle.\n- **Admin System**: Order verification/rejection, product/category management, manual product delivery, support session management, customer communication, notifications, stock management.\n- **Owner System**: Admin management (add/remove), owner setup, store settings configuration, welcome media customization, payment QR management, automated backup to Dropbox (every 5 minutes + manual `/backupnow` command).\n- **Auto Promote System (10 Functions)**: Broadcast messaging, scheduled promotions, promotion templates, user targeting, analytics dashboard, A/B testing, discount code management, flash sales, repeat campaigns, active campaign monitoring.\n- **System Functions (20 Functions)**: User statistics, sales analytics, admin activity logs, system health monitoring, backup/restore UI, error tracking, performance metrics, storage usage monitoring, API rate limits, webhook logs, transaction reports, inventory alerts, session analytics, user engagement metrics, revenue dashboard, data export/import, system settings management, maintenance mode, cache control.\n- **Auto Systems**: Unique ID generation, session timeout, stock-based product visibility, admin notifications, OAuth token refresh.\n- **Payment Flow**: User places order -> Bot sends QR -> User pays & uploads proof via `/send` -> Admin verifies (`/verify` or `/reject`) -> Admin manually delivers item to customer.\n- **Product Types**: All products are \"Manual\" delivery (admin handles delivery after verification).\n\n### System Design Choices\n- **Event-Driven**: The bot primarily responds to Telegram messages and commands.\n- **Local Persistence**: All data is stored locally in JSON files, avoiding external database dependencies.\n- **Config-driven**: Core settings and tokens are managed through `config.js` for easy modification.\n- **Structured File System**: Well-organized directory structure to separate concerns (handlers, utils, data, media).\n\n## External Dependencies\n- **Telegram Bot API**: Core communication platform for the bot.\n- **Node.js**: Runtime environment.\n- **Telegraf**: Bot framework for interacting with the Telegram Bot API.\n- **Dropbox API with OAuth**: Primary backup storage with automated data synchronization every 5 minutes using Replit connector for automatic token refresh.\n- **Google Drive API**: Secondary backup storage with automatic failover when primary storage is full.\n- **Archiver**: ZIP compression for backup files.\n- **Node-cron**: Scheduled task execution utilities.\n- **PDFKit**: For PDF receipt generation.\n- **Sharp**: For image processing.\n- **UUID**: For generating unique identifiers.\n- **Dropbox NPM Package (10.34.0)**: Official Dropbox SDK for OAuth integration.","size_bytes":10099},"handlers/orders.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { t } = require('../utils/translations');\nconst { formatDate } = require('../utils/helpers');\nconst { safeEditMessage } = require('../utils/messageHelper');\n\nasync function handleMyOrders(ctx) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const userOrders = transactions.filter(t => t.userId === userId);\n  \n  if (userOrders.length === 0) {\n    const noOrdersMsg = lang === 'ms'\n      ? 'üìã *Pesanan Saya*\\n\\n‚ùå Anda belum ada pesanan lagi.\\n\\nüí° Mulakan dengan klik butang \"Beli Produk\" di menu utama!'\n      : 'üìã *My Orders*\\n\\n‚ùå You don\\'t have any orders yet.\\n\\nüí° Start by clicking \"Buy Products\" in the main menu!';\n    \n    await safeEditMessage(ctx, noOrdersMsg, {\n      parse_mode: 'Markdown',\n      ...Markup.inlineKeyboard([\n        [Markup.button.callback(lang === 'ms' ? 'üõçÔ∏è Beli Produk' : 'üõçÔ∏è Buy Products', 'buy_products')],\n        [Markup.button.callback(t('btnBack', lang), 'main_menu')]\n      ])\n    });\n    return;\n  }\n  \n  let orderText = lang === 'ms' ? 'üìã *Pesanan Saya*\\n\\n' : 'üìã *My Orders*\\n\\n';\n  orderText += lang === 'ms' \n    ? `Jumlah pesanan: ${userOrders.length}\\n\\n`\n    : `Total orders: ${userOrders.length}\\n\\n`;\n  \n  userOrders.slice(-5).reverse().forEach(order => {\n    const statusEmoji = {\n      'pending': '‚è≥',\n      'awaiting_verification': 'üí≥',\n      'completed': '‚úÖ',\n      'rejected': '‚ùå'\n    };\n    const statusText = t(`orderStatus.${order.status}`, lang) || order.status;\n    orderText += `${statusEmoji[order.status] || 'üìå'} \\`${order.id}\\`\\n`;\n    orderText += `üì¶ ${order.productName?.ms || order.productName}\\n`;\n    orderText += `üí∞ RM${order.price}\\n`;\n    orderText += `üìÖ ${formatDate(order.createdAt)}\\n`;\n    orderText += `üìä Status: ${statusText}\\n\\n`;\n  });\n  \n  if (userOrders.length > 5) {\n    orderText += lang === 'ms'\n      ? `\\n_Menunjukkan 5 pesanan terkini. Anda ada ${userOrders.length} pesanan keseluruhan._`\n      : `\\n_Showing 5 most recent orders. You have ${userOrders.length} orders in total._`;\n  }\n  \n  orderText += lang === 'ms'\n    ? '\\n\\nüí° Gunakan `/searchorder [order_id]` untuk cari pesanan tertentu.'\n    : '\\n\\nüí° Use `/searchorder [order_id]` to search for specific order.';\n  \n  await safeEditMessage(ctx, orderText, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([\n      [Markup.button.callback(t('btnBack', lang), 'main_menu')]\n    ])\n  });\n}\n\nasync function handleMyItems(ctx) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const completedOrders = transactions.filter(t => t.userId === userId && t.status === 'completed' && t.deliveredItem);\n  \n  if (completedOrders.length === 0) {\n    await safeEditMessage(ctx, '‚ùå No items yet.', {\n      ...Markup.inlineKeyboard([\n        [Markup.button.callback(t('btnBack', lang), 'main_menu')]\n      ])\n    });\n    return;\n  }\n  \n  let itemsText = 'üéÅ *My Digital Items*\\n\\n';\n  \n  completedOrders.forEach(order => {\n    itemsText += `üì¶ ${order.productName.ms || order.productName}\\n`;\n    itemsText += `üîë ${order.deliveredItem}\\n\\n`;\n  });\n  \n  await safeEditMessage(ctx, itemsText, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([\n      [Markup.button.callback(t('btnBack', lang), 'main_menu')]\n    ])\n  });\n}\n\nmodule.exports = {\n  handleMyOrders,\n  handleMyItems\n};\n","size_bytes":3616},"utils/receipt.js":{"content":"const PDFDocument = require('pdfkit');\nconst fs = require('fs');\nconst path = require('path');\nconst { formatDate, formatPrice } = require('./helpers');\n\nasync function generateReceipt(transaction, product, user) {\n  const doc = new PDFDocument({ margin: 50 });\n  const fileName = `receipt-${transaction.id}.pdf`;\n  const filePath = path.join('logs', fileName);\n  \n  const writeStream = fs.createWriteStream(filePath);\n  doc.pipe(writeStream);\n  \n  doc.fontSize(20).text('CexiStore Ultimate Pro', { align: 'center' });\n  doc.fontSize(12).text('Digital Store Receipt', { align: 'center' });\n  doc.moveDown();\n  \n  doc.fontSize(10).text(`Receipt Date: ${formatDate(new Date())}`, { align: 'right' });\n  doc.moveDown();\n  \n  doc.fontSize(14).text('Order Details', { underline: true });\n  doc.fontSize(10).moveDown(0.5);\n  doc.text(`Order ID: ${transaction.id}`);\n  doc.text(`Customer ID: ${user.id}`);\n  doc.text(`Customer Name: ${user.firstName} ${user.lastName || ''}`);\n  doc.moveDown();\n  \n  doc.fontSize(14).text('Product Information', { underline: true });\n  doc.fontSize(10).moveDown(0.5);\n  doc.text(`Product: ${product.name.ms || product.name}`);\n  doc.text(`Price: ${formatPrice(transaction.price)}`);\n  doc.text(`Order Date: ${formatDate(transaction.createdAt)}`);\n  doc.moveDown();\n  \n  doc.fontSize(14).text('Payment Information', { underline: true });\n  doc.fontSize(10).moveDown(0.5);\n  doc.text(`Status: ${transaction.status.toUpperCase()}`);\n  doc.text(`Total Amount: ${formatPrice(transaction.price)}`);\n  doc.moveDown();\n  \n  if (transaction.deliveredItem) {\n    doc.fontSize(14).text('Delivered Item', { underline: true });\n    doc.fontSize(10).moveDown(0.5);\n    doc.text(transaction.deliveredItem);\n    doc.moveDown();\n  }\n  \n  doc.fontSize(8).text('Thank you for your purchase!', { align: 'center' });\n  doc.text('For support, contact us via the bot.', { align: 'center' });\n  \n  doc.end();\n  \n  return new Promise((resolve, reject) => {\n    writeStream.on('finish', () => resolve(filePath));\n    writeStream.on('error', reject);\n  });\n}\n\nmodule.exports = { generateReceipt };\n","size_bytes":2097},"SETUP_COMPLETE.md":{"content":"# ‚úÖ CexiStore Ultimate Pro - Setup Complete!\n\nYour comprehensive Telegram e-commerce bot is ready to use! üéâ\n\n## üì¶ What's Been Built\n\n### ‚úÖ Core Features Implemented (90+ Functions)\n\n#### üë§ User System (25 Functions)\n- ‚úÖ Product browsing with categories\n- ‚úÖ Product search and filtering  \n- ‚úÖ Order placement with QR payment\n- ‚úÖ Payment proof upload via `/send`\n- ‚úÖ Order history and status tracking\n- ‚úÖ Digital item access (My Items)\n- ‚úÖ Live chat support sessions\n- ‚úÖ Language toggle (Malay/English)\n- ‚úÖ Transaction history\n\n#### üë®‚Äçüíº Admin System (40 Functions)\n- ‚úÖ Order verification (`/verify`, `/reject`)\n- ‚úÖ Product management (add, edit, delete)\n- ‚úÖ Category management\n- ‚úÖ Auto/manual product delivery\n- ‚úÖ Support session management (`/join`)\n- ‚úÖ Customer communication\n- ‚úÖ Order notifications\n- ‚úÖ Stock management\n- ‚úÖ Product listing and search\n\n#### üëë Owner System (20 Functions)\n- ‚úÖ Admin management (`/addadmin`, `/removeadmin`)\n- ‚úÖ Owner setup (`/setowner`)\n- ‚úÖ Store settings configuration\n- ‚úÖ Welcome media customization\n- ‚úÖ Payment QR management\n\n#### ‚öôÔ∏è Auto Systems (15 Functions)\n- ‚úÖ Unique ID generation (orders, sessions, products)\n- ‚úÖ Session timeout (4-hour auto-expire)\n- ‚úÖ Stock management (auto-hide when 0)\n- ‚úÖ Admin notifications on new orders\n- ‚úÖ Auto digital product delivery\n- ‚úÖ Message forwarding in chat sessions\n\n## üöÄ Quick Start (5 Steps)\n\n### Step 1: Get Bot Token\n```\n1. Open Telegram ‚Üí Search @BotFather\n2. Send: /newbot\n3. Follow instructions\n4. Copy your bot token\n```\n\n### Step 2: Add Token to Config\nOpen `config.js` and paste your token:\n```javascript\nTELEGRAM_BOT_TOKEN: 'your_token_here'\n```\n\n### Step 3: (Optional) Setup Example Data\n```bash\nnpm run setup\n```\n\n### Step 4: Start Bot\n```bash\nnpm start\n```\n\n### Step 5: Configure on Telegram\n```\n1. Search for your bot\n2. Send: /start\n3. Send: /setowner\n```\n\n## üìÅ Project Structure\n\n```\nCexiStore/\n‚îú‚îÄ‚îÄ index.js              # Main bot entry\n‚îú‚îÄ‚îÄ config.js             # All configuration\n‚îú‚îÄ‚îÄ handlers/             # Command handlers\n‚îÇ   ‚îú‚îÄ‚îÄ start.js         # Start & main menu\n‚îÇ   ‚îú‚îÄ‚îÄ products.js      # Product browsing\n‚îÇ   ‚îú‚îÄ‚îÄ payment.js       # Payment proof\n‚îÇ   ‚îú‚îÄ‚îÄ orders.js        # Order history\n‚îÇ   ‚îú‚îÄ‚îÄ admin.js         # Admin panel\n‚îÇ   ‚îú‚îÄ‚îÄ owner.js         # Owner panel\n‚îÇ   ‚îî‚îÄ‚îÄ session.js       # Live chat\n‚îú‚îÄ‚îÄ utils/               # Utilities\n‚îÇ   ‚îú‚îÄ‚îÄ database.js      # JSON database\n‚îÇ   ‚îú‚îÄ‚îÄ translations.js  # Bilingual text\n‚îÇ   ‚îú‚îÄ‚îÄ helpers.js       # Helper functions\n‚îÇ   ‚îî‚îÄ‚îÄ receipt.js       # PDF receipts\n‚îú‚îÄ‚îÄ data/                # JSON storage\n‚îú‚îÄ‚îÄ media/               # Welcome images/videos\n‚îú‚îÄ‚îÄ qr/                  # Payment QR codes\n‚îî‚îÄ‚îÄ logs/                # Activity logs\n```\n\n## üéØ Key Commands\n\n### User Commands\n```\n/start - Start bot\n/send  - Upload payment proof (with photo)\n```\n\n### Admin Commands\n```\n/verify [order_id]     - Approve order\n/reject [order_id]     - Reject order\n/join [token]          - Join support session\n/addcategory [name]    - Add category\n/addproduct           - Add product\n/listproducts         - List all products\n```\n\n### Owner Commands\n```\n/setowner              - Set yourself as owner\n/addadmin [user_id]    - Add admin\n/removeadmin [user_id] - Remove admin\n```\n\n## üí∞ Payment Flow\n\n```\nUser ‚Üí Browse ‚Üí Buy ‚Üí QR Payment ‚Üí Upload Proof ‚Üí Admin Verify ‚Üí Delivery\n```\n\n1. User selects product\n2. Bot sends QR code\n3. User pays and uploads proof via `/send`\n4. Admin receives notification\n5. Admin verifies: `/verify ORD-XXX`\n6. Auto delivery or manual send\n\n## üí¨ Support System\n\n```\nUser ‚Üí Request Support ‚Üí Get Token ‚Üí Admin Joins ‚Üí Chat ‚Üí Auto Timeout (4h)\n```\n\n- Session-based live chat\n- Token-based rejoin\n- Message forwarding\n- Auto-expire after 4 hours\n- Activity logging\n\n## üåê Bilingual Support\n\n- Default: Malay (ms)\n- Secondary: English (en)\n- User toggle via button\n- All text translated\n\n## üìù Adding Products\n\n### Step 1: Add Category\n```\n/addcategory Netflix Premium\n```\nCopy the category ID (CAT-XXXXX)\n\n### Step 2: Add Product\n```\n/addproduct CAT-XXXXX | Netflix Premium | 15.00 | 10 | Premium account | auto\n```\n\nFormat:\n```\ncategory_id | name | price | stock | description | type\n```\n\nTypes:\n- `auto` - Bot delivers automatically from stock\n- `manual` - Admin sends manually\n\n## üìä Database Files\n\nAll data in `data/` folder:\n- `users.json` - User accounts\n- `products.json` - Product catalog\n- `categories.json` - Categories\n- `transactions.json` - Orders\n- `sessions.json` - Support chats\n- `admins.json` - Admin list\n- `settings.json` - Store config\n\n## üîß Configuration\n\nAll settings in `config.js`:\n```javascript\n{\n  TELEGRAM_BOT_TOKEN: 'token',\n  OWNER_ID: null,\n  store: {\n    name: 'CexiStore Ultimate Pro',\n    currency: 'RM',\n    sessionTimeout: 14400000 // 4 hours\n  }\n}\n```\n\n## üìö Documentation\n\n- `README.md` - Full documentation\n- `QUICK_START.md` - Quick setup guide\n- `replit.md` - Project architecture\n- `SETUP_COMPLETE.md` - This file\n\n## üéØ Next Steps\n\n1. ‚úÖ Get bot token from @BotFather\n2. ‚úÖ Add token to config.js\n3. ‚úÖ Run npm start\n4. ‚úÖ Send /start to bot\n5. ‚úÖ Send /setowner\n6. ‚úÖ Add categories and products\n7. ‚úÖ Upload payment QR to qr/ folder\n8. ‚úÖ Start selling! üöÄ\n\n## üõ†Ô∏è Tech Stack\n\n- Node.js 20\n- Telegraf 4.16 (Telegram Bot Framework)\n- PDFKit (Receipt generation)\n- Sharp (Image processing)\n- UUID (ID generation)\n- JSON file database\n\n## üîê Security Notes\n\n- All tokens in config.js (not committed to git)\n- Payment verification workflow\n- Owner/admin authorization\n- Session timeout protection\n- Data persistence in JSON\n\n## üì± User Experience\n\n1. User sends `/start`\n2. Sees welcome with inline menu\n3. Browses products by category\n4. Makes purchase\n5. Receives QR payment\n6. Uploads proof with `/send`\n7. Gets item after admin verification\n8. Can request support anytime\n\n---\n\n## üéâ You're All Set!\n\nYour CexiStore bot is ready to start selling digital products!\n\n**Need help?** Check README.md or QUICK_START.md\n\n**Happy Selling! üõçÔ∏è**\n","size_bytes":6246},"utils/messageHelper.js":{"content":"const { Markup } = require('telegraf');\n\n/**\n * Safely edit a message - handles both text and media messages\n * If editing fails (e.g., trying to edit a photo message), sends a new message instead\n */\nasync function safeEditMessage(ctx, text, options = {}) {\n  try {\n    // Try to edit the message text\n    await ctx.editMessageText(text, options);\n    // Answer callback query on success to improve UX\n    if (ctx.callbackQuery) {\n      await ctx.answerCbQuery().catch(() => {});\n    }\n  } catch (error) {\n    const errorMsg = error.response?.description || error.message || '';\n    \n    // If message is not modified (same text), just answer callback and return\n    if (errorMsg.includes('message is not modified')) {\n      if (ctx.callbackQuery) {\n        await ctx.answerCbQuery().catch(() => {});\n      }\n      return;\n    }\n    \n    // If editing fails (e.g., message is a photo/video), delete old message and send new one\n    if (errorMsg.includes('no text in the message to edit') || \n        errorMsg.includes('message to edit not found') ||\n        errorMsg.includes('message can\\'t be edited')) {\n      try {\n        // Answer callback query first to remove loading state\n        if (ctx.callbackQuery) {\n          await ctx.answerCbQuery().catch(() => {});\n        }\n        \n        // Delete the old message if possible\n        if (ctx.callbackQuery?.message?.message_id) {\n          try {\n            await ctx.deleteMessage(ctx.callbackQuery.message.message_id);\n          } catch (deleteErr) {\n            console.log('Could not delete old message:', deleteErr.message);\n          }\n        }\n        \n        // Send new message\n        await ctx.reply(text, options);\n      } catch (fallbackErr) {\n        console.error('safeEditMessage fallback error:', fallbackErr.message);\n        // Last resort: just send the message without options\n        try {\n          await ctx.reply(text);\n        } catch (finalErr) {\n          console.error('safeEditMessage final fallback failed:', finalErr.message);\n        }\n      }\n    } else {\n      // Log unexpected errors but don't crash\n      console.error('safeEditMessage unexpected error:', errorMsg);\n      // Try to at least answer the callback query\n      if (ctx.callbackQuery) {\n        await ctx.answerCbQuery('Error occurred').catch(() => {});\n      }\n      throw error;\n    }\n  }\n}\n\nmodule.exports = {\n  safeEditMessage\n};\n","size_bytes":2394},"handlers/userManagement.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { t } = require('../utils/translations');\nconst { logAdminAction } = require('../utils/adminLogger');\n\nasync function isOwnerOrAdmin(userId) {\n  const admins = await db.getAdmins();\n  return admins.owner === userId || admins.admins.includes(userId);\n}\n\nasync function handleBanUser(ctx, targetUserId, reason = 'No reason provided') {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can ban users.');\n    return;\n  }\n  \n  if (!targetUserId) {\n    await ctx.reply('Usage: /ban [user_id] [reason]\\n\\nExample: /ban 123456 Spam messages');\n    return;\n  }\n  \n  const users = await db.getUsers();\n  const user = users.find(u => u.id == targetUserId);\n  \n  if (!user) {\n    await ctx.reply(`‚ùå User ${targetUserId} not found in database.`);\n    return;\n  }\n  \n  if (user.banned) {\n    await ctx.reply(`‚ö†Ô∏è User ${targetUserId} is already banned.`);\n    return;\n  }\n  \n  await db.updateUser(user.id, {\n    banned: true,\n    bannedAt: new Date().toISOString(),\n    bannedBy: adminId,\n    bannedReason: reason\n  });\n  \n  await logAdminAction(adminId, 'Banned User', `User ${targetUserId} - Reason: ${reason}`);\n  \n  await ctx.reply(`‚úÖ User ${targetUserId} has been banned.\\n\\nüìù Reason: ${reason}\\nüë§ Banned by: ${adminId}`);\n  \n  try {\n    await ctx.telegram.sendMessage(\n      targetUserId,\n      `üö´ *You have been banned from this store.*\\n\\nüìù Reason: ${reason}\\n\\nPlease contact admin if you think this is a mistake.`,\n      { parse_mode: 'Markdown' }\n    );\n  } catch (error) {\n    console.error('Could not notify banned user:', error.message);\n  }\n}\n\nasync function handleUnbanUser(ctx, targetUserId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can unban users.');\n    return;\n  }\n  \n  if (!targetUserId) {\n    await ctx.reply('Usage: /unban [user_id]\\n\\nExample: /unban 123456');\n    return;\n  }\n  \n  const users = await db.getUsers();\n  const user = users.find(u => u.id == targetUserId);\n  \n  if (!user) {\n    await ctx.reply(`‚ùå User ${targetUserId} not found in database.`);\n    return;\n  }\n  \n  if (!user.banned) {\n    await ctx.reply(`‚ö†Ô∏è User ${targetUserId} is not banned.`);\n    return;\n  }\n  \n  await db.updateUser(user.id, {\n    banned: false,\n    bannedAt: null,\n    bannedBy: null,\n    bannedReason: null\n  });\n  \n  await logAdminAction(adminId, 'Unbanned User', `User ${targetUserId} was unbanned`);\n  \n  await ctx.reply(`‚úÖ User ${targetUserId} has been unbanned.\\n\\nThey can now use the store again.`);\n  \n  try {\n    await ctx.telegram.sendMessage(\n      targetUserId,\n      `‚úÖ *You have been unbanned!*\\n\\nYou can now use the store again. Welcome back! üéâ`,\n      { parse_mode: 'Markdown' }\n    );\n  } catch (error) {\n    console.error('Could not notify unbanned user:', error.message);\n  }\n}\n\nasync function handleTagUser(ctx, targetUserId, tag) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can tag users.');\n    return;\n  }\n  \n  if (!targetUserId || !tag) {\n    await ctx.reply('Usage: /tag [user_id] [tag]\\n\\nExample: /tag 123456 VIP\\n\\nAvailable tags: VIP, Premium, Reseller, Problematic, New');\n    return;\n  }\n  \n  const users = await db.getUsers();\n  const user = users.find(u => u.id == targetUserId);\n  \n  if (!user) {\n    await ctx.reply(`‚ùå User ${targetUserId} not found in database.`);\n    return;\n  }\n  \n  const currentTags = user.tags || [];\n  \n  if (currentTags.includes(tag)) {\n    await ctx.reply(`‚ö†Ô∏è User ${targetUserId} already has tag: ${tag}`);\n    return;\n  }\n  \n  currentTags.push(tag);\n  \n  await db.updateUser(user.id, {\n    tags: currentTags\n  });\n  \n  await ctx.reply(`‚úÖ Tag \"${tag}\" added to user ${targetUserId}\\n\\nüè∑Ô∏è Current tags: ${currentTags.join(', ')}`);\n}\n\nasync function handleUntagUser(ctx, targetUserId, tag) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can untag users.');\n    return;\n  }\n  \n  if (!targetUserId || !tag) {\n    await ctx.reply('Usage: /untag [user_id] [tag]\\n\\nExample: /untag 123456 VIP');\n    return;\n  }\n  \n  const users = await db.getUsers();\n  const user = users.find(u => u.id == targetUserId);\n  \n  if (!user) {\n    await ctx.reply(`‚ùå User ${targetUserId} not found in database.`);\n    return;\n  }\n  \n  const currentTags = user.tags || [];\n  \n  if (!currentTags.includes(tag)) {\n    await ctx.reply(`‚ö†Ô∏è User ${targetUserId} does not have tag: ${tag}`);\n    return;\n  }\n  \n  const updatedTags = currentTags.filter(t => t !== tag);\n  \n  await db.updateUser(user.id, {\n    tags: updatedTags\n  });\n  \n  await ctx.reply(`‚úÖ Tag \"${tag}\" removed from user ${targetUserId}\\n\\nüè∑Ô∏è Remaining tags: ${updatedTags.length > 0 ? updatedTags.join(', ') : 'None'}`);\n}\n\nasync function handleListBannedUsers(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can view banned users.');\n    return;\n  }\n  \n  const users = await db.getUsers();\n  const bannedUsers = users.filter(u => u.banned);\n  \n  if (bannedUsers.length === 0) {\n    await ctx.reply('‚úÖ No banned users at the moment.');\n    return;\n  }\n  \n  let message = 'üö´ *Banned Users List*\\n\\n';\n  \n  bannedUsers.forEach((user, index) => {\n    message += `${index + 1}. üë§ ID: ${user.id}\\n`;\n    message += `   üìù Reason: ${user.bannedReason || 'N/A'}\\n`;\n    message += `   üìÖ Banned: ${new Date(user.bannedAt).toLocaleDateString()}\\n\\n`;\n  });\n  \n  message += `\\nUse /unban [user_id] to unban a user.`;\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function checkIfBanned(userId) {\n  const user = await db.getUser(userId);\n  return user?.banned === true;\n}\n\nmodule.exports = {\n  handleBanUser,\n  handleUnbanUser,\n  handleTagUser,\n  handleUntagUser,\n  handleListBannedUsers,\n  checkIfBanned,\n  isOwnerOrAdmin\n};\n","size_bytes":6103},"handlers/feedback.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { generateId } = require('../utils/helpers');\n\nconst feedbackState = new Map();\n\nasync function sendFeedbackRequest(ctx, orderId, userId) {\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const messages = {\n    ms: `üìù *Feedback & Review*\\n\\nTerima kasih kerana membeli dengan kami!\\n\\nüÜî Order: ${orderId}\\n\\nBolehkah anda berikan rating dan feedback?`,\n    en: `üìù *Feedback & Review*\\n\\nThank you for your purchase!\\n\\nüÜî Order: ${orderId}\\n\\nWould you like to provide a rating and feedback?`,\n    zh: `üìù *ÂèçÈ¶à‰∏éËØÑ‰ª∑*\\n\\nÊÑüË∞¢ÊÇ®ÁöÑË¥≠‰π∞ÔºÅ\\n\\nüÜî ËÆ¢ÂçïÔºö${orderId}\\n\\nÊÇ®ÊÑøÊÑèÊèê‰æõËØÑÂàÜÂíåÂèçÈ¶àÂêóÔºü`,\n    ta: `üìù *‡Æï‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ*\\n\\n‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Ææ‡Æô‡Øç‡Æï‡ØÅ‡Æ§‡Æ≤‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æ®‡Æ©‡Øç‡Æ±‡Æø!\\n\\nüÜî ‡ÆÜ‡Æ∞‡Øç‡Æü‡Æ∞‡Øç: ${orderId}\\n\\n‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÄ‡Æü‡ØÅ ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æï‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡Øà ‡Æµ‡Æ¥‡Æô‡Øç‡Æï ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?`\n  };\n  \n  const buttons = [\n    [\n      Markup.button.callback('‚≠ê', `rating_${orderId}_1`),\n      Markup.button.callback('‚≠ê‚≠ê', `rating_${orderId}_2`),\n      Markup.button.callback('‚≠ê‚≠ê‚≠ê', `rating_${orderId}_3`)\n    ],\n    [\n      Markup.button.callback('‚≠ê‚≠ê‚≠ê‚≠ê', `rating_${orderId}_4`),\n      Markup.button.callback('‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê', `rating_${orderId}_5`)\n    ],\n    [Markup.button.callback(lang === 'ms' ? '‚ùå Tidak sekarang' : '‚ùå Not now', `feedback_skip_${orderId}`)]\n  ];\n  \n  try {\n    await ctx.telegram.sendMessage(\n      userId,\n      messages[lang] || messages.en,\n      {\n        parse_mode: 'Markdown',\n        ...Markup.inlineKeyboard(buttons)\n      }\n    );\n  } catch (error) {\n    console.error('Failed to send feedback request:', error.message);\n  }\n}\n\nasync function handleRating(ctx, orderId, rating) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  feedbackState.set(userId, { orderId, rating, step: 'waiting_comment' });\n  \n  const messages = {\n    ms: `‚≠ê Terima kasih! Anda memberi ${rating} bintang.\\n\\nüí¨ Sila taip komen atau feedback anda (atau skip dengan /skipfeedback):`,\n    en: `‚≠ê Thank you! You gave ${rating} stars.\\n\\nüí¨ Please type your comment or feedback (or skip with /skipfeedback):`,\n    zh: `‚≠ê Ë∞¢Ë∞¢ÔºÅÊÇ®Áªô‰∫Ü${rating}Êòü„ÄÇ\\n\\nüí¨ ËØ∑ËæìÂÖ•ÊÇ®ÁöÑËØÑËÆ∫ÊàñÂèçÈ¶àÔºàÊàñ‰ΩøÁî® /skipfeedback Ë∑≥ËøáÔºâÔºö`,\n    ta: `‚≠ê ‡Æ®‡Æ©‡Øç‡Æ±‡Æø! ‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ${rating} ‡Æ®‡Æü‡Øç‡Æö‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Øä‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç.\\n\\nüí¨ ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æï‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡Øà ‡Æ§‡Æü‡Øç‡Æü‡Æö‡Øç‡Æö‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç (‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ /skipfeedback ‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç ‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç):`\n  };\n  \n  await ctx.editMessageText(messages[lang] || messages.en, { parse_mode: 'Markdown' });\n}\n\nasync function handleFeedbackComment(ctx) {\n  const userId = ctx.from.id;\n  const state = feedbackState.get(userId);\n  \n  if (!state || state.step !== 'waiting_comment') {\n    return false;\n  }\n  \n  const comment = ctx.message.text;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const feedback = {\n    id: generateId('FBK'),\n    orderId: state.orderId,\n    userId: userId,\n    rating: state.rating,\n    comment: comment,\n    createdAt: new Date().toISOString()\n  };\n  \n  const feedbacks = await db.read('feedbacks.json') || [];\n  feedbacks.push(feedback);\n  await db.write('feedbacks.json', feedbacks);\n  \n  feedbackState.delete(userId);\n  \n  const messages = {\n    ms: `‚úÖ *Terima kasih atas feedback anda!*\\n\\n‚≠ê Rating: ${state.rating}/5\\nüí¨ Komen: ${comment}\\n\\nFeedback anda sangat dihargai! üôè`,\n    en: `‚úÖ *Thank you for your feedback!*\\n\\n‚≠ê Rating: ${state.rating}/5\\nüí¨ Comment: ${comment}\\n\\nYour feedback is greatly appreciated! üôè`,\n    zh: `‚úÖ *ÊÑüË∞¢ÊÇ®ÁöÑÂèçÈ¶àÔºÅ*\\n\\n‚≠ê ËØÑÂàÜÔºö${state.rating}/5\\nüí¨ ËØÑËÆ∫Ôºö${comment}\\n\\nÈùûÂ∏∏ÊÑüË∞¢ÊÇ®ÁöÑÂèçÈ¶àÔºÅüôè`,\n    ta: `‚úÖ *‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æ®‡Æ©‡Øç‡Æ±‡Æø!*\\n\\n‚≠ê ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÄ‡Æü‡ØÅ: ${state.rating}/5\\nüí¨ ‡Æï‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ: ${comment}\\n\\n‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡ÆÆ‡Æø‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Ææ‡Æ∞‡Ææ‡Æü‡Øç‡Æü‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ! üôè`\n  };\n  \n  await ctx.reply(messages[lang] || messages.en, { parse_mode: 'Markdown' });\n  \n  return true;\n}\n\nasync function handleSkipFeedback(ctx, orderId) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  feedbackState.delete(userId);\n  \n  const messages = {\n    ms: '‚úÖ Feedback dilangkau. Terima kasih!',\n    en: '‚úÖ Feedback skipped. Thank you!',\n    zh: '‚úÖ Â∑≤Ë∑≥ËøáÂèçÈ¶à„ÄÇË∞¢Ë∞¢ÔºÅ',\n    ta: '‚úÖ ‡Æï‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ. ‡Æ®‡Æ©‡Øç‡Æ±‡Æø!'\n  };\n  \n  await ctx.answerCbQuery(messages[lang] || messages.en);\n}\n\nasync function handleViewFeedbacks(ctx) {\n  const userId = ctx.from.id;\n  const { isAdmin } = require('./admin');\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can view feedbacks.');\n    return;\n  }\n  \n  const feedbacks = await db.read('feedbacks.json') || [];\n  \n  if (feedbacks.length === 0) {\n    await ctx.reply('No feedbacks yet.');\n    return;\n  }\n  \n  const sortedFeedbacks = feedbacks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 20);\n  \n  let message = 'üìù *Customer Feedbacks*\\n\\n';\n  \n  sortedFeedbacks.forEach((fb, index) => {\n    const stars = '‚≠ê'.repeat(fb.rating);\n    message += `${index + 1}. ${stars} (${fb.rating}/5)\\n`;\n    message += `   üÜî Order: ${fb.orderId}\\n`;\n    message += `   üë§ User: ${fb.userId}\\n`;\n    message += `   üí¨ ${fb.comment || 'No comment'}\\n`;\n    message += `   üìÖ ${new Date(fb.createdAt).toLocaleDateString()}\\n\\n`;\n  });\n  \n  if (feedbacks.length > 20) {\n    message += `... and ${feedbacks.length - 20} more feedbacks`;\n  }\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nfunction clearFeedbackState(userId) {\n  feedbackState.delete(userId);\n}\n\nmodule.exports = {\n  sendFeedbackRequest,\n  handleRating,\n  handleFeedbackComment,\n  handleSkipFeedback,\n  handleViewFeedbacks,\n  clearFeedbackState\n};\n","size_bytes":6445},"handlers/productManagement.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { generateId } = require('../utils/helpers');\n\nasync function isOwnerOrAdmin(userId) {\n  const admins = await db.getAdmins();\n  return admins.owner === userId || admins.admins.includes(userId);\n}\n\n// Product Duplication\nasync function handleDuplicateProduct(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can duplicate products.');\n    return;\n  }\n  \n  if (!productId) {\n    await ctx.reply('Usage: /duplicate [product_id]\\n\\nExample: /duplicate PROD-ABC123');\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const originalProduct = products.find(p => p.id === productId);\n  \n  if (!originalProduct) {\n    await ctx.reply(`‚ùå Product ${productId} not found.`);\n    return;\n  }\n  \n  // Create duplicate with new ID\n  const newProduct = {\n    ...originalProduct,\n    id: generateId('PROD'),\n    name: {\n      ms: `${originalProduct.name.ms} (Copy)`,\n      en: `${originalProduct.name.en || originalProduct.name.ms} (Copy)`\n    },\n    stock: 0, // Start with 0 stock\n    items: [], // Empty items for auto-delivery\n    createdAt: new Date().toISOString()\n  };\n  \n  products.push(newProduct);\n  await db.saveProducts(products);\n  \n  // Log inventory movement\n  await logInventoryMovement({\n    productId: newProduct.id,\n    productName: newProduct.name.ms,\n    type: 'product_created',\n    quantity: 0,\n    note: `Duplicated from ${productId}`,\n    adminId: adminId\n  });\n  \n  await ctx.reply(\n    `‚úÖ *Product Duplicated Successfully!*\\n\\n` +\n    `üÜî New ID: \\`${newProduct.id}\\`\\n` +\n    `üì¶ Name: ${newProduct.name.ms}\\n` +\n    `üí∞ Price: RM${newProduct.price}\\n` +\n    `üìä Stock: ${newProduct.stock}\\n\\n` +\n    `Use /additem to add stock for auto-delivery products.`,\n    { parse_mode: 'Markdown' }\n  );\n}\n\n// Inventory Management\nasync function logInventoryMovement(movement) {\n  const inventory = await db.read('inventory.json') || [];\n  \n  const log = {\n    id: generateId('INV'),\n    ...movement,\n    timestamp: new Date().toISOString()\n  };\n  \n  inventory.push(log);\n  await db.write('inventory.json', inventory);\n  \n  return log;\n}\n\nasync function handleInventoryHistory(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can view inventory.');\n    return;\n  }\n  \n  const inventory = await db.read('inventory.json') || [];\n  \n  let logs = [...inventory];\n  \n  if (productId) {\n    logs = logs.filter(l => l.productId === productId);\n    \n    if (logs.length === 0) {\n      await ctx.reply(`‚ùå No inventory history for product: ${productId}`);\n      return;\n    }\n  }\n  \n  // Sort by date (newest first)\n  logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));\n  \n  // Limit to 30 recent logs\n  const displayLogs = logs.slice(0, 30);\n  \n  let message = productId \n    ? `üìä *Inventory History: ${productId}*\\n\\n`\n    : `üìä *Recent Inventory Movements*\\n\\n`;\n  \n  displayLogs.forEach((log, index) => {\n    const typeEmoji = {\n      'stock_added': '‚ûï',\n      'stock_reduced': '‚ûñ',\n      'product_created': 'üÜï',\n      'stock_verified': '‚úÖ',\n      'stock_rejected': '‚ùå',\n      'manual_adjustment': 'üîß'\n    }[log.type] || 'üì¶';\n    \n    message += `${index + 1}. ${typeEmoji} *${log.type.replace(/_/g, ' ').toUpperCase()}*\\n`;\n    message += `   üì¶ ${log.productName}\\n`;\n    message += `   üìä Qty: ${log.quantity > 0 ? '+' : ''}${log.quantity}\\n`;\n    message += `   üìÖ ${new Date(log.timestamp).toLocaleString()}\\n`;\n    if (log.note) {\n      message += `   üìù ${log.note}\\n`;\n    }\n    message += '\\n';\n  });\n  \n  if (logs.length > 30) {\n    message += `... and ${logs.length - 30} older movements\\n`;\n  }\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function handleStockAdjustment(ctx, productId, adjustment, note) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can adjust stock.');\n    return;\n  }\n  \n  if (!productId || !adjustment) {\n    await ctx.reply(\n      'Usage: /adjuststock [product_id] [+/-amount] [note]\\n\\n' +\n      'Examples:\\n' +\n      '‚Ä¢ /adjuststock PROD-ABC +50 Restocked\\n' +\n      '‚Ä¢ /adjuststock PROD-ABC -10 Damaged items removed'\n    );\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product) {\n    await ctx.reply(`‚ùå Product ${productId} not found.`);\n    return;\n  }\n  \n  const amount = parseInt(adjustment);\n  \n  if (isNaN(amount)) {\n    await ctx.reply('‚ùå Invalid amount. Use +/- with number (e.g., +10 or -5)');\n    return;\n  }\n  \n  const oldStock = product.stock;\n  product.stock = Math.max(0, product.stock + amount);\n  \n  // For auto-delivery products, adjust items count too\n  if (product.deliveryType === 'auto' && amount < 0) {\n    const removeCount = Math.abs(amount);\n    product.items = (product.items || []).slice(removeCount);\n  }\n  \n  await db.saveProducts(products);\n  \n  // Log inventory movement\n  await logInventoryMovement({\n    productId: product.id,\n    productName: product.name.ms,\n    type: 'manual_adjustment',\n    quantity: amount,\n    note: note || 'Manual stock adjustment',\n    adminId: adminId,\n    oldStock: oldStock,\n    newStock: product.stock\n  });\n  \n  await ctx.reply(\n    `‚úÖ *Stock Adjusted!*\\n\\n` +\n    `üì¶ Product: ${product.name.ms}\\n` +\n    `üìä Old Stock: ${oldStock}\\n` +\n    `üìä Change: ${amount > 0 ? '+' : ''}${amount}\\n` +\n    `üìä New Stock: ${product.stock}\\n` +\n    `üìù Note: ${note || 'N/A'}`,\n    { parse_mode: 'Markdown' }\n  );\n}\n\n// Export for use in admin.js to log stock changes\nasync function trackStockChange(productId, productName, type, quantity, note, adminId = null) {\n  await logInventoryMovement({\n    productId,\n    productName,\n    type,\n    quantity,\n    note,\n    adminId\n  });\n}\n\nmodule.exports = {\n  handleDuplicateProduct,\n  handleInventoryHistory,\n  handleStockAdjustment,\n  trackStockChange,\n  logInventoryMovement\n};\n","size_bytes":6169},"handlers/currency.js":{"content":"const db = require('../utils/database');\nconst { Markup } = require('telegraf');\n\nconst EXCHANGE_RATES = {\n  MYR: 1,\n  USD: 0.22,  // 1 MYR = 0.22 USD\n  SGD: 0.30,  // 1 MYR = 0.30 SGD\n  EUR: 0.20,  // 1 MYR = 0.20 EUR\n  CNY: 1.60   // 1 MYR = 1.60 CNY\n};\n\nasync function handleSetCurrency(ctx) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const buttons = [\n    [Markup.button.callback('üá≤üáæ MYR (Malaysian Ringgit)', 'currency_MYR')],\n    [Markup.button.callback('üá∫üá∏ USD (US Dollar)', 'currency_USD')],\n    [Markup.button.callback('üá∏üá¨ SGD (Singapore Dollar)', 'currency_SGD')],\n    [Markup.button.callback('üá™üá∫ EUR (Euro)', 'currency_EUR')],\n    [Markup.button.callback('üá®üá≥ CNY (Chinese Yuan)', 'currency_CNY')]\n  ];\n  \n  const messages = {\n    ms: 'üí± *Pilih Mata Wang*\\n\\nSila pilih mata wang pilihan anda:',\n    en: 'üí± *Select Currency*\\n\\nPlease select your preferred currency:',\n    zh: 'üí± *ÈÄâÊã©Ë¥ßÂ∏Å*\\n\\nËØ∑ÈÄâÊã©ÊÇ®ÁöÑÈ¶ñÈÄâË¥ßÂ∏ÅÔºö',\n    ta: 'üí± *‡Æ®‡Ææ‡Æ£‡ÆØ‡Æ§‡Øç‡Æ§‡Øà ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç*\\n\\n‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™ ‡Æ®‡Ææ‡Æ£‡ÆØ‡Æ§‡Øç‡Æ§‡Øà ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç:'\n  };\n  \n  await ctx.reply(messages[lang] || messages.en, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleCurrencySelect(ctx, currency) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  await db.updateUser(userId, { currency: currency });\n  \n  const messages = {\n    ms: `‚úÖ Mata wang ditukar kepada ${currency}`,\n    en: `‚úÖ Currency changed to ${currency}`,\n    zh: `‚úÖ Ë¥ßÂ∏ÅÂ∑≤Êõ¥Êîπ‰∏∫ ${currency}`,\n    ta: `‚úÖ ‡Æ®‡Ææ‡Æ£‡ÆØ‡ÆÆ‡Øç ${currency} ‡ÆÜ‡Æï ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ`\n  };\n  \n  await ctx.answerCbQuery(messages[lang] || messages.en);\n}\n\nfunction convertPrice(priceInMYR, targetCurrency) {\n  const rate = EXCHANGE_RATES[targetCurrency] || 1;\n  const convertedPrice = (priceInMYR * rate).toFixed(2);\n  return convertedPrice;\n}\n\nfunction formatPrice(price, currency) {\n  const symbols = {\n    MYR: 'RM',\n    USD: '$',\n    SGD: 'S$',\n    EUR: '‚Ç¨',\n    CNY: '¬•'\n  };\n  \n  const symbol = symbols[currency] || currency;\n  return `${symbol}${price}`;\n}\n\nfunction getPriceDisplay(priceInMYR, userCurrency = 'MYR') {\n  if (userCurrency === 'MYR') {\n    return `RM${priceInMYR}`;\n  }\n  \n  const convertedPrice = convertPrice(priceInMYR, userCurrency);\n  return `${formatPrice(convertedPrice, userCurrency)} (‚âàRM${priceInMYR})`;\n}\n\nmodule.exports = {\n  handleSetCurrency,\n  handleCurrencySelect,\n  convertPrice,\n  formatPrice,\n  getPriceDisplay,\n  EXCHANGE_RATES\n};\n","size_bytes":2777},"handlers/orderSearch.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\n\nasync function isOwnerOrAdmin(userId) {\n  const admins = await db.getAdmins();\n  return admins.owner === userId || admins.admins.includes(userId);\n}\n\nasync function handleSearchOrders(ctx, searchQuery) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can search orders.');\n    return;\n  }\n  \n  if (!searchQuery) {\n    await ctx.reply(\n      'üîç *Advanced Order Search*\\n\\n' +\n      'Usage: /searchorder [query]\\n\\n' +\n      'üìù Examples:\\n' +\n      '‚Ä¢ /searchorder status:pending\\n' +\n      '‚Ä¢ /searchorder user:123456\\n' +\n      '‚Ä¢ /searchorder product:PROD-ABC\\n' +\n      '‚Ä¢ /searchorder date:2025-10-10\\n' +\n      '‚Ä¢ /searchorder completed\\n' +\n      '‚Ä¢ /searchorder ORD-123\\n\\n' +\n      'üè∑Ô∏è Available status:\\n' +\n      'pending, awaiting_verification, completed, rejected',\n      { parse_mode: 'Markdown' }\n    );\n    return;\n  }\n  \n  const transactions = await db.getTransactions();\n  \n  if (!transactions || transactions.length === 0) {\n    await ctx.reply('‚ùå No orders found in the system.');\n    return;\n  }\n  \n  let results = [...transactions];\n  \n  // Parse search query\n  const query = searchQuery.toLowerCase().trim();\n  \n  // Search by status\n  if (query.includes('status:')) {\n    const status = query.split('status:')[1].split(' ')[0];\n    results = results.filter(t => t.status === status);\n  }\n  // Search by user ID\n  else if (query.includes('user:')) {\n    const userId = query.split('user:')[1].split(' ')[0];\n    results = results.filter(t => t.userId == userId);\n  }\n  // Search by product ID\n  else if (query.includes('product:')) {\n    const productId = query.split('product:')[1].split(' ')[0];\n    results = results.filter(t => t.productId === productId);\n  }\n  // Search by date (YYYY-MM-DD)\n  else if (query.includes('date:')) {\n    const date = query.split('date:')[1].split(' ')[0];\n    results = results.filter(t => t.createdAt.includes(date));\n  }\n  // Search by order ID\n  else if (query.startsWith('ord-')) {\n    results = results.filter(t => t.id.toLowerCase() === query);\n  }\n  // Search by status name directly\n  else if (['pending', 'awaiting_verification', 'completed', 'rejected'].includes(query)) {\n    results = results.filter(t => t.status === query);\n  }\n  // General search in product name\n  else {\n    results = results.filter(t => {\n      const productName = (t.productName?.ms || t.productName || '').toLowerCase();\n      return productName.includes(query) || t.id.toLowerCase().includes(query);\n    });\n  }\n  \n  if (results.length === 0) {\n    await ctx.reply(`‚ùå No orders found for: \"${searchQuery}\"`);\n    return;\n  }\n  \n  // Sort by date (newest first)\n  results.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\n  \n  // Limit to 20 results\n  const displayResults = results.slice(0, 20);\n  \n  let message = `üîç *Search Results* (${results.length} found)\\n\\n`;\n  \n  displayResults.forEach((order, index) => {\n    const statusEmoji = {\n      'pending': '‚è≥',\n      'awaiting_verification': '‚è±Ô∏è',\n      'completed': '‚úÖ',\n      'rejected': '‚ùå'\n    }[order.status] || 'üì¶';\n    \n    message += `${index + 1}. ${statusEmoji} *${order.id}*\\n`;\n    message += `   üì¶ ${order.productName?.ms || order.productName || 'N/A'}\\n`;\n    message += `   üë§ User: ${order.userId}\\n`;\n    message += `   üí∞ RM${order.price}\\n`;\n    message += `   üìÖ ${new Date(order.createdAt).toLocaleDateString()}\\n`;\n    message += `   üìä Status: ${order.status}\\n\\n`;\n  });\n  \n  if (results.length > 20) {\n    message += `\\n... and ${results.length - 20} more results.\\n`;\n  }\n  \n  message += '\\nüí° Use /verify [order_id] or /reject [order_id]';\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function handleFilterOrders(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can filter orders.');\n    return;\n  }\n  \n  const buttons = [\n    [\n      Markup.button.callback('‚è≥ Pending', 'filter_pending'),\n      Markup.button.callback('‚è±Ô∏è Awaiting', 'filter_awaiting_verification')\n    ],\n    [\n      Markup.button.callback('‚úÖ Completed', 'filter_completed'),\n      Markup.button.callback('‚ùå Rejected', 'filter_rejected')\n    ],\n    [\n      Markup.button.callback('üìÖ Today', 'filter_today'),\n      Markup.button.callback('üìÖ This Week', 'filter_week')\n    ],\n    [Markup.button.callback('üîô Back', 'admin_panel')]\n  ];\n  \n  await ctx.reply(\n    'üîç *Filter Orders*\\n\\nSelect a filter option:',\n    {\n      parse_mode: 'Markdown',\n      ...Markup.inlineKeyboard(buttons)\n    }\n  );\n}\n\nasync function handleFilterCallback(ctx, filter) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('Unauthorized');\n    return;\n  }\n  \n  const transactions = await db.getTransactions();\n  let results = [...transactions];\n  let filterName = filter;\n  \n  // Apply filter\n  if (filter === 'pending' || filter === 'awaiting_verification' || filter === 'completed' || filter === 'rejected') {\n    results = results.filter(t => t.status === filter);\n  } else if (filter === 'today') {\n    const today = new Date().toISOString().split('T')[0];\n    results = results.filter(t => t.createdAt.includes(today));\n    filterName = 'Today';\n  } else if (filter === 'week') {\n    const weekAgo = new Date();\n    weekAgo.setDate(weekAgo.getDate() - 7);\n    results = results.filter(t => new Date(t.createdAt) >= weekAgo);\n    filterName = 'This Week';\n  }\n  \n  if (results.length === 0) {\n    await ctx.answerCbQuery(`No orders found for: ${filterName}`);\n    return;\n  }\n  \n  // Sort by date (newest first)\n  results.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\n  \n  const displayResults = results.slice(0, 15);\n  \n  let message = `üîç *Filter: ${filterName}* (${results.length} orders)\\n\\n`;\n  \n  displayResults.forEach((order, index) => {\n    const statusEmoji = {\n      'pending': '‚è≥',\n      'awaiting_verification': '‚è±Ô∏è',\n      'completed': '‚úÖ',\n      'rejected': '‚ùå'\n    }[order.status] || 'üì¶';\n    \n    message += `${index + 1}. ${statusEmoji} *${order.id}*\\n`;\n    message += `   üì¶ ${order.productName?.ms || order.productName || 'N/A'}\\n`;\n    message += `   üí∞ RM${order.price} | üë§ ${order.userId}\\n\\n`;\n  });\n  \n  if (results.length > 15) {\n    message += `... and ${results.length - 15} more\\n`;\n  }\n  \n  await ctx.editMessageText(message, { parse_mode: 'Markdown' });\n  await ctx.answerCbQuery();\n}\n\nmodule.exports = {\n  handleSearchOrders,\n  handleFilterOrders,\n  handleFilterCallback\n};\n","size_bytes":6724},"handlers/autoReply.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { generateId } = require('../utils/helpers');\n\nasync function isOwnerOrAdmin(userId) {\n  const admins = await db.getAdmins();\n  return admins.owner === userId || admins.admins.includes(userId);\n}\n\n// Auto-Reply Templates\nasync function handleAddTemplate(ctx, keyword, response) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can add templates.');\n    return;\n  }\n  \n  if (!keyword || !response) {\n    await ctx.reply(\n      'üìù *Add Quick Reply Template*\\n\\n' +\n      'Usage: /addtemplate [keyword] | [response]\\n\\n' +\n      'Example:\\n' +\n      '/addtemplate payment | Please scan the QR code and upload your payment proof using /send command\\n\\n' +\n      'Admins can use /qt [keyword] to send templates quickly!',\n      { parse_mode: 'Markdown' }\n    );\n    return;\n  }\n  \n  const templates = await db.read('templates.json') || [];\n  \n  const existingTemplate = templates.find(t => t.keyword.toLowerCase() === keyword.toLowerCase());\n  \n  if (existingTemplate) {\n    await ctx.reply(`‚ö†Ô∏è Template with keyword \"${keyword}\" already exists. Use /edittemplate to update it.`);\n    return;\n  }\n  \n  const newTemplate = {\n    id: generateId('TPL'),\n    keyword: keyword.toLowerCase(),\n    response: response,\n    createdBy: adminId,\n    createdAt: new Date().toISOString(),\n    usageCount: 0\n  };\n  \n  templates.push(newTemplate);\n  await db.write('templates.json', templates);\n  \n  await ctx.reply(\n    `‚úÖ *Template Added!*\\n\\n` +\n    `üîë Keyword: \\`${keyword}\\`\\n` +\n    `üìù Response:\\n${response}\\n\\n` +\n    `Use: /qt ${keyword}`,\n    { parse_mode: 'Markdown' }\n  );\n}\n\nasync function handleQuickTemplate(ctx, keyword) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can use quick templates.');\n    return;\n  }\n  \n  if (!keyword) {\n    const templates = await db.read('templates.json') || [];\n    \n    if (templates.length === 0) {\n      await ctx.reply('No templates found. Use /addtemplate to create one.');\n      return;\n    }\n    \n    let message = 'üìù *Available Templates:*\\n\\n';\n    templates.forEach((t, index) => {\n      message += `${index + 1}. \\`/qt ${t.keyword}\\`\\n   üìù ${t.response.substring(0, 50)}${t.response.length > 50 ? '...' : ''}\\n\\n`;\n    });\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    return;\n  }\n  \n  const templates = await db.read('templates.json') || [];\n  const template = templates.find(t => t.keyword.toLowerCase() === keyword.toLowerCase());\n  \n  if (!template) {\n    await ctx.reply(`‚ùå Template \"${keyword}\" not found. Use /qt to see available templates.`);\n    return;\n  }\n  \n  // Update usage count\n  template.usageCount = (template.usageCount || 0) + 1;\n  await db.write('templates.json', templates);\n  \n  // Send template response\n  await ctx.reply(template.response);\n}\n\nasync function handleListTemplates(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized.');\n    return;\n  }\n  \n  const templates = await db.read('templates.json') || [];\n  \n  if (templates.length === 0) {\n    await ctx.reply('No templates found. Use /addtemplate to create one.');\n    return;\n  }\n  \n  let message = 'üìù *Quick Reply Templates*\\n\\n';\n  \n  templates.forEach((t, index) => {\n    message += `${index + 1}. üîë \\`${t.keyword}\\`\\n`;\n    message += `   üìù ${t.response}\\n`;\n    message += `   üìä Used: ${t.usageCount || 0} times\\n\\n`;\n  });\n  \n  message += '\\nUse /qt [keyword] to send a template';\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\n// FAQ Bot\nasync function handleAddFAQ(ctx, question, answer) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized. Only admins can add FAQs.');\n    return;\n  }\n  \n  if (!question || !answer) {\n    await ctx.reply(\n      '‚ùì *Add FAQ*\\n\\n' +\n      'Usage: /addfaq [question] | [answer]\\n\\n' +\n      'Example:\\n' +\n      '/addfaq How to pay? | Scan the QR code and upload payment proof using /send\\n\\n' +\n      'Users will get auto-replies when they ask these questions!',\n      { parse_mode: 'Markdown' }\n    );\n    return;\n  }\n  \n  const faqs = await db.read('faqs.json') || [];\n  \n  const newFAQ = {\n    id: generateId('FAQ'),\n    question: question.toLowerCase(),\n    answer: answer,\n    keywords: question.toLowerCase().split(' ').filter(w => w.length > 2),\n    createdBy: adminId,\n    createdAt: new Date().toISOString(),\n    triggerCount: 0\n  };\n  \n  faqs.push(newFAQ);\n  await db.write('faqs.json', faqs);\n  \n  await ctx.reply(\n    `‚úÖ *FAQ Added!*\\n\\n` +\n    `‚ùì Question: ${question}\\n` +\n    `üí¨ Answer:\\n${answer}\\n\\n` +\n    `Users asking similar questions will get this auto-reply!`,\n    { parse_mode: 'Markdown' }\n  );\n}\n\nasync function handleFAQList(ctx) {\n  try {\n    const faqs = await db.read('faqs.json') || [];\n    const user = await db.getUser(ctx.from.id);\n    const lang = user?.language || 'ms';\n    \n    if (faqs.length === 0) {\n      await ctx.reply('No FAQs available yet. Contact admin for help.');\n      return;\n    }\n    \n    const MAX_LENGTH = 4000;\n    let messages = [];\n    let currentMessage = '‚ùì *Frequently Asked Questions*\\n\\n';\n    \n    for (let index = 0; index < faqs.length; index++) {\n      const faq = faqs[index];\n      let question = faq.question;\n      let answer = faq.answer;\n      \n      if (question && typeof question === 'object' && question !== null) {\n        question = question[lang] || question['ms'] || question['en'] || 'No question available';\n      }\n      \n      if (answer && typeof answer === 'object' && answer !== null) {\n        answer = answer[lang] || answer['ms'] || answer['en'] || 'No answer available';\n      }\n      \n      question = String(question || 'No question available');\n      answer = String(answer || 'No answer available');\n      \n      const faqEntry = `${index + 1}. *${question}*\\n   üí¨ ${answer}\\n\\n`;\n      \n      if ((currentMessage + faqEntry).length > MAX_LENGTH) {\n        messages.push(currentMessage);\n        currentMessage = faqEntry;\n      } else {\n        currentMessage += faqEntry;\n      }\n    }\n    \n    if (currentMessage.length > 0) {\n      messages.push(currentMessage);\n    }\n    \n    for (const msg of messages) {\n      await ctx.reply(msg, { parse_mode: 'Markdown' });\n    }\n  } catch (error) {\n    console.error('Error in handleFAQList:', error);\n    await ctx.reply('‚ùå Error loading FAQs. Please try again later or contact admin.');\n  }\n}\n\nasync function checkFAQResponse(message, userId) {\n  const faqs = await db.read('faqs.json') || [];\n  \n  if (faqs.length === 0) {\n    return null;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const messageLower = message.toLowerCase();\n  const messageWords = messageLower.split(' ').filter(w => w.length > 2);\n  \n  // Find matching FAQ\n  for (const faq of faqs) {\n    let question = faq.question;\n    let answer = faq.answer;\n    \n    if (question && typeof question === 'object' && question !== null) {\n      question = question[lang] || question['ms'] || question['en'] || '';\n    }\n    \n    if (answer && typeof answer === 'object' && answer !== null) {\n      answer = answer[lang] || answer['ms'] || answer['en'] || '';\n    }\n    \n    question = String(question || '');\n    answer = String(answer || '');\n    \n    // Check if question matches exactly or partially\n    if (messageLower.includes(question.toLowerCase())) {\n      faq.triggerCount = (faq.triggerCount || 0) + 1;\n      await db.write('faqs.json', faqs);\n      return answer;\n    }\n    \n    // Check keyword matching (at least 50% keywords match)\n    if (faq.keywords && Array.isArray(faq.keywords)) {\n      const matchingKeywords = faq.keywords.filter(k => messageWords.includes(k));\n      if (matchingKeywords.length >= Math.ceil(faq.keywords.length * 0.5)) {\n        faq.triggerCount = (faq.triggerCount || 0) + 1;\n        await db.write('faqs.json', faqs);\n        return answer;\n      }\n    }\n  }\n  \n  return null;\n}\n\nasync function handleDeleteTemplate(ctx, keyword) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized.');\n    return;\n  }\n  \n  if (!keyword) {\n    await ctx.reply('Usage: /deletetemplate [keyword]');\n    return;\n  }\n  \n  const templates = await db.read('templates.json') || [];\n  const updatedTemplates = templates.filter(t => t.keyword.toLowerCase() !== keyword.toLowerCase());\n  \n  if (templates.length === updatedTemplates.length) {\n    await ctx.reply(`‚ùå Template \"${keyword}\" not found.`);\n    return;\n  }\n  \n  await db.write('templates.json', updatedTemplates);\n  await ctx.reply(`‚úÖ Template \"${keyword}\" deleted.`);\n}\n\nasync function handleDeleteFAQ(ctx, faqId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized.');\n    return;\n  }\n  \n  if (!faqId) {\n    await ctx.reply('Usage: /deletefaq [faq_id]\\n\\nUse /listfaqs to see all FAQ IDs.');\n    return;\n  }\n  \n  const faqs = await db.read('faqs.json') || [];\n  const updatedFAQs = faqs.filter(f => f.id !== faqId);\n  \n  if (faqs.length === updatedFAQs.length) {\n    await ctx.reply(`‚ùå FAQ \"${faqId}\" not found.`);\n    return;\n  }\n  \n  await db.write('faqs.json', updatedFAQs);\n  await ctx.reply(`‚úÖ FAQ deleted.`);\n}\n\nasync function handleListFAQs(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized.');\n    return;\n  }\n  \n  const faqs = await db.read('faqs.json') || [];\n  \n  if (faqs.length === 0) {\n    await ctx.reply('No FAQs found. Use /addfaq to create one.');\n    return;\n  }\n  \n  let message = '‚ùì *All FAQs*\\n\\n';\n  \n  faqs.forEach((faq, index) => {\n    message += `${index + 1}. üÜî \\`${faq.id}\\`\\n`;\n    \n    if (typeof faq.question === 'object') {\n      message += `   ‚ùì MS: ${faq.question.ms || 'N/A'}\\n`;\n      message += `   ‚ùì EN: ${faq.question.en || 'N/A'}\\n`;\n    } else {\n      message += `   ‚ùì ${faq.question}\\n`;\n    }\n    \n    if (typeof faq.answer === 'object') {\n      const answerMs = faq.answer.ms || 'N/A';\n      const answerEn = faq.answer.en || 'N/A';\n      message += `   üí¨ MS: ${answerMs.substring(0, 50)}${answerMs.length > 50 ? '...' : ''}\\n`;\n      message += `   üí¨ EN: ${answerEn.substring(0, 50)}${answerEn.length > 50 ? '...' : ''}\\n`;\n    } else {\n      message += `   üí¨ ${faq.answer}\\n`;\n    }\n    \n    message += `   üìä Triggered: ${faq.triggerCount || 0} times\\n\\n`;\n  });\n  \n  message += '\\nUse /deletefaq [id] to remove an FAQ';\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nmodule.exports = {\n  handleAddTemplate,\n  handleQuickTemplate,\n  handleListTemplates,\n  handleDeleteTemplate,\n  handleAddFAQ,\n  handleFAQList,\n  handleListFAQs,\n  handleDeleteFAQ,\n  checkFAQResponse\n};\n","size_bytes":11010},"handlers/ping.js":{"content":"const db = require('../utils/database');\nconst os = require('os');\nconst { execSync } = require('child_process');\nconst fs = require('fs');\n\nasync function handlePing(ctx) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  try {\n    const startTime = Date.now();\n    const now = new Date();\n    const uptime = process.uptime();\n    const hours = Math.floor(uptime / 3600);\n    const minutes = Math.floor((uptime % 3600) / 60);\n    const seconds = Math.floor(uptime % 60);\n\n    const systemUptime = os.uptime();\n    const sysHours = Math.floor(systemUptime / 3600);\n    const sysMinutes = Math.floor((systemUptime % 3600) / 60);\n    const sysDays = Math.floor(sysHours / 24);\n\n    const totalMemory = (os.totalmem() / 1024 / 1024 / 1024).toFixed(2);\n    const freeMemory = (os.freemem() / 1024 / 1024 / 1024).toFixed(2);\n    const usedMemory = (totalMemory - freeMemory).toFixed(2);\n    const memoryUsagePercent = ((usedMemory / totalMemory) * 100).toFixed(1);\n\n    const cpus = os.cpus();\n    const cpuCount = cpus.length;\n    const cpuModel = cpus[0]?.model || 'Unknown';\n    const cpuSpeed = cpus[0]?.speed || 0;\n    const cpuArch = os.arch();\n    \n    const platform = os.platform();\n    const osType = os.type();\n    const osRelease = os.release();\n    const hostname = os.hostname();\n    const nodeVersion = process.version;\n    const v8Version = process.versions.v8;\n    const opensslVersion = process.versions.openssl;\n    const zlibVersion = process.versions.zlib;\n    \n    const processMemory = process.memoryUsage();\n    const heapUsed = (processMemory.heapUsed / 1024 / 1024).toFixed(2);\n    const heapTotal = (processMemory.heapTotal / 1024 / 1024).toFixed(2);\n    const rss = (processMemory.rss / 1024 / 1024).toFixed(2);\n    const external = (processMemory.external / 1024 / 1024).toFixed(2);\n    const arrayBuffers = processMemory.arrayBuffers ? (processMemory.arrayBuffers / 1024 / 1024).toFixed(2) : 'N/A';\n\n    const networkInterfaces = os.networkInterfaces();\n    const networkCount = Object.keys(networkInterfaces).length;\n    \n    let primaryIP = 'N/A';\n    let ipv6Address = 'N/A';\n    for (const [name, nets] of Object.entries(networkInterfaces)) {\n      for (const net of nets) {\n        if (net.family === 'IPv4' && !net.internal && primaryIP === 'N/A') {\n          primaryIP = net.address;\n        }\n        if (net.family === 'IPv6' && !net.internal && ipv6Address === 'N/A') {\n          ipv6Address = net.address;\n        }\n      }\n    }\n\n    let gpuInfo = 'N/A';\n    try {\n      const lspci = execSync('lspci | grep -i vga', { encoding: 'utf8', timeout: 1000 });\n      gpuInfo = lspci.trim().split('\\n')[0]?.split(': ')[1] || 'N/A';\n    } catch (e) {\n      gpuInfo = 'Not detected';\n    }\n\n    let diskTotal = 'N/A';\n    let diskUsed = 'N/A';\n    let diskFree = 'N/A';\n    let diskPercent = 'N/A';\n    let inodeUsed = 'N/A';\n    let inodeTotal = 'N/A';\n    try {\n      const df = execSync('df -h / | tail -1', { encoding: 'utf8', timeout: 1000 });\n      const parts = df.trim().split(/\\s+/);\n      diskTotal = parts[1];\n      diskUsed = parts[2];\n      diskFree = parts[3];\n      diskPercent = parts[4];\n      \n      const dfInodes = execSync('df -i / | tail -1', { encoding: 'utf8', timeout: 1000 });\n      const inodeParts = dfInodes.trim().split(/\\s+/);\n      inodeTotal = inodeParts[1];\n      inodeUsed = inodeParts[2];\n    } catch (e) {}\n\n    const loadAvg = os.loadavg();\n    const load1 = loadAvg[0].toFixed(2);\n    const load5 = loadAvg[1].toFixed(2);\n    const load15 = loadAvg[2].toFixed(2);\n\n    const homedir = os.homedir();\n    const tmpdir = os.tmpdir();\n    const endianness = os.endianness();\n    const pid = process.pid;\n    const ppid = process.ppid;\n\n    const users = await db.getUsers();\n    const products = await db.getProducts();\n    const categories = await db.getCategories();\n    const transactions = await db.getTransactions();\n    const sessions = await db.getSessions();\n    const admins = await db.getAdmins();\n    const settings = await db.getSettings();\n    const templates = await db.read('templates.json') || [];\n    const faqs = await db.read('faqs.json') || [];\n    const feedbacks = await db.read('feedbacks.json') || [];\n    const inventory = await db.read('inventory.json') || [];\n\n    let cpuTempInfo = 'N/A';\n    try {\n      const temp = execSync('cat /sys/class/thermal/thermal_zone*/temp 2>/dev/null | head -1', { encoding: 'utf8', timeout: 1000 });\n      const tempVal = parseInt(temp.trim()) / 1000;\n      cpuTempInfo = `${tempVal.toFixed(1)}¬∞C`;\n    } catch (e) {\n      cpuTempInfo = 'Not available';\n    }\n\n    const activeProducts = products.filter(p => p.active);\n    const pendingOrders = transactions.filter(t => t.status === 'pending');\n    const completedOrders = transactions.filter(t => t.status === 'completed');\n    const activeSessions = sessions.filter(s => s.status === 'active');\n    const bannedUsers = users.filter(u => u.banned);\n    const totalRevenue = completedOrders.reduce((sum, t) => sum + (t.price || 0), 0);\n\n    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n    const todayOrders = transactions.filter(t => new Date(t.createdAt) >= todayStart);\n    const todayRevenue = todayOrders.filter(t => t.status === 'completed').reduce((sum, t) => sum + (t.price || 0), 0);\n\n    const avgCpuSpeed = cpus.reduce((sum, cpu) => sum + cpu.speed, 0) / cpuCount;\n    \n    let fileDescriptors = 'N/A';\n    try {\n      const fdCount = execSync(`ls -la /proc/${pid}/fd | wc -l`, { encoding: 'utf8', timeout: 1000 });\n      fileDescriptors = parseInt(fdCount.trim()) - 3;\n    } catch (e) {}\n\n    let threadCount = 'N/A';\n    try {\n      const threads = execSync(`ls /proc/${pid}/task | wc -l`, { encoding: 'utf8', timeout: 1000 });\n      threadCount = threads.trim();\n    } catch (e) {}\n\n    const totalUsers = users.length;\n    const totalProducts = products.length;\n    const totalOrders = transactions.length;\n    const totalCategories = categories.length;\n\n    const avgRating = feedbacks.length > 0 \n      ? (feedbacks.reduce((sum, f) => sum + f.rating, 0) / feedbacks.length).toFixed(2)\n      : '0';\n\n    const totalStock = products.reduce((sum, p) => sum + (p.stock || 0), 0);\n    const lowStockProducts = products.filter(p => p.stock <= 5).length;\n\n    const responseTime = Date.now() - startTime;\n\n    const text = lang === 'ms' \n      ? `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë  üèì PING - SISTEM RUNTIME   ‚ïë\n‚ïë    üìä 100 MAKLUMAT LENGKAP    ‚ïë\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ  üñ•Ô∏è  SISTEM OPERASI & HOST  ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 1Ô∏è‚É£  Jenis OS: ${osType}\n 2Ô∏è‚É£  Platform: ${platform}\n 3Ô∏è‚É£  Versi Kernel: ${osRelease}\n 4Ô∏è‚É£  Hostname: ${hostname}\n 5Ô∏è‚É£  Endianness: ${endianness}\n 6Ô∏è‚É£  Architecture: ${cpuArch}\n 7Ô∏è‚É£  Uptime Sistem: ${sysDays}d ${sysHours % 24}h ${sysMinutes}m\n 8Ô∏è‚É£  Home Dir: ${homedir}\n 9Ô∏è‚É£  Temp Dir: ${tmpdir}\n üîü User: ${process.env.USER || os.userInfo().username}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ     ‚ö° PROSESSOR (CPU)       ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 1Ô∏è‚É£1Ô∏è‚É£ Model: ${cpuModel}\n 1Ô∏è‚É£2Ô∏è‚É£ Cores/Threads: ${cpuCount}\n 1Ô∏è‚É£3Ô∏è‚É£ Speed Core-1: ${cpuSpeed} MHz\n 1Ô∏è‚É£4Ô∏è‚É£ Purata Speed: ${avgCpuSpeed.toFixed(0)} MHz\n 1Ô∏è‚É£5Ô∏è‚É£ Load 1min: ${load1}\n 1Ô∏è‚É£6Ô∏è‚É£ Load 5min: ${load5}\n 1Ô∏è‚É£7Ô∏è‚É£ Load 15min: ${load15}\n 1Ô∏è‚É£8Ô∏è‚É£ Temperature: ${cpuTempInfo}\n 1Ô∏è‚É£9Ô∏è‚É£ CPU Core-1: ${cpus[0]?.model.substring(0, 20)}\n 2Ô∏è‚É£0Ô∏è‚É£ CPU Core-2: ${cpus[1]?.model.substring(0, 20) || 'N/A'}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ      üéÆ GRAFIK (GPU)         ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 2Ô∏è‚É£1Ô∏è‚É£ GPU Info: ${gpuInfo}\n 2Ô∏è‚É£2Ô∏è‚É£ Graphics: ${gpuInfo === 'Not detected' ? 'Integrated/Virtual' : 'Dedicated'}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ      üíæ MEMORI (RAM)         ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 2Ô∏è‚É£3Ô∏è‚É£ Total RAM: ${totalMemory} GB\n 2Ô∏è‚É£4Ô∏è‚É£ RAM Digunakan: ${usedMemory} GB\n 2Ô∏è‚É£5Ô∏è‚É£ RAM Bebas: ${freeMemory} GB\n 2Ô∏è‚É£6Ô∏è‚É£ Penggunaan: ${memoryUsagePercent}%\n 2Ô∏è‚É£7Ô∏è‚É£ Heap Used: ${heapUsed} MB\n 2Ô∏è‚É£8Ô∏è‚É£ Heap Total: ${heapTotal} MB\n 2Ô∏è‚É£9Ô∏è‚É£ RSS Memory: ${rss} MB\n 3Ô∏è‚É£0Ô∏è‚É£ External: ${external} MB\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ    üíΩ STORAGE (DISK)         ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 3Ô∏è‚É£1Ô∏è‚É£ Total Disk: ${diskTotal}\n 3Ô∏è‚É£2Ô∏è‚É£ Digunakan: ${diskUsed}\n 3Ô∏è‚É£3Ô∏è‚É£ Tersedia: ${diskFree}\n 3Ô∏è‚É£4Ô∏è‚É£ Penggunaan: ${diskPercent}\n 3Ô∏è‚É£5Ô∏è‚É£ Total Inodes: ${inodeTotal}\n 3Ô∏è‚É£6Ô∏è‚É£ Inodes Used: ${inodeUsed}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ     üåê NETWORK & IP          ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 3Ô∏è‚É£7Ô∏è‚É£ Interfaces: ${networkCount}\n 3Ô∏è‚É£8Ô∏è‚É£ IPv4 Address: ${primaryIP}\n 3Ô∏è‚É£9Ô∏è‚É£ IPv6 Address: ${ipv6Address}\n 4Ô∏è‚É£0Ô∏è‚É£ Hostname: ${hostname}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ   üîß NODE.JS & RUNTIME       ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 4Ô∏è‚É£1Ô∏è‚É£ Node Version: ${nodeVersion}\n 4Ô∏è‚É£2Ô∏è‚É£ V8 Engine: ${v8Version}\n 4Ô∏è‚É£3Ô∏è‚É£ OpenSSL: ${opensslVersion}\n 4Ô∏è‚É£4Ô∏è‚É£ Zlib: ${zlibVersion}\n 4Ô∏è‚É£5Ô∏è‚É£ Process ID: ${pid}\n 4Ô∏è‚É£6Ô∏è‚É£ Parent PID: ${ppid}\n 4Ô∏è‚É£7Ô∏è‚É£ Uptime: ${hours}h ${minutes}m ${seconds}s\n 4Ô∏è‚É£8Ô∏è‚É£ Process Title: ${process.title.substring(0, 25)}\n 4Ô∏è‚É£9Ô∏è‚É£ Platform: ${process.platform}\n 5Ô∏è‚É£0Ô∏è‚É£ Array Buffers: ${arrayBuffers} MB\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ  üìä STATISTIK PENGGUNA       ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 5Ô∏è‚É£1Ô∏è‚É£ Total Users: ${totalUsers}\n 5Ô∏è‚É£2Ô∏è‚É£ Active Users: ${totalUsers - bannedUsers.length}\n 5Ô∏è‚É£3Ô∏è‚É£ Banned Users: ${bannedUsers.length}\n 5Ô∏è‚É£4Ô∏è‚É£ Total Admins: ${admins.adminIds?.length || 0}\n 5Ô∏è‚É£5Ô∏è‚É£ Owner Set: ${admins.ownerId ? 'Yes' : 'No'}\n 5Ô∏è‚É£6Ô∏è‚É£ VIP Users: ${users.filter(u => u.tags?.includes('vip')).length}\n 5Ô∏è‚É£7Ô∏è‚É£ Regular Users: ${users.filter(u => u.tags?.includes('regular')).length}\n 5Ô∏è‚É£8Ô∏è‚É£ New Today: ${users.filter(u => new Date(u.createdAt) >= todayStart).length}\n 5Ô∏è‚É£9Ô∏è‚É£ Total Points: ${users.reduce((sum, u) => sum + (u.points || 0), 0)}\n 6Ô∏è‚É£0Ô∏è‚É£ Avg Points/User: ${(users.reduce((sum, u) => sum + (u.points || 0), 0) / totalUsers).toFixed(0)}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ   üì¶ STATISTIK PRODUK        ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 6Ô∏è‚É£1Ô∏è‚É£ Total Products: ${totalProducts}\n 6Ô∏è‚É£2Ô∏è‚É£ Active Products: ${activeProducts.length}\n 6Ô∏è‚É£3Ô∏è‚É£ Inactive: ${totalProducts - activeProducts.length}\n 6Ô∏è‚É£4Ô∏è‚É£ Categories: ${totalCategories}\n 6Ô∏è‚É£5Ô∏è‚É£ Total Stock: ${totalStock}\n 6Ô∏è‚É£6Ô∏è‚É£ Low Stock (<5): ${lowStockProducts}\n 6Ô∏è‚É£7Ô∏è‚É£ Auto Delivery: ${products.filter(p => p.deliveryType === 'auto').length}\n 6Ô∏è‚É£8Ô∏è‚É£ Manual Delivery: ${products.filter(p => p.deliveryType === 'manual').length}\n 6Ô∏è‚É£9Ô∏è‚É£ Total Items: ${products.reduce((sum, p) => sum + (p.items?.length || 0), 0)}\n 7Ô∏è‚É£0Ô∏è‚É£ Avg Price: ${settings.currency}${(products.reduce((sum, p) => sum + p.price, 0) / totalProducts).toFixed(2)}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ   üí∞ STATISTIK PESANAN       ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 7Ô∏è‚É£1Ô∏è‚É£ Total Orders: ${totalOrders}\n 7Ô∏è‚É£2Ô∏è‚É£ Pending: ${pendingOrders.length}\n 7Ô∏è‚É£3Ô∏è‚É£ Awaiting Verify: ${transactions.filter(t => t.status === 'awaiting_verification').length}\n 7Ô∏è‚É£4Ô∏è‚É£ Completed: ${completedOrders.length}\n 7Ô∏è‚É£5Ô∏è‚É£ Rejected: ${transactions.filter(t => t.status === 'rejected').length}\n 7Ô∏è‚É£6Ô∏è‚É£ Today Orders: ${todayOrders.length}\n 7Ô∏è‚É£7Ô∏è‚É£ Total Revenue: ${settings.currency}${totalRevenue.toFixed(2)}\n 7Ô∏è‚É£8Ô∏è‚É£ Today Revenue: ${settings.currency}${todayRevenue.toFixed(2)}\n 7Ô∏è‚É£9Ô∏è‚É£ Avg Order: ${settings.currency}${completedOrders.length ? (totalRevenue / completedOrders.length).toFixed(2) : '0.00'}\n 8Ô∏è‚É£0Ô∏è‚É£ Success Rate: ${totalOrders ? ((completedOrders.length / totalOrders) * 100).toFixed(1) : '0'}%\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ  üí¨ SUPPORT & SESSIONS       ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 8Ô∏è‚É£1Ô∏è‚É£ Total Sessions: ${sessions.length}\n 8Ô∏è‚É£2Ô∏è‚É£ Active Now: ${activeSessions.length}\n 8Ô∏è‚É£3Ô∏è‚É£ Expired: ${sessions.filter(s => s.status === 'expired').length}\n 8Ô∏è‚É£4Ô∏è‚É£ Ended: ${sessions.filter(s => s.status === 'ended').length}\n 8Ô∏è‚É£5Ô∏è‚É£ Templates: ${templates.length}\n 8Ô∏è‚É£6Ô∏è‚É£ FAQs: ${faqs.length}\n 8Ô∏è‚É£7Ô∏è‚É£ Feedbacks: ${feedbacks.length}\n 8Ô∏è‚É£8Ô∏è‚É£ Avg Rating: ${avgRating} ‚≠ê\n 8Ô∏è‚É£9Ô∏è‚É£ 5-Star Reviews: ${feedbacks.filter(f => f.rating === 5).length}\n 9Ô∏è‚É£0Ô∏è‚É£ Inventory Logs: ${inventory.length}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ  ‚öôÔ∏è SISTEM & ENVIRONMENT     ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 9Ô∏è‚É£1Ô∏è‚É£ Node ENV: ${process.env.NODE_ENV || 'production'}\n 9Ô∏è‚É£2Ô∏è‚É£ PWD: ${process.env.PWD?.substring(0, 30) || 'N/A'}\n 9Ô∏è‚É£3Ô∏è‚É£ Shell: ${process.env.SHELL || 'N/A'}\n 9Ô∏è‚É£4Ô∏è‚É£ PATH Items: ${(process.env.PATH || '').split(':').length}\n 9Ô∏è‚É£5Ô∏è‚É£ File Descriptors: ${fileDescriptors}\n 9Ô∏è‚É£6Ô∏è‚É£ Thread Count: ${threadCount}\n 9Ô∏è‚É£7Ô∏è‚É£ Currency: ${settings.currency || 'RM'}\n 9Ô∏è‚É£8Ô∏è‚É£ Default Lang: ${settings.defaultLanguage || 'ms'}\n 9Ô∏è‚É£9Ô∏è‚É£ Maintenance: ${settings.maintenanceMode ? 'üî¥ ON' : 'üü¢ OFF'}\n üíØ Store: ${settings.storeName}\n\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë   ‚úÖ SISTEM OK | ‚ö°${responseTime}ms   ‚ïë\n‚ïë   üìÖ ${now.toLocaleDateString('ms-MY')}        ‚ïë\n‚ïë   üïê ${now.toLocaleTimeString('ms-MY')}           ‚ïë\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`\n      : `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë  üèì PING - SYSTEM RUNTIME   ‚ïë\n‚ïë   üìä 100 COMPLETE INFO      ‚ïë\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ  üñ•Ô∏è  OPERATING SYSTEM       ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 1Ô∏è‚É£  OS Type: ${osType}\n 2Ô∏è‚É£  Platform: ${platform}\n 3Ô∏è‚É£  Kernel Ver: ${osRelease}\n 4Ô∏è‚É£  Hostname: ${hostname}\n 5Ô∏è‚É£  Endianness: ${endianness}\n 6Ô∏è‚É£  Architecture: ${cpuArch}\n 7Ô∏è‚É£  System Uptime: ${sysDays}d ${sysHours % 24}h ${sysMinutes}m\n 8Ô∏è‚É£  Home Dir: ${homedir}\n 9Ô∏è‚É£  Temp Dir: ${tmpdir}\n üîü User: ${process.env.USER || os.userInfo().username}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ     ‚ö° PROCESSOR (CPU)       ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 1Ô∏è‚É£1Ô∏è‚É£ Model: ${cpuModel}\n 1Ô∏è‚É£2Ô∏è‚É£ Cores/Threads: ${cpuCount}\n 1Ô∏è‚É£3Ô∏è‚É£ Speed Core-1: ${cpuSpeed} MHz\n 1Ô∏è‚É£4Ô∏è‚É£ Avg Speed: ${avgCpuSpeed.toFixed(0)} MHz\n 1Ô∏è‚É£5Ô∏è‚É£ Load 1min: ${load1}\n 1Ô∏è‚É£6Ô∏è‚É£ Load 5min: ${load5}\n 1Ô∏è‚É£7Ô∏è‚É£ Load 15min: ${load15}\n 1Ô∏è‚É£8Ô∏è‚É£ Temperature: ${cpuTempInfo}\n 1Ô∏è‚É£9Ô∏è‚É£ CPU Core-1: ${cpus[0]?.model.substring(0, 20)}\n 2Ô∏è‚É£0Ô∏è‚É£ CPU Core-2: ${cpus[1]?.model.substring(0, 20) || 'N/A'}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ      üéÆ GRAPHICS (GPU)       ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 2Ô∏è‚É£1Ô∏è‚É£ GPU Info: ${gpuInfo}\n 2Ô∏è‚É£2Ô∏è‚É£ Graphics: ${gpuInfo === 'Not detected' ? 'Integrated/Virtual' : 'Dedicated'}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ      üíæ MEMORY (RAM)         ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 2Ô∏è‚É£3Ô∏è‚É£ Total RAM: ${totalMemory} GB\n 2Ô∏è‚É£4Ô∏è‚É£ RAM Used: ${usedMemory} GB\n 2Ô∏è‚É£5Ô∏è‚É£ RAM Free: ${freeMemory} GB\n 2Ô∏è‚É£6Ô∏è‚É£ Usage: ${memoryUsagePercent}%\n 2Ô∏è‚É£7Ô∏è‚É£ Heap Used: ${heapUsed} MB\n 2Ô∏è‚É£8Ô∏è‚É£ Heap Total: ${heapTotal} MB\n 2Ô∏è‚É£9Ô∏è‚É£ RSS Memory: ${rss} MB\n 3Ô∏è‚É£0Ô∏è‚É£ External: ${external} MB\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ    üíΩ STORAGE (DISK)         ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 3Ô∏è‚É£1Ô∏è‚É£ Total Disk: ${diskTotal}\n 3Ô∏è‚É£2Ô∏è‚É£ Used: ${diskUsed}\n 3Ô∏è‚É£3Ô∏è‚É£ Available: ${diskFree}\n 3Ô∏è‚É£4Ô∏è‚É£ Usage: ${diskPercent}\n 3Ô∏è‚É£5Ô∏è‚É£ Total Inodes: ${inodeTotal}\n 3Ô∏è‚É£6Ô∏è‚É£ Inodes Used: ${inodeUsed}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ     üåê NETWORK & IP          ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 3Ô∏è‚É£7Ô∏è‚É£ Interfaces: ${networkCount}\n 3Ô∏è‚É£8Ô∏è‚É£ IPv4 Address: ${primaryIP}\n 3Ô∏è‚É£9Ô∏è‚É£ IPv6 Address: ${ipv6Address}\n 4Ô∏è‚É£0Ô∏è‚É£ Hostname: ${hostname}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ   üîß NODE.JS & RUNTIME       ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 4Ô∏è‚É£1Ô∏è‚É£ Node Version: ${nodeVersion}\n 4Ô∏è‚É£2Ô∏è‚É£ V8 Engine: ${v8Version}\n 4Ô∏è‚É£3Ô∏è‚É£ OpenSSL: ${opensslVersion}\n 4Ô∏è‚É£4Ô∏è‚É£ Zlib: ${zlibVersion}\n 4Ô∏è‚É£5Ô∏è‚É£ Process ID: ${pid}\n 4Ô∏è‚É£6Ô∏è‚É£ Parent PID: ${ppid}\n 4Ô∏è‚É£7Ô∏è‚É£ Uptime: ${hours}h ${minutes}m ${seconds}s\n 4Ô∏è‚É£8Ô∏è‚É£ Process Title: ${process.title.substring(0, 25)}\n 4Ô∏è‚É£9Ô∏è‚É£ Platform: ${process.platform}\n 5Ô∏è‚É£0Ô∏è‚É£ Array Buffers: ${arrayBuffers} MB\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ  üìä USER STATISTICS          ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 5Ô∏è‚É£1Ô∏è‚É£ Total Users: ${totalUsers}\n 5Ô∏è‚É£2Ô∏è‚É£ Active Users: ${totalUsers - bannedUsers.length}\n 5Ô∏è‚É£3Ô∏è‚É£ Banned Users: ${bannedUsers.length}\n 5Ô∏è‚É£4Ô∏è‚É£ Total Admins: ${admins.adminIds?.length || 0}\n 5Ô∏è‚É£5Ô∏è‚É£ Owner Set: ${admins.ownerId ? 'Yes' : 'No'}\n 5Ô∏è‚É£6Ô∏è‚É£ VIP Users: ${users.filter(u => u.tags?.includes('vip')).length}\n 5Ô∏è‚É£7Ô∏è‚É£ Regular Users: ${users.filter(u => u.tags?.includes('regular')).length}\n 5Ô∏è‚É£8Ô∏è‚É£ New Today: ${users.filter(u => new Date(u.createdAt) >= todayStart).length}\n 5Ô∏è‚É£9Ô∏è‚É£ Total Points: ${users.reduce((sum, u) => sum + (u.points || 0), 0)}\n 6Ô∏è‚É£0Ô∏è‚É£ Avg Points/User: ${(users.reduce((sum, u) => sum + (u.points || 0), 0) / totalUsers).toFixed(0)}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ   üì¶ PRODUCT STATISTICS      ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 6Ô∏è‚É£1Ô∏è‚É£ Total Products: ${totalProducts}\n 6Ô∏è‚É£2Ô∏è‚É£ Active Products: ${activeProducts.length}\n 6Ô∏è‚É£3Ô∏è‚É£ Inactive: ${totalProducts - activeProducts.length}\n 6Ô∏è‚É£4Ô∏è‚É£ Categories: ${totalCategories}\n 6Ô∏è‚É£5Ô∏è‚É£ Total Stock: ${totalStock}\n 6Ô∏è‚É£6Ô∏è‚É£ Low Stock (<5): ${lowStockProducts}\n 6Ô∏è‚É£7Ô∏è‚É£ Auto Delivery: ${products.filter(p => p.deliveryType === 'auto').length}\n 6Ô∏è‚É£8Ô∏è‚É£ Manual Delivery: ${products.filter(p => p.deliveryType === 'manual').length}\n 6Ô∏è‚É£9Ô∏è‚É£ Total Items: ${products.reduce((sum, p) => sum + (p.items?.length || 0), 0)}\n 7Ô∏è‚É£0Ô∏è‚É£ Avg Price: ${settings.currency}${(products.reduce((sum, p) => sum + p.price, 0) / totalProducts).toFixed(2)}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ   üí∞ ORDER STATISTICS        ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 7Ô∏è‚É£1Ô∏è‚É£ Total Orders: ${totalOrders}\n 7Ô∏è‚É£2Ô∏è‚É£ Pending: ${pendingOrders.length}\n 7Ô∏è‚É£3Ô∏è‚É£ Awaiting Verify: ${transactions.filter(t => t.status === 'awaiting_verification').length}\n 7Ô∏è‚É£4Ô∏è‚É£ Completed: ${completedOrders.length}\n 7Ô∏è‚É£5Ô∏è‚É£ Rejected: ${transactions.filter(t => t.status === 'rejected').length}\n 7Ô∏è‚É£6Ô∏è‚É£ Today Orders: ${todayOrders.length}\n 7Ô∏è‚É£7Ô∏è‚É£ Total Revenue: ${settings.currency}${totalRevenue.toFixed(2)}\n 7Ô∏è‚É£8Ô∏è‚É£ Today Revenue: ${settings.currency}${todayRevenue.toFixed(2)}\n 7Ô∏è‚É£9Ô∏è‚É£ Avg Order: ${settings.currency}${completedOrders.length ? (totalRevenue / completedOrders.length).toFixed(2) : '0.00'}\n 8Ô∏è‚É£0Ô∏è‚É£ Success Rate: ${totalOrders ? ((completedOrders.length / totalOrders) * 100).toFixed(1) : '0'}%\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ  üí¨ SUPPORT & SESSIONS       ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 8Ô∏è‚É£1Ô∏è‚É£ Total Sessions: ${sessions.length}\n 8Ô∏è‚É£2Ô∏è‚É£ Active Now: ${activeSessions.length}\n 8Ô∏è‚É£3Ô∏è‚É£ Expired: ${sessions.filter(s => s.status === 'expired').length}\n 8Ô∏è‚É£4Ô∏è‚É£ Ended: ${sessions.filter(s => s.status === 'ended').length}\n 8Ô∏è‚É£5Ô∏è‚É£ Templates: ${templates.length}\n 8Ô∏è‚É£6Ô∏è‚É£ FAQs: ${faqs.length}\n 8Ô∏è‚É£7Ô∏è‚É£ Feedbacks: ${feedbacks.length}\n 8Ô∏è‚É£8Ô∏è‚É£ Avg Rating: ${avgRating} ‚≠ê\n 8Ô∏è‚É£9Ô∏è‚É£ 5-Star Reviews: ${feedbacks.filter(f => f.rating === 5).length}\n 9Ô∏è‚É£0Ô∏è‚É£ Inventory Logs: ${inventory.length}\n\n‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n‚îÉ  ‚öôÔ∏è SYSTEM & ENVIRONMENT     ‚îÉ\n‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n 9Ô∏è‚É£1Ô∏è‚É£ Node ENV: ${process.env.NODE_ENV || 'production'}\n 9Ô∏è‚É£2Ô∏è‚É£ PWD: ${process.env.PWD?.substring(0, 30) || 'N/A'}\n 9Ô∏è‚É£3Ô∏è‚É£ Shell: ${process.env.SHELL || 'N/A'}\n 9Ô∏è‚É£4Ô∏è‚É£ PATH Items: ${(process.env.PATH || '').split(':').length}\n 9Ô∏è‚É£5Ô∏è‚É£ File Descriptors: ${fileDescriptors}\n 9Ô∏è‚É£6Ô∏è‚É£ Thread Count: ${threadCount}\n 9Ô∏è‚É£7Ô∏è‚É£ Currency: ${settings.currency || 'RM'}\n 9Ô∏è‚É£8Ô∏è‚É£ Default Lang: ${settings.defaultLanguage || 'ms'}\n 9Ô∏è‚É£9Ô∏è‚É£ Maintenance: ${settings.maintenanceMode ? 'üî¥ ON' : 'üü¢ OFF'}\n üíØ Store: ${settings.storeName}\n\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë   ‚úÖ SYSTEM OK | ‚ö°${responseTime}ms  ‚ïë\n‚ïë   üìÖ ${now.toLocaleDateString('en-US')}      ‚ïë\n‚ïë   üïê ${now.toLocaleTimeString('en-US')}         ‚ïë\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`;\n\n    await ctx.reply(text, { parse_mode: 'Markdown' });\n  } catch (error) {\n    console.error('Ping command error:', error);\n    await ctx.reply('‚ùå Error fetching system information');\n  }\n}\n\nmodule.exports = { handlePing };\n","size_bytes":24644},"autoBackup.js":{"content":"const cron = require('node-cron');\nconst archiver = require('archiver');\nconst fs = require('fs-extra');\nconst path = require('path');\nconst { google } = require('googleapis');\nconst config = require('./config');\n\nconst dataDir = path.join(__dirname, 'data');\nconst backupDir = path.join(dataDir, 'backup');\nconst logFile = path.join(backupDir, 'backup.log');\n\nasync function logBackup(message) {\n  const timestamp = new Date().toISOString();\n  const logMessage = `[${timestamp}] ${message}\\n`;\n  await fs.ensureDir(backupDir);\n  await fs.appendFile(logFile, logMessage);\n  console.log(logMessage.trim());\n}\n\nasync function getGoogleDriveClient() {\n  try {\n    const credentialsPath = process.env.GOOGLE_CREDENTIALS || config.backup.googleCredentials;\n    \n    if (!fs.existsSync(credentialsPath)) {\n      throw new Error(`Google credentials file not found at: ${credentialsPath}`);\n    }\n\n    const credentials = JSON.parse(await fs.readFile(credentialsPath, 'utf8'));\n    \n    if (credentials.project_id === 'YOUR_PROJECT_ID') {\n      throw new Error('Google credentials not configured. Please update config/google.json with your actual service account credentials.');\n    }\n\n    const auth = new google.auth.GoogleAuth({\n      credentials,\n      scopes: ['https://www.googleapis.com/auth/drive.file'],\n    });\n\n    const drive = google.drive({ version: 'v3', auth });\n    return drive;\n  } catch (error) {\n    throw new Error(`Failed to initialize Google Drive client: ${error.message}`);\n  }\n}\n\nasync function createBackupZip(timestamp) {\n  const backupFileName = `backup-${timestamp}.zip`;\n  const backupFilePath = path.join(backupDir, backupFileName);\n\n  await fs.ensureDir(backupDir);\n\n  return new Promise((resolve, reject) => {\n    const output = fs.createWriteStream(backupFilePath);\n    const archive = archiver('zip', { zlib: { level: 9 } });\n\n    output.on('close', () => {\n      const sizeInMB = (archive.pointer() / 1024 / 1024).toFixed(2);\n      logBackup(`Created backup: ${backupFileName} (${sizeInMB} MB)`);\n      resolve(backupFilePath);\n    });\n\n    archive.on('error', (err) => {\n      reject(err);\n    });\n\n    archive.pipe(output);\n\n    archive.glob('**/*', {\n      cwd: dataDir,\n      ignore: ['backup/**'],\n    });\n\n    archive.finalize();\n  });\n}\n\nasync function uploadToGoogleDrive(filePath, fileName) {\n  const folderId = process.env.DRIVE_FOLDER_ID || config.backup.driveFolderId;\n  \n  if (!folderId || folderId === 'YOUR_FOLDER_ID_HERE') {\n    throw new Error('Google Drive folder ID not configured. Please update config.js or set DRIVE_FOLDER_ID environment variable.');\n  }\n\n  const drive = await getGoogleDriveClient();\n\n  // First, verify the folder is accessible and is a Shared Drive or properly shared folder\n  try {\n    const folderInfo = await drive.files.get({\n      fileId: folderId,\n      fields: 'id, name, capabilities, driveId',\n      supportsAllDrives: true\n    });\n    \n    await logBackup(`Uploading to folder: ${folderInfo.data.name} (${folderInfo.data.driveId ? 'Shared Drive' : 'Regular Drive'})`);\n  } catch (error) {\n    throw new Error(`Cannot access folder ${folderId}: ${error.message}`);\n  }\n\n  const fileMetadata = {\n    name: fileName,\n    parents: [folderId],\n  };\n\n  const media = {\n    mimeType: 'application/zip',\n    body: fs.createReadStream(filePath),\n  };\n\n  const response = await drive.files.create({\n    requestBody: fileMetadata,\n    media: media,\n    fields: 'id, name, size, webViewLink',\n    supportsAllDrives: true\n  });\n\n  return response.data;\n}\n\nasync function runBackup() {\n  try {\n    const now = new Date();\n    const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);\n    const backupFileName = `backup-${timestamp}.zip`;\n    const backupFilePath = path.join(backupDir, backupFileName);\n\n    await logBackup(`Starting backup process at ${now.toISOString()}...`);\n\n    const zipPath = await createBackupZip(timestamp);\n    await logBackup(`Backup zip created successfully at: ${zipPath}`);\n\n    try {\n      const driveFile = await uploadToGoogleDrive(zipPath, backupFileName);\n      await logBackup(`Backup uploaded to Google Drive successfully - File ID: ${driveFile.id}`);\n      await logBackup(`Google Drive link: ${driveFile.webViewLink || 'N/A'}`);\n      \n      return { \n        success: true, \n        skipped: false, \n        message: `Backup completed successfully at ${timestamp}`,\n        driveFileId: driveFile.id,\n        driveLink: driveFile.webViewLink\n      };\n    } catch (uploadError) {\n      await logBackup(`Warning: Google Drive upload failed - ${uploadError.message}`);\n      await logBackup(`Local backup saved at: ${zipPath}`);\n      \n      return { \n        success: true, \n        skipped: false, \n        localOnly: true,\n        message: `Backup saved locally only (Google Drive upload failed: ${uploadError.message})`\n      };\n    }\n\n  } catch (error) {\n    await logBackup(`ERROR: Backup failed - ${error.message}`);\n    console.error('Backup error:', error);\n    return { success: false, error: error.message };\n  }\n}\n\nfunction startAutoBackup() {\n  setInterval(async () => {\n    await logBackup('=== Automatic backup triggered (every 10 seconds) ===');\n    await runBackup();\n  }, 10000);\n\n  logBackup('Auto-backup started: Running every 10 seconds');\n}\n\nmodule.exports = {\n  runBackup,\n  startAutoBackup\n};\n","size_bytes":5337},"BACKUP_SETUP.md":{"content":"# Auto-Backup System Setup Guide\n\n## ‚úÖ Implementation Complete\n\nThe auto-backup system has been successfully implemented for your Telegram bot. Here's what was created:\n\n### üìÅ Files Created\n\n1. **config/google.json** - Google service account credentials (placeholder)\n2. **autoBackup.js** - Main backup system with Google Drive integration\n3. **config.js** - Updated with backup configuration\n4. **.gitignore** - Updated to protect sensitive files\n\n### üîß Configuration Required\n\nTo activate the backup system, you need to:\n\n#### 1. Get Google Service Account Credentials\n\n1. Go to [Google Cloud Console](https://console.cloud.google.com/)\n2. Create a new project or select existing one\n3. Enable Google Drive API for your project\n4. Create a Service Account:\n   - Go to \"IAM & Admin\" > \"Service Accounts\"\n   - Click \"Create Service Account\"\n   - Give it a name and click \"Create\"\n   - Click \"Done\"\n5. Create a key for the service account:\n   - Click on the service account you just created\n   - Go to \"Keys\" tab\n   - Click \"Add Key\" > \"Create New Key\"\n   - Select \"JSON\" format\n   - Download the JSON file\n\n#### 2. Update config/google.json\n\nReplace the placeholder content in `config/google.json` with the actual content from the downloaded JSON file.\n\n**Current placeholder:**\n```json\n{\n  \"type\": \"service_account\",\n  \"project_id\": \"YOUR_PROJECT_ID\",\n  ...\n}\n```\n\n**Replace with your actual credentials from the downloaded JSON file.**\n\n#### 3. Create Google Drive Folder\n\n1. Go to [Google Drive](https://drive.google.com/)\n2. Create a new folder for backups (e.g., \"Bot Backups\")\n3. Share the folder with your service account email:\n   - Right-click the folder > \"Share\"\n   - Add the service account email (found in config/google.json as \"client_email\")\n   - Give it \"Editor\" permissions\n4. Get the folder ID:\n   - Open the folder in Google Drive\n   - Copy the ID from the URL: `https://drive.google.com/drive/folders/YOUR_FOLDER_ID`\n\n#### 4. Update Backup Configuration\n\nOpen `config.js` and update the backup section:\n\n```javascript\nbackup: {\n  googleCredentials: process.env.GOOGLE_CREDENTIALS || './config/google.json',\n  driveFolderId: process.env.DRIVE_FOLDER_ID || 'YOUR_ACTUAL_FOLDER_ID_HERE'\n}\n```\n\nReplace `YOUR_ACTUAL_FOLDER_ID_HERE` with the folder ID from step 3.\n\n**Alternative:** Set environment variables:\n- `GOOGLE_CREDENTIALS=./config/google.json`\n- `DRIVE_FOLDER_ID=your_folder_id`\n\n### üì¶ Features Implemented\n\n‚úÖ **Automatic Daily Backups**\n- Scheduled at midnight (00:00 Asia/Kuala_Lumpur time)\n- Backs up all data/ folder contents\n- Excludes data/backup/** to prevent loops\n- Creates ZIP files named: `backup-YYYY-MM-DD.zip`\n\n‚úÖ **Manual Backup Command**\n- Command: `/backupnow`\n- Owner-only access\n- Bilingual responses (Malay/English)\n- Shows backup status and Google Drive link\n\n‚úÖ **Smart Backup Logic**\n- Skips backup if same-date backup exists\n- Logs all operations to `data/backup/backup.log`\n- Graceful error handling with local fallback\n- Uploads to Google Drive automatically\n\n‚úÖ **Security**\n- Sensitive files protected via .gitignore:\n  - config/google.json\n  - .env\n  - data/backup/*.zip\n  - data/backup/*.log\n\n### üéØ Usage\n\n**Manual Backup:**\n```\n/backupnow\n```\nOnly the bot owner can use this command.\n\n**Automatic Backup:**\nRuns automatically every day at midnight. Check `data/backup/backup.log` for status.\n\n### üìä Backup Locations\n\n1. **Local:** `data/backup/backup-YYYY-MM-DD.zip`\n2. **Google Drive:** Uploaded to your configured folder\n3. **Logs:** `data/backup/backup.log`\n\n### üîç Verify Setup\n\n1. Configure Google credentials and folder ID (steps above)\n2. Restart the bot\n3. Run `/backupnow` command\n4. Check for success message with Google Drive link\n5. Verify backup appears in your Google Drive folder\n\n### ‚ö†Ô∏è Important Notes\n\n- The placeholder credentials in `config/google.json` will not work - you must replace them with real credentials\n- Keep your service account credentials secure and never commit them to version control\n- The .gitignore is already configured to protect sensitive files\n- Test the manual backup first before relying on automatic backups\n\n### üÜò Troubleshooting\n\n**Error: \"Google credentials not configured\"**\n- Update config/google.json with real service account credentials\n\n**Error: \"Google Drive folder ID not configured\"**\n- Update config.js with actual folder ID from Google Drive\n\n**Error: \"Permission denied\" or \"File not found\"**\n- Make sure the folder is shared with the service account email\n- Verify the folder ID is correct\n\n**Backup works locally but not uploading to Google Drive:**\n- Check service account permissions on the Google Drive folder\n- Verify Google Drive API is enabled in Google Cloud Console\n- Check data/backup/backup.log for detailed error messages\n\n---\n\n## üéâ Setup Complete!\n\nOnce you've configured the Google credentials and folder ID, your bot will automatically backup all data daily and you can trigger manual backups anytime with `/backupnow`.\n","size_bytes":4988},"autoBackupDropbox.js":{"content":"const fs = require(\"fs\");\nconst path = require(\"path\");\nconst archiver = require(\"archiver\");\nconst cron = require(\"node-cron\");\nconst config = require(\"./config\");\nconst { extract } = require(\"zip-lib\");\n\nconst DROPBOX_TOKEN = config.DROPBOX_TOKEN;\nconst backupFolder = \"./data/backup\";\nconst logFile = \"./data/backup/backup.log\";\nconst stateFile = \"./data/backup/sync_state.json\";\n\nif (!fs.existsSync(backupFolder)) fs.mkdirSync(backupFolder, { recursive: true });\n\nfunction getSyncState() {\n  try {\n    if (fs.existsSync(stateFile)) {\n      return JSON.parse(fs.readFileSync(stateFile, \"utf8\"));\n    }\n  } catch (err) {\n    console.error(\"Error reading sync state:\", err);\n  }\n  return { lastBackupTime: null, lastRestoreTime: null, lastDropboxFile: null };\n}\n\nfunction saveSyncState(state) {\n  try {\n    fs.writeFileSync(stateFile, JSON.stringify(state, null, 2));\n  } catch (err) {\n    console.error(\"Error saving sync state:\", err);\n  }\n}\n\nasync function createBackupZip() {\n  const timestamp = new Date().toISOString().replace(/[:.]/g, \"-\");\n  const zipName = `backup-${timestamp}.zip`;\n  const outputPath = path.join(backupFolder, zipName);\n\n  const output = fs.createWriteStream(outputPath);\n  const archive = archiver(\"zip\", { zlib: { level: 9 } });\n\n  return new Promise((resolve, reject) => {\n    output.on('close', () => {\n      console.log(`‚úÖ Created backup: ${zipName}`);\n      resolve(outputPath);\n    });\n\n    archive.on('error', (err) => {\n      reject(err);\n    });\n\n    archive.pipe(output);\n    archive.glob(\"data/**/*\", { ignore: [\"data/backup/**\"] });\n    archive.finalize();\n  });\n}\n\nasync function uploadToDropbox(filePath) {\n  if (!DROPBOX_TOKEN) {\n    console.log(\"‚ùå DROPBOX_TOKEN not found\");\n    return null;\n  }\n\n  const fileName = path.basename(filePath);\n  const fileData = fs.readFileSync(filePath);\n\n  const res = await fetch(\"https://content.dropboxapi.com/2/files/upload\", {\n    method: \"POST\",\n    headers: {\n      \"Authorization\": `Bearer ${DROPBOX_TOKEN}`,\n      \"Dropbox-API-Arg\": JSON.stringify({\n        path: `/backups/${fileName}`,\n        mode: \"add\",\n        autorename: true,\n        mute: false\n      }),\n      \"Content-Type\": \"application/octet-stream\"\n    },\n    body: fileData\n  });\n\n  const json = await res.json();\n\n  if (json.error_summary) {\n    console.log(\"‚ùå Upload failed:\", json.error_summary);\n    return null;\n  }\n\n  const log = `[${new Date().toLocaleString()}] UPLOAD: ${fileName} ‚Üí ${json.path_display}\\n`;\n  fs.appendFileSync(logFile, log);\n\n  console.log(`‚òÅÔ∏è Uploaded to Dropbox: ${json.path_display}`);\n  return json;\n}\n\nasync function listDropboxFiles() {\n  if (!DROPBOX_TOKEN) {\n    console.log(\"‚ùå DROPBOX_TOKEN not found\");\n    return [];\n  }\n\n  const res = await fetch(\"https://api.dropboxapi.com/2/files/list_folder\", {\n    method: \"POST\",\n    headers: {\n      \"Authorization\": `Bearer ${DROPBOX_TOKEN}`,\n      \"Content-Type\": \"application/json\"\n    },\n    body: JSON.stringify({\n      path: \"/backups\",\n      recursive: false,\n      include_deleted: false\n    })\n  });\n\n  const json = await res.json();\n\n  if (json.error_summary) {\n    console.log(\"‚ùå List files failed:\", json.error_summary);\n    return [];\n  }\n\n  return json.entries || [];\n}\n\nasync function downloadFromDropbox(dropboxPath, localPath) {\n  if (!DROPBOX_TOKEN) {\n    console.log(\"‚ùå DROPBOX_TOKEN not found\");\n    return false;\n  }\n\n  if (fs.existsSync(localPath)) {\n    fs.unlinkSync(localPath);\n  }\n\n  const res = await fetch(\"https://content.dropboxapi.com/2/files/download\", {\n    method: \"POST\",\n    headers: {\n      \"Authorization\": `Bearer ${DROPBOX_TOKEN}`,\n      \"Dropbox-API-Arg\": JSON.stringify({\n        path: dropboxPath\n      })\n    }\n  });\n\n  if (!res.ok) {\n    console.log(\"‚ùå Download failed:\", res.statusText);\n    return false;\n  }\n\n  const buffer = await res.arrayBuffer();\n  fs.writeFileSync(localPath, Buffer.from(buffer));\n\n  const log = `[${new Date().toLocaleString()}] DOWNLOAD: ${dropboxPath} ‚Üí ${localPath}\\n`;\n  fs.appendFileSync(logFile, log);\n\n  console.log(`üì• Downloaded from Dropbox: ${dropboxPath}`);\n  return true;\n}\n\nasync function restoreFromBackup(zipPath) {\n  try {\n    console.log(`üì¶ Extracting backup: ${zipPath}`);\n    \n    const tempDir = path.join(backupFolder, \"temp_restore\");\n    if (fs.existsSync(tempDir)) {\n      fs.rmSync(tempDir, { recursive: true });\n    }\n    fs.mkdirSync(tempDir, { recursive: true });\n\n    await extract(zipPath, tempDir);\n\n    const dataDir = path.join(tempDir, \"data\");\n    if (fs.existsSync(dataDir)) {\n      const files = fs.readdirSync(dataDir);\n      for (const file of files) {\n        if (file === \"backup\") continue;\n        \n        const srcPath = path.join(dataDir, file);\n        const destPath = path.join(\"./data\", file);\n        \n        fs.copyFileSync(srcPath, destPath);\n        console.log(`‚úÖ Restored: ${file}`);\n      }\n\n      const log = `[${new Date().toLocaleString()}] RESTORE: ${path.basename(zipPath)}\\n`;\n      fs.appendFileSync(logFile, log);\n\n      fs.rmSync(tempDir, { recursive: true });\n      \n      console.log(`‚úÖ Restore completed from: ${path.basename(zipPath)}`);\n      return true;\n    } else {\n      console.log(\"‚ùå No data folder found in backup\");\n      return false;\n    }\n  } catch (err) {\n    console.error(\"‚ùå Restore Error:\", err);\n    return false;\n  }\n}\n\nasync function checkAndRestoreNewData() {\n  try {\n    const state = getSyncState();\n    const files = await listDropboxFiles();\n    \n    if (files.length === 0) {\n      return;\n    }\n\n    files.sort((a, b) => new Date(b.server_modified) - new Date(a.server_modified));\n    const latestFile = files[0];\n\n    if (state.lastDropboxFile !== latestFile.id) {\n      console.log(`üîç New backup detected: ${latestFile.name}`);\n      \n      const localPath = path.join(backupFolder, latestFile.name);\n      const downloaded = await downloadFromDropbox(latestFile.path_display, localPath);\n      \n      if (downloaded) {\n        const restored = await restoreFromBackup(localPath);\n        \n        if (restored) {\n          state.lastDropboxFile = latestFile.id;\n          state.lastRestoreTime = new Date().toISOString();\n          saveSyncState(state);\n          console.log(`‚úÖ Auto-restored new data from: ${latestFile.name}`);\n        }\n      }\n    }\n  } catch (err) {\n    console.error(\"‚ùå Check/Restore Error:\", err);\n  }\n}\n\nasync function runBackup() {\n  try {\n    const filePath = await createBackupZip();\n    if (filePath) {\n      const result = await uploadToDropbox(filePath);\n      if (result) {\n        const state = getSyncState();\n        state.lastBackupTime = new Date().toISOString();\n        saveSyncState(state);\n      }\n    }\n  } catch (err) {\n    console.error(\"‚ùå Backup Error:\", err);\n  }\n}\n\nasync function syncCycle() {\n  await runBackup();\n  await checkAndRestoreNewData();\n}\n\nsetInterval(() => {\n  console.log(\"üîÑ Running sync cycle (backup + check for new data)...\");\n  syncCycle();\n}, 1000);\n\nconsole.log(\"üöÄ Dropbox sync started: Every 1 second (backup + auto-restore)\");\n\nmodule.exports = { runBackup, checkAndRestoreNewData, restoreFromBackup };\n","size_bytes":7128},"utils/storageProviders.js":{"content":"const fs = require(\"fs\");\nconst fetch = globalThis.fetch || require(\"node-fetch\");\n\nclass StorageProvider {\n  constructor(name) {\n    this.name = name;\n  }\n\n  async uploadBackup(buffer, filename) {\n    throw new Error(\"uploadBackup() must be implemented\");\n  }\n\n  async listBackups() {\n    throw new Error(\"listBackups() must be implemented\");\n  }\n\n  async downloadBackup(path) {\n    throw new Error(\"downloadBackup() must be implemented\");\n  }\n}\n\nclass DropboxProvider extends StorageProvider {\n  constructor(token) {\n    super(\"Dropbox\");\n    this.token = token;\n  }\n\n  async uploadBackup(buffer, filename) {\n    if (!this.token) {\n      throw new Error(\"Dropbox token not configured\");\n    }\n\n    const res = await fetch(\"https://content.dropboxapi.com/2/files/upload\", {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Bearer ${this.token}`,\n        \"Dropbox-API-Arg\": JSON.stringify({\n          path: `/backups/${filename}`,\n          mode: \"add\",\n          autorename: true,\n          mute: false\n        }),\n        \"Content-Type\": \"application/octet-stream\"\n      },\n      body: buffer\n    });\n\n    const json = await res.json();\n\n    if (json.error_summary) {\n      if (json.error_summary.includes(\"insufficient_space\")) {\n        const error = new Error(\"Dropbox storage full\");\n        error.code = \"STORAGE_FULL\";\n        throw error;\n      }\n      throw new Error(`Dropbox upload failed: ${json.error_summary}`);\n    }\n\n    return {\n      path: json.path_display,\n      id: json.id,\n      name: json.name,\n      size: json.size,\n      modified: json.server_modified\n    };\n  }\n\n  async listBackups() {\n    if (!this.token) {\n      throw new Error(\"Dropbox token not configured\");\n    }\n\n    const res = await fetch(\"https://api.dropboxapi.com/2/files/list_folder\", {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Bearer ${this.token}`,\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify({\n        path: \"/backups\",\n        recursive: false,\n        include_deleted: false\n      })\n    });\n\n    const json = await res.json();\n\n    if (json.error_summary) {\n      throw new Error(`Dropbox list failed: ${json.error_summary}`);\n    }\n\n    const files = (json.entries || []).filter(entry => entry['.tag'] === 'file');\n    \n    return files.map(file => ({\n      path: file.path_display,\n      id: file.id,\n      name: file.name,\n      size: file.size,\n      modified: file.server_modified\n    }));\n  }\n\n  async downloadBackup(dropboxPath) {\n    if (!this.token) {\n      throw new Error(\"Dropbox token not configured\");\n    }\n\n    const res = await fetch(\"https://content.dropboxapi.com/2/files/download\", {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Bearer ${this.token}`,\n        \"Dropbox-API-Arg\": JSON.stringify({\n          path: dropboxPath\n        })\n      }\n    });\n\n    if (!res.ok) {\n      const errorText = await res.text();\n      throw new Error(`Dropbox download failed: ${res.statusText} - ${errorText}`);\n    }\n\n    return await res.arrayBuffer();\n  }\n}\n\nclass GoogleDriveProvider extends StorageProvider {\n  constructor(token, folderId = null) {\n    super(\"Google Drive\");\n    this.token = token;\n    this.folderId = folderId;\n  }\n\n  async ensureFolder() {\n    if (this.folderId) {\n      return this.folderId;\n    }\n\n    const searchRes = await fetch(\n      `https://www.googleapis.com/drive/v3/files?q=name='backups' and mimeType='application/vnd.google-apps.folder' and trashed=false`,\n      {\n        headers: {\n          \"Authorization\": `Bearer ${this.token}`\n        }\n      }\n    );\n\n    const searchJson = await searchRes.json();\n\n    if (searchJson.files && searchJson.files.length > 0) {\n      this.folderId = searchJson.files[0].id;\n      return this.folderId;\n    }\n\n    const createRes = await fetch(\"https://www.googleapis.com/drive/v3/files\", {\n      method: \"POST\",\n      headers: {\n        \"Authorization\": `Bearer ${this.token}`,\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify({\n        name: \"backups\",\n        mimeType: \"application/vnd.google-apps.folder\"\n      })\n    });\n\n    const createJson = await createRes.json();\n    this.folderId = createJson.id;\n    return this.folderId;\n  }\n\n  async uploadBackup(buffer, filename) {\n    if (!this.token) {\n      throw new Error(\"Google Drive token not configured\");\n    }\n\n    const folderId = await this.ensureFolder();\n\n    const metadata = {\n      name: filename,\n      mimeType: \"application/zip\",\n      parents: [folderId]\n    };\n\n    const initiateRes = await fetch(\n      \"https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable\",\n      {\n        method: \"POST\",\n        headers: {\n          \"Authorization\": `Bearer ${this.token}`,\n          \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify(metadata)\n      }\n    );\n\n    if (!initiateRes.ok) {\n      const errorJson = await initiateRes.json().catch(() => ({}));\n      if (\n        initiateRes.status === 403 &&\n        (errorJson.error?.errors?.[0]?.reason === \"quotaExceeded\" ||\n         errorJson.error?.errors?.[0]?.reason === \"storageQuotaExceeded\")\n      ) {\n        const error = new Error(\"Google Drive storage full\");\n        error.code = \"STORAGE_FULL\";\n        throw error;\n      }\n      throw new Error(\n        `Google Drive upload initiation failed: ${errorJson.error?.message || initiateRes.statusText}`\n      );\n    }\n\n    const sessionUrl = initiateRes.headers.get(\"Location\");\n    if (!sessionUrl) {\n      throw new Error(\"Google Drive did not return session URL\");\n    }\n\n    const uploadRes = await fetch(sessionUrl, {\n      method: \"PUT\",\n      headers: {\n        \"Authorization\": `Bearer ${this.token}`,\n        \"Content-Type\": \"application/zip\"\n      },\n      body: buffer\n    });\n\n    if (!uploadRes.ok) {\n      const errorJson = await uploadRes.json().catch(() => ({}));\n      if (\n        uploadRes.status === 403 &&\n        (errorJson.error?.errors?.[0]?.reason === \"quotaExceeded\" ||\n         errorJson.error?.errors?.[0]?.reason === \"storageQuotaExceeded\")\n      ) {\n        const error = new Error(\"Google Drive storage full\");\n        error.code = \"STORAGE_FULL\";\n        throw error;\n      }\n      if (uploadRes.status === 507 || errorJson.error?.message?.includes(\"storage quota\")) {\n        const error = new Error(\"Google Drive storage full\");\n        error.code = \"STORAGE_FULL\";\n        throw error;\n      }\n      throw new Error(\n        `Google Drive upload failed: ${errorJson.error?.message || uploadRes.statusText}`\n      );\n    }\n\n    const json = await uploadRes.json();\n\n    if (json.error) {\n      throw new Error(`Google Drive upload failed: ${json.error.message || JSON.stringify(json.error)}`);\n    }\n\n    return {\n      path: `/backups/${json.name}`,\n      id: json.id,\n      name: json.name,\n      size: json.size,\n      modified: json.modifiedTime\n    };\n  }\n\n  async listBackups() {\n    if (!this.token) {\n      throw new Error(\"Google Drive token not configured\");\n    }\n\n    const folderId = await this.ensureFolder();\n\n    const res = await fetch(\n      `https://www.googleapis.com/drive/v3/files?q='${folderId}' in parents and trashed=false&fields=files(id,name,size,modifiedTime)&orderBy=modifiedTime desc`,\n      {\n        headers: {\n          \"Authorization\": `Bearer ${this.token}`\n        }\n      }\n    );\n\n    const json = await res.json();\n\n    if (json.error) {\n      throw new Error(`Google Drive list failed: ${json.error.message || JSON.stringify(json.error)}`);\n    }\n\n    return (json.files || []).map(file => ({\n      path: `/backups/${file.name}`,\n      id: file.id,\n      name: file.name,\n      size: file.size,\n      modified: file.modifiedTime\n    }));\n  }\n\n  async downloadBackup(fileId) {\n    if (!this.token) {\n      throw new Error(\"Google Drive token not configured\");\n    }\n\n    const res = await fetch(\n      `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,\n      {\n        headers: {\n          \"Authorization\": `Bearer ${this.token}`\n        }\n      }\n    );\n\n    if (!res.ok) {\n      const errorText = await res.text();\n      throw new Error(`Google Drive download failed: ${res.statusText} - ${errorText}`);\n    }\n\n    return await res.arrayBuffer();\n  }\n}\n\nmodule.exports = {\n  StorageProvider,\n  DropboxProvider,\n  GoogleDriveProvider\n};\n","size_bytes":8344},"autoBackupManager.js":{"content":"const fs = require(\"fs\");\nconst path = require(\"path\");\nconst archiver = require(\"archiver\");\nconst cron = require(\"node-cron\");\nconst config = require(\"./config\");\nconst { extract } = require(\"zip-lib\");\nconst { DropboxProvider, GoogleDriveProvider } = require(\"./utils/storageProviders\");\nconst db = require(\"./utils/database\");\n\nconst backupFolder = \"./data/backup\";\nconst logFile = \"./data/backup/backup.log\";\nconst stateFile = \"./data/backup/sync_state.json\";\n\nif (!fs.existsSync(backupFolder)) fs.mkdirSync(backupFolder, { recursive: true });\n\nlet providers = {\n  dropbox: null,\n  googleDrive: null\n};\n\nasync function initializeProviders() {\n  try {\n    let dropboxToken = null;\n    \n    // Priority 1: Check settings.json (via /addapi command)\n    const settings = await db.getSettings();\n    if (settings.dropboxToken) {\n      dropboxToken = settings.dropboxToken;\n      console.log('‚úÖ Using Dropbox token from settings (/addapi)');\n    } \n    // Priority 2: Check config.js (DROPBOX_TOKEN) - MAIN METHOD\n    else if (config.DROPBOX_TOKEN) {\n      dropboxToken = config.DROPBOX_TOKEN;\n      console.log('‚úÖ Using Dropbox token from config.js');\n    }\n    else {\n      console.log('‚ö†Ô∏è No Dropbox token configured. Set DROPBOX_TOKEN in config.js or use /addapi command.');\n    }\n    \n    const googleDriveToken = config.GOOGLE_DRIVE_TOKEN;\n    \n    providers.dropbox = dropboxToken ? new DropboxProvider(dropboxToken) : null;\n    providers.googleDrive = googleDriveToken ? new GoogleDriveProvider(googleDriveToken) : null;\n    \n    console.log(`‚úÖ Storage providers initialized (Dropbox: ${providers.dropbox ? 'OK' : 'Not configured'}, Google Drive: ${providers.googleDrive ? 'OK' : 'Not configured'})`);\n  } catch (err) {\n    console.error(\"Error initializing providers:\", err);\n  }\n}\n\nasync function reloadProviders() {\n  await initializeProviders();\n  console.log(`üîÑ Storage providers reloaded`);\n}\n\nfunction getSyncState() {\n  try {\n    if (fs.existsSync(stateFile)) {\n      return JSON.parse(fs.readFileSync(stateFile, \"utf8\"));\n    }\n  } catch (err) {\n    console.error(\"Error reading sync state:\", err);\n  }\n  return { \n    lastBackupTime: null, \n    lastRestoreTime: null, \n    lastBackupFile: null,\n    activeProvider: \"dropbox\"\n  };\n}\n\nfunction saveSyncState(state) {\n  try {\n    fs.writeFileSync(stateFile, JSON.stringify(state, null, 2));\n  } catch (err) {\n    console.error(\"Error saving sync state:\", err);\n  }\n}\n\nfunction getActiveProvider() {\n  const state = getSyncState();\n  const providerName = state.activeProvider || \"dropbox\";\n  \n  if (providers[providerName]) {\n    return { name: providerName, provider: providers[providerName] };\n  }\n  \n  for (const [name, provider] of Object.entries(providers)) {\n    if (provider) {\n      console.log(`‚ö†Ô∏è Configured provider '${providerName}' not available, using '${name}' instead`);\n      return { name, provider };\n    }\n  }\n  \n  throw new Error(\"No storage providers configured\");\n}\n\nfunction switchProvider(currentProvider) {\n  const availableProviders = Object.entries(providers)\n    .filter(([name, provider]) => provider && name !== currentProvider)\n    .map(([name]) => name);\n  \n  if (availableProviders.length === 0) {\n    throw new Error(\"No alternative storage providers available\");\n  }\n  \n  const newProvider = availableProviders[0];\n  const state = getSyncState();\n  state.activeProvider = newProvider;\n  saveSyncState(state);\n  \n  console.log(`üîÑ FAILOVER: Switched from ${currentProvider} to ${newProvider}`);\n  \n  const log = `[${new Date().toLocaleString()}] FAILOVER: ${currentProvider} ‚Üí ${newProvider}\\n`;\n  fs.appendFileSync(logFile, log);\n  \n  return newProvider;\n}\n\nasync function createBackupZip() {\n  const timestamp = new Date().toISOString().replace(/[:.]/g, \"-\");\n  const zipName = `backup-${timestamp}.zip`;\n  const outputPath = path.join(backupFolder, zipName);\n\n  const output = fs.createWriteStream(outputPath);\n  const archive = archiver(\"zip\", { zlib: { level: 9 } });\n\n  return new Promise((resolve, reject) => {\n    output.on('close', () => {\n      console.log(`‚úÖ Created backup: ${zipName}`);\n      resolve(outputPath);\n    });\n\n    archive.on('error', (err) => {\n      reject(err);\n    });\n\n    archive.pipe(output);\n    archive.glob(\"data/**/*\", { ignore: [\"data/backup/**\"] });\n    archive.finalize();\n  });\n}\n\nasync function uploadBackup(filePath) {\n  const fileName = path.basename(filePath);\n  const fileData = fs.readFileSync(filePath);\n  \n  let { name: providerName, provider } = getActiveProvider();\n  \n  try {\n    const result = await provider.uploadBackup(fileData, fileName);\n    \n    const log = `[${new Date().toLocaleString()}] UPLOAD (${providerName}): ${fileName} ‚Üí ${result.path}\\n`;\n    fs.appendFileSync(logFile, log);\n    \n    console.log(`‚òÅÔ∏è Uploaded to ${providerName}: ${result.path}`);\n    return result;\n  } catch (err) {\n    if (err.code === \"STORAGE_FULL\") {\n      console.log(`‚ùå ${providerName} storage full, attempting failover...`);\n      \n      try {\n        const newProviderName = switchProvider(providerName);\n        const newProvider = providers[newProviderName];\n        \n        const result = await newProvider.uploadBackup(fileData, fileName);\n        \n        const log = `[${new Date().toLocaleString()}] UPLOAD (${newProviderName}): ${fileName} ‚Üí ${result.path}\\n`;\n        fs.appendFileSync(logFile, log);\n        \n        console.log(`‚òÅÔ∏è Uploaded to ${newProviderName}: ${result.path}`);\n        return result;\n      } catch (failoverErr) {\n        console.error(`‚ùå Failover upload failed:`, failoverErr.message);\n        throw failoverErr;\n      }\n    } else {\n      console.error(`‚ùå Upload failed:`, err.message);\n      throw err;\n    }\n  }\n}\n\nasync function listBackups() {\n  const { name: providerName, provider } = getActiveProvider();\n  \n  try {\n    const files = await provider.listBackups();\n    return files;\n  } catch (err) {\n    console.error(`‚ùå List backups failed (${providerName}):`, err.message);\n    return [];\n  }\n}\n\nasync function downloadBackup(file) {\n  const { name: providerName, provider } = getActiveProvider();\n  const localPath = path.join(backupFolder, file.name);\n  \n  try {\n    if (fs.existsSync(localPath)) {\n      fs.unlinkSync(localPath);\n    }\n    \n    const buffer = await provider.downloadBackup(file.id || file.path);\n    fs.writeFileSync(localPath, Buffer.from(buffer));\n    \n    const log = `[${new Date().toLocaleString()}] DOWNLOAD (${providerName}): ${file.path} ‚Üí ${localPath}\\n`;\n    fs.appendFileSync(logFile, log);\n    \n    console.log(`üì• Downloaded from ${providerName}: ${file.path}`);\n    return localPath;\n  } catch (err) {\n    console.error(`‚ùå Download failed (${providerName}):`, err.message);\n    return null;\n  }\n}\n\nasync function restoreFromBackup(zipPath) {\n  try {\n    console.log(`üì¶ Extracting backup: ${zipPath}`);\n    \n    const tempDir = path.join(backupFolder, \"temp_restore\");\n    if (fs.existsSync(tempDir)) {\n      fs.rmSync(tempDir, { recursive: true });\n    }\n    fs.mkdirSync(tempDir, { recursive: true });\n\n    await extract(zipPath, tempDir);\n\n    const dataDir = path.join(tempDir, \"data\");\n    if (fs.existsSync(dataDir)) {\n      const files = fs.readdirSync(dataDir);\n      for (const file of files) {\n        if (file === \"backup\") continue;\n        \n        const srcPath = path.join(dataDir, file);\n        const destPath = path.join(\"./data\", file);\n        \n        fs.copyFileSync(srcPath, destPath);\n        console.log(`‚úÖ Restored: ${file}`);\n      }\n\n      const log = `[${new Date().toLocaleString()}] RESTORE: ${path.basename(zipPath)}\\n`;\n      fs.appendFileSync(logFile, log);\n\n      fs.rmSync(tempDir, { recursive: true });\n      \n      console.log(`‚úÖ Restore completed from: ${path.basename(zipPath)}`);\n      return true;\n    } else {\n      console.log(\"‚ùå No data folder found in backup\");\n      return false;\n    }\n  } catch (err) {\n    console.error(\"‚ùå Restore Error:\", err);\n    return false;\n  }\n}\n\nasync function checkAndRestoreNewData() {\n  try {\n    const state = getSyncState();\n    const allFiles = await listBackups();\n    \n    if (allFiles.length === 0) {\n      return;\n    }\n\n    allFiles.sort((a, b) => new Date(b.modified) - new Date(a.modified));\n    const latestFile = allFiles[0];\n\n    const lastBackupTime = state.lastBackupTime ? new Date(state.lastBackupTime) : new Date(0);\n    const latestFileTime = new Date(latestFile.modified);\n    \n    if (latestFileTime > lastBackupTime && state.lastBackupFile !== latestFile.id) {\n      console.log(`üîç New backup detected from another source: ${latestFile.name}`);\n      \n      const localPath = await downloadBackup(latestFile);\n      \n      if (localPath) {\n        const restored = await restoreFromBackup(localPath);\n        \n        if (restored) {\n          state.lastBackupFile = latestFile.id;\n          state.lastRestoreTime = new Date().toISOString();\n          saveSyncState(state);\n          console.log(`‚úÖ Auto-restored new data from: ${latestFile.name}`);\n        }\n      }\n    }\n  } catch (err) {\n    console.error(\"‚ùå Check/Restore Error:\", err);\n  }\n}\n\nasync function runBackup() {\n  try {\n    const filePath = await createBackupZip();\n    if (filePath) {\n      const result = await uploadBackup(filePath);\n      if (result) {\n        const state = getSyncState();\n        state.lastBackupTime = new Date().toISOString();\n        state.lastBackupFile = result.id;\n        saveSyncState(state);\n      }\n    }\n  } catch (err) {\n    console.error(\"‚ùå Backup Error:\", err);\n  }\n}\n\nasync function syncCycle() {\n  await runBackup();\n  await checkAndRestoreNewData();\n}\n\nconst state = getSyncState();\nconsole.log(`üöÄ Backup manager started with provider: ${state.activeProvider || 'dropbox'}`);\n\ninitializeProviders().then(() => {\n  const backupInterval = config.backup?.interval || 300000;\n  const backupEnabled = config.backup?.enabled !== false;\n  \n  if (backupEnabled) {\n    console.log(`‚è∞ Backup scheduled every ${backupInterval / 1000 / 60} minutes`);\n    setInterval(() => {\n      console.log(\"üîÑ Running sync cycle (backup + check for new data)...\");\n      syncCycle();\n    }, backupInterval);\n  } else {\n    console.log('‚ö†Ô∏è Automatic backup is disabled in config');\n  }\n});\n\nmodule.exports = { runBackup, checkAndRestoreNewData, restoreFromBackup, reloadProviders };\n","size_bytes":10365},"BACKUP_FAILOVER_SYSTEM.md":{"content":"# Dual API Backup System with Automatic Failover\n\n## Overview\nThis system implements a robust backup solution with automatic failover between Dropbox and Google Drive storage providers.\n\n## Architecture\n\n### Storage Providers (`utils/storageProviders.js`)\n- **Base StorageProvider class**: Abstract interface for storage operations\n- **DropboxProvider**: Implements Dropbox API operations\n- **GoogleDriveProvider**: Implements Google Drive API operations\n\nEach provider implements:\n- `uploadBackup(buffer, filename)`: Upload backup file\n- `listBackups()`: List available backups\n- `downloadBackup(path)`: Download backup file\n\n### Backup Manager (`autoBackupManager.js`)\nManages backup operations with automatic failover:\n\n1. **Primary Provider**: Dropbox (default)\n2. **Secondary Provider**: Google Drive (fallback)\n\n## Failover Mechanism\n\n### Storage Full Detection\nThe system detects storage full errors:\n- **Dropbox**: Error containing `insufficient_space`\n- **Google Drive**: HTTP 507 or error message containing `storage quota`\n\n### Automatic Failover\nWhen storage full error is detected:\n1. System catches the error with code `STORAGE_FULL`\n2. Automatically switches to the next available provider\n3. Updates `activeProvider` in `sync_state.json`\n4. Logs the failover event\n5. Retries upload with new provider\n\n### State Tracking\nThe `sync_state.json` file tracks:\n```json\n{\n  \"lastBackupTime\": \"2025-10-10T19:21:33.739Z\",\n  \"lastRestoreTime\": \"2025-10-10T19:18:27.990Z\",\n  \"lastBackupFile\": \"id:P0EOxg48SN0AAAAAAAABrg\",\n  \"activeProvider\": \"dropbox\"\n}\n```\n\n## Configuration\n\n### config.js\n```javascript\n{\n  DROPBOX_TOKEN: 'your_dropbox_token',\n  GOOGLE_DRIVE_TOKEN: process.env.GOOGLE_DRIVE_TOKEN || ''\n}\n```\n\n### Setting Up Google Drive (Optional)\n1. Create a Google Cloud Project\n2. Enable Google Drive API\n3. Create OAuth 2.0 credentials or Service Account\n4. Set `GOOGLE_DRIVE_TOKEN` environment variable\n5. System will automatically use Google Drive when Dropbox is full\n\n## Failover Logs\n\n### Normal Upload\n```\n‚òÅÔ∏è Uploaded to dropbox: /backups/backup-2025-10-10T19-21-31-564Z.zip\n[10/10/2025, 7:21:33 PM] UPLOAD (dropbox): backup-2025-10-10T19-21-31-564Z.zip ‚Üí /backups/backup-2025-10-10T19-21-31-564Z.zip\n```\n\n### Failover Event\n```\n‚ùå dropbox storage full, attempting failover...\nüîÑ FAILOVER: Switched from dropbox to googleDrive\n‚òÅÔ∏è Uploaded to googleDrive: /backups/backup-2025-10-10T19-22-00-000Z.zip\n[10/10/2025, 7:22:00 PM] FAILOVER: dropbox ‚Üí googleDrive\n[10/10/2025, 7:22:01 PM] UPLOAD (googleDrive): backup-2025-10-10T19-22-00-000Z.zip ‚Üí /backups/backup-2025-10-10T19-22-00-000Z.zip\n```\n\n## Backup Cycle\nThe system runs every 20 seconds:\n1. Create backup ZIP of all data files\n2. Upload to active provider\n3. Check for new backups from other instances\n4. Auto-restore if new backup detected\n\n## Benefits\n- ‚úÖ **No manual intervention**: Automatic failover on storage full\n- ‚úÖ **Seamless switching**: No data loss during provider change\n- ‚úÖ **State persistence**: Tracks active provider across restarts\n- ‚úÖ **Clear logging**: Easy to monitor and debug failover events\n- ‚úÖ **Provider agnostic**: Easy to add more providers in the future\n","size_bytes":3184},"handlers/autoPromote.js":{"content":"const db = require('../utils/database');\nconst config = require('../config');\n\nasync function isAdmin(userId) {\n  const admins = await db.getAdmins();\n  return admins.owner === userId || admins.admins.includes(userId);\n}\n\nasync function handleAutoPromotePanel(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'en' \n    ? 'üì¢ *Auto Promote Panel*\\n\\nManage your promotional campaigns:'\n    : 'üì¢ *Panel Auto Promosi*\\n\\nUrus kempen promosi anda:';\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [\n          { text: lang === 'en' ? 'üì® Create Broadcast' : 'üì® Buat Siaran', callback_data: 'promo_create_broadcast' },\n          { text: lang === 'en' ? '‚è∞ Schedule Message' : '‚è∞ Jadual Mesej', callback_data: 'promo_schedule' }\n        ],\n        [\n          { text: lang === 'en' ? 'üìù Templates' : 'üìù Templat', callback_data: 'promo_templates' },\n          { text: lang === 'en' ? 'üéØ User Targeting' : 'üéØ Sasaran Pengguna', callback_data: 'promo_targeting' }\n        ],\n        [\n          { text: lang === 'en' ? 'üìä Analytics' : 'üìä Analitik', callback_data: 'promo_analytics' },\n          { text: lang === 'en' ? 'üîÑ A/B Testing' : 'üîÑ Ujian A/B', callback_data: 'promo_ab_test' }\n        ],\n        [\n          { text: lang === 'en' ? 'üí∞ Discount Codes' : 'üí∞ Kod Diskaun', callback_data: 'promo_discounts' },\n          { text: lang === 'en' ? '‚ö° Flash Sales' : '‚ö° Jualan Kilat', callback_data: 'promo_flash_sales' }\n        ],\n        [\n          { text: lang === 'en' ? 'üîÅ Repeat Campaigns' : 'üîÅ Kempen Berulang', callback_data: 'promo_repeat' },\n          { text: lang === 'en' ? 'üìã Active Campaigns' : 'üìã Kempen Aktif', callback_data: 'promo_active' }\n        ],\n        [{ text: lang === 'en' ? 'üîô Back to Admin' : 'üîô Kembali ke Admin', callback_data: 'admin_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleCreateBroadcast(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  ctx.session = ctx.session || {};\n  ctx.session.awaitingBroadcast = true;\n  \n  const message = lang === 'en'\n    ? 'üì® *Create Broadcast*\\n\\nSend your promotional message to:\\n\\n1Ô∏è‚É£ All Users - Send to everyone\\n2Ô∏è‚É£ Active Users - Users active in last 30 days\\n3Ô∏è‚É£ Tagged Users - Send to specific tag\\n\\nPlease type your message:'\n    : 'üì® *Buat Siaran*\\n\\nHantar mesej promosi anda kepada:\\n\\n1Ô∏è‚É£ Semua Pengguna - Hantar ke semua\\n2Ô∏è‚É£ Pengguna Aktif - Pengguna aktif dalam 30 hari terakhir\\n3Ô∏è‚É£ Pengguna Bertag - Hantar ke tag tertentu\\n\\nSila taip mesej anda:';\n\n  await ctx.reply(message, { \n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [\n          { text: lang === 'en' ? 'üë• All Users' : 'üë• Semua Pengguna', callback_data: 'broadcast_all' },\n          { text: lang === 'en' ? '‚úÖ Active Users' : '‚úÖ Pengguna Aktif', callback_data: 'broadcast_active' }\n        ],\n        [\n          { text: lang === 'en' ? 'üè∑Ô∏è Tagged Users' : 'üè∑Ô∏è Pengguna Bertag', callback_data: 'broadcast_tagged' },\n          { text: lang === 'en' ? '‚ùå Cancel' : '‚ùå Batal', callback_data: 'promo_panel' }\n        ]\n      ]\n    }\n  });\n}\n\nasync function handleScheduleMessage(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  let schedules = await db.read('scheduled_messages.json') || [];\n  \n  const message = lang === 'en'\n    ? `‚è∞ *Scheduled Messages*\\n\\nActive Schedules: ${schedules.length}\\n\\nCreate a new scheduled message:\\n\\nFormat: /schedulemsg [date] [time] [message]\\nExample: /schedulemsg 2025-12-25 10:00 Happy Holidays!`\n    : `‚è∞ *Mesej Berjadual*\\n\\nJadual Aktif: ${schedules.length}\\n\\nBuat mesej berjadual baharu:\\n\\nFormat: /schedulemsg [tarikh] [masa] [mesej]\\nContoh: /schedulemsg 2025-12-25 10:00 Selamat Hari Raya!`;\n\n  const keyboard = schedules.slice(0, 5).map(s => [\n    { text: `üìÖ ${s.date} ${s.time} - ${s.message.substring(0, 30)}...`, callback_data: `view_schedule_${s.id}` }\n  ]);\n  \n  keyboard.push([{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_panel' }]);\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: { inline_keyboard: keyboard }\n  });\n}\n\nasync function handlePromoTemplates(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  let templates = await db.read('promo_templates.json') || [];\n  \n  const message = lang === 'en'\n    ? `üìù *Promotion Templates*\\n\\nSaved Templates: ${templates.length}\\n\\nUse /addpromotemplate [name] [message] to create`\n    : `üìù *Templat Promosi*\\n\\nTemplat Tersimpan: ${templates.length}\\n\\nGuna /addpromotemplate [nama] [mesej] untuk buat`;\n\n  const keyboard = templates.slice(0, 5).map(t => [\n    { text: `${t.name}`, callback_data: `use_promo_template_${t.id}` }\n  ]);\n  \n  keyboard.push([{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_panel' }]);\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: { inline_keyboard: keyboard }\n  });\n}\n\nasync function handleUserTargeting(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const users = await db.getUsers();\n  const activeUsers = users.filter(u => {\n    const lastActive = new Date(u.lastActive || 0);\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    return lastActive > thirtyDaysAgo;\n  });\n  \n  const message = lang === 'en'\n    ? `üéØ *User Targeting*\\n\\nüìä Total Users: ${users.length}\\n‚úÖ Active (30 days): ${activeUsers.length}\\n\\nSegments:\\n‚Ä¢ All Users\\n‚Ä¢ Active Users\\n‚Ä¢ Tagged Users\\n‚Ä¢ Purchased Users\\n‚Ä¢ Non-buyers`\n    : `üéØ *Sasaran Pengguna*\\n\\nüìä Jumlah Pengguna: ${users.length}\\n‚úÖ Aktif (30 hari): ${activeUsers.length}\\n\\nSegmen:\\n‚Ä¢ Semua Pengguna\\n‚Ä¢ Pengguna Aktif\\n‚Ä¢ Pengguna Bertag\\n‚Ä¢ Pengguna Beli\\n‚Ä¢ Belum Beli`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [\n          { text: lang === 'en' ? 'üë• All' : 'üë• Semua', callback_data: 'target_all' },\n          { text: lang === 'en' ? '‚úÖ Active' : '‚úÖ Aktif', callback_data: 'target_active' }\n        ],\n        [\n          { text: lang === 'en' ? 'üè∑Ô∏è Tagged' : 'üè∑Ô∏è Bertag', callback_data: 'target_tagged' },\n          { text: lang === 'en' ? 'üõçÔ∏è Buyers' : 'üõçÔ∏è Pembeli', callback_data: 'target_buyers' }\n        ],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handlePromoAnalytics(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const campaigns = await db.read('campaigns.json') || [];\n  const totalSent = campaigns.reduce((sum, c) => sum + (c.sent || 0), 0);\n  const totalClicks = campaigns.reduce((sum, c) => sum + (c.clicks || 0), 0);\n  const totalConversions = campaigns.reduce((sum, c) => sum + (c.conversions || 0), 0);\n  \n  const message = lang === 'en'\n    ? `üìä *Promotion Analytics*\\n\\nüì® Total Messages Sent: ${totalSent}\\nüëÜ Total Clicks: ${totalClicks}\\nüí∞ Conversions: ${totalConversions}\\nüìà Click Rate: ${totalSent > 0 ? ((totalClicks/totalSent)*100).toFixed(2) : 0}%\\nüíµ Conversion Rate: ${totalClicks > 0 ? ((totalConversions/totalClicks)*100).toFixed(2) : 0}%`\n    : `üìä *Analitik Promosi*\\n\\nüì® Jumlah Mesej Dihantar: ${totalSent}\\nüëÜ Jumlah Klik: ${totalClicks}\\nüí∞ Penukaran: ${totalConversions}\\nüìà Kadar Klik: ${totalSent > 0 ? ((totalClicks/totalSent)*100).toFixed(2) : 0}%\\nüíµ Kadar Penukaran: ${totalClicks > 0 ? ((totalConversions/totalClicks)*100).toFixed(2) : 0}%`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üìà Detailed Report' : 'üìà Laporan Terperinci', callback_data: 'promo_detailed_report' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleABTesting(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'en'\n    ? `üîÑ *A/B Testing*\\n\\nTest different messages to find what works best!\\n\\nCreate test: /createabtest [name] [messageA] | [messageB]\\n\\nExample:\\n/createabtest \"Sale Test\" Get 20% off today! | Limited time 20% discount!`\n    : `üîÑ *Ujian A/B*\\n\\nUji mesej berbeza untuk cari yang terbaik!\\n\\nBuat ujian: /createabtest [nama] [mesejA] | [mesejB]\\n\\nContoh:\\n/createabtest \"Ujian Jualan\" Dapat 20% diskaun hari ini! | Diskaun 20% masa terhad!`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? '‚ûï Create A/B Test' : '‚ûï Buat Ujian A/B', callback_data: 'create_ab_test' }],\n        [{ text: lang === 'en' ? 'üìä View Results' : 'üìä Lihat Hasil', callback_data: 'ab_test_results' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleDiscountCodes(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const discounts = await db.read('discount_codes.json') || [];\n  \n  const message = lang === 'en'\n    ? `üí∞ *Discount Codes*\\n\\nActive Codes: ${discounts.length}\\n\\nCreate: /creatediscount [code] [percentage] [maxUses]\\nExample: /creatediscount SAVE20 20 100`\n    : `üí∞ *Kod Diskaun*\\n\\nKod Aktif: ${discounts.length}\\n\\nBuat: /creatediscount [kod] [peratusan] [maksPenggunaan]\\nContoh: /creatediscount JIMAT20 20 100`;\n\n  const keyboard = discounts.slice(0, 5).map(d => [\n    { text: `${d.code} - ${d.percentage}% (${d.used || 0}/${d.maxUses})`, callback_data: `view_discount_${d.code}` }\n  ]);\n  \n  keyboard.push([{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_panel' }]);\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: { inline_keyboard: keyboard }\n  });\n}\n\nasync function handleFlashSales(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const flashSales = await db.read('flash_sales.json') || [];\n  const activeFlashSales = flashSales.filter(f => new Date(f.endTime) > new Date());\n  \n  const message = lang === 'en'\n    ? `‚ö° *Flash Sales*\\n\\nActive Flash Sales: ${activeFlashSales.length}\\n\\nCreate: /createflash [productId] [discount%] [duration_hours]\\nExample: /createflash PROD123 30 24`\n    : `‚ö° *Jualan Kilat*\\n\\nJualan Kilat Aktif: ${activeFlashSales.length}\\n\\nBuat: /createflash [idProduk] [diskaun%] [jam_durasi]\\nContoh: /createflash PROD123 30 24`;\n\n  const keyboard = activeFlashSales.slice(0, 5).map(f => [\n    { text: `${f.productName} - ${f.discount}% (${f.hoursLeft}h left)`, callback_data: `view_flash_${f.id}` }\n  ]);\n  \n  keyboard.push([{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_panel' }]);\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: { inline_keyboard: keyboard }\n  });\n}\n\nasync function handleRepeatCampaigns(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const repeatCampaigns = await db.read('repeat_campaigns.json') || [];\n  \n  const message = lang === 'en'\n    ? `üîÅ *Repeat Campaigns*\\n\\nActive Recurring: ${repeatCampaigns.length}\\n\\nCreate: /repeatcampaign [interval] [message]\\nIntervals: daily, weekly, monthly\\n\\nExample: /repeatcampaign weekly Check our new products!`\n    : `üîÅ *Kempen Berulang*\\n\\nBerulang Aktif: ${repeatCampaigns.length}\\n\\nBuat: /repeatcampaign [selang] [mesej]\\nSelang: daily, weekly, monthly\\n\\nContoh: /repeatcampaign weekly Lihat produk baharu kami!`;\n\n  const keyboard = repeatCampaigns.slice(0, 5).map(r => [\n    { text: `${r.interval} - ${r.message.substring(0, 30)}...`, callback_data: `view_repeat_${r.id}` }\n  ]);\n  \n  keyboard.push([{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_panel' }]);\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: { inline_keyboard: keyboard }\n  });\n}\n\nasync function handleActiveCampaigns(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const campaigns = await db.read('campaigns.json') || [];\n  const activeCampaigns = campaigns.filter(c => c.status === 'active');\n  \n  const message = lang === 'en'\n    ? `üìã *Active Campaigns*\\n\\nRunning: ${activeCampaigns.length}\\n\\n${activeCampaigns.slice(0, 10).map((c, i) => \n        `${i+1}. ${c.name}\\n   üì® Sent: ${c.sent || 0} | üëÜ Clicks: ${c.clicks || 0}`\n      ).join('\\n\\n')}`\n    : `üìã *Kempen Aktif*\\n\\nBerjalan: ${activeCampaigns.length}\\n\\n${activeCampaigns.slice(0, 10).map((c, i) => \n        `${i+1}. ${c.name}\\n   üì® Dihantar: ${c.sent || 0} | üëÜ Klik: ${c.clicks || 0}`\n      ).join('\\n\\n')}`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? '‚è∏Ô∏è Pause All' : '‚è∏Ô∏è Jeda Semua', callback_data: 'pause_all_campaigns' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleBroadcastAll(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const users = await db.getUsers();\n  \n  const message = lang === 'en'\n    ? `üë• *Broadcast to All Users*\\n\\nTotal Recipients: ${users.length}\\n\\nPlease send your broadcast message now:`\n    : `üë• *Siaran ke Semua Pengguna*\\n\\nJumlah Penerima: ${users.length}\\n\\nSila hantar mesej siaran anda sekarang:`;\n\n  ctx.session = ctx.session || {};\n  ctx.session.awaitingBroadcastAll = true;\n  \n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Cancel' : 'üîô Batal', callback_data: 'promo_create_broadcast' }]\n      ]\n    }\n  });\n}\n\nasync function handleBroadcastActive(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const users = await db.getUsers();\n  const activeUsers = users.filter(u => {\n    const lastActive = new Date(u.lastActive || 0);\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    return lastActive > thirtyDaysAgo;\n  });\n  \n  const message = lang === 'en'\n    ? `‚úÖ *Broadcast to Active Users*\\n\\nActive Users (30 days): ${activeUsers.length}\\n\\nPlease send your broadcast message now:`\n    : `‚úÖ *Siaran ke Pengguna Aktif*\\n\\nPengguna Aktif (30 hari): ${activeUsers.length}\\n\\nSila hantar mesej siaran anda sekarang:`;\n\n  ctx.session = ctx.session || {};\n  ctx.session.awaitingBroadcastActive = true;\n  \n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Cancel' : 'üîô Batal', callback_data: 'promo_create_broadcast' }]\n      ]\n    }\n  });\n}\n\nasync function handleBroadcastTagged(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'en'\n    ? `üè∑Ô∏è *Broadcast to Tagged Users*\\n\\nPlease specify the tag:\\n\\nFormat: /broadcasttag [tag_name] [message]\\n\\nExample:\\n/broadcasttag vip Check out our exclusive offers!`\n    : `üè∑Ô∏è *Siaran ke Pengguna Bertag*\\n\\nSila nyatakan tag:\\n\\nFormat: /broadcasttag [nama_tag] [mesej]\\n\\nContoh:\\n/broadcasttag vip Lihat tawaran eksklusif kami!`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Cancel' : 'üîô Batal', callback_data: 'promo_create_broadcast' }]\n      ]\n    }\n  });\n}\n\nasync function handleTargetAll(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const users = await db.getUsers();\n  \n  const message = lang === 'en'\n    ? `üë• *All Users Segment*\\n\\nTotal Users: ${users.length}\\n\\nüìä Breakdown:\\n‚Ä¢ Total Registered: ${users.length}\\n‚Ä¢ Average Activity: Daily check recommended\\n\\nUse this segment for:\\n‚Ä¢ General announcements\\n‚Ä¢ New product launches\\n‚Ä¢ Important updates`\n    : `üë• *Segmen Semua Pengguna*\\n\\nJumlah Pengguna: ${users.length}\\n\\nüìä Pecahan:\\n‚Ä¢ Jumlah Berdaftar: ${users.length}\\n‚Ä¢ Aktiviti Purata: Semak harian disyorkan\\n\\nGuna segmen ini untuk:\\n‚Ä¢ Pengumuman umum\\n‚Ä¢ Pelancaran produk baharu\\n‚Ä¢ Kemas kini penting`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üì® Send Broadcast' : 'üì® Hantar Siaran', callback_data: 'broadcast_all' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_targeting' }]\n      ]\n    }\n  });\n}\n\nasync function handleTargetActive(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const users = await db.getUsers();\n  const activeUsers = users.filter(u => {\n    const lastActive = new Date(u.lastActive || 0);\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    return lastActive > thirtyDaysAgo;\n  });\n  \n  const message = lang === 'en'\n    ? `‚úÖ *Active Users Segment*\\n\\nActive Users (30 days): ${activeUsers.length}\\nConversion Rate: Higher\\n\\nüìä Best for:\\n‚Ä¢ Flash sales\\n‚Ä¢ Limited time offers\\n‚Ä¢ Engagement campaigns`\n    : `‚úÖ *Segmen Pengguna Aktif*\\n\\nPengguna Aktif (30 hari): ${activeUsers.length}\\nKadar Penukaran: Lebih Tinggi\\n\\nüìä Terbaik untuk:\\n‚Ä¢ Jualan kilat\\n‚Ä¢ Tawaran masa terhad\\n‚Ä¢ Kempen penglibatan`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üì® Send Broadcast' : 'üì® Hantar Siaran', callback_data: 'broadcast_active' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_targeting' }]\n      ]\n    }\n  });\n}\n\nasync function handleTargetTagged(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const users = await db.getUsers();\n  const taggedUsers = users.filter(u => u.tags && u.tags.length > 0);\n  \n  const allTags = [...new Set(users.flatMap(u => u.tags || []))];\n  \n  const message = lang === 'en'\n    ? `üè∑Ô∏è *Tagged Users Segment*\\n\\nUsers with Tags: ${taggedUsers.length}\\nAvailable Tags: ${allTags.join(', ') || 'None'}\\n\\nUse /tag [user_id] [tag] to add tags\\n\\nThen broadcast with:\\n/broadcasttag [tag] [message]`\n    : `üè∑Ô∏è *Segmen Pengguna Bertag*\\n\\nPengguna dengan Tag: ${taggedUsers.length}\\nTag Tersedia: ${allTags.join(', ') || 'Tiada'}\\n\\nGuna /tag [user_id] [tag] untuk tambah tag\\n\\nKemudian siar dengan:\\n/broadcasttag [tag] [mesej]`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üì® Send to Tagged' : 'üì® Hantar ke Bertag', callback_data: 'broadcast_tagged' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_targeting' }]\n      ]\n    }\n  });\n}\n\nasync function handleTargetBuyers(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.read('transactions.json') || [];\n  const buyerIds = [...new Set(transactions.filter(t => t.status === 'verified').map(t => t.userId))];\n  \n  const message = lang === 'en'\n    ? `üõçÔ∏è *Buyers Segment*\\n\\nTotal Buyers: ${buyerIds.length}\\n\\nüìä Best for:\\n‚Ä¢ Cross-sell campaigns\\n‚Ä¢ Loyalty rewards\\n‚Ä¢ Repeat purchase incentives\\n‚Ä¢ Premium product launches`\n    : `üõçÔ∏è *Segmen Pembeli*\\n\\nJumlah Pembeli: ${buyerIds.length}\\n\\nüìä Terbaik untuk:\\n‚Ä¢ Kempen jualan silang\\n‚Ä¢ Ganjaran kesetiaan\\n‚Ä¢ Insentif pembelian berulang\\n‚Ä¢ Pelancaran produk premium`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üì® Send to Buyers' : 'üì® Hantar ke Pembeli', callback_data: 'broadcast_buyers' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_targeting' }]\n      ]\n    }\n  });\n}\n\nasync function handlePromoDetailedReport(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const campaigns = await db.read('campaigns.json') || [];\n  \n  let report = lang === 'en' ? 'üìà *Detailed Analytics Report*\\n\\n' : 'üìà *Laporan Analitik Terperinci*\\n\\n';\n  \n  if (campaigns.length === 0) {\n    report += lang === 'en' ? 'No campaigns yet.' : 'Tiada kempen lagi.';\n  } else {\n    campaigns.slice(0, 10).forEach((c, i) => {\n      const clickRate = c.sent > 0 ? ((c.clicks || 0) / c.sent * 100).toFixed(2) : 0;\n      const convRate = (c.clicks || 0) > 0 ? ((c.conversions || 0) / c.clicks * 100).toFixed(2) : 0;\n      \n      report += `${i + 1}. *${c.name || 'Unnamed'}*\\n`;\n      report += `   üì® Sent: ${c.sent || 0}\\n`;\n      report += `   üëÜ Clicks: ${c.clicks || 0} (${clickRate}%)\\n`;\n      report += `   üí∞ Conversions: ${c.conversions || 0} (${convRate}%)\\n`;\n      report += `   üìÖ Date: ${c.date || 'N/A'}\\n\\n`;\n    });\n  }\n\n  await ctx.reply(report, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_analytics' }]\n      ]\n    }\n  });\n}\n\nasync function handleCreateABTest(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'en'\n    ? `‚ûï *Create A/B Test*\\n\\nFormat:\\n/createabtest [name] [messageA] | [messageB]\\n\\nExample:\\n/createabtest \"Holiday Sale\" üéÑ Get 30% off now! | üéÅ Limited: 30% discount today!\\n\\nThe system will randomly send either version and track which performs better.`\n    : `‚ûï *Buat Ujian A/B*\\n\\nFormat:\\n/createabtest [nama] [mesejA] | [mesejB]\\n\\nContoh:\\n/createabtest \"Jualan Raya\" üéÑ Dapat 30% diskaun sekarang! | üéÅ Terhad: 30% diskaun hari ini!\\n\\nSistem akan hantar salah satu versi secara rawak dan jejak prestasi.`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_ab_test' }]\n      ]\n    }\n  });\n}\n\nasync function handleABTestResults(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const abTests = await db.read('ab_tests.json') || [];\n  \n  let message = lang === 'en' ? 'üìä *A/B Test Results*\\n\\n' : 'üìä *Hasil Ujian A/B*\\n\\n';\n  \n  if (abTests.length === 0) {\n    message += lang === 'en' ? 'No A/B tests yet. Create one to start testing!' : 'Tiada ujian A/B lagi. Buat satu untuk mula menguji!';\n  } else {\n    abTests.forEach((test, i) => {\n      const winnerText = lang === 'en' ? 'Winner' : 'Pemenang';\n      const winner = (test.clicksA || 0) > (test.clicksB || 0) ? 'A' : 'B';\n      \n      message += `${i + 1}. *${test.name}*\\n`;\n      message += `   Version A: ${test.clicksA || 0} clicks\\n`;\n      message += `   Version B: ${test.clicksB || 0} clicks\\n`;\n      message += `   ${winnerText}: Version ${winner}\\n\\n`;\n    });\n  }\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_ab_test' }]\n      ]\n    }\n  });\n}\n\nasync function handlePauseAllCampaigns(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const campaigns = await db.read('campaigns.json') || [];\n  let pausedCount = 0;\n  \n  campaigns.forEach(c => {\n    if (c.status === 'active') {\n      c.status = 'paused';\n      pausedCount++;\n    }\n  });\n  \n  await db.write('campaigns.json', campaigns);\n  \n  const message = lang === 'en'\n    ? `‚è∏Ô∏è *Campaigns Paused*\\n\\n${pausedCount} active campaigns have been paused.\\n\\nYou can resume them individually from the campaign management panel.`\n    : `‚è∏Ô∏è *Kempen Dijeda*\\n\\n${pausedCount} kempen aktif telah dijeda.\\n\\nAnda boleh sambung semula dari panel pengurusan kempen.`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_active' }]\n      ]\n    }\n  });\n}\n\nasync function handleViewSchedule(ctx, scheduleId) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const schedules = await db.read('scheduled_messages.json') || [];\n  const schedule = schedules.find(s => s.id === scheduleId);\n  \n  if (!schedule) {\n    await ctx.reply(lang === 'en' ? '‚ùå Schedule not found' : '‚ùå Jadual tidak dijumpai');\n    return;\n  }\n  \n  const message = lang === 'en'\n    ? `üìÖ *Scheduled Message*\\n\\nDate: ${schedule.date}\\nTime: ${schedule.time}\\nMessage: ${schedule.message}\\n\\nStatus: ${schedule.status || 'pending'}`\n    : `üìÖ *Mesej Berjadual*\\n\\nTarikh: ${schedule.date}\\nMasa: ${schedule.time}\\nMesej: ${schedule.message}\\n\\nStatus: ${schedule.status || 'menunggu'}`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üóëÔ∏è Delete' : 'üóëÔ∏è Padam', callback_data: `delete_schedule_${scheduleId}` }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_schedule' }]\n      ]\n    }\n  });\n}\n\nasync function handleUsePromoTemplate(ctx, templateId) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const templates = await db.read('promo_templates.json') || [];\n  const template = templates.find(t => t.id === templateId);\n  \n  if (!template) {\n    await ctx.reply(lang === 'en' ? '‚ùå Template not found' : '‚ùå Templat tidak dijumpai');\n    return;\n  }\n  \n  const message = lang === 'en'\n    ? `üìù *Using Template: ${template.name}*\\n\\nMessage:\\n${template.message}\\n\\nSend this to:`\n    : `üìù *Guna Templat: ${template.name}*\\n\\nMesej:\\n${template.message}\\n\\nHantar ke:`;\n\n  ctx.session = ctx.session || {};\n  ctx.session.templateMessage = template.message;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [\n          { text: lang === 'en' ? 'üë• All Users' : 'üë• Semua', callback_data: 'broadcast_all' },\n          { text: lang === 'en' ? '‚úÖ Active' : '‚úÖ Aktif', callback_data: 'broadcast_active' }\n        ],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_templates' }]\n      ]\n    }\n  });\n}\n\nasync function handleViewDiscount(ctx, discountCode) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const discounts = await db.read('discount_codes.json') || [];\n  const discount = discounts.find(d => d.code === discountCode);\n  \n  if (!discount) {\n    await ctx.reply(lang === 'en' ? '‚ùå Discount code not found' : '‚ùå Kod diskaun tidak dijumpai');\n    return;\n  }\n  \n  const message = lang === 'en'\n    ? `üí∞ *Discount Code: ${discount.code}*\\n\\nüíµ Discount: ${discount.percentage}%\\nüìä Used: ${discount.used || 0}/${discount.maxUses}\\nüìÖ Created: ${discount.created || 'N/A'}\\n‚è∞ Expires: ${discount.expires || 'Never'}\\n\\nStatus: ${discount.used >= discount.maxUses ? '‚ùå Exhausted' : '‚úÖ Active'}`\n    : `üí∞ *Kod Diskaun: ${discount.code}*\\n\\nüíµ Diskaun: ${discount.percentage}%\\nüìä Digunakan: ${discount.used || 0}/${discount.maxUses}\\nüìÖ Dicipta: ${discount.created || 'N/A'}\\n‚è∞ Luput: ${discount.expires || 'Tidak'}\\n\\nStatus: ${discount.used >= discount.maxUses ? '‚ùå Habis' : '‚úÖ Aktif'}`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üóëÔ∏è Delete' : 'üóëÔ∏è Padam', callback_data: `delete_discount_${discountCode}` }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_discounts' }]\n      ]\n    }\n  });\n}\n\nasync function handleViewFlash(ctx, flashId) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const flashSales = await db.read('flash_sales.json') || [];\n  const flash = flashSales.find(f => f.id === flashId);\n  \n  if (!flash) {\n    await ctx.reply(lang === 'en' ? '‚ùå Flash sale not found' : '‚ùå Jualan kilat tidak dijumpai');\n    return;\n  }\n  \n  const timeLeft = new Date(flash.endTime) - new Date();\n  const hoursLeft = Math.max(0, Math.floor(timeLeft / (1000 * 60 * 60)));\n  \n  const message = lang === 'en'\n    ? `‚ö° *Flash Sale*\\n\\nProduct: ${flash.productName}\\nüíµ Discount: ${flash.discount}%\\n‚è∞ Time Left: ${hoursLeft} hours\\nüìÖ Ends: ${flash.endTime}\\n\\nStatus: ${hoursLeft > 0 ? '‚úÖ Active' : '‚ùå Expired'}`\n    : `‚ö° *Jualan Kilat*\\n\\nProduk: ${flash.productName}\\nüíµ Diskaun: ${flash.discount}%\\n‚è∞ Masa Tinggal: ${hoursLeft} jam\\nüìÖ Tamat: ${flash.endTime}\\n\\nStatus: ${hoursLeft > 0 ? '‚úÖ Aktif' : '‚ùå Tamat'}`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üóëÔ∏è End Sale' : 'üóëÔ∏è Tamat Jualan', callback_data: `end_flash_${flashId}` }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_flash_sales' }]\n      ]\n    }\n  });\n}\n\nasync function handleViewRepeat(ctx, repeatId) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const repeatCampaigns = await db.read('repeat_campaigns.json') || [];\n  const repeat = repeatCampaigns.find(r => r.id === repeatId);\n  \n  if (!repeat) {\n    await ctx.reply(lang === 'en' ? '‚ùå Repeat campaign not found' : '‚ùå Kempen berulang tidak dijumpai');\n    return;\n  }\n  \n  const message = lang === 'en'\n    ? `üîÅ *Repeat Campaign*\\n\\nInterval: ${repeat.interval}\\nMessage: ${repeat.message}\\nüìä Sent: ${repeat.timesSent || 0} times\\nüìÖ Last Sent: ${repeat.lastSent || 'Never'}\\nüìÖ Next Send: ${repeat.nextSend || 'Calculating...'}\\n\\nStatus: ${repeat.status || 'active'}`\n    : `üîÅ *Kempen Berulang*\\n\\nSelang: ${repeat.interval}\\nMesej: ${repeat.message}\\nüìä Dihantar: ${repeat.timesSent || 0} kali\\nüìÖ Terakhir Dihantar: ${repeat.lastSent || 'Belum'}\\nüìÖ Hantar Seterusnya: ${repeat.nextSend || 'Mengira...'}\\n\\nStatus: ${repeat.status || 'aktif'}`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? '‚è∏Ô∏è Pause' : '‚è∏Ô∏è Jeda', callback_data: `pause_repeat_${repeatId}` }],\n        [{ text: lang === 'en' ? 'üóëÔ∏è Delete' : 'üóëÔ∏è Padam', callback_data: `delete_repeat_${repeatId}` }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'promo_repeat' }]\n      ]\n    }\n  });\n}\n\nasync function handleScheduleMsg(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n\n  const { generateId } = require('../utils/helpers');\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const text = ctx.message.text.replace('/schedulemsg', '').trim();\n  const parts = text.split(' ');\n\n  if (parts.length < 3) {\n    const message = lang === 'en'\n      ? '‚ùå Invalid format!\\n\\nUsage: /schedulemsg [date] [time] [message]\\nExample: /schedulemsg 2025-12-25 10:00 Happy Holidays!'\n      : '‚ùå Format tidak sah!\\n\\nGuna: /schedulemsg [tarikh] [masa] [mesej]\\nContoh: /schedulemsg 2025-12-25 10:00 Selamat Hari Raya!';\n    await ctx.reply(message);\n    return;\n  }\n\n  const date = parts[0];\n  const time = parts[1];\n  const message = parts.slice(2).join(' ');\n\n  const dateRegex = /^\\d{4}-\\d{2}-\\d{2}$/;\n  const timeRegex = /^\\d{2}:\\d{2}$/;\n\n  if (!dateRegex.test(date)) {\n    const errorMsg = lang === 'en'\n      ? '‚ùå Invalid date format! Use YYYY-MM-DD (e.g., 2025-12-25)'\n      : '‚ùå Format tarikh tidak sah! Guna YYYY-MM-DD (contoh: 2025-12-25)';\n    await ctx.reply(errorMsg);\n    return;\n  }\n\n  if (!timeRegex.test(time)) {\n    const errorMsg = lang === 'en'\n      ? '‚ùå Invalid time format! Use HH:MM (e.g., 10:00)'\n      : '‚ùå Format masa tidak sah! Guna HH:MM (contoh: 10:00)';\n    await ctx.reply(errorMsg);\n    return;\n  }\n\n  const scheduledMessages = await db.read('scheduled_messages.json') || [];\n  \n  const newSchedule = {\n    id: generateId('SCH'),\n    date,\n    time,\n    message,\n    createdBy: userId,\n    createdAt: new Date().toISOString(),\n    status: 'pending'\n  };\n\n  scheduledMessages.push(newSchedule);\n  await db.write('scheduled_messages.json', scheduledMessages);\n\n  const successMsg = lang === 'en'\n    ? `‚úÖ Message scheduled successfully!\\n\\nüìÖ Date: ${date}\\n‚è∞ Time: ${time}\\nüìù Message: ${message}\\n\\nID: ${newSchedule.id}`\n    : `‚úÖ Mesej berjadual berjaya!\\n\\nüìÖ Tarikh: ${date}\\n‚è∞ Masa: ${time}\\nüìù Mesej: ${message}\\n\\nID: ${newSchedule.id}`;\n\n  await ctx.reply(successMsg);\n}\n\nasync function handleAddPromoTemplate(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n\n  const { generateId } = require('../utils/helpers');\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const text = ctx.message.text.replace('/addpromotemplate', '').trim();\n  const parts = text.split(' ');\n\n  if (parts.length < 2) {\n    const message = lang === 'en'\n      ? '‚ùå Invalid format!\\n\\nUsage: /addpromotemplate [name] [message]\\nExample: /addpromotemplate welcome Welcome to our store!'\n      : '‚ùå Format tidak sah!\\n\\nGuna: /addpromotemplate [nama] [mesej]\\nContoh: /addpromotemplate selamat Selamat datang ke kedai kami!';\n    await ctx.reply(message);\n    return;\n  }\n\n  const name = parts[0];\n  const message = parts.slice(1).join(' ');\n\n  const templates = await db.read('promo_templates.json') || [];\n  \n  const existing = templates.find(t => t.name.toLowerCase() === name.toLowerCase());\n  if (existing) {\n    const errorMsg = lang === 'en'\n      ? `‚ùå Template \"${name}\" already exists!`\n      : `‚ùå Templat \"${name}\" sudah wujud!`;\n    await ctx.reply(errorMsg);\n    return;\n  }\n\n  const newTemplate = {\n    id: generateId('TPL'),\n    name,\n    message,\n    createdBy: userId,\n    createdAt: new Date().toISOString(),\n    usageCount: 0\n  };\n\n  templates.push(newTemplate);\n  await db.write('promo_templates.json', templates);\n\n  const successMsg = lang === 'en'\n    ? `‚úÖ Template created successfully!\\n\\nüìù Name: ${name}\\nüí¨ Message: ${message}\\n\\nID: ${newTemplate.id}`\n    : `‚úÖ Templat berjaya dicipta!\\n\\nüìù Nama: ${name}\\nüí¨ Mesej: ${message}\\n\\nID: ${newTemplate.id}`;\n\n  await ctx.reply(successMsg);\n}\n\nasync function handleCreateABTestCommand(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n\n  const { generateId } = require('../utils/helpers');\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const text = ctx.message.text.replace('/createabtest', '').trim();\n  \n  if (!text.includes('|')) {\n    const message = lang === 'en'\n      ? '‚ùå Invalid format!\\n\\nUsage: /createabtest [name] [messageA] | [messageB]\\nExample: /createabtest \"Sale Test\" Get 20% off today! | Limited time 20% discount!'\n      : '‚ùå Format tidak sah!\\n\\nGuna: /createabtest [nama] [mesejA] | [mesejB]\\nContoh: /createabtest \"Ujian Jualan\" Dapat 20% diskaun hari ini! | Diskaun 20% masa terhad!';\n    await ctx.reply(message);\n    return;\n  }\n\n  const mainParts = text.split('|');\n  if (mainParts.length !== 2) {\n    const errorMsg = lang === 'en'\n      ? '‚ùå Please provide exactly 2 message variants separated by |'\n      : '‚ùå Sila berikan tepat 2 varian mesej dipisahkan dengan |';\n    await ctx.reply(errorMsg);\n    return;\n  }\n\n  const firstPart = mainParts[0].trim();\n  const messageB = mainParts[1].trim();\n  \n  const firstWords = firstPart.split(' ');\n  const name = firstWords[0];\n  const messageA = firstWords.slice(1).join(' ');\n\n  if (!name || !messageA || !messageB) {\n    const errorMsg = lang === 'en'\n      ? '‚ùå All fields are required: name, messageA, and messageB'\n      : '‚ùå Semua medan diperlukan: nama, mesejA, dan mesejB';\n    await ctx.reply(errorMsg);\n    return;\n  }\n\n  const abTests = await db.read('ab_tests.json') || [];\n  \n  const newTest = {\n    id: generateId('ABT'),\n    name,\n    messageA,\n    messageB,\n    results: {\n      a: { sent: 0, clicks: 0 },\n      b: { sent: 0, clicks: 0 }\n    },\n    status: 'active',\n    createdBy: userId,\n    createdAt: new Date().toISOString()\n  };\n\n  abTests.push(newTest);\n  await db.write('ab_tests.json', abTests);\n\n  const successMsg = lang === 'en'\n    ? `‚úÖ A/B Test created successfully!\\n\\nüìù Name: ${name}\\n\\nüÖ∞Ô∏è Message A:\\n${messageA}\\n\\nüÖ±Ô∏è Message B:\\n${messageB}\\n\\nID: ${newTest.id}\\n\\nThe system will randomly send either version and track performance.`\n    : `‚úÖ Ujian A/B berjaya dicipta!\\n\\nüìù Nama: ${name}\\n\\nüÖ∞Ô∏è Mesej A:\\n${messageA}\\n\\nüÖ±Ô∏è Mesej B:\\n${messageB}\\n\\nID: ${newTest.id}\\n\\nSistem akan hantar salah satu versi secara rawak dan jejak prestasi.`;\n\n  await ctx.reply(successMsg);\n}\n\nasync function handleCreateDiscount(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const text = ctx.message.text.replace('/creatediscount', '').trim();\n  const parts = text.split(' ');\n\n  if (parts.length !== 3) {\n    const message = lang === 'en'\n      ? '‚ùå Invalid format!\\n\\nUsage: /creatediscount [code] [percentage] [maxUses]\\nExample: /creatediscount SAVE20 20 100'\n      : '‚ùå Format tidak sah!\\n\\nGuna: /creatediscount [kod] [peratusan] [maksPenggunaan]\\nContoh: /creatediscount JIMAT20 20 100';\n    await ctx.reply(message);\n    return;\n  }\n\n  const code = parts[0].toUpperCase();\n  const percentage = parseInt(parts[1]);\n  const maxUses = parseInt(parts[2]);\n\n  if (isNaN(percentage) || percentage < 1 || percentage > 100) {\n    const errorMsg = lang === 'en'\n      ? '‚ùå Percentage must be between 1 and 100!'\n      : '‚ùå Peratusan mesti antara 1 dan 100!';\n    await ctx.reply(errorMsg);\n    return;\n  }\n\n  if (isNaN(maxUses) || maxUses < 1) {\n    const errorMsg = lang === 'en'\n      ? '‚ùå Max uses must be a positive number!'\n      : '‚ùå Maks penggunaan mesti nombor positif!';\n    await ctx.reply(errorMsg);\n    return;\n  }\n\n  const discounts = await db.read('discount_codes.json') || [];\n  \n  const existing = discounts.find(d => d.code === code);\n  if (existing) {\n    const errorMsg = lang === 'en'\n      ? `‚ùå Discount code \"${code}\" already exists!`\n      : `‚ùå Kod diskaun \"${code}\" sudah wujud!`;\n    await ctx.reply(errorMsg);\n    return;\n  }\n\n  const newDiscount = {\n    code,\n    percentage,\n    maxUses,\n    used: 0,\n    createdBy: userId,\n    createdAt: new Date().toISOString(),\n    active: true\n  };\n\n  discounts.push(newDiscount);\n  await db.write('discount_codes.json', discounts);\n\n  const successMsg = lang === 'en'\n    ? `‚úÖ Discount code created successfully!\\n\\nüí∞ Code: ${code}\\nüìä Discount: ${percentage}%\\nüéØ Max Uses: ${maxUses}\\nüìà Used: 0/${maxUses}\\n\\nShare this code with your customers!`\n    : `‚úÖ Kod diskaun berjaya dicipta!\\n\\nüí∞ Kod: ${code}\\nüìä Diskaun: ${percentage}%\\nüéØ Maks Penggunaan: ${maxUses}\\nüìà Digunakan: 0/${maxUses}\\n\\nKongsi kod ini dengan pelanggan anda!`;\n\n  await ctx.reply(successMsg);\n}\n\nasync function handleCreateFlash(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n\n  const { generateId } = require('../utils/helpers');\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const text = ctx.message.text.replace('/createflash', '').trim();\n  const parts = text.split(' ');\n\n  if (parts.length !== 3) {\n    const message = lang === 'en'\n      ? '‚ùå Invalid format!\\n\\nUsage: /createflash [productId] [discount%] [duration_hours]\\nExample: /createflash PROD123 30 24'\n      : '‚ùå Format tidak sah!\\n\\nGuna: /createflash [idProduk] [diskaun%] [jam_durasi]\\nContoh: /createflash PROD123 30 24';\n    await ctx.reply(message);\n    return;\n  }\n\n  const productId = parts[0];\n  const discount = parseInt(parts[1]);\n  const durationHours = parseInt(parts[2]);\n\n  if (isNaN(discount) || discount < 1 || discount > 100) {\n    const errorMsg = lang === 'en'\n      ? '‚ùå Discount must be between 1 and 100!'\n      : '‚ùå Diskaun mesti antara 1 dan 100!';\n    await ctx.reply(errorMsg);\n    return;\n  }\n\n  if (isNaN(durationHours) || durationHours < 1) {\n    const errorMsg = lang === 'en'\n      ? '‚ùå Duration must be a positive number of hours!'\n      : '‚ùå Durasi mesti nombor jam positif!';\n    await ctx.reply(errorMsg);\n    return;\n  }\n\n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n\n  if (!product) {\n    const errorMsg = lang === 'en'\n      ? `‚ùå Product \"${productId}\" not found!`\n      : `‚ùå Produk \"${productId}\" tidak dijumpai!`;\n    await ctx.reply(errorMsg);\n    return;\n  }\n\n  const flashSales = await db.read('flash_sales.json') || [];\n  \n  const startTime = new Date().toISOString();\n  const endTime = new Date(Date.now() + durationHours * 60 * 60 * 1000).toISOString();\n\n  const newFlash = {\n    id: generateId('FLS'),\n    productId,\n    productName: product.name.en || product.name.ms || product.name,\n    discount,\n    startTime,\n    endTime,\n    createdBy: userId,\n    active: true\n  };\n\n  flashSales.push(newFlash);\n  await db.write('flash_sales.json', flashSales);\n\n  const successMsg = lang === 'en'\n    ? `‚úÖ Flash sale created successfully!\\n\\n‚ö° Product: ${newFlash.productName}\\nüí∞ Discount: ${discount}%\\n‚è∞ Duration: ${durationHours} hours\\nüìÖ Ends: ${new Date(endTime).toLocaleString()}\\n\\nID: ${newFlash.id}`\n    : `‚úÖ Jualan kilat berjaya dicipta!\\n\\n‚ö° Produk: ${newFlash.productName}\\nüí∞ Diskaun: ${discount}%\\n‚è∞ Durasi: ${durationHours} jam\\nüìÖ Tamat: ${new Date(endTime).toLocaleString()}\\n\\nID: ${newFlash.id}`;\n\n  await ctx.reply(successMsg);\n}\n\nasync function handleRepeatCampaign(ctx) {\n  const userId = ctx.from.id;\n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n\n  const { generateId } = require('../utils/helpers');\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n\n  const text = ctx.message.text.replace('/repeatcampaign', '').trim();\n  const parts = text.split(' ');\n\n  if (parts.length < 2) {\n    const message = lang === 'en'\n      ? '‚ùå Invalid format!\\n\\nUsage: /repeatcampaign [interval] [message]\\nIntervals: daily, weekly, monthly\\n\\nExample: /repeatcampaign weekly Check our new products!'\n      : '‚ùå Format tidak sah!\\n\\nGuna: /repeatcampaign [selang] [mesej]\\nSelang: daily, weekly, monthly\\n\\nContoh: /repeatcampaign weekly Lihat produk baharu kami!';\n    await ctx.reply(message);\n    return;\n  }\n\n  const interval = parts[0].toLowerCase();\n  const message = parts.slice(1).join(' ');\n\n  const allowedIntervals = ['daily', 'weekly', 'monthly'];\n  if (!allowedIntervals.includes(interval)) {\n    const errorMsg = lang === 'en'\n      ? `‚ùå Invalid interval! Must be one of: ${allowedIntervals.join(', ')}`\n      : `‚ùå Selang tidak sah! Mesti salah satu: ${allowedIntervals.join(', ')}`;\n    await ctx.reply(errorMsg);\n    return;\n  }\n\n  const repeatCampaigns = await db.read('repeat_campaigns.json') || [];\n  \n  const newCampaign = {\n    id: generateId('RPC'),\n    interval,\n    message,\n    lastSent: null,\n    nextSend: null,\n    active: true,\n    createdBy: userId,\n    createdAt: new Date().toISOString()\n  };\n\n  repeatCampaigns.push(newCampaign);\n  await db.write('repeat_campaigns.json', repeatCampaigns);\n\n  const successMsg = lang === 'en'\n    ? `‚úÖ Repeat campaign created successfully!\\n\\nüîÅ Interval: ${interval}\\nüìù Message: ${message}\\n\\nID: ${newCampaign.id}\\n\\nThe campaign will run automatically at the specified interval.`\n    : `‚úÖ Kempen berulang berjaya dicipta!\\n\\nüîÅ Selang: ${interval}\\nüìù Mesej: ${message}\\n\\nID: ${newCampaign.id}\\n\\nKempen akan berjalan secara automatik pada selang yang dinyatakan.`;\n\n  await ctx.reply(successMsg);\n}\n\nmodule.exports = {\n  handleAutoPromotePanel,\n  handleCreateBroadcast,\n  handleScheduleMessage,\n  handlePromoTemplates,\n  handleUserTargeting,\n  handlePromoAnalytics,\n  handleABTesting,\n  handleDiscountCodes,\n  handleFlashSales,\n  handleRepeatCampaigns,\n  handleActiveCampaigns,\n  handleBroadcastAll,\n  handleBroadcastActive,\n  handleBroadcastTagged,\n  handleTargetAll,\n  handleTargetActive,\n  handleTargetTagged,\n  handleTargetBuyers,\n  handlePromoDetailedReport,\n  handleCreateABTest,\n  handleABTestResults,\n  handlePauseAllCampaigns,\n  handleViewSchedule,\n  handleUsePromoTemplate,\n  handleViewDiscount,\n  handleViewFlash,\n  handleViewRepeat,\n  handleScheduleMsg,\n  handleAddPromoTemplate,\n  handleCreateABTestCommand,\n  handleCreateDiscount,\n  handleCreateFlash,\n  handleRepeatCampaign\n};\n","size_bytes":47163},"handlers/systemFunctions.js":{"content":"const db = require('../utils/database');\nconst fs = require('fs');\nconst path = require('path');\nconst config = require('../config');\nconst { logAdminAction, getAdminLogs, clearAdminLogs } = require('../utils/adminLogger');\n\nasync function isOwner(userId) {\n  const admins = await db.getAdmins();\n  return admins.owner === userId;\n}\n\nasync function handleSystemPanel(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'en' \n    ? '‚öôÔ∏è *System Functions Panel*\\n\\nAdvanced system management:'\n    : '‚öôÔ∏è *Panel Fungsi Sistem*\\n\\nPengurusan sistem lanjutan:';\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [\n          { text: lang === 'en' ? 'üìä User Stats' : 'üìä Statistik Pengguna', callback_data: 'sys_user_stats' },\n          { text: lang === 'en' ? 'üí∞ Sales Analytics' : 'üí∞ Analitik Jualan', callback_data: 'sys_sales_analytics' }\n        ],\n        [\n          { text: lang === 'en' ? 'üìù Admin Logs' : 'üìù Log Admin', callback_data: 'sys_admin_logs' },\n          { text: lang === 'en' ? 'üè• Health Check' : 'üè• Pemeriksaan Kesihatan', callback_data: 'sys_health_check' }\n        ],\n        [\n          { text: lang === 'en' ? 'üíæ Backup UI' : 'üíæ UI Backup', callback_data: 'sys_backup_ui' },\n          { text: lang === 'en' ? 'üîç Error Monitor' : 'üîç Monitor Ralat', callback_data: 'sys_error_monitor' }\n        ],\n        [\n          { text: lang === 'en' ? '‚ö° Performance' : '‚ö° Prestasi', callback_data: 'sys_performance' },\n          { text: lang === 'en' ? 'üíø Storage Usage' : 'üíø Penggunaan Storan', callback_data: 'sys_storage' }\n        ],\n        [\n          { text: lang === 'en' ? 'üì° API Limits' : 'üì° Had API', callback_data: 'sys_api_limits' },\n          { text: lang === 'en' ? 'üîî Webhook Logs' : 'üîî Log Webhook', callback_data: 'sys_webhook_logs' }\n        ],\n        [\n          { text: lang === 'en' ? 'üìà Transaction Reports' : 'üìà Laporan Transaksi', callback_data: 'sys_transaction_reports' },\n          { text: lang === 'en' ? '‚ö†Ô∏è Inventory Alerts' : '‚ö†Ô∏è Amaran Inventori', callback_data: 'sys_inventory_alerts' }\n        ],\n        [\n          { text: lang === 'en' ? 'üë• Session Analytics' : 'üë• Analitik Sesi', callback_data: 'sys_session_analytics' },\n          { text: lang === 'en' ? 'üìä User Engagement' : 'üìä Penglibatan Pengguna', callback_data: 'sys_engagement' }\n        ],\n        [\n          { text: lang === 'en' ? 'üíµ Revenue Dashboard' : 'üíµ Papan Pemuka Hasil', callback_data: 'sys_revenue' },\n          { text: lang === 'en' ? 'üì§ Export Data' : 'üì§ Eksport Data', callback_data: 'sys_export' }\n        ],\n        [\n          { text: lang === 'en' ? 'üì• Import Data' : 'üì• Import Data', callback_data: 'sys_import' },\n          { text: lang === 'en' ? '‚öôÔ∏è System Settings' : '‚öôÔ∏è Tetapan Sistem', callback_data: 'sys_settings' }\n        ],\n        [\n          { text: lang === 'en' ? 'üè™ Store Status' : 'üè™ Status Kedai', callback_data: 'store_status' },\n          { text: lang === 'en' ? 'üîß Maintenance Mode' : 'üîß Mod Penyelenggaraan', callback_data: 'sys_maintenance' }\n        ],\n        [\n          { text: lang === 'en' ? 'üóëÔ∏è Cache Management' : 'üóëÔ∏è Pengurusan Cache', callback_data: 'sys_cache' }\n        ],\n        [{ text: lang === 'en' ? 'üîô Back to Owner' : 'üîô Kembali ke Owner', callback_data: 'owner_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleUserStats(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const users = await db.getUsers();\n  const admins = users.filter(u => u.isAdmin);\n  const banned = users.filter(u => u.banned);\n  const activeUsers = users.filter(u => {\n    const lastActive = new Date(u.lastActive || 0);\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    return lastActive > thirtyDaysAgo;\n  });\n\n  const message = lang === 'en'\n    ? `üìä *User Statistics*\\n\\nüë• Total Users: ${users.length}\\nüë®‚Äçüíº Admins: ${admins.length}\\nüö´ Banned: ${banned.length}\\n‚úÖ Active (30d): ${activeUsers.length}\\nüí§ Inactive: ${users.length - activeUsers.length}\\n\\nüìà Growth Rate: ${((activeUsers.length / users.length) * 100).toFixed(1)}% active`\n    : `üìä *Statistik Pengguna*\\n\\nüë• Jumlah Pengguna: ${users.length}\\nüë®‚Äçüíº Admin: ${admins.length}\\nüö´ Dilarang: ${banned.length}\\n‚úÖ Aktif (30h): ${activeUsers.length}\\nüí§ Tidak Aktif: ${users.length - activeUsers.length}\\n\\nüìà Kadar Pertumbuhan: ${((activeUsers.length / users.length) * 100).toFixed(1)}% aktif`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üì• Export Users' : 'üì• Eksport Pengguna', callback_data: 'export_users' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleSalesAnalytics(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const completed = transactions.filter(t => t.status === 'completed');\n  const totalRevenue = completed.reduce((sum, t) => sum + (t.price || 0), 0);\n  const avgOrder = completed.length > 0 ? (totalRevenue / completed.length).toFixed(2) : 0;\n\n  const today = new Date().toISOString().split('T')[0];\n  const todayOrders = completed.filter(t => t.createdAt?.startsWith(today));\n  const todayRevenue = todayOrders.reduce((sum, t) => sum + (t.price || 0), 0);\n\n  const message = lang === 'en'\n    ? `üí∞ *Sales Analytics*\\n\\nüì¶ Total Orders: ${transactions.length}\\n‚úÖ Completed: ${completed.length}\\nüíµ Total Revenue: ${config.store.currency} ${totalRevenue.toFixed(2)}\\nüìä Average Order: ${config.store.currency} ${avgOrder}\\n\\nüìÖ Today:\\n   Orders: ${todayOrders.length}\\n   Revenue: ${config.store.currency} ${todayRevenue.toFixed(2)}`\n    : `üí∞ *Analitik Jualan*\\n\\nüì¶ Jumlah Pesanan: ${transactions.length}\\n‚úÖ Selesai: ${completed.length}\\nüíµ Jumlah Hasil: ${config.store.currency} ${totalRevenue.toFixed(2)}\\nüìä Purata Pesanan: ${config.store.currency} ${avgOrder}\\n\\nüìÖ Hari Ini:\\n   Pesanan: ${todayOrders.length}\\n   Hasil: ${config.store.currency} ${todayRevenue.toFixed(2)}`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üìà Detailed Report' : 'üìà Laporan Terperinci', callback_data: 'detailed_sales_report' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleAdminLogs(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const { logs, total } = await getAdminLogs(20);\n  const users = await db.getUsers();\n  \n  let message = lang === 'en' \n    ? `üìù *Admin Activity Logs*\\n\\nTotal Actions: ${total}\\nShowing: Last ${logs.length}\\n\\n`\n    : `üìù *Log Aktiviti Admin*\\n\\nJumlah Tindakan: ${total}\\nMenunjukkan: ${logs.length} terkini\\n\\n`;\n  \n  if (logs.length === 0) {\n    message += lang === 'en' ? 'No admin activity logged yet.' : 'Tiada aktiviti admin dilog lagi.';\n  } else {\n    message += lang === 'en' ? 'Recent Activity:\\n\\n' : 'Aktiviti Terkini:\\n\\n';\n    logs.slice(0, 10).forEach((l, i) => {\n      const admin = users.find(u => u.id === l.adminId);\n      const adminName = admin ? (admin.username || admin.first_name || l.adminId) : l.adminId;\n      const time = new Date(l.timestamp).toLocaleString();\n      message += `${i+1}. ${l.action}\\n`;\n      message += `   üë§ Admin: ${adminName}\\n`;\n      if (l.details) message += `   üìù ${l.details}\\n`;\n      message += `   üïê ${time}\\n\\n`;\n    });\n  }\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üóëÔ∏è Clear Logs' : 'üóëÔ∏è Padam Log', callback_data: 'clear_admin_logs' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleHealthCheck(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const uptime = process.uptime();\n  const memory = process.memoryUsage();\n  \n  const dbFiles = ['users.json', 'products.json', 'transactions.json', 'categories.json'];\n  const dbStatus = {};\n  for (const file of dbFiles) {\n    try {\n      const data = await db.read(file);\n      dbStatus[file] = data ? '‚úÖ OK' : '‚ö†Ô∏è Empty';\n    } catch {\n      dbStatus[file] = '‚ùå Error';\n    }\n  }\n\n  const message = lang === 'en'\n    ? `üè• *System Health Check*\\n\\n‚è± Uptime: ${Math.floor(uptime / 3600)}h ${Math.floor((uptime % 3600) / 60)}m\\nüíæ Memory: ${(memory.heapUsed / 1024 / 1024).toFixed(2)} MB\\n\\nüìÅ Database Status:\\n${Object.entries(dbStatus).map(([k, v]) => `${v} ${k}`).join('\\n')}\\n\\n‚úÖ System Status: Healthy`\n    : `üè• *Pemeriksaan Kesihatan Sistem*\\n\\n‚è± Masa Aktif: ${Math.floor(uptime / 3600)}j ${Math.floor((uptime % 3600) / 60)}m\\nüíæ Memori: ${(memory.heapUsed / 1024 / 1024).toFixed(2)} MB\\n\\nüìÅ Status Pangkalan Data:\\n${Object.entries(dbStatus).map(([k, v]) => `${v} ${k}`).join('\\n')}\\n\\n‚úÖ Status Sistem: Sihat`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîÑ Refresh' : 'üîÑ Segar Semula', callback_data: 'sys_health_check' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleStorageUsage(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const getDirectorySize = (dir) => {\n    let size = 0;\n    if (fs.existsSync(dir)) {\n      const files = fs.readdirSync(dir);\n      files.forEach(file => {\n        const filePath = path.join(dir, file);\n        const stats = fs.statSync(filePath);\n        if (stats.isDirectory()) {\n          size += getDirectorySize(filePath);\n        } else {\n          size += stats.size;\n        }\n      });\n    }\n    return size;\n  };\n\n  const dataSize = getDirectorySize('./data');\n  const mediaSize = getDirectorySize('./media');\n  const backupSize = getDirectorySize('./data/backup');\n  const totalSize = dataSize + mediaSize;\n\n  const message = lang === 'en'\n    ? `üíø *Storage Usage*\\n\\nüìÅ Data: ${(dataSize / 1024 / 1024).toFixed(2)} MB\\nüñº Media: ${(mediaSize / 1024 / 1024).toFixed(2)} MB\\nüíæ Backups: ${(backupSize / 1024 / 1024).toFixed(2)} MB\\n\\nüìä Total: ${(totalSize / 1024 / 1024).toFixed(2)} MB`\n    : `üíø *Penggunaan Storan*\\n\\nüìÅ Data: ${(dataSize / 1024 / 1024).toFixed(2)} MB\\nüñº Media: ${(mediaSize / 1024 / 1024).toFixed(2)} MB\\nüíæ Backup: ${(backupSize / 1024 / 1024).toFixed(2)} MB\\n\\nüìä Jumlah: ${(totalSize / 1024 / 1024).toFixed(2)} MB`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üóëÔ∏è Clean Backups' : 'üóëÔ∏è Bersih Backup', callback_data: 'clean_old_backups' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleExportData(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'en'\n    ? `üì§ *Export Data*\\n\\nExport your data in JSON or CSV format:\\n\\nCommands:\\n/export users\\n/export products\\n/export transactions\\n/export all`\n    : `üì§ *Eksport Data*\\n\\nEksport data anda dalam format JSON atau CSV:\\n\\nArahan:\\n/export users\\n/export products\\n/export transactions\\n/export all`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [\n          { text: lang === 'en' ? 'üë• Users' : 'üë• Pengguna', callback_data: 'export_users' },\n          { text: lang === 'en' ? 'üì¶ Products' : 'üì¶ Produk', callback_data: 'export_products' }\n        ],\n        [\n          { text: lang === 'en' ? 'üí≥ Transactions' : 'üí≥ Transaksi', callback_data: 'export_transactions' },\n          { text: lang === 'en' ? 'üìä All Data' : 'üìä Semua Data', callback_data: 'export_all' }\n        ],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleMaintenanceMode(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const settings = await db.getSettings();\n  const isMaintenanceMode = settings.maintenanceMode || false;\n\n  const message = lang === 'en'\n    ? `üîß *Maintenance Mode*\\n\\nCurrent Status: ${isMaintenanceMode ? 'üî¥ ACTIVE' : 'üü¢ INACTIVE'}\\n\\n${isMaintenanceMode ? 'Bot is currently in maintenance mode. Only admins can use it.' : 'Bot is running normally for all users.'}`\n    : `üîß *Mod Penyelenggaraan*\\n\\nStatus Semasa: ${isMaintenanceMode ? 'üî¥ AKTIF' : 'üü¢ TIDAK AKTIF'}\\n\\n${isMaintenanceMode ? 'Bot sedang dalam mod penyelenggaraan. Hanya admin boleh guna.' : 'Bot berjalan normal untuk semua pengguna.'}`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ \n          text: isMaintenanceMode \n            ? (lang === 'en' ? 'üü¢ Disable Maintenance' : 'üü¢ Matikan Penyelenggaraan')\n            : (lang === 'en' ? 'üî¥ Enable Maintenance' : 'üî¥ Aktifkan Penyelenggaraan'), \n          callback_data: 'toggle_maintenance' \n        }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleBackupUI(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const backups = fs.existsSync('./data/backup') ? fs.readdirSync('./data/backup').filter(f => f.endsWith('.zip')) : [];\n  \n  const message = lang === 'en'\n    ? `üíæ *Backup Management*\\n\\nüì¶ Total Backups: ${backups.length}\\n‚è∞ Interval: ${config.backup?.interval / 60000 || 5} minutes\\n‚úÖ Status: ${config.backup?.enabled ? 'Enabled' : 'Disabled'}\\n\\nUse /backupnow for manual backup`\n    : `üíæ *Pengurusan Backup*\\n\\nüì¶ Jumlah Backup: ${backups.length}\\n‚è∞ Selang: ${config.backup?.interval / 60000 || 5} minit\\n‚úÖ Status: ${config.backup?.enabled ? 'Aktif' : 'Tidak Aktif'}\\n\\nGuna /backupnow untuk backup manual`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üì• Manual Backup' : 'üì• Backup Manual', callback_data: 'trigger_manual_backup' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleErrorMonitor(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'en'\n    ? `üîç *Error Monitor*\\n\\n‚úÖ No critical errors detected\\nüìä System running normally\\n\\nCheck logs for detailed information`\n    : `üîç *Monitor Ralat*\\n\\n‚úÖ Tiada ralat kritikal dikesan\\nüìä Sistem berjalan normal\\n\\nSemak log untuk maklumat terperinci`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handlePerformance(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const uptime = process.uptime();\n  const memory = process.memoryUsage();\n  \n  const message = lang === 'en'\n    ? `‚ö° *Performance Metrics*\\n\\n‚è± Uptime: ${Math.floor(uptime / 3600)}h ${Math.floor((uptime % 3600) / 60)}m\\nüíæ Memory: ${(memory.heapUsed / 1024 / 1024).toFixed(2)} MB / ${(memory.heapTotal / 1024 / 1024).toFixed(2)} MB\\nüìä CPU: Normal\\nüîÑ Response Time: <100ms`\n    : `‚ö° *Metrik Prestasi*\\n\\n‚è± Masa Aktif: ${Math.floor(uptime / 3600)}j ${Math.floor((uptime % 3600) / 60)}m\\nüíæ Memori: ${(memory.heapUsed / 1024 / 1024).toFixed(2)} MB / ${(memory.heapTotal / 1024 / 1024).toFixed(2)} MB\\nüìä CPU: Normal\\nüîÑ Masa Respons: <100ms`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîÑ Refresh' : 'üîÑ Segar Semula', callback_data: 'sys_performance' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleAPILimits(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'en'\n    ? `üì° *API Rate Limits*\\n\\nü§ñ Telegram Bot API:\\n   ‚úÖ Within limits\\n   üìä ~30 req/sec allowed\\n\\n‚òÅÔ∏è Dropbox API:\\n   ‚úÖ OAuth active\\n   üìä No rate limit issues`\n    : `üì° *Had Kadar API*\\n\\nü§ñ API Bot Telegram:\\n   ‚úÖ Dalam had\\n   üìä ~30 req/saat dibenarkan\\n\\n‚òÅÔ∏è API Dropbox:\\n   ‚úÖ OAuth aktif\\n   üìä Tiada isu had kadar`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleWebhookLogs(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'en'\n    ? `üîî *Webhook Logs*\\n\\nüìä Total Requests: 0\\n‚úÖ No webhooks configured\\n\\nBot uses long-polling mode`\n    : `üîî *Log Webhook*\\n\\nüìä Jumlah Permintaan: 0\\n‚úÖ Tiada webhook dikonfigurasi\\n\\nBot guna mod long-polling`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleTransactionReports(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const today = new Date().toISOString().split('T')[0];\n  const thisMonth = new Date().toISOString().substring(0, 7);\n  \n  const todayTx = transactions.filter(t => t.createdAt?.startsWith(today));\n  const monthTx = transactions.filter(t => t.createdAt?.startsWith(thisMonth));\n  \n  const message = lang === 'en'\n    ? `üìà *Transaction Reports*\\n\\nüìÖ Today: ${todayTx.length} orders\\nüìÜ This Month: ${monthTx.length} orders\\nüìä Total: ${transactions.length} orders\\n\\nUse /export transactions for detailed report`\n    : `üìà *Laporan Transaksi*\\n\\nüìÖ Hari Ini: ${todayTx.length} pesanan\\nüìÜ Bulan Ini: ${monthTx.length} pesanan\\nüìä Jumlah: ${transactions.length} pesanan\\n\\nGuna /export transactions untuk laporan terperinci`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üì• Export Report' : 'üì• Eksport Laporan', callback_data: 'export_transactions' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleInventoryAlerts(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const lowStock = products.filter(p => p.stock < 5);\n  const outOfStock = products.filter(p => p.stock === 0);\n  \n  const message = lang === 'en'\n    ? `‚ö†Ô∏è *Inventory Alerts*\\n\\nüî¥ Out of Stock: ${outOfStock.length}\\nüü° Low Stock (<5): ${lowStock.length}\\n‚úÖ Total Products: ${products.length}\\n\\n${lowStock.slice(0, 5).map(p => `‚Ä¢ ${p.name?.ms || p.name} (${p.stock})`).join('\\n')}`\n    : `‚ö†Ô∏è *Amaran Inventori*\\n\\nüî¥ Kehabisan Stok: ${outOfStock.length}\\nüü° Stok Rendah (<5): ${lowStock.length}\\n‚úÖ Jumlah Produk: ${products.length}\\n\\n${lowStock.slice(0, 5).map(p => `‚Ä¢ ${p.name?.ms || p.name} (${p.stock})`).join('\\n')}`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleSessionAnalytics(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const sessions = await db.getSessions();\n  const active = sessions.filter(s => s.status === 'active');\n  const closed = sessions.filter(s => s.status === 'closed');\n  \n  const message = lang === 'en'\n    ? `üë• *Session Analytics*\\n\\nüü¢ Active Sessions: ${active.length}\\nüìä Total Sessions: ${sessions.length}\\n‚úÖ Closed: ${closed.length}\\nüìà Avg. Session Time: N/A`\n    : `üë• *Analitik Sesi*\\n\\nüü¢ Sesi Aktif: ${active.length}\\nüìä Jumlah Sesi: ${sessions.length}\\n‚úÖ Ditutup: ${closed.length}\\nüìà Purata Masa Sesi: T/A`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleEngagement(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const users = await db.getUsers();\n  const transactions = await db.getTransactions();\n  const sessions = await db.getSessions();\n  \n  const engagementRate = users.length > 0 ? ((transactions.length / users.length) * 100).toFixed(1) : 0;\n  \n  const message = lang === 'en'\n    ? `üìä *User Engagement Metrics*\\n\\nüë• Total Users: ${users.length}\\nüõçÔ∏è Orders: ${transactions.length}\\nüí¨ Support Sessions: ${sessions.length}\\nüìà Engagement Rate: ${engagementRate}%`\n    : `üìä *Metrik Penglibatan Pengguna*\\n\\nüë• Jumlah Pengguna: ${users.length}\\nüõçÔ∏è Pesanan: ${transactions.length}\\nüí¨ Sesi Sokongan: ${sessions.length}\\nüìà Kadar Penglibatan: ${engagementRate}%`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleRevenue(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const completed = transactions.filter(t => t.status === 'completed');\n  const totalRevenue = completed.reduce((sum, t) => sum + (t.price || 0), 0);\n  \n  const today = new Date().toISOString().split('T')[0];\n  const todayRevenue = completed.filter(t => t.createdAt?.startsWith(today)).reduce((sum, t) => sum + (t.price || 0), 0);\n  \n  const message = lang === 'en'\n    ? `üíµ *Revenue Dashboard*\\n\\nüí∞ Total Revenue: ${config.store.currency} ${totalRevenue.toFixed(2)}\\nüìÖ Today: ${config.store.currency} ${todayRevenue.toFixed(2)}\\nüìä Orders: ${completed.length}\\nüìà Avg. Order: ${config.store.currency} ${(completed.length > 0 ? totalRevenue / completed.length : 0).toFixed(2)}`\n    : `üíµ *Papan Pemuka Hasil*\\n\\nüí∞ Jumlah Hasil: ${config.store.currency} ${totalRevenue.toFixed(2)}\\nüìÖ Hari Ini: ${config.store.currency} ${todayRevenue.toFixed(2)}\\nüìä Pesanan: ${completed.length}\\nüìà Purata Pesanan: ${config.store.currency} ${(completed.length > 0 ? totalRevenue / completed.length : 0).toFixed(2)}`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üìà Detailed Report' : 'üìà Laporan Terperinci', callback_data: 'detailed_revenue_report' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleImportData(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'en'\n    ? `üì• *Import Data*\\n\\nSend JSON file to import:\\n\\n‚Ä¢ Users\\n‚Ä¢ Products\\n‚Ä¢ Categories\\n‚Ä¢ Transactions\\n\\nFormat: Send file with caption /import [type]`\n    : `üì• *Import Data*\\n\\nHantar fail JSON untuk import:\\n\\n‚Ä¢ Pengguna\\n‚Ä¢ Produk\\n‚Ä¢ Kategori\\n‚Ä¢ Transaksi\\n\\nFormat: Hantar fail dengan caption /import [jenis]`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleSystemSettings(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const settings = await db.getSettings();\n  const storeStatus = settings.storeOpen !== false ? (lang === 'en' ? 'OPEN' : 'BUKA') : (lang === 'en' ? 'CLOSED' : 'TUTUP');\n  \n  const message = lang === 'en'\n    ? `‚öôÔ∏è *System Settings*\\n\\nüè™ Store: ${settings.storeName}\\nüí± Currency: ${config.store.currency}\\nüåê Language: ${settings.defaultLanguage}\\n‚è∞ Backup: ${config.backup?.interval / 60000}min\\nüîß Maintenance: ${settings.maintenanceMode ? 'ON' : 'OFF'}\\nüè™ Store Status: ${storeStatus}`\n    : `‚öôÔ∏è *Tetapan Sistem*\\n\\nüè™ Kedai: ${settings.storeName}\\nüí± Matawang: ${config.store.currency}\\nüåê Bahasa: ${settings.defaultLanguage}\\n‚è∞ Backup: ${config.backup?.interval / 60000}min\\nüîß Penyelenggaraan: ${settings.maintenanceMode ? 'HIDUP' : 'MATI'}\\nüè™ Status Kedai: ${storeStatus}`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? '‚úèÔ∏è Edit Settings' : '‚úèÔ∏è Edit Tetapan', callback_data: 'edit_system_settings' }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleCacheManagement(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'en'\n    ? `üóëÔ∏è *Cache Management*\\n\\nüìä No cache system configured\\n‚úÖ Bot uses direct database access\\n\\nFor performance optimization, consider implementing Redis cache`\n    : `üóëÔ∏è *Pengurusan Cache*\\n\\nüìä Tiada sistem cache dikonfigurasi\\n‚úÖ Bot guna akses pangkalan data terus\\n\\nUntuk pengoptimuman prestasi, pertimbang implementasi cache Redis`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleExportUsers(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  try {\n    const users = await db.getUsers();\n    const jsonData = JSON.stringify(users, null, 2);\n    \n    const message = lang === 'en' \n      ? `üì• *Users Data Export*\\n\\nüë• Total: ${users.length} users\\n\\nDownloading...`\n      : `üì• *Eksport Data Pengguna*\\n\\nüë• Jumlah: ${users.length} pengguna\\n\\nMemuat turun...`;\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    \n    await ctx.replyWithDocument({\n      source: Buffer.from(jsonData),\n      filename: `users_export_${new Date().toISOString().split('T')[0]}.json`\n    });\n  } catch (error) {\n    console.error('Export users error:', error);\n    const errorMsg = lang === 'en' ? '‚ùå Export failed!' : '‚ùå Eksport gagal!';\n    await ctx.reply(errorMsg);\n  }\n}\n\nasync function handleExportProducts(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  try {\n    const products = await db.getProducts();\n    const jsonData = JSON.stringify(products, null, 2);\n    \n    const message = lang === 'en' \n      ? `üì• *Products Data Export*\\n\\nüì¶ Total: ${products.length} products\\n\\nDownloading...`\n      : `üì• *Eksport Data Produk*\\n\\nüì¶ Jumlah: ${products.length} produk\\n\\nMemuat turun...`;\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    \n    await ctx.replyWithDocument({\n      source: Buffer.from(jsonData),\n      filename: `products_export_${new Date().toISOString().split('T')[0]}.json`\n    });\n  } catch (error) {\n    console.error('Export products error:', error);\n    const errorMsg = lang === 'en' ? '‚ùå Export failed!' : '‚ùå Eksport gagal!';\n    await ctx.reply(errorMsg);\n  }\n}\n\nasync function handleExportTransactions(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  try {\n    const transactions = await db.getTransactions();\n    const jsonData = JSON.stringify(transactions, null, 2);\n    \n    const message = lang === 'en' \n      ? `üì• *Transactions Data Export*\\n\\nüí≥ Total: ${transactions.length} transactions\\n\\nDownloading...`\n      : `üì• *Eksport Data Transaksi*\\n\\nüí≥ Jumlah: ${transactions.length} transaksi\\n\\nMemuat turun...`;\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    \n    await ctx.replyWithDocument({\n      source: Buffer.from(jsonData),\n      filename: `transactions_export_${new Date().toISOString().split('T')[0]}.json`\n    });\n  } catch (error) {\n    console.error('Export transactions error:', error);\n    const errorMsg = lang === 'en' ? '‚ùå Export failed!' : '‚ùå Eksport gagal!';\n    await ctx.reply(errorMsg);\n  }\n}\n\nasync function handleExportAll(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  try {\n    const users = await db.getUsers();\n    const products = await db.getProducts();\n    const transactions = await db.getTransactions();\n    const categories = await db.getCategories();\n    const settings = await db.getSettings();\n    \n    const allData = {\n      exportDate: new Date().toISOString(),\n      users,\n      products,\n      transactions,\n      categories,\n      settings\n    };\n    \n    const jsonData = JSON.stringify(allData, null, 2);\n    \n    const message = lang === 'en' \n      ? `üì• *Complete Data Export*\\n\\nüë• Users: ${users.length}\\nüì¶ Products: ${products.length}\\nüí≥ Transactions: ${transactions.length}\\nüìÇ Categories: ${categories.length}\\n\\nDownloading...`\n      : `üì• *Eksport Data Lengkap*\\n\\nüë• Pengguna: ${users.length}\\nüì¶ Produk: ${products.length}\\nüí≥ Transaksi: ${transactions.length}\\nüìÇ Kategori: ${categories.length}\\n\\nMemuat turun...`;\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    \n    await ctx.replyWithDocument({\n      source: Buffer.from(jsonData),\n      filename: `complete_export_${new Date().toISOString().split('T')[0]}.json`\n    });\n  } catch (error) {\n    console.error('Export all error:', error);\n    const errorMsg = lang === 'en' ? '‚ùå Export failed!' : '‚ùå Eksport gagal!';\n    await ctx.reply(errorMsg);\n  }\n}\n\nasync function handleStoreStatus(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const settings = await db.getSettings();\n  const isOpen = settings.storeOpen !== false;\n\n  const message = lang === 'en'\n    ? `üè™ *Store Status*\\n\\nCurrent Status: ${isOpen ? 'üü¢ OPEN' : 'üî¥ CLOSED'}\\n\\n${isOpen ? 'Store is currently open. Customers can place orders.' : 'Store is currently closed. Customers cannot place orders.'}`\n    : `üè™ *Status Kedai*\\n\\nStatus Semasa: ${isOpen ? 'üü¢ BUKA' : 'üî¥ TUTUP'}\\n\\n${isOpen ? 'Kedai sedang buka. Pelanggan boleh buat pesanan.' : 'Kedai sedang tutup. Pelanggan tidak boleh buat pesanan.'}`;\n\n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [\n        [{ \n          text: isOpen \n            ? (lang === 'en' ? 'üî¥ Close Store' : 'üî¥ Tutup Kedai')\n            : (lang === 'en' ? 'üü¢ Open Store' : 'üü¢ Buka Kedai'), \n          callback_data: 'toggle_store_status' \n        }],\n        [{ text: lang === 'en' ? 'üîô Back' : 'üîô Kembali', callback_data: 'system_panel' }]\n      ]\n    }\n  });\n}\n\nasync function handleToggleStoreStatus(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const settings = await db.getSettings();\n  const currentStatus = settings.storeOpen !== false;\n  const newStatus = !currentStatus;\n  \n  settings.storeOpen = newStatus;\n  await db.saveSettings(settings);\n  \n  const message = lang === 'en'\n    ? `‚úÖ Store status updated!\\n\\n${newStatus ? 'üü¢ Store is now OPEN' : 'üî¥ Store is now CLOSED'}`\n    : `‚úÖ Status kedai dikemaskini!\\n\\n${newStatus ? 'üü¢ Kedai kini BUKA' : 'üî¥ Kedai kini TUTUP'}`;\n  \n  await ctx.answerCbQuery(message);\n  await handleStoreStatus(ctx);\n}\n\nasync function handleToggleMaintenance(ctx) {\n  const userId = ctx.from.id;\n  if (!await isOwner(userId)) return;\n\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const settings = await db.getSettings();\n  const currentStatus = settings.maintenanceMode || false;\n  const newStatus = !currentStatus;\n  \n  settings.maintenanceMode = newStatus;\n  await db.saveSettings(settings);\n  \n  const message = lang === 'en'\n    ? `‚úÖ Maintenance mode updated!\\n\\n${newStatus ? 'üî¥ Maintenance mode ACTIVE' : 'üü¢ Maintenance mode INACTIVE'}`\n    : `‚úÖ Mod penyelenggaraan dikemaskini!\\n\\n${newStatus ? 'üî¥ Mod penyelenggaraan AKTIF' : 'üü¢ Mod penyelenggaraan TIDAK AKTIF'}`;\n  \n  await ctx.answerCbQuery(message);\n  await handleMaintenanceMode(ctx);\n}\n\nmodule.exports = {\n  handleSystemPanel,\n  handleUserStats,\n  handleSalesAnalytics,\n  handleAdminLogs,\n  handleHealthCheck,\n  handleStorageUsage,\n  handleExportData,\n  handleMaintenanceMode,\n  handleBackupUI,\n  handleErrorMonitor,\n  handlePerformance,\n  handleAPILimits,\n  handleWebhookLogs,\n  handleTransactionReports,\n  handleInventoryAlerts,\n  handleSessionAnalytics,\n  handleEngagement,\n  handleRevenue,\n  handleImportData,\n  handleSystemSettings,\n  handleCacheManagement,\n  handleExportUsers,\n  handleExportProducts,\n  handleExportTransactions,\n  handleExportAll,\n  handleStoreStatus,\n  handleToggleStoreStatus,\n  handleToggleMaintenance\n};\n","size_bytes":35767},"utils/dropboxOAuth.js":{"content":"const { Dropbox } = require('dropbox');\n\nlet connectionSettings = null;\n\nasync function getAccessToken() {\n  if (connectionSettings && connectionSettings.settings.expires_at && new Date(connectionSettings.settings.expires_at).getTime() > Date.now()) {\n    return connectionSettings.settings.access_token;\n  }\n  \n  const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  try {\n    const res = await fetch(\n      'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=dropbox',\n      {\n        headers: {\n          'Accept': 'application/json',\n          'X_REPLIT_TOKEN': xReplitToken\n        }\n      }\n    );\n\n    if (!res.ok) {\n      throw new Error(`Replit connector API error: ${res.status} ${res.statusText}`);\n    }\n\n    const data = await res.json();\n    connectionSettings = data.items?.[0];\n\n    const accessToken = connectionSettings?.settings?.access_token || connectionSettings?.settings?.oauth?.credentials?.access_token;\n\n    if (!connectionSettings || !accessToken) {\n      throw new Error('Dropbox not connected');\n    }\n    return accessToken;\n  } catch (error) {\n    console.error('Error fetching Dropbox access token:', error.message);\n    throw new Error(`Failed to get Dropbox access token: ${error.message}`);\n  }\n}\n\nasync function getUncachableDropboxClient() {\n  const accessToken = await getAccessToken();\n  return new Dropbox({ accessToken });\n}\n\nmodule.exports = { getUncachableDropboxClient, getAccessToken };\n","size_bytes":1745},"DROPBOX_SETUP.md":{"content":"# Panduan Setup Dropbox Token untuk Pterodactyl Panel\n# Dropbox Token Setup Guide for Pterodactyl Panel\n\n## Bahasa Melayu\n\n### Langkah 1: Buat Dropbox App\n1. Pergi ke [Dropbox Developers Console](https://www.dropbox.com/developers/apps)\n2. Klik **\"Create app\"**\n3. Pilih **\"Scoped access\"**\n4. Pilih **\"Full Dropbox\"** untuk access type\n5. Beri nama app anda (contoh: `CexiStore-Backup`)\n6. Klik **\"Create app\"**\n\n### Langkah 2: Dapatkan Access Token\n1. Dalam halaman app yang baru dibuat, scroll ke bahagian **\"OAuth 2\"**\n2. Cari section **\"Generated access token\"**\n3. Klik **\"Generate\"** button\n4. Copy token yang dipaparkan (ia bermula dengan `sl.` atau serupa)\n5. **PENTING**: Simpan token ini dengan selamat, ia tidak akan dipaparkan lagi!\n\n### Langkah 3: Set Permissions (Jika Perlu)\n1. Pergi ke tab **\"Permissions\"**\n2. Pastikan permissions berikut di-enable:\n   - `files.metadata.write`\n   - `files.metadata.read`\n   - `files.content.write`\n   - `files.content.read`\n3. Klik **\"Submit\"** jika ada perubahan\n\n### Langkah 4: Setup Token (Guna Command `/addapi`)\n1. Start bot anda\n2. Login sebagai owner dalam Telegram\n3. Gunakan command:\n   ```\n   /addapi sl.your_token_from_step_2\n   ```\n4. Bot akan auto save dan reload\n\n### Langkah 5: Verify Setup\n1. Selepas guna `/addapi`, check console logs - sepatutnya ada mesej:\n   ```\n   ‚úÖ Using Dropbox token from settings (/addapi)\n   ‚úÖ Storage providers initialized (Dropbox: OK)\n   ```\n2. Test backup dengan command `/backupnow` dalam Telegram bot\n\n---\n\n## English\n\n### Step 1: Create Dropbox App\n1. Go to [Dropbox Developers Console](https://www.dropbox.com/developers/apps)\n2. Click **\"Create app\"**\n3. Choose **\"Scoped access\"**\n4. Select **\"Full Dropbox\"** for access type\n5. Name your app (example: `CexiStore-Backup`)\n6. Click **\"Create app\"**\n\n### Step 2: Get Access Token\n1. In your newly created app page, scroll to **\"OAuth 2\"** section\n2. Find the **\"Generated access token\"** section\n3. Click the **\"Generate\"** button\n4. Copy the displayed token (starts with `sl.` or similar)\n5. **IMPORTANT**: Save this token securely, it won't be shown again!\n\n### Step 3: Set Permissions (If Needed)\n1. Go to **\"Permissions\"** tab\n2. Ensure these permissions are enabled:\n   - `files.metadata.write`\n   - `files.metadata.read`\n   - `files.content.write`\n   - `files.content.read`\n3. Click **\"Submit\"** if you made changes\n\n### Step 4: Setup Token (Use `/addapi` Command)\n1. Start your bot\n2. Login as owner in Telegram\n3. Use command:\n   ```\n   /addapi sl.your_token_from_step_2\n   ```\n4. Bot will auto save and reload\n\n### Step 5: Verify Setup\n1. After using `/addapi`, check console logs - should see:\n   ```\n   ‚úÖ Using Dropbox token from settings (/addapi)\n   ‚úÖ Storage providers initialized (Dropbox: OK)\n   ```\n2. Test backup with `/backupnow` command in Telegram bot\n\n---\n\n## Troubleshooting\n\n### ‚ùå \"Dropbox token not configured\"\n- Guna command `/addapi [token]` untuk set token\n- Check token tidak expired atau invalid (generate baru jika perlu)\n- Token akan auto save ke settings.json\n\n### ‚ùå \"Dropbox upload failed\"\n- Check internet connection\n- Verify token masih valid (generate baru jika perlu)\n- Pastikan Dropbox storage tidak penuh\n\n### ‚ùå \"Dropbox list failed: path/not_found\"\n- Folder `/backups` akan dibuat auto pada backup pertama\n- Cuba jalankan `/backupnow` sekali untuk create folder\n\n---\n\n## Notes\n- Token ini adalah **permanent** (tidak expired) kecuali anda revoke secara manual\n- Jangan share token dengan orang lain\n- Jika token leaked, revoke segera di Dropbox Developers Console\n- Bot akan auto-create folder `/backups` di Dropbox anda\n","size_bytes":3630},"CONFIG_SETUP.md":{"content":"# üîß Setup Config Tokens (NO REPLIT AUTH)\n\n## Bahasa Melayu\n\n### Kaedah 1: Terus di config.js (RECOMMENDED)\n\nEdit file `config.js`:\n\n```javascript\nmodule.exports = {\n  // 1. TELEGRAM BOT TOKEN (WAJIB!)\n  TELEGRAM_BOT_TOKEN: '8285430975:AAFxk17EnyAHonkeaYVKOAW4ZJLAjeBFzMQ',\n  \n  // 2. DROPBOX TOKEN (Optional - untuk backup)\n  DROPBOX_TOKEN: 'sl.BxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxA',\n  \n  // 3. GOOGLE DRIVE TOKEN (Optional - backup failover)\n  GOOGLE_DRIVE_TOKEN: 'ya29.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',\n  \n  OWNER_ID: 8253048034, // Tukar dengan ID Telegram anda\n  // ... rest of config\n};\n```\n\n### Kaedah 2: Guna file .env\n\n1. Copy `.env.example` ke `.env`:\n   ```bash\n   cp .env.example .env\n   ```\n\n2. Edit `.env` dan masukkan tokens:\n   ```\n   TELEGRAM_BOT_TOKEN=8285430975:AAFxk17EnyAHonkeaYVKOAW4ZJLAjeBFzMQ\n   DROPBOX_TOKEN=sl.BxxxxxxxxxxxxxxxxxA\n   GOOGLE_DRIVE_TOKEN=ya29.xxxxxxxx\n   ```\n\n### Cara Dapatkan Tokens:\n\n#### 1. Telegram Bot Token\n1. Buka Telegram, cari @BotFather\n2. Hantar `/newbot`\n3. Ikut arahan untuk buat bot\n4. Copy token yang diberi (contoh: `8285430975:AAFxk17E...`)\n\n#### 2. Dropbox Token (Optional)\n1. Pergi ke https://www.dropbox.com/developers/apps\n2. Create app ‚Üí Scoped access ‚Üí Full Dropbox\n3. Pergi ke tab OAuth 2\n4. Klik \"Generate access token\"\n5. Copy token (bermula dengan `sl.`)\n\nAtau guna command dalam bot:\n```\n/addapi sl.your_dropbox_token_here\n```\n\n#### 3. Google Drive Token (Optional)\n- Untuk backup failover sahaja\n- Rujuk dokumentasi Google Drive API\n\n---\n\n## English\n\n### Method 1: Directly in config.js (RECOMMENDED)\n\nEdit `config.js` file:\n\n```javascript\nmodule.exports = {\n  // 1. TELEGRAM BOT TOKEN (REQUIRED!)\n  TELEGRAM_BOT_TOKEN: '8285430975:AAFxk17EnyAHonkeaYVKOAW4ZJLAjeBFzMQ',\n  \n  // 2. DROPBOX TOKEN (Optional - for backup)\n  DROPBOX_TOKEN: 'sl.BxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxA',\n  \n  // 3. GOOGLE DRIVE TOKEN (Optional - backup failover)\n  GOOGLE_DRIVE_TOKEN: 'ya29.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',\n  \n  OWNER_ID: 8253048034, // Change to your Telegram ID\n  // ... rest of config\n};\n```\n\n### Method 2: Use .env file\n\n1. Copy `.env.example` to `.env`:\n   ```bash\n   cp .env.example .env\n   ```\n\n2. Edit `.env` and add tokens:\n   ```\n   TELEGRAM_BOT_TOKEN=8285430975:AAFxk17EnyAHonkeaYVKOAW4ZJLAjeBFzMQ\n   DROPBOX_TOKEN=sl.BxxxxxxxxxxxxxxxxxA\n   GOOGLE_DRIVE_TOKEN=ya29.xxxxxxxx\n   ```\n\n### How to Get Tokens:\n\n#### 1. Telegram Bot Token\n1. Open Telegram, search for @BotFather\n2. Send `/newbot`\n3. Follow instructions to create bot\n4. Copy the token provided (example: `8285430975:AAFxk17E...`)\n\n#### 2. Dropbox Token (Optional)\n1. Go to https://www.dropbox.com/developers/apps\n2. Create app ‚Üí Scoped access ‚Üí Full Dropbox\n3. Go to OAuth 2 tab\n4. Click \"Generate access token\"\n5. Copy token (starts with `sl.`)\n\nOr use command in bot:\n```\n/addapi sl.your_dropbox_token_here\n```\n\n#### 3. Google Drive Token (Optional)\n- For backup failover only\n- Refer to Google Drive API documentation\n\n---\n\n## Priority System\n\nToken loading priority (first found wins):\n\n1. **settings.json** (via `/addapi` command) - Highest priority\n2. **config.js** - Direct hardcoded tokens\n3. **.env file** - Environment variables via process.env\n\n**NO REPLIT AUTH NEEDED!** üö´\n\nAll tokens can be set directly in config.js or .env file.\n\n---\n\n## Security Warning ‚ö†Ô∏è\n\n**IMPORTANT:** If using git/GitHub:\n\n1. **DO NOT commit config.js** with real tokens\n2. **DO add .env to .gitignore** (already included)\n3. **Best practice:** Use .env file and keep .env in .gitignore\n\nCurrent .gitignore already includes:\n```\n.env\n```\n\nSo your tokens are safe! ‚úÖ\n","size_bytes":3655},"utils/adminLogger.js":{"content":"const db = require('./database');\n\nasync function logAdminAction(adminId, action, details = '') {\n  try {\n    const logs = await db.read('admin_logs.json') || [];\n    const log = {\n      id: `LOG-${Date.now()}`,\n      adminId,\n      action,\n      details,\n      timestamp: new Date().toISOString()\n    };\n    \n    logs.push(log);\n    \n    if (logs.length > 1000) {\n      logs.splice(0, logs.length - 1000);\n    }\n    \n    await db.write('admin_logs.json', logs);\n    return log;\n  } catch (error) {\n    console.error('Failed to log admin action:', error);\n    return null;\n  }\n}\n\nasync function getAdminLogs(limit = 50) {\n  try {\n    const logs = await db.read('admin_logs.json') || [];\n    return {\n      logs: logs.slice(-limit).reverse(),\n      total: logs.length\n    };\n  } catch (error) {\n    console.error('Failed to get admin logs:', error);\n    return { logs: [], total: 0 };\n  }\n}\n\nasync function clearAdminLogs() {\n  try {\n    await db.write('admin_logs.json', []);\n    return true;\n  } catch (error) {\n    console.error('Failed to clear admin logs:', error);\n    return false;\n  }\n}\n\nmodule.exports = {\n  logAdminAction,\n  getAdminLogs,\n  clearAdminLogs\n};\n","size_bytes":1168},"public/style.css":{"content":"@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');\n\n* {\n    margin: 0;\n    padding: 0;\n    box-sizing: border-box;\n}\n\n:root {\n    --primary: #1e293b;\n    --secondary: #334155;\n    --accent: #3b82f6;\n    --accent-dark: #2563eb;\n    --light: #f1f5f9;\n    --lighter: #e2e8f0;\n    --white: #ffffff;\n    --gray: #94a3b8;\n    --dark-gray: #64748b;\n    --text-dark: #0f172a;\n    --success: #10b981;\n    --warning: #f59e0b;\n    --danger: #ef4444;\n    --gradient-1: linear-gradient(135deg, #1e293b 0%, #334155 100%);\n    --gradient-2: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);\n    --gradient-3: linear-gradient(135deg, #334155 0%, #1e293b 100%);\n    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);\n    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);\n    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);\n    --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);\n}\n\nbody[data-theme=\"emerald\"] {\n    --primary: #065f46;\n    --secondary: #047857;\n    --accent: #10b981;\n    --accent-dark: #059669;\n    --light: #f0fdf4;\n    --lighter: #dcfce7;\n    --gradient-1: linear-gradient(135deg, #065f46 0%, #047857 100%);\n    --gradient-2: linear-gradient(135deg, #10b981 0%, #059669 100%);\n    --gradient-3: linear-gradient(135deg, #047857 0%, #065f46 100%);\n}\n\nbody[data-theme=\"royal\"] {\n    --primary: #581c87;\n    --secondary: #6b21a8;\n    --accent: #a855f7;\n    --accent-dark: #9333ea;\n    --light: #faf5ff;\n    --lighter: #f3e8ff;\n    --gradient-1: linear-gradient(135deg, #581c87 0%, #6b21a8 100%);\n    --gradient-2: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);\n    --gradient-3: linear-gradient(135deg, #6b21a8 0%, #581c87 100%);\n}\n\n:root, body[data-theme=\"midnight\"] {\n    --primary-blue: var(--primary);\n    --secondary-blue: var(--secondary);\n    --light-blue: var(--dark-gray);\n    --lighter-blue: var(--lighter);\n    --dark-blue: var(--text-dark);\n    --light-gray: var(--light);\n    --purple: var(--accent);\n}\n\nbody {\n    font-family: 'Poppins', sans-serif;\n    background: var(--light);\n    color: var(--text-dark);\n    overflow-x: hidden;\n    transition: background 0.3s ease, color 0.3s ease;\n}\n\n.page {\n    display: none;\n}\n\n.page.active {\n    display: block;\n    animation: fadeIn 0.5s ease-in-out;\n}\n\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n        transform: translateY(20px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.animated-background {\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    overflow: hidden;\n    z-index: -1;\n    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);\n    transition: background 0.5s ease;\n}\n\n.gradient-orb {\n    position: absolute;\n    border-radius: 50%;\n    filter: blur(80px);\n    opacity: 0.6;\n    animation: float 20s infinite ease-in-out;\n}\n\n.orb-1 {\n    width: 500px;\n    height: 500px;\n    background: radial-gradient(circle, var(--accent) 0%, transparent 70%);\n    top: -10%;\n    left: -10%;\n    animation-delay: 0s;\n}\n\n.orb-2 {\n    width: 400px;\n    height: 400px;\n    background: radial-gradient(circle, var(--accent-dark) 0%, transparent 70%);\n    top: 50%;\n    right: -5%;\n    animation-delay: 7s;\n}\n\n.orb-3 {\n    width: 600px;\n    height: 600px;\n    background: radial-gradient(circle, var(--secondary) 0%, transparent 70%);\n    bottom: -15%;\n    left: 30%;\n    animation-delay: 14s;\n}\n\n@keyframes float {\n    0%, 100% {\n        transform: translate(0, 0) scale(1);\n    }\n    33% {\n        transform: translate(30px, -50px) scale(1.1);\n    }\n    66% {\n        transform: translate(-20px, 20px) scale(0.9);\n    }\n}\n\n.login-container {\n    min-height: 100vh;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    padding: 20px;\n}\n\n.login-card {\n    background: rgba(255, 255, 255, 0.95);\n    backdrop-filter: blur(20px);\n    border-radius: 30px;\n    padding: 50px 40px;\n    box-shadow: var(--shadow-xl);\n    max-width: 450px;\n    width: 100%;\n    animation: slideUp 0.6s ease-out;\n    border: 1px solid rgba(255, 255, 255, 0.3);\n}\n\n@keyframes slideUp {\n    from {\n        opacity: 0;\n        transform: translateY(50px) scale(0.9);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0) scale(1);\n    }\n}\n\n.logo-container {\n    text-align: center;\n    margin-bottom: 40px;\n}\n\n.logo-circle {\n    width: 100px;\n    height: 100px;\n    background: var(--gradient-2);\n    border-radius: 50%;\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    margin-bottom: 20px;\n    animation: pulse 2s infinite;\n    box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3);\n}\n\n@keyframes pulse {\n    0%, 100% {\n        transform: scale(1);\n        box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3);\n    }\n    50% {\n        transform: scale(1.05);\n        box-shadow: 0 15px 40px rgba(37, 99, 235, 0.5);\n    }\n}\n\n.logo-circle i {\n    font-size: 48px;\n    color: var(--white);\n}\n\n.login-title {\n    font-size: 32px;\n    font-weight: 700;\n    color: var(--primary);\n    margin-bottom: 8px;\n}\n\n@media (max-width: 480px) {\n    .login-title {\n        font-size: 24px;\n    }\n    \n    .login-subtitle {\n        font-size: 14px;\n    }\n}\n\n.login-subtitle {\n    font-size: 16px;\n    color: var(--dark-gray);\n}\n\n.login-form {\n    margin-bottom: 30px;\n}\n\n.input-group {\n    position: relative;\n    margin-bottom: 25px;\n}\n\n.input-group i {\n    position: absolute;\n    left: 20px;\n    top: 50%;\n    transform: translateY(-50%);\n    color: var(--primary-blue);\n    font-size: 20px;\n}\n\n.input-group input {\n    width: 100%;\n    padding: 18px 20px 18px 60px;\n    border: 2px solid var(--gray);\n    border-radius: 15px;\n    font-size: 16px;\n    font-family: 'Poppins', sans-serif;\n    transition: all 0.3s ease;\n    background: var(--white);\n}\n\n.input-group input:focus {\n    outline: none;\n    border-color: var(--accent);\n    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);\n    transform: translateY(-2px);\n}\n\n@media (max-width: 480px) {\n    .input-group input {\n        padding: 14px 16px 14px 50px;\n        font-size: 14px;\n    }\n}\n\n.btn-login {\n    width: 100%;\n    padding: 18px;\n    background: var(--gradient-2);\n    color: var(--white);\n    border: none;\n    border-radius: 15px;\n    font-size: 16px;\n    font-weight: 600;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 10px;\n    transition: all 0.3s ease;\n    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);\n}\n\n.btn-login:hover {\n    transform: translateY(-3px);\n    box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);\n}\n\n.btn-login:active {\n    transform: translateY(-1px);\n}\n\n.login-footer {\n    text-align: center;\n    color: var(--dark-gray);\n    font-size: 14px;\n}\n\n.login-footer i {\n    color: var(--primary-blue);\n    margin-right: 5px;\n}\n\n.sidebar {\n    position: fixed;\n    left: 0;\n    top: 0;\n    width: 280px;\n    height: 100vh;\n    background: var(--white);\n    box-shadow: var(--shadow-md);\n    padding: 30px 20px;\n    padding-bottom: 120px;\n    overflow-y: auto;\n    z-index: 100;\n    animation: slideInLeft 0.5s ease-out;\n}\n\n@keyframes slideInLeft {\n    from {\n        transform: translateX(-100%);\n    }\n    to {\n        transform: translateX(0);\n    }\n}\n\n.sidebar-header {\n    text-align: center;\n    margin-bottom: 20px;\n    padding-bottom: 15px;\n    border-bottom: 2px solid var(--lighter-blue);\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n}\n\n.sidebar-logo {\n    width: 50px;\n    height: 50px;\n    background: var(--gradient-2);\n    border-radius: 50%;\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    margin-bottom: 10px;\n}\n\n.sidebar-logo i {\n    font-size: 24px;\n    color: var(--white);\n}\n\n.sidebar-title {\n    font-size: 16px;\n    font-weight: 700;\n    color: var(--primary-blue);\n}\n\n/* Theme Selector Styles */\n.theme-selector {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    gap: 15px;\n    margin-top: 10px;\n}\n\n.theme-option {\n    background: var(--white);\n    border: 3px solid var(--lighter);\n    border-radius: 12px;\n    padding: 15px;\n    cursor: pointer;\n    transition: all 0.3s ease;\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    position: relative;\n}\n\n.theme-option:hover {\n    border-color: var(--accent);\n    transform: translateY(-3px);\n    box-shadow: var(--shadow-lg);\n}\n\n.theme-option.active {\n    border-color: var(--accent);\n    background: linear-gradient(135deg, var(--light) 0%, var(--lighter) 100%);\n}\n\n.theme-option.active .theme-check {\n    opacity: 1;\n}\n\n.theme-preview {\n    width: 60px;\n    height: 60px;\n    border-radius: 10px;\n    flex-shrink: 0;\n    box-shadow: var(--shadow-md);\n}\n\n.midnight-preview {\n    background: linear-gradient(135deg, #1e293b 0%, #3b82f6 100%);\n}\n\n.emerald-preview {\n    background: linear-gradient(135deg, #065f46 0%, #10b981 100%);\n}\n\n.royal-preview {\n    background: linear-gradient(135deg, #581c87 0%, #a855f7 100%);\n}\n\n.theme-info {\n    flex: 1;\n}\n\n.theme-info h4 {\n    margin: 0 0 5px 0;\n    font-size: 16px;\n    font-weight: 600;\n    color: var(--text-dark);\n}\n\n.theme-info p {\n    margin: 0;\n    font-size: 13px;\n    color: var(--gray);\n}\n\n.theme-check {\n    font-size: 20px;\n    color: var(--success);\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n/* Layout Selector */\n.layout-selector {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    gap: 20px;\n    margin-top: 15px;\n}\n\n.layout-option {\n    background: var(--white);\n    border: 3px solid var(--lighter);\n    border-radius: 15px;\n    padding: 20px;\n    cursor: pointer;\n    transition: all 0.3s ease;\n    display: flex;\n    flex-direction: column;\n    gap: 15px;\n    position: relative;\n}\n\n.layout-option:hover {\n    border-color: var(--accent);\n    transform: translateY(-5px);\n    box-shadow: var(--shadow-lg);\n}\n\n.layout-option.active {\n    border-color: var(--accent);\n    background: linear-gradient(135deg, var(--light) 0%, var(--lighter) 100%);\n}\n\n.layout-option.active .layout-check {\n    opacity: 1;\n}\n\n.layout-preview {\n    width: 100%;\n    height: 150px;\n    border-radius: 10px;\n    overflow: hidden;\n    background: var(--light-gray);\n    display: flex;\n    gap: 5px;\n    padding: 8px;\n    box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);\n    position: relative;\n    flex-shrink: 0;\n}\n\n/* Modern Layout Preview */\n.modern-preview .preview-sidebar {\n    width: 30%;\n    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);\n    border-radius: 6px;\n}\n\n.modern-preview .preview-content {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n}\n\n.modern-preview .preview-card {\n    background: var(--white);\n    border-radius: 6px;\n    height: 50%;\n    box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n}\n\n/* Compact Layout Preview */\n.compact-preview {\n    flex-direction: column;\n}\n\n.compact-preview .preview-topbar {\n    width: 100%;\n    height: 25px;\n    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);\n    border-radius: 6px;\n}\n\n.compact-preview .preview-content {\n    flex: 1;\n    display: grid;\n    grid-template-columns: repeat(3, 1fr);\n    gap: 6px;\n    margin-top: 6px;\n}\n\n.compact-preview .preview-card.small {\n    background: var(--white);\n    border-radius: 6px;\n    box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n}\n\n/* Minimal Layout Preview */\n.minimal-preview {\n    flex-direction: column;\n}\n\n.minimal-preview .preview-simple-header {\n    width: 100%;\n    height: 20px;\n    background: var(--white);\n    border-radius: 6px;\n    border-bottom: 2px solid var(--lighter-blue);\n}\n\n.minimal-preview .preview-content {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    gap: 6px;\n    margin-top: 8px;\n}\n\n.minimal-preview .preview-list {\n    background: var(--white);\n    border-radius: 4px;\n    height: 40%;\n    border-left: 3px solid var(--accent);\n    box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n}\n\n/* New Layout Previews */\n.classic-preview {\n    flex-direction: column;\n    padding: 0;\n    gap: 0;\n}\n\n.classic-preview .preview-header {\n    width: 100%;\n    height: 20px;\n    background: #34495e;\n    border-radius: 10px 10px 0 0;\n    flex-shrink: 0;\n}\n\n.classic-preview .preview-sidebar-left {\n    flex: 0 0 30%;\n    background: #2c3e50;\n    max-width: 30%;\n}\n\n.classic-preview .preview-content-main {\n    flex: 1 1 0;\n    background: #ecf0f1;\n    min-width: 0;\n    min-height: 0;\n}\n\n.gradient-preview {\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    border-radius: 10px;\n    padding: 10%;\n    justify-content: center;\n    align-items: center;\n}\n\n.gradient-preview .preview-float-cards {\n    width: 100%;\n    height: 100%;\n    background: rgba(255,255,255,0.9);\n    border-radius: 6px;\n    box-shadow: 0 4px 8px rgba(0,0,0,0.2);\n}\n\n.cardcentric-preview {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    grid-template-rows: 1fr 1fr;\n    gap: 6px;\n}\n\n.cardcentric-preview .preview-card-grid {\n    background: var(--white);\n    border-radius: 6px;\n    box-shadow: 0 2px 4px rgba(0,0,0,0.12);\n    min-height: 0;\n}\n\n.sideright-preview {\n    flex-direction: row-reverse;\n    gap: 4px;\n}\n\n.sideright-preview .preview-content-left {\n    flex: 1 1 0;\n    background: #f5f5f5;\n    border-radius: 6px;\n    min-width: 0;\n    max-width: 70%;\n}\n\n.sideright-preview .preview-sidebar-right {\n    flex: 0 0 30%;\n    background: var(--primary-blue);\n    border-radius: 6px;\n    max-width: 30%;\n}\n\n.splitview-preview {\n    gap: 4px;\n}\n\n.splitview-preview .preview-split-left,\n.splitview-preview .preview-split-right {\n    flex: 1 1 0;\n    background: #f5f5f5;\n    border-radius: 6px;\n    min-width: 0;\n    max-width: 50%;\n}\n\n.splitview-preview .preview-split-left {\n    background: var(--primary-blue);\n}\n\n.floating-preview {\n    background: linear-gradient(135deg, #0f0c29 0%, #302b63 100%);\n    border-radius: 10px;\n    padding: 12px;\n    justify-content: center;\n    align-items: center;\n}\n\n.floating-preview .preview-float-elements {\n    width: 100%;\n    height: 100%;\n    background: rgba(255,255,255,0.95);\n    border-radius: 8px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n}\n\n.metro-preview {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    grid-template-rows: 1fr 1fr;\n    gap: 4px;\n}\n\n.metro-preview .preview-metro-tiles {\n    background: #0078d4;\n    border-radius: 0;\n    min-height: 0;\n}\n\n.material-preview {\n    flex-direction: column;\n    padding: 0;\n}\n\n.material-preview .preview-material-header {\n    width: 100%;\n    height: 30px;\n    background: var(--white);\n    border-radius: 10px 10px 0 0;\n    box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n    flex-shrink: 0;\n}\n\n.material-preview .preview-material-content {\n    flex: 1;\n    background: #f5f5f5;\n    border-radius: 0 0 10px 10px;\n    min-height: 0;\n}\n\n.glass-preview {\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    border-radius: 10px;\n    padding: 10%;\n    justify-content: center;\n    align-items: center;\n}\n\n.glass-preview .preview-glass-panel {\n    width: 100%;\n    height: 100%;\n    background: rgba(255,255,255,0.15);\n    backdrop-filter: blur(10px);\n    border: 1px solid rgba(255,255,255,0.3);\n    border-radius: 6px;\n}\n\n.darkpro-preview {\n    background: #161b22;\n    border: 1px solid #30363d;\n    border-radius: 10px;\n    padding: 0;\n}\n\n.darkpro-preview .preview-dark-theme {\n    width: 100%;\n    height: 100%;\n    background: #0d1117;\n    border-radius: 10px;\n}\n\n.neon-preview {\n    background: #000;\n    border-radius: 10px;\n    padding: 8px;\n    justify-content: center;\n    align-items: center;\n}\n\n.neon-preview .preview-neon-glow {\n    width: 100%;\n    height: 100%;\n    background: #0a0a0a;\n    border: 2px solid #00ff88;\n    border-radius: 6px;\n    box-shadow: 0 0 10px rgba(0,255,136,0.4);\n}\n\n.corporate-preview {\n    flex-direction: column;\n    padding: 0;\n}\n\n.corporate-preview .preview-corp-header {\n    width: 100%;\n    height: 25px;\n    background: #003d82;\n    border-radius: 10px 10px 0 0;\n    flex-shrink: 0;\n}\n\n.corporate-preview .preview-corp-content {\n    flex: 1;\n    background: #f8f9fa;\n    border-radius: 0 0 10px 10px;\n    min-height: 0;\n}\n\n.elegant-preview {\n    background: #ffffff;\n    border: 1px solid #e0e0e0;\n    border-radius: 10px;\n    padding: 0;\n}\n\n.elegant-preview .preview-elegant-white {\n    width: 100%;\n    height: 100%;\n    background: #fafafa;\n    border-radius: 10px;\n}\n\n.dashgrid-preview {\n    display: grid;\n    grid-template-columns: repeat(3, 1fr);\n    grid-template-rows: 1fr 1fr;\n    gap: 5px;\n}\n\n.dashgrid-preview .preview-grid-system {\n    background: var(--white);\n    border-radius: 4px;\n    box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n    min-height: 0;\n}\n\n.timeline-preview {\n    padding-left: 15px;\n    justify-content: center;\n}\n\n.timeline-preview .preview-timeline {\n    flex: 1;\n    height: 100%;\n    background: var(--white);\n    border-left: 3px solid var(--accent);\n    border-radius: 4px;\n    position: relative;\n}\n\n.timeline-preview .preview-timeline::before {\n    content: '';\n    position: absolute;\n    left: -7px;\n    top: 20%;\n    width: 8px;\n    height: 8px;\n    background: var(--accent);\n    border-radius: 50%;\n}\n\n.magazine-preview {\n    display: grid;\n    grid-template-columns: 2fr 1fr 1fr;\n    grid-template-rows: 1fr 1fr;\n    gap: 5px;\n}\n\n.magazine-preview .preview-mag-layout {\n    background: var(--white);\n    border-radius: 4px;\n    box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n    min-height: 0;\n}\n\n.magazine-preview .preview-mag-layout:first-child {\n    grid-row: 1 / 3;\n}\n\n.collapsed-preview {\n    gap: 4px;\n}\n\n.collapsed-preview .preview-mini-sidebar {\n    flex: 0 0 20%;\n    background: var(--primary-blue);\n    border-radius: 6px;\n    max-width: 20%;\n}\n\n.collapsed-preview .preview-wide-content {\n    flex: 1 1 0;\n    background: #f5f5f5;\n    border-radius: 6px;\n    min-width: 0;\n    max-width: 80%;\n}\n\n.fullwidth-preview {\n    padding: 0;\n}\n\n.fullwidth-preview .preview-full-content {\n    width: 100%;\n    height: 100%;\n    background: #f5f5f5;\n    border-radius: 10px;\n}\n\n.boxed-preview {\n    background: #e0e0e0;\n    border-radius: 10px;\n    padding: 10px;\n    justify-content: center;\n    align-items: center;\n}\n\n.boxed-preview .preview-boxed-container {\n    width: 100%;\n    height: 100%;\n    background: var(--white);\n    border-radius: 4px;\n    box-shadow: 0 2px 6px rgba(0,0,0,0.1);\n}\n\n.asymmetric-preview {\n    display: grid;\n    grid-template-columns: 1fr 2fr;\n    grid-template-rows: 1fr;\n    gap: 5px;\n}\n\n.asymmetric-preview .preview-asym-grid {\n    background: var(--white);\n    border-radius: 4px;\n    box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n    min-height: 0;\n}\n\n.layout-info h4 {\n    margin: 0 0 5px 0;\n    font-size: 16px;\n    font-weight: 600;\n    color: var(--text-dark);\n}\n\n.layout-info p {\n    margin: 0;\n    font-size: 13px;\n    color: var(--gray);\n}\n\n.layout-check {\n    position: absolute;\n    top: 15px;\n    right: 15px;\n    font-size: 24px;\n    color: var(--success);\n    opacity: 0;\n    transition: opacity 0.3s ease;\n}\n\n/* Modern Layout Styles */\nbody[data-layout=\"modern\"] .sidebar {\n    background: linear-gradient(180deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);\n}\n\nbody[data-layout=\"modern\"] .sidebar-title {\n    color: var(--white);\n}\n\nbody[data-layout=\"modern\"] .menu-item {\n    color: rgba(255, 255, 255, 0.8);\n}\n\nbody[data-layout=\"modern\"] .menu-item:hover {\n    background: rgba(255, 255, 255, 0.1);\n    color: var(--white);\n}\n\nbody[data-layout=\"modern\"] .menu-item.active {\n    background: rgba(255, 255, 255, 0.15);\n    color: var(--white);\n}\n\n/* Compact Layout Styles */\nbody[data-layout=\"compact\"] .sidebar {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    width: 100%;\n    height: 70px;\n    flex-direction: row;\n    padding: 15px 30px;\n    box-shadow: 0 2px 10px rgba(0,0,0,0.1);\n}\n\nbody[data-layout=\"compact\"] .sidebar-header {\n    border-bottom: none;\n    margin-bottom: 0;\n    padding-bottom: 0;\n    flex-direction: row;\n    align-items: center;\n    gap: 15px;\n}\n\nbody[data-layout=\"compact\"] .sidebar-logo {\n    margin-bottom: 0;\n}\n\nbody[data-layout=\"compact\"] .sidebar-user {\n    display: none;\n}\n\nbody[data-layout=\"compact\"] .sidebar-menu {\n    display: flex;\n    flex-direction: row;\n    gap: 10px;\n    margin-bottom: 0;\n    margin-left: auto;\n}\n\nbody[data-layout=\"compact\"] .menu-item {\n    padding: 8px 15px;\n    border-radius: 8px;\n}\n\nbody[data-layout=\"compact\"] .menu-item span {\n    display: none;\n}\n\nbody[data-layout=\"compact\"] .menu-item i {\n    margin-right: 0;\n    font-size: 18px;\n}\n\nbody[data-layout=\"compact\"] .sidebar-footer {\n    display: none;\n}\n\nbody[data-layout=\"compact\"] .main-content {\n    margin-left: 0;\n    margin-top: 90px;\n    padding: 20px;\n}\n\nbody[data-layout=\"compact\"] .sidebar-toggle {\n    display: none;\n}\n\n/* Minimal Layout Styles */\nbody[data-layout=\"minimal\"] .sidebar {\n    background: var(--white);\n    border-right: 1px solid var(--lighter);\n    box-shadow: none;\n}\n\nbody[data-layout=\"minimal\"] .sidebar-header {\n    border-bottom: 1px solid var(--lighter);\n}\n\nbody[data-layout=\"minimal\"] .sidebar-logo {\n    background: transparent;\n    border: 2px solid var(--primary-blue);\n}\n\nbody[data-layout=\"minimal\"] .sidebar-logo i {\n    color: var(--primary-blue);\n}\n\nbody[data-layout=\"minimal\"] .sidebar-user {\n    background: transparent;\n    border: 1px solid var(--lighter);\n}\n\nbody[data-layout=\"minimal\"] .user-avatar {\n    background: var(--light-gray);\n}\n\nbody[data-layout=\"minimal\"] .user-name,\nbody[data-layout=\"minimal\"] .user-role {\n    color: var(--text-dark);\n}\n\nbody[data-layout=\"minimal\"] .menu-item {\n    background: transparent;\n    color: var(--text-dark);\n    border-radius: 4px;\n}\n\nbody[data-layout=\"minimal\"] .menu-item:hover {\n    background: var(--light-gray);\n}\n\nbody[data-layout=\"minimal\"] .menu-item.active {\n    background: var(--lighter-blue);\n    color: var(--primary-blue);\n}\n\nbody[data-layout=\"minimal\"] .btn-logout {\n    background: transparent;\n    color: var(--danger);\n    border: 1px solid var(--danger);\n}\n\nbody[data-layout=\"minimal\"] .btn-logout:hover {\n    background: var(--danger);\n    color: var(--white);\n}\n\n/* Classic Layout Styles */\nbody[data-layout=\"classic\"] .sidebar {\n    width: 220px;\n    background: #2c3e50;\n}\n\nbody[data-layout=\"classic\"] .main-content {\n    margin-left: 220px;\n    background: #ecf0f1;\n}\n\nbody[data-layout=\"classic\"] .menu-item {\n    color: #bdc3c7;\n}\n\nbody[data-layout=\"classic\"] .menu-item.active {\n    background: #34495e;\n    color: #3498db;\n}\n\n/* Gradient Modern Layout */\nbody[data-layout=\"gradient\"] .sidebar {\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n}\n\nbody[data-layout=\"gradient\"] .main-content {\n    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n}\n\nbody[data-layout=\"gradient\"] .stat-card {\n    background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);\n    backdrop-filter: blur(10px);\n}\n\n/* Card Centric Layout */\nbody[data-layout=\"cardcentric\"] .main-content {\n    padding: 30px;\n}\n\nbody[data-layout=\"cardcentric\"] .stats-grid {\n    gap: 25px;\n}\n\nbody[data-layout=\"cardcentric\"] .stat-card {\n    box-shadow: 0 10px 30px rgba(0,0,0,0.15);\n    transform: translateY(0);\n    transition: transform 0.3s ease;\n}\n\nbody[data-layout=\"cardcentric\"] .stat-card:hover {\n    transform: translateY(-10px);\n}\n\n/* Sidebar Right Layout */\nbody[data-layout=\"sideright\"] .sidebar {\n    left: auto;\n    right: 0;\n}\n\nbody[data-layout=\"sideright\"] .main-content {\n    margin-left: 0;\n    margin-right: 280px;\n}\n\nbody[data-layout=\"sideright\"] .sidebar-toggle {\n    right: 20px;\n    left: auto;\n}\n\n/* Split View Layout */\nbody[data-layout=\"splitview\"] .sidebar {\n    width: 50%;\n    position: relative;\n}\n\nbody[data-layout=\"splitview\"] .main-content {\n    margin-left: 50%;\n    width: 50%;\n}\n\n/* Floating Cards Layout */\nbody[data-layout=\"floating\"] .main-content {\n    background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);\n}\n\nbody[data-layout=\"floating\"] .stat-card {\n    background: rgba(255, 255, 255, 0.95);\n    box-shadow: 0 20px 60px rgba(0,0,0,0.3);\n    border-radius: 20px;\n}\n\nbody[data-layout=\"floating\"] .page-header {\n    color: #fff;\n}\n\n/* Metro Style Layout */\nbody[data-layout=\"metro\"] .sidebar {\n    background: #0078d4;\n}\n\nbody[data-layout=\"metro\"] .main-content {\n    background: #f3f3f3;\n}\n\nbody[data-layout=\"metro\"] .stat-card {\n    border-radius: 0;\n    border-left: 4px solid var(--accent);\n}\n\nbody[data-layout=\"metro\"] .menu-item {\n    border-radius: 0;\n    border-left: 4px solid transparent;\n}\n\nbody[data-layout=\"metro\"] .menu-item.active {\n    border-left-color: #fff;\n}\n\n/* Material Design Layout */\nbody[data-layout=\"material\"] .sidebar {\n    background: #fff;\n    box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n}\n\nbody[data-layout=\"material\"] .stat-card {\n    border-radius: 4px;\n    box-shadow: 0 2px 4px rgba(0,0,0,0.12);\n}\n\nbody[data-layout=\"material\"] .btn-primary {\n    border-radius: 24px;\n    box-shadow: 0 4px 6px rgba(0,0,0,0.2);\n}\n\n/* Glass Morphism Layout */\nbody[data-layout=\"glass\"] .main-content {\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n}\n\nbody[data-layout=\"glass\"] .sidebar {\n    background: rgba(255, 255, 255, 0.1);\n    backdrop-filter: blur(20px);\n    border-right: 1px solid rgba(255, 255, 255, 0.2);\n}\n\nbody[data-layout=\"glass\"] .stat-card {\n    background: rgba(255, 255, 255, 0.15);\n    backdrop-filter: blur(10px);\n    border: 1px solid rgba(255, 255, 255, 0.3);\n}\n\nbody[data-layout=\"glass\"] .page-header {\n    color: #fff;\n}\n\n/* Dark Mode Pro Layout */\nbody[data-layout=\"darkpro\"] {\n    background: #0d1117;\n}\n\nbody[data-layout=\"darkpro\"] .sidebar {\n    background: #161b22;\n    border-right: 1px solid #30363d;\n}\n\nbody[data-layout=\"darkpro\"] .main-content {\n    background: #0d1117;\n    color: #c9d1d9;\n}\n\nbody[data-layout=\"darkpro\"] .stat-card {\n    background: #161b22;\n    border: 1px solid #30363d;\n    color: #c9d1d9;\n}\n\nbody[data-layout=\"darkpro\"] .page-title {\n    color: #f0f6fc;\n}\n\n/* Neon Glow Layout */\nbody[data-layout=\"neon\"] {\n    background: #000;\n}\n\nbody[data-layout=\"neon\"] .sidebar {\n    background: #0a0a0a;\n    border-right: 2px solid #00ff88;\n    box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);\n}\n\nbody[data-layout=\"neon\"] .main-content {\n    background: #050505;\n}\n\nbody[data-layout=\"neon\"] .stat-card {\n    background: #0a0a0a;\n    border: 2px solid #00ff88;\n    box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);\n}\n\nbody[data-layout=\"neon\"] .menu-item.active {\n    background: rgba(0, 255, 136, 0.1);\n    box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);\n}\n\nbody[data-layout=\"neon\"] .page-title {\n    color: #00ff88;\n    text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);\n}\n\n/* Corporate Blue Layout */\nbody[data-layout=\"corporate\"] .sidebar {\n    background: #003d82;\n}\n\nbody[data-layout=\"corporate\"] .main-content {\n    background: #f8f9fa;\n}\n\nbody[data-layout=\"corporate\"] .stat-card {\n    border-top: 4px solid #003d82;\n}\n\nbody[data-layout=\"corporate\"] .menu-item.active {\n    background: #002956;\n}\n\n/* Elegant White Layout */\nbody[data-layout=\"elegant\"] .sidebar {\n    background: #ffffff;\n    box-shadow: 2px 0 10px rgba(0,0,0,0.05);\n}\n\nbody[data-layout=\"elegant\"] .main-content {\n    background: #fafafa;\n}\n\nbody[data-layout=\"elegant\"] .stat-card {\n    background: #ffffff;\n    box-shadow: 0 2px 8px rgba(0,0,0,0.06);\n}\n\nbody[data-layout=\"elegant\"] .menu-item {\n    color: #333;\n}\n\nbody[data-layout=\"elegant\"] .menu-item.active {\n    background: #f5f5f5;\n    color: #000;\n}\n\n/* Dashboard Grid Layout */\nbody[data-layout=\"dashgrid\"] .stats-grid {\n    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    gap: 20px;\n}\n\nbody[data-layout=\"dashgrid\"] .dashboard-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n    gap: 20px;\n}\n\n/* Timeline View Layout */\nbody[data-layout=\"timeline\"] .main-content {\n    max-width: 900px;\n    margin-left: auto;\n    margin-right: auto;\n}\n\nbody[data-layout=\"timeline\"] .stat-card {\n    position: relative;\n    margin-left: 30px;\n}\n\nbody[data-layout=\"timeline\"] .stat-card::before {\n    content: '';\n    position: absolute;\n    left: -30px;\n    top: 50%;\n    width: 12px;\n    height: 12px;\n    background: var(--accent);\n    border-radius: 50%;\n    transform: translateY(-50%);\n}\n\n/* Magazine Layout */\nbody[data-layout=\"magazine\"] .stats-grid {\n    grid-template-columns: 2fr 1fr 1fr;\n}\n\nbody[data-layout=\"magazine\"] .stat-card:first-child {\n    grid-row: span 2;\n}\n\nbody[data-layout=\"magazine\"] .main-content {\n    column-gap: 30px;\n}\n\n/* Sidebar Collapsed Layout */\nbody[data-layout=\"collapsed\"] .sidebar {\n    width: 80px;\n}\n\nbody[data-layout=\"collapsed\"] .main-content {\n    margin-left: 80px;\n}\n\nbody[data-layout=\"collapsed\"] .sidebar-title,\nbody[data-layout=\"collapsed\"] .menu-item span,\nbody[data-layout=\"collapsed\"] .sidebar-user,\nbody[data-layout=\"collapsed\"] .btn-logout span {\n    display: none;\n}\n\nbody[data-layout=\"collapsed\"] .menu-item {\n    justify-content: center;\n}\n\nbody[data-layout=\"collapsed\"] .sidebar-logo {\n    margin: 0 auto;\n}\n\n/* Full Width Layout */\nbody[data-layout=\"fullwidth\"] .sidebar {\n    display: none;\n}\n\nbody[data-layout=\"fullwidth\"] .main-content {\n    margin-left: 0;\n    width: 100%;\n}\n\nbody[data-layout=\"fullwidth\"] .sidebar-toggle {\n    display: inline-flex;\n}\n\n/* Boxed Layout */\nbody[data-layout=\"boxed\"] {\n    background: #e0e0e0;\n}\n\nbody[data-layout=\"boxed\"] #dashboardPage {\n    max-width: 1400px;\n    margin: 20px auto;\n    background: #fff;\n    box-shadow: 0 0 30px rgba(0,0,0,0.1);\n}\n\n/* Asymmetric Grid Layout */\nbody[data-layout=\"asymmetric\"] .stats-grid {\n    grid-template-columns: 1fr 2fr 1fr;\n}\n\nbody[data-layout=\"asymmetric\"] .stat-card:nth-child(2) {\n    grid-row: span 2;\n}\n\nbody[data-layout=\"asymmetric\"] .dashboard-grid {\n    display: grid;\n    grid-template-columns: 1.5fr 1fr;\n    gap: 20px;\n}\n\n@media (max-width: 768px) {\n    .layout-selector {\n        grid-template-columns: 1fr;\n    }\n    \n    body[data-layout=\"compact\"] .sidebar {\n        flex-direction: column;\n        height: auto;\n        padding: 15px;\n    }\n    \n    body[data-layout=\"compact\"] .sidebar-menu {\n        flex-wrap: wrap;\n        margin-left: 0;\n        margin-top: 15px;\n    }\n    \n    /* Mobile: Classic Layout */\n    body[data-layout=\"classic\"] .sidebar {\n        width: 100%;\n        position: relative;\n    }\n    \n    body[data-layout=\"classic\"] .main-content {\n        margin-left: 0;\n    }\n    \n    /* Mobile: Gradient Layout */\n    body[data-layout=\"gradient\"] .stats-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    /* Mobile: Sidebar Right */\n    body[data-layout=\"sideright\"] .sidebar {\n        right: 0;\n        width: 100%;\n    }\n    \n    body[data-layout=\"sideright\"] .main-content {\n        margin-right: 0;\n    }\n    \n    /* Mobile: Split View */\n    body[data-layout=\"splitview\"] .sidebar {\n        width: 100%;\n        position: relative;\n    }\n    \n    body[data-layout=\"splitview\"] .main-content {\n        margin-left: 0;\n        width: 100%;\n    }\n    \n    /* Mobile: Magazine Layout */\n    body[data-layout=\"magazine\"] .stats-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    body[data-layout=\"magazine\"] .stat-card:first-child {\n        grid-row: auto;\n    }\n    \n    /* Mobile: Collapsed Layout */\n    body[data-layout=\"collapsed\"] .sidebar {\n        width: 100%;\n    }\n    \n    body[data-layout=\"collapsed\"] .main-content {\n        margin-left: 0;\n    }\n    \n    body[data-layout=\"collapsed\"] .sidebar-title,\n    body[data-layout=\"collapsed\"] .menu-item span,\n    body[data-layout=\"collapsed\"] .sidebar-user {\n        display: block;\n    }\n    \n    /* Mobile: Boxed Layout */\n    body[data-layout=\"boxed\"] #dashboardPage {\n        margin: 0;\n        max-width: 100%;\n    }\n    \n    /* Mobile: Asymmetric Grid */\n    body[data-layout=\"asymmetric\"] .stats-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    body[data-layout=\"asymmetric\"] .stat-card:nth-child(2) {\n        grid-row: auto;\n    }\n    \n    body[data-layout=\"asymmetric\"] .dashboard-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    /* Mobile: Dashboard Grid */\n    body[data-layout=\"dashgrid\"] .stats-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    body[data-layout=\"dashgrid\"] .dashboard-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    /* Mobile: Timeline */\n    body[data-layout=\"timeline\"] .stat-card {\n        margin-left: 20px;\n    }\n    \n    body[data-layout=\"timeline\"] .stat-card::before {\n        left: -20px;\n        width: 8px;\n        height: 8px;\n    }\n    \n    /* Mobile: Card Centric */\n    body[data-layout=\"cardcentric\"] .main-content {\n        padding: 15px;\n    }\n    \n    /* Mobile: All layouts - Sidebar toggle */\n    .sidebar-toggle {\n        display: inline-flex;\n    }\n    \n    .sidebar.collapsed {\n        transform: translateX(-100%);\n    }\n    \n    body[data-layout=\"sideright\"] .sidebar.collapsed {\n        transform: translateX(100%);\n    }\n}\n\n@media (max-width: 768px) {\n    .sidebar-header {\n        margin-bottom: 15px;\n        padding-bottom: 12px;\n    }\n\n    .sidebar-logo {\n        width: 40px;\n        height: 40px;\n        margin-bottom: 8px;\n    }\n\n    .sidebar-logo i {\n        font-size: 20px;\n    }\n\n    .sidebar-title {\n        font-size: 14px;\n    }\n    \n    .theme-selector {\n        grid-template-columns: 1fr;\n    }\n    \n    .theme-option {\n        padding: 12px;\n    }\n    \n    .theme-preview {\n        width: 50px;\n        height: 50px;\n    }\n    \n    .theme-info h4 {\n        font-size: 14px;\n    }\n    \n    .theme-info p {\n        font-size: 12px;\n    }\n}\n\n.sidebar-user {\n    background: var(--gradient-3);\n    border-radius: 15px;\n    padding: 20px;\n    margin-bottom: 30px;\n    display: flex;\n    align-items: center;\n    gap: 15px;\n    animation: fadeInScale 0.6s ease-out;\n}\n\n@keyframes fadeInScale {\n    from {\n        opacity: 0;\n        transform: scale(0.8);\n    }\n    to {\n        opacity: 1;\n        transform: scale(1);\n    }\n}\n\n.user-avatar {\n    width: 50px;\n    height: 50px;\n    background: var(--white);\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: var(--primary-blue);\n    font-size: 24px;\n    flex-shrink: 0;\n}\n\n.user-info {\n    flex: 1;\n}\n\n.user-name {\n    font-weight: 600;\n    color: var(--white);\n    margin-bottom: 3px;\n}\n\n.user-role {\n    font-size: 12px;\n    color: rgba(255, 255, 255, 0.8);\n    text-transform: uppercase;\n    letter-spacing: 1px;\n}\n\n.sidebar-menu {\n    list-style: none;\n    margin-bottom: 30px;\n}\n\n.menu-item {\n    padding: 15px 20px;\n    border-radius: 12px;\n    cursor: pointer;\n    transition: all 0.3s ease;\n    display: flex;\n    align-items: center;\n    gap: 15px;\n    margin-bottom: 8px;\n    color: var(--dark-gray);\n    position: relative;\n    overflow: hidden;\n}\n\n.menu-item::before {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0;\n    width: 4px;\n    height: 100%;\n    background: var(--primary-blue);\n    transform: translateX(-100%);\n    transition: transform 0.3s ease;\n}\n\n.menu-item:hover {\n    background: var(--lighter-blue);\n    color: var(--primary-blue);\n    transform: translateX(5px);\n}\n\n.menu-item:hover::before {\n    transform: translateX(0);\n}\n\n.menu-item.active {\n    background: var(--gradient-2);\n    color: var(--white);\n    box-shadow: var(--shadow-md);\n}\n\n.menu-item.active::before {\n    background: var(--white);\n    transform: translateX(0);\n}\n\n.menu-item i {\n    font-size: 20px;\n    width: 24px;\n    text-align: center;\n}\n\n.menu-item span:first-of-type {\n    flex: 1;\n    font-weight: 500;\n}\n\n.badge {\n    background: var(--danger);\n    color: var(--white);\n    padding: 2px 8px;\n    border-radius: 10px;\n    font-size: 12px;\n    font-weight: 600;\n    animation: bounce 1s infinite;\n}\n\n.badge-success {\n    background: var(--success);\n    color: var(--white);\n    padding: 4px 10px;\n    border-radius: 12px;\n    font-size: 11px;\n    font-weight: 600;\n    display: inline-block;\n    margin-right: 8px;\n}\n\n.badge-danger {\n    background: var(--danger);\n    color: var(--white);\n    padding: 4px 10px;\n    border-radius: 12px;\n    font-size: 11px;\n    font-weight: 600;\n    display: inline-block;\n    margin-right: 8px;\n}\n\n.btn-sm {\n    padding: 6px 12px !important;\n    font-size: 12px !important;\n    border-radius: 6px !important;\n}\n\n@keyframes bounce {\n    0%, 100% {\n        transform: scale(1);\n    }\n    50% {\n        transform: scale(1.1);\n    }\n}\n\n.sidebar-footer {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    width: 280px;\n    background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,1) 100%);\n    padding: 20px;\n    box-shadow: 0 -3px 15px rgba(0,0,0,0.1);\n    z-index: 102;\n    border-top: 2px solid var(--lighter);\n    backdrop-filter: blur(10px);\n}\n\n.btn-logout {\n    width: 100%;\n    padding: 15px;\n    background: transparent;\n    border: 2px solid var(--gray);\n    border-radius: 12px;\n    color: var(--dark-gray);\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 10px;\n    font-weight: 500;\n    transition: all 0.3s ease;\n}\n\n.btn-logout:hover {\n    background: var(--danger);\n    border-color: var(--danger);\n    color: var(--white);\n    transform: translateY(-2px);\n}\n\n.main-content {\n    margin-left: 280px;\n    padding: 30px;\n    min-height: 100vh;\n}\n\n.content-section {\n    display: none;\n}\n\n.content-section.active {\n    display: block;\n    animation: fadeInUp 0.5s ease-out;\n}\n\n@keyframes fadeInUp {\n    from {\n        opacity: 0;\n        transform: translateY(30px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.page-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 30px;\n    animation: slideInRight 0.6s ease-out;\n    flex-wrap: wrap;\n    gap: 15px;\n}\n\n@media (min-width: 1024px) {\n    .page-header {\n        flex-wrap: nowrap;\n    }\n}\n\n@keyframes slideInRight {\n    from {\n        opacity: 0;\n        transform: translateX(-30px);\n    }\n    to {\n        opacity: 1;\n        transform: translateX(0);\n    }\n}\n\n.page-title {\n    font-size: 32px;\n    font-weight: 700;\n    color: var(--text-dark);\n    background: var(--gradient-2);\n    -webkit-background-clip: text;\n    -webkit-text-fill-color: transparent;\n    background-clip: text;\n}\n\n.page-subtitle {\n    color: var(--dark-gray);\n    margin-top: 5px;\n}\n\n.stats-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));\n    gap: 25px;\n    margin-bottom: 40px;\n}\n\n@media (max-width: 600px) {\n    .stats-grid {\n        grid-template-columns: 1fr;\n    }\n}\n\n.stat-card {\n    background: var(--white);\n    border-radius: 20px;\n    padding: 30px;\n    box-shadow: var(--shadow-md);\n    transition: all 0.3s ease;\n    position: relative;\n    overflow: hidden;\n    animation: scaleIn 0.5s ease-out;\n    animation-fill-mode: backwards;\n}\n\n.stat-card:nth-child(1) { animation-delay: 0.1s; }\n.stat-card:nth-child(2) { animation-delay: 0.2s; }\n.stat-card:nth-child(3) { animation-delay: 0.3s; }\n.stat-card:nth-child(4) { animation-delay: 0.4s; }\n\n@keyframes scaleIn {\n    from {\n        opacity: 0;\n        transform: scale(0.8);\n    }\n    to {\n        opacity: 1;\n        transform: scale(1);\n    }\n}\n\n.stat-card::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    right: 0;\n    width: 100px;\n    height: 100px;\n    opacity: 0.1;\n    transform: translate(30%, -30%);\n}\n\n.stat-card.card-blue::before {\n    background: radial-gradient(circle, var(--primary-blue) 0%, transparent 70%);\n}\n\n.stat-card.card-green::before {\n    background: radial-gradient(circle, var(--success) 0%, transparent 70%);\n}\n\n.stat-card.card-orange::before {\n    background: radial-gradient(circle, var(--warning) 0%, transparent 70%);\n}\n\n.stat-card.card-purple::before {\n    background: radial-gradient(circle, var(--purple) 0%, transparent 70%);\n}\n\n.stat-card:hover {\n    transform: translateY(-10px) scale(1.02);\n    box-shadow: var(--shadow-xl);\n}\n\n.stat-icon {\n    width: 60px;\n    height: 60px;\n    border-radius: 15px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    margin-bottom: 20px;\n    font-size: 28px;\n    color: var(--white);\n    animation: iconFloat 3s infinite ease-in-out;\n}\n\n@keyframes iconFloat {\n    0%, 100% {\n        transform: translateY(0);\n    }\n    50% {\n        transform: translateY(-5px);\n    }\n}\n\n.card-blue .stat-icon {\n    background: var(--gradient-2);\n}\n\n.card-green .stat-icon {\n    background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n}\n\n.card-orange .stat-icon {\n    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);\n}\n\n.card-purple .stat-icon {\n    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);\n}\n\n.stat-info {\n    margin-bottom: 15px;\n}\n\n.stat-label {\n    color: var(--dark-gray);\n    font-size: 14px;\n    margin-bottom: 8px;\n    font-weight: 500;\n}\n\n.stat-value {\n    font-size: 36px;\n    font-weight: 700;\n    color: var(--text-dark);\n}\n\n.stat-trend {\n    display: flex;\n    align-items: center;\n    gap: 5px;\n    color: var(--success);\n    font-size: 14px;\n    font-weight: 500;\n}\n\n.stat-trend i {\n    font-size: 16px;\n}\n\n.dashboard-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));\n    gap: 25px;\n}\n\n@media (max-width: 768px) {\n    .dashboard-grid {\n        grid-template-columns: 1fr;\n    }\n}\n\n.dashboard-card {\n    background: var(--white);\n    border-radius: 20px;\n    padding: 25px;\n    box-shadow: var(--shadow-md);\n    animation: fadeInUp 0.6s ease-out;\n}\n\n.card-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 20px;\n    padding-bottom: 15px;\n    border-bottom: 2px solid var(--lighter-blue);\n}\n\n.card-header h3 {\n    font-size: 18px;\n    font-weight: 600;\n    color: var(--text-dark);\n}\n\n.btn-link {\n    color: var(--primary-blue);\n    background: none;\n    border: none;\n    cursor: pointer;\n    font-weight: 500;\n    transition: all 0.3s ease;\n}\n\n.btn-link:hover {\n    color: var(--secondary-blue);\n    text-decoration: underline;\n}\n\n.card-content {\n    min-height: 200px;\n}\n\n.recent-orders-list {\n    display: flex;\n    flex-direction: column;\n    gap: 15px;\n}\n\n.order-item {\n    padding: 15px;\n    background: var(--light-gray);\n    border-radius: 12px;\n    border-left: 4px solid var(--primary-blue);\n    transition: all 0.3s ease;\n    animation: slideInLeft 0.5s ease-out;\n}\n\n.order-item:hover {\n    background: var(--lighter-blue);\n    transform: translateX(5px);\n}\n\n.quick-stats {\n    display: flex;\n    flex-direction: column;\n    gap: 20px;\n}\n\n.quick-stat-item {\n    display: flex;\n    align-items: center;\n    gap: 15px;\n    padding: 15px;\n    background: var(--light-gray);\n    border-radius: 12px;\n    transition: all 0.3s ease;\n}\n\n.quick-stat-item:hover {\n    background: var(--lighter-blue);\n    transform: scale(1.05);\n}\n\n.quick-stat-item i {\n    font-size: 28px;\n    color: var(--primary-blue);\n}\n\n.quick-stat-item h4 {\n    font-size: 24px;\n    font-weight: 700;\n    color: var(--text-dark);\n}\n\n.quick-stat-item p {\n    font-size: 14px;\n    color: var(--dark-gray);\n}\n\n.btn-primary, .btn-secondary, .btn-refresh {\n    padding: 12px 24px;\n    border-radius: 12px;\n    font-weight: 600;\n    cursor: pointer;\n    transition: all 0.3s ease;\n    border: none;\n    display: inline-flex;\n    align-items: center;\n    gap: 8px;\n}\n\n.btn-primary {\n    background: var(--gradient-2);\n    color: var(--white);\n    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);\n}\n\n.btn-primary:hover {\n    transform: translateY(-3px);\n    box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);\n}\n\n.btn-secondary {\n    background: var(--gray);\n    color: var(--text-dark);\n}\n\n.btn-secondary:hover {\n    background: var(--dark-gray);\n    color: var(--white);\n}\n\n.btn-refresh {\n    background: var(--white);\n    color: var(--primary-blue);\n    border: 2px solid var(--primary-blue);\n}\n\n.btn-refresh:hover {\n    background: var(--primary-blue);\n    color: var(--white);\n}\n\n.data-table {\n    width: 100%;\n    background: var(--white);\n    border-radius: 15px;\n    overflow: hidden;\n    box-shadow: var(--shadow-md);\n}\n\n.data-table thead {\n    background: var(--gradient-2);\n    color: var(--white);\n}\n\n.data-table th {\n    padding: 18px;\n    text-align: left;\n    font-weight: 600;\n    font-size: 14px;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n}\n\n.data-table tbody tr {\n    border-bottom: 1px solid var(--gray);\n    transition: all 0.3s ease;\n}\n\n.data-table tbody tr:hover {\n    background: var(--lighter-blue);\n    transform: scale(1.01);\n}\n\n.data-table td {\n    padding: 18px;\n    font-size: 14px;\n}\n\n.status-badge {\n    padding: 6px 12px;\n    border-radius: 20px;\n    font-size: 12px;\n    font-weight: 600;\n    text-transform: uppercase;\n    display: inline-block;\n}\n\n.status-pending {\n    background: rgba(245, 158, 11, 0.2);\n    color: var(--warning);\n}\n\n.status-completed {\n    background: rgba(16, 185, 129, 0.2);\n    color: var(--success);\n}\n\n.status-rejected {\n    background: rgba(239, 68, 68, 0.2);\n    color: var(--danger);\n}\n\n.action-btns {\n    display: flex;\n    gap: 8px;\n}\n\n.btn-success, .btn-danger {\n    padding: 8px 16px;\n    border: none;\n    border-radius: 8px;\n    font-size: 12px;\n    font-weight: 600;\n    cursor: pointer;\n    transition: all 0.3s ease;\n}\n\n.btn-success {\n    background: var(--success);\n    color: var(--white);\n}\n\n.btn-success:hover {\n    background: #059669;\n    transform: scale(1.1);\n}\n\n.btn-danger {\n    background: var(--danger);\n    color: var(--white);\n}\n\n.btn-danger:hover {\n    background: #dc2626;\n    transform: scale(1.1);\n}\n\n.products-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));\n    gap: 25px;\n}\n\n@media (max-width: 640px) {\n    .products-grid {\n        grid-template-columns: 1fr;\n    }\n}\n\n.product-card {\n    background: var(--white);\n    border-radius: 15px;\n    padding: 20px;\n    box-shadow: var(--shadow-md);\n    transition: all 0.3s ease;\n    animation: fadeInScale 0.5s ease-out;\n}\n\n.product-card:hover {\n    transform: translateY(-10px);\n    box-shadow: var(--shadow-xl);\n}\n\n.product-display-card {\n    background: var(--white);\n    border-radius: 16px;\n    overflow: hidden;\n    box-shadow: var(--shadow-md);\n    transition: all 0.3s ease;\n    position: relative;\n}\n\n.product-display-card:hover {\n    transform: translateY(-8px);\n    box-shadow: var(--shadow-xl);\n}\n\n.product-display-card:hover .product-actions-overlay {\n    opacity: 1;\n    visibility: visible;\n}\n\n.product-display-card.inactive {\n    opacity: 0.6;\n}\n\n.product-image-placeholder {\n    width: 100%;\n    height: 200px;\n    background: linear-gradient(135deg, var(--lighter-blue) 0%, var(--light-gray) 100%);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 64px;\n    color: var(--primary-blue);\n}\n\n.product-info {\n    padding: 20px;\n}\n\n.product-title {\n    font-size: 18px;\n    font-weight: 700;\n    color: var(--text-dark);\n    margin-bottom: 8px;\n    min-height: 50px;\n    display: -webkit-box;\n    -webkit-line-clamp: 2;\n    -webkit-box-orient: vertical;\n    overflow: hidden;\n}\n\n.product-category {\n    font-size: 13px;\n    color: var(--gray);\n    margin-bottom: 12px;\n}\n\n.product-price-tag {\n    font-size: 28px;\n    font-weight: 700;\n    color: var(--primary-blue);\n    margin-bottom: 12px;\n}\n\n.product-stock-info {\n    padding: 8px 12px;\n    border-radius: 8px;\n    font-size: 14px;\n    font-weight: 600;\n    margin-bottom: 12px;\n    display: inline-block;\n}\n\n.product-stock-info.in-stock {\n    background: rgba(5, 150, 105, 0.1);\n    color: var(--success);\n}\n\n.product-stock-info.low-stock {\n    background: rgba(217, 119, 6, 0.1);\n    color: var(--warning);\n}\n\n.product-stock-info.out-of-stock {\n    background: rgba(220, 38, 38, 0.1);\n    color: var(--danger);\n}\n\n.product-meta {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding-top: 12px;\n    border-top: 1px solid var(--lighter-blue);\n}\n\n.product-id {\n    font-size: 11px;\n    color: var(--gray);\n    font-family: monospace;\n}\n\n.product-status {\n    font-size: 12px;\n    font-weight: 600;\n    padding: 4px 10px;\n    border-radius: 12px;\n}\n\n.product-status.active {\n    background: rgba(5, 150, 105, 0.1);\n    color: var(--success);\n}\n\n.product-status.inactive {\n    background: rgba(220, 38, 38, 0.1);\n    color: var(--danger);\n}\n\n.product-actions-overlay {\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.8);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 10px;\n    opacity: 0;\n    visibility: hidden;\n    transition: all 0.3s ease;\n    padding: 20px;\n}\n\n.btn-action {\n    width: 45px;\n    height: 45px;\n    border-radius: 50%;\n    background: var(--white);\n    color: var(--primary-blue);\n    border: none;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 18px;\n    transition: all 0.3s ease;\n    box-shadow: var(--shadow-md);\n}\n\n.btn-action:hover {\n    transform: scale(1.15);\n    box-shadow: var(--shadow-lg);\n}\n\n.btn-action.danger {\n    color: var(--danger);\n}\n\n.btn-action.danger:hover {\n    background: var(--danger);\n    color: var(--white);\n}\n\n.stat-mini-card {\n    background: var(--white);\n    border-radius: 12px;\n    padding: 20px;\n    box-shadow: var(--shadow-sm);\n    display: flex;\n    align-items: center;\n    gap: 15px;\n    transition: all 0.3s ease;\n}\n\n.stat-mini-card:hover {\n    transform: translateY(-5px);\n    box-shadow: var(--shadow-md);\n}\n\n.stat-mini-card i {\n    font-size: 32px;\n    color: var(--primary-blue);\n}\n\n.stat-mini-card p {\n    margin: 0;\n    font-size: 13px;\n    color: var(--gray);\n}\n\n.stat-mini-card h3 {\n    margin: 5px 0 0 0;\n    font-size: 28px;\n    font-weight: 700;\n    color: var(--text-dark);\n}\n\n.product-header {\n    margin-bottom: 15px;\n}\n\n.product-name {\n    font-size: 18px;\n    font-weight: 600;\n    color: var(--text-dark);\n    margin-bottom: 5px;\n}\n\n.product-category {\n    font-size: 12px;\n    color: var(--dark-gray);\n    text-transform: uppercase;\n}\n\n.product-price {\n    font-size: 24px;\n    font-weight: 700;\n    color: var(--primary-blue);\n    margin-bottom: 10px;\n}\n\n.product-stock {\n    font-size: 14px;\n    color: var(--dark-gray);\n    margin-bottom: 15px;\n}\n\n.product-actions {\n    display: flex;\n    gap: 10px;\n}\n\n.btn-edit, .btn-delete {\n    flex: 1;\n    padding: 10px;\n    border: none;\n    border-radius: 8px;\n    font-weight: 600;\n    cursor: pointer;\n    transition: all 0.3s ease;\n}\n\n.btn-edit {\n    background: var(--light-blue);\n    color: var(--white);\n}\n\n.btn-edit:hover {\n    background: var(--primary-blue);\n}\n\n.btn-delete {\n    background: var(--danger);\n    color: var(--white);\n}\n\n.btn-delete:hover {\n    background: #dc2626;\n}\n\n.modal {\n    display: none;\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.7);\n    backdrop-filter: blur(5px);\n    z-index: 1000;\n    animation: fadeIn 0.3s ease-out;\n}\n\n.modal.active {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.modal-content {\n    background: var(--white);\n    border-radius: 20px;\n    padding: 30px;\n    max-width: 500px;\n    width: 90%;\n    max-height: 80vh;\n    overflow-y: auto;\n    box-shadow: var(--shadow-xl);\n    animation: zoomIn 0.3s ease-out;\n}\n\n@keyframes zoomIn {\n    from {\n        opacity: 0;\n        transform: scale(0.8);\n    }\n    to {\n        opacity: 1;\n        transform: scale(1);\n    }\n}\n\n.modal-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 25px;\n    padding-bottom: 15px;\n    border-bottom: 2px solid var(--lighter-blue);\n}\n\n.modal-header h2 {\n    font-size: 24px;\n    font-weight: 700;\n    color: var(--text-dark);\n}\n\n.btn-close {\n    width: 35px;\n    height: 35px;\n    border-radius: 50%;\n    border: none;\n    background: var(--gray);\n    color: var(--text-dark);\n    cursor: pointer;\n    transition: all 0.3s ease;\n}\n\n.btn-close:hover {\n    background: var(--danger);\n    color: var(--white);\n    transform: rotate(90deg);\n}\n\n.modal-form .form-group {\n    margin-bottom: 20px;\n}\n\n.modal-form label {\n    display: block;\n    margin-bottom: 8px;\n    font-weight: 600;\n    color: var(--text-dark);\n}\n\n.modal-form input,\n.modal-form select,\n.modal-form textarea {\n    width: 100%;\n    padding: 12px;\n    border: 2px solid var(--gray);\n    border-radius: 10px;\n    font-family: 'Poppins', sans-serif;\n    font-size: 14px;\n    transition: all 0.3s ease;\n}\n\n.modal-form input:focus,\n.modal-form select:focus,\n.modal-form textarea:focus {\n    outline: none;\n    border-color: var(--primary-blue);\n    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);\n}\n\n.modal-actions {\n    display: flex;\n    gap: 15px;\n    margin-top: 25px;\n}\n\n.modal-actions button {\n    flex: 1;\n}\n\n.loading-spinner {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    padding: 40px;\n}\n\n.loading-spinner i {\n    font-size: 32px;\n    color: var(--primary-blue);\n    animation: spin 1s linear infinite;\n}\n\n@keyframes spin {\n    from {\n        transform: rotate(0deg);\n    }\n    to {\n        transform: rotate(360deg);\n    }\n}\n\n.loading-cell {\n    text-align: center;\n}\n\n.notification {\n    position: fixed;\n    top: 30px;\n    right: 30px;\n    padding: 20px 30px;\n    background: var(--white);\n    border-radius: 15px;\n    box-shadow: var(--shadow-xl);\n    z-index: 2000;\n    transform: translateX(400px);\n    opacity: 0;\n    transition: all 0.4s ease;\n}\n\n.notification.show {\n    transform: translateX(0);\n    opacity: 1;\n}\n\n.notification.success {\n    border-left: 5px solid var(--success);\n}\n\n.notification.error {\n    border-left: 5px solid var(--danger);\n}\n\n.settings-form {\n    background: var(--white);\n    border-radius: 20px;\n    padding: 30px;\n    box-shadow: var(--shadow-md);\n}\n\n.settings-form .form-group {\n    margin-bottom: 25px;\n}\n\n.settings-form label {\n    display: block;\n    margin-bottom: 10px;\n    font-weight: 600;\n    color: var(--text-dark);\n}\n\n.settings-form input,\n.settings-form select {\n    width: 100%;\n    padding: 15px;\n    border: 2px solid var(--gray);\n    border-radius: 12px;\n    font-family: 'Poppins', sans-serif;\n    font-size: 16px;\n    transition: all 0.3s ease;\n}\n\n.settings-form input:focus,\n.settings-form select:focus {\n    outline: none;\n    border-color: var(--primary-blue);\n    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);\n}\n\n.analytics-container {\n    background: var(--white);\n    border-radius: 20px;\n    padding: 30px;\n    box-shadow: var(--shadow-md);\n}\n\n.chart-card {\n    margin-bottom: 30px;\n}\n\n.chart-card h3 {\n    margin-bottom: 20px;\n    color: var(--text-dark);\n    font-size: 20px;\n}\n\n@media (max-width: 1024px) {\n    .sidebar {\n        transform: translateX(0);\n        width: 250px;\n    }\n\n    .sidebar.collapsed {\n        transform: translateX(-100%);\n    }\n\n    .main-content {\n        margin-left: 0;\n    }\n\n    .stats-grid {\n        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));\n    }\n\n    .dashboard-grid {\n        grid-template-columns: 1fr;\n    }\n\n    .sidebar-toggle {\n        display: block;\n        position: fixed;\n        top: 15px;\n        left: 15px;\n        z-index: 1001;\n        background: var(--primary-blue);\n        color: white;\n        border: none;\n        border-radius: 8px;\n        padding: 10px 15px;\n        cursor: pointer;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n        font-weight: 600;\n    }\n}\n\n@media (max-width: 768px) {\n    .login-card {\n        padding: 20px 15px;\n        max-width: 95%;\n    }\n\n    .logo-circle {\n        width: 50px;\n        height: 50px;\n    }\n\n    .logo-circle i {\n        font-size: 24px;\n    }\n\n    .login-title {\n        font-size: 18px;\n    }\n\n    .login-subtitle {\n        font-size: 11px;\n    }\n\n    .input-group input {\n        padding: 12px 14px 12px 45px;\n        font-size: 13px;\n    }\n\n    .input-group i {\n        font-size: 16px;\n        left: 15px;\n    }\n\n    .btn-login {\n        padding: 12px;\n        font-size: 13px;\n    }\n\n    .page-header {\n        flex-direction: column;\n        align-items: flex-start;\n        gap: 10px;\n        margin-bottom: 20px;\n    }\n\n    .page-title {\n        font-size: 22px;\n    }\n\n    .page-subtitle {\n        font-size: 13px;\n    }\n\n    .stats-grid {\n        grid-template-columns: 1fr;\n        gap: 12px;\n    }\n\n    .stat-card {\n        padding: 15px 12px;\n    }\n\n    .stat-icon {\n        width: 40px;\n        height: 40px;\n        font-size: 18px;\n        margin-bottom: 10px;\n    }\n\n    .stat-value {\n        font-size: 20px;\n    }\n\n    .stat-label {\n        font-size: 11px;\n    }\n\n    .stat-trend {\n        font-size: 10px;\n    }\n\n    .products-grid {\n        grid-template-columns: 1fr;\n        gap: 15px;\n    }\n\n    .product-card {\n        padding: 16px;\n    }\n\n    .product-name {\n        font-size: 16px;\n    }\n\n    .product-price {\n        font-size: 20px;\n    }\n\n    .product-stock {\n        font-size: 13px;\n    }\n\n    .data-table {\n        font-size: 12px;\n        display: block;\n        overflow-x: auto;\n        -webkit-overflow-scrolling: touch;\n        white-space: nowrap;\n    }\n\n    .data-table th,\n    .data-table td {\n        padding: 10px 8px;\n        font-size: 12px;\n        min-width: 80px;\n    }\n\n    .modal-content {\n        width: 92%;\n        padding: 20px;\n        max-height: 85vh;\n    }\n\n    .modal-header h2 {\n        font-size: 18px;\n    }\n\n    .modal-form input,\n    .modal-form select,\n    .modal-form textarea {\n        padding: 12px;\n        font-size: 14px;\n    }\n\n    .modal-form label {\n        font-size: 13px;\n    }\n\n    .action-btns {\n        gap: 6px;\n        flex-wrap: wrap;\n    }\n\n    .action-btns button {\n        padding: 8px 12px;\n        font-size: 11px;\n    }\n\n    .btn-primary,\n    .btn-secondary,\n    .btn-success,\n    .btn-danger,\n    .btn-refresh {\n        padding: 10px 16px;\n        font-size: 13px;\n    }\n\n    .btn-edit,\n    .btn-delete {\n        padding: 10px;\n        font-size: 13px;\n    }\n\n    .dashboard-card {\n        padding: 16px;\n    }\n\n    .card-header h3 {\n        font-size: 16px;\n    }\n\n    .main-content {\n        padding: 15px;\n        padding-top: 70px;\n    }\n\n    .notification {\n        top: 15px;\n        right: 15px;\n        left: 15px;\n        padding: 12px 18px;\n        font-size: 13px;\n    }\n\n    .sidebar {\n        width: 240px;\n        padding: 20px 10px;\n        padding-bottom: 90px;\n    }\n\n    .sidebar-user {\n        padding: 12px;\n        gap: 10px;\n    }\n\n    .user-avatar {\n        width: 35px;\n        height: 35px;\n        font-size: 18px;\n    }\n\n    .user-name {\n        font-size: 12px;\n    }\n\n    .user-role {\n        font-size: 9px;\n    }\n\n    .menu-item {\n        padding: 10px 12px;\n        font-size: 12px;\n        gap: 10px;\n        margin-bottom: 5px;\n    }\n\n    .menu-item i {\n        font-size: 14px;\n        width: 20px;\n    }\n\n    .sidebar-footer {\n        position: fixed;\n        bottom: 0;\n        left: 0;\n        width: 240px;\n        background: white;\n        padding: 12px 10px;\n        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);\n        z-index: 101;\n        border-top: 1px solid var(--gray);\n        transition: transform 0.3s ease;\n    }\n\n    .sidebar.collapsed .sidebar-footer {\n        transform: translateX(-100%);\n    }\n\n    .btn-logout {\n        width: 100%;\n        padding: 12px;\n        font-size: 13px;\n        gap: 8px;\n    }\n}\n\n.sidebar-toggle {\n    display: none;\n}\n\n@media (max-width: 768px) {\n    .sidebar {\n        transform: translateX(0);\n        transition: transform 0.3s ease;\n        z-index: 1000;\n        width: 250px;\n    }\n\n    .sidebar.collapsed {\n        transform: translateX(-100%);\n    }\n\n    .sidebar-toggle {\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        position: fixed;\n        top: 20px;\n        left: 20px;\n        z-index: 1001;\n        background: var(--gradient-2);\n        color: white;\n        border: none;\n        border-radius: 12px;\n        padding: 12px 20px;\n        cursor: pointer;\n        box-shadow: var(--shadow-md);\n        font-weight: 600;\n        font-size: 14px;\n        transition: all 0.3s ease;\n    }\n\n    .sidebar-toggle:hover {\n        transform: translateY(-2px);\n        box-shadow: var(--shadow-lg);\n    }\n\n    .sidebar-toggle:active {\n        transform: translateY(0);\n    }\n\n    .sidebar-toggle i {\n        font-size: 18px;\n    }\n\n    .main-content {\n        margin-left: 0;\n        width: 100%;\n        padding-top: 60px;\n    }\n}\n\n.sidebar-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 20px;\n}\n\n\n.sessions-container {\n    display: flex;\n    gap: 20px;\n    height: calc(100vh - 200px);\n    margin-top: 20px;\n}\n\n.sessions-list-panel {\n    width: 350px;\n    background: white;\n    border-radius: 12px;\n    box-shadow: var(--shadow-md);\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n}\n\n.sessions-list-header {\n    padding: 20px;\n    border-bottom: 1px solid var(--lighter-blue);\n    background: var(--gradient-1);\n    color: white;\n}\n\n.sessions-list-header h3 {\n    margin: 0;\n    font-size: 18px;\n    font-weight: 600;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n.sessions-list {\n    flex: 1;\n    overflow-y: auto;\n    padding: 10px;\n}\n\n.session-item {\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    padding: 15px;\n    border-radius: 10px;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    margin-bottom: 8px;\n    border: 2px solid transparent;\n}\n\n.session-item:hover {\n    background: var(--light-gray);\n}\n\n.session-item.active {\n    background: var(--lighter-blue);\n    border-color: var(--primary-blue);\n}\n\n.session-avatar {\n    font-size: 40px;\n    color: var(--primary-blue);\n}\n\n.session-info {\n    flex: 1;\n}\n\n.session-info h4 {\n    margin: 0;\n    font-size: 15px;\n    font-weight: 600;\n    color: var(--text-dark);\n}\n\n.session-info p {\n    margin: 2px 0;\n    font-size: 13px;\n    color: var(--gray);\n}\n\n.session-info small {\n    font-size: 11px;\n    color: var(--gray);\n}\n\n.session-status {\n    display: flex;\n    align-items: center;\n}\n\n.status-dot {\n    width: 10px;\n    height: 10px;\n    border-radius: 50%;\n    background: var(--gray);\n}\n\n.status-dot.active {\n    background: var(--success);\n    animation: pulse 2s infinite;\n}\n\n@keyframes pulse {\n    0%, 100% {\n        opacity: 1;\n    }\n    50% {\n        opacity: 0.5;\n    }\n}\n\n.chat-panel {\n    flex: 1;\n    background: white;\n    border-radius: 12px;\n    box-shadow: var(--shadow-md);\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n}\n\n.message-avatar {\n    width: 32px;\n    height: 32px;\n    border-radius: 50%;\n    background: var(--lighter-blue);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: var(--primary-blue);\n    flex-shrink: 0;\n}\n\n.chat-message.admin .message-avatar {\n    background: var(--light-green);\n    color: var(--success);\n}\n\n.message-bubble {\n    flex: 1;\n    background: white;\n    padding: 12px 15px;\n    border-radius: 12px;\n    border: 2px solid var(--light-gray);\n}\n\n.chat-message.admin .message-bubble {\n    background: var(--lighter-blue);\n    border-color: var(--primary-blue);\n}\n\n.message-sender {\n    font-size: 12px;\n    font-weight: 600;\n    color: var(--gray);\n    margin-bottom: 4px;\n}\n\n.message-text {\n    font-size: 14px;\n    color: var(--text-dark);\n    margin-bottom: 4px;\n    word-wrap: break-word;\n}\n\n.message-image {\n    max-width: 100%;\n    max-height: 300px;\n    border-radius: 8px;\n    margin-top: 8px;\n    cursor: pointer;\n}\n\n.message-time {\n    font-size: 11px;\n    color: var(--gray);\n    margin-top: 4px;\n}\n\n.chat-message {\n    display: flex;\n    gap: 10px;\n    margin-bottom: 15px;\n    animation: slideIn 0.3s ease;\n}\n\n@keyframes slideIn {\n    from {\n        opacity: 0;\n        transform: translateY(10px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.chat-placeholder {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    color: var(--gray);\n    padding: 40px;\n    text-align: center;\n}\n\n.chat-placeholder h3 {\n    margin: 0 0 10px 0;\n    color: var(--dark-gray);\n}\n\n.chat-placeholder p {\n    color: var(--gray);\n    margin: 0;\n}\n\n.chat-container {\n    display: none;\n    flex-direction: column;\n    height: 100%;\n}\n\n.chat-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 20px;\n    border-bottom: 1px solid var(--lighter-blue);\n    background: var(--gradient-1);\n    color: white;\n}\n\n.chat-user-info {\n    display: flex;\n    align-items: center;\n}\n\n.chat-user-info h4 {\n    margin: 0;\n    font-size: 16px;\n    font-weight: 600;\n}\n\n.chat-user-info p {\n    margin: 4px 0 0 0;\n    font-size: 13px;\n    opacity: 0.9;\n}\n\n.chat-messages {\n    flex: 1;\n    overflow-y: auto;\n    padding: 20px;\n    background: #f8fafc;\n    display: flex;\n    flex-direction: column;\n    gap: 12px;\n}\n\n.message {\n    display: flex;\n    margin-bottom: 12px;\n    animation: messageSlide 0.3s ease;\n    width: 100%;\n}\n\n@keyframes messageSlide {\n    from {\n        opacity: 0;\n        transform: translateY(10px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.message-user {\n    justify-content: flex-start;\n    align-items: flex-start;\n}\n\n.message-admin {\n    justify-content: flex-end;\n    align-items: flex-end;\n}\n\n.message-bubble {\n    max-width: 70%;\n    padding: 12px 16px;\n    border-radius: 12px;\n    box-shadow: var(--shadow-sm);\n    word-wrap: break-word;\n    display: inline-block;\n}\n\n.message-user .message-bubble {\n    background: var(--light);\n    border: 1px solid var(--lighter);\n    border-bottom-left-radius: 4px;\n    margin-right: auto;\n    color: var(--text-dark);\n    box-shadow: var(--shadow-sm);\n}\n\n.message-admin .message-bubble {\n    background: var(--gradient-2);\n    color: white;\n    border-bottom-right-radius: 4px;\n    margin-left: auto;\n    box-shadow: var(--shadow-sm);\n}\n\n.message-text {\n    font-size: 14px;\n    line-height: 1.5;\n    word-wrap: break-word;\n}\n\n.message-time {\n    font-size: 11px;\n    margin-top: 6px;\n    opacity: 0.7;\n}\n\n.chat-input-container {\n    display: flex;\n    flex-direction: column;\n    gap: 12px;\n    padding: 20px;\n    border-top: 2px solid var(--lighter);\n    background: var(--white);\n    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);\n}\n\n.chat-media-buttons {\n    display: flex;\n    gap: 8px;\n    flex-wrap: wrap;\n}\n\n.btn-media {\n    padding: 10px 14px;\n    background: var(--light);\n    color: var(--accent);\n    border: 2px solid var(--lighter);\n    border-radius: 8px;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    font-size: 16px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.btn-media:hover {\n    background: var(--gradient-2);\n    color: white;\n    border-color: var(--accent);\n    transform: translateY(-2px);\n    box-shadow: var(--shadow-md);\n}\n\n.btn-media:active {\n    transform: translateY(0);\n}\n\n.btn-media.recording {\n    background: var(--danger);\n    color: white;\n    animation: pulse 1.5s infinite;\n}\n\n@keyframes pulse {\n    0%, 100% {\n        opacity: 1;\n    }\n    50% {\n        opacity: 0.7;\n    }\n}\n\n.chat-input-wrapper {\n    display: flex;\n    gap: 12px;\n}\n\n.chat-input-container textarea {\n    flex: 1;\n    padding: 14px;\n    border: 2px solid var(--lighter);\n    border-radius: 10px;\n    font-family: 'Poppins', sans-serif;\n    font-size: 14px;\n    resize: none;\n    transition: all 0.2s ease;\n    background: var(--light);\n}\n\n.chat-input-container textarea:focus {\n    outline: none;\n    border-color: var(--accent);\n    background: var(--white);\n    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);\n}\n\n.btn-send {\n    padding: 14px 28px;\n    background: var(--gradient-2);\n    color: white;\n    border: none;\n    border-radius: 10px;\n    font-family: 'Poppins', sans-serif;\n    font-weight: 600;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    box-shadow: var(--shadow-sm);\n}\n\n.btn-send:hover {\n    background: var(--accent-dark);\n    transform: translateY(-3px);\n    box-shadow: var(--shadow-lg);\n}\n\n.btn-send:active {\n    transform: translateY(0);\n}\n\n.empty-state {\n    text-align: center;\n    padding: 40px;\n    color: var(--gray);\n}\n\n.empty-state i {\n    font-size: 48px;\n    margin-bottom: 16px;\n    opacity: 0.5;\n}\n\n.empty-state p {\n    margin: 0;\n    font-size: 14px;\n}\n\n@media (max-width: 768px) {\n    .sessions-container {\n        flex-direction: column;\n        height: auto;\n        gap: 15px;\n    }\n\n    .sessions-list-panel {\n        width: 100%;\n        max-height: 250px;\n        border-radius: 10px;\n    }\n\n    .chat-panel {\n        height: 500px;\n        border-radius: 10px;\n    }\n\n    .message-bubble {\n        max-width: 85%;\n        padding: 10px 14px;\n        font-size: 13px;\n    }\n    \n    .chat-input-container {\n        padding: 15px;\n        gap: 10px;\n    }\n    \n    .btn-media {\n        padding: 8px 10px;\n        font-size: 14px;\n    }\n    \n    .btn-send {\n        padding: 12px 20px;\n        font-size: 13px;\n    }\n    \n    .chat-input-container textarea {\n        padding: 12px;\n        font-size: 13px;\n    }\n}\n\n@media (max-width: 480px) {\n    .sessions-container {\n        margin-top: 10px;\n    }\n    \n    .sessions-list-panel {\n        max-height: 200px;\n    }\n    \n    .chat-panel {\n        height: 450px;\n    }\n    \n    .chat-media-buttons {\n        gap: 6px;\n    }\n    \n    .btn-media {\n        padding: 6px 8px;\n        font-size: 12px;\n    }\n    \n    .message-bubble {\n        max-width: 90%;\n        padding: 8px 12px;\n        font-size: 12px;\n    }\n    \n    .message-time {\n        font-size: 10px;\n    }\n    \n    .session-item {\n        padding: 12px;\n    }\n    \n    .session-avatar {\n        font-size: 32px;\n    }\n    \n    .session-info h4 {\n        font-size: 14px;\n    }\n    \n    .session-info p {\n        font-size: 12px;\n    }\n}\n\n#productDetailModal .modal-content {\n    animation: slideInFromBottom 0.3s ease-out;\n}\n\n@keyframes slideInFromBottom {\n    from {\n        opacity: 0;\n        transform: translateY(50px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n#productDetailModal h3 {\n    color: var(--text-dark);\n    font-weight: 600;\n}\n\n#productDetailModal h4 {\n    color: inherit;\n    font-weight: 600;\n    margin: 0;\n}\n\n@media (max-width: 768px) {\n    #productDetailModal .modal-content {\n        max-width: 95% !important;\n        margin: 10px;\n    }\n\n    #productDetailModal [style*=\"grid-template-columns\"] {\n        grid-template-columns: 1fr !important;\n    }\n\n    .sidebar {\n        width: 260px;\n        padding: 15px 0;\n        padding-bottom: 85px;\n    }\n\n    .sidebar-header {\n        padding: 0 15px 15px;\n        margin-bottom: 20px;\n    }\n\n    .sidebar-logo {\n        width: 48px;\n        height: 48px;\n        border-radius: 14px;\n    }\n\n    .sidebar-logo i {\n        font-size: 22px;\n    }\n\n    .sidebar-title {\n        font-size: 16px;\n    }\n\n    .sidebar-user {\n        margin: 0 12px 20px;\n        padding: 14px;\n        gap: 10px;\n        border-radius: 14px;\n    }\n\n    .user-avatar {\n        width: 40px;\n        height: 40px;\n        font-size: 18px;\n        border-radius: 10px;\n    }\n\n    .user-name {\n        font-size: 13px;\n    }\n\n    .user-role {\n        font-size: 10px;\n    }\n\n    .sidebar-menu {\n        padding: 0 10px;\n    }\n\n    .menu-item {\n        padding: 11px 14px;\n        font-size: 13px;\n        gap: 10px;\n        margin-bottom: 3px;\n        border-radius: 9px;\n    }\n\n    .menu-item i {\n        font-size: 16px;\n        width: 18px;\n    }\n\n    .badge {\n        font-size: 10px;\n        padding: 2px 6px;\n    }\n\n    .sidebar-footer {\n        position: fixed;\n        bottom: 0;\n        left: 0;\n        width: 260px;\n        background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,1) 100%);\n        padding: 15px 10px;\n        box-shadow: 0 -3px 15px rgba(0,0,0,0.08);\n        z-index: 101;\n        border-top: 1px solid rgba(0, 0, 0, 0.06);\n        transition: transform 0.3s ease;\n        backdrop-filter: blur(10px);\n    }\n\n    .sidebar.collapsed .sidebar-footer {\n        transform: translateX(-100%);\n    }\n\n    .btn-logout {\n        padding: 12px;\n        font-size: 13px;\n        gap: 7px;\n        border-radius: 9px;\n    }\n\n    .btn-logout i {\n        font-size: 15px;\n    }\n}\n\n.broadcast-main-panel {\n    display: grid;\n    grid-template-columns: 2fr 1fr;\n    gap: 25px;\n    margin-top: 20px;\n}\n\n.broadcast-form-card {\n    background: white;\n    border-radius: 20px;\n    padding: 30px;\n    box-shadow: var(--shadow-md);\n}\n\n.broadcast-stats-card {\n    background: white;\n    border-radius: 20px;\n    padding: 30px;\n    box-shadow: var(--shadow-md);\n}\n\n.broadcast-stats-card h3 {\n    margin-bottom: 25px;\n    color: var(--primary-blue);\n    font-size: 18px;\n}\n\n.broadcast-stats-card .stat-item {\n    display: flex;\n    align-items: center;\n    gap: 15px;\n    padding: 15px;\n    background: var(--light-gray);\n    border-radius: 12px;\n    margin-bottom: 12px;\n}\n\n.broadcast-stats-card .stat-item i {\n    font-size: 24px;\n    color: var(--primary-blue);\n}\n\n.broadcast-stats-card .stat-item small {\n    display: block;\n    color: var(--gray);\n    font-size: 12px;\n}\n\n.broadcast-stats-card .stat-item strong {\n    display: block;\n    color: var(--text-dark);\n    font-size: 20px;\n    font-weight: 700;\n}\n\n.broadcast-step {\n    margin-bottom: 30px;\n}\n\n.broadcast-step h3 {\n    color: var(--primary-blue);\n    font-size: 16px;\n    margin-bottom: 15px;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n.broadcast-step textarea {\n    width: 100%;\n    padding: 15px;\n    border: 2px solid var(--lighter-blue);\n    border-radius: 12px;\n    font-family: 'Poppins', sans-serif;\n    font-size: 14px;\n    resize: vertical;\n    transition: all 0.3s ease;\n}\n\n.broadcast-step textarea:focus {\n    outline: none;\n    border-color: var(--primary-blue);\n    box-shadow: 0 0 0 4px rgba(60, 70, 84, 0.1);\n}\n\n.broadcast-step input[type=\"text\"] {\n    width: 100%;\n    padding: 12px;\n    border: 2px solid var(--lighter-blue);\n    border-radius: 10px;\n    font-family: 'Poppins', sans-serif;\n    font-size: 14px;\n    transition: all 0.3s ease;\n}\n\n.broadcast-step input[type=\"text\"]:focus {\n    outline: none;\n    border-color: var(--primary-blue);\n    box-shadow: 0 0 0 4px rgba(60, 70, 84, 0.1);\n}\n\n.broadcast-targets {\n    display: flex;\n    flex-direction: column;\n    gap: 12px;\n}\n\n.broadcast-option {\n    display: block;\n    cursor: pointer;\n}\n\n.broadcast-option input[type=\"radio\"] {\n    display: none;\n}\n\n.broadcast-option .option-content {\n    display: flex;\n    align-items: center;\n    gap: 15px;\n    padding: 15px 20px;\n    border: 2px solid var(--lighter-blue);\n    border-radius: 12px;\n    transition: all 0.3s ease;\n}\n\n.broadcast-option input[type=\"radio\"]:checked + .option-content {\n    border-color: var(--primary-blue);\n    background: linear-gradient(135deg, rgba(60, 70, 84, 0.05) 0%, rgba(60, 70, 84, 0.1) 100%);\n}\n\n.broadcast-option .option-content i {\n    font-size: 24px;\n    color: var(--primary-blue);\n}\n\n.broadcast-option .option-content strong {\n    display: block;\n    color: var(--text-dark);\n    font-size: 15px;\n    margin-bottom: 3px;\n}\n\n.broadcast-option .option-content small {\n    display: block;\n    color: var(--gray);\n    font-size: 12px;\n}\n\n.broadcast-actions {\n    margin-top: 25px;\n    padding-top: 25px;\n    border-top: 2px solid var(--lighter-blue);\n}\n\n.btn-broadcast-send {\n    width: 100%;\n    padding: 18px;\n    font-size: 16px;\n    font-weight: 600;\n}\n\n@media (max-width: 768px) {\n    .broadcast-main-panel {\n        grid-template-columns: 1fr;\n    }\n\n    .broadcast-form-card,\n    .broadcast-stats-card {\n        padding: 20px;\n    }\n\n    .broadcast-step h3 {\n        font-size: 14px;\n    }\n\n    .broadcast-option .option-content {\n        padding: 12px 15px;\n    }\n\n    .broadcast-option .option-content i {\n        font-size: 20px;\n    }\n\n    .broadcast-option .option-content strong {\n        font-size: 14px;\n    }\n}\n/* Pricing Tools Styles */\n.pricing-tools-container {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));\n    gap: 24px;\n    margin-bottom: 30px;\n}\n\n.tool-card {\n    background: white;\n    padding: 30px;\n    border-radius: 12px;\n    box-shadow: var(--shadow-md);\n    transition: transform 0.3s ease, box-shadow 0.3s ease;\n}\n\n.tool-card:hover {\n    transform: translateY(-5px);\n    box-shadow: var(--shadow-xl);\n}\n\n.tool-header {\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    margin-bottom: 15px;\n}\n\n.tool-header i {\n    font-size: 32px;\n    color: var(--accent);\n}\n\n.tool-header h3 {\n    font-size: 22px;\n    color: var(--text-dark);\n    margin: 0;\n}\n\n.tool-description {\n    color: var(--gray);\n    margin-bottom: 20px;\n    line-height: 1.6;\n}\n\n.results-container {\n    background: white;\n    padding: 20px;\n    border-radius: 12px;\n    box-shadow: var(--shadow-md);\n}\n\n.alert {\n    display: flex;\n    align-items: flex-start;\n    gap: 15px;\n    padding: 20px;\n    border-radius: 8px;\n    margin-bottom: 20px;\n}\n\n.alert i {\n    font-size: 24px;\n    margin-top: 2px;\n}\n\n.alert-success {\n    background: #d1fae5;\n    color: #065f46;\n    border-left: 4px solid var(--success);\n}\n\n.alert-warning {\n    background: #fef3c7;\n    color: #92400e;\n    border-left: 4px solid var(--warning);\n}\n\n.alert h3 {\n    margin: 0 0 8px 0;\n    font-size: 18px;\n}\n\n.alert p {\n    margin: 0;\n    font-size: 14px;\n}\n\n.pricing-issues-list {\n    display: flex;\n    flex-direction: column;\n    gap: 15px;\n}\n\n.pricing-issue-card {\n    background: #f8fafc;\n    border: 1px solid #e2e8f0;\n    border-radius: 8px;\n    padding: 20px;\n}\n\n.pricing-issue-card h4 {\n    margin: 0 0 15px 0;\n    color: var(--text-dark);\n    font-size: 16px;\n}\n\n.product-comparison {\n    display: flex;\n    align-items: center;\n    gap: 15px;\n    margin-bottom: 15px;\n    flex-wrap: wrap;\n}\n\n.product-item {\n    flex: 1;\n    min-width: 200px;\n    padding: 12px;\n    background: white;\n    border-radius: 6px;\n    border: 1px solid #e2e8f0;\n}\n\n.product-name {\n    display: block;\n    font-weight: 600;\n    color: var(--text-dark);\n    margin-bottom: 5px;\n}\n\n.product-qty {\n    display: block;\n    font-size: 13px;\n    color: var(--gray);\n    margin-bottom: 5px;\n}\n\n.product-price {\n    display: block;\n    font-size: 18px;\n    font-weight: 700;\n    color: var(--accent);\n}\n\n.comparison-arrow {\n    font-size: 24px;\n    color: var(--gray);\n}\n\n.ratio-info {\n    display: flex;\n    gap: 15px;\n    padding: 12px;\n    background: white;\n    border-radius: 6px;\n    flex-wrap: wrap;\n}\n\n.ratio-label {\n    font-size: 13px;\n    color: var(--gray);\n}\n\n.ratio-value {\n    font-weight: 600;\n    color: var(--success);\n}\n\n.ratio-value.actual {\n    color: var(--danger);\n}\n\n.pricing-fix-summary {\n    background: #f8fafc;\n    padding: 20px;\n    border-radius: 8px;\n    margin-bottom: 20px;\n}\n\n.pricing-fix-summary h4 {\n    margin: 0 0 15px 0;\n    color: var(--text-dark);\n}\n\n.summary-stats {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    gap: 15px;\n}\n\n.stat-item {\n    display: flex;\n    flex-direction: column;\n    gap: 5px;\n}\n\n.stat-label {\n    font-size: 13px;\n    color: var(--gray);\n}\n\n.stat-value {\n    font-size: 16px;\n    font-weight: 600;\n    color: var(--text-dark);\n}\n\n.pricing-updates-list {\n    background: #f8fafc;\n    padding: 20px;\n    border-radius: 8px;\n}\n\n.pricing-updates-list h4 {\n    margin: 0 0 15px 0;\n    color: var(--text-dark);\n}\n\n.update-item {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 12px;\n    background: white;\n    border-radius: 6px;\n    margin-bottom: 10px;\n    border: 1px solid #e2e8f0;\n}\n\n.update-product {\n    font-weight: 500;\n    color: var(--text-dark);\n}\n\n.update-prices {\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n.old-price {\n    color: var(--danger);\n    text-decoration: line-through;\n}\n\n.new-price {\n    color: var(--success);\n    font-weight: 700;\n}\n\n/* Pricing Table Styles */\n.pricing-table {\n    width: 100%;\n    border-collapse: collapse;\n    margin-top: 10px;\n    background: white;\n    border-radius: 8px;\n    overflow: hidden;\n}\n\n.pricing-table thead {\n    background: var(--accent);\n    color: white;\n}\n\n.pricing-table th {\n    padding: 12px;\n    text-align: left;\n    font-weight: 600;\n    font-size: 14px;\n}\n\n.pricing-table td {\n    padding: 12px;\n    border-bottom: 1px solid #e2e8f0;\n    font-size: 14px;\n}\n\n.pricing-table tbody tr:hover {\n    background: #f8fafc;\n}\n\n.pricing-table .status-correct {\n    background: #d1fae5;\n}\n\n.pricing-table .status-incorrect {\n    background: #fef3c7;\n}\n\n#baseProductSelector {\n    padding: 15px;\n    background: #f8fafc;\n    border-radius: 8px;\n    border: 1px solid #e2e8f0;\n}\n\n#baseProductSelector label {\n    font-weight: 600;\n    color: var(--text-dark);\n    margin-bottom: 8px;\n    display: block;\n}\n","size_bytes":81114},"RENDER_DEPLOYMENT.md":{"content":"# üöÄ Panduan Deploy ke Render\n\n## Langkah-langkah Deploy Bot Telegram ke Render\n\n### 1Ô∏è‚É£ Push Kod ke GitHub\n```bash\ngit init\ngit add .\ngit commit -m \"Initial commit\"\ngit remote add origin YOUR_GITHUB_REPO_URL\ngit push -u origin main\n```\n\n### 2Ô∏è‚É£ Buat Web Service di Render\n\n1. Pergi ke [render.com](https://render.com)\n2. Login atau daftar akaun free\n3. Klik **\"New +\"** ‚Üí **\"Web Service\"**\n4. Connect repository GitHub anda\n5. Pilih repository bot Telegram anda\n\n### 3Ô∏è‚É£ Konfigurasi Web Service\n\n**Build Command:**\n```\nnpm install\n```\n\n**Start Command:**\n```\nnode index.js\n```\n\n**Environment:**\n- Runtime: `Node`\n- Region: Pilih yang terdekat (contoh: Singapore)\n- Branch: `main`\n- Plan: **Free** (untuk testing)\n\n### 4Ô∏è‚É£ Set Environment Variables\n\nKlik **\"Environment\"** dan tambah:\n\n| Key | Value | Keterangan |\n|-----|-------|------------|\n| `TELEGRAM_BOT_TOKEN` | `your_bot_token` | Token dari @BotFather |\n\n**Cara dapat Bot Token:**\n1. Chat dengan [@BotFather](https://t.me/BotFather) di Telegram\n2. Hantar `/newbot`\n3. Ikut arahan untuk nama dan username bot\n4. Copy token yang diberi\n\n### 5Ô∏è‚É£ Deploy!\n\n1. Klik **\"Create Web Service\"**\n2. Tunggu build selesai (2-5 minit)\n3. Bot akan start automatically\n\n---\n\n## ‚ö†Ô∏è Penting!\n\n### Free Tier Limits:\n- ‚úÖ 750 hours/month\n- ‚ö†Ô∏è Auto sleep selepas 15 min tanpa aktiviti\n- ‚úÖ Bot akan auto-wake bila ada message masuk\n\n### Tips:\n1. **Bot akan sleep bila tiada message**\n   - First message selepas sleep akan ada delay 30-60 saat\n   - Selepas itu bot akan respond dengan pantas\n   \n2. **Monitor Usage:**\n   - Check dashboard Render untuk usage\n   - 750 hours/month cukup untuk bot dengan active users\n   \n3. **Upgrade jika perlu:**\n   - Paid tier $7/month - no sleep, always online\n   - Good untuk production bot dengan ramai user 24/7\n\n---\n\n## üîç Troubleshooting\n\n### Bot tidak start?\n‚úÖ Check Environment Variables di Render:\n- `TELEGRAM_BOT_TOKEN` ada dan betul?\n- Check logs di Render dashboard untuk error messages\n- Restart service: Dashboard ‚Üí Manual Deploy ‚Üí **\"Deploy latest commit\"**\n\n### Bot tidak respond?\n‚úÖ Check Telegram:\n- Cuba send `/start` ke bot\n- Check status bot di @BotFather\n- Pastikan bot token betul di Environment Variables\n\n‚úÖ Check Logs di Render dashboard:\n- Klik **\"Logs\"** untuk lihat error\n- Pastikan bot successfully connected ke Telegram\n\n---\n\n## üì± Telegram Bot Commands\n\nTest bot anda dengan command:\n- `/start` - Start bot dan lihat menu utama\n- `/ping` - Check system status\n- `/list` - Lihat semua commands\n\n---\n\n## üéâ Siap!\n\nBot Telegram anda sekarang:\n- ‚úÖ Running di Render\n- ‚úÖ Respond kepada messages\n- ‚úÖ Semua features accessible via Telegram bot\n- ‚úÖ Free hosting!\n\n**Bot Username:** `@your_bot_username` (dari BotFather)\n**Commands:** Semua commands accessible via `/list` dalam Telegram\n\n---\n\n**Need help?** Check logs di Render dashboard atau contact support.\n","size_bytes":2911},"public/script.js":{"content":"let currentUser = null;\nlet authToken = null;\nlet salesChart = null;\nlet currentSessionToken = null;\n\ndocument.addEventListener('DOMContentLoaded', () => {\n    loadTheme();\n    loadLayout();\n    checkAuth();\n    setupEventListeners();\n});\n\nfunction loadTheme() {\n    const savedTheme = localStorage.getItem('appTheme') || 'midnight';\n    document.body.setAttribute('data-theme', savedTheme);\n    updateThemeSelection(savedTheme);\n}\n\nfunction loadLayout() {\n    const savedLayout = localStorage.getItem('appLayout') || 'modern';\n    document.body.setAttribute('data-layout', savedLayout);\n    updateLayoutSelection(savedLayout);\n}\n\nfunction changeTheme(theme) {\n    document.body.setAttribute('data-theme', theme);\n    localStorage.setItem('appTheme', theme);\n    updateThemeSelection(theme);\n    showNotification(`Tema ditukar ke ${getThemeName(theme)}`, 'success');\n}\n\nfunction changeLayout(layout) {\n    document.body.setAttribute('data-layout', layout);\n    localStorage.setItem('appLayout', layout);\n    updateLayoutSelection(layout);\n    showNotification(`UI Layout ditukar ke ${getLayoutName(layout)}`, 'success');\n}\n\nfunction getThemeName(theme) {\n    const names = {\n        'midnight': 'Midnight Blue',\n        'emerald': 'Emerald Green',\n        'royal': 'Royal Purple'\n    };\n    return names[theme] || theme;\n}\n\nfunction updateThemeSelection(theme) {\n    document.querySelectorAll('.theme-option').forEach(option => {\n        option.classList.remove('active');\n        if (option.dataset.theme === theme) {\n            option.classList.add('active');\n        }\n    });\n}\n\nfunction updateLayoutSelection(layout) {\n    document.querySelectorAll('.layout-option').forEach(option => {\n        option.classList.remove('active');\n        if (option.dataset.layout === layout) {\n            option.classList.add('active');\n        }\n    });\n}\n\nfunction getLayoutName(layout) {\n    const names = {\n        'modern': 'Modern Dashboard',\n        'compact': 'Compact View',\n        'minimal': 'Minimal Clean',\n        'classic': 'Classic Dashboard',\n        'gradient': 'Gradient Modern',\n        'cardcentric': 'Card Centric',\n        'sideright': 'Sidebar Right',\n        'splitview': 'Split View',\n        'floating': 'Floating Cards',\n        'metro': 'Metro Style',\n        'material': 'Material Design',\n        'glass': 'Glass Morphism',\n        'darkpro': 'Dark Mode Pro',\n        'neon': 'Neon Glow',\n        'corporate': 'Corporate Blue',\n        'elegant': 'Elegant White',\n        'dashgrid': 'Dashboard Grid',\n        'timeline': 'Timeline View',\n        'magazine': 'Magazine Layout',\n        'collapsed': 'Sidebar Collapsed',\n        'fullwidth': 'Full Width',\n        'boxed': 'Boxed Layout',\n        'asymmetric': 'Asymmetric Grid'\n    };\n    return names[layout] || layout;\n}\n\nfunction getAuthHeaders() {\n    if (!authToken) {\n        return { 'Content-Type': 'application/json' };\n    }\n    return {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${authToken}`\n    };\n}\n\nfunction setupEventListeners() {\n    const loginForm = document.getElementById('loginForm');\n    if (loginForm) {\n        loginForm.addEventListener('submit', handleLogin);\n    }\n\n    const logoutBtn = document.getElementById('logoutBtn');\n    if (logoutBtn) {\n        logoutBtn.addEventListener('click', handleLogout);\n    }\n\n    const sidebarToggle = document.getElementById('sidebarToggle');\n    if (sidebarToggle) {\n        sidebarToggle.addEventListener('click', (e) => {\n            e.stopPropagation();\n            const sidebar = document.getElementById('mainSidebar');\n            sidebar.classList.toggle('collapsed');\n        });\n    }\n\n    document.addEventListener('click', (e) => {\n        const sidebar = document.getElementById('mainSidebar');\n        const sidebarToggle = document.getElementById('sidebarToggle');\n        if (sidebar && !sidebar.contains(e.target) && e.target !== sidebarToggle && !sidebarToggle.contains(e.target)) {\n            if (window.innerWidth <= 768) {\n                sidebar.classList.add('collapsed');\n            }\n        }\n    });\n\n    const menuItems = document.querySelectorAll('.menu-item');\n    menuItems.forEach(item => {\n        item.addEventListener('click', () => {\n            const page = item.dataset.page;\n            switchPage(page);\n        });\n    });\n\n    const addProductForm = document.getElementById('addProductForm');\n    if (addProductForm) {\n        addProductForm.addEventListener('submit', handleAddProduct);\n    }\n\n    const editProductForm = document.getElementById('editProductForm');\n    if (editProductForm) {\n        editProductForm.addEventListener('submit', handleEditProduct);\n    }\n\n    const addCategoryForm = document.getElementById('addCategoryForm');\n    if (addCategoryForm) {\n        addCategoryForm.addEventListener('submit', handleAddCategory);\n    }\n\n    const editCategoryForm = document.getElementById('editCategoryForm');\n    if (editCategoryForm) {\n        editCategoryForm.addEventListener('submit', handleEditCategory);\n    }\n\n    const addVoucherForm = document.getElementById('addVoucherForm');\n    if (addVoucherForm) {\n        addVoucherForm.addEventListener('submit', handleAddVoucher);\n    }\n\n    const addTemplateForm = document.getElementById('addTemplateForm');\n    if (addTemplateForm) {\n        addTemplateForm.addEventListener('submit', handleAddTemplate);\n    }\n\n    // Event listeners for chat input\n    const chatInput = document.getElementById('chatInput');\n    if (chatInput) {\n        chatInput.addEventListener('keypress', handleChatKeyPress);\n    }\n    const sendChatBtn = document.getElementById('sendChatMessageBtn');\n    if (sendChatBtn) {\n        sendChatBtn.addEventListener('click', sendChatMessage);\n    }\n    const closeSessionBtn = document.getElementById('closeSessionBtn');\n    if (closeSessionBtn) {\n        closeSessionBtn.addEventListener('click', closeCurrentSession);\n    }\n}\n\nfunction checkAuth() {\n    const userData = localStorage.getItem('adminUser');\n    const token = localStorage.getItem('authToken');\n    if (userData && token) {\n        currentUser = JSON.parse(userData);\n        authToken = token;\n        showDashboard();\n    } else {\n        showLoginPage();\n    }\n}\n\nfunction showLoginPage() {\n    document.getElementById('loginPage').classList.add('active');\n    document.getElementById('dashboardPage').classList.remove('active');\n}\n\nfunction showDashboard() {\n    document.getElementById('loginPage').classList.remove('active');\n    document.getElementById('dashboardPage').classList.add('active');\n\n    if (currentUser) {\n        document.getElementById('userName').textContent = currentUser.name;\n        document.getElementById('userRole').textContent = currentUser.role.toUpperCase();\n    }\n\n    loadDashboardData();\n}\n\nasync function handleLogin(e) {\n    e.preventDefault();\n\n    const telegramId = document.getElementById('telegramId').value;\n    const btn = e.target.querySelector('button');\n    const originalText = btn.innerHTML;\n\n    btn.innerHTML = '<i class=\"fas fa-spinner fa-spin\"></i> Logging in...';\n    btn.disabled = true;\n\n    try {\n        const response = await fetch('/api/auth/login', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({ telegramId })\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            currentUser = data.user;\n            authToken = data.token;\n            localStorage.setItem('adminUser', JSON.stringify(data.user));\n            localStorage.setItem('authToken', data.token);\n            showNotification('Login berjaya!', 'success');\n            setTimeout(() => {\n                showDashboard();\n            }, 500);\n        } else {\n            showNotification(data.message, 'error');\n            btn.innerHTML = originalText;\n            btn.disabled = false;\n        }\n    } catch (error) {\n        console.error('Login error:', error);\n        showNotification('Ralat semasa login. Sila cuba lagi.', 'error');\n        btn.innerHTML = originalText;\n        btn.disabled = false;\n    }\n}\n\nfunction handleLogout() {\n    // Clear all authentication data\n    localStorage.removeItem('adminUser');\n    localStorage.removeItem('authToken');\n    currentUser = null;\n    authToken = null;\n\n    // Clear any active sessions\n    if (currentSessionToken) {\n        currentSessionToken = null;\n    }\n\n    // Reset all content sections\n    const sections = document.querySelectorAll('.content-section');\n    sections.forEach(section => {\n        section.classList.remove('active');\n    });\n\n    // Reset menu items\n    const menuItems = document.querySelectorAll('.menu-item');\n    menuItems.forEach(item => {\n        item.classList.remove('active');\n    });\n\n    // Show login page\n    showLoginPage();\n\n    // Show notification\n    showNotification('Anda telah log keluar', 'success');\n\n    // Reload page after a short delay to ensure clean state\n    setTimeout(() => {\n        window.location.reload();\n    }, 500);\n}\n\nfunction switchPage(pageName) {\n    document.querySelectorAll('.content-section').forEach(section => {\n        section.classList.remove('active');\n    });\n\n    document.querySelectorAll('.menu-item').forEach(item => {\n        item.classList.remove('active');\n    });\n\n    document.getElementById(`${pageName}Content`).classList.add('active');\n    document.querySelectorAll(`[data-page=\"${pageName}\"]`).forEach(item => {\n        item.classList.add('active');\n    });\n\n    if (pageName === 'dashboard') {\n        loadDashboardData();\n    } else if (pageName === 'orders') {\n        loadOrders();\n    } else if (pageName === 'sessions') {\n        loadSessions();\n    } else if (pageName === 'products') {\n        loadProducts();\n    } else if (pageName === 'users') {\n        loadUsers();\n    } else if (pageName === 'analytics') {\n        loadAnalytics();\n    } else if (pageName === 'broadcast') {\n        loadBroadcastStats();\n    } else if (pageName === 'productsPage') {\n        loadProductsPage();\n    } else if (pageName === 'categories') {\n        loadCategoriesPage(); // Changed from loadCategories to loadCategoriesPage\n    } else if (pageName === 'pricing') {\n        loadCategoriesForPricing();\n    } else if (pageName === 'vouchers') {\n        loadVouchers();\n    } else if (pageName === 'templates') {\n        loadTemplates();\n    } else if (pageName === 'settings') { // Added from original code\n        loadSettings();\n    }\n}\n\nasync function loadProductsPage() {\n    try {\n        const grid = document.getElementById('productsPageGrid');\n        grid.innerHTML = '<div class=\"loading-spinner\"><i class=\"fas fa-spinner fa-spin\"></i></div>';\n\n        const response = await fetch('/api/products', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            let products = data.products || [];\n\n            // Filter by category if selected\n            const categoryFilter = document.getElementById('productCategoryFilter');\n            if (categoryFilter && categoryFilter.value) {\n                products = products.filter(p => p.categoryId === categoryFilter.value);\n            }\n\n            // Filter by search\n            const searchInput = document.getElementById('productSearchInput');\n            if (searchInput && searchInput.value) {\n                const searchTerm = searchInput.value.toLowerCase();\n                products = products.filter(p =>\n                    (p.productName || '').toLowerCase().includes(searchTerm) ||\n                    (p.id || '').toLowerCase().includes(searchTerm)\n                );\n            }\n\n            // Update stats\n            document.getElementById('totalProductsCount').textContent = products.length;\n            document.getElementById('activeProductsCount').textContent = products.filter(p => p.active).length;\n            document.getElementById('lowStockCount').textContent = products.filter(p => p.stock < 5).length;\n            document.getElementById('inactiveProductsCount').textContent = products.filter(p => !p.active).length;\n\n            // Load categories for filter\n            const categoriesResponse = await fetch('/api/categories', {\n                headers: getAuthHeaders()\n            });\n            const categoriesData = await categoriesResponse.json();\n            if (categoriesData.success && categoryFilter) {\n                categoryFilter.innerHTML = '<option value=\"\">Semua Kategori</option>' +\n                    categoriesData.categories.map(cat =>\n                        `<option value=\"${cat.id}\">${cat.displayName || cat.name?.ms || cat.name || cat.id}</option>`\n                    ).join('');\n            }\n\n            if (products.length === 0) {\n                grid.innerHTML = '<div class=\"empty-state\"><i class=\"fas fa-box-open\" style=\"font-size: 64px; color: var(--gray); margin-bottom: 20px;\"></i><p>Tiada produk dijumpai</p></div>';\n                return;\n            }\n\n            grid.innerHTML = products.map(product => {\n                const productName = product.productName ||\n                                  (typeof product.name === 'string' ? product.name : '') ||\n                                  product.name?.ms ||\n                                  product.name?.en ||\n                                  'Produk';\n                const categoryName = product.categoryName || 'N/A';\n                const price = parseFloat(product.price || 0);\n                const stock = parseInt(product.stock || 0);\n                const active = product.active !== undefined ? product.active : true;\n\n                const stockStatus = stock === 0 ? 'out-of-stock' : stock < 5 ? 'low-stock' : 'in-stock';\n                const stockIcon = stock === 0 ? '‚ùå' : stock < 5 ? '‚ö†Ô∏è' : '‚úÖ';\n\n                return `\n                <div class=\"product-display-card ${!active ? 'inactive' : ''}\">\n                    <div class=\"product-image-placeholder\">\n                        <i class=\"fas fa-box\"></i>\n                    </div>\n                    <div class=\"product-info\">\n                        <h3 class=\"product-title\">${productName}</h3>\n                        <p class=\"product-category\"><i class=\"fas fa-folder\"></i> ${categoryName}</p>\n                        <div class=\"product-price-tag\">RM ${price.toFixed(2)}</div>\n                        <div class=\"product-stock-info ${stockStatus}\">\n                            ${stockIcon} Stok: ${stock} unit\n                        </div>\n                        <div class=\"product-meta\">\n                            <span class=\"product-id\">ID: ${product.id}</span>\n                            <span class=\"product-status ${active ? 'active' : 'inactive'}\">\n                                ${active ? '‚úì Aktif' : '‚úï Tidak Aktif'}\n                            </span>\n                        </div>\n                    </div>\n                    <div class=\"product-actions-overlay\">\n                        <button class=\"btn-action\" onclick=\"viewProductDetail('${product.id}')\" title=\"Lihat Detail\">\n                            <i class=\"fas fa-eye\"></i>\n                        </button>\n                        <button class=\"btn-action\" onclick=\"editProductModal('${product.id}')\" title=\"Edit\">\n                            <i class=\"fas fa-edit\"></i>\n                        </button>\n                        <button class=\"btn-action\" onclick=\"toggleProduct('${product.id}', ${!active})\" title=\"Toggle Status\">\n                            <i class=\"fas fa-toggle-${active ? 'on' : 'off'}\"></i>\n                        </button>\n                        <button class=\"btn-action danger\" onclick=\"deleteProduct('${product.id}')\" title=\"Padam\">\n                            <i class=\"fas fa-trash\"></i>\n                        </button>\n                    </div>\n                </div>\n                `;\n            }).join('');\n        }\n    } catch (error) {\n        console.error('Load products page error:', error);\n        showNotification('Ralat memuatkan produk', 'error');\n    }\n}\n\n// Add search functionality\ndocument.addEventListener('DOMContentLoaded', () => {\n    const searchInput = document.getElementById('productSearchInput');\n    if (searchInput) {\n        searchInput.addEventListener('input', debounce(() => {\n            loadProductsPage();\n        }, 500));\n    }\n});\n\nfunction debounce(func, wait) {\n    let timeout;\n    return function executedFunction(...args) {\n        const later = () => {\n            clearTimeout(timeout);\n            func(...args);\n        };\n        clearTimeout(timeout);\n        timeout = setTimeout(later, wait);\n    };\n}\n\nasync function viewProductDetail(productId) {\n    try {\n        const response = await fetch('/api/products', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            const product = data.products.find(p => p.id === productId);\n            if (!product) {\n                showNotification('Produk tidak dijumpai', 'error');\n                return;\n            }\n\n            const productName = product.productName ||\n                              (typeof product.name === 'string' ? product.name : '') ||\n                              product.name?.ms ||\n                              product.name?.en ||\n                              'Produk';\n            const categoryName = product.categoryName || 'N/A';\n            const price = parseFloat(product.price || 0);\n            const stock = parseInt(product.stock || 0);\n            const active = product.active !== undefined ? product.active : true;\n            const description = (typeof product.description === 'string' ? product.description : '') ||\n                              product.description?.ms ||\n                              product.description?.en ||\n                              'Tiada penerangan';\n            const deliveryType = product.deliveryType || 'manual';\n            const createdAt = product.createdAt || new Date().toISOString();\n\n            // Get order statistics for this product\n            const ordersResponse = await fetch('/api/orders', {\n                headers: getAuthHeaders()\n            });\n            const ordersData = await ordersResponse.json();\n\n            let totalOrders = 0;\n            let totalRevenue = 0;\n            if (ordersData.success) {\n                const productOrders = ordersData.orders.filter(o =>\n                    o.productId === productId\n                );\n                totalOrders = productOrders.length;\n                totalRevenue = productOrders\n                    .filter(o => o.status === 'completed')\n                    .reduce((sum, o) => sum + parseFloat(o.price || 0), 0);\n            }\n\n            const modalHtml = `\n                <div id=\"productDetailModal\" class=\"modal active\">\n                    <div class=\"modal-content\" style=\"max-width: 700px;\">\n                        <div class=\"modal-header\">\n                            <h2>üì¶ Detail Produk</h2>\n                            <button class=\"btn-close\" onclick=\"closeProductDetailModal()\">\n                                <i class=\"fas fa-times\"></i>\n                            </button>\n                        </div>\n                        <div style=\"padding: 20px;\">\n                            <div style=\"display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;\">\n                                <div style=\"background: var(--light-gray); padding: 15px; border-radius: 12px;\">\n                                    <p style=\"font-size: 12px; color: var(--gray); margin-bottom: 5px;\">ID Produk</p>\n                                    <p style=\"font-weight: 600; font-family: monospace;\">${product.id}</p>\n                                </div>\n                                <div style=\"background: var(--light-gray); padding: 15px; border-radius: 12px;\">\n                                    <p style=\"font-size: 12px; color: var(--gray); margin-bottom: 5px;\">Status</p>\n                                    <p style=\"font-weight: 600; color: ${active ? 'var(--success)' : 'var(--danger)'};\">\n                                        ${active ? '‚úÖ Aktif' : '‚ùå Tidak Aktif'}\n                                    </p>\n                                </div>\n                            </div>\n\n                            <div style=\"margin-bottom: 20px;\">\n                                <h3 style=\"font-size: 24px; margin-bottom: 10px;\">${productName}</h3>\n                                <p style=\"color: var(--gray); margin-bottom: 15px;\">\n                                    <i class=\"fas fa-folder\"></i> ${categoryName}\n                                </p>\n                                <div style=\"background: var(--lighter-blue); padding: 15px; border-radius: 12px; margin-bottom: 15px;\">\n                                    <p style=\"font-size: 14px; line-height: 1.6;\">${description}</p>\n                                </div>\n                            </div>\n\n                            <div style=\"display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;\">\n                                <div style=\"background: var(--light-gray); padding: 15px; border-radius: 12px;\">\n                                    <p style=\"font-size: 12px; color: var(--gray); margin-bottom: 5px;\">üí∞ Harga</p>\n                                    <p style=\"font-size: 24px; font-weight: 700; color: var(--primary-blue);\">RM ${price.toFixed(2)}</p>\n                                </div>\n                                <div style=\"background: var(--light-gray); padding: 15px; border-radius: 12px;\">\n                                    <p style=\"font-size: 12px; color: var(--gray); margin-bottom: 5px;\">üìä Stok</p>\n                                    <p style=\"font-size: 24px; font-weight: 700; color: ${stock < 5 ? 'var(--danger)' : 'var(--success)'};\">${stock} unit</p>\n                                </div>\n                                <div style=\"background: var(--light-gray); padding: 15px; border-radius: 12px;\">\n                                    <p style=\"font-size: 12px; color: var(--gray); margin-bottom: 5px;\">üöö Jenis Penghantaran</p>\n                                    <p style=\"font-weight: 600;\">${deliveryType === 'auto' ? 'Automatik' : 'Manual'}</p>\n                                </div>\n                                <div style=\"background: var(--light-gray); padding: 15px; border-radius: 12px;\">\n                                    <p style=\"font-size: 12px; color: var(--gray); margin-bottom: 5px;\">üìÖ Dicipta</p>\n                                    <p style=\"font-weight: 600; font-size: 13px;\">${createdAt ? new Date(createdAt).toLocaleDateString('ms-MY', { day: '2-digit', month: 'short', year: 'numeric' }) : 'N/A'}</p>\n                                </div>\n                            </div>\n\n                            <div style=\"background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px;\">\n                                <h4 style=\"margin-bottom: 15px; font-size: 16px;\">üìà Statistik Jualan</h4>\n                                <div style=\"display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;\">\n                                    <div>\n                                        <p style=\"font-size: 12px; opacity: 0.9; margin-bottom: 5px;\">Jumlah Pesanan</p>\n                                        <p style=\"font-size: 28px; font-weight: 700;\">${totalOrders}</p>\n                                    </div>\n                                    <div>\n                                        <p style=\"font-size: 12px; opacity: 0.9; margin-bottom: 5px;\">Jumlah Hasil</p>\n                                        <p style=\"font-size: 28px; font-weight: 700;\">RM ${totalRevenue.toFixed(2)}</p>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div style=\"display: flex; gap: 10px;\">\n                                <button class=\"btn-primary\" onclick=\"editProductModal('${product.id}'); closeProductDetailModal();\" style=\"flex: 1;\">\n                                    <i class=\"fas fa-edit\"></i> Edit Produk\n                                </button>\n                                <button class=\"btn-secondary\" onclick=\"closeProductDetailModal()\" style=\"flex: 1;\">\n                                    <i class=\"fas fa-times\"></i> Tutup\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `;\n\n            // Remove existing modal if any\n            const existingModal = document.getElementById('productDetailModal');\n            if (existingModal) {\n                existingModal.remove();\n            }\n\n            // Add modal to body\n            document.body.insertAdjacentHTML('beforeend', modalHtml);\n        }\n    } catch (error) {\n        console.error('View product detail error:', error);\n        showNotification('Ralat memuatkan detail produk', 'error');\n    }\n}\n\nfunction closeProductDetailModal() {\n    const modal = document.getElementById('productDetailModal');\n    if (modal) {\n        modal.remove();\n    }\n}\n\nasync function loadDashboardData() {\n    try {\n        const response = await fetch('/api/dashboard/stats', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            const stats = data.stats;\n\n            document.getElementById('totalUsers').textContent = stats.totalUsers;\n            document.getElementById('totalOrders').textContent = stats.totalOrders;\n            document.getElementById('pendingOrders').textContent = stats.pendingOrders;\n            document.getElementById('totalRevenue').textContent = `RM ${stats.totalRevenue.toFixed(2)}`;\n            document.getElementById('todayOrders').textContent = `${stats.todayOrders} hari ini`;\n            document.getElementById('totalProducts').textContent = stats.totalProducts;\n            document.getElementById('completedOrders').textContent = stats.completedOrders;\n            document.getElementById('totalCategories').textContent = stats.totalCategories;\n\n            const badge = document.getElementById('pendingBadge');\n            if (badge) {\n                badge.textContent = stats.pendingOrders;\n            }\n        }\n\n        await loadRecentOrders();\n\n    } catch (error) {\n        console.error('Dashboard error:', error);\n        showNotification('Ralat memuatkan dashboard', 'error');\n    }\n}\n\nasync function loadRecentOrders() {\n    try {\n        const response = await fetch('/api/orders', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            const recentOrders = (data.orders || []).slice(0, 5);\n            const container = document.getElementById('recentOrders');\n\n            if (!container) return;\n\n            if (recentOrders.length === 0) {\n                container.innerHTML = '<p style=\"color: var(--dark-gray); text-align: center; padding: 20px;\">Tiada pesanan lagi</p>';\n                return;\n            }\n\n            container.innerHTML = recentOrders.map(order => {\n                const userName = order.userName || (order.user && order.user.firstName) || 'Pengguna';\n                const price = parseFloat(order.price || 0);\n                const status = order.status || 'pending';\n                const date = order.createdAt ? new Date(order.createdAt).toLocaleDateString('ms-MY') : 'N/A';\n                const orderId = order.id || 'N/A';\n\n                return `\n                <div class=\"order-item\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;\">\n                        <strong style=\"font-size: 12px;\">#${orderId}</strong>\n                        <span class=\"status-badge status-${status}\">${status}</span>\n                    </div>\n                    <div style=\"font-size: 12px; color: var(--dark-gray);\">\n                        <p style=\"margin-bottom: 3px;\">${userName} - RM ${price.toFixed(2)}</p>\n                        <p style=\"font-size: 11px; opacity: 0.8;\">${date}</p>\n                    </div>\n                </div>\n                `;\n            }).join('');\n        }\n    } catch (error) {\n        console.error('Recent orders error:', error);\n        const container = document.getElementById('recentOrders');\n        if (container) {\n            container.innerHTML = '<p style=\"color: var(--danger); text-align: center; padding: 20px;\">Ralat memuatkan pesanan</p>';\n        }\n    }\n}\n\nasync function loadOrders() {\n    try {\n        const tbody = document.getElementById('ordersTableBody');\n        tbody.innerHTML = '<tr><td colspan=\"7\" class=\"loading-cell\"><div class=\"loading-spinner\"><i class=\"fas fa-spinner fa-spin\"></i></div></td></tr>';\n\n        const response = await fetch('/api/orders', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            if (data.orders.length === 0) {\n                tbody.innerHTML = '<tr><td colspan=\"7\" style=\"text-align: center; padding: 40px; color: var(--dark-gray);\">Tiada pesanan</td></tr>';\n                return;\n            }\n\n            tbody.innerHTML = (data.orders || []).map(order => {\n                const userName = order.userName || (order.user && order.user.firstName) || 'Pengguna';\n                const userUsername = order.userUsername || (order.user && order.user.username) || '-';\n\n                const productName = order.productName\n                    ? (typeof order.productName === 'object' ? (order.productName.ms || order.productName.en) : order.productName)\n                    : '-';\n\n                const price = parseFloat(order.price || 0);\n                const orderId = order.id || '-';\n\n                return `\n                <tr>\n                    <td><strong>${orderId}</strong></td>\n                    <td>${userName} (@${userUsername})</td>\n                    <td>${productName}</td>\n                    <td>RM ${parseFloat(price).toFixed(2)}</td>\n                    <td><span class=\"status-badge status-${order.status || 'pending'}\">${order.status || 'pending'}</span></td>\n                    <td>${order.createdAt ? new Date(order.createdAt).toLocaleDateString('ms-MY') : 'N/A'}</td>\n                    <td>\n                        <div class=\"action-btns\">\n                            ${order.status === 'pending' ? `\n                                <button class=\"btn-success\" onclick=\"verifyOrder('${orderId}')\">\n                                    <i class=\"fas fa-check\"></i> Sahkan\n                                </button>\n                                <button class=\"btn-danger\" onclick=\"rejectOrder('${orderId}')\">\n                                    <i class=\"fas fa-times\"></i> Tolak\n                                </button>\n                            ` : '-'}\n                        </div>\n                    </td>\n                </tr>\n                `;\n            }).join('');\n        }\n    } catch (error) {\n        console.error('Load orders error:', error);\n        showNotification('Ralat memuatkan pesanan', 'error');\n    }\n}\n\nasync function verifyOrder(orderId) {\n    if (!confirm(`Sahkan pesanan ${orderId}?`)) return;\n\n    try {\n        const response = await fetch(`/api/orders/${orderId}/verify`, {\n            method: 'POST',\n            headers: getAuthHeaders()\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Pesanan berjaya disahkan!', 'success');\n            loadOrders();\n            loadDashboardData();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Verify order error:', error);\n        showNotification('Ralat semasa mengesahkan pesanan', 'error');\n    }\n}\n\nasync function rejectOrder(orderId) {\n    if (!confirm(`Tolak pesanan ${orderId}?`)) return;\n\n    try {\n        const response = await fetch(`/api/orders/${orderId}/reject`, {\n            method: 'POST',\n            headers: getAuthHeaders()\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Pesanan telah ditolak', 'success');\n            loadOrders();\n            loadDashboardData();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Reject order error:', error);\n        showNotification('Ralat semasa menolak pesanan', 'error');\n    }\n}\n\nasync function loadProducts() {\n    try {\n        const grid = document.getElementById('productsGrid');\n        grid.innerHTML = '<div class=\"loading-spinner\"><i class=\"fas fa-spinner fa-spin\"></i></div>';\n\n        const response = await fetch('/api/products', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            if (data.products.length === 0) {\n                grid.innerHTML = '<p style=\"text-align: center; color: var(--dark-gray); padding: 40px;\">Tiada produk. Tambah produk baru!</p>';\n                return;\n            }\n\n            grid.innerHTML = data.products.map(product => {\n                const productName = product.productName ||\n                                  (typeof product.name === 'string' ? product.name : '') ||\n                                  product.name?.ms ||\n                                  product.name?.en ||\n                                  'Produk';\n                const categoryName = product.categoryName || 'N/A';\n                const price = parseFloat(product.price || 0);\n                const stock = parseInt(product.stock || 0);\n                const active = product.active !== undefined ? product.active : true;\n\n                return `\n                <div class=\"product-card\">\n                    <div class=\"product-header\">\n                        <h3 class=\"product-name\">${productName}</h3>\n                        <p class=\"product-category\">${categoryName}</p>\n                    </div>\n                    <p class=\"product-price\">RM ${price.toFixed(2)}</p>\n                    <p class=\"product-stock\">Stok: ${stock} unit</p>\n                    <p class=\"product-stock\" style=\"font-size: 12px;\">\n                        Status: ${active ? '<span style=\"color: var(--success)\">Aktif</span>' : '<span style=\"color: var(--danger)\">Tidak Aktif</span>'}\n                    </p>\n                    <div class=\"product-actions\">\n                        <button class=\"btn-edit\" onclick=\"editProductModal('${product.id}')\">\n                            <i class=\"fas fa-edit\"></i> Edit\n                        </button>\n                        <button class=\"btn-edit\" onclick=\"toggleProduct('${product.id}', ${!active})\">\n                            <i class=\"fas fa-toggle-${active ? 'on' : 'off'}\"></i>\n                        </button>\n                        <button class=\"btn-delete\" onclick=\"deleteProduct('${product.id}')\">\n                            <i class=\"fas fa-trash\"></i>\n                        </button>\n                    </div>\n                </div>\n                `;\n            }).join('');\n        }\n    } catch (error) {\n        console.error('Load products error:', error);\n        showNotification('Ralat memuatkan produk', 'error');\n    }\n}\n\nasync function loadCategories() {\n    try {\n        const response = await fetch('/api/categories', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            const select = document.getElementById('productCategory');\n            select.innerHTML = '<option value=\"\">Pilih Kategori</option>' +\n                data.categories.map(cat => `<option value=\"${cat.id}\">${cat.displayName || cat.name?.ms || cat.name || cat.id}</option>`).join('');\n        }\n    } catch (error) {\n        console.error('Load categories error:', error);\n    }\n}\n\nfunction showAddProductModal() {\n    document.getElementById('addProductModal').classList.add('active');\n}\n\nfunction closeAddProductModal() {\n    document.getElementById('addProductModal').classList.remove('active');\n    document.getElementById('addProductForm').reset();\n}\n\nasync function handleAddProduct(e) {\n    e.preventDefault();\n\n    const productData = {\n        name: document.getElementById('productName').value,\n        price: document.getElementById('productPrice').value,\n        categoryId: document.getElementById('productCategory').value,\n        stock: document.getElementById('productStock').value,\n        description: document.getElementById('productDescription').value\n    };\n\n    try {\n        const response = await fetch('/api/products', {\n            method: 'POST',\n            headers: getAuthHeaders(),\n            body: JSON.stringify(productData)\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Produk berjaya ditambah!', 'success');\n            closeAddProductModal();\n            loadProducts();\n            loadDashboardData();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Add product error:', error);\n        showNotification('Ralat semasa menambah produk', 'error');\n    }\n}\n\nasync function toggleProduct(productId, activeStatus) {\n    try {\n        const response = await fetch(`/api/products/${productId}`, {\n            method: 'PUT',\n            headers: getAuthHeaders(),\n            body: JSON.stringify({ active: activeStatus })\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Status produk dikemaskini!', 'success');\n            loadProducts();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Toggle product error:', error);\n        showNotification('Ralat semasa mengubah status', 'error');\n    }\n}\n\nasync function deleteProduct(productId) {\n    if (!confirm('Anda pasti mahu padam produk ini?')) return;\n\n    try {\n        const response = await fetch(`/api/products/${productId}`, {\n            method: 'DELETE',\n            headers: getAuthHeaders()\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Produk berjaya dipadam!', 'success');\n            loadProducts();\n            loadDashboardData();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Delete product error:', error);\n        showNotification('Ralat semasa memadam produk', 'error');\n    }\n}\n\nasync function loadUsers() {\n    try {\n        const tbody = document.getElementById('usersTableBody');\n        tbody.innerHTML = '<tr><td colspan=\"6\" class=\"loading-cell\"><div class=\"loading-spinner\"><i class=\"fas fa-spinner fa-spin\"></i></div></td></tr>';\n\n        const response = await fetch('/api/users', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            if (data.users.length === 0) {\n                tbody.innerHTML = '<tr><td colspan=\"6\" style=\"text-align: center; padding: 40px; color: var(--dark-gray);\">Tiada pengguna</td></tr>';\n                return;\n            }\n\n            tbody.innerHTML = data.users.map(user => {\n                const firstName = user.firstName || user.first_name || 'Tanpa';\n                const lastName = user.lastName || user.last_name || 'Nama';\n                const username = user.username || 'tiada';\n                const totalOrders = user.totalOrders || 0;\n                const totalSpent = parseFloat(user.totalSpent || 0);\n                const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('ms-MY') : 'N/A';\n                const isBanned = user.banned ? '<span class=\"badge-danger\">Banned</span>' : '<span class=\"badge-success\">Active</span>';\n\n                return `\n                <tr>\n                    <td>${user.id}</td>\n                    <td>${firstName} ${lastName}</td>\n                    <td>@${username}</td>\n                    <td>${totalOrders}</td>\n                    <td>RM ${totalSpent.toFixed(2)}</td>\n                    <td>${createdAt}</td>\n                    <td>\n                        ${isBanned}\n                        <button class=\"btn-danger btn-sm\" onclick=\"deleteUser(${user.id})\" title=\"Padam\">\n                            <i class=\"fas fa-trash\"></i>\n                        </button>\n                    </td>\n                </tr>\n                `;\n            }).join('');\n        }\n    } catch (error) {\n        console.error('Load users error:', error);\n        showNotification('Ralat memuatkan pengguna', 'error');\n    }\n}\n\nasync function deleteUser(userId) {\n    if (!confirm('Adakah anda pasti mahu memadamkan pengguna ini? Tindakan ini tidak boleh dibatalkan.')) {\n        return;\n    }\n\n    try {\n        const response = await fetch(`/api/users/${userId}`, {\n            method: 'DELETE',\n            headers: getAuthHeaders()\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Pengguna berjaya dipadam', 'success');\n            loadUsers();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Delete user error:', error);\n        showNotification('Ralat memadam pengguna', 'error');\n    }\n}\n\nasync function loadAnalytics() {\n    try {\n        const response = await fetch('/api/analytics/sales', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            renderSalesChart(data.salesData);\n        }\n    } catch (error) {\n        console.error('Analytics error:', error);\n        showNotification('Ralat memuatkan analytics', 'error');\n    }\n}\n\nfunction renderSalesChart(salesData) {\n    const ctx = document.getElementById('salesChart');\n\n    if (salesChart) {\n        salesChart.destroy();\n    }\n\n    salesChart = new Chart(ctx, {\n        type: 'line',\n        data: {\n            labels: salesData.map(d => d.date),\n            datasets: [{\n                label: 'Jualan (RM)',\n                data: salesData.map(d => d.revenue),\n                borderColor: '#2563eb',\n                backgroundColor: 'rgba(37, 99, 235, 0.1)',\n                borderWidth: 3,\n                fill: true,\n                tension: 0.4,\n                pointBackgroundColor: '#2563eb',\n                pointBorderColor: '#fff',\n                pointBorderWidth: 2,\n                pointRadius: 5,\n                pointHoverRadius: 7\n            }]\n        },\n        options: {\n            responsive: true,\n            maintainAspectRatio: true,\n            plugins: {\n                legend: {\n                    display: true,\n                    position: 'top'\n                },\n                tooltip: {\n                    backgroundColor: 'rgba(0, 0, 0, 0.8)',\n                    padding: 12,\n                    borderRadius: 8,\n                    titleFont: { size: 14 },\n                    bodyFont: { size: 13 }\n                }\n            },\n            scales: {\n                y: {\n                    beginAtZero: true,\n                    grid: {\n                        color: 'rgba(0, 0, 0, 0.05)'\n                    }\n                },\n                x: {\n                    grid: {\n                        display: false\n                    }\n                }\n            }\n        }\n    });\n}\n\nasync function loadSettings() {\n    try {\n        const response = await fetch('/api/settings', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            document.getElementById('storeName').value = data.settings.storeName || '';\n            document.getElementById('storeCurrency').value = data.settings.currency || 'RM';\n            document.getElementById('defaultLanguage').value = data.settings.defaultLanguage || 'ms';\n        }\n    } catch (error) {\n        console.error('Load settings error:', error);\n        showNotification('Ralat memuatkan tetapan', 'error');\n    }\n}\n\nasync function saveSettings() {\n    const settings = {\n        storeName: document.getElementById('storeName').value,\n        currency: document.getElementById('storeCurrency').value,\n        defaultLanguage: document.getElementById('defaultLanguage').value\n    };\n\n    try {\n        const response = await fetch('/api/settings', {\n            method: 'PUT',\n            headers: getAuthHeaders(),\n            body: JSON.stringify(settings)\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Tetapan berjaya disimpan!', 'success');\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Save settings error:', error);\n        showNotification('Ralat semasa menyimpan tetapan', 'error');\n    }\n}\n\nfunction showNotification(message, type = 'success') {\n    const notification = document.getElementById('notification');\n    notification.textContent = message;\n    notification.className = `notification ${type} show`;\n\n    setTimeout(() => {\n        notification.classList.remove('show');\n    }, 3000);\n}\n\nasync function editProductModal(productId) {\n    try {\n        const response = await fetch('/api/products', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            const product = data.products.find(p => p.id === productId);\n            if (!product) {\n                showNotification('Produk tidak dijumpai', 'error');\n                return;\n            }\n\n            const categoriesResponse = await fetch('/api/categories', {\n                headers: getAuthHeaders()\n            });\n            const categoriesData = await categoriesResponse.json();\n\n            if (categoriesData.success) {\n                const editSelect = document.getElementById('editProductCategory');\n                editSelect.innerHTML = '<option value=\"\">Pilih Kategori</option>' +\n                    categoriesData.categories.map(cat => `<option value=\"${cat.id}\">${cat.displayName || cat.name?.ms || cat.name || cat.id}</option>`).join('');\n            }\n\n            document.getElementById('editProductId').value = product.id;\n            document.getElementById('editProductName').value = product.productName || product.name?.ms || product.name || '';\n            document.getElementById('editProductPrice').value = product.price;\n            document.getElementById('editProductCategory').value = product.categoryId || product.category || '';\n            document.getElementById('editProductStock').value = product.stock;\n            document.getElementById('editProductDescription').value = product.description?.ms || product.description || '';\n\n            document.getElementById('editProductModal').classList.add('active');\n        }\n    } catch (error) {\n        console.error('Edit product modal error:', error);\n        showNotification('Ralat memuatkan data produk', 'error');\n    }\n}\n\nfunction closeEditProductModal() {\n    document.getElementById('editProductModal').classList.remove('active');\n    document.getElementById('editProductForm').reset();\n}\n\nasync function handleEditProduct(e) {\n    e.preventDefault();\n\n    const productId = document.getElementById('editProductId').value;\n    const productData = {\n        name: document.getElementById('editProductName').value,\n        price: parseFloat(document.getElementById('editProductPrice').value),\n        categoryId: document.getElementById('editProductCategory').value,\n        stock: parseInt(document.getElementById('editProductStock').value),\n        description: document.getElementById('editProductDescription').value\n    };\n\n    try {\n        const response = await fetch(`/api/products/${productId}`, {\n            method: 'PUT',\n            headers: getAuthHeaders(),\n            body: JSON.stringify(productData)\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Produk berjaya dikemaskini!', 'success');\n            closeEditProductModal();\n            loadProducts();\n            loadDashboardData();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Update product error:', error);\n        showNotification('Ralat semasa mengemas kini produk', 'error');\n    }\n}\n\nasync function loadCategoriesPage() {\n    try {\n        const grid = document.getElementById('categoriesGrid');\n        grid.innerHTML = '<div class=\"loading-spinner\"><i class=\"fas fa-spinner fa-spin\"></i></div>';\n\n        const response = await fetch('/api/categories', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            if (data.categories.length === 0) {\n                grid.innerHTML = '<p style=\"text-align: center; color: var(--dark-gray); padding: 40px;\">Tiada kategori. Tambah kategori baru!</p>';\n                return;\n            }\n\n            grid.innerHTML = data.categories.map(category => {\n                const icon = category.icon || 'üì¶';\n                const name = category.displayName ||\n                           (typeof category.name === 'string' ? category.name : '') ||\n                           category.name?.ms ||\n                           category.name?.en ||\n                           category.id ||\n                           'Tanpa Nama';\n\n                return `\n                <div class=\"product-card\">\n                    <div class=\"product-header\">\n                        <h3 class=\"product-name\">${icon} ${name}</h3>\n                    </div>\n                    <p class=\"product-category\">ID: ${category.id || 'N/A'}</p>\n                    <div class=\"product-actions\">\n                        <button class=\"btn-edit\" onclick=\"editCategoryModal('${category.id}')\">\n                            <i class=\"fas fa-edit\"></i> Edit\n                        </button>\n                        <button class=\"btn-delete\" onclick=\"deleteCategory('${category.id}')\">\n                            <i class=\"fas fa-trash\"></i> Padam\n                        </button>\n                    </div>\n                </div>\n                `;\n            }).join('');\n        }\n    } catch (error) {\n        console.error('Load categories error:', error);\n        showNotification('Ralat memuatkan kategori', 'error');\n    }\n}\n\nfunction showAddCategoryModal() {\n    document.getElementById('addCategoryModal').classList.add('active');\n}\n\nfunction closeAddCategoryModal() {\n    document.getElementById('addCategoryModal').classList.remove('active');\n    document.getElementById('addCategoryForm').reset();\n}\n\nasync function handleAddCategory(e) {\n    e.preventDefault();\n\n    const categoryData = {\n        name: document.getElementById('categoryName').value,\n        icon: document.getElementById('categoryIcon').value || 'üì¶'\n    };\n\n    try {\n        const response = await fetch('/api/categories', {\n            method: 'POST',\n            headers: getAuthHeaders(),\n            body: JSON.stringify(categoryData)\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Kategori berjaya ditambah!', 'success');\n            closeAddCategoryModal();\n            loadCategoriesPage();\n            loadCategories();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Add category error:', error);\n        showNotification('Ralat semasa menambah kategori', 'error');\n    }\n}\n\nasync function editCategoryModal(categoryId) {\n    try {\n        const response = await fetch('/api/categories', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            const category = data.categories.find(c => c.id === categoryId);\n            if (!category) {\n                showNotification('Kategori tidak dijumpai', 'error');\n                return;\n            }\n\n            document.getElementById('editCategoryId').value = category.id;\n            document.getElementById('editCategoryName').value = category.displayName || category.name?.ms || category.name || '';\n            document.getElementById('editCategoryIcon').value = category.icon || '';\n\n            document.getElementById('editCategoryModal').classList.add('active');\n        }\n    } catch (error) {\n        console.error('Edit category modal error:', error);\n        showNotification('Ralat memuatkan data kategori', 'error');\n    }\n}\n\nfunction closeEditCategoryModal() {\n    document.getElementById('editCategoryModal').classList.remove('active');\n    document.getElementById('editCategoryForm').reset();\n}\n\nasync function handleEditCategory(e) {\n    e.preventDefault();\n\n    const categoryId = document.getElementById('editCategoryId').value;\n    const categoryData = {\n        name: document.getElementById('editCategoryName').value,\n        icon: document.getElementById('editCategoryIcon').value || 'üì¶'\n    };\n\n    try {\n        const response = await fetch(`/api/categories/${categoryId}`, {\n            method: 'PUT',\n            headers: getAuthHeaders(),\n            body: JSON.stringify(categoryData)\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Kategori berjaya dikemaskini!', 'success');\n            closeEditCategoryModal();\n            loadCategoriesPage();\n            loadCategories();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Update category error:', error);\n        showNotification('Ralat semasa mengemas kini kategori', 'error');\n    }\n}\n\nasync function deleteCategory(categoryId) {\n    if (!confirm('Anda pasti mahu padam kategori ini?')) return;\n\n    try {\n        const response = await fetch(`/api/categories/${categoryId}`, {\n            method: 'DELETE',\n            headers: getAuthHeaders()\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Kategori berjaya dipadam!', 'success');\n            loadCategoriesPage();\n            loadCategories();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Delete category error:', error);\n        showNotification('Ralat semasa memadam kategori', 'error');\n    }\n}\n\nasync function loadVouchers() {\n    try {\n        const tbody = document.getElementById('vouchersTableBody');\n        tbody.innerHTML = '<tr><td colspan=\"7\" class=\"loading-cell\"><div class=\"loading-spinner\"><i class=\"fas fa-spinner fa-spin\"></i></div></td></tr>';\n\n        const response = await fetch('/api/vouchers', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            if (data.vouchers.length === 0) {\n                tbody.innerHTML = '<tr><td colspan=\"7\" style=\"text-align: center; padding: 40px; color: var(--dark-gray);\">Tiada voucher</td></tr>';\n                return;\n            }\n\n            tbody.innerHTML = data.vouchers.map(voucher => `\n                <tr>\n                    <td><strong>${voucher.code}</strong></td>\n                    <td>${voucher.type === 'percentage' ? 'Peratusan' : 'Tetap'}</td>\n                    <td>${voucher.type === 'percentage' ? voucher.value + '%' : 'RM ' + voucher.value.toFixed(2)}</td>\n                    <td>${voucher.usedCount || 0}</td>\n                    <td>${voucher.maxUses || 'Tanpa had'}</td>\n                    <td><span class=\"status-badge status-${voucher.active ? 'completed' : 'cancelled'}\">${voucher.active ? 'Aktif' : 'Tidak Aktif'}</span></td>\n                    <td>\n                        <div class=\"action-btns\">\n                            <button class=\"btn-edit\" onclick=\"toggleVoucher('${voucher.id}', ${!voucher.active})\">\n                                <i class=\"fas fa-toggle-${voucher.active ? 'on' : 'off'}\"></i>\n                            </button>\n                            <button class=\"btn-delete\" onclick=\"deleteVoucher('${voucher.id}')\">\n                                <i class=\"fas fa-trash\"></i>\n                            </button>\n                        </div>\n                    </td>\n                </tr>\n            `).join('');\n        }\n    } catch (error) {\n        console.error('Load vouchers error:', error);\n        showNotification('Ralat memuatkan voucher', 'error');\n    }\n}\n\nfunction showAddVoucherModal() {\n    document.getElementById('addVoucherModal').classList.add('active');\n}\n\nfunction closeAddVoucherModal() {\n    document.getElementById('addVoucherModal').classList.remove('active');\n    document.getElementById('addVoucherForm').reset();\n}\n\nasync function handleAddVoucher(e) {\n    e.preventDefault();\n\n    const voucherData = {\n        code: document.getElementById('voucherCode').value.toUpperCase(),\n        type: document.getElementById('voucherType').value,\n        value: parseFloat(document.getElementById('voucherValue').value),\n        maxUses: parseInt(document.getElementById('voucherLimit').value) || 0\n    };\n\n    try {\n        const response = await fetch('/api/vouchers', {\n            method: 'POST',\n            headers: getAuthHeaders(),\n            body: JSON.stringify(voucherData)\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Voucher berjaya ditambah!', 'success');\n            closeAddVoucherModal();\n            loadVouchers();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Add voucher error:', error);\n        showNotification('Ralat semasa menambah voucher', 'error');\n    }\n}\n\nasync function toggleVoucher(voucherId, activeStatus) {\n    try {\n        const response = await fetch(`/api/vouchers/${voucherId}`, {\n            method: 'PUT',\n            headers: getAuthHeaders(),\n            body: JSON.stringify({ active: activeStatus })\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Status voucher dikemaskini!', 'success');\n            loadVouchers();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Toggle voucher error:', error);\n        showNotification('Ralat semasa mengubah status voucher', 'error');\n    }\n}\n\nasync function deleteVoucher(voucherId) {\n    if (!confirm('Anda pasti mahu padam voucher ini?')) return;\n\n    try {\n        const response = await fetch(`/api/vouchers/${voucherId}`, {\n            method: 'DELETE',\n            headers: getAuthHeaders()\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Voucher berjaya dipadam!', 'success');\n            loadVouchers();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Delete voucher error:', error);\n        showNotification('Ralat semasa memadam voucher', 'error');\n    }\n}\n\nasync function loadTemplates() {\n    try {\n        const tbody = document.getElementById('templatesTableBody');\n        tbody.innerHTML = '<tr><td colspan=\"3\" class=\"loading-cell\"><div class=\"loading-spinner\"><i class=\"fas fa-spinner fa-spin\"></i></div></td></tr>';\n\n        const response = await fetch('/api/templates', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            if (data.templates.length === 0) {\n                tbody.innerHTML = '<tr><td colspan=\"3\" style=\"text-align: center; padding: 40px; color: var(--dark-gray);\">Tiada template</td></tr>';\n                return;\n            }\n\n            tbody.innerHTML = data.templates.map(template => `\n                <tr>\n                    <td><strong>${template.name || 'N/A'}</strong></td>\n                    <td style=\"max-width: 400px; white-space: pre-wrap;\">${template.message?.ms || template.message || 'N/A'}</td>\n                    <td>\n                        <div class=\"action-btns\">\n                            <button class=\"btn-delete\" onclick=\"deleteTemplate('${template.id}')\">\n                                <i class=\"fas fa-trash\"></i> Padam\n                            </button>\n                        </div>\n                    </td>\n                </tr>\n            `).join('');\n        }\n    } catch (error) {\n        console.error('Load templates error:', error);\n        showNotification('Ralat memuatkan template', 'error');\n    }\n}\n\nfunction showAddTemplateModal() {\n    document.getElementById('addTemplateModal').classList.add('active');\n}\n\nfunction closeAddTemplateModal() {\n    document.getElementById('addTemplateModal').classList.remove('active');\n    document.getElementById('addTemplateForm').reset();\n}\n\nasync function handleAddTemplate(e) {\n    e.preventDefault();\n\n    const templateData = {\n        name: document.getElementById('templateName').value,\n        message: document.getElementById('templateMessage').value\n    };\n\n    try {\n        const response = await fetch('/api/templates', {\n            method: 'POST',\n            headers: getAuthHeaders(),\n            body: JSON.stringify(templateData)\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Template berjaya ditambah!', 'success');\n            closeAddTemplateModal();\n            loadTemplates();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Add template error:', error);\n        showNotification('Ralat semasa menambah template', 'error');\n    }\n}\n\nasync function deleteTemplate(templateId) {\n    if (!confirm('Anda pasti mahu padam template ini?')) return;\n\n    try {\n        const response = await fetch(`/api/templates/${templateId}`, {\n            method: 'DELETE',\n            headers: getAuthHeaders()\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Template berjaya dipadam!', 'success');\n            loadTemplates();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Delete template error:', error);\n        showNotification('Ralat semasa memadam template', 'error');\n    }\n}\n\nasync function loadBroadcastStats() {\n    try {\n        const response = await fetch('/api/users', {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            const users = data.users || [];\n            const activeUsers = users.filter(u => {\n                const lastActive = new Date(u.lastActive || 0);\n                const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n                return lastActive > thirtyDaysAgo;\n            });\n\n            document.getElementById('totalUsersStats').textContent = users.length;\n            document.getElementById('activeUsersStats').textContent = activeUsers.length;\n            document.getElementById('allUsersCount').textContent = `${users.length} pengguna`;\n            document.getElementById('activeUsersCount').textContent = `${activeUsers.length} pengguna aktif`;\n        }\n    } catch (error) {\n        console.error('Load broadcast stats error:', error);\n    }\n}\n\nasync function executeBroadcast() {\n    const message = document.getElementById('broadcastMessage').value.trim();\n    if (!message) {\n        showNotification('Sila masukkan mesej broadcast', 'error');\n        return;\n    }\n\n    const targetType = document.querySelector('input[name=\"broadcastTarget\"]:checked').value;\n    let endpoint = '/api/broadcast/all';\n    let body = { message };\n\n    if (targetType === 'active') {\n        endpoint = '/api/broadcast/active';\n    } else if (targetType === 'tagged') {\n        const tag = document.getElementById('broadcastTag').value.trim();\n        if (!tag) {\n            showNotification('Sila masukkan tag', 'error');\n            return;\n        }\n        endpoint = '/api/broadcast/tagged';\n        body.tag = tag;\n    }\n\n    if (!confirm(`Anda pasti mahu hantar broadcast ke ${targetType === 'all' ? 'semua pengguna' : targetType === 'active' ? 'pengguna aktif' : 'pengguna bertag'}?`)) {\n        return;\n    }\n\n    try {\n        showNotification('Menghantar broadcast...', 'success');\n\n        const response = await fetch(endpoint, {\n            method: 'POST',\n            headers: getAuthHeaders(),\n            body: JSON.stringify(body)\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification(data.message, 'success');\n            document.getElementById('broadcastMessage').value = '';\n            document.getElementById('lastBroadcastStats').textContent = new Date().toLocaleTimeString('ms-MY');\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Broadcast error:', error);\n        showNotification('Ralat semasa menghantar broadcast', 'error');\n    }\n}\n\n// Removed duplicate DOMContentLoaded listener\n\nlet mediaRecorder = null;\nlet audioChunks = [];\nlet isRecording = false;\n\nasync function handleFileSelect(event) {\n    const file = event.target.files[0];\n    if (!file || !currentSessionToken) return;\n\n    await uploadMedia(file, 'document', event);\n}\n\nasync function handlePhotoSelect(event) {\n    const file = event.target.files[0];\n    if (!file || !currentSessionToken) return;\n\n    await uploadMedia(file, 'photo', event);\n}\n\nasync function handleAudioSelect(event) {\n    const file = event.target.files[0];\n    if (!file || !currentSessionToken) return;\n\n    await uploadMedia(file, 'audio', event);\n}\n\nasync function handleVideoSelect(event) {\n    const file = event.target.files[0];\n    if (!file || !currentSessionToken) return;\n\n    await uploadMedia(file, 'video', event);\n}\n\nasync function uploadMedia(file, mediaType, event = null) {\n    if (!currentSessionToken) {\n        showNotification('Sila pilih session terlebih dahulu', 'error');\n        return;\n    }\n\n    const formData = new FormData();\n    formData.append('file', file);\n    formData.append('mediaType', mediaType);\n\n    try {\n        showNotification('Menghantar fail...', 'success');\n\n        const response = await fetch(`/api/sessions/${currentSessionToken}/upload`, {\n            method: 'POST',\n            headers: {\n                'Authorization': `Bearer ${authToken}`\n            },\n            body: formData\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Fail berjaya dihantar!', 'success');\n\n            const chatMessages = document.getElementById('chatMessages');\n            const time = new Date().toLocaleTimeString('ms-MY', {\n                hour: '2-digit',\n                minute: '2-digit'\n            });\n\n            const messageHtml = `\n            <div class=\"message message-admin\">\n                <div class=\"message-bubble\">\n                    <div class=\"message-text\"><i class=\"fas fa-file\"></i> ${file.name}</div>\n                    <div class=\"message-time\">${time}</div>\n                </div>\n            </div>\n            `;\n\n            chatMessages.innerHTML += messageHtml;\n            chatMessages.scrollTop = chatMessages.scrollHeight;\n\n            if (event && event.target) {\n                event.target.value = '';\n            }\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Upload media error:', error);\n        showNotification('Ralat menghantar fail', 'error');\n    }\n}\n\nasync function toggleVoiceRecording() {\n    const recordBtn = document.getElementById('recordVoiceBtn');\n\n    if (!isRecording) {\n        try {\n            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n            mediaRecorder = new MediaRecorder(stream);\n            audioChunks = [];\n\n            mediaRecorder.ondataavailable = (event) => {\n                audioChunks.push(event.data);\n            };\n\n            mediaRecorder.onstop = async () => {\n                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });\n                const audioFile = new File([audioBlob], `voice-${Date.now()}.webm`, { type: 'audio/webm' });\n\n                await uploadMedia(audioFile, 'voice');\n\n                stream.getTracks().forEach(track => track.stop());\n                recordBtn.classList.remove('recording');\n                isRecording = false;\n            };\n\n            mediaRecorder.start();\n            recordBtn.classList.add('recording');\n            isRecording = true;\n            showNotification('Rakaman dimulakan... Klik sekali lagi untuk berhenti', 'success');\n        } catch (error) {\n            console.error('Voice recording error:', error);\n            showNotification('Ralat: Tidak dapat mengakses mikrofon', 'error');\n        }\n    } else {\n        if (mediaRecorder && mediaRecorder.state === 'recording') {\n            mediaRecorder.stop();\n            showNotification('Rakaman dihentikan. Menghantar...', 'success');\n        }\n    }\n}\n\nasync function shareLocation() {\n    if (!currentSessionToken) {\n        showNotification('Sila pilih session terlebih dahulu', 'error');\n        return;\n    }\n\n    if (!navigator.geolocation) {\n        showNotification('Pelayar anda tidak menyokong geolocation', 'error');\n        return;\n    }\n\n    showNotification('Mendapatkan lokasi anda...', 'success');\n\n    navigator.geolocation.getCurrentPosition(\n        async (position) => {\n            const latitude = position.coords.latitude;\n            const longitude = position.coords.longitude;\n\n            try {\n                const response = await fetch(`/api/sessions/${currentSessionToken}/reply`, {\n                    method: 'POST',\n                    headers: getAuthHeaders(),\n                    body: JSON.stringify({\n                        type: 'location',\n                        latitude,\n                        longitude\n                    })\n                });\n\n                const data = await response.json();\n\n                if (data.success) {\n                    showNotification('Lokasi berjaya dikongsi!', 'success');\n\n                    const chatMessages = document.getElementById('chatMessages');\n                    const time = new Date().toLocaleTimeString('ms-MY', {\n                        hour: '2-digit',\n                        minute: '2-digit'\n                    });\n\n                    const messageHtml = `\n                    <div class=\"message message-admin\">\n                        <div class=\"message-bubble\">\n                            <div class=\"message-text\">\n                                <i class=\"fas fa-map-marker-alt\"></i> Lokasi dikongsi\n                                <br><small>Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}</small>\n                            </div>\n                            <div class=\"message-time\">${time}</div>\n                        </div>\n                    </div>\n                    `;\n\n                    chatMessages.innerHTML += messageHtml;\n                    chatMessages.scrollTop = chatMessages.scrollHeight;\n                } else {\n                    showNotification(data.message, 'error');\n                }\n            } catch (error) {\n                console.error('Share location error:', error);\n                showNotification('Ralat menghantar lokasi', 'error');\n            }\n        },\n        (error) => {\n            console.error('Geolocation error:', error);\n            showNotification('Ralat: Tidak dapat mendapatkan lokasi anda', 'error');\n        }\n    );\n}\n\nfunction getMediaUrl(filePath) {\n    if (!filePath) return '';\n    if (filePath.startsWith('/') || filePath.startsWith('http://') || filePath.startsWith('https://')) {\n        return filePath;\n    }\n    if (filePath.startsWith('media/')) {\n        return `/${filePath}`;\n    }\n    return `/media/${filePath}`;\n}\n\nfunction renderMessage(msg) {\n    const isAdmin = msg.from === 'admin' || msg.isAdmin === true;\n    const time = new Date(msg.timestamp).toLocaleTimeString('ms-MY', {\n        hour: '2-digit',\n        minute: '2-digit'\n    });\n\n    let content = '';\n\n    if (msg.type === 'text') {\n        content = `<div class=\"message-text\">${escapeHtml(msg.text)}</div>`;\n    } else if (msg.type === 'photo') {\n        if (msg.filePath) {\n            const imageUrl = getMediaUrl(msg.filePath);\n            content = `\n                <div class=\"message-media\">\n                    <img src=\"${imageUrl}\" alt=\"Photo\" style=\"max-width: 300px; max-height: 300px; border-radius: 8px; cursor: pointer;\" onclick=\"window.open('${imageUrl}', '_blank')\">\n                    ${msg.caption ? `<div class=\"message-text\" style=\"margin-top: 8px;\"><small>${escapeHtml(msg.caption)}</small></div>` : ''}\n                </div>\n            `;\n        } else {\n            content = `\n                <div class=\"message-text\">\n                    <i class=\"fas fa-image\"></i> Foto dihantar\n                    ${msg.caption ? `<br><small>${escapeHtml(msg.caption)}</small>` : ''}\n                </div>\n            `;\n        }\n    } else if (msg.type === 'document') {\n        if (msg.filePath) {\n            const fileUrl = getMediaUrl(msg.filePath);\n            content = `\n                <div class=\"message-text\">\n                    <a href=\"${fileUrl}\" target=\"_blank\" download=\"${msg.fileName || 'document'}\" style=\"color: var(--accent); text-decoration: none;\">\n                        <i class=\"fas fa-file-download\"></i> ${msg.fileName || 'Dokumen'}\n                    </a>\n                    ${msg.caption ? `<br><small>${escapeHtml(msg.caption)}</small>` : ''}\n                </div>\n            `;\n        } else {\n            content = `\n                <div class=\"message-text\">\n                    <i class=\"fas fa-file\"></i> ${msg.fileName || 'Dokumen'}\n                    ${msg.caption ? `<br><small>${escapeHtml(msg.caption)}</small>` : ''}\n                </div>\n            `;\n        }\n    } else if (msg.type === 'audio') {\n        if (msg.filePath) {\n            const audioUrl = getMediaUrl(msg.filePath);\n            content = `\n                <div class=\"message-media\">\n                    <audio controls style=\"max-width: 300px;\">\n                        <source src=\"${audioUrl}\" type=\"${msg.mimeType || 'audio/mpeg'}\">\n                        Browser anda tidak menyokong audio player.\n                    </audio>\n                    ${msg.caption ? `<div class=\"message-text\" style=\"margin-top: 8px;\"><small>${escapeHtml(msg.caption)}</small></div>` : ''}\n                </div>\n            `;\n        } else {\n            content = `\n                <div class=\"message-text\">\n                    <i class=\"fas fa-music\"></i> Audio (${msg.duration || 0}s)\n                    ${msg.caption ? `<br><small>${escapeHtml(msg.caption)}</small>` : ''}\n                </div>\n            `;\n        }\n    } else if (msg.type === 'voice') {\n        if (msg.filePath) {\n            const voiceUrl = getMediaUrl(msg.filePath);\n            content = `\n                <div class=\"message-media\">\n                    <audio controls style=\"max-width: 300px;\">\n                        <source src=\"${voiceUrl}\" type=\"${msg.mimeType || 'audio/ogg'}\">\n                        Browser anda tidak menyokong audio player.\n                    </audio>\n                </div>\n            `;\n        } else {\n            content = `\n                <div class=\"message-text\">\n                    <i class=\"fas fa-microphone\"></i> Mesej Suara (${msg.duration || 0}s)\n                </div>\n            `;\n        }\n    } else if (msg.type === 'video') {\n        if (msg.filePath) {\n            const videoUrl = getMediaUrl(msg.filePath);\n            content = `\n                <div class=\"message-media\">\n                    <video controls style=\"max-width: 300px; max-height: 300px; border-radius: 8px;\">\n                        <source src=\"${videoUrl}\" type=\"${msg.mimeType || 'video/mp4'}\">\n                        Browser anda tidak menyokong video player.\n                    </video>\n                    ${msg.caption ? `<div class=\"message-text\" style=\"margin-top: 8px;\"><small>${escapeHtml(msg.caption)}</small></div>` : ''}\n                </div>\n            `;\n        } else {\n            content = `\n                <div class=\"message-text\">\n                    <i class=\"fas fa-video\"></i> Video (${msg.duration || 0}s)\n                    ${msg.caption ? `<br><small>${escapeHtml(msg.caption)}</small>` : ''}\n                </div>\n            `;\n        }\n    } else if (msg.type === 'location') {\n        content = `\n            <div class=\"message-text\">\n                <i class=\"fas fa-map-marker-alt\"></i> Lokasi dikongsi\n                <br><small>Lat: ${msg.location.latitude.toFixed(6)}, Lng: ${msg.location.longitude.toFixed(6)}</small>\n            </div>\n        `;\n    } else {\n        content = `<div class=\"message-text\">${escapeHtml(msg.text || 'Mesej tidak diketahui')}</div>`;\n    }\n\n    return `\n    <div class=\"message ${isAdmin ? 'message-admin' : 'message-user'}\">\n        <div class=\"message-bubble\">\n            ${content}\n            <div class=\"message-time\">${time}</div>\n        </div>\n    </div>\n    `;\n}\n\nsetInterval(() => {\n    if (currentUser && document.getElementById('dashboardPage').classList.contains('active')) {\n        const activeSection = document.querySelector('.content-section.active');\n        if (activeSection && activeSection.id === 'dashboardContent') {\n            loadDashboardData();\n        }\n        if (activeSection && activeSection.id === 'sessionsContent') {\n            loadSessions();\n            if (currentSessionToken) {\n                refreshCurrentSessionMessages();\n            }\n        }\n    }\n}, 5000);\n\nasync function refreshCurrentSessionMessages() {\n    if (!currentSessionToken) return;\n\n    try {\n        const response = await fetch(`/api/sessions/${currentSessionToken}/messages`, {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            const messages = data.messages || [];\n            const chatMessages = document.getElementById('chatMessages');\n\n            if (messages.length === 0) {\n                chatMessages.innerHTML = '<div class=\"empty-state\"><i class=\"fas fa-comment-slash\"></i><p>Tiada mesej lagi. Hantar mesej pertama!</p></div>';\n            } else {\n                chatMessages.innerHTML = messages.map(msg => renderMessage(msg)).join('');\n            }\n\n            chatMessages.scrollTop = chatMessages.scrollHeight;\n        }\n    } catch (error) {\n        console.error('Refresh messages error:', error);\n    }\n}\n\n\nasync function loadSessions() {\n    try {\n        const response = await fetch('/api/sessions', {\n            headers: getAuthHeaders() // Use getAuthHeaders for consistency\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            renderSessions(data.sessions);\n        }\n    } catch (error) {\n        console.error('Error loading sessions:', error);\n        showNotification('Gagal memuatkan sessions', 'error');\n    }\n}\n\n// Placeholder for renderSessions if it's not defined elsewhere in the original code\n// Assuming renderSessions exists and is correctly implemented\nfunction renderSessions(sessions) {\n    // This is a placeholder function. Replace with actual implementation if available.\n    console.log(\"Rendering sessions:\", sessions);\n    const sessionsList = document.getElementById('sessionsList');\n    if (sessionsList) {\n        sessionsList.innerHTML = sessions.map(session => `\n            <div class=\"session-item ${currentSessionToken === session.token ? 'active' : ''}\" onclick=\"openSession('${session.token}')\">\n                <div class=\"session-avatar\">\n                    <i class=\"fas fa-user-circle\"></i>\n                </div>\n                <div class=\"session-info\">\n                    <h4>${session.userName || 'User'}</h4>\n                    <p>@${session.userUsername || 'unknown'}</p>\n                    <small>${(session.messages || []).length} mesej ‚Ä¢ ${formatTimeAgo(session.lastActiveAt || session.createdAt)}</small>\n                </div>\n                <div class=\"session-status\">\n                    <span class=\"status-dot active\"></span>\n                </div>\n            </div>\n        `).join('');\n    }\n\n    const sessionsBadge = document.getElementById('sessionsBadge');\n    if (sessionsBadge) {\n        sessionsBadge.textContent = sessions.filter(s => s.status === 'active').length;\n    }\n}\n\nasync function openSession(token) {\n    try {\n        currentSessionToken = token;\n\n        const chatPlaceholder = document.getElementById('chatPlaceholder');\n        const chatContainer = document.getElementById('chatContainer');\n        const chatMessages = document.getElementById('chatMessages');\n\n        chatPlaceholder.style.display = 'none';\n        chatContainer.style.display = 'flex';\n        chatMessages.innerHTML = '<div class=\"loading-spinner\"><i class=\"fas fa-spinner fa-spin\"></i></div>';\n\n        const response = await fetch(`/api/sessions/${token}/messages`, {\n            headers: getAuthHeaders()\n        });\n        const data = await response.json();\n\n        if (data.success) {\n            const session = data.session;\n            const messages = data.messages || [];\n\n            document.getElementById('chatUserName').textContent = session.userName || 'User';\n            document.getElementById('chatUserDetails').textContent = `@${session.userUsername} ‚Ä¢ ID: ${session.userId}`;\n\n            const ordersResponse = await fetch('/api/orders', {\n                headers: getAuthHeaders()\n            });\n            const ordersData = await ordersResponse.json();\n\n            if (ordersData.success) {\n                const userOrders = ordersData.orders.filter(o => o.userId === session.userId && o.status !== 'rejected');\n                const pendingOrders = userOrders.filter(o => o.status === 'pending' || o.status === 'awaiting_verification');\n\n                let orderInfoHtml = '';\n                if (pendingOrders.length > 0) {\n                    orderInfoHtml = `\n                    <div class=\"chat-order-info\">\n                        <h5><i class=\"fas fa-shopping-cart\"></i> Pending Orders (${pendingOrders.length})</h5>\n                        ${pendingOrders.slice(0, 2).map(order => `\n                            <div class=\"order-card\">\n                                <div class=\"order-details\">\n                                    <strong>${order.id}</strong>\n                                    <p>${order.productName?.ms || order.productName || 'Product'}</p>\n                                    <p class=\"order-price\">RM ${parseFloat(order.price || 0).toFixed(2)}</p>\n                                    <span class=\"status-badge status-${order.status}\">${order.status}</span>\n                                </div>\n                                ${order.status === 'awaiting_verification' ? `\n                                <div class=\"order-actions\">\n                                    <button class=\"btn-success-sm\" onclick=\"completeOrderFromChat('${order.id}')\">\n                                        <i class=\"fas fa-check\"></i> Complete\n                                    </button>\n                                    <button class=\"btn-danger-sm\" onclick=\"rejectOrderFromChat('${order.id}')\">\n                                        <i class=\"fas fa-times\"></i> Reject\n                                    </button>\n                                </div>\n                                ` : ''}\n                            </div>\n                        `).join('')}\n                    </div>\n                    `;\n                }\n\n                const orderInfoContainer = document.getElementById('chatOrderInfo');\n                if (orderInfoContainer) {\n                    orderInfoContainer.innerHTML = orderInfoHtml;\n                }\n            }\n\n            if (messages.length === 0) {\n                chatMessages.innerHTML = '<div class=\"empty-state\"><i class=\"fas fa-comment-slash\"></i><p>Tiada mesej lagi. Hantar mesej pertama!</p></div>';\n            } else {\n                chatMessages.innerHTML = messages.map(msg => renderMessage(msg)).join('');\n            }\n\n            chatMessages.scrollTop = chatMessages.scrollHeight;\n\n            loadSessions();\n        }\n    } catch (error) {\n        console.error('Open session error:', error);\n        showNotification('Ralat membuka session', 'error');\n    }\n}\n\nasync function sendChatMessage() {\n    const input = document.getElementById('chatInput');\n    const message = input.value.trim();\n\n    if (!message || !currentSessionToken) {\n        return;\n    }\n\n    try {\n        const response = await fetch(`/api/sessions/${currentSessionToken}/reply`, {\n            method: 'POST',\n            headers: getAuthHeaders(),\n            body: JSON.stringify({ message })\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            input.value = '';\n\n            const chatMessages = document.getElementById('chatMessages');\n            const time = new Date().toLocaleTimeString('ms-MY', {\n                hour: '2-digit',\n                minute: '2-digit'\n            });\n\n            const messageHtml = `\n            <div class=\"message message-admin\">\n                <div class=\"message-bubble\">\n                    <div class=\"message-text\">${escapeHtml(message)}</div>\n                    <div class=\"message-time\">${time}</div>\n                </div>\n            </div>\n            `;\n\n            chatMessages.innerHTML += messageHtml;\n            chatMessages.scrollTop = chatMessages.scrollHeight;\n\n            showNotification('Mesej dihantar!', 'success');\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Send message error:', error);\n        showNotification('Ralat menghantar mesej', 'error');\n    }\n}\n\nasync function closeCurrentSession() {\n    if (!currentSessionToken) return;\n\n    if (!confirm('Anda pasti mahu tutup session ini?')) return;\n\n    try {\n        const response = await fetch(`/api/sessions/${currentSessionToken}/close`, {\n            method: 'POST',\n            headers: getAuthHeaders()\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification('Session ditutup!', 'success');\n            currentSessionToken = null;\n\n            document.getElementById('chatPlaceholder').style.display = 'flex';\n            document.getElementById('chatContainer').style.display = 'none';\n\n            loadSessions();\n        } else {\n            showNotification(data.message, 'error');\n        }\n    } catch (error) {\n        console.error('Close session error:', error);\n        showNotification('Ralat menutup session', 'error');\n    }\n}\n\nfunction handleChatKeyPress(event) {\n    if (event.key === 'Enter' && !event.shiftKey) {\n        event.preventDefault();\n        sendChatMessage();\n    }\n}\n\nfunction formatTimeAgo(timestamp) {\n    const now = new Date();\n    const time = new Date(timestamp);\n    const diffMs = now - time;\n    const diffMins = Math.floor(diffMs / 60000);\n    const diffHours = Math.floor(diffMs / 3600000);\n    const diffDays = Math.floor(diffMs / 86400000);\n\n    if (diffMins < 1) return 'Baru sahaja';\n    if (diffMins < 60) return `${diffMins} minit lalu`;\n    if (diffHours < 24) return `${diffHours} jam lalu`;\n    if (diffDays < 7) return `${diffDays} hari lalu`;\n    return time.toLocaleDateString('ms-MY');\n}\n\nfunction escapeHtml(text) {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n}\n\n// Helper functions for Chat (Customer Chats)\nasync function completeOrderFromChat(orderId) {\n    // Placeholder - implement actual logic if needed\n    console.log(`Completing order: ${orderId}`);\n    showNotification('Fungsi completeOrderFromChat belum diimplementasikan.', 'warning');\n}\n\nasync function rejectOrderFromChat(orderId) {\n    // Placeholder - implement actual logic if needed\n    console.log(`Rejecting order: ${orderId}`);\n    showNotification('Fungsi rejectOrderFromChat belum diimplementasikan.', 'warning');\n}\n\nasync function validatePricing() {\n    try {\n        showNotification('Validating pricing...', 'info');\n        \n        const response = await fetch('/api/products/validate-pricing', {\n            method: 'GET',\n            headers: getAuthHeaders()\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            const resultsContainer = document.getElementById('pricingResults');\n            const resultsSection = document.getElementById('pricingResultsContainer');\n            \n            if (data.inconsistencies.length === 0) {\n                resultsContainer.innerHTML = `\n                    <div class=\"alert alert-success\">\n                        <i class=\"fas fa-check-circle\"></i>\n                        <div>\n                            <h3>‚úÖ No Pricing Inconsistencies Found!</h3>\n                            <p>Semua ${data.totalChecked} produk mempunyai pricing yang konsisten.</p>\n                        </div>\n                    </div>\n                `;\n            } else {\n                let html = `\n                    <div class=\"alert alert-warning\">\n                        <i class=\"fas fa-exclamation-triangle\"></i>\n                        <div>\n                            <h3>‚ö†Ô∏è Found ${data.inconsistencies.length} Pricing Inconsistencies</h3>\n                            <p>Checked ${data.totalChecked} products</p>\n                        </div>\n                    </div>\n                    <div class=\"pricing-issues-list\">\n                `;\n                \n                data.inconsistencies.forEach(issue => {\n                    html += `\n                        <div class=\"pricing-issue-card\">\n                            <h4>üìÇ ${issue.categoryName}</h4>\n                            <div class=\"issue-details\">\n                                <div class=\"product-comparison\">\n                                    <div class=\"product-item\">\n                                        <span class=\"product-name\">${issue.currentProduct.name}</span>\n                                        <span class=\"product-qty\">(${issue.currentProduct.quantity} units)</span>\n                                        <span class=\"product-price\">RM${issue.currentProduct.price.toFixed(2)}</span>\n                                    </div>\n                                    <div class=\"comparison-arrow\">‚Üí</div>\n                                    <div class=\"product-item\">\n                                        <span class=\"product-name\">${issue.nextProduct.name}</span>\n                                        <span class=\"product-qty\">(${issue.nextProduct.quantity} units)</span>\n                                        <span class=\"product-price\">RM${issue.nextProduct.price.toFixed(2)}</span>\n                                    </div>\n                                </div>\n                                <div class=\"ratio-info\">\n                                    <span class=\"ratio-label\">Expected Ratio:</span>\n                                    <span class=\"ratio-value\">${issue.expectedRatio}x</span>\n                                    <span class=\"ratio-label\">Actual Ratio:</span>\n                                    <span class=\"ratio-value actual\">${issue.actualRatio}x</span>\n                                </div>\n                            </div>\n                        </div>\n                    `;\n                });\n                \n                html += '</div>';\n                resultsContainer.innerHTML = html;\n            }\n            \n            resultsSection.style.display = 'block';\n            showNotification('Validation completed!', 'success');\n        } else {\n            showNotification(data.message || 'Error validating pricing', 'error');\n        }\n    } catch (error) {\n        console.error('Validate pricing error:', error);\n        showNotification('Error validating pricing', 'error');\n    }\n}\n\nasync function loadCategoriesForPricing() {\n    try {\n        const response = await fetch('/api/categories', {\n            headers: getAuthHeaders()\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            const select = document.getElementById('fixPricingCategory');\n            const advSelect = document.getElementById('advFixCategory');\n            \n            select.innerHTML = '<option value=\"\">Pilih Kategori</option>';\n            advSelect.innerHTML = '<option value=\"\">Pilih Kategori</option>';\n            \n            data.categories.forEach(category => {\n                const option1 = document.createElement('option');\n                option1.value = category.id;\n                option1.textContent = category.displayName || category.name?.ms || category.id;\n                select.appendChild(option1);\n                \n                const option2 = document.createElement('option');\n                option2.value = category.id;\n                option2.textContent = category.displayName || category.name?.ms || category.id;\n                advSelect.appendChild(option2);\n            });\n            \n            // Add event listener to load products when category is selected\n            select.addEventListener('change', async (e) => {\n                if (e.target.value) {\n                    await loadCategoryProductsForPricing(e.target.value);\n                } else {\n                    document.getElementById('baseProductSelector').style.display = 'none';\n                }\n            });\n            \n            advSelect.addEventListener('change', async (e) => {\n                if (e.target.value) {\n                    await loadCategoryProductsForAdvancedFix(e.target.value);\n                }\n            });\n        }\n    } catch (error) {\n        console.error('Load categories error:', error);\n    }\n}\n\nasync function loadCategoryProductsForAdvancedFix(categoryId) {\n    try {\n        const response = await fetch(`/api/products/category/${categoryId}`, {\n            headers: getAuthHeaders()\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            const select = document.getElementById('advFixBaseProduct');\n            select.innerHTML = '<option value=\"\">Pilih Base Product</option>';\n            \n            data.products.forEach(product => {\n                const option = document.createElement('option');\n                option.value = product.id;\n                option.textContent = `${product.name} (${product.quantity} units) - RM${product.price.toFixed(2)}`;\n                select.appendChild(option);\n            });\n        }\n    } catch (error) {\n        console.error('Load category products error:', error);\n    }\n}\n\nasync function loadCategoryProductsForPricing(categoryId) {\n    try {\n        const response = await fetch(`/api/products/category/${categoryId}`, {\n            headers: getAuthHeaders()\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            const container = document.getElementById('baseProductSelector');\n            const select = document.getElementById('baseProductSelect');\n            \n            select.innerHTML = '<option value=\"\">Auto (Produk Pertama)</option>';\n            \n            data.products.forEach(product => {\n                const option = document.createElement('option');\n                option.value = product.id;\n                option.textContent = `${product.name} (${product.quantity} units) - RM${product.price.toFixed(2)}`;\n                select.appendChild(option);\n            });\n            \n            container.style.display = 'block';\n        }\n    } catch (error) {\n        console.error('Load category products error:', error);\n    }\n}\n\nasync function previewPricing() {\n    const categoryId = document.getElementById('fixPricingCategory').value;\n    const baseProductId = document.getElementById('baseProductSelect').value || null;\n    \n    if (!categoryId) {\n        showNotification('Sila pilih kategori dahulu', 'warning');\n        return;\n    }\n    \n    try {\n        showNotification('Generating preview...', 'info');\n        \n        const response = await fetch('/api/products/fix-pricing', {\n            method: 'POST',\n            headers: getAuthHeaders(),\n            body: JSON.stringify({ \n                categoryId,\n                baseProductId,\n                applyChanges: false \n            })\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            displayPricingResults(data, false);\n            showNotification('Preview generated!', 'success');\n        } else {\n            showNotification(data.message || 'Error generating preview', 'error');\n        }\n    } catch (error) {\n        console.error('Preview pricing error:', error);\n        showNotification('Error generating preview', 'error');\n    }\n}\n\nasync function fixPricing() {\n    const categoryId = document.getElementById('fixPricingCategory').value;\n    const baseProductId = document.getElementById('baseProductSelect').value || null;\n    \n    if (!categoryId) {\n        showNotification('Sila pilih kategori dahulu', 'warning');\n        return;\n    }\n    \n    if (!confirm('Anda pasti mahu auto-fix pricing untuk kategori ini?')) {\n        return;\n    }\n    \n    try {\n        showNotification('Fixing pricing...', 'info');\n        \n        const response = await fetch('/api/products/fix-pricing', {\n            method: 'POST',\n            headers: getAuthHeaders(),\n            body: JSON.stringify({ \n                categoryId,\n                baseProductId,\n                applyChanges: true \n            })\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            displayPricingResults(data, true);\n            showNotification('Pricing fixed successfully!', 'success');\n        } else {\n            showNotification(data.message || 'Error fixing pricing', 'error');\n        }\n    } catch (error) {\n        console.error('Fix pricing error:', error);\n        showNotification('Error fixing pricing', 'error');\n    }\n}\n\nfunction displayPricingResults(data, applied) {\n    const resultsContainer = document.getElementById('pricingResults');\n    const resultsSection = document.getElementById('pricingResultsContainer');\n    \n    let html = `\n        <div class=\"pricing-fix-summary\">\n            <h4>üìä Base Product & Calculation</h4>\n            <div class=\"summary-stats\">\n                <div class=\"stat-item\">\n                    <span class=\"stat-label\">Base Product:</span>\n                    <span class=\"stat-value\">${data.baseProduct.name}</span>\n                </div>\n                <div class=\"stat-item\">\n                    <span class=\"stat-label\">Base Price:</span>\n                    <span class=\"stat-value\">RM${data.baseProduct.price.toFixed(2)}</span>\n                </div>\n                <div class=\"stat-item\">\n                    <span class=\"stat-label\">Base Quantity:</span>\n                    <span class=\"stat-value\">${data.baseProduct.quantity} units</span>\n                </div>\n                <div class=\"stat-item\">\n                    <span class=\"stat-label\">Price Per Unit:</span>\n                    <span class=\"stat-value\">RM${data.pricePerUnit.toFixed(4)}</span>\n                </div>\n            </div>\n        </div>\n    `;\n    \n    if (data.updates.length === 0) {\n        html += `\n            <div class=\"alert alert-success\">\n                <i class=\"fas fa-check-circle\"></i>\n                <div>\n                    <h3>‚úÖ All Prices Already Consistent!</h3>\n                    <p>Semua ${data.totalProducts} produk dalam kategori ini sudah mempunyai pricing yang betul.</p>\n                </div>\n            </div>\n        `;\n    } else {\n        if (applied) {\n            html += `\n                <div class=\"alert alert-success\">\n                    <i class=\"fas fa-magic\"></i>\n                    <div>\n                        <h3>‚úÖ Pricing Fixed Successfully!</h3>\n                        <p>${data.updates.length} produk telah dikemaskini</p>\n                    </div>\n                </div>\n            `;\n        } else {\n            html += `\n                <div class=\"alert alert-warning\">\n                    <i class=\"fas fa-eye\"></i>\n                    <div>\n                        <h3>üëÅÔ∏è Preview Mode</h3>\n                        <p>${data.updates.length} produk akan dikemaskini. Semak details di bawah.</p>\n                    </div>\n                </div>\n            `;\n        }\n    }\n    \n    // Show all products table\n    html += `\n        <div class=\"pricing-updates-list\">\n            <h4>üìã All Products in Category</h4>\n            <table class=\"pricing-table\">\n                <thead>\n                    <tr>\n                        <th>Product</th>\n                        <th>Quantity</th>\n                        <th>Current Price</th>\n                        <th>Expected Price</th>\n                        <th>Status</th>\n                    </tr>\n                </thead>\n                <tbody>\n    `;\n    \n    data.allProducts.forEach(product => {\n        const statusClass = product.isCorrect ? 'status-correct' : 'status-incorrect';\n        const statusIcon = product.isCorrect ? '‚úÖ' : '‚ö†Ô∏è';\n        const statusText = product.isCorrect ? 'Correct' : 'Needs Fix';\n        \n        html += `\n            <tr class=\"${statusClass}\">\n                <td>${product.productName}</td>\n                <td>${product.quantity} units</td>\n                <td class=\"${product.isCorrect ? '' : 'old-price'}\">RM${product.currentPrice.toFixed(2)}</td>\n                <td class=\"${product.isCorrect ? '' : 'new-price'}\">RM${product.expectedPrice.toFixed(2)}</td>\n                <td>${statusIcon} ${statusText}</td>\n            </tr>\n        `;\n    });\n    \n    html += `\n                </tbody>\n            </table>\n        </div>\n    `;\n    \n    resultsContainer.innerHTML = html;\n    resultsSection.style.display = 'block';\n}\n\nasync function generateAdvancedFix() {\n    const categoryId = document.getElementById('advFixCategory').value;\n    const baseProductId = document.getElementById('advFixBaseProduct').value;\n    \n    if (!categoryId || !baseProductId) {\n        showNotification('Sila pilih kategori dan base product', 'warning');\n        return;\n    }\n    \n    try {\n        showNotification('Generating suggestions...', 'info');\n        \n        const response = await fetch('/api/products/fix-product-advanced', {\n            method: 'POST',\n            headers: getAuthHeaders(),\n            body: JSON.stringify({ categoryId, baseProductId, multiplier: 2 })\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            displayAdvancedFixResults(data);\n            showNotification('Suggestions generated!', 'success');\n        } else {\n            showNotification(data.message || 'Error generating suggestions', 'error');\n        }\n    } catch (error) {\n        console.error('Generate advanced fix error:', error);\n        showNotification('Error generating suggestions', 'error');\n    }\n}\n\nfunction displayAdvancedFixResults(data) {\n    const resultsContainer = document.getElementById('advancedFixResults');\n    const resultsSection = document.getElementById('advancedFixContainer');\n    \n    let html = `\n        <div class=\"pricing-fix-summary\">\n            <h4>üìä Base Configuration</h4>\n            <div class=\"summary-stats\">\n                <div class=\"stat-item\">\n                    <span class=\"stat-label\">Base Product:</span>\n                    <span class=\"stat-value\">${data.baseProduct.name}</span>\n                </div>\n                <div class=\"stat-item\">\n                    <span class=\"stat-label\">Base Quantity:</span>\n                    <span class=\"stat-value\">${data.baseProduct.quantity} units</span>\n                </div>\n                <div class=\"stat-item\">\n                    <span class=\"stat-label\">Base Price:</span>\n                    <span class=\"stat-value\">RM${data.baseProduct.price.toFixed(2)}</span>\n                </div>\n                <div class=\"stat-item\">\n                    <span class=\"stat-label\">Price Per Unit:</span>\n                    <span class=\"stat-value\">RM${data.pricePerUnit.toFixed(4)}</span>\n                </div>\n            </div>\n        </div>\n        \n        <div class=\"alert alert-warning\">\n            <i class=\"fas fa-info-circle\"></i>\n            <div>\n                <h3>üìù Instructions</h3>\n                <p>Tick checkbox untuk produk yang anda mahu update. Produk yang sudah betul tak perlu tick.</p>\n            </div>\n        </div>\n        \n        <div class=\"pricing-updates-list\">\n            <h4>üéØ Suggested Products (Based on ${data.baseName})</h4>\n            <form id=\"advancedFixForm\">\n                <table class=\"pricing-table\">\n                    <thead>\n                        <tr>\n                            <th style=\"width: 40px;\">\n                                <input type=\"checkbox\" id=\"selectAllAdvFix\" onchange=\"toggleAllAdvFixCheckboxes(this)\">\n                            </th>\n                            <th>Multiplier</th>\n                            <th>Suggested Name</th>\n                            <th>Suggested Price</th>\n                            <th>Current Status</th>\n                            <th>Action Needed</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n    `;\n    \n    data.suggestions.forEach((suggestion, index) => {\n        let statusHtml = '';\n        let actionHtml = '';\n        let rowClass = '';\n        let checked = '';\n        \n        if (!suggestion.exists) {\n            statusHtml = '<span style=\"color: var(--gray);\">‚ö™ Tiada produk matching</span>';\n            actionHtml = '<span style=\"color: var(--gray);\">-</span>';\n            rowClass = 'status-notexist';\n            checked = '';\n        } else if (suggestion.needsUpdate) {\n            if (suggestion.isWrongQuantity) {\n                statusHtml = `<span style=\"color: var(--danger);\">üî¥ ${suggestion.existingName} (${suggestion.existingQty} units) - RM${suggestion.existingPrice.toFixed(2)}</span>`;\n                actionHtml = '<span style=\"color: var(--danger); font-weight: 600;\">WRONG QUANTITY! Will Fix ‚úèÔ∏è</span>';\n            } else {\n                statusHtml = `<span style=\"color: var(--warning);\">‚ö†Ô∏è ${suggestion.existingName} (RM${suggestion.existingPrice.toFixed(2)})</span>`;\n                actionHtml = '<span style=\"color: var(--warning); font-weight: 600;\">Wrong Price - Will Fix ‚úèÔ∏è</span>';\n            }\n            rowClass = 'status-incorrect';\n            checked = 'checked';\n        } else {\n            statusHtml = `<span style=\"color: var(--success);\">‚úÖ ${suggestion.existingName} (RM${suggestion.existingPrice.toFixed(2)})</span>`;\n            actionHtml = '<span style=\"color: var(--success);\">Already Correct</span>';\n            rowClass = 'status-correct';\n            checked = '';\n        }\n        \n        html += `\n            <tr class=\"${rowClass}\">\n                <td>\n                    ${suggestion.exists && suggestion.needsUpdate ? \n                        `<input type=\"checkbox\" name=\"fixProduct\" value=\"${suggestion.existingId}\" \n                         data-name=\"${suggestion.name}\" data-price=\"${suggestion.price}\" ${checked}>` : \n                        ''}\n                </td>\n                <td>${index + 1}x</td>\n                <td><strong>${suggestion.name}</strong> (${suggestion.quantity} units)</td>\n                <td>RM${suggestion.price.toFixed(2)}</td>\n                <td>${statusHtml}</td>\n                <td>${actionHtml}</td>\n            </tr>\n        `;\n    });\n    \n    html += `\n                    </tbody>\n                </table>\n                <div style=\"margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 8px;\">\n                    <p style=\"margin-bottom: 15px; color: var(--text-dark); font-weight: 600;\">\n                        <i class=\"fas fa-exclamation-triangle\" style=\"color: var(--warning);\"></i>\n                        Hanya produk yang <strong>SUDAH WUJUD</strong> dan perlu update akan dikemaskini.\n                    </p>\n                    <button type=\"button\" class=\"btn-success\" onclick=\"applyAdvancedFix()\" style=\"width: 100%;\">\n                        <i class=\"fas fa-check\"></i> Apply Selected Updates\n                    </button>\n                </div>\n            </form>\n        </div>\n    `;\n    \n    resultsContainer.innerHTML = html;\n    resultsSection.style.display = 'block';\n}\n\nfunction toggleAllAdvFixCheckboxes(checkbox) {\n    const checkboxes = document.querySelectorAll('input[name=\"fixProduct\"]');\n    checkboxes.forEach(cb => cb.checked = checkbox.checked);\n}\n\nasync function applyAdvancedFix() {\n    const checkboxes = document.querySelectorAll('input[name=\"fixProduct\"]:checked');\n    \n    if (checkboxes.length === 0) {\n        showNotification('Sila pilih sekurang-kurangnya satu produk untuk update', 'warning');\n        return;\n    }\n    \n    const updates = Array.from(checkboxes).map(cb => ({\n        productId: cb.value,\n        newName: cb.dataset.name,\n        newPrice: parseFloat(cb.dataset.price)\n    }));\n    \n    if (!confirm(`Anda pasti mahu update ${updates.length} produk?`)) {\n        return;\n    }\n    \n    try {\n        showNotification('Applying fixes...', 'info');\n        \n        const response = await fetch('/api/products/apply-fix-product', {\n            method: 'POST',\n            headers: getAuthHeaders(),\n            body: JSON.stringify({ updates })\n        });\n\n        const data = await response.json();\n\n        if (data.success) {\n            showNotification(`${data.results.length} produk berjaya dikemaskini!`, 'success');\n            \n            // Show results\n            let resultsHtml = `\n                <div class=\"alert alert-success\">\n                    <i class=\"fas fa-check-circle\"></i>\n                    <div>\n                        <h3>‚úÖ Products Updated Successfully!</h3>\n                        <p>${data.message}</p>\n                    </div>\n                </div>\n                <div class=\"pricing-updates-list\">\n                    <h4>üìù Updated Products</h4>\n            `;\n            \n            data.results.forEach(result => {\n                resultsHtml += `\n                    <div class=\"update-item\">\n                        <div>\n                            <strong>Name:</strong> ${result.oldName} ‚Üí ${result.newName}<br>\n                            <strong>Price:</strong> RM${result.oldPrice.toFixed(2)} ‚Üí RM${result.newPrice.toFixed(2)}\n                        </div>\n                    </div>\n                `;\n            });\n            \n            resultsHtml += '</div>';\n            document.getElementById('advancedFixResults').innerHTML = resultsHtml;\n        } else {\n            showNotification(data.message || 'Error applying fixes', 'error');\n        }\n    } catch (error) {\n        console.error('Apply advanced fix error:', error);\n        showNotification('Error applying fixes', 'error');\n    }\n}","size_bytes":112720},"server.js":{"content":"const express = require('express');\nconst path = require('path');\nconst db = require('./utils/database');\nconst config = require('./config');\nconst { Telegraf } = require('telegraf');\nconst multer = require('multer');\nconst fs = require('fs').promises;\n\nconst app = express();\nconst PORT = process.env.PORT || 5000;\n\nconst bot = new Telegraf(config.TELEGRAM_BOT_TOKEN);\n\nconst storage = multer.diskStorage({\n  destination: async (req, file, cb) => {\n    const uploadDir = path.join(__dirname, 'media', 'chat_uploads');\n    try {\n      await fs.mkdir(uploadDir, { recursive: true });\n      cb(null, uploadDir);\n    } catch (error) {\n      cb(error);\n    }\n  },\n  filename: (req, file, cb) => {\n    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));\n  }\n});\n\nconst upload = multer({ \n  storage: storage,\n  limits: { fileSize: 50 * 1024 * 1024 }\n});\n\napp.use(express.json());\napp.use(express.static(path.join(__dirname, 'public')));\napp.use('/media', express.static(path.join(__dirname, 'media')));\n\nasync function authMiddleware(req, res, next) {\n  const authHeader = req.headers.authorization;\n  \n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\n    return res.status(401).json({ success: false, message: 'Unauthorized - No token provided' });\n  }\n  \n  const token = authHeader.substring(7);\n  \n  try {\n    const userData = JSON.parse(Buffer.from(token, 'base64').toString('utf8'));\n    const telegramId = parseInt(userData.id);\n    \n    const admins = await db.getAdmins();\n    const isOwner = admins.owner === telegramId;\n    const isAdmin = admins.admins.includes(telegramId);\n    \n    if (!isOwner && !isAdmin) {\n      return res.status(403).json({ success: false, message: 'Forbidden - Not an admin' });\n    }\n    \n    req.user = userData;\n    next();\n  } catch (error) {\n    return res.status(401).json({ success: false, message: 'Invalid token' });\n  }\n}\n\napp.get('/', (req, res) => {\n  res.sendFile(path.join(__dirname, 'public', 'index.html'));\n});\n\napp.get('/admin', (req, res) => {\n  res.sendFile(path.join(__dirname, 'public', 'admin.html'));\n});\n\napp.get('/ping', (req, res) => {\n  res.status(200).json({ \n    status: 'alive', \n    message: 'Bot is running!',\n    timestamp: new Date().toISOString() \n  });\n});\n\napp.get('/health', (req, res) => {\n  res.status(200).json({ \n    status: 'healthy', \n    uptime: process.uptime(),\n    timestamp: new Date().toISOString() \n  });\n});\n\napp.post('/setup-ping', (req, res) => {\n  const { interval } = req.body;\n  \n  if (!interval || interval < 1 || interval > 14) {\n    return res.status(400).json({ \n      success: false, \n      message: 'Interval must be between 1-14 minutes' \n    });\n  }\n  \n  const baseUrl = process.env.RENDER_EXTERNAL_URL ?? \n                  (process.env.REPLIT_DEV_DOMAIN ? `https://${process.env.REPLIT_DEV_DOMAIN}` : \n                  `http://localhost:${PORT}`);\n  \n  const pingUrl = `${baseUrl}/ping`;\n  \n  res.json({\n    success: true,\n    pingUrl: pingUrl,\n    interval: interval,\n    message: `Setup ping setiap ${interval} minit di cron-job.org`\n  });\n});\n\napp.post('/api/auth/login', async (req, res) => {\n  try {\n    const { telegramId } = req.body;\n    \n    if (!telegramId) {\n      return res.status(400).json({ success: false, message: 'Telegram ID diperlukan' });\n    }\n    \n    const admins = await db.getAdmins();\n    const isOwner = admins.owner === parseInt(telegramId);\n    const isAdmin = admins.admins.includes(parseInt(telegramId));\n    \n    if (!isOwner && !isAdmin) {\n      return res.status(403).json({ success: false, message: 'Akses ditolak. Hanya Owner dan Admin sahaja.' });\n    }\n    \n    const user = await db.getUser(parseInt(telegramId));\n    \n    const userData = {\n      id: telegramId,\n      name: user?.firstName || 'Admin',\n      role: isOwner ? 'owner' : 'admin',\n      language: user?.language || 'ms'\n    };\n    \n    const token = Buffer.from(JSON.stringify(userData)).toString('base64');\n    \n    res.json({\n      success: true,\n      token: token,\n      user: userData\n    });\n  } catch (error) {\n    console.error('Login error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/dashboard/stats', authMiddleware, async (req, res) => {\n  try {\n    const users = await db.getUsers();\n    const products = await db.getProducts();\n    const transactions = await db.getTransactions();\n    const categories = await db.getCategories();\n    \n    const pendingOrders = transactions.filter(t => t.status === 'pending').length;\n    const completedOrders = transactions.filter(t => t.status === 'completed').length;\n    const totalRevenue = transactions\n      .filter(t => t.status === 'completed')\n      .reduce((sum, t) => sum + (t.price || 0), 0);\n    \n    const todayStart = new Date();\n    todayStart.setHours(0, 0, 0, 0);\n    const todayOrders = transactions.filter(t => new Date(t.createdAt) >= todayStart).length;\n    \n    res.json({\n      success: true,\n      stats: {\n        totalUsers: users.length,\n        totalProducts: products.length,\n        totalOrders: transactions.length,\n        pendingOrders,\n        completedOrders,\n        totalRevenue,\n        todayOrders,\n        totalCategories: categories.length\n      }\n    });\n  } catch (error) {\n    console.error('Dashboard stats error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/orders', authMiddleware, async (req, res) => {\n  try {\n    const transactions = await db.getTransactions();\n    const users = await db.getUsers();\n    \n    const ordersWithUsers = transactions.map(t => {\n      const user = users.find(u => u.id === t.userId);\n      return {\n        ...t,\n        userName: user?.firstName || 'Unknown',\n        userUsername: user?.username || 'N/A'\n      };\n    }).reverse();\n    \n    res.json({ success: true, orders: ordersWithUsers });\n  } catch (error) {\n    console.error('Get orders error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/orders/:orderId/verify', authMiddleware, async (req, res) => {\n  try {\n    const { orderId } = req.params;\n    const transactions = await db.getTransactions();\n    const orderIndex = transactions.findIndex(t => t.id === orderId);\n    \n    if (orderIndex === -1) {\n      return res.status(404).json({ success: false, message: 'Order tidak dijumpai' });\n    }\n    \n    transactions[orderIndex].status = 'completed';\n    transactions[orderIndex].verifiedAt = new Date().toISOString();\n    \n    await db.saveTransactions(transactions);\n    \n    res.json({ success: true, message: 'Order berjaya disahkan' });\n  } catch (error) {\n    console.error('Verify order error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/orders/:orderId/reject', authMiddleware, async (req, res) => {\n  try {\n    const { orderId } = req.params;\n    const transactions = await db.getTransactions();\n    const orderIndex = transactions.findIndex(t => t.id === orderId);\n    \n    if (orderIndex === -1) {\n      return res.status(404).json({ success: false, message: 'Order tidak dijumpai' });\n    }\n    \n    transactions[orderIndex].status = 'rejected';\n    transactions[orderIndex].rejectedAt = new Date().toISOString();\n    \n    await db.saveTransactions(transactions);\n    \n    res.json({ success: true, message: 'Order telah ditolak' });\n  } catch (error) {\n    console.error('Reject order error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/products', authMiddleware, async (req, res) => {\n  try {\n    const products = await db.getProducts();\n    const categories = await db.getCategories();\n    \n    const productsWithCategories = products.map(p => {\n      const category = categories.find(c => c.id === p.categoryId);\n      return {\n        ...p,\n        categoryName: category?.name?.ms || category?.name || 'N/A',\n        productName: p.name?.ms || p.name || 'N/A'\n      };\n    });\n    \n    res.json({ success: true, products: productsWithCategories });\n  } catch (error) {\n    console.error('Get products error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/categories', authMiddleware, async (req, res) => {\n  try {\n    const categories = await db.getCategories();\n    const formattedCategories = categories.map(c => ({\n      ...c,\n      displayName: c.name?.ms || c.name || c.id\n    }));\n    res.json({ success: true, categories: formattedCategories });\n  } catch (error) {\n    console.error('Get categories error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/products', authMiddleware, async (req, res) => {\n  try {\n    const { name, price, categoryId, stock, description, deliveryType } = req.body;\n    const products = await db.getProducts();\n    \n    const newProduct = {\n      id: 'PROD-' + Date.now().toString(36).toUpperCase(),\n      name: typeof name === 'string' ? { ms: name, en: name } : name,\n      price: parseFloat(price),\n      categoryId,\n      stock: parseInt(stock),\n      description: typeof description === 'string' ? { ms: description, en: description } : description || { ms: '', en: '' },\n      deliveryType: deliveryType || 'manual',\n      items: [],\n      active: true,\n      createdAt: new Date().toISOString()\n    };\n    \n    products.push(newProduct);\n    await db.saveProducts(products);\n    \n    res.json({ success: true, message: 'Produk berjaya ditambah', product: newProduct });\n  } catch (error) {\n    console.error('Add product error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.put('/api/products/:productId', authMiddleware, async (req, res) => {\n  try {\n    const { productId } = req.params;\n    const { name, price, categoryId, stock, description, active, deliveryType } = req.body;\n    const products = await db.getProducts();\n    const productIndex = products.findIndex(p => p.id === productId);\n    \n    if (productIndex === -1) {\n      return res.status(404).json({ success: false, message: 'Produk tidak dijumpai' });\n    }\n    \n    products[productIndex] = {\n      ...products[productIndex],\n      name: name ? (typeof name === 'string' ? { ms: name, en: name } : name) : products[productIndex].name,\n      price: price !== undefined ? parseFloat(price) : products[productIndex].price,\n      categoryId: categoryId || products[productIndex].categoryId,\n      stock: stock !== undefined ? parseInt(stock) : products[productIndex].stock,\n      description: description !== undefined ? (typeof description === 'string' ? { ms: description, en: description } : description) : products[productIndex].description,\n      deliveryType: deliveryType || products[productIndex].deliveryType || 'manual',\n      active: active !== undefined ? active : products[productIndex].active,\n      updatedAt: new Date().toISOString()\n    };\n    \n    await db.saveProducts(products);\n    \n    res.json({ success: true, message: 'Produk berjaya dikemaskini', product: products[productIndex] });\n  } catch (error) {\n    console.error('Update product error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.delete('/api/products/:productId', authMiddleware, async (req, res) => {\n  try {\n    const { productId } = req.params;\n    const products = await db.getProducts();\n    const filteredProducts = products.filter(p => p.id !== productId);\n    \n    if (products.length === filteredProducts.length) {\n      return res.status(404).json({ success: false, message: 'Produk tidak dijumpai' });\n    }\n    \n    await db.saveProducts(filteredProducts);\n    \n    res.json({ success: true, message: 'Produk berjaya dipadam' });\n  } catch (error) {\n    console.error('Delete product error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/users', authMiddleware, async (req, res) => {\n  try {\n    const users = await db.getUsers();\n    const transactions = await db.getTransactions();\n    \n    const usersWithStats = users.map(u => {\n      const userOrders = transactions.filter(t => t.userId === u.id);\n      const totalSpent = userOrders\n        .filter(t => t.status === 'completed')\n        .reduce((sum, t) => sum + (t.price || 0), 0);\n      \n      return {\n        ...u,\n        totalOrders: userOrders.length,\n        totalSpent\n      };\n    });\n    \n    res.json({ success: true, users: usersWithStats });\n  } catch (error) {\n    console.error('Get users error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/analytics/sales', authMiddleware, async (req, res) => {\n  try {\n    const transactions = await db.getTransactions();\n    const completedOrders = transactions.filter(t => t.status === 'completed');\n    \n    const last7Days = [];\n    for (let i = 6; i >= 0; i--) {\n      const date = new Date();\n      date.setDate(date.getDate() - i);\n      date.setHours(0, 0, 0, 0);\n      \n      const nextDate = new Date(date);\n      nextDate.setDate(nextDate.getDate() + 1);\n      \n      const dayOrders = completedOrders.filter(t => {\n        const orderDate = new Date(t.createdAt);\n        return orderDate >= date && orderDate < nextDate;\n      });\n      \n      const dayRevenue = dayOrders.reduce((sum, t) => sum + (t.price || 0), 0);\n      \n      last7Days.push({\n        date: date.toLocaleDateString('ms-MY', { day: '2-digit', month: 'short' }),\n        orders: dayOrders.length,\n        revenue: dayRevenue\n      });\n    }\n    \n    res.json({ success: true, salesData: last7Days });\n  } catch (error) {\n    console.error('Analytics error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/settings', authMiddleware, async (req, res) => {\n  try {\n    const settings = await db.getSettings();\n    res.json({ success: true, settings });\n  } catch (error) {\n    console.error('Get settings error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.put('/api/settings', authMiddleware, async (req, res) => {\n  try {\n    const settings = await db.getSettings();\n    const updatedSettings = { ...settings, ...req.body };\n    await db.saveSettings(updatedSettings);\n    \n    res.json({ success: true, message: 'Tetapan berjaya dikemaskini', settings: updatedSettings });\n  } catch (error) {\n    console.error('Update settings error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/broadcast/all', authMiddleware, async (req, res) => {\n  try {\n    const { message } = req.body;\n    if (!message) {\n      return res.status(400).json({ success: false, message: 'Mesej diperlukan' });\n    }\n    \n    const users = await db.getUsers();\n    const botConfig = require('./config');\n    const { Telegraf } = require('telegraf');\n    const bot = new Telegraf(botConfig.TELEGRAM_BOT_TOKEN);\n    \n    let sent = 0;\n    let failed = 0;\n    \n    for (const user of users) {\n      try {\n        await bot.telegram.sendMessage(user.id, message, { parse_mode: 'Markdown' });\n        sent++;\n      } catch (error) {\n        failed++;\n      }\n    }\n    \n    res.json({ success: true, message: `Broadcast dihantar ke ${sent} pengguna`, sent, failed });\n  } catch (error) {\n    console.error('Broadcast error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/broadcast/active', authMiddleware, async (req, res) => {\n  try {\n    const { message } = req.body;\n    if (!message) {\n      return res.status(400).json({ success: false, message: 'Mesej diperlukan' });\n    }\n    \n    const users = await db.getUsers();\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n    const activeUsers = users.filter(u => new Date(u.lastActive || 0) > thirtyDaysAgo);\n    \n    const botConfig = require('./config');\n    const { Telegraf } = require('telegraf');\n    const bot = new Telegraf(botConfig.TELEGRAM_BOT_TOKEN);\n    \n    let sent = 0;\n    let failed = 0;\n    \n    for (const user of activeUsers) {\n      try {\n        await bot.telegram.sendMessage(user.id, message, { parse_mode: 'Markdown' });\n        sent++;\n      } catch (error) {\n        failed++;\n      }\n    }\n    \n    res.json({ success: true, message: `Broadcast dihantar ke ${sent} pengguna aktif`, sent, failed });\n  } catch (error) {\n    console.error('Broadcast error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/broadcast/tagged', authMiddleware, async (req, res) => {\n  try {\n    const { message, tag } = req.body;\n    if (!message || !tag) {\n      return res.status(400).json({ success: false, message: 'Mesej dan tag diperlukan' });\n    }\n    \n    const users = await db.getUsers();\n    const taggedUsers = users.filter(u => u.tags && u.tags.includes(tag));\n    \n    const botConfig = require('./config');\n    const { Telegraf } = require('telegraf');\n    const bot = new Telegraf(botConfig.TELEGRAM_BOT_TOKEN);\n    \n    let sent = 0;\n    let failed = 0;\n    \n    for (const user of taggedUsers) {\n      try {\n        await bot.telegram.sendMessage(user.id, message, { parse_mode: 'Markdown' });\n        sent++;\n      } catch (error) {\n        failed++;\n      }\n    }\n    \n    res.json({ success: true, message: `Broadcast dihantar ke ${sent} pengguna dengan tag \"${tag}\"`, sent, failed });\n  } catch (error) {\n    console.error('Broadcast error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/categories', authMiddleware, async (req, res) => {\n  try {\n    const { name, icon } = req.body;\n    const categories = await db.getCategories();\n    \n    const newCategory = {\n      id: 'CAT-' + Date.now().toString(36).toUpperCase(),\n      name: typeof name === 'string' ? { ms: name, en: name } : name,\n      icon: icon || 'üì¶',\n      createdAt: new Date().toISOString()\n    };\n    \n    categories.push(newCategory);\n    await db.saveCategories(categories);\n    \n    res.json({ success: true, message: 'Kategori berjaya ditambah', category: newCategory });\n  } catch (error) {\n    console.error('Add category error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.put('/api/categories/:categoryId', authMiddleware, async (req, res) => {\n  try {\n    const { categoryId } = req.params;\n    const { name, icon } = req.body;\n    const categories = await db.getCategories();\n    const categoryIndex = categories.findIndex(c => c.id === categoryId);\n    \n    if (categoryIndex === -1) {\n      return res.status(404).json({ success: false, message: 'Kategori tidak dijumpai' });\n    }\n    \n    categories[categoryIndex] = {\n      ...categories[categoryIndex],\n      name: name ? (typeof name === 'string' ? { ms: name, en: name } : name) : categories[categoryIndex].name,\n      icon: icon || categories[categoryIndex].icon,\n      updatedAt: new Date().toISOString()\n    };\n    \n    await db.saveCategories(categories);\n    \n    res.json({ success: true, message: 'Kategori berjaya dikemaskini', category: categories[categoryIndex] });\n  } catch (error) {\n    console.error('Update category error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.delete('/api/categories/:categoryId', authMiddleware, async (req, res) => {\n  try {\n    const { categoryId } = req.params;\n    const categories = await db.getCategories();\n    const filteredCategories = categories.filter(c => c.id !== categoryId);\n    \n    if (categories.length === filteredCategories.length) {\n      return res.status(404).json({ success: false, message: 'Kategori tidak dijumpai' });\n    }\n    \n    await db.saveCategories(filteredCategories);\n    \n    res.json({ success: true, message: 'Kategori berjaya dipadam' });\n  } catch (error) {\n    console.error('Delete category error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/products/bulk-toggle', authMiddleware, async (req, res) => {\n  try {\n    const { productIds, active } = req.body;\n    const products = await db.getProducts();\n    \n    let updated = 0;\n    productIds.forEach(id => {\n      const index = products.findIndex(p => p.id === id);\n      if (index !== -1) {\n        products[index].active = active;\n        updated++;\n      }\n    });\n    \n    await db.saveProducts(products);\n    res.json({ success: true, message: `${updated} produk dikemaskini` });\n  } catch (error) {\n    console.error('Bulk toggle error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/products/bulk-delete', authMiddleware, async (req, res) => {\n  try {\n    const { productIds } = req.body;\n    const products = await db.getProducts();\n    const filteredProducts = products.filter(p => !productIds.includes(p.id));\n    \n    await db.saveProducts(filteredProducts);\n    res.json({ success: true, message: `${products.length - filteredProducts.length} produk dipadam` });\n  } catch (error) {\n    console.error('Bulk delete error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/products/low-stock', authMiddleware, async (req, res) => {\n  try {\n    const products = await db.getProducts();\n    const lowStockProducts = products.filter(p => p.stock < 5 && p.active);\n    res.json({ success: true, products: lowStockProducts });\n  } catch (error) {\n    console.error('Low stock error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/products/search', authMiddleware, async (req, res) => {\n  try {\n    const { query } = req.query;\n    const products = await db.getProducts();\n    const results = products.filter(p => \n      (p.name?.ms || '').toLowerCase().includes(query.toLowerCase()) ||\n      (p.name?.en || '').toLowerCase().includes(query.toLowerCase()) ||\n      p.id.toLowerCase().includes(query.toLowerCase())\n    );\n    res.json({ success: true, products: results });\n  } catch (error) {\n    console.error('Search error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/products/validate-pricing', authMiddleware, async (req, res) => {\n  try {\n    const products = await db.getProducts();\n    const categories = await db.getCategories();\n    \n    const productsByCategory = {};\n    \n    products.forEach(prod => {\n      if (!productsByCategory[prod.categoryId]) {\n        productsByCategory[prod.categoryId] = [];\n      }\n      productsByCategory[prod.categoryId].push(prod);\n    });\n    \n    const inconsistencies = [];\n    \n    function extractQuantity(name) {\n      const match = name.match(/(\\d+)/);\n      return match ? parseInt(match[1]) : null;\n    }\n    \n    for (const categoryId in productsByCategory) {\n      const categoryProducts = productsByCategory[categoryId];\n      const category = categories.find(c => c.id === categoryId);\n      \n      if (categoryProducts.length > 1) {\n        categoryProducts.sort((a, b) => a.price - b.price);\n        \n        for (let i = 0; i < categoryProducts.length - 1; i++) {\n          const current = categoryProducts[i];\n          const next = categoryProducts[i + 1];\n          \n          const currentQty = extractQuantity(current.name.ms || current.name.en);\n          const nextQty = extractQuantity(next.name.ms || next.name.en);\n          \n          if (currentQty && nextQty && currentQty < nextQty) {\n            const expectedRatio = nextQty / currentQty;\n            const actualRatio = next.price / current.price;\n            \n            if (Math.abs(expectedRatio - actualRatio) > 0.1) {\n              inconsistencies.push({\n                categoryId: categoryId,\n                categoryName: category?.name?.ms || 'Unknown',\n                currentProduct: {\n                  id: current.id,\n                  name: current.name.ms || current.name.en,\n                  quantity: currentQty,\n                  price: current.price\n                },\n                nextProduct: {\n                  id: next.id,\n                  name: next.name.ms || next.name.en,\n                  quantity: nextQty,\n                  price: next.price\n                },\n                expectedRatio: parseFloat(expectedRatio.toFixed(2)),\n                actualRatio: parseFloat(actualRatio.toFixed(2))\n              });\n            }\n          }\n        }\n      }\n    }\n    \n    res.json({ \n      success: true, \n      inconsistencies: inconsistencies,\n      totalChecked: products.length\n    });\n  } catch (error) {\n    console.error('Validate pricing error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/products/category/:categoryId', authMiddleware, async (req, res) => {\n  try {\n    const { categoryId } = req.params;\n    const products = await db.getProducts();\n    \n    function extractQuantity(name) {\n      const match = name.match(/(\\d+)/);\n      return match ? parseInt(match[1]) : null;\n    }\n    \n    const categoryProducts = products\n      .filter(p => p.categoryId === categoryId)\n      .map(p => ({\n        id: p.id,\n        name: p.name.ms || p.name.en,\n        price: p.price,\n        quantity: extractQuantity(p.name.ms || p.name.en),\n        stock: p.stock\n      }))\n      .sort((a, b) => a.quantity - b.quantity);\n    \n    res.json({ success: true, products: categoryProducts });\n  } catch (error) {\n    console.error('Get category products error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/products/fix-product-advanced', authMiddleware, async (req, res) => {\n  try {\n    const { categoryId, baseProductId, multiplier } = req.body;\n    \n    if (!categoryId || !baseProductId) {\n      return res.status(400).json({ success: false, message: 'Category ID dan Base Product diperlukan' });\n    }\n    \n    const products = await db.getProducts();\n    const categories = await db.getCategories();\n    const category = categories.find(c => c.id === categoryId);\n    \n    if (!category) {\n      return res.status(404).json({ success: false, message: 'Kategori tidak dijumpai' });\n    }\n    \n    const categoryProducts = products.filter(p => p.categoryId === categoryId);\n    const baseProduct = categoryProducts.find(p => p.id === baseProductId);\n    \n    if (!baseProduct) {\n      return res.status(404).json({ success: false, message: 'Base product tidak dijumpai' });\n    }\n    \n    function extractQuantity(name) {\n      const match = name.match(/(\\d+)/);\n      return match ? parseInt(match[1]) : null;\n    }\n    \n    function extractBaseName(name) {\n      return name.replace(/\\d+/g, '').trim();\n    }\n    \n    const baseQty = extractQuantity(baseProduct.name.ms || baseProduct.name.en);\n    const baseName = extractBaseName(baseProduct.name.ms || baseProduct.name.en);\n    const basePrice = baseProduct.price;\n    const pricePerUnit = basePrice / baseQty;\n    \n    // Sort products by position for smart matching\n    categoryProducts.sort((a, b) => {\n      const qtyA = extractQuantity(a.name.ms || a.name.en);\n      const qtyB = extractQuantity(b.name.ms || b.name.en);\n      return qtyA - qtyB;\n    });\n    \n    // Generate suggested products based on multiplier\n    const suggestions = [];\n    \n    for (let i = 1; i <= 10; i++) {\n      const newQty = baseQty * i;\n      const newPrice = parseFloat((newQty * pricePerUnit).toFixed(2));\n      const newName = `${newQty} ${baseName}`;\n      \n      // First try exact quantity match\n      let existingProduct = categoryProducts.find(p => {\n        const qty = extractQuantity(p.name.ms || p.name.en);\n        return qty === newQty;\n      });\n      \n      // If not found, try smart matching by position\n      // The i-th suggestion should match the i-th product in the sorted list\n      if (!existingProduct && i <= categoryProducts.length) {\n        const potentialMatch = categoryProducts[i - 1];\n        const potentialQty = extractQuantity(potentialMatch.name.ms || potentialMatch.name.en);\n        \n        // Only match if the product is within reasonable range (not too far off)\n        // e.g., if we expect 320, accept anything from 200-400\n        const tolerance = newQty * 0.5; // 50% tolerance\n        if (Math.abs(potentialQty - newQty) <= tolerance) {\n          existingProduct = potentialMatch;\n        }\n      }\n      \n      suggestions.push({\n        quantity: newQty,\n        name: newName,\n        price: newPrice,\n        exists: !!existingProduct,\n        existingId: existingProduct?.id,\n        existingName: existingProduct ? (existingProduct.name.ms || existingProduct.name.en) : null,\n        existingPrice: existingProduct?.price,\n        existingQty: existingProduct ? extractQuantity(existingProduct.name.ms || existingProduct.name.en) : null,\n        needsUpdate: existingProduct && (\n          Math.abs(existingProduct.price - newPrice) > 0.01 ||\n          (existingProduct.name.ms !== newName && existingProduct.name.en !== newName)\n        ),\n        isWrongQuantity: existingProduct && extractQuantity(existingProduct.name.ms || existingProduct.name.en) !== newQty\n      });\n    }\n    \n    res.json({ \n      success: true,\n      baseProduct: {\n        id: baseProduct.id,\n        name: baseProduct.name.ms || baseProduct.name.en,\n        quantity: baseQty,\n        price: basePrice\n      },\n      baseName: baseName,\n      pricePerUnit: parseFloat(pricePerUnit.toFixed(4)),\n      suggestions: suggestions\n    });\n  } catch (error) {\n    console.error('Fix product advanced error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/products/apply-fix-product', authMiddleware, async (req, res) => {\n  try {\n    const { updates } = req.body;\n    \n    if (!updates || !Array.isArray(updates)) {\n      return res.status(400).json({ success: false, message: 'Updates array diperlukan' });\n    }\n    \n    const products = await db.getProducts();\n    let updatedCount = 0;\n    const results = [];\n    \n    for (const update of updates) {\n      const productIndex = products.findIndex(p => p.id === update.productId);\n      \n      if (productIndex !== -1) {\n        const oldName = products[productIndex].name.ms || products[productIndex].name.en;\n        const oldPrice = products[productIndex].price;\n        \n        if (update.newName) {\n          products[productIndex].name = {\n            ms: update.newName,\n            en: update.newName\n          };\n        }\n        \n        if (update.newPrice !== undefined) {\n          products[productIndex].price = update.newPrice;\n        }\n        \n        updatedCount++;\n        results.push({\n          productId: update.productId,\n          oldName: oldName,\n          newName: update.newName || oldName,\n          oldPrice: oldPrice,\n          newPrice: update.newPrice !== undefined ? update.newPrice : oldPrice\n        });\n      }\n    }\n    \n    if (updatedCount > 0) {\n      await db.saveProducts(products);\n    }\n    \n    res.json({ \n      success: true, \n      message: `${updatedCount} produk telah dikemaskini`,\n      results: results\n    });\n  } catch (error) {\n    console.error('Apply fix product error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/products/fix-pricing', authMiddleware, async (req, res) => {\n  try {\n    const { categoryId, baseProductId, applyChanges } = req.body;\n    \n    if (!categoryId) {\n      return res.status(400).json({ success: false, message: 'Category ID diperlukan' });\n    }\n    \n    const products = await db.getProducts();\n    const categories = await db.getCategories();\n    const category = categories.find(c => c.id === categoryId);\n    \n    if (!category) {\n      return res.status(404).json({ success: false, message: 'Kategori tidak dijumpai' });\n    }\n    \n    const categoryProducts = products.filter(p => p.categoryId === categoryId);\n    \n    if (categoryProducts.length === 0) {\n      return res.status(404).json({ success: false, message: 'Tiada produk dalam kategori ini' });\n    }\n    \n    function extractQuantity(name) {\n      const match = name.match(/(\\d+)/);\n      return match ? parseInt(match[1]) : null;\n    }\n    \n    categoryProducts.sort((a, b) => {\n      const qtyA = extractQuantity(a.name.ms || a.name.en);\n      const qtyB = extractQuantity(b.name.ms || b.name.en);\n      return qtyA - qtyB;\n    });\n    \n    // Use specified base product or default to first product\n    let baseProduct;\n    if (baseProductId) {\n      baseProduct = categoryProducts.find(p => p.id === baseProductId);\n      if (!baseProduct) {\n        return res.status(404).json({ success: false, message: 'Base product tidak dijumpai' });\n      }\n    } else {\n      baseProduct = categoryProducts[0];\n    }\n    \n    const baseQty = extractQuantity(baseProduct.name.ms || baseProduct.name.en);\n    const basePrice = baseProduct.price;\n    const pricePerUnit = basePrice / baseQty;\n    \n    const allProducts = [];\n    const updates = [];\n    \n    for (let i = 0; i < categoryProducts.length; i++) {\n      const product = categoryProducts[i];\n      const qty = extractQuantity(product.name.ms || product.name.en);\n      const expectedPrice = parseFloat((qty * pricePerUnit).toFixed(2));\n      \n      const productInfo = {\n        productId: product.id,\n        productName: product.name.ms || product.name.en,\n        quantity: qty,\n        currentPrice: product.price,\n        expectedPrice: expectedPrice,\n        isCorrect: Math.abs(product.price - expectedPrice) <= 0.01\n      };\n      \n      allProducts.push(productInfo);\n      \n      if (!productInfo.isCorrect) {\n        updates.push({\n          productId: product.id,\n          productName: product.name.ms || product.name.en,\n          quantity: qty,\n          oldPrice: product.price,\n          newPrice: expectedPrice\n        });\n      }\n    }\n    \n    // Apply changes if requested\n    if (applyChanges && updates.length > 0) {\n      updates.forEach(update => {\n        const productIndex = products.findIndex(p => p.id === update.productId);\n        if (productIndex !== -1) {\n          products[productIndex].price = update.newPrice;\n        }\n      });\n      await db.saveProducts(products);\n    }\n    \n    res.json({ \n      success: true, \n      message: applyChanges ? `${updates.length} harga telah dikemaskini` : 'Preview generated',\n      baseProduct: {\n        id: baseProduct.id,\n        name: baseProduct.name.ms || baseProduct.name.en,\n        price: basePrice,\n        quantity: baseQty\n      },\n      pricePerUnit: parseFloat(pricePerUnit.toFixed(4)),\n      allProducts: allProducts,\n      updates: updates,\n      totalProducts: categoryProducts.length,\n      applied: applyChanges || false\n    });\n  } catch (error) {\n    console.error('Fix pricing error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/vouchers', authMiddleware, async (req, res) => {\n  try {\n    const vouchers = await db.read('vouchers.json') || [];\n    res.json({ success: true, vouchers });\n  } catch (error) {\n    console.error('Get vouchers error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/vouchers', authMiddleware, async (req, res) => {\n  try {\n    const { code, type, value, maxUses } = req.body;\n    const vouchers = await db.read('vouchers.json') || [];\n    \n    const existingVoucher = vouchers.find(v => v.code.toUpperCase() === code.toUpperCase());\n    if (existingVoucher) {\n      return res.status(400).json({ success: false, message: 'Kod voucher sudah wujud' });\n    }\n    \n    const newVoucher = {\n      id: 'VCH-' + Date.now().toString(36).toUpperCase(),\n      code: code.toUpperCase(),\n      type: type || 'percentage',\n      value: parseFloat(value),\n      maxUses: parseInt(maxUses) || 0,\n      usedCount: 0,\n      active: true,\n      createdAt: new Date().toISOString()\n    };\n    \n    vouchers.push(newVoucher);\n    await db.write('vouchers.json', vouchers);\n    \n    res.json({ success: true, message: 'Voucher berjaya dibuat', voucher: newVoucher });\n  } catch (error) {\n    console.error('Create voucher error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.put('/api/vouchers/:voucherId', authMiddleware, async (req, res) => {\n  try {\n    const { voucherId } = req.params;\n    const { active } = req.body;\n    const vouchers = await db.read('vouchers.json') || [];\n    \n    const voucherIndex = vouchers.findIndex(v => v.id === voucherId);\n    if (voucherIndex === -1) {\n      return res.status(404).json({ success: false, message: 'Voucher tidak dijumpai' });\n    }\n    \n    vouchers[voucherIndex].active = active;\n    vouchers[voucherIndex].updatedAt = new Date().toISOString();\n    \n    await db.write('vouchers.json', vouchers);\n    res.json({ success: true, message: 'Status voucher dikemaskini' });\n  } catch (error) {\n    console.error('Update voucher error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.delete('/api/vouchers/:voucherId', authMiddleware, async (req, res) => {\n  try {\n    const { voucherId } = req.params;\n    const vouchers = await db.read('vouchers.json') || [];\n    const filtered = vouchers.filter(v => v.id !== voucherId);\n    \n    await db.write('vouchers.json', filtered);\n    res.json({ success: true, message: 'Voucher berjaya dipadam' });\n  } catch (error) {\n    console.error('Delete voucher error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/feedbacks', authMiddleware, async (req, res) => {\n  try {\n    const feedbacks = await db.read('feedbacks.json') || [];\n    res.json({ success: true, feedbacks });\n  } catch (error) {\n    console.error('Get feedbacks error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/templates', authMiddleware, async (req, res) => {\n  try {\n    const templates = await db.read('templates.json') || [];\n    res.json({ success: true, templates });\n  } catch (error) {\n    console.error('Get templates error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/templates', authMiddleware, async (req, res) => {\n  try {\n    const { name, message } = req.body;\n    const templates = await db.read('templates.json') || [];\n    \n    const newTemplate = {\n      id: 'TPL-' + Date.now().toString(36).toUpperCase(),\n      name,\n      message: { ms: message, en: message },\n      createdAt: new Date().toISOString()\n    };\n    \n    templates.push(newTemplate);\n    await db.write('templates.json', templates);\n    \n    res.json({ success: true, message: 'Template berjaya dibuat', template: newTemplate });\n  } catch (error) {\n    console.error('Create template error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.delete('/api/templates/:templateId', authMiddleware, async (req, res) => {\n  try {\n    const { templateId } = req.params;\n    const templates = await db.read('templates.json') || [];\n    const filtered = templates.filter(t => t.id !== templateId);\n    \n    await db.write('templates.json', filtered);\n    res.json({ success: true, message: 'Template berjaya dipadam' });\n  } catch (error) {\n    console.error('Delete template error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/faqs', authMiddleware, async (req, res) => {\n  try {\n    const faqs = await db.read('faqs.json') || [];\n    res.json({ success: true, faqs });\n  } catch (error) {\n    console.error('Get FAQs error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/faqs', authMiddleware, async (req, res) => {\n  try {\n    const { question, answer } = req.body;\n    const faqs = await db.read('faqs.json') || [];\n    \n    const newFAQ = {\n      id: 'FAQ-' + Date.now().toString(36).toUpperCase(),\n      question,\n      answer,\n      createdAt: new Date().toISOString()\n    };\n    \n    faqs.push(newFAQ);\n    await db.write('faqs.json', faqs);\n    \n    res.json({ success: true, message: 'FAQ berjaya dibuat', faq: newFAQ });\n  } catch (error) {\n    console.error('Create FAQ error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.delete('/api/faqs/:faqId', authMiddleware, async (req, res) => {\n  try {\n    const { faqId } = req.params;\n    const faqs = await db.read('faqs.json') || [];\n    const filtered = faqs.filter(f => f.id !== faqId);\n    \n    await db.write('faqs.json', filtered);\n    res.json({ success: true, message: 'FAQ berjaya dipadam' });\n  } catch (error) {\n    console.error('Delete FAQ error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/discount-codes', authMiddleware, async (req, res) => {\n  try {\n    const discounts = await db.read('discount_codes.json') || [];\n    res.json({ success: true, discounts });\n  } catch (error) {\n    console.error('Get discounts error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/discount-codes', authMiddleware, async (req, res) => {\n  try {\n    const { code, percentage, maxUses, expires } = req.body;\n    const discounts = await db.read('discount_codes.json') || [];\n    \n    const newDiscount = {\n      code: code.toUpperCase(),\n      percentage: parseFloat(percentage),\n      maxUses: parseInt(maxUses),\n      used: 0,\n      expires: expires || null,\n      created: new Date().toISOString()\n    };\n    \n    discounts.push(newDiscount);\n    await db.write('discount_codes.json', discounts);\n    \n    res.json({ success: true, message: 'Kod diskaun berjaya dibuat', discount: newDiscount });\n  } catch (error) {\n    console.error('Create discount error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/users/:userId/tag', authMiddleware, async (req, res) => {\n  try {\n    const { userId } = req.params;\n    const { tag } = req.body;\n    const users = await db.getUsers();\n    const userIndex = users.findIndex(u => u.id === parseInt(userId));\n    \n    if (userIndex === -1) {\n      return res.status(404).json({ success: false, message: 'Pengguna tidak dijumpai' });\n    }\n    \n    users[userIndex].tags = users[userIndex].tags || [];\n    if (!users[userIndex].tags.includes(tag)) {\n      users[userIndex].tags.push(tag);\n    }\n    \n    await db.saveUsers(users);\n    res.json({ success: true, message: 'Tag berjaya ditambah' });\n  } catch (error) {\n    console.error('Tag user error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/users/:userId/ban', authMiddleware, async (req, res) => {\n  try {\n    const { userId } = req.params;\n    const users = await db.getUsers();\n    const userIndex = users.findIndex(u => u.id === parseInt(userId));\n    \n    if (userIndex === -1) {\n      return res.status(404).json({ success: false, message: 'Pengguna tidak dijumpai' });\n    }\n    \n    users[userIndex].banned = true;\n    users[userIndex].bannedAt = new Date().toISOString();\n    \n    await db.saveUsers(users);\n    res.json({ success: true, message: 'Pengguna berjaya diharamkan' });\n  } catch (error) {\n    console.error('Ban user error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/users/:userId/unban', authMiddleware, async (req, res) => {\n  try {\n    const { userId } = req.params;\n    const users = await db.getUsers();\n    const userIndex = users.findIndex(u => u.id === parseInt(userId));\n    \n    if (userIndex === -1) {\n      return res.status(404).json({ success: false, message: 'Pengguna tidak dijumpai' });\n    }\n    \n    users[userIndex].banned = false;\n    \n    await db.saveUsers(users);\n    res.json({ success: true, message: 'Pengguna berjaya diaktifkan semula' });\n  } catch (error) {\n    console.error('Unban user error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.delete('/api/users/:userId', authMiddleware, async (req, res) => {\n  try {\n    const { userId } = req.params;\n    const users = await db.getUsers();\n    const filteredUsers = users.filter(u => u.id !== parseInt(userId));\n    \n    if (users.length === filteredUsers.length) {\n      return res.status(404).json({ success: false, message: 'Pengguna tidak dijumpai' });\n    }\n    \n    await db.saveUsers(filteredUsers);\n    res.json({ success: true, message: 'Pengguna berjaya dipadam' });\n  } catch (error) {\n    console.error('Delete user error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/sessions', authMiddleware, async (req, res) => {\n  try {\n    const sessions = await db.read('sessions.json') || [];\n    res.json({ success: true, sessions });\n  } catch (error) {\n    console.error('Get sessions error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/sessions/:token/messages', authMiddleware, async (req, res) => {\n  try {\n    const { token } = req.params;\n    const sessions = await db.getSessions();\n    const session = sessions.find(s => s.token === token);\n    \n    if (!session) {\n      return res.status(404).json({ success: false, message: 'Session tidak dijumpai' });\n    }\n    \n    const users = await db.getUsers();\n    const user = users.find(u => u.id === session.userId);\n    \n    res.json({ \n      success: true, \n      session: {\n        ...session,\n        userName: user?.firstName || 'Unknown User',\n        userUsername: user?.username || 'unknown'\n      },\n      messages: session.messages || []\n    });\n  } catch (error) {\n    console.error('Get session messages error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/sessions/:token/reply', authMiddleware, async (req, res) => {\n  try {\n    const { token } = req.params;\n    const { message, type, latitude, longitude } = req.body;\n    \n    if (!message && !latitude) {\n      return res.status(400).json({ success: false, message: 'Mesej atau lokasi diperlukan' });\n    }\n    \n    const sessions = await db.getSessions();\n    const session = sessions.find(s => s.token === token);\n    \n    if (!session) {\n      return res.status(404).json({ success: false, message: 'Session tidak dijumpai' });\n    }\n    \n    if (session.status !== 'active') {\n      return res.status(400).json({ success: false, message: 'Session tidak aktif' });\n    }\n    \n    const messageData = {\n      from: 'admin',\n      type: type || 'text',\n      timestamp: new Date().toISOString()\n    };\n    \n    if (type === 'location') {\n      messageData.location = { latitude, longitude };\n    } else {\n      messageData.text = message;\n    }\n    \n    session.messages = session.messages || [];\n    session.messages.push(messageData);\n    session.lastActiveAt = new Date().toISOString();\n    \n    if (!session.adminId) {\n      session.adminId = parseInt(req.user.id);\n    }\n    \n    await db.saveSessions(sessions);\n    \n    try {\n      if (type === 'location') {\n        await bot.telegram.sendLocation(session.userId, latitude, longitude);\n        await bot.telegram.sendMessage(session.userId, 'üë®‚Äçüíº Admin shared a location');\n      } else {\n        await bot.telegram.sendMessage(session.userId, `üë®‚Äçüíº Admin: ${message}`);\n      }\n      res.json({ success: true, message: 'Mesej berjaya dihantar' });\n    } catch (telegramError) {\n      console.error('Failed to send message to Telegram:', telegramError);\n      res.status(500).json({ success: false, message: 'Ralat menghantar ke Telegram' });\n    }\n  } catch (error) {\n    console.error('Reply to session error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/sessions/:token/upload', authMiddleware, upload.single('file'), async (req, res) => {\n  try {\n    const { token } = req.params;\n    const { mediaType, caption } = req.body;\n    \n    if (!req.file) {\n      return res.status(400).json({ success: false, message: 'Fail diperlukan' });\n    }\n    \n    const sessions = await db.getSessions();\n    const session = sessions.find(s => s.token === token);\n    \n    if (!session) {\n      return res.status(404).json({ success: false, message: 'Session tidak dijumpai' });\n    }\n    \n    if (session.status !== 'active') {\n      return res.status(400).json({ success: false, message: 'Session tidak aktif' });\n    }\n    \n    const filePath = req.file.path;\n    const fileName = req.file.originalname;\n    const mimeType = req.file.mimetype;\n    \n    const messageData = {\n      from: 'admin',\n      type: mediaType || 'document',\n      timestamp: new Date().toISOString(),\n      fileName: fileName,\n      filePath: filePath,\n      mimeType: mimeType,\n      caption: caption || ''\n    };\n    \n    session.messages = session.messages || [];\n    session.messages.push(messageData);\n    session.lastActiveAt = new Date().toISOString();\n    \n    if (!session.adminId) {\n      session.adminId = parseInt(req.user.id);\n    }\n    \n    await db.saveSessions(sessions);\n    \n    try {\n      const fileBuffer = await fs.readFile(filePath);\n      const captionText = `üë®‚Äçüíº Admin sent a ${mediaType || 'file'}${caption ? ':\\n' + caption : ''}`;\n      \n      if (mediaType === 'photo') {\n        await bot.telegram.sendPhoto(\n          session.userId,\n          { source: fileBuffer },\n          { caption: captionText }\n        );\n      } else if (mediaType === 'audio') {\n        await bot.telegram.sendAudio(\n          session.userId,\n          { source: fileBuffer },\n          { caption: captionText, filename: fileName }\n        );\n      } else if (mediaType === 'voice') {\n        await bot.telegram.sendVoice(\n          session.userId,\n          { source: fileBuffer },\n          { caption: captionText }\n        );\n      } else if (mediaType === 'video') {\n        await bot.telegram.sendVideo(\n          session.userId,\n          { source: fileBuffer },\n          { caption: captionText }\n        );\n      } else {\n        await bot.telegram.sendDocument(\n          session.userId,\n          { source: fileBuffer, filename: fileName },\n          { caption: captionText }\n        );\n      }\n      \n      res.json({ success: true, message: 'Fail berjaya dihantar' });\n    } catch (telegramError) {\n      console.error('Failed to send file to Telegram:', telegramError);\n      res.status(500).json({ success: false, message: 'Ralat menghantar fail ke Telegram' });\n    }\n  } catch (error) {\n    console.error('Upload to session error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/sessions/:token/close', authMiddleware, async (req, res) => {\n  try {\n    const { token } = req.params;\n    const sessions = await db.getSessions();\n    const session = sessions.find(s => s.token === token);\n    \n    if (!session) {\n      return res.status(404).json({ success: false, message: 'Session tidak dijumpai' });\n    }\n    \n    session.status = 'ended';\n    session.endedAt = new Date().toISOString();\n    \n    await db.saveSessions(sessions);\n    \n    try {\n      await bot.telegram.sendMessage(\n        session.userId,\n        '‚úÖ Session support telah ditutup oleh admin. Terima kasih!'\n      );\n    } catch (telegramError) {\n      console.error('Failed to notify user on Telegram:', telegramError);\n    }\n    \n    res.json({ success: true, message: 'Session berjaya ditutup' });\n  } catch (error) {\n    console.error('Close session error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/orders/:orderId/details', authMiddleware, async (req, res) => {\n  try {\n    const { orderId } = req.params;\n    const transactions = await db.getTransactions();\n    const order = transactions.find(t => t.id === orderId);\n    \n    if (!order) {\n      return res.status(404).json({ success: false, message: 'Order tidak dijumpai' });\n    }\n    \n    const users = await db.getUsers();\n    const user = users.find(u => u.id === order.userId);\n    \n    res.json({ \n      success: true, \n      order: {\n        ...order,\n        userName: user?.firstName || 'Unknown',\n        userUsername: user?.username || 'unknown',\n        userTelegramId: order.userId\n      }\n    });\n  } catch (error) {\n    console.error('Get order details error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.post('/api/orders/:orderId/complete', authMiddleware, async (req, res) => {\n  try {\n    const { orderId } = req.params;\n    const transactions = await db.getTransactions();\n    const orderIndex = transactions.findIndex(t => t.id === orderId);\n    \n    if (orderIndex === -1) {\n      return res.status(404).json({ success: false, message: 'Order tidak dijumpai' });\n    }\n    \n    const order = transactions[orderIndex];\n    \n    if (order.status === 'completed') {\n      return res.status(400).json({ success: false, message: 'Order sudah selesai' });\n    }\n    \n    transactions[orderIndex].status = 'completed';\n    transactions[orderIndex].completedAt = new Date().toISOString();\n    \n    await db.saveTransactions(transactions);\n    \n    try {\n      const user = await db.getUser(order.userId);\n      const lang = user?.language || 'ms';\n      \n      await bot.telegram.sendMessage(\n        order.userId,\n        lang === 'ms' \n          ? `‚úÖ Pesanan ${orderId} anda telah selesai! Terima kasih.`\n          : `‚úÖ Your order ${orderId} has been completed! Thank you.`\n      );\n    } catch (telegramError) {\n      console.error('Failed to notify user on Telegram:', telegramError);\n    }\n    \n    res.json({ success: true, message: 'Order berjaya diselesaikan' });\n  } catch (error) {\n    console.error('Complete order error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\napp.get('/api/stats/advanced', authMiddleware, async (req, res) => {\n  try {\n    const users = await db.getUsers();\n    const products = await db.getProducts();\n    const transactions = await db.getTransactions();\n    const categories = await db.getCategories();\n    \n    const activeProducts = products.filter(p => p.active).length;\n    const inactiveProducts = products.filter(p => !p.active).length;\n    const lowStockProducts = products.filter(p => p.stock < 5 && p.active).length;\n    \n    const thisMonth = new Date();\n    thisMonth.setDate(1);\n    thisMonth.setHours(0, 0, 0, 0);\n    const monthlyOrders = transactions.filter(t => new Date(t.createdAt) >= thisMonth).length;\n    const monthlyRevenue = transactions\n      .filter(t => t.status === 'completed' && new Date(t.createdAt) >= thisMonth)\n      .reduce((sum, t) => sum + (t.totalPrice || 0), 0);\n    \n    const topProducts = {};\n    transactions.forEach(t => {\n      if (t.items) {\n        t.items.forEach(item => {\n          topProducts[item.id] = (topProducts[item.id] || 0) + item.quantity;\n        });\n      }\n    });\n    \n    res.json({\n      success: true,\n      stats: {\n        totalUsers: users.length,\n        totalProducts: products.length,\n        activeProducts,\n        inactiveProducts,\n        lowStockProducts,\n        totalCategories: categories.length,\n        totalOrders: transactions.length,\n        monthlyOrders,\n        monthlyRevenue,\n        topProducts\n      }\n    });\n  } catch (error) {\n    console.error('Advanced stats error:', error);\n    res.status(500).json({ success: false, message: 'Server error' });\n  }\n});\n\nconst server = app.listen(PORT, '0.0.0.0', () => {\n  console.log(`üåê Web server running on http://0.0.0.0:${PORT}`);\n  console.log(`üìç Ping endpoint: http://0.0.0.0:${PORT}/ping`);\n  console.log(`üíö Health endpoint: http://0.0.0.0:${PORT}/health`);\n  console.log(`üé® Admin Panel: http://0.0.0.0:${PORT}`);\n});\n\nmodule.exports = server;\n","size_bytes":56242},"handlers/voucher.js":{"content":"const db = require('../utils/database');\nconst { generateId } = require('../utils/helpers');\nconst { t } = require('../utils/translations');\n\nasync function handleCreateVoucher(ctx) {\n  const { isAdmin } = require('./admin');\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized / Tidak dibenarkan');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const input = ctx.message.text.replace('/createvoucher', '').trim();\n  \n  if (!input) {\n    const message = lang === 'ms'\n      ? `üé´ *Buat Baucher Baru*\n\nFormat:\n\\`/createvoucher [kod] | [diskaun%] | [max guna] | [tamat (opsional)]\\`\n\nContoh:\n\\`/createvoucher JIMAT50 | 50 | 100\\`\n\\`/createvoucher RAYA2025 | 30 | 50 | 2025-12-31\\`\n\nüìù Penjelasan:\n‚Ä¢ Kod: Kod baucher (contoh: JIMAT50)\n‚Ä¢ Diskaun%: Peratus diskaun (1-99)\n‚Ä¢ Max Guna: Bilangan maksimum penggunaan\n‚Ä¢ Tamat: Tarikh tamat (opsional, format: YYYY-MM-DD)`\n      : `üé´ *Create New Voucher*\n\nFormat:\n\\`/createvoucher [code] | [discount%] | [max uses] | [expiry (optional)]\\`\n\nExample:\n\\`/createvoucher SAVE50 | 50 | 100\\`\n\\`/createvoucher RAYA2025 | 30 | 50 | 2025-12-31\\`\n\nüìù Explanation:\n‚Ä¢ Code: Voucher code (example: SAVE50)\n‚Ä¢ Discount%: Discount percentage (1-99)\n‚Ä¢ Max Uses: Maximum number of uses\n‚Ä¢ Expiry: Expiry date (optional, format: YYYY-MM-DD)`;\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    return;\n  }\n  \n  const parts = input.split('|').map(p => p.trim());\n  \n  if (parts.length < 3) {\n    const message = lang === 'ms'\n      ? '‚ùå Format tidak sah. Sila berikan semua maklumat yang diperlukan.'\n      : '‚ùå Invalid format. Please provide all required information.';\n    await ctx.reply(message);\n    return;\n  }\n  \n  const code = parts[0].toUpperCase();\n  const discount = parseInt(parts[1]);\n  const maxUses = parseInt(parts[2]);\n  const expiryDate = parts[3] || null;\n  \n  if (!code || code.length < 3) {\n    const message = lang === 'ms'\n      ? '‚ùå Kod baucher mesti sekurang-kurangnya 3 aksara.'\n      : '‚ùå Voucher code must be at least 3 characters.';\n    await ctx.reply(message);\n    return;\n  }\n  \n  if (isNaN(discount) || discount < 1 || discount > 99) {\n    const message = lang === 'ms'\n      ? '‚ùå Diskaun mesti antara 1% hingga 99%.'\n      : '‚ùå Discount must be between 1% and 99%.';\n    await ctx.reply(message);\n    return;\n  }\n  \n  if (isNaN(maxUses) || maxUses < 1) {\n    const message = lang === 'ms'\n      ? '‚ùå Bilangan maksimum penggunaan mesti sekurang-kurangnya 1.'\n      : '‚ùå Maximum uses must be at least 1.';\n    await ctx.reply(message);\n    return;\n  }\n  \n  const vouchers = await db.getVouchers();\n  \n  const existing = vouchers.find(v => v.code.toUpperCase() === code);\n  if (existing) {\n    const message = lang === 'ms'\n      ? '‚ùå Kod baucher ini sudah wujud. Sila gunakan kod yang berbeza.'\n      : '‚ùå This voucher code already exists. Please use a different code.';\n    await ctx.reply(message);\n    return;\n  }\n  \n  const newVoucher = {\n    id: generateId('VOUCH'),\n    code: code,\n    value: discount,\n    type: 'percentage',\n    maxUses: maxUses,\n    usedCount: 0,\n    usedBy: [],\n    expiryDate: expiryDate,\n    createdBy: userId,\n    createdAt: new Date().toISOString(),\n    active: true\n  };\n  \n  vouchers.push(newVoucher);\n  await db.saveVouchers(vouchers);\n  \n  const expiryText = expiryDate \n    ? (lang === 'ms' ? `\\nüìÖ Tamat: ${expiryDate}` : `\\nüìÖ Expires: ${expiryDate}`)\n    : '';\n  \n  const message = lang === 'ms'\n    ? `‚úÖ *Baucher Berjaya Dibuat!*\n\nüé´ Kod: \\`${code}\\`\nüí∞ Diskaun: ${discount}%\nüìä Max Guna: ${maxUses}\nüî¢ Digunakan: 0${expiryText}\n\nCustomer boleh guna kod ini dengan command:\n\\`/redeem ${code}\\``\n    : `‚úÖ *Voucher Created Successfully!*\n\nüé´ Code: \\`${code}\\`\nüí∞ Discount: ${discount}%\nüìä Max Uses: ${maxUses}\nüî¢ Used: 0${expiryText}\n\nCustomers can use this code with command:\n\\`/redeem ${code}\\``;\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function handleRedeemVoucher(ctx) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const code = ctx.message.text.replace('/redeem', '').trim().toUpperCase();\n  \n  if (!code) {\n    const message = lang === 'ms'\n      ? `üé´ *Cara Guna Baucher*\n\nFormat:\n\\`/redeem [KOD_BAUCHER]\\`\n\nContoh:\n\\`/redeem JIMAT50\\`\n\nüìù Panduan:\n1Ô∏è‚É£ Dapatkan kod baucher dari admin/promosi\n2Ô∏è‚É£ Taip \\`/redeem\\` diikuti kod baucher\n3Ô∏è‚É£ Baucher akan disimpan untuk digunakan pada order seterusnya\n4Ô∏è‚É£ Diskaun akan ditolak automatik semasa checkout\n\nüí° Nota: Kod baucher tidak case-sensitive (huruf besar/kecil sama sahaja)`\n      : `üé´ *How to Use Voucher*\n\nFormat:\n\\`/redeem [VOUCHER_CODE]\\`\n\nExample:\n\\`/redeem SAVE50\\`\n\nüìù Guide:\n1Ô∏è‚É£ Get voucher code from admin/promotion\n2Ô∏è‚É£ Type \\`/redeem\\` followed by voucher code\n3Ô∏è‚É£ Voucher will be saved for your next order\n4Ô∏è‚É£ Discount will be applied automatically at checkout\n\nüí° Note: Voucher codes are not case-sensitive`;\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    return;\n  }\n  \n  const voucher = await db.getVoucher(code);\n  \n  if (!voucher) {\n    const message = lang === 'ms'\n      ? `‚ùå Kod baucher tidak sah atau tidak wujud.\n\nSila pastikan:\n‚Ä¢ Kod baucher betul\n‚Ä¢ Kod baucher masih aktif\n‚Ä¢ Tiada typo dalam kod\n\nSila dapatkan kod baucher yang sah dari admin.`\n      : `‚ùå Invalid or non-existent voucher code.\n\nPlease ensure:\n‚Ä¢ Voucher code is correct\n‚Ä¢ Voucher code is still active\n‚Ä¢ No typos in the code\n\nPlease get a valid voucher code from admin.`;\n    \n    await ctx.reply(message);\n    return;\n  }\n  \n  if (!voucher.active) {\n    const message = lang === 'ms'\n      ? '‚ùå Baucher ini tidak aktif lagi. Sila hubungi admin untuk maklumat lanjut.'\n      : '‚ùå This voucher is no longer active. Please contact admin for more information.';\n    await ctx.reply(message);\n    return;\n  }\n  \n  if (voucher.expiryDate) {\n    const expiryDate = new Date(voucher.expiryDate);\n    const now = new Date();\n    if (now > expiryDate) {\n      const message = lang === 'ms'\n        ? `‚ùå Baucher ini telah tamat tempoh pada ${voucher.expiryDate}.`\n        : `‚ùå This voucher expired on ${voucher.expiryDate}.`;\n      await ctx.reply(message);\n      return;\n    }\n  }\n  \n  if (voucher.usedCount >= voucher.maxUses) {\n    const message = lang === 'ms'\n      ? '‚ùå Baucher ini telah mencapai had maksimum penggunaan.'\n      : '‚ùå This voucher has reached its maximum usage limit.';\n    await ctx.reply(message);\n    return;\n  }\n  \n  if (voucher.usedBy && voucher.usedBy.includes(userId)) {\n    const message = lang === 'ms'\n      ? '‚ùå Anda telah menggunakan baucher ini sebelum ini. Setiap user hanya boleh guna sekali sahaja.'\n      : '‚ùå You have already used this voucher. Each user can only use it once.';\n    await ctx.reply(message);\n    return;\n  }\n  \n  await db.updateUser(userId, { activeVoucher: code });\n  \n  const message = lang === 'ms'\n    ? `‚úÖ *Baucher Berjaya Ditebus!*\n\nüé´ Kod: \\`${code}\\`\nüí∞ Diskaun: ${voucher.value}%\n\nBaucher ini akan digunakan pada order seterusnya anda. Diskaun akan ditolak automatik semasa checkout.\n\nüõí Tekan butang \"Beli Produk\" untuk mula shopping!`\n    : `‚úÖ *Voucher Redeemed Successfully!*\n\nüé´ Code: \\`${code}\\`\nüí∞ Discount: ${voucher.value}%\n\nThis voucher will be used on your next order. Discount will be applied automatically at checkout.\n\nüõí Click \"Buy Products\" button to start shopping!`;\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function handleListVouchers(ctx) {\n  const { isAdmin } = require('./admin');\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized / Tidak dibenarkan');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const vouchers = await db.getVouchers();\n  \n  if (vouchers.length === 0) {\n    const message = lang === 'ms'\n      ? 'üìã Tiada baucher dijumpai. Gunakan /createvoucher untuk buat baucher baru.'\n      : 'üìã No vouchers found. Use /createvoucher to create a new voucher.';\n    await ctx.reply(message);\n    return;\n  }\n  \n  let message = lang === 'ms'\n    ? 'üé´ *SENARAI BAUCHER*\\n\\n'\n    : 'üé´ *VOUCHER LIST*\\n\\n';\n  \n  vouchers.forEach((v, index) => {\n    const status = v.active ? '‚úÖ' : '‚ùå';\n    const expiryText = v.expiryDate ? ` | ${lang === 'ms' ? 'Tamat' : 'Expires'}: ${v.expiryDate}` : '';\n    \n    message += `${index + 1}. ${status} \\`${v.code}\\`\\n`;\n    message += `   üí∞ ${v.value}% | üìä ${v.usedCount}/${v.maxUses}${expiryText}\\n\\n`;\n  });\n  \n  message += lang === 'ms'\n    ? '\\nüí° Gunakan /togglevoucher [kod] untuk aktif/nyahaktif baucher'\n    : '\\nüí° Use /togglevoucher [code] to activate/deactivate voucher';\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function handleToggleVoucher(ctx) {\n  const { isAdmin } = require('./admin');\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized / Tidak dibenarkan');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const code = ctx.message.text.replace('/togglevoucher', '').trim().toUpperCase();\n  \n  if (!code) {\n    const message = lang === 'ms'\n      ? 'Format: /togglevoucher [kod]\\n\\nContoh: /togglevoucher JIMAT50'\n      : 'Format: /togglevoucher [code]\\n\\nExample: /togglevoucher SAVE50';\n    await ctx.reply(message);\n    return;\n  }\n  \n  const vouchers = await db.getVouchers();\n  const voucher = vouchers.find(v => v.code.toUpperCase() === code);\n  \n  if (!voucher) {\n    const message = lang === 'ms'\n      ? '‚ùå Baucher tidak dijumpai.'\n      : '‚ùå Voucher not found.';\n    await ctx.reply(message);\n    return;\n  }\n  \n  voucher.active = !voucher.active;\n  await db.saveVouchers(vouchers);\n  \n  const status = voucher.active\n    ? (lang === 'ms' ? 'AKTIF' : 'ACTIVE')\n    : (lang === 'ms' ? 'TIDAK AKTIF' : 'INACTIVE');\n  \n  const message = lang === 'ms'\n    ? `‚úÖ Baucher \\`${code}\\` kini ${status}`\n    : `‚úÖ Voucher \\`${code}\\` is now ${status}`;\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function handleCheckVoucher(ctx) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  if (!user.activeVoucher) {\n    const message = lang === 'ms'\n      ? `‚ùå Anda tiada baucher aktif sekarang.\n\nGunakan \\`/redeem [KOD]\\` untuk tebus baucher.\n\nContoh: \\`/redeem JIMAT50\\``\n      : `‚ùå You don't have an active voucher.\n\nUse \\`/redeem [CODE]\\` to redeem a voucher.\n\nExample: \\`/redeem SAVE50\\``;\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    return;\n  }\n  \n  const voucher = await db.getVoucher(user.activeVoucher);\n  \n  if (!voucher || !voucher.active) {\n    await db.updateUser(userId, { activeVoucher: null });\n    const message = lang === 'ms'\n      ? '‚ùå Baucher anda tidak sah lagi. Sila tebus baucher baru.'\n      : '‚ùå Your voucher is no longer valid. Please redeem a new voucher.';\n    await ctx.reply(message);\n    return;\n  }\n  \n  const expiryText = voucher.expiryDate\n    ? (lang === 'ms' ? `\\nüìÖ Tamat: ${voucher.expiryDate}` : `\\nüìÖ Expires: ${voucher.expiryDate}`)\n    : '';\n  \n  const message = lang === 'ms'\n    ? `‚úÖ *Baucher Aktif Anda*\n\nüé´ Kod: \\`${voucher.code}\\`\nüí∞ Diskaun: ${voucher.value}%${expiryText}\n\nBaucher ini akan digunakan pada order seterusnya anda.`\n    : `‚úÖ *Your Active Voucher*\n\nüé´ Code: \\`${voucher.code}\\`\nüí∞ Discount: ${voucher.value}%${expiryText}\n\nThis voucher will be used on your next order.`;\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function applyVoucherToOrder(userId, totalAmount) {\n  const user = await db.getUser(userId);\n  \n  if (!user || !user.activeVoucher) {\n    return { finalAmount: totalAmount, discount: 0, voucherCode: null };\n  }\n  \n  const voucher = await db.getVoucher(user.activeVoucher);\n  \n  if (!voucher || !voucher.active) {\n    await db.updateUser(userId, { activeVoucher: null });\n    return { finalAmount: totalAmount, discount: 0, voucherCode: null };\n  }\n  \n  if (voucher.expiryDate) {\n    const expiryDate = new Date(voucher.expiryDate);\n    const now = new Date();\n    if (now > expiryDate) {\n      await db.updateUser(userId, { activeVoucher: null });\n      return { finalAmount: totalAmount, discount: 0, voucherCode: null };\n    }\n  }\n  \n  if (voucher.usedCount >= voucher.maxUses) {\n    await db.updateUser(userId, { activeVoucher: null });\n    return { finalAmount: totalAmount, discount: 0, voucherCode: null };\n  }\n  \n  if (voucher.usedBy && voucher.usedBy.includes(userId)) {\n    await db.updateUser(userId, { activeVoucher: null });\n    return { finalAmount: totalAmount, discount: 0, voucherCode: null };\n  }\n  \n  const discountAmount = (totalAmount * voucher.value) / 100;\n  const finalAmount = totalAmount - discountAmount;\n  \n  const vouchers = await db.getVouchers();\n  const voucherIndex = vouchers.findIndex(v => v.code.toUpperCase() === voucher.code.toUpperCase());\n  \n  if (voucherIndex !== -1) {\n    vouchers[voucherIndex].usedCount += 1;\n    if (!vouchers[voucherIndex].usedBy) {\n      vouchers[voucherIndex].usedBy = [];\n    }\n    vouchers[voucherIndex].usedBy.push(userId);\n    await db.saveVouchers(vouchers);\n  }\n  \n  await db.updateUser(userId, { activeVoucher: null });\n  \n  return {\n    finalAmount: finalAmount,\n    discount: discountAmount,\n    voucherCode: voucher.code,\n    discountPercentage: voucher.value\n  };\n}\n\nmodule.exports = {\n  handleCreateVoucher,\n  handleRedeemVoucher,\n  handleListVouchers,\n  handleToggleVoucher,\n  handleCheckVoucher,\n  applyVoucherToOrder\n};\n","size_bytes":13801},"handlers/orderTracking.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { formatDate } = require('../utils/helpers');\nconst { safeEditMessage } = require('../utils/messageHelper');\n\nasync function handleOrderTracking(ctx, orderId) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const order = transactions.find(t => t.id === orderId);\n  \n  if (!order) {\n    const msg = lang === 'ms' ? '‚ùå Pesanan tidak dijumpai!' : '‚ùå Order not found!';\n    await ctx.reply(msg);\n    return;\n  }\n  \n  if (order.userId !== userId) {\n    const { isAdmin } = require('./admin');\n    const { isOwner } = require('./owner');\n    if (!await isAdmin(userId) && !await isOwner(userId)) {\n      const msg = lang === 'ms' ? 'üö´ Anda tidak boleh lihat pesanan ini!' : 'üö´ You cannot view this order!';\n      await ctx.reply(msg);\n      return;\n    }\n  }\n  \n  const statusEmoji = {\n    'pending': '‚è≥',\n    'verified': '‚úÖ',\n    'completed': 'üéâ',\n    'rejected': '‚ùå'\n  };\n  \n  const timeline = order.timeline || [];\n  \n  let message = lang === 'ms' \n    ? `üìä *TRACKING PESANAN*\\n\\nüÜî *Order ID:* \\`${order.id}\\`\\nüì¶ *Produk:* ${order.productName.ms || order.productName}\\nüí∞ *Jumlah:* RM${order.price}\\n${statusEmoji[order.status] || 'üìå'} *Status:* ${getStatusText(order.status, lang)}\\n\\n`\n    : `üìä *ORDER TRACKING*\\n\\nüÜî *Order ID:* \\`${order.id}\\`\\nüì¶ *Product:* ${order.productName.en || order.productName}\\nüí∞ *Amount:* RM${order.price}\\n${statusEmoji[order.status] || 'üìå'} *Status:* ${getStatusText(order.status, lang)}\\n\\n`;\n  \n  message += lang === 'ms' ? 'üìÖ *TIMELINE:*\\n\\n' : 'üìÖ *TIMELINE:*\\n\\n';\n  \n  if (timeline.length > 0) {\n    timeline.forEach((event, index) => {\n      const date = formatDate(event.timestamp);\n      message += `${index + 1}. ${statusEmoji[event.status] || 'üìå'} ${event.message[lang] || event.message}\\n   _${date}_\\n\\n`;\n    });\n  } else {\n    const created = formatDate(order.createdAt);\n    message += `1. ‚è≥ ${lang === 'ms' ? 'Pesanan dibuat' : 'Order created'}\\n   _${created}_\\n\\n`;\n    \n    if (order.status === 'verified' || order.status === 'completed') {\n      message += `2. ‚úÖ ${lang === 'ms' ? 'Pembayaran disahkan' : 'Payment verified'}\\n   _${formatDate(order.verifiedAt || order.createdAt)}_\\n\\n`;\n    }\n    \n    if (order.status === 'completed') {\n      message += `3. üéâ ${lang === 'ms' ? 'Item dihantar' : 'Item delivered'}\\n   _${formatDate(order.completedAt || order.createdAt)}_\\n\\n`;\n    }\n    \n    if (order.status === 'rejected') {\n      message += `2. ‚ùå ${lang === 'ms' ? 'Pembayaran ditolak' : 'Payment rejected'}\\n   _${formatDate(order.rejectedAt || order.createdAt)}_\\n`;\n      if (order.rejectReason) {\n        message += `   üìù ${lang === 'ms' ? 'Sebab' : 'Reason'}: ${order.rejectReason}\\n\\n`;\n      }\n    }\n  }\n  \n  if (order.deliveryNotes) {\n    message += lang === 'ms' ? `\\nüìù *Nota Penghantaran:*\\n${order.deliveryNotes}\\n` : `\\nüìù *Delivery Notes:*\\n${order.deliveryNotes}\\n`;\n  }\n  \n  const buttons = [];\n  \n  if (order.status === 'pending' && order.userId === userId) {\n    buttons.push([Markup.button.callback(\n      lang === 'ms' ? 'üö´ Batalkan Pesanan' : 'üö´ Cancel Order',\n      `cancel_order_${orderId}`\n    )]);\n  }\n  \n  buttons.push([Markup.button.callback(\n    lang === 'ms' ? 'üîô Kembali' : 'üîô Back',\n    'my_orders'\n  )]);\n  \n  await safeEditMessage(ctx, message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nfunction getStatusText(status, lang) {\n  const statusTexts = {\n    pending: { ms: 'Menunggu Pengesahan', en: 'Awaiting Verification' },\n    verified: { ms: 'Pembayaran Disahkan', en: 'Payment Verified' },\n    completed: { ms: 'Selesai', en: 'Completed' },\n    rejected: { ms: 'Ditolak', en: 'Rejected' }\n  };\n  \n  return statusTexts[status]?.[lang] || status;\n}\n\nasync function handleCancelOrder(ctx, orderId) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const order = transactions.find(t => t.id === orderId);\n  \n  if (!order || order.userId !== userId) {\n    const msg = lang === 'ms' ? '‚ùå Pesanan tidak dijumpai!' : '‚ùå Order not found!';\n    await ctx.answerCbQuery(msg);\n    return;\n  }\n  \n  if (order.status !== 'pending') {\n    const msg = lang === 'ms' ? '‚ùå Hanya pesanan pending boleh dibatalkan!' : '‚ùå Only pending orders can be cancelled!';\n    await ctx.answerCbQuery(msg);\n    return;\n  }\n  \n  order.status = 'cancelled';\n  order.cancelledAt = new Date().toISOString();\n  order.timeline = order.timeline || [];\n  order.timeline.push({\n    status: 'cancelled',\n    timestamp: new Date().toISOString(),\n    message: {\n      ms: 'Pesanan dibatalkan oleh pelanggan',\n      en: 'Order cancelled by customer'\n    }\n  });\n  \n  await db.saveTransactions(transactions);\n  \n  if (order.productId) {\n    const products = await db.getProducts();\n    const product = products.find(p => p.id === order.productId);\n    if (product) {\n      product.stock = (product.stock || 0) + 1;\n      await db.saveProducts(products);\n    }\n  }\n  \n  const msg = lang === 'ms' ? '‚úÖ Pesanan telah dibatalkan. Stok dikembalikan.' : '‚úÖ Order cancelled. Stock restored.';\n  await ctx.answerCbQuery(msg);\n  \n  await ctx.reply(\n    lang === 'ms' \n      ? `‚úÖ *Pesanan Dibatalkan*\\n\\nüÜî Order ID: \\`${orderId}\\`\\n\\nStok produk telah dikembalikan.`\n      : `‚úÖ *Order Cancelled*\\n\\nüÜî Order ID: \\`${orderId}\\`\\n\\nProduct stock has been restored.`,\n    { parse_mode: 'Markdown' }\n  );\n  \n  const admins = await db.getAdmins();\n  for (const adminId of admins) {\n    try {\n      await ctx.telegram.sendMessage(\n        adminId,\n        lang === 'ms'\n          ? `üö´ *Pesanan Dibatalkan*\\n\\nüÜî Order: \\`${orderId}\\`\\nüë§ User: ${userId}\\nüì¶ Produk: ${order.productName.ms || order.productName}\\nüí∞ RM${order.price}\\n\\n_Dibatalkan oleh pelanggan_`\n          : `üö´ *Order Cancelled*\\n\\nüÜî Order: \\`${orderId}\\`\\nüë§ User: ${userId}\\nüì¶ Product: ${order.productName.en || order.productName}\\nüí∞ RM${order.price}\\n\\n_Cancelled by customer_`,\n        { parse_mode: 'Markdown' }\n      );\n    } catch (err) {\n      console.log(`Failed to notify admin ${adminId}:`, err.message);\n    }\n  }\n}\n\nmodule.exports = {\n  handleOrderTracking,\n  handleCancelOrder,\n  getStatusText\n};\n","size_bytes":6498},"handlers/quickActions.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { formatDate } = require('../utils/helpers');\n\nasync function handleQuickActions(ctx) {\n  const { isAdmin } = require('./admin');\n  const { isOwner } = require('./owner');\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId) && !await isOwner(userId)) {\n    await ctx.answerCbQuery('üö´ Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const pending = transactions.filter(t => t.status === 'pending');\n  const verified = transactions.filter(t => t.status === 'verified');\n  \n  const products = await db.getProducts();\n  const lowStock = products.filter(p => p.stock > 0 && p.stock < 5).length;\n  const outOfStock = products.filter(p => p.stock <= 0).length;\n  \n  let message = lang === 'ms' ? '‚ö° *TINDAKAN PANTAS*\\n\\n' : '‚ö° *QUICK ACTIONS*\\n\\n';\n  \n  message += lang === 'ms'\n    ? `‚è≥ Pesanan Pending: ${pending.length}\\n‚úÖ Perlu Dihantar: ${verified.length}\\n‚ö†Ô∏è Stok Rendah: ${lowStock}\\n‚ùå Habis Stok: ${outOfStock}\\n\\n`\n    : `‚è≥ Pending Orders: ${pending.length}\\n‚úÖ To Deliver: ${verified.length}\\n‚ö†Ô∏è Low Stock: ${lowStock}\\n‚ùå Out of Stock: ${outOfStock}\\n\\n`;\n  \n  const buttons = [\n    [\n      Markup.button.callback(\n        lang === 'ms' ? `‚è≥ Pending (${pending.length})` : `‚è≥ Pending (${pending.length})`,\n        'quick_pending'\n      ),\n      Markup.button.callback(\n        lang === 'ms' ? `‚úÖ Verified (${verified.length})` : `‚úÖ Verified (${verified.length})`,\n        'quick_verified'\n      )\n    ],\n    [\n      Markup.button.callback(\n        lang === 'ms' ? `‚ö†Ô∏è Stok Rendah (${lowStock})` : `‚ö†Ô∏è Low Stock (${lowStock})`,\n        'quick_lowstock'\n      ),\n      Markup.button.callback(\n        lang === 'ms' ? `‚ùå Habis (${outOfStock})` : `‚ùå Out (${outOfStock})`,\n        'quick_outstock'\n      )\n    ],\n    [\n      Markup.button.callback(\n        lang === 'ms' ? 'üìä Hari Ini' : 'üìä Today',\n        'quick_today'\n      ),\n      Markup.button.callback(\n        lang === 'ms' ? 'üìà Minggu Ini' : 'üìà This Week',\n        'quick_week'\n      )\n    ],\n    [\n      Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_panel')\n    ]\n  ];\n  \n  await ctx.editMessageText(message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleQuickPending(ctx) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const pending = transactions.filter(t => t.status === 'pending');\n  \n  if (pending.length === 0) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Tiada pesanan pending!' : 'No pending orders!');\n    return;\n  }\n  \n  let message = lang === 'ms' \n    ? `‚è≥ *PESANAN PENDING (${pending.length})*\\n\\n`\n    : `‚è≥ *PENDING ORDERS (${pending.length})*\\n\\n`;\n  \n  const buttons = [];\n  \n  pending.slice(0, 5).forEach(order => {\n    message += `üÜî ${order.id}\\n`;\n    message += `üì¶ ${order.productName?.ms || order.productName}\\n`;\n    message += `üí∞ RM${order.price}\\n`;\n    message += `üë§ User: ${order.userId}\\n`;\n    message += `üìÖ ${formatDate(order.createdAt)}\\n\\n`;\n    \n    buttons.push([\n      Markup.button.callback(`‚úÖ Sahkan ${order.id}`, `verify_order_${order.id}`),\n      Markup.button.callback(`‚ùå Tolak`, `reject_order_${order.id}`)\n    ]);\n  });\n  \n  buttons.push([\n    Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'quick_actions')\n  ]);\n  \n  await ctx.editMessageText(message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleQuickVerified(ctx) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const verified = transactions.filter(t => t.status === 'verified');\n  \n  if (verified.length === 0) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Tiada pesanan verified!' : 'No verified orders!');\n    return;\n  }\n  \n  let message = lang === 'ms'\n    ? `‚úÖ *PESANAN VERIFIED (${verified.length})*\\n\\nPesanan ini menunggu penghantaran item.\\n\\n`\n    : `‚úÖ *VERIFIED ORDERS (${verified.length})*\\n\\nThese orders are awaiting item delivery.\\n\\n`;\n  \n  verified.slice(0, 5).forEach(order => {\n    message += `üÜî ${order.id}\\n`;\n    message += `üì¶ ${order.productName?.ms || order.productName}\\n`;\n    message += `üí∞ RM${order.price}\\n`;\n    message += `üë§ User: ${order.userId}\\n\\n`;\n  });\n  \n  message += lang === 'ms'\n    ? '\\nüí° _Gunakan panel Admin Orders untuk hantar item_'\n    : '\\nüí° _Use Admin Orders panel to deliver items_';\n  \n  await ctx.editMessageText(message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[\n      Markup.button.callback(lang === 'ms' ? 'üì¶ Lihat Semua' : 'üì¶ View All', 'admin_orders'),\n      Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'quick_actions')\n    ]])\n  });\n}\n\nasync function handleTodaySummary(ctx) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n  \n  const transactions = await db.getTransactions();\n  const todayOrders = transactions.filter(t => {\n    const orderDate = new Date(t.createdAt);\n    return orderDate >= today;\n  });\n  \n  const completed = todayOrders.filter(t => t.status === 'completed');\n  const pending = todayOrders.filter(t => t.status === 'pending');\n  const verified = todayOrders.filter(t => t.status === 'verified');\n  const rejected = todayOrders.filter(t => t.status === 'rejected');\n  \n  const revenue = completed.reduce((sum, t) => sum + (t.price || 0), 0);\n  \n  let message = lang === 'ms' ? 'üìä *RINGKASAN HARI INI*\\n\\n' : 'üìä *TODAY\\'S SUMMARY*\\n\\n';\n  message += `üìÖ ${formatDate(new Date())}\\n\\n`;\n  \n  message += lang === 'ms' ? 'üí∞ *JUALAN:*\\n' : 'üí∞ *SALES:*\\n';\n  message += `RM${revenue.toFixed(2)}\\n\\n`;\n  \n  message += lang === 'ms' ? 'üì¶ *PESANAN:*\\n' : 'üì¶ *ORDERS:*\\n';\n  message += `${lang === 'ms' ? 'Jumlah' : 'Total'}: ${todayOrders.length}\\n`;\n  message += `‚úÖ ${lang === 'ms' ? 'Selesai' : 'Completed'}: ${completed.length}\\n`;\n  message += `‚è≥ Pending: ${pending.length}\\n`;\n  message += `‚úîÔ∏è Verified: ${verified.length}\\n`;\n  message += `‚ùå ${lang === 'ms' ? 'Ditolak' : 'Rejected'}: ${rejected.length}\\n`;\n  \n  await ctx.editMessageText(message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[\n      Markup.button.callback(lang === 'ms' ? 'üîÑ Refresh' : 'üîÑ Refresh', 'quick_today'),\n      Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'quick_actions')\n    ]])\n  });\n}\n\nasync function handleWeekSummary(ctx) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const weekAgo = new Date();\n  weekAgo.setDate(weekAgo.getDate() - 7);\n  weekAgo.setHours(0, 0, 0, 0);\n  \n  const transactions = await db.getTransactions();\n  const weekOrders = transactions.filter(t => {\n    const orderDate = new Date(t.createdAt);\n    return orderDate >= weekAgo;\n  });\n  \n  const completed = weekOrders.filter(t => t.status === 'completed');\n  const revenue = completed.reduce((sum, t) => sum + (t.price || 0), 0);\n  const avgPerDay = revenue / 7;\n  \n  let message = lang === 'ms' ? 'üìà *RINGKASAN 7 HARI*\\n\\n' : 'üìà *7-DAY SUMMARY*\\n\\n';\n  \n  message += lang === 'ms' ? 'üí∞ *JUALAN:*\\n' : 'üí∞ *SALES:*\\n';\n  message += `${lang === 'ms' ? 'Jumlah' : 'Total'}: RM${revenue.toFixed(2)}\\n`;\n  message += `${lang === 'ms' ? 'Purata/hari' : 'Avg/day'}: RM${avgPerDay.toFixed(2)}\\n\\n`;\n  \n  message += lang === 'ms' ? 'üì¶ *PESANAN:*\\n' : 'üì¶ *ORDERS:*\\n';\n  message += `${lang === 'ms' ? 'Jumlah' : 'Total'}: ${weekOrders.length}\\n`;\n  message += `‚úÖ ${lang === 'ms' ? 'Selesai' : 'Completed'}: ${completed.length}\\n`;\n  message += `${lang === 'ms' ? 'Kadar kejayaan' : 'Success rate'}: ${weekOrders.length > 0 ? ((completed.length / weekOrders.length) * 100).toFixed(1) : 0}%\\n`;\n  \n  await ctx.editMessageText(message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[\n      Markup.button.callback(lang === 'ms' ? 'üîÑ Refresh' : 'üîÑ Refresh', 'quick_week'),\n      Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'quick_actions')\n    ]])\n  });\n}\n\nasync function addDeliveryNote(orderId, note) {\n  const transactions = await db.getTransactions();\n  const order = transactions.find(t => t.id === orderId);\n  \n  if (!order) {\n    return false;\n  }\n  \n  order.deliveryNotes = note;\n  order.timeline = order.timeline || [];\n  order.timeline.push({\n    status: 'note_added',\n    timestamp: new Date().toISOString(),\n    message: {\n      ms: `Nota ditambah: ${note}`,\n      en: `Note added: ${note}`\n    }\n  });\n  \n  await db.saveTransactions(transactions);\n  return true;\n}\n\nasync function addCustomerNote(customerId, note, adminId) {\n  const users = await db.getUsers();\n  const user = users.find(u => u.id === customerId);\n  \n  if (!user) {\n    return false;\n  }\n  \n  user.adminNotes = user.adminNotes || [];\n  user.adminNotes.push({\n    note,\n    addedBy: adminId,\n    timestamp: new Date().toISOString()\n  });\n  \n  await db.saveUsers(users);\n  return true;\n}\n\nasync function getCustomerNotes(customerId) {\n  const user = await db.getUser(customerId);\n  return user?.adminNotes || [];\n}\n\nmodule.exports = {\n  handleQuickActions,\n  handleQuickPending,\n  handleQuickVerified,\n  handleTodaySummary,\n  handleWeekSummary,\n  addDeliveryNote,\n  addCustomerNote,\n  getCustomerNotes\n};\n","size_bytes":9667},"handlers/advancedFeatures.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { formatDate } = require('../utils/helpers');\nconst { safeEditMessage } = require('../utils/messageHelper');\n\nasync function handleAdvancedProductSearch(ctx) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'ms'\n    ? `üîç *CARIAN PRODUK LANJUTAN*\\n\\nGunakan arahan berikut:\\n\\n\\`/searchproduct [nama]\\` - Cari mengikut nama\\n\\`/searchprice [min] [max]\\` - Cari mengikut julat harga\\n\\`/searchstock low\\` - Produk stok rendah (<5)\\n\\`/searchstock out\\` - Produk habis stok\\n\\nContoh:\\n\\`/searchproduct Netflix\\`\\n\\`/searchprice 10 50\\`\\n\\`/searchstock low\\``\n    : `üîç *ADVANCED PRODUCT SEARCH*\\n\\nUse the following commands:\\n\\n\\`/searchproduct [name]\\` - Search by name\\n\\`/searchprice [min] [max]\\` - Search by price range\\n\\`/searchstock low\\` - Low stock products (<5)\\n\\`/searchstock out\\` - Out of stock products\\n\\nExamples:\\n\\`/searchproduct Netflix\\`\\n\\`/searchprice 10 50\\`\\n\\`/searchstock low\\``;\n  \n  await safeEditMessage(ctx, message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[\n      Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_panel')\n    ]])\n  });\n}\n\nasync function searchProductByName(ctx, query) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const results = products.filter(p => \n    (p.name.ms && p.name.ms.toLowerCase().includes(query.toLowerCase())) ||\n    (p.name.en && p.name.en.toLowerCase().includes(query.toLowerCase()))\n  );\n  \n  if (results.length === 0) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Tiada produk dijumpai!' : '‚ùå No products found!');\n    return;\n  }\n  \n  let message = lang === 'ms' \n    ? `üîç *Keputusan Carian: \"${query}\"*\\n\\nJumpaan ${results.length} produk:\\n\\n`\n    : `üîç *Search Results: \"${query}\"*\\n\\nFound ${results.length} products:\\n\\n`;\n  \n  results.slice(0, 10).forEach(p => {\n    const stockStatus = p.stock > 0 ? `‚úÖ ${p.stock}` : '‚ùå Habis';\n    message += `üì¶ ${p.name[lang] || p.name.ms}\\n`;\n    message += `üí∞ RM${p.price}\\n`;\n    message += `üìä Stok: ${stockStatus}\\n`;\n    message += `üÜî ID: \\`${p.id}\\`\\n\\n`;\n  });\n  \n  if (results.length > 10) {\n    message += lang === 'ms' \n      ? `\\n_Menunjukkan 10 daripada ${results.length} produk_`\n      : `\\n_Showing 10 of ${results.length} products_`;\n  }\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function searchProductByPrice(ctx, min, max) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const results = products.filter(p => p.price >= min && p.price <= max);\n  \n  if (results.length === 0) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Tiada produk dijumpai!' : '‚ùå No products found!');\n    return;\n  }\n  \n  let message = lang === 'ms'\n    ? `üí∞ *Produk RM${min} - RM${max}*\\n\\nJumpaan ${results.length} produk:\\n\\n`\n    : `üí∞ *Products RM${min} - RM${max}*\\n\\nFound ${results.length} products:\\n\\n`;\n  \n  results.slice(0, 10).forEach(p => {\n    const stockStatus = p.stock > 0 ? `‚úÖ ${p.stock}` : '‚ùå Habis';\n    message += `üì¶ ${p.name[lang] || p.name.ms}\\n`;\n    message += `üí∞ RM${p.price}\\n`;\n    message += `üìä Stok: ${stockStatus}\\n\\n`;\n  });\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function searchProductByStock(ctx, type) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  let results;\n  let title;\n  \n  if (type === 'low') {\n    results = products.filter(p => p.stock > 0 && p.stock < 5);\n    title = lang === 'ms' ? '‚ö†Ô∏è *Produk Stok Rendah*' : '‚ö†Ô∏è *Low Stock Products*';\n  } else if (type === 'out') {\n    results = products.filter(p => p.stock <= 0);\n    title = lang === 'ms' ? '‚ùå *Produk Habis Stok*' : '‚ùå *Out of Stock Products*';\n  }\n  \n  if (results.length === 0) {\n    await ctx.reply(lang === 'ms' ? '‚úÖ Tiada produk dijumpai!' : '‚úÖ No products found!');\n    return;\n  }\n  \n  let message = `${title}\\n\\nJumpaan ${results.length} produk:\\n\\n`;\n  \n  results.forEach(p => {\n    message += `üì¶ ${p.name[lang] || p.name.ms}\\n`;\n    message += `üí∞ RM${p.price}\\n`;\n    message += `üìä Stok: ${p.stock}\\n`;\n    message += `üÜî ID: \\`${p.id}\\`\\n\\n`;\n  });\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function handleSalesReport(ctx, startDate, endDate) {\n  const { isAdmin } = require('./admin');\n  const { isOwner } = require('./owner');\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId) && !await isOwner(userId)) {\n    await ctx.reply('üö´ Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  let filtered = transactions;\n  \n  if (startDate && endDate) {\n    filtered = transactions.filter(t => {\n      const orderDate = new Date(t.createdAt);\n      return orderDate >= new Date(startDate) && orderDate <= new Date(endDate);\n    });\n  }\n  \n  const completed = filtered.filter(t => t.status === 'completed');\n  const verified = filtered.filter(t => t.status === 'verified');\n  const pending = filtered.filter(t => t.status === 'pending');\n  const rejected = filtered.filter(t => t.status === 'rejected');\n  \n  const totalRevenue = completed.reduce((sum, t) => sum + (t.price || 0), 0);\n  const potentialRevenue = verified.reduce((sum, t) => sum + (t.price || 0), 0);\n  \n  let message = lang === 'ms' ? 'üìä *LAPORAN JUALAN*\\n\\n' : 'üìä *SALES REPORT*\\n\\n';\n  \n  if (startDate && endDate) {\n    message += lang === 'ms'\n      ? `üìÖ Tempoh: ${formatDate(startDate)} - ${formatDate(endDate)}\\n\\n`\n      : `üìÖ Period: ${formatDate(startDate)} - ${formatDate(endDate)}\\n\\n`;\n  } else {\n    message += lang === 'ms' ? 'üìÖ Tempoh: Semua masa\\n\\n' : 'üìÖ Period: All time\\n\\n';\n  }\n  \n  message += lang === 'ms'\n    ? `üí∞ *Jumlah Jualan:* RM${totalRevenue.toFixed(2)}\\n`\n    : `üí∞ *Total Revenue:* RM${totalRevenue.toFixed(2)}\\n`;\n  \n  message += lang === 'ms'\n    ? `‚è≥ *Potensi (Verified):* RM${potentialRevenue.toFixed(2)}\\n\\n`\n    : `‚è≥ *Potential (Verified):* RM${potentialRevenue.toFixed(2)}\\n\\n`;\n  \n  message += lang === 'ms' ? 'üìà *STATUS PESANAN:*\\n' : 'üìà *ORDER STATUS:*\\n';\n  message += `‚úÖ ${lang === 'ms' ? 'Selesai' : 'Completed'}: ${completed.length}\\n`;\n  message += `‚è≥ ${lang === 'ms' ? 'Menunggu' : 'Pending'}: ${pending.length}\\n`;\n  message += `‚úîÔ∏è ${lang === 'ms' ? 'Disahkan' : 'Verified'}: ${verified.length}\\n`;\n  message += `‚ùå ${lang === 'ms' ? 'Ditolak' : 'Rejected'}: ${rejected.length}\\n\\n`;\n  \n  const productSales = {};\n  completed.forEach(t => {\n    const pName = t.productName?.ms || t.productName || 'Unknown';\n    productSales[pName] = (productSales[pName] || 0) + 1;\n  });\n  \n  const topProducts = Object.entries(productSales)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 5);\n  \n  if (topProducts.length > 0) {\n    message += lang === 'ms' ? '\\nüèÜ *TOP 5 PRODUK:*\\n' : '\\nüèÜ *TOP 5 PRODUCTS:*\\n';\n    topProducts.forEach(([name, count], index) => {\n      message += `${index + 1}. ${name} (${count} ${lang === 'ms' ? 'jualan' : 'sales'})\\n`;\n    });\n  }\n  \n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[\n      Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_panel')\n    ]])\n  });\n}\n\nasync function handleCustomerPurchaseHistory(ctx, customerId) {\n  const { isAdmin } = require('./admin');\n  const { isOwner } = require('./owner');\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId) && !await isOwner(userId)) {\n    await ctx.reply('üö´ Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const customerOrders = transactions.filter(t => t.userId == customerId);\n  \n  if (customerOrders.length === 0) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Tiada pesanan dijumpai!' : '‚ùå No orders found!');\n    return;\n  }\n  \n  const customer = await db.getUser(customerId);\n  const customerName = customer?.name || `User ${customerId}`;\n  \n  const totalSpent = customerOrders\n    .filter(t => t.status === 'completed')\n    .reduce((sum, t) => sum + (t.price || 0), 0);\n  \n  const completed = customerOrders.filter(t => t.status === 'completed').length;\n  const pending = customerOrders.filter(t => t.status === 'pending').length;\n  \n  let message = lang === 'ms' \n    ? `üë§ *SEJARAH PEMBELIAN*\\n\\nüë§ Pelanggan: ${customerName}\\nüÜî ID: \\`${customerId}\\`\\n\\nüí∞ *Jumlah Belanja:* RM${totalSpent.toFixed(2)}\\nüì¶ *Pesanan Selesai:* ${completed}\\n‚è≥ *Pending:* ${pending}\\n\\nüìã *PESANAN TERKINI:*\\n\\n`\n    : `üë§ *PURCHASE HISTORY*\\n\\nüë§ Customer: ${customerName}\\nüÜî ID: \\`${customerId}\\`\\n\\nüí∞ *Total Spent:* RM${totalSpent.toFixed(2)}\\nüì¶ *Completed Orders:* ${completed}\\n‚è≥ *Pending:* ${pending}\\n\\nüìã *RECENT ORDERS:*\\n\\n`;\n  \n  customerOrders.slice(-10).reverse().forEach(order => {\n    const statusEmoji = { pending: '‚è≥', verified: '‚úÖ', completed: 'üéâ', rejected: '‚ùå' };\n    message += `${statusEmoji[order.status] || 'üìå'} ${order.productName?.ms || order.productName}\\n`;\n    message += `   RM${order.price} ‚Ä¢ ${formatDate(order.createdAt)}\\n`;\n    message += `   ID: \\`${order.id}\\`\\n\\n`;\n  });\n  \n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[\n      Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_panel')\n    ]])\n  });\n}\n\nasync function handleBulkStockUpdate(ctx) {\n  const { isAdmin } = require('./admin');\n  const { isOwner } = require('./owner');\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId) && !await isOwner(userId)) {\n    await ctx.reply('üö´ Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'ms'\n    ? `üì¶ *KEMAS KINI STOK PUKAL*\\n\\nGunakan arahan:\\n\\`/bulkstock [product_id] [quantity]\\`\\n\\nContoh:\\n\\`/bulkstock PROD-123 +10\\` - Tambah 10\\n\\`/bulkstock PROD-123 -5\\` - Tolak 5\\n\\`/bulkstock PROD-123 20\\` - Set tepat 20\\n\\nUntuk kemas kini berbilang produk:\\n\\`/bulkstock PROD-123 +10, PROD-456 -5, PROD-789 15\\``\n    : `üì¶ *BULK STOCK UPDATE*\\n\\nUse command:\\n\\`/bulkstock [product_id] [quantity]\\`\\n\\nExamples:\\n\\`/bulkstock PROD-123 +10\\` - Add 10\\n\\`/bulkstock PROD-123 -5\\` - Subtract 5\\n\\`/bulkstock PROD-123 20\\` - Set exactly 20\\n\\nFor multiple products:\\n\\`/bulkstock PROD-123 +10, PROD-456 -5, PROD-789 15\\``;\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function processBulkStockUpdate(ctx, updates) {\n  const { isAdmin } = require('./admin');\n  const { isOwner } = require('./owner');\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId) && !await isOwner(userId)) {\n    await ctx.reply('üö´ Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const results = [];\n  \n  for (const update of updates) {\n    const [productId, quantityStr] = update.trim().split(' ');\n    const product = products.find(p => p.id === productId);\n    \n    if (!product) {\n      results.push({ productId, success: false, reason: 'Not found' });\n      continue;\n    }\n    \n    let newStock;\n    if (quantityStr.startsWith('+')) {\n      newStock = (product.stock || 0) + parseInt(quantityStr.substring(1));\n    } else if (quantityStr.startsWith('-')) {\n      newStock = (product.stock || 0) - parseInt(quantityStr.substring(1));\n    } else {\n      newStock = parseInt(quantityStr);\n    }\n    \n    if (newStock < 0) newStock = 0;\n    \n    product.stock = newStock;\n    results.push({ \n      productId, \n      productName: product.name.ms || product.name,\n      success: true, \n      newStock \n    });\n  }\n  \n  await db.saveProducts(products);\n  \n  let message = lang === 'ms' ? '‚úÖ *Kemas Kini Stok Selesai*\\n\\n' : '‚úÖ *Stock Update Complete*\\n\\n';\n  \n  results.forEach(r => {\n    if (r.success) {\n      message += `‚úÖ ${r.productName}: ${r.newStock} unit\\n`;\n    } else {\n      message += `‚ùå ${r.productId}: ${r.reason}\\n`;\n    }\n  });\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nmodule.exports = {\n  handleAdvancedProductSearch,\n  searchProductByName,\n  searchProductByPrice,\n  searchProductByStock,\n  handleSalesReport,\n  handleCustomerPurchaseHistory,\n  handleBulkStockUpdate,\n  processBulkStockUpdate\n};\n","size_bytes":12705},"handlers/productManagementImproved.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { generateId } = require('../utils/helpers');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { isOwnerOrAdmin } = require('./userManagement');\n\nconst productEditState = new Map();\n\nasync function handleProductManagementMenu(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const categories = await db.getCategories();\n  const lowStockProducts = products.filter(p => p.stock < 5 && p.active);\n  \n  const text = lang === 'ms'\n    ? `üì¶ *Pengurusan Produk*\\n\\n` +\n      `üìä Jumlah Produk: ${products.length}\\n` +\n      `üìÇ Kategori: ${categories.length}\\n` +\n      `‚ö†Ô∏è Stok Rendah: ${lowStockProducts.length}\\n\\n` +\n      `Pilih tindakan:`\n    : `üì¶ *Product Management*\\n\\n` +\n      `üìä Total Products: ${products.length}\\n` +\n      `üìÇ Categories: ${categories.length}\\n` +\n      `‚ö†Ô∏è Low Stock: ${lowStockProducts.length}\\n\\n` +\n      `Choose action:`;\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üìã Senarai Produk' : 'üìã List Products', 'prod_list_page_0')],\n    [\n      Markup.button.callback(lang === 'ms' ? 'üîç Cari' : 'üîç Search', 'product_search'),\n      Markup.button.callback(lang === 'ms' ? 'üîΩ Tapis' : 'üîΩ Filter', 'product_filter')\n    ],\n    [\n      Markup.button.callback(lang === 'ms' ? '‚ö° Edit Pantas' : '‚ö° Quick Edit', 'quick_edit_menu'),\n      Markup.button.callback(lang === 'ms' ? 'üîÑ Bulk Ops' : 'üîÑ Bulk Ops', 'bulk_operations')\n    ],\n    [\n      Markup.button.callback(lang === 'ms' ? 'üìÖ Produk Berjadual' : 'üìÖ Scheduled Products', 'scheduled_products'),\n      Markup.button.callback(lang === 'ms' ? 'üìä Statistik' : 'üìä Statistics', 'all_products_stats')\n    ],\n    [Markup.button.callback(lang === 'ms' ? 'üìÇ Urus Kategori' : 'üìÇ Manage Categories', 'cat_management')],\n    [Markup.button.callback(lang === 'ms' ? '‚ö†Ô∏è Produk Stok Rendah' : '‚ö†Ô∏è Low Stock Products', 'prod_low_stock')],\n    [Markup.button.callback(lang === 'ms' ? '‚ûï Tambah Produk' : '‚ûï Add Product', 'prod_add_new')],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Panel Admin' : 'üîô Admin Panel', 'admin_panel')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleProductList(ctx, page = 0) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const itemsPerPage = 8;\n  const startIndex = page * itemsPerPage;\n  const endIndex = startIndex + itemsPerPage;\n  const paginatedProducts = products.slice(startIndex, endIndex);\n  const totalPages = Math.ceil(products.length / itemsPerPage);\n  \n  const text = lang === 'ms'\n    ? `üìã *Senarai Produk*\\n\\nHalaman ${page + 1}/${totalPages} (${products.length} produk)\\n\\nKlik produk untuk edit/delete:`\n    : `üìã *Product List*\\n\\nPage ${page + 1}/${totalPages} (${products.length} products)\\n\\nClick product to edit/delete:`;\n  \n  const buttons = [];\n  \n  paginatedProducts.forEach(prod => {\n    const stockIcon = prod.stock < 5 ? '‚ö†Ô∏è' : (prod.active ? '‚úÖ' : '‚ùå');\n    const productLabel = `${stockIcon} ${prod.name.ms} - RM${prod.price} (${prod.stock})`;\n    buttons.push([Markup.button.callback(productLabel, `prod_detail_${prod.id}`)]);\n  });\n  \n  const navButtons = [];\n  if (page > 0) {\n    navButtons.push(Markup.button.callback('‚¨ÖÔ∏è Prev', `prod_list_page_${page - 1}`));\n  }\n  if (endIndex < products.length) {\n    navButtons.push(Markup.button.callback('Next ‚û°Ô∏è', `prod_list_page_${page + 1}`));\n  }\n  if (navButtons.length > 0) {\n    buttons.push(navButtons);\n  }\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_products_menu')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleProductDetail(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Produk tidak dijumpai' : 'Product not found');\n    return;\n  }\n  \n  const categories = await db.getCategories();\n  const category = categories.find(c => c.id === product.categoryId);\n  \n  const text = lang === 'ms'\n    ? `üì¶ *${product.name.ms}*\\n\\n` +\n      `üÜî ID: \\`${product.id}\\`\\n` +\n      `üìÇ Kategori: ${category?.name.ms || 'Unknown'}\\n` +\n      `üí∞ Harga: RM${product.price}\\n` +\n      `üìä Stok: ${product.stock}\\n` +\n      `üîÑ Jenis: ${product.deliveryType}\\n` +\n      `${product.active ? '‚úÖ' : '‚ùå'} Status: ${product.active ? 'Aktif' : 'Tidak Aktif'}\\n\\n` +\n      `üìù Penerangan:\\n${product.description.ms}\\n\\n` +\n      `Pilih tindakan:`\n    : `üì¶ *${product.name.en || product.name.ms}*\\n\\n` +\n      `üÜî ID: \\`${product.id}\\`\\n` +\n      `üìÇ Category: ${category?.name.en || category?.name.ms || 'Unknown'}\\n` +\n      `üí∞ Price: RM${product.price}\\n` +\n      `üìä Stock: ${product.stock}\\n` +\n      `üîÑ Type: ${product.deliveryType}\\n` +\n      `${product.active ? '‚úÖ' : '‚ùå'} Status: ${product.active ? 'Active' : 'Inactive'}\\n\\n` +\n      `üìù Description:\\n${product.description.en || product.description.ms}\\n\\n` +\n      `Choose action:`;\n  \n  const buttons = [\n    [\n      Markup.button.callback(lang === 'ms' ? '‚úèÔ∏è Edit Harga' : '‚úèÔ∏è Edit Price', `prod_edit_price_${productId}`),\n      Markup.button.callback(lang === 'ms' ? 'üìä Edit Stok' : 'üìä Edit Stock', `prod_edit_stock_${productId}`)\n    ],\n    [\n      Markup.button.callback(lang === 'ms' ? 'üìù Edit Nama' : 'üìù Edit Name', `prod_edit_name_${productId}`),\n      Markup.button.callback(lang === 'ms' ? 'üìÑ Edit Desc' : 'üìÑ Edit Desc', `prod_edit_desc_${productId}`)\n    ],\n    [\n      Markup.button.callback(lang === 'ms' ? 'üé® Pilihan Produk' : 'üé® Product Options', `prod_options_${productId}`),\n      Markup.button.callback(lang === 'ms' ? 'üñºÔ∏è Imej Produk' : 'üñºÔ∏è Product Images', `prod_images_${productId}`)\n    ],\n    [\n      Markup.button.callback(lang === 'ms' ? 'üìÖ Jadual Terbit' : 'üìÖ Schedule Publish', `schedule_prod_${productId}`),\n      Markup.button.callback(lang === 'ms' ? '‚≠ê Lihat Ulasan' : '‚≠ê View Reviews', `prod_reviews_${productId}`)\n    ],\n    [Markup.button.callback(\n      product.active \n        ? (lang === 'ms' ? 'üî¥ Nyahaktifkan' : 'üî¥ Deactivate')\n        : (lang === 'ms' ? 'üü¢ Aktifkan' : 'üü¢ Activate'),\n      `prod_toggle_${productId}`\n    )],\n    [Markup.button.callback(lang === 'ms' ? 'üóëÔ∏è Padam Produk' : 'üóëÔ∏è Delete Product', `prod_delete_confirm_${productId}`)],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'prod_list_page_0')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleToggleProduct(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product) {\n    await ctx.answerCbQuery('Product not found');\n    return;\n  }\n  \n  product.active = !product.active;\n  await db.saveProducts(products);\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  await ctx.answerCbQuery(\n    product.active \n      ? (lang === 'ms' ? '‚úÖ Produk diaktifkan' : '‚úÖ Product activated')\n      : (lang === 'ms' ? 'üî¥ Produk dinyahaktifkan' : 'üî¥ Product deactivated')\n  );\n  \n  await handleProductDetail(ctx, productId);\n}\n\nasync function handleDeleteProductConfirm(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Produk tidak dijumpai' : 'Product not found');\n    return;\n  }\n  \n  const text = lang === 'ms'\n    ? `‚ö†Ô∏è *Sahkan Padam Produk*\\n\\nüì¶ ${product.name.ms}\\nüí∞ RM${product.price}\\n\\nAdakah anda pasti mahu memadam produk ini?\\n\\n*Tindakan ini tidak boleh dibatalkan!*`\n    : `‚ö†Ô∏è *Confirm Delete Product*\\n\\nüì¶ ${product.name.en || product.name.ms}\\nüí∞ RM${product.price}\\n\\nAre you sure you want to delete this product?\\n\\n*This action cannot be undone!*`;\n  \n  const buttons = [\n    [\n      Markup.button.callback(lang === 'ms' ? '‚ùå Batal' : '‚ùå Cancel', `prod_detail_${productId}`),\n      Markup.button.callback(lang === 'ms' ? 'üóëÔ∏è Ya, Padam' : 'üóëÔ∏è Yes, Delete', `prod_delete_${productId}`)\n    ]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleDeleteProduct(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const productIndex = products.findIndex(p => p.id === productId);\n  \n  if (productIndex === -1) {\n    await ctx.answerCbQuery('Product not found');\n    return;\n  }\n  \n  const product = products[productIndex];\n  products.splice(productIndex, 1);\n  await db.saveProducts(products);\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'ms'\n    ? `‚úÖ *Produk berjaya dipadam!*\\n\\nüì¶ ${product.name.ms}\\nüí∞ RM${product.price}`\n    : `‚úÖ *Product deleted successfully!*\\n\\nüì¶ ${product.name.en || product.name.ms}\\nüí∞ RM${product.price}`;\n  \n  await ctx.answerCbQuery(lang === 'ms' ? '‚úÖ Produk dipadam' : '‚úÖ Product deleted');\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n  \n  await handleProductList(ctx, 0);\n}\n\nasync function handleEditProductField(ctx, productId, field) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  productEditState.set(adminId, { productId, field });\n  \n  let message = '';\n  \n  switch(field) {\n    case 'price':\n      message = lang === 'ms'\n        ? 'üí∞ *Edit Harga Produk*\\n\\nHantar harga baru (nombor sahaja).\\n\\nContoh: 15.00'\n        : 'üí∞ *Edit Product Price*\\n\\nSend the new price (numbers only).\\n\\nExample: 15.00';\n      break;\n    case 'stock':\n      message = lang === 'ms'\n        ? 'üìä *Edit Stok Produk*\\n\\nHantar jumlah stok baru.\\n\\nContoh: 50'\n        : 'üìä *Edit Product Stock*\\n\\nSend the new stock quantity.\\n\\nExample: 50';\n      break;\n    case 'name':\n      message = lang === 'ms'\n        ? 'üìù *Edit Nama Produk*\\n\\nHantar nama baru untuk produk.\\n\\nContoh: Netflix Premium 1 Bulan'\n        : 'üìù *Edit Product Name*\\n\\nSend the new product name.\\n\\nExample: Netflix Premium 1 Month';\n      break;\n    case 'description':\n      message = lang === 'ms'\n        ? 'üìÑ *Edit Penerangan Produk*\\n\\nHantar penerangan baru untuk produk.\\n\\nContoh: Akaun Netflix Premium dengan 4K streaming dan 4 peranti serentak'\n        : 'üìÑ *Edit Product Description*\\n\\nSend the new product description.\\n\\nExample: Netflix Premium account with 4K streaming and 4 simultaneous devices';\n      break;\n  }\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function processProductEdit(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!productEditState.has(adminId)) {\n    return false;\n  }\n  \n  const editData = productEditState.get(adminId);\n  const newValue = ctx.message.text.trim();\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === editData.productId);\n  \n  if (!product) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Produk tidak dijumpai' : '‚ùå Product not found');\n    productEditState.delete(adminId);\n    return true;\n  }\n  \n  switch(editData.field) {\n    case 'price':\n      const price = parseFloat(newValue);\n      if (isNaN(price) || price < 0) {\n        await ctx.reply(lang === 'ms' ? '‚ùå Harga tidak sah!' : '‚ùå Invalid price!');\n        productEditState.delete(adminId);\n        return true;\n      }\n      product.price = price;\n      await ctx.reply(\n        lang === 'ms' \n          ? `‚úÖ Harga dikemaskini ke RM${price}`\n          : `‚úÖ Price updated to RM${price}`\n      );\n      break;\n      \n    case 'stock':\n      const stock = parseInt(newValue);\n      if (isNaN(stock) || stock < 0) {\n        await ctx.reply(lang === 'ms' ? '‚ùå Stok tidak sah!' : '‚ùå Invalid stock!');\n        productEditState.delete(adminId);\n        return true;\n      }\n      product.stock = stock;\n      await ctx.reply(\n        lang === 'ms' \n          ? `‚úÖ Stok dikemaskini ke ${stock} unit`\n          : `‚úÖ Stock updated to ${stock} units`\n      );\n      break;\n      \n    case 'name':\n      product.name = { ms: newValue, en: newValue };\n      await ctx.reply(\n        lang === 'ms' \n          ? `‚úÖ Nama dikemaskini: ${newValue}`\n          : `‚úÖ Name updated: ${newValue}`\n      );\n      break;\n      \n    case 'description':\n      product.description = { ms: newValue, en: newValue };\n      await ctx.reply(\n        lang === 'ms' \n          ? '‚úÖ Penerangan dikemaskini'\n          : '‚úÖ Description updated'\n      );\n      break;\n  }\n  \n  await db.saveProducts(products);\n  productEditState.delete(adminId);\n  return true;\n}\n\nasync function handleLowStockProducts(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const lowStockProducts = products.filter(p => p.stock < 5 && p.active);\n  \n  if (lowStockProducts.length === 0) {\n    const text = lang === 'ms'\n      ? '‚úÖ *Tiada Produk Stok Rendah*\\n\\nSemua produk mempunyai stok yang mencukupi.'\n      : '‚úÖ *No Low Stock Products*\\n\\nAll products have sufficient stock.';\n    \n    await safeEditMessage(ctx, text, {\n      parse_mode: 'Markdown',\n      ...Markup.inlineKeyboard([\n        [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_products_menu')]\n      ])\n    });\n    return;\n  }\n  \n  let text = lang === 'ms'\n    ? `‚ö†Ô∏è *Produk Stok Rendah*\\n\\n${lowStockProducts.length} produk dengan stok kurang dari 5:\\n\\n`\n    : `‚ö†Ô∏è *Low Stock Products*\\n\\n${lowStockProducts.length} products with stock below 5:\\n\\n`;\n  \n  const buttons = [];\n  \n  lowStockProducts.forEach(prod => {\n    text += `üì¶ ${prod.name.ms}\\nüìä Stok: ${prod.stock}\\nüí∞ RM${prod.price}\\nüÜî ${prod.id}\\n\\n`;\n    buttons.push([Markup.button.callback(`üìä ${prod.name.ms} (${prod.stock})`, `prod_detail_${prod.id}`)]);\n  });\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_products_menu')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nmodule.exports = {\n  handleProductManagementMenu,\n  handleProductList,\n  handleProductDetail,\n  handleToggleProduct,\n  handleDeleteProductConfirm,\n  handleDeleteProduct,\n  handleEditProductField,\n  processProductEdit,\n  handleLowStockProducts,\n  productEditState\n};\n","size_bytes":16276},"handlers/enhancedOrders.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { formatDate } = require('../utils/helpers');\nconst PDFDocument = require('pdfkit');\nconst fs = require('fs-extra');\nconst path = require('path');\n\nasync function handleOrderInvoice(ctx, orderId) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const order = transactions.find(t => t.id === orderId);\n  \n  if (!order) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Pesanan tidak dijumpai!' : '‚ùå Order not found!');\n    return;\n  }\n  \n  if (order.userId !== userId) {\n    const { isAdmin } = require('./admin');\n    const { isOwner } = require('./owner');\n    if (!await isAdmin(userId) && !await isOwner(userId)) {\n      await ctx.reply(lang === 'ms' ? 'üö´ Tidak dibenarkan!' : 'üö´ Unauthorized!');\n      return;\n    }\n  }\n  \n  let invoice = lang === 'ms' ? 'üßæ *INVOIS PESANAN*\\n\\n' : 'üßæ *ORDER INVOICE*\\n\\n';\n  invoice += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\n  invoice += `üè™ *CexiStore Ultimate Pro*\\n`;\n  invoice += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\n  \n  invoice += lang === 'ms' ? 'üìã *MAKLUMAT PESANAN:*\\n' : 'üìã *ORDER DETAILS:*\\n';\n  invoice += `üÜî Invoice ID: \\`${orderId}\\`\\n`;\n  invoice += `üìÖ ${lang === 'ms' ? 'Tarikh' : 'Date'}: ${formatDate(order.createdAt)}\\n`;\n  invoice += `üë§ Customer ID: \\`${order.userId}\\`\\n\\n`;\n  \n  invoice += lang === 'ms' ? 'üì¶ *ITEM:*\\n' : 'üì¶ *ITEM:*\\n';\n  invoice += `${order.productName?.ms || order.productName}\\n`;\n  invoice += `${order.description?.ms || order.description || ''}\\n\\n`;\n  \n  invoice += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\n  invoice += lang === 'ms' ? 'üí∞ *RINGKASAN BAYARAN:*\\n' : 'üí∞ *PAYMENT SUMMARY:*\\n';\n  invoice += `${lang === 'ms' ? 'Harga Asal' : 'Original Price'}: RM${order.originalPrice || order.price}\\n`;\n  \n  if (order.discount) {\n    invoice += `${lang === 'ms' ? 'Diskaun' : 'Discount'}: -RM${order.discount.toFixed(2)}\\n`;\n  }\n  \n  if (order.voucherCode) {\n    invoice += `${lang === 'ms' ? 'Baucher' : 'Voucher'}: ${order.voucherCode}\\n`;\n  }\n  \n  invoice += `\\n*${lang === 'ms' ? 'JUMLAH' : 'TOTAL'}: RM${order.price}*\\n`;\n  invoice += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\n  \n  const statusTexts = {\n    pending: { ms: '‚è≥ Menunggu Pengesahan', en: '‚è≥ Awaiting Verification' },\n    verified: { ms: '‚úÖ Pembayaran Disahkan', en: '‚úÖ Payment Verified' },\n    completed: { ms: 'üéâ Selesai', en: 'üéâ Completed' },\n    rejected: { ms: '‚ùå Ditolak', en: '‚ùå Rejected' },\n    cancelled: { ms: 'üö´ Dibatalkan', en: 'üö´ Cancelled' }\n  };\n  \n  invoice += `üìå *Status:* ${statusTexts[order.status]?.[lang] || order.status}\\n\\n`;\n  \n  if (order.status === 'completed' && order.completedAt) {\n    invoice += `‚úÖ ${lang === 'ms' ? 'Diselesaikan pada' : 'Completed on'}: ${formatDate(order.completedAt)}\\n`;\n  }\n  \n  invoice += `\\n${lang === 'ms' ? 'üìû Hubungi /support untuk pertanyaan' : 'üìû Contact /support for inquiries'}\\n`;\n  invoice += `${lang === 'ms' ? 'Terima kasih atas pembelian anda!' : 'Thank you for your purchase!'}\\n`;\n  \n  await ctx.reply(invoice, { parse_mode: 'Markdown' });\n}\n\nasync function handleOrderFilters(ctx) {\n  const { isAdmin } = require('./admin');\n  const { isOwner } = require('./owner');\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId) && !await isOwner(userId)) {\n    await ctx.answerCbQuery('üö´ Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'ms'\n    ? 'üîç *TAPIS PESANAN*\\n\\nPilih kriteria penapisan:'\n    : 'üîç *FILTER ORDERS*\\n\\nSelect filter criteria:';\n  \n  const buttons = [\n    [\n      Markup.button.callback(lang === 'ms' ? 'üí∞ >RM50' : 'üí∞ >RM50', 'filter_price_high'),\n      Markup.button.callback(lang === 'ms' ? 'üí∞ <RM20' : 'üí∞ <RM20', 'filter_price_low')\n    ],\n    [\n      Markup.button.callback(lang === 'ms' ? 'üìÖ Hari Ini' : 'üìÖ Today', 'filter_date_today'),\n      Markup.button.callback(lang === 'ms' ? 'üìÖ 7 Hari' : 'üìÖ 7 Days', 'filter_date_week')\n    ],\n    [\n      Markup.button.callback(lang === 'ms' ? 'üìÖ 30 Hari' : 'üìÖ 30 Days', 'filter_date_month'),\n      Markup.button.callback(lang === 'ms' ? 'üìÖ Semua' : 'üìÖ All Time', 'filter_date_all')\n    ],\n    [\n      Markup.button.callback(lang === 'ms' ? 'üë• By Customer' : 'üë• By Customer', 'filter_customer')\n    ],\n    [\n      Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_panel')\n    ]\n  ];\n  \n  await ctx.editMessageText(message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function filterOrdersByPrice(ctx, minPrice, maxPrice) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  let filtered;\n  \n  if (maxPrice) {\n    filtered = transactions.filter(t => t.price >= minPrice && t.price <= maxPrice);\n  } else {\n    filtered = transactions.filter(t => t.price >= minPrice);\n  }\n  \n  if (filtered.length === 0) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Tiada pesanan dijumpai!' : 'No orders found!');\n    return;\n  }\n  \n  const priceRange = maxPrice ? `RM${minPrice}-${maxPrice}` : `>RM${minPrice}`;\n  let message = lang === 'ms'\n    ? `üí∞ *Pesanan ${priceRange}*\\n\\nJumpaan ${filtered.length} pesanan:\\n\\n`\n    : `üí∞ *Orders ${priceRange}*\\n\\nFound ${filtered.length} orders:\\n\\n`;\n  \n  const revenue = filtered.reduce((sum, t) => sum + (t.price || 0), 0);\n  message += lang === 'ms' ? `üíµ Jumlah: RM${revenue.toFixed(2)}\\n\\n` : `üíµ Total: RM${revenue.toFixed(2)}\\n\\n`;\n  \n  filtered.slice(0, 10).forEach(order => {\n    message += `üÜî ${order.id}\\n`;\n    message += `üí∞ RM${order.price}\\n`;\n    message += `üì¶ ${order.productName?.ms || order.productName}\\n`;\n    message += `üìÖ ${formatDate(order.createdAt)}\\n\\n`;\n  });\n  \n  await ctx.editMessageText(message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[\n      Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'filter_orders')\n    ]])\n  });\n}\n\nasync function filterOrdersByDate(ctx, days) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const cutoffDate = new Date();\n  cutoffDate.setDate(cutoffDate.getDate() - days);\n  cutoffDate.setHours(0, 0, 0, 0);\n  \n  const filtered = transactions.filter(t => {\n    const orderDate = new Date(t.createdAt);\n    return orderDate >= cutoffDate;\n  });\n  \n  if (filtered.length === 0) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Tiada pesanan!' : 'No orders!');\n    return;\n  }\n  \n  const periodText = days === 0 ? (lang === 'ms' ? 'Hari Ini' : 'Today') :\n                     days === 7 ? '7 Hari' :\n                     days === 30 ? '30 Hari' : `${days} Hari`;\n  \n  let message = lang === 'ms'\n    ? `üìÖ *Pesanan ${periodText}*\\n\\nJumpaan ${filtered.length} pesanan:\\n\\n`\n    : `üìÖ *Orders ${periodText}*\\n\\nFound ${filtered.length} orders:\\n\\n`;\n  \n  const completed = filtered.filter(t => t.status === 'completed');\n  const revenue = completed.reduce((sum, t) => sum + (t.price || 0), 0);\n  \n  message += lang === 'ms'\n    ? `üí∞ Jualan: RM${revenue.toFixed(2)}\\n‚úÖ Selesai: ${completed.length}/${filtered.length}\\n\\n`\n    : `üí∞ Revenue: RM${revenue.toFixed(2)}\\n‚úÖ Completed: ${completed.length}/${filtered.length}\\n\\n`;\n  \n  filtered.slice(0, 10).reverse().forEach(order => {\n    const statusEmoji = { pending: '‚è≥', verified: '‚úÖ', completed: 'üéâ', rejected: '‚ùå', cancelled: 'üö´' };\n    message += `${statusEmoji[order.status] || 'üìå'} ${order.id}\\n`;\n    message += `üí∞ RM${order.price} ‚Ä¢ ${order.productName?.ms || order.productName}\\n`;\n    message += `üìÖ ${formatDate(order.createdAt)}\\n\\n`;\n  });\n  \n  await ctx.editMessageText(message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[\n      Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'filter_orders')\n    ]])\n  });\n}\n\nasync function handleCustomerLifetimeValue(ctx, customerId) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const customerOrders = transactions.filter(t => t.userId == customerId);\n  \n  if (customerOrders.length === 0) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Tiada data!' : '‚ùå No data!');\n    return;\n  }\n  \n  const completed = customerOrders.filter(t => t.status === 'completed');\n  const totalSpent = completed.reduce((sum, t) => sum + (t.price || 0), 0);\n  const averageOrder = totalSpent / (completed.length || 1);\n  \n  const firstOrder = customerOrders.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))[0];\n  const daysSinceFirst = Math.floor((new Date() - new Date(firstOrder.createdAt)) / (1000 * 60 * 60 * 24));\n  \n  const customer = await db.getUser(customerId);\n  const customerName = customer?.name || `User ${customerId}`;\n  \n  let message = lang === 'ms' ? 'üíé *NILAI PELANGGAN*\\n\\n' : 'üíé *CUSTOMER LIFETIME VALUE*\\n\\n';\n  message += `üë§ ${customerName}\\n`;\n  message += `üÜî \\`${customerId}\\`\\n\\n`;\n  \n  message += lang === 'ms' ? 'üí∞ *RINGKASAN:*\\n' : 'üí∞ *SUMMARY:*\\n';\n  message += lang === 'ms' \n    ? `Jumlah Belanja: RM${totalSpent.toFixed(2)}\\n`\n    : `Total Spent: RM${totalSpent.toFixed(2)}\\n`;\n  message += lang === 'ms'\n    ? `Purata Pesanan: RM${averageOrder.toFixed(2)}\\n`\n    : `Average Order: RM${averageOrder.toFixed(2)}\\n`;\n  message += lang === 'ms'\n    ? `Pesanan Selesai: ${completed.length}\\n`\n    : `Completed Orders: ${completed.length}\\n`;\n  message += lang === 'ms'\n    ? `Jumlah Pesanan: ${customerOrders.length}\\n\\n`\n    : `Total Orders: ${customerOrders.length}\\n\\n`;\n  \n  message += lang === 'ms' ? 'üìä *AKTIVITI:*\\n' : 'üìä *ACTIVITY:*\\n';\n  message += lang === 'ms'\n    ? `Pelanggan sejak: ${daysSinceFirst} hari\\n`\n    : `Customer since: ${daysSinceFirst} days ago\\n`;\n  message += lang === 'ms'\n    ? `Pesanan pertama: ${formatDate(firstOrder.createdAt)}\\n`\n    : `First order: ${formatDate(firstOrder.createdAt)}\\n`;\n  \n  const pending = customerOrders.filter(t => t.status === 'pending').length;\n  if (pending > 0) {\n    message += lang === 'ms'\n      ? `\\n‚è≥ ${pending} pesanan pending\\n`\n      : `\\n‚è≥ ${pending} pending orders\\n`;\n  }\n  \n  const customerTags = customer?.tags || [];\n  if (customerTags.length > 0) {\n    message += `\\nüè∑Ô∏è Tags: ${customerTags.join(', ')}\\n`;\n  }\n  \n  await ctx.reply(message, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard([[\n      Markup.button.callback(lang === 'ms' ? 'üìã Lihat Pesanan' : 'üìã View Orders', `customer_orders_${customerId}`),\n      Markup.button.callback(lang === 'ms' ? 'üìù Nota' : 'üìù Notes', `customer_notes_${customerId}`)\n    ], [\n      Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_panel')\n    ]])\n  });\n}\n\nmodule.exports = {\n  handleOrderInvoice,\n  handleOrderFilters,\n  filterOrdersByPrice,\n  filterOrdersByDate,\n  handleCustomerLifetimeValue\n};\n","size_bytes":11300},"handlers/categoryManagement.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { generateId } = require('../utils/helpers');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { isOwnerOrAdmin } = require('./userManagement');\n\nasync function handleCategoryManagement(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const categories = await db.getCategories();\n  \n  const text = lang === 'ms'\n    ? `üìÇ *Pengurusan Kategori*\\n\\nüìä Jumlah Kategori: ${categories.length}\\n\\nPilih kategori untuk edit/delete atau tambah kategori baru:`\n    : `üìÇ *Category Management*\\n\\nüìä Total Categories: ${categories.length}\\n\\nSelect a category to edit/delete or add new category:`;\n  \n  const buttons = [];\n  \n  categories.forEach(cat => {\n    buttons.push([\n      Markup.button.callback(`${cat.icon} ${cat.name.ms}`, `cat_manage_${cat.id}`)\n    ]);\n  });\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? '‚ûï Tambah Kategori' : '‚ûï Add Category', 'cat_add_new')]);\n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üè∑Ô∏è Diskaun Kategori' : 'üè∑Ô∏è Category Discounts', 'category_discounts')]);\n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîÑ Susun Kategori' : 'üîÑ Sort Categories', 'category_sort')]);\n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_products_menu')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleCategoryDetail(ctx, categoryId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const categories = await db.getCategories();\n  const category = categories.find(c => c.id === categoryId);\n  \n  if (!category) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Kategori tidak dijumpai' : 'Category not found');\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const categoryProducts = products.filter(p => p.categoryId === categoryId);\n  \n  const text = lang === 'ms'\n    ? `${category.icon} *${category.name.ms}*\\n\\n` +\n      `üÜî ID: \\`${category.id}\\`\\n` +\n      `üì¶ Produk: ${categoryProducts.length}\\n` +\n      `üìÖ Dibuat: ${new Date(category.createdAt).toLocaleDateString('ms-MY')}\\n\\n` +\n      `Pilih tindakan:`\n    : `${category.icon} *${category.name.en || category.name.ms}*\\n\\n` +\n      `üÜî ID: \\`${category.id}\\`\\n` +\n      `üì¶ Products: ${categoryProducts.length}\\n` +\n      `üìÖ Created: ${new Date(category.createdAt).toLocaleDateString('en-MY')}\\n\\n` +\n      `Choose action:`;\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? '‚úèÔ∏è Edit Nama' : '‚úèÔ∏è Edit Name', `cat_edit_name_${categoryId}`)],\n    [Markup.button.callback(lang === 'ms' ? 'üé® Edit Icon' : 'üé® Edit Icon', `cat_icon_select_${categoryId}`)],\n    [Markup.button.callback(lang === 'ms' ? 'üìä Analitik' : 'üìä Analytics', `cat_analytics_${categoryId}`)],\n    [Markup.button.callback(lang === 'ms' ? 'üóëÔ∏è Padam Kategori' : 'üóëÔ∏è Delete Category', `cat_delete_${categoryId}`)],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'cat_management')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleDeleteCategory(ctx, categoryId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const categoryProducts = products.filter(p => p.categoryId === categoryId);\n  \n  if (categoryProducts.length > 0) {\n    await ctx.answerCbQuery(\n      lang === 'ms' \n        ? `‚ùå Tidak boleh padam! ${categoryProducts.length} produk dalam kategori ini.`\n        : `‚ùå Cannot delete! ${categoryProducts.length} products in this category.`,\n      { show_alert: true }\n    );\n    return;\n  }\n  \n  const categories = await db.getCategories();\n  const categoryIndex = categories.findIndex(c => c.id === categoryId);\n  \n  if (categoryIndex === -1) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Kategori tidak dijumpai' : 'Category not found');\n    return;\n  }\n  \n  const category = categories[categoryIndex];\n  categories.splice(categoryIndex, 1);\n  await db.saveCategories(categories);\n  \n  const message = lang === 'ms'\n    ? `‚úÖ *Kategori berjaya dipadam!*\\n\\n${category.icon} ${category.name.ms}`\n    : `‚úÖ *Category deleted successfully!*\\n\\n${category.icon} ${category.name.en || category.name.ms}`;\n  \n  await ctx.answerCbQuery(lang === 'ms' ? '‚úÖ Kategori dipadam' : '‚úÖ Category deleted');\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n  \n  await handleCategoryManagement(ctx);\n}\n\nconst categoryEditState = new Map();\n\nasync function handleEditCategoryName(ctx, categoryId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  categoryEditState.set(adminId, { type: 'name', categoryId });\n  \n  const message = lang === 'ms'\n    ? `‚úèÔ∏è *Edit Nama Kategori*\\n\\nHantar nama baru untuk kategori ini.\\n\\nContoh: Streaming Premium`\n    : `‚úèÔ∏è *Edit Category Name*\\n\\nSend the new name for this category.\\n\\nExample: Premium Streaming`;\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function handleEditCategoryIcon(ctx, categoryId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  categoryEditState.set(adminId, { type: 'icon', categoryId });\n  \n  const message = lang === 'ms'\n    ? `üé® *Edit Icon Kategori*\\n\\nHantar emoji untuk icon kategori.\\n\\nContoh: üé¨ atau üì± atau üéÆ`\n    : `üé® *Edit Category Icon*\\n\\nSend an emoji for the category icon.\\n\\nExample: üé¨ or üì± or üéÆ`;\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function processCategoryEdit(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!categoryEditState.has(adminId)) {\n    return false;\n  }\n  \n  const editData = categoryEditState.get(adminId);\n  const newValue = ctx.message.text.trim();\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const categories = await db.getCategories();\n  const category = categories.find(c => c.id === editData.categoryId);\n  \n  if (!category) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Kategori tidak dijumpai' : '‚ùå Category not found');\n    categoryEditState.delete(adminId);\n    return true;\n  }\n  \n  if (editData.type === 'name') {\n    category.name = { ms: newValue, en: newValue };\n    await db.saveCategories(categories);\n    \n    const message = lang === 'ms'\n      ? `‚úÖ *Nama kategori dikemaskini!*\\n\\n${category.icon} ${category.name.ms}`\n      : `‚úÖ *Category name updated!*\\n\\n${category.icon} ${category.name.en || category.name.ms}`;\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n  } else if (editData.type === 'icon') {\n    category.icon = newValue;\n    await db.saveCategories(categories);\n    \n    const message = lang === 'ms'\n      ? `‚úÖ *Icon kategori dikemaskini!*\\n\\n${category.icon} ${category.name.ms}`\n      : `‚úÖ *Category icon updated!*\\n\\n${category.icon} ${category.name.en || category.name.ms}`;\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n  }\n  \n  categoryEditState.delete(adminId);\n  return true;\n}\n\nmodule.exports = {\n  handleCategoryManagement,\n  handleCategoryDetail,\n  handleDeleteCategory,\n  handleEditCategoryName,\n  handleEditCategoryIcon,\n  processCategoryEdit,\n  categoryEditState\n};\n","size_bytes":8223},"handlers/categoryAdvanced.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { isOwnerOrAdmin } = require('./userManagement');\n\nasync function handleCategorySort(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const text = lang === 'ms'\n    ? 'üîÑ *Susun Kategori*\\n\\nPilih cara susun kategori:'\n    : 'üîÑ *Sort Categories*\\n\\nSelect sorting method:';\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üìù Nama A-Z' : 'üìù Name A-Z', 'sort_cat_name_asc')],\n    [Markup.button.callback(lang === 'ms' ? 'üìù Nama Z-A' : 'üìù Name Z-A', 'sort_cat_name_desc')],\n    [Markup.button.callback(lang === 'ms' ? 'üì¶ Jumlah Produk ‚Üë' : 'üì¶ Product Count ‚Üë', 'sort_cat_prod_asc')],\n    [Markup.button.callback(lang === 'ms' ? 'üì¶ Jumlah Produk ‚Üì' : 'üì¶ Product Count ‚Üì', 'sort_cat_prod_desc')],\n    [Markup.button.callback(lang === 'ms' ? 'üìÖ Terbaru' : 'üìÖ Newest First', 'sort_cat_newest')],\n    [Markup.button.callback(lang === 'ms' ? 'üìÖ Terlama' : 'üìÖ Oldest First', 'sort_cat_oldest')],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'cat_management')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleCategorySortCallback(ctx, sortType) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  let categories = await db.getCategories();\n  const products = await db.getProducts();\n  \n  switch(sortType) {\n    case 'name_asc':\n      categories.sort((a, b) => (a.name.ms || '').localeCompare(b.name.ms || ''));\n      break;\n    case 'name_desc':\n      categories.sort((a, b) => (b.name.ms || '').localeCompare(a.name.ms || ''));\n      break;\n    case 'prod_asc':\n      categories.sort((a, b) => {\n        const aCount = products.filter(p => p.categoryId === a.id).length;\n        const bCount = products.filter(p => p.categoryId === b.id).length;\n        return aCount - bCount;\n      });\n      break;\n    case 'prod_desc':\n      categories.sort((a, b) => {\n        const aCount = products.filter(p => p.categoryId === a.id).length;\n        const bCount = products.filter(p => p.categoryId === b.id).length;\n        return bCount - aCount;\n      });\n      break;\n    case 'newest':\n      categories.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\n      break;\n    case 'oldest':\n      categories.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));\n      break;\n  }\n  \n  await db.saveCategories(categories);\n  \n  let text = lang === 'ms'\n    ? `‚úÖ *Kategori Disusun*\\n\\n`\n    : `‚úÖ *Categories Sorted*\\n\\n`;\n  \n  const buttons = [];\n  \n  categories.forEach((cat, index) => {\n    const prodCount = products.filter(p => p.categoryId === cat.id).length;\n    text += `${index + 1}. ${cat.icon} ${cat.name.ms} (${prodCount} produk)\\n`;\n    buttons.push([\n      Markup.button.callback(`${cat.icon} ${cat.name.ms}`, `cat_manage_${cat.id}`)\n    ]);\n  });\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'cat_management')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleCategoryAnalytics(ctx, categoryId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const categories = await db.getCategories();\n  const category = categories.find(c => c.id === categoryId);\n  \n  if (!category) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Kategori tidak dijumpai' : 'Category not found');\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const transactions = await db.getTransactions();\n  \n  const categoryProducts = products.filter(p => p.categoryId === categoryId);\n  const activeProducts = categoryProducts.filter(p => p.active);\n  const totalStock = categoryProducts.reduce((sum, p) => sum + p.stock, 0);\n  const avgPrice = categoryProducts.length > 0 \n    ? categoryProducts.reduce((sum, p) => sum + p.price, 0) / categoryProducts.length \n    : 0;\n  \n  const categoryOrders = transactions.filter(t => {\n    const prod = products.find(p => p.id === t.productId);\n    return prod && prod.categoryId === categoryId;\n  });\n  \n  const completedOrders = categoryOrders.filter(t => t.status === 'completed');\n  const revenue = completedOrders.reduce((sum, t) => sum + (t.price || 0), 0);\n  \n  const text = lang === 'ms'\n    ? `üìä *Analitik Kategori*\\n\\n` +\n      `${category.icon} *${category.name.ms}*\\n\\n` +\n      `üì¶ *Produk:*\\n` +\n      `  ‚Ä¢ Total: ${categoryProducts.length}\\n` +\n      `  ‚Ä¢ Aktif: ${activeProducts.length}\\n` +\n      `  ‚Ä¢ Tidak Aktif: ${categoryProducts.length - activeProducts.length}\\n\\n` +\n      `üìä *Inventori:*\\n` +\n      `  ‚Ä¢ Total Stok: ${totalStock} unit\\n` +\n      `  ‚Ä¢ Avg Harga: RM${avgPrice.toFixed(2)}\\n\\n` +\n      `üí∞ *Jualan:*\\n` +\n      `  ‚Ä¢ Total Order: ${categoryOrders.length}\\n` +\n      `  ‚Ä¢ Selesai: ${completedOrders.length}\\n` +\n      `  ‚Ä¢ Hasil: RM${revenue.toFixed(2)}\\n` +\n      `  ‚Ä¢ Conversion: ${categoryOrders.length > 0 ? ((completedOrders.length/categoryOrders.length)*100).toFixed(1) : 0}%`\n    : `üìä *Category Analytics*\\n\\n` +\n      `${category.icon} *${category.name.en || category.name.ms}*\\n\\n` +\n      `üì¶ *Products:*\\n` +\n      `  ‚Ä¢ Total: ${categoryProducts.length}\\n` +\n      `  ‚Ä¢ Active: ${activeProducts.length}\\n` +\n      `  ‚Ä¢ Inactive: ${categoryProducts.length - activeProducts.length}\\n\\n` +\n      `üìä *Inventory:*\\n` +\n      `  ‚Ä¢ Total Stock: ${totalStock} units\\n` +\n      `  ‚Ä¢ Avg Price: RM${avgPrice.toFixed(2)}\\n\\n` +\n      `üí∞ *Sales:*\\n` +\n      `  ‚Ä¢ Total Orders: ${categoryOrders.length}\\n` +\n      `  ‚Ä¢ Completed: ${completedOrders.length}\\n` +\n      `  ‚Ä¢ Revenue: RM${revenue.toFixed(2)}\\n` +\n      `  ‚Ä¢ Conversion: ${categoryOrders.length > 0 ? ((completedOrders.length/categoryOrders.length)*100).toFixed(1) : 0}%`;\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', `cat_manage_${categoryId}`)]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleCategoryIconSelector(ctx, categoryId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const presetIcons = [\n    'üì¶', 'üéÆ', 'üé¨', 'üì±', 'üíª', 'üéµ', 'üìö', 'üçî', 'üè†', 'üöó',\n    '‚úàÔ∏è', 'üèñÔ∏è', 'üíé', 'üëî', 'üëó', 'üëü', '‚öΩ', 'üé®', 'üîß', 'üîë',\n    'üíä', 'üåü', 'üî•', '‚≠ê', 'üí∞', 'üéÅ', 'üéØ', 'üé™', 'üé≠', 'üé∫'\n  ];\n  \n  const buttons = [];\n  const row = [];\n  \n  presetIcons.forEach((icon, index) => {\n    row.push(Markup.button.callback(icon, `set_cat_icon_${categoryId}_${icon}`));\n    if ((index + 1) % 5 === 0) {\n      buttons.push([...row]);\n      row.length = 0;\n    }\n  });\n  \n  if (row.length > 0) {\n    buttons.push([...row]);\n  }\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', `cat_manage_${categoryId}`)]);\n  \n  const text = lang === 'ms'\n    ? 'üé® *Pilih Icon Kategori*\\n\\nPilih icon dari senarai atau hantar emoji sendiri:'\n    : 'üé® *Select Category Icon*\\n\\nSelect icon from list or send your own emoji:';\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleSetCategoryIcon(ctx, categoryId, icon) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const categories = await db.getCategories();\n  const category = categories.find(c => c.id === categoryId);\n  \n  if (!category) {\n    await ctx.answerCbQuery('Category not found');\n    return;\n  }\n  \n  category.icon = icon;\n  await db.saveCategories(categories);\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  await ctx.answerCbQuery(lang === 'ms' ? '‚úÖ Icon dikemaskini' : '‚úÖ Icon updated');\n  \n  const { handleCategoryDetail } = require('./categoryManagement');\n  await handleCategoryDetail(ctx, categoryId);\n}\n\nmodule.exports = {\n  handleCategorySort,\n  handleCategorySortCallback,\n  handleCategoryAnalytics,\n  handleCategoryIconSelector,\n  handleSetCategoryIcon\n};\n","size_bytes":8976},"handlers/exportReports.js":{"content":"const db = require('../utils/database');\nconst fs = require('fs').promises;\nconst path = require('path');\n\nasync function isOwnerOrAdmin(userId) {\n  const admins = await db.getAdmins();\n  return admins.owner === userId || admins.admins.includes(userId);\n}\n\nfunction arrayToCSV(data, headers) {\n  if (data.length === 0) return '';\n  \n  const csv = [];\n  csv.push(headers.join(','));\n  \n  data.forEach(row => {\n    const values = headers.map(header => {\n      const value = row[header] !== undefined ? row[header] : '';\n      const stringValue = String(value).replace(/\"/g, '\"\"');\n      return `\"${stringValue}\"`;\n    });\n    csv.push(values.join(','));\n  });\n  \n  return csv.join('\\n');\n}\n\nasync function exportProductsCSV(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const categories = await db.getCategories();\n  \n  const data = products.map(p => {\n    const cat = categories.find(c => c.id === p.categoryId);\n    return {\n      ID: p.id,\n      Name: p.name.ms,\n      Category: cat?.name.ms || '',\n      Price: p.price,\n      Stock: p.stock,\n      Active: p.active ? 'Yes' : 'No',\n      DeliveryType: p.deliveryType,\n      CreatedAt: new Date(p.createdAt).toISOString()\n    };\n  });\n  \n  const headers = ['ID', 'Name', 'Category', 'Price', 'Stock', 'Active', 'DeliveryType', 'CreatedAt'];\n  const csv = arrayToCSV(data, headers);\n  \n  const filename = `products_${new Date().toISOString().split('T')[0]}.csv`;\n  const filepath = path.join('data', filename);\n  \n  await fs.writeFile(filepath, csv, 'utf8');\n  \n  await ctx.replyWithDocument(\n    { source: filepath, filename },\n    {\n      caption: lang === 'ms'\n        ? `üìä Export Produk\\n\\n${products.length} produk diexport`\n        : `üìä Products Export\\n\\n${products.length} products exported`\n    }\n  );\n  \n  await fs.unlink(filepath).catch(() => {});\n}\n\nasync function exportTransactionsCSV(ctx, startDate = null, endDate = null) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  let transactions = await db.getTransactions();\n  const products = await db.getProducts();\n  \n  // Filter by date range if provided\n  if (startDate) {\n    transactions = transactions.filter(t => new Date(t.createdAt) >= new Date(startDate));\n  }\n  if (endDate) {\n    transactions = transactions.filter(t => new Date(t.createdAt) <= new Date(endDate));\n  }\n  \n  const data = transactions.map(t => {\n    const prod = products.find(p => p.id === t.productId);\n    return {\n      OrderID: t.id,\n      UserID: t.userId,\n      ProductName: prod?.name.ms || 'Unknown',\n      Price: t.price,\n      Status: t.status,\n      CreatedAt: new Date(t.createdAt).toISOString(),\n      CompletedAt: t.completedAt ? new Date(t.completedAt).toISOString() : ''\n    };\n  });\n  \n  const headers = ['OrderID', 'UserID', 'ProductName', 'Price', 'Status', 'CreatedAt', 'CompletedAt'];\n  const csv = arrayToCSV(data, headers);\n  \n  const filename = `transactions_${new Date().toISOString().split('T')[0]}.csv`;\n  const filepath = path.join('data', filename);\n  \n  await fs.writeFile(filepath, csv, 'utf8');\n  \n  const totalRevenue = transactions\n    .filter(t => t.status === 'completed')\n    .reduce((sum, t) => sum + (t.price || 0), 0);\n  \n  await ctx.replyWithDocument(\n    { source: filepath, filename },\n    {\n      caption: lang === 'ms'\n        ? `üí∞ Export Transaksi\\n\\n${transactions.length} transaksi\\nJumlah: RM${totalRevenue.toFixed(2)}`\n        : `üí∞ Transactions Export\\n\\n${transactions.length} transactions\\nTotal: RM${totalRevenue.toFixed(2)}`\n    }\n  );\n  \n  await fs.unlink(filepath).catch(() => {});\n}\n\nasync function exportUsersCSV(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const users = await db.getUsers();\n  const transactions = await db.getTransactions();\n  \n  const data = users.map(u => {\n    const userOrders = transactions.filter(t => t.userId === u.id);\n    const completedOrders = userOrders.filter(t => t.status === 'completed');\n    const totalSpent = completedOrders.reduce((sum, t) => sum + (t.price || 0), 0);\n    \n    return {\n      UserID: u.id,\n      Username: u.username || '',\n      FirstName: u.first_name || '',\n      Language: u.language || 'ms',\n      TotalOrders: userOrders.length,\n      CompletedOrders: completedOrders.length,\n      TotalSpent: totalSpent.toFixed(2),\n      JoinedAt: new Date(u.createdAt).toISOString(),\n      Banned: u.banned ? 'Yes' : 'No'\n    };\n  });\n  \n  const headers = ['UserID', 'Username', 'FirstName', 'Language', 'TotalOrders', 'CompletedOrders', 'TotalSpent', 'JoinedAt', 'Banned'];\n  const csv = arrayToCSV(data, headers);\n  \n  const filename = `users_${new Date().toISOString().split('T')[0]}.csv`;\n  const filepath = path.join('data', filename);\n  \n  await fs.writeFile(filepath, csv, 'utf8');\n  \n  await ctx.replyWithDocument(\n    { source: filepath, filename },\n    {\n      caption: lang === 'ms'\n        ? `üë• Export Pengguna\\n\\n${users.length} pengguna diexport`\n        : `üë• Users Export\\n\\n${users.length} users exported`\n    }\n  );\n  \n  await fs.unlink(filepath).catch(() => {});\n}\n\nasync function exportSalesReport(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(userId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const transactions = await db.getTransactions();\n  const categories = await db.getCategories();\n  \n  // Sales by product\n  const productSales = products.map(p => {\n    const orders = transactions.filter(t => t.productId === p.id && t.status === 'completed');\n    const revenue = orders.reduce((sum, t) => sum + (t.price || 0), 0);\n    const cat = categories.find(c => c.id === p.categoryId);\n    \n    return {\n      ProductID: p.id,\n      ProductName: p.name.ms,\n      Category: cat?.name.ms || '',\n      UnitsSold: orders.length,\n      Revenue: revenue.toFixed(2),\n      CurrentStock: p.stock,\n      Status: p.active ? 'Active' : 'Inactive'\n    };\n  });\n  \n  const headers = ['ProductID', 'ProductName', 'Category', 'UnitsSold', 'Revenue', 'CurrentStock', 'Status'];\n  const csv = arrayToCSV(productSales, headers);\n  \n  const filename = `sales_report_${new Date().toISOString().split('T')[0]}.csv`;\n  const filepath = path.join('data', filename);\n  \n  await fs.writeFile(filepath, csv, 'utf8');\n  \n  const totalRevenue = productSales.reduce((sum, p) => sum + parseFloat(p.Revenue), 0);\n  const totalUnits = productSales.reduce((sum, p) => sum + p.UnitsSold, 0);\n  \n  await ctx.replyWithDocument(\n    { source: filepath, filename },\n    {\n      caption: lang === 'ms'\n        ? `üìà Laporan Jualan\\n\\nüí∞ Jumlah: RM${totalRevenue.toFixed(2)}\\nüì¶ Unit Dijual: ${totalUnits}`\n        : `üìà Sales Report\\n\\nüí∞ Total: RM${totalRevenue.toFixed(2)}\\nüì¶ Units Sold: ${totalUnits}`\n    }\n  );\n  \n  await fs.unlink(filepath).catch(() => {});\n}\n\nasync function handleExportMenu(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const { safeEditMessage } = require('../utils/messageHelper');\n  const { Markup } = require('telegraf');\n  \n  const text = lang === 'ms'\n    ? 'üìä *Export Data*\\n\\nPilih jenis data untuk export dalam format CSV:'\n    : 'üìä *Export Data*\\n\\nSelect data type to export in CSV format:';\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üì¶ Export Produk' : 'üì¶ Export Products', 'export_products')],\n    [Markup.button.callback(lang === 'ms' ? 'üí∞ Export Transaksi' : 'üí∞ Export Transactions', 'export_transactions')],\n    [Markup.button.callback(lang === 'ms' ? 'üë• Export Pengguna' : 'üë• Export Users', 'export_users')],\n    [Markup.button.callback(lang === 'ms' ? 'üìà Laporan Jualan' : 'üìà Sales Report', 'export_sales')],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_panel')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nmodule.exports = {\n  exportProductsCSV,\n  exportTransactionsCSV,\n  exportUsersCSV,\n  exportSalesReport,\n  handleExportMenu\n};\n","size_bytes":8775},"handlers/adminPermissions.js":{"content":"const db = require('../utils/database');\nconst { Markup } = require('telegraf');\nconst { safeEditMessage } = require('../utils/messageHelper');\n\n// Permission types (using short keys to avoid Telegram 64-byte callback data limit)\nconst PERMISSIONS = {\n  VERIFY_ORDERS: 'vo',\n  MANAGE_PRODUCTS: 'mp',\n  MANAGE_USERS: 'mu',\n  VIEW_ANALYTICS: 'va',\n  BROADCAST: 'bc',\n  MANAGE_CATEGORIES: 'mc',\n  EXPORT_DATA: 'ed',\n  MANAGE_SETTINGS: 'ms'\n};\n\n// Full names for display\nconst PERMISSION_NAMES = {\n  'vo': 'verify_orders',\n  'mp': 'manage_products',\n  'mu': 'manage_users',\n  'va': 'view_analytics',\n  'bc': 'broadcast',\n  'mc': 'manage_categories',\n  'ed': 'export_data',\n  'ms': 'manage_settings'\n};\n\nasync function isOwner(userId) {\n  const admins = await db.getAdmins();\n  return admins.owner === userId;\n}\n\nasync function getAdminPermissions(adminId) {\n  const permissions = await db.read('admin_permissions.json') || {};\n  return permissions[adminId] || Object.values(PERMISSIONS); // Default: all permissions\n}\n\nasync function setAdminPermissions(adminId, permissionsList) {\n  const permissions = await db.read('admin_permissions.json') || {};\n  permissions[adminId] = permissionsList;\n  await db.write('admin_permissions.json', permissions);\n}\n\nasync function hasPermission(adminId, permission) {\n  if (await isOwner(adminId)) return true;\n  \n  const permissions = await getAdminPermissions(adminId);\n  return permissions.includes(permission);\n}\n\nasync function handlePermissionsManagement(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('‚ùå Only owner can manage permissions');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const admins = await db.getAdmins();\n  const adminList = admins.admins || [];\n  \n  if (adminList.length === 0) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Tiada admin' : 'No admins');\n    return;\n  }\n  \n  let text = lang === 'ms'\n    ? 'üîê *Pengurusan Permissions*\\n\\nPilih admin untuk edit permissions:'\n    : 'üîê *Permissions Management*\\n\\nSelect admin to edit permissions:';\n  \n  const buttons = adminList.map(adminId => [\n    Markup.button.callback(`üë§ Admin ${adminId}`, `pm_${adminId}`)\n  ]);\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'owner_panel')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleAdminPermissionsEdit(ctx, adminId) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const currentPermissions = await getAdminPermissions(parseInt(adminId));\n  \n  const permissionLabels = {\n    [PERMISSIONS.VERIFY_ORDERS]: lang === 'ms' ? 'Verify Orders' : 'Verify Orders',\n    [PERMISSIONS.MANAGE_PRODUCTS]: lang === 'ms' ? 'Urus Produk' : 'Manage Products',\n    [PERMISSIONS.MANAGE_USERS]: lang === 'ms' ? 'Urus Pengguna' : 'Manage Users',\n    [PERMISSIONS.VIEW_ANALYTICS]: lang === 'ms' ? 'Lihat Analitik' : 'View Analytics',\n    [PERMISSIONS.BROADCAST]: lang === 'ms' ? 'Broadcast' : 'Broadcast',\n    [PERMISSIONS.MANAGE_CATEGORIES]: lang === 'ms' ? 'Urus Kategori' : 'Manage Categories',\n    [PERMISSIONS.EXPORT_DATA]: lang === 'ms' ? 'Export Data' : 'Export Data',\n    [PERMISSIONS.MANAGE_SETTINGS]: lang === 'ms' ? 'Urus Tetapan' : 'Manage Settings'\n  };\n  \n  let text = lang === 'ms'\n    ? `üîê *Permissions untuk Admin ${adminId}*\\n\\nKlik untuk toggle permissions:`\n    : `üîê *Permissions for Admin ${adminId}*\\n\\nClick to toggle permissions:`;\n  \n  const buttons = [];\n  \n  Object.entries(PERMISSIONS).forEach(([key, perm]) => {\n    const hasP = currentPermissions.includes(perm);\n    const icon = hasP ? '‚úÖ' : '‚ùå';\n    buttons.push([\n      Markup.button.callback(\n        `${icon} ${permissionLabels[perm]}`,\n        `pt_${adminId}_${perm}`\n      )\n    ]);\n  });\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'perm_mgmt')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleTogglePermission(ctx, adminId, permission) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const currentPermissions = await getAdminPermissions(parseInt(adminId));\n  \n  if (currentPermissions.includes(permission)) {\n    // Remove permission\n    const newPermissions = currentPermissions.filter(p => p !== permission);\n    await setAdminPermissions(parseInt(adminId), newPermissions);\n  } else {\n    // Add permission\n    currentPermissions.push(permission);\n    await setAdminPermissions(parseInt(adminId), currentPermissions);\n  }\n  \n  await ctx.answerCbQuery('‚úÖ Updated');\n  await handleAdminPermissionsEdit(ctx, adminId);\n}\n\nasync function checkPermissionMiddleware(permission) {\n  return async (ctx, next) => {\n    const userId = ctx.from.id;\n    \n    if (await hasPermission(userId, permission)) {\n      return next();\n    }\n    \n    const user = await db.getUser(userId);\n    const lang = user?.language || 'ms';\n    \n    await ctx.reply(\n      lang === 'ms' \n        ? '‚ùå Anda tidak mempunyai permission untuk tindakan ini.'\n        : '‚ùå You do not have permission for this action.'\n    );\n  };\n}\n\nasync function getAdminActivity(adminId) {\n  const logs = await db.read('admin_logs.json') || [];\n  return logs.filter(log => log.adminId === adminId)\n    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))\n    .slice(0, 20);\n}\n\nasync function handleAdminActivityLog(ctx, adminId) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const activity = await getAdminActivity(parseInt(adminId));\n  \n  if (activity.length === 0) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Tiada aktiviti' : 'No activity');\n    return;\n  }\n  \n  let text = lang === 'ms'\n    ? `üìã *Log Aktiviti Admin ${adminId}*\\n\\n`\n    : `üìã *Activity Log for Admin ${adminId}*\\n\\n`;\n  \n  activity.slice(0, 10).forEach((log, index) => {\n    text += `${index + 1}. ${log.action}\\n`;\n    text += `   üìù ${log.details || 'N/A'}\\n`;\n    text += `   üìÖ ${new Date(log.timestamp).toLocaleString()}\\n\\n`;\n  });\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', `pm_${adminId}`)]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nmodule.exports = {\n  PERMISSIONS,\n  getAdminPermissions,\n  setAdminPermissions,\n  hasPermission,\n  handlePermissionsManagement,\n  handleAdminPermissionsEdit,\n  handleTogglePermission,\n  checkPermissionMiddleware,\n  getAdminActivity,\n  handleAdminActivityLog\n};\n","size_bytes":7036},"handlers/ownerDashboard.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { safeEditMessage } = require('../utils/messageHelper');\n\nasync function isOwner(userId) {\n  const admins = await db.getAdmins();\n  return admins.owner === userId;\n}\n\nasync function handleOwnerDashboard(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  // Get all data\n  const users = await db.getUsers();\n  const products = await db.getProducts();\n  const transactions = await db.getTransactions();\n  const categories = await db.getCategories();\n  \n  // Calculate today stats\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n  \n  const todayOrders = transactions.filter(t => new Date(t.createdAt) >= today);\n  const todayCompleted = todayOrders.filter(t => t.status === 'completed');\n  const todayRevenue = todayCompleted.reduce((sum, t) => sum + (t.price || 0), 0);\n  \n  // Calculate week stats\n  const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);\n  const weekOrders = transactions.filter(t => new Date(t.createdAt) >= weekAgo);\n  const weekCompleted = weekOrders.filter(t => t.status === 'completed');\n  const weekRevenue = weekCompleted.reduce((sum, t) => sum + (t.price || 0), 0);\n  \n  // Calculate month stats\n  const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);\n  const monthOrders = transactions.filter(t => new Date(t.createdAt) >= monthAgo);\n  const monthCompleted = monthOrders.filter(t => t.status === 'completed');\n  const monthRevenue = monthCompleted.reduce((sum, t) => sum + (t.price || 0), 0);\n  \n  // Calculate all time stats\n  const allCompleted = transactions.filter(t => t.status === 'completed');\n  const allRevenue = allCompleted.reduce((sum, t) => sum + (t.price || 0), 0);\n  const avgOrderValue = allCompleted.length > 0 ? allRevenue / allCompleted.length : 0;\n  \n  // Product stats\n  const activeProducts = products.filter(p => p.active);\n  const lowStockProducts = products.filter(p => p.stock < 5 && p.active);\n  const outOfStockProducts = products.filter(p => p.stock === 0 && p.active);\n  \n  // User stats\n  const newUsersToday = users.filter(u => new Date(u.createdAt) >= today);\n  const newUsersWeek = users.filter(u => new Date(u.createdAt) >= weekAgo);\n  \n  // Pending stats\n  const pendingOrders = transactions.filter(t => t.status === 'awaiting_verification');\n  const pendingPayments = transactions.filter(t => t.status === 'pending');\n  \n  // Growth calculation\n  const prevWeekStart = new Date(today.getTime() - 14 * 24 * 60 * 60 * 1000);\n  const prevWeekEnd = weekAgo;\n  const prevWeekOrders = transactions.filter(t => {\n    const date = new Date(t.createdAt);\n    return date >= prevWeekStart && date < prevWeekEnd && t.status === 'completed';\n  });\n  const prevWeekRevenue = prevWeekOrders.reduce((sum, t) => sum + (t.price || 0), 0);\n  const weekGrowth = prevWeekRevenue > 0 \n    ? ((weekRevenue - prevWeekRevenue) / prevWeekRevenue * 100).toFixed(1)\n    : 0;\n  \n  const text = lang === 'ms'\n    ? `üìä *Dashboard Owner*\\n\\n` +\n      `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n` +\n      `üìà *RINGKASAN HARI INI*\\n` +\n      `üí∞ Hasil: RM${todayRevenue.toFixed(2)}\\n` +\n      `üì¶ Order: ${todayOrders.length} (${todayCompleted.length} selesai)\\n` +\n      `üë• Pengguna Baru: ${newUsersToday.length}\\n\\n` +\n      `üìä *7 HARI LEPAS*\\n` +\n      `üí∞ Hasil: RM${weekRevenue.toFixed(2)} ${weekGrowth > 0 ? '‚Üë' : '‚Üì'}${Math.abs(weekGrowth)}%\\n` +\n      `üì¶ Order: ${weekOrders.length} (${weekCompleted.length} selesai)\\n` +\n      `üë• Pengguna Baru: ${newUsersWeek.length}\\n\\n` +\n      `üìÖ *30 HARI LEPAS*\\n` +\n      `üí∞ Hasil: RM${monthRevenue.toFixed(2)}\\n` +\n      `üì¶ Order: ${monthOrders.length} (${monthCompleted.length} selesai)\\n\\n` +\n      `üíé *STATISTIK KESELURUHAN*\\n` +\n      `üí∞ Jumlah Hasil: RM${allRevenue.toFixed(2)}\\n` +\n      `üì¶ Jumlah Order: ${transactions.length} (${allCompleted.length} selesai)\\n` +\n      `üíµ Avg Order Value: RM${avgOrderValue.toFixed(2)}\\n` +\n      `üë• Jumlah Pengguna: ${users.length}\\n` +\n      `üì¶ Produk: ${products.length} (${activeProducts.length} aktif)\\n` +\n      `üìÇ Kategori: ${categories.length}\\n\\n` +\n      `‚ö†Ô∏è *PERHATIAN DIPERLUKAN*\\n` +\n      `üí≥ Pending Verification: ${pendingOrders.length}\\n` +\n      `‚è≥ Pending Payment: ${pendingPayments.length}\\n` +\n      `‚ö†Ô∏è Stok Rendah: ${lowStockProducts.length}\\n` +\n      `üì¶ Stok Habis: ${outOfStockProducts.length}\\n` +\n      `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`\n    : `üìä *Owner Dashboard*\\n\\n` +\n      `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n` +\n      `üìà *TODAY'S SUMMARY*\\n` +\n      `üí∞ Revenue: RM${todayRevenue.toFixed(2)}\\n` +\n      `üì¶ Orders: ${todayOrders.length} (${todayCompleted.length} completed)\\n` +\n      `üë• New Users: ${newUsersToday.length}\\n\\n` +\n      `üìä *LAST 7 DAYS*\\n` +\n      `üí∞ Revenue: RM${weekRevenue.toFixed(2)} ${weekGrowth > 0 ? '‚Üë' : '‚Üì'}${Math.abs(weekGrowth)}%\\n` +\n      `üì¶ Orders: ${weekOrders.length} (${weekCompleted.length} completed)\\n` +\n      `üë• New Users: ${newUsersWeek.length}\\n\\n` +\n      `üìÖ *LAST 30 DAYS*\\n` +\n      `üí∞ Revenue: RM${monthRevenue.toFixed(2)}\\n` +\n      `üì¶ Orders: ${monthOrders.length} (${monthCompleted.length} completed)\\n\\n` +\n      `üíé *ALL TIME STATS*\\n` +\n      `üí∞ Total Revenue: RM${allRevenue.toFixed(2)}\\n` +\n      `üì¶ Total Orders: ${transactions.length} (${allCompleted.length} completed)\\n` +\n      `üíµ Avg Order Value: RM${avgOrderValue.toFixed(2)}\\n` +\n      `üë• Total Users: ${users.length}\\n` +\n      `üì¶ Products: ${products.length} (${activeProducts.length} active)\\n` +\n      `üìÇ Categories: ${categories.length}\\n\\n` +\n      `‚ö†Ô∏è *REQUIRES ATTENTION*\\n` +\n      `üí≥ Pending Verification: ${pendingOrders.length}\\n` +\n      `‚è≥ Pending Payment: ${pendingPayments.length}\\n` +\n      `‚ö†Ô∏è Low Stock: ${lowStockProducts.length}\\n` +\n      `üì¶ Out of Stock: ${outOfStockProducts.length}\\n` +\n      `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üîÑ Refresh' : 'üîÑ Refresh', 'owner_dashboard')],\n    [Markup.button.callback(lang === 'ms' ? 'üìä Laporan Terperinci' : 'üìä Detailed Report', 'owner_detailed_report')],\n    [Markup.button.callback(lang === 'ms' ? 'üìà Trend Analysis' : 'üìà Trend Analysis', 'owner_trend_analysis')],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Panel Owner' : 'üîô Owner Panel', 'owner_panel')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleDetailedReport(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const transactions = await db.getTransactions();\n  const categories = await db.getCategories();\n  \n  // Top products by revenue\n  const productRevenue = {};\n  transactions.filter(t => t.status === 'completed').forEach(t => {\n    productRevenue[t.productId] = (productRevenue[t.productId] || 0) + (t.price || 0);\n  });\n  \n  const topProducts = Object.entries(productRevenue)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 5)\n    .map(([productId, revenue]) => {\n      const prod = products.find(p => p.id === productId);\n      return { product: prod, revenue };\n    });\n  \n  // Top categories by revenue\n  const categoryRevenue = {};\n  transactions.filter(t => t.status === 'completed').forEach(t => {\n    const prod = products.find(p => p.id === t.productId);\n    if (prod) {\n      categoryRevenue[prod.categoryId] = (categoryRevenue[prod.categoryId] || 0) + (t.price || 0);\n    }\n  });\n  \n  const topCategories = Object.entries(categoryRevenue)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 5)\n    .map(([categoryId, revenue]) => {\n      const cat = categories.find(c => c.id === categoryId);\n      return { category: cat, revenue };\n    });\n  \n  let text = lang === 'ms'\n    ? `üìä *Laporan Terperinci*\\n\\n`\n    : `üìä *Detailed Report*\\n\\n`;\n  \n  text += lang === 'ms' ? `üèÜ *TOP 5 PRODUK*\\n` : `üèÜ *TOP 5 PRODUCTS*\\n`;\n  topProducts.forEach((item, index) => {\n    if (item.product) {\n      text += `${index + 1}. ${item.product.name.ms}\\n   üí∞ RM${item.revenue.toFixed(2)}\\n`;\n    }\n  });\n  \n  text += lang === 'ms' ? `\\nüìÇ *TOP 5 KATEGORI*\\n` : `\\nüìÇ *TOP 5 CATEGORIES*\\n`;\n  topCategories.forEach((item, index) => {\n    if (item.category) {\n      text += `${index + 1}. ${item.category.icon} ${item.category.name.ms}\\n   üí∞ RM${item.revenue.toFixed(2)}\\n`;\n    }\n  });\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'owner_dashboard')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleTrendAnalysis(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isOwner(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const users = await db.getUsers();\n  \n  // Last 7 days daily revenue\n  const dailyRevenue = [];\n  for (let i = 6; i >= 0; i--) {\n    const date = new Date();\n    date.setDate(date.getDate() - i);\n    date.setHours(0, 0, 0, 0);\n    const nextDate = new Date(date);\n    nextDate.setDate(nextDate.getDate() + 1);\n    \n    const dayOrders = transactions.filter(t => {\n      const orderDate = new Date(t.createdAt);\n      return orderDate >= date && orderDate < nextDate && t.status === 'completed';\n    });\n    \n    const dayRevenue = dayOrders.reduce((sum, t) => sum + (t.price || 0), 0);\n    dailyRevenue.push({ date, revenue: dayRevenue, orders: dayOrders.length });\n  }\n  \n  let text = lang === 'ms'\n    ? `üìà *Analisis Trend*\\n\\n`\n    : `üìà *Trend Analysis*\\n\\n`;\n  \n  text += lang === 'ms' ? `üìä *JUALAN 7 HARI LEPAS*\\n` : `üìä *SALES LAST 7 DAYS*\\n`;\n  \n  dailyRevenue.forEach((day, index) => {\n    const dayName = day.date.toLocaleDateString('en-US', { weekday: 'short' });\n    const bar = '‚ñà'.repeat(Math.min(10, Math.floor(day.revenue / 10)));\n    text += `${dayName}: ${bar} RM${day.revenue.toFixed(0)} (${day.orders})\\n`;\n  });\n  \n  const avgDailyRevenue = dailyRevenue.reduce((sum, day) => sum + day.revenue, 0) / 7;\n  const avgDailyOrders = dailyRevenue.reduce((sum, day) => sum + day.orders, 0) / 7;\n  \n  text += lang === 'ms'\n    ? `\\nüìä Avg Harian: RM${avgDailyRevenue.toFixed(2)}\\nüì¶ Avg Order: ${avgDailyOrders.toFixed(1)}/hari`\n    : `\\nüìä Daily Avg: RM${avgDailyRevenue.toFixed(2)}\\nüì¶ Avg Orders: ${avgDailyOrders.toFixed(1)}/day`;\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'owner_dashboard')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nmodule.exports = {\n  handleOwnerDashboard,\n  handleDetailedReport,\n  handleTrendAnalysis\n};\n","size_bytes":11378},"handlers/stockAlerts.js":{"content":"const db = require('../utils/database');\nconst cron = require('node-cron');\n\nlet alertsInitialized = false;\nlet botInstance = null;\n\nasync function initializeStockAlerts(bot) {\n  if (alertsInitialized) return;\n  \n  botInstance = bot;\n  \n  // Check stock every hour\n  cron.schedule('0 * * * *', async () => {\n    await checkAndSendStockAlerts();\n  });\n  \n  // Check stock every 6 hours for critical alerts\n  cron.schedule('0 */6 * * *', async () => {\n    await checkCriticalStockAlerts();\n  });\n  \n  alertsInitialized = true;\n  console.log('‚úÖ Stock alert system initialized');\n}\n\nasync function checkAndSendStockAlerts() {\n  try {\n    const products = await db.getProducts();\n    const admins = await db.getAdmins();\n    \n    const lowStockProducts = products.filter(p => p.stock > 0 && p.stock < 5 && p.active);\n    \n    if (lowStockProducts.length === 0) return;\n    \n    const allAdmins = [admins.owner, ...admins.admins].filter(Boolean);\n    \n    let message = `‚ö†Ô∏è *Low Stock Alert*\\n\\n${lowStockProducts.length} products have low stock (<5 units):\\n\\n`;\n    \n    lowStockProducts.forEach(prod => {\n      message += `üì¶ ${prod.name.ms}\\n`;\n      message += `üìä Stock: ${prod.stock} units\\n`;\n      message += `üÜî ${prod.id}\\n\\n`;\n    });\n    \n    message += '_This is an automated alert. Use /adjuststock to update stock levels._';\n    \n    for (const adminId of allAdmins) {\n      try {\n        await botInstance.telegram.sendMessage(adminId, message, { parse_mode: 'Markdown' });\n      } catch (error) {\n        console.error(`Failed to send stock alert to admin ${adminId}:`, error.message);\n      }\n    }\n    \n    console.log(`üìä Sent low stock alerts for ${lowStockProducts.length} products`);\n  } catch (error) {\n    console.error('Error in stock alert system:', error);\n  }\n}\n\nasync function checkCriticalStockAlerts() {\n  try {\n    const products = await db.getProducts();\n    const admins = await db.getAdmins();\n    \n    const outOfStockProducts = products.filter(p => p.stock === 0 && p.active);\n    \n    if (outOfStockProducts.length === 0) return;\n    \n    const allAdmins = [admins.owner, ...admins.admins].filter(Boolean);\n    \n    let message = `üö® *CRITICAL: Out of Stock Alert*\\n\\n${outOfStockProducts.length} active products are OUT OF STOCK:\\n\\n`;\n    \n    outOfStockProducts.forEach(prod => {\n      message += `üì¶ ${prod.name.ms}\\n`;\n      message += `üí∞ RM${prod.price}\\n`;\n      message += `üÜî ${prod.id}\\n\\n`;\n    });\n    \n    message += '‚ö†Ô∏è *URGENT ACTION REQUIRED*\\n';\n    message += '_These products are active but cannot be sold. Please restock or deactivate them._';\n    \n    for (const adminId of allAdmins) {\n      try {\n        await botInstance.telegram.sendMessage(adminId, message, { parse_mode: 'Markdown' });\n      } catch (error) {\n        console.error(`Failed to send critical stock alert to admin ${adminId}:`, error.message);\n      }\n    }\n    \n    console.log(`üö® Sent critical stock alerts for ${outOfStockProducts.length} products`);\n  } catch (error) {\n    console.error('Error in critical stock alert system:', error);\n  }\n}\n\nasync function sendManualStockAlert(bot, adminId) {\n  try {\n    const products = await db.getProducts();\n    const lowStockProducts = products.filter(p => p.stock > 0 && p.stock < 5 && p.active);\n    const outOfStockProducts = products.filter(p => p.stock === 0 && p.active);\n    \n    let message = `üìä *Stock Status Report*\\n\\n`;\n    \n    if (outOfStockProducts.length > 0) {\n      message += `üö® *OUT OF STOCK (${outOfStockProducts.length})*\\n`;\n      outOfStockProducts.slice(0, 5).forEach(prod => {\n        message += `  ‚Ä¢ ${prod.name.ms} (${prod.id})\\n`;\n      });\n      if (outOfStockProducts.length > 5) {\n        message += `  _...and ${outOfStockProducts.length - 5} more_\\n`;\n      }\n      message += `\\n`;\n    }\n    \n    if (lowStockProducts.length > 0) {\n      message += `‚ö†Ô∏è *LOW STOCK (${lowStockProducts.length})*\\n`;\n      lowStockProducts.slice(0, 5).forEach(prod => {\n        message += `  ‚Ä¢ ${prod.name.ms}: ${prod.stock} units (${prod.id})\\n`;\n      });\n      if (lowStockProducts.length > 5) {\n        message += `  _...and ${lowStockProducts.length - 5} more_\\n`;\n      }\n    }\n    \n    if (lowStockProducts.length === 0 && outOfStockProducts.length === 0) {\n      message += `‚úÖ All products have sufficient stock!`;\n    }\n    \n    await bot.telegram.sendMessage(adminId, message, { parse_mode: 'Markdown' });\n  } catch (error) {\n    console.error('Error sending manual stock alert:', error);\n    throw error;\n  }\n}\n\nmodule.exports = {\n  initializeStockAlerts,\n  checkAndSendStockAlerts,\n  checkCriticalStockAlerts,\n  sendManualStockAlert\n};\n","size_bytes":4682},"handlers/productStats.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { isOwnerOrAdmin } = require('./userManagement');\n\nasync function handleProductStats(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Produk tidak dijumpai' : 'Product not found');\n    return;\n  }\n  \n  const transactions = await db.getTransactions();\n  const productOrders = transactions.filter(t => t.productId === productId);\n  const completedOrders = productOrders.filter(t => t.status === 'completed');\n  const pendingOrders = productOrders.filter(t => t.status === 'awaiting_verification');\n  const rejectedOrders = productOrders.filter(t => t.status === 'rejected');\n  \n  const totalRevenue = completedOrders.reduce((sum, t) => sum + (t.price || 0), 0);\n  const conversionRate = productOrders.length > 0 \n    ? (completedOrders.length / productOrders.length * 100).toFixed(1)\n    : 0;\n  \n  // Calculate average rating if feedback exists\n  const feedbacks = await db.read('feedbacks.json') || [];\n  const productFeedbacks = feedbacks.filter(f => f.productId === productId && f.rating);\n  const avgRating = productFeedbacks.length > 0\n    ? (productFeedbacks.reduce((sum, f) => sum + f.rating, 0) / productFeedbacks.length).toFixed(1)\n    : 0;\n  \n  // Get sales trend (last 7 days)\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n  const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);\n  \n  const weekSales = completedOrders.filter(t => new Date(t.createdAt) >= weekAgo).length;\n  const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);\n  const monthSales = completedOrders.filter(t => new Date(t.createdAt) >= monthAgo).length;\n  \n  const text = lang === 'ms'\n    ? `üìä *Statistik Produk*\\n\\n` +\n      `üì¶ *${product.name.ms}*\\n` +\n      `üÜî ${productId}\\n\\n` +\n      `üí∞ *Jualan:*\\n` +\n      `  ‚Ä¢ Total Order: ${productOrders.length}\\n` +\n      `  ‚Ä¢ Selesai: ${completedOrders.length}\\n` +\n      `  ‚Ä¢ Pending: ${pendingOrders.length}\\n` +\n      `  ‚Ä¢ Ditolak: ${rejectedOrders.length}\\n` +\n      `  ‚Ä¢ Hasil: RM${totalRevenue.toFixed(2)}\\n` +\n      `  ‚Ä¢ Conversion: ${conversionRate}%\\n\\n` +\n      `üìà *Trend:*\\n` +\n      `  ‚Ä¢ 7 Hari: ${weekSales} jualan\\n` +\n      `  ‚Ä¢ 30 Hari: ${monthSales} jualan\\n\\n` +\n      `‚≠ê *Rating:* ${avgRating > 0 ? `${avgRating}/5.0 (${productFeedbacks.length} reviews)` : 'Tiada rating'}\\n\\n` +\n      `üìä *Inventori:*\\n` +\n      `  ‚Ä¢ Stok Semasa: ${product.stock}\\n` +\n      `  ‚Ä¢ Harga: RM${product.price}\\n` +\n      `  ‚Ä¢ Status: ${product.active ? '‚úÖ Aktif' : '‚ùå Tidak Aktif'}`\n    : `üìä *Product Statistics*\\n\\n` +\n      `üì¶ *${product.name.en || product.name.ms}*\\n` +\n      `üÜî ${productId}\\n\\n` +\n      `üí∞ *Sales:*\\n` +\n      `  ‚Ä¢ Total Orders: ${productOrders.length}\\n` +\n      `  ‚Ä¢ Completed: ${completedOrders.length}\\n` +\n      `  ‚Ä¢ Pending: ${pendingOrders.length}\\n` +\n      `  ‚Ä¢ Rejected: ${rejectedOrders.length}\\n` +\n      `  ‚Ä¢ Revenue: RM${totalRevenue.toFixed(2)}\\n` +\n      `  ‚Ä¢ Conversion: ${conversionRate}%\\n\\n` +\n      `üìà *Trend:*\\n` +\n      `  ‚Ä¢ 7 Days: ${weekSales} sales\\n` +\n      `  ‚Ä¢ 30 Days: ${monthSales} sales\\n\\n` +\n      `‚≠ê *Rating:* ${avgRating > 0 ? `${avgRating}/5.0 (${productFeedbacks.length} reviews)` : 'No ratings'}\\n\\n` +\n      `üìä *Inventory:*\\n` +\n      `  ‚Ä¢ Current Stock: ${product.stock}\\n` +\n      `  ‚Ä¢ Price: RM${product.price}\\n` +\n      `  ‚Ä¢ Status: ${product.active ? '‚úÖ Active' : '‚ùå Inactive'}`;\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üìä Inventory History' : 'üìä Inventory History', `prod_inventory_${productId}`)],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', `prod_detail_${productId}`)]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleAllProductsStats(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const transactions = await db.getTransactions();\n  \n  // Calculate stats for each product\n  const productStats = products.map(prod => {\n    const orders = transactions.filter(t => t.productId === prod.id && t.status === 'completed');\n    const revenue = orders.reduce((sum, t) => sum + (t.price || 0), 0);\n    return { product: prod, orders: orders.length, revenue };\n  });\n  \n  // Sort by revenue\n  productStats.sort((a, b) => b.revenue - a.revenue);\n  \n  let text = lang === 'ms'\n    ? `üìä *Statistik Semua Produk*\\n\\nTop 10 produk mengikut hasil:\\n\\n`\n    : `üìä *All Products Statistics*\\n\\nTop 10 products by revenue:\\n\\n`;\n  \n  const buttons = [];\n  \n  productStats.slice(0, 10).forEach((stat, index) => {\n    text += `${index + 1}. ${stat.product.name.ms}\\n`;\n    text += `   üí∞ RM${stat.revenue.toFixed(2)} (${stat.orders} orders)\\n`;\n    text += `   üìä Stock: ${stat.product.stock}\\n\\n`;\n    \n    buttons.push([\n      Markup.button.callback(\n        `${stat.product.name.ms.substring(0, 25)}...`,\n        `prod_stats_${stat.product.id}`\n      )\n    ]);\n  });\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_products_menu')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nmodule.exports = {\n  handleProductStats,\n  handleAllProductsStats\n};\n","size_bytes":5983},"handlers/adminQuickActions.js":{"content":"\nasync function validateProductPricing(ctx) {\n  const adminId = ctx.from.id;\n  const db = require('../utils/database');\n  const { isOwnerOrAdmin } = require('./userManagement');\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n  \n  const products = await db.getProducts();\n  \n  let message = 'üìä *Pricing Validation Report*\\n\\n';\n  \n  // Group products by category to check consistency\n  const productsByCategory = {};\n  \n  products.forEach(prod => {\n    if (!productsByCategory[prod.categoryId]) {\n      productsByCategory[prod.categoryId] = [];\n    }\n    productsByCategory[prod.categoryId].push(prod);\n  });\n  \n  // Check for pricing inconsistencies\n  let inconsistencies = 0;\n  \n  for (const categoryId in productsByCategory) {\n    const categoryProducts = productsByCategory[categoryId];\n    \n    if (categoryProducts.length > 1) {\n      // Sort by price to check ratios\n      categoryProducts.sort((a, b) => a.price - b.price);\n      \n      for (let i = 0; i < categoryProducts.length - 1; i++) {\n        const current = categoryProducts[i];\n        const next = categoryProducts[i + 1];\n        \n        // Extract quantities from product names if possible\n        const currentQty = extractQuantity(current.name.ms || current.name.en);\n        const nextQty = extractQuantity(next.name.ms || next.name.en);\n        \n        if (currentQty && nextQty && currentQty < nextQty) {\n          const expectedRatio = nextQty / currentQty;\n          const actualRatio = next.price / current.price;\n          \n          if (Math.abs(expectedRatio - actualRatio) > 0.1) {\n            inconsistencies++;\n            message += `‚ö†Ô∏è Inconsistent pricing:\\n`;\n            message += `   ${current.name.ms} (${currentQty}): RM${current.price}\\n`;\n            message += `   ${next.name.ms} (${nextQty}): RM${next.price}\\n`;\n            message += `   Expected ratio: ${expectedRatio.toFixed(2)}x\\n`;\n            message += `   Actual ratio: ${actualRatio.toFixed(2)}x\\n\\n`;\n          }\n        }\n      }\n    }\n  }\n  \n  if (inconsistencies === 0) {\n    message += '‚úÖ No pricing inconsistencies detected!';\n  } else {\n    message += `\\nüî¥ Found ${inconsistencies} pricing inconsistencies.\\n`;\n    message += `Please review and update product prices.`;\n  }\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nfunction extractQuantity(name) {\n  // Extract numbers from product name (e.g., \"160 Robux\" -> 160)\n  const match = name.match(/(\\d+)/);\n  return match ? parseInt(match[1]) : null;\n}\n\nasync function fixCategoryPricing(ctx) {\n  const adminId = ctx.from.id;\n  const db = require('../utils/database');\n  const { isOwnerOrAdmin } = require('./userManagement');\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.reply('‚ùå Unauthorized');\n    return;\n  }\n  \n  const categories = await db.getCategories();\n  const robuxCategory = categories.find(c => \n    c.name.ms.toUpperCase().includes('ROBUX') || \n    c.name.en.toUpperCase().includes('ROBUX')\n  );\n  \n  if (!robuxCategory) {\n    await ctx.reply('‚ùå Category ROBUX tidak dijumpai. Sila gunakan format:\\n/fixpricing [CATEGORY_ID]');\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const categoryProducts = products.filter(p => p.categoryId === robuxCategory.id);\n  \n  if (categoryProducts.length === 0) {\n    await ctx.reply(`‚ùå Tiada produk dalam category ${robuxCategory.name.ms}`);\n    return;\n  }\n  \n  // Sort by quantity\n  categoryProducts.sort((a, b) => {\n    const qtyA = extractQuantity(a.name.ms || a.name.en);\n    const qtyB = extractQuantity(b.name.ms || b.name.en);\n    return qtyA - qtyB;\n  });\n  \n  // Use first product as base\n  const baseProduct = categoryProducts[0];\n  const baseQty = extractQuantity(baseProduct.name.ms || baseProduct.name.en);\n  const basePrice = baseProduct.price;\n  const pricePerUnit = basePrice / baseQty;\n  \n  let message = `üîß *Fix Pricing - ${robuxCategory.name.ms}*\\n\\n`;\n  message += `üìä Base: ${baseProduct.name.ms}\\n`;\n  message += `üí∞ Harga: RM${basePrice} (${baseQty} unit)\\n`;\n  message += `üìà Price per unit: RM${pricePerUnit.toFixed(4)}\\n\\n`;\n  message += `*Cadangan harga baru:*\\n\\n`;\n  \n  const updates = [];\n  \n  for (let i = 0; i < categoryProducts.length; i++) {\n    const product = categoryProducts[i];\n    const qty = extractQuantity(product.name.ms || product.name.en);\n    const expectedPrice = parseFloat((qty * pricePerUnit).toFixed(2));\n    \n    if (Math.abs(product.price - expectedPrice) > 0.01) {\n      message += `${i + 1}. ${product.name.ms}\\n`;\n      message += `   Current: RM${product.price} ‚ùå\\n`;\n      message += `   Expected: RM${expectedPrice} ‚úÖ\\n\\n`;\n      \n      updates.push({\n        product: product,\n        oldPrice: product.price,\n        newPrice: expectedPrice\n      });\n    } else {\n      message += `${i + 1}. ${product.name.ms}\\n`;\n      message += `   RM${product.price} ‚úÖ (OK)\\n\\n`;\n    }\n  }\n  \n  if (updates.length === 0) {\n    await ctx.reply(message + '\\n‚úÖ Semua harga sudah konsisten!', { parse_mode: 'Markdown' });\n    return;\n  }\n  \n  // Apply updates\n  for (const update of updates) {\n    const productIndex = products.findIndex(p => p.id === update.product.id);\n    if (productIndex !== -1) {\n      products[productIndex].price = update.newPrice;\n    }\n  }\n  \n  await db.saveProducts(products);\n  \n  message += `\\n‚úÖ *${updates.length} harga telah dikemaskini!*\\n\\n`;\n  message += `Total products: ${categoryProducts.length}\\n`;\n  message += `Updated: ${updates.length}\\n`;\n  message += `Already correct: ${categoryProducts.length - updates.length}`;\n  \n  await ctx.reply(message, { parse_mode: 'Markdown' });\n  \n  await logAdminAction(adminId, 'Fix Category Pricing', `${robuxCategory.name.ms}: ${updates.length} products updated`);\n}\n\nconst { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { logAdminAction } = require('../utils/adminLogger');\n\nasync function isAdmin(userId) {\n  const admins = await db.getAdmins();\n  return admins.owner === userId || admins.admins.includes(userId);\n}\n\nasync function handleQuickActionsMenu(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const products = await db.getProducts();\n  const pendingOrders = transactions.filter(t => t.status === 'awaiting_verification');\n  const lowStock = products.filter(p => p.stock < 5 && p.active);\n  \n  const text = lang === 'ms'\n    ? `‚ö° *Quick Actions*\\n\\nAkses pantas untuk tugas admin:\\n\\nüì¶ ${pendingOrders.length} order pending\\n‚ö†Ô∏è ${lowStock.length} produk stok rendah`\n    : `‚ö° *Quick Actions*\\n\\nQuick access to admin tasks:\\n\\nüì¶ ${pendingOrders.length} pending orders\\n‚ö†Ô∏è ${lowStock.length} low stock products`;\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? `‚úÖ Quick Verify (${pendingOrders.length})` : `‚úÖ Quick Verify (${pendingOrders.length})`, 'qa_quick_verify')],\n    [Markup.button.callback(lang === 'ms' ? 'üìä Quick Stock Update' : 'üìä Quick Stock Update', 'qa_quick_stock')],\n    [Markup.button.callback(lang === 'ms' ? 'üí∞ Quick Price Update' : 'üí∞ Quick Price Update', 'qa_quick_price')],\n    [Markup.button.callback(lang === 'ms' ? 'üîÑ Quick Toggle Status' : 'üîÑ Quick Toggle Status', 'qa_quick_toggle')],\n    [Markup.button.callback(lang === 'ms' ? 'üì¢ Quick Broadcast' : 'üì¢ Quick Broadcast', 'qa_quick_broadcast')],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_panel')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleQuickVerify(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const pendingOrders = transactions.filter(t => t.status === 'awaiting_verification').slice(0, 5);\n  \n  if (pendingOrders.length === 0) {\n    await ctx.answerCbQuery(lang === 'ms' ? '‚úÖ Tiada pending orders' : '‚úÖ No pending orders');\n    return;\n  }\n  \n  let text = lang === 'ms'\n    ? `‚úÖ *Quick Verify*\\n\\n${pendingOrders.length} order pending:\\n\\n`\n    : `‚úÖ *Quick Verify*\\n\\n${pendingOrders.length} pending orders:\\n\\n`;\n  \n  const buttons = [];\n  \n  pendingOrders.forEach(order => {\n    text += `üÜî \\`${order.id}\\`\\n`;\n    text += `üë§ User: ${order.userId}\\n`;\n    text += `üí∞ RM${order.price}\\n\\n`;\n    \n    buttons.push([\n      Markup.button.callback(`‚úÖ ${order.id.substring(0, 10)}...`, `qa_verify_${order.id}`),\n      Markup.button.callback(`‚ùå`, `qa_reject_${order.id}`)\n    ]);\n  });\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? '‚úÖ Verify Semua' : '‚úÖ Verify All', 'qa_verify_all')]);\n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'quick_actions')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleQuickVerifyOrder(ctx, orderId) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const { handleVerifyOrder } = require('./admin');\n  await handleVerifyOrder(ctx, orderId);\n  \n  await logAdminAction(userId, 'Quick Verify', `Order ${orderId}`);\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  await ctx.answerCbQuery(lang === 'ms' ? '‚úÖ Order verified' : '‚úÖ Order verified');\n}\n\nasync function handleQuickRejectOrder(ctx, orderId) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const { handleRejectOrder } = require('./admin');\n  await handleRejectOrder(ctx, orderId);\n  \n  await logAdminAction(userId, 'Quick Reject', `Order ${orderId}`);\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  await ctx.answerCbQuery(lang === 'ms' ? '‚ùå Order rejected' : '‚ùå Order rejected');\n}\n\nasync function handleQuickVerifyAll(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const products = await db.getProducts();\n  const pendingOrders = transactions.filter(t => t.status === 'awaiting_verification');\n  \n  let successCount = 0;\n  let failCount = 0;\n  \n  for (const order of pendingOrders) {\n    const product = products.find(p => p.id === order.productId);\n    \n    if (product && product.stock > 0) {\n      product.stock -= 1;\n      order.status = 'completed';\n      successCount++;\n      \n      // Notify user\n      try {\n        const customerLang = (await db.getUser(order.userId))?.language || 'ms';\n        await ctx.telegram.sendMessage(\n          order.userId,\n          customerLang === 'ms' \n            ? `‚úÖ Pesanan ${order.id} anda telah disahkan! Admin akan hantar item anda tidak lama lagi.`\n            : `‚úÖ Your order ${order.id} has been verified! Admin will deliver your item shortly.`\n        );\n      } catch (error) {\n        console.error('Failed to notify user:', error);\n      }\n    } else {\n      failCount++;\n    }\n  }\n  \n  await db.saveProducts(products);\n  await db.saveTransactions(transactions);\n  \n  await logAdminAction(userId, 'Quick Verify All', `Verified ${successCount} orders, failed ${failCount}`);\n  \n  const message = lang === 'ms'\n    ? `‚úÖ *Selesai!*\\n\\n‚úì ${successCount} order verified\\n‚úó ${failCount} gagal (stok habis)`\n    : `‚úÖ *Complete!*\\n\\n‚úì ${successCount} orders verified\\n‚úó ${failCount} failed (out of stock)`;\n  \n  await ctx.answerCbQuery(lang === 'ms' ? '‚úÖ Selesai' : '‚úÖ Complete');\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nconst quickStockState = new Map();\n\nasync function handleQuickStock(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  quickStockState.set(userId, true);\n  \n  const message = lang === 'ms'\n    ? 'üìä *Quick Stock Update*\\n\\nHantar dalam format:\\n`PRODUCT_ID +/-AMOUNT`\\n\\nContoh:\\n‚Ä¢ `PROD-ABC123 +50`\\n‚Ä¢ `PROD-XYZ789 -10`'\n    : 'üìä *Quick Stock Update*\\n\\nSend in format:\\n`PRODUCT_ID +/-AMOUNT`\\n\\nExample:\\n‚Ä¢ `PROD-ABC123 +50`\\n‚Ä¢ `PROD-XYZ789 -10`';\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function processQuickStock(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!quickStockState.has(userId)) {\n    return false;\n  }\n  \n  quickStockState.delete(userId);\n  \n  const input = ctx.message.text.trim();\n  const parts = input.split(' ');\n  \n  if (parts.length < 2) {\n    await ctx.reply('‚ùå Format salah. Contoh: PROD-ABC123 +50');\n    return true;\n  }\n  \n  const productId = parts[0];\n  const adjustment = parseInt(parts[1]);\n  \n  if (isNaN(adjustment)) {\n    await ctx.reply('‚ùå Jumlah tidak sah');\n    return true;\n  }\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product) {\n    await ctx.reply(`‚ùå Produk ${productId} tidak dijumpai`);\n    return true;\n  }\n  \n  const oldStock = product.stock;\n  product.stock = Math.max(0, product.stock + adjustment);\n  \n  await db.saveProducts(products);\n  \n  await logAdminAction(userId, 'Quick Stock Update', `${productId}: ${oldStock} ‚Üí ${product.stock}`);\n  \n  await ctx.reply(\n    `‚úÖ *Stock Updated*\\n\\n` +\n    `üì¶ ${product.name.ms}\\n` +\n    `üìä ${oldStock} ‚Üí ${product.stock}`,\n    { parse_mode: 'Markdown' }\n  );\n  \n  return true;\n}\n\nconst quickPriceState = new Map();\n\nasync function handleQuickPrice(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!await isAdmin(userId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  quickPriceState.set(userId, true);\n  \n  const message = lang === 'ms'\n    ? 'üí∞ *Quick Price Update*\\n\\nHantar dalam format:\\n`PRODUCT_ID PRICE`\\n\\nContoh:\\n‚Ä¢ `PROD-ABC123 15.00`\\n‚Ä¢ `PROD-XYZ789 25.50`'\n    : 'üí∞ *Quick Price Update*\\n\\nSend in format:\\n`PRODUCT_ID PRICE`\\n\\nExample:\\n‚Ä¢ `PROD-ABC123 15.00`\\n‚Ä¢ `PROD-XYZ789 25.50`';\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function processQuickPrice(ctx) {\n  const userId = ctx.from.id;\n  \n  if (!quickPriceState.has(userId)) {\n    return false;\n  }\n  \n  quickPriceState.delete(userId);\n  \n  const input = ctx.message.text.trim();\n  const parts = input.split(' ');\n  \n  if (parts.length < 2) {\n    await ctx.reply('‚ùå Format salah. Contoh: PROD-ABC123 15.00');\n    return true;\n  }\n  \n  const productId = parts[0];\n  const price = parseFloat(parts[1]);\n  \n  if (isNaN(price) || price < 0) {\n    await ctx.reply('‚ùå Harga tidak sah');\n    return true;\n  }\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product) {\n    await ctx.reply(`‚ùå Produk ${productId} tidak dijumpai`);\n    return true;\n  }\n  \n  const oldPrice = product.price;\n  product.price = price;\n  \n  await db.saveProducts(products);\n  \n  await logAdminAction(userId, 'Quick Price Update', `${productId}: RM${oldPrice} ‚Üí RM${price}`);\n  \n  await ctx.reply(\n    `‚úÖ *Price Updated*\\n\\n` +\n    `üì¶ ${product.name.ms}\\n` +\n    `üí∞ RM${oldPrice} ‚Üí RM${price}`,\n    { parse_mode: 'Markdown' }\n  );\n  \n  return true;\n}\n\nmodule.exports = {\n  handleQuickActionsMenu,\n  handleQuickVerify,\n  handleQuickVerifyOrder,\n  handleQuickRejectOrder,\n  handleQuickVerifyAll,\n  handleQuickStock,\n  processQuickStock,\n  handleQuickPrice,\n  processQuickPrice,\n  quickStockState,\n  quickPriceState\n};\n","size_bytes":16261},"handlers/productBulkOperations.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { isOwnerOrAdmin } = require('./userManagement');\nconst { logInventoryMovement } = require('./productManagement');\n\nconst bulkEditState = new Map();\n\nasync function handleBulkOperations(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const text = lang === 'ms'\n    ? `üîÑ *Operasi Bulk*\\n\\nPilih tindakan untuk banyak produk sekaligus:`\n    : `üîÑ *Bulk Operations*\\n\\nSelect action for multiple products:`;\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? '‚úÖ Aktifkan Semua' : '‚úÖ Activate All', 'bulk_activate_all')],\n    [Markup.button.callback(lang === 'ms' ? '‚ùå Nyahaktif Semua' : '‚ùå Deactivate All', 'bulk_deactivate_all')],\n    [Markup.button.callback(lang === 'ms' ? 'üè∑Ô∏è Bulk Edit Harga' : 'üè∑Ô∏è Bulk Edit Price', 'bulk_price_category')],\n    [Markup.button.callback(lang === 'ms' ? 'üìä Bulk Edit Stok' : 'üìä Bulk Edit Stock', 'bulk_stock_category')],\n    [Markup.button.callback(lang === 'ms' ? 'üóëÔ∏è Bulk Delete' : 'üóëÔ∏è Bulk Delete', 'bulk_delete_inactive')],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_products_menu')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleBulkActivateAll(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const inactiveCount = products.filter(p => !p.active).length;\n  \n  products.forEach(p => p.active = true);\n  await db.saveProducts(products);\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'ms'\n    ? `‚úÖ *Operasi Selesai!*\\n\\n${inactiveCount} produk telah diaktifkan.`\n    : `‚úÖ *Operation Complete!*\\n\\n${inactiveCount} products activated.`;\n  \n  await ctx.answerCbQuery(lang === 'ms' ? '‚úÖ Selesai' : '‚úÖ Complete');\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function handleBulkDeactivateAll(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const activeCount = products.filter(p => p.active).length;\n  \n  products.forEach(p => p.active = false);\n  await db.saveProducts(products);\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const message = lang === 'ms'\n    ? `‚úÖ *Operasi Selesai!*\\n\\n${activeCount} produk telah dinyahaktifkan.`\n    : `‚úÖ *Operation Complete!*\\n\\n${activeCount} products deactivated.`;\n  \n  await ctx.answerCbQuery(lang === 'ms' ? '‚úÖ Selesai' : '‚úÖ Complete');\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function handleBulkPriceByCategory(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const categories = await db.getCategories();\n  \n  if (categories.length === 0) {\n    await ctx.answerCbQuery(lang === 'ms' ? '‚ùå Tiada kategori' : '‚ùå No categories');\n    return;\n  }\n  \n  const buttons = categories.map(cat => [\n    Markup.button.callback(\n      `${cat.icon} ${cat.name.ms}`,\n      `bulk_price_cat_${cat.id}`\n    )\n  ]);\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'bulk_operations')]);\n  \n  const text = lang === 'ms'\n    ? 'üè∑Ô∏è *Bulk Edit Harga*\\n\\nPilih kategori untuk edit harga:'\n    : 'üè∑Ô∏è *Bulk Edit Price*\\n\\nSelect category to edit price:';\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleBulkPriceCategorySelect(ctx, categoryId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  bulkEditState.set(adminId, { type: 'price', categoryId });\n  \n  const message = lang === 'ms'\n    ? 'üí∞ *Bulk Edit Harga*\\n\\nHantar peratusan perubahan harga:\\n\\nContoh:\\n‚Ä¢ `+10` - Tambah 10%\\n‚Ä¢ `-20` - Kurang 20%\\n‚Ä¢ `15` - Set harga tetap RM15'\n    : 'üí∞ *Bulk Edit Price*\\n\\nSend price change percentage:\\n\\nExample:\\n‚Ä¢ `+10` - Increase 10%\\n‚Ä¢ `-20` - Decrease 20%\\n‚Ä¢ `15` - Set fixed price RM15';\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function handleBulkStockByCategory(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const categories = await db.getCategories();\n  \n  if (categories.length === 0) {\n    await ctx.answerCbQuery(lang === 'ms' ? '‚ùå Tiada kategori' : '‚ùå No categories');\n    return;\n  }\n  \n  const buttons = categories.map(cat => [\n    Markup.button.callback(\n      `${cat.icon} ${cat.name.ms}`,\n      `bulk_stock_cat_${cat.id}`\n    )\n  ]);\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'bulk_operations')]);\n  \n  const text = lang === 'ms'\n    ? 'üìä *Bulk Edit Stok*\\n\\nPilih kategori untuk edit stok:'\n    : 'üìä *Bulk Edit Stock*\\n\\nSelect category to edit stock:';\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleBulkStockCategorySelect(ctx, categoryId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  bulkEditState.set(adminId, { type: 'stock', categoryId });\n  \n  const message = lang === 'ms'\n    ? 'üìä *Bulk Edit Stok*\\n\\nHantar perubahan stok:\\n\\nContoh:\\n‚Ä¢ `+50` - Tambah 50 unit ke semua produk\\n‚Ä¢ `-10` - Kurang 10 unit dari semua produk\\n‚Ä¢ `100` - Set stok tetap 100 untuk semua produk'\n    : 'üìä *Bulk Edit Stock*\\n\\nSend stock change:\\n\\nExample:\\n‚Ä¢ `+50` - Add 50 units to all products\\n‚Ä¢ `-10` - Remove 10 units from all products\\n‚Ä¢ `100` - Set fixed stock 100 for all products';\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function processBulkEdit(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!bulkEditState.has(adminId)) {\n    return false;\n  }\n  \n  const editData = bulkEditState.get(adminId);\n  const input = ctx.message.text.trim();\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const categoryProducts = products.filter(p => p.categoryId === editData.categoryId);\n  \n  if (categoryProducts.length === 0) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Tiada produk dalam kategori' : '‚ùå No products in category');\n    bulkEditState.delete(adminId);\n    return true;\n  }\n  \n  if (editData.type === 'price') {\n    const isPercentage = input.includes('+') || input.includes('-');\n    const value = parseFloat(input.replace(/[^0-9.-]/g, ''));\n    \n    if (isNaN(value)) {\n      await ctx.reply(lang === 'ms' ? '‚ùå Nilai tidak sah' : '‚ùå Invalid value');\n      bulkEditState.delete(adminId);\n      return true;\n    }\n    \n    categoryProducts.forEach(prod => {\n      if (isPercentage) {\n        const change = prod.price * (value / 100);\n        prod.price = Math.max(0.01, prod.price + change);\n      } else {\n        prod.price = Math.max(0.01, value);\n      }\n      prod.price = Math.round(prod.price * 100) / 100;\n    });\n    \n    await db.saveProducts(products);\n    \n    const message = lang === 'ms'\n      ? `‚úÖ *Harga dikemaskini!*\\n\\n${categoryProducts.length} produk telah dikemaskini.`\n      : `‚úÖ *Price updated!*\\n\\n${categoryProducts.length} products updated.`;\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n    \n  } else if (editData.type === 'stock') {\n    const isRelative = input.includes('+') || input.includes('-');\n    const value = parseInt(input);\n    \n    if (isNaN(value)) {\n      await ctx.reply(lang === 'ms' ? '‚ùå Nilai tidak sah' : '‚ùå Invalid value');\n      bulkEditState.delete(adminId);\n      return true;\n    }\n    \n    categoryProducts.forEach(prod => {\n      if (isRelative) {\n        prod.stock = Math.max(0, prod.stock + value);\n      } else {\n        prod.stock = Math.max(0, value);\n      }\n      \n      // Log inventory movement\n      logInventoryMovement({\n        productId: prod.id,\n        productName: prod.name.ms,\n        type: 'manual_adjustment',\n        quantity: isRelative ? value : (value - prod.stock),\n        note: 'Bulk stock adjustment',\n        adminId: adminId\n      });\n    });\n    \n    await db.saveProducts(products);\n    \n    const message = lang === 'ms'\n      ? `‚úÖ *Stok dikemaskini!*\\n\\n${categoryProducts.length} produk telah dikemaskini.`\n      : `‚úÖ *Stock updated!*\\n\\n${categoryProducts.length} products updated.`;\n    \n    await ctx.reply(message, { parse_mode: 'Markdown' });\n  }\n  \n  bulkEditState.delete(adminId);\n  return true;\n}\n\nasync function handleBulkDeleteInactive(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const inactiveProducts = products.filter(p => !p.active);\n  \n  if (inactiveProducts.length === 0) {\n    await ctx.answerCbQuery(lang === 'ms' ? '‚úÖ Tiada produk tidak aktif' : '‚úÖ No inactive products');\n    return;\n  }\n  \n  const text = lang === 'ms'\n    ? `‚ö†Ô∏è *Padam Produk Tidak Aktif*\\n\\n${inactiveProducts.length} produk tidak aktif akan dipadam.\\n\\n*Tindakan ini tidak boleh dibatalkan!*\\n\\nTeruskan?`\n    : `‚ö†Ô∏è *Delete Inactive Products*\\n\\n${inactiveProducts.length} inactive products will be deleted.\\n\\n*This action cannot be undone!*\\n\\nContinue?`;\n  \n  const buttons = [\n    [\n      Markup.button.callback(lang === 'ms' ? '‚ùå Batal' : '‚ùå Cancel', 'bulk_operations'),\n      Markup.button.callback(lang === 'ms' ? 'üóëÔ∏è Ya, Padam' : 'üóëÔ∏è Yes, Delete', 'bulk_delete_confirm')\n    ]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleBulkDeleteConfirm(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const activeProducts = products.filter(p => p.active);\n  const deletedCount = products.length - activeProducts.length;\n  \n  await db.saveProducts(activeProducts);\n  \n  const message = lang === 'ms'\n    ? `‚úÖ *Selesai!*\\n\\n${deletedCount} produk tidak aktif telah dipadam.`\n    : `‚úÖ *Complete!*\\n\\n${deletedCount} inactive products deleted.`;\n  \n  await ctx.answerCbQuery(lang === 'ms' ? '‚úÖ Selesai' : '‚úÖ Complete');\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nmodule.exports = {\n  handleBulkOperations,\n  handleBulkActivateAll,\n  handleBulkDeactivateAll,\n  handleBulkPriceByCategory,\n  handleBulkPriceCategorySelect,\n  handleBulkStockByCategory,\n  handleBulkStockCategorySelect,\n  processBulkEdit,\n  handleBulkDeleteInactive,\n  handleBulkDeleteConfirm,\n  bulkEditState\n};\n","size_bytes":11998},"handlers/productSearch.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { isOwnerOrAdmin } = require('./userManagement');\n\nconst searchState = new Map();\n\nasync function handleProductSearch(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  searchState.set(adminId, true);\n  \n  const message = lang === 'ms'\n    ? 'üîç *Cari Produk*\\n\\nHantar nama produk, ID, atau kategori untuk cari:\\n\\nContoh:\\n‚Ä¢ Netflix\\n‚Ä¢ PROD-ABC123\\n‚Ä¢ Premium'\n    : 'üîç *Search Product*\\n\\nSend product name, ID, or category to search:\\n\\nExample:\\n‚Ä¢ Netflix\\n‚Ä¢ PROD-ABC123\\n‚Ä¢ Premium';\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(message, { parse_mode: 'Markdown' });\n}\n\nasync function processProductSearch(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!searchState.has(adminId)) {\n    return false;\n  }\n  \n  searchState.delete(adminId);\n  \n  const query = ctx.message.text.trim().toLowerCase();\n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const categories = await db.getCategories();\n  \n  const results = products.filter(p => {\n    const nameMatch = (p.name.ms || '').toLowerCase().includes(query) ||\n                      (p.name.en || '').toLowerCase().includes(query);\n    const idMatch = p.id.toLowerCase().includes(query);\n    const categoryMatch = categories.some(c => \n      c.id === p.categoryId && \n      ((c.name.ms || '').toLowerCase().includes(query) || \n       (c.name.en || '').toLowerCase().includes(query))\n    );\n    \n    return nameMatch || idMatch || categoryMatch;\n  });\n  \n  if (results.length === 0) {\n    await ctx.reply(\n      lang === 'ms' \n        ? '‚ùå Tiada produk dijumpai untuk carian anda.'\n        : '‚ùå No products found for your search.',\n      { parse_mode: 'Markdown' }\n    );\n    return true;\n  }\n  \n  let text = lang === 'ms'\n    ? `üîç *Hasil Carian*\\n\\nDijumpai ${results.length} produk:\\n\\n`\n    : `üîç *Search Results*\\n\\nFound ${results.length} products:\\n\\n`;\n  \n  const buttons = [];\n  \n  results.slice(0, 10).forEach(prod => {\n    const cat = categories.find(c => c.id === prod.categoryId);\n    const status = prod.active ? '‚úÖ' : '‚ùå';\n    text += `${status} \\`${prod.id}\\`\\n`;\n    text += `üì¶ ${prod.name.ms}\\n`;\n    text += `üí∞ RM${prod.price} | üìä Stok: ${prod.stock}\\n`;\n    text += `üìÇ ${cat?.name.ms || 'Unknown'}\\n\\n`;\n    \n    buttons.push([\n      Markup.button.callback(`${prod.name.ms}`, `prod_detail_${prod.id}`)\n    ]);\n  });\n  \n  if (results.length > 10) {\n    text += lang === 'ms'\n      ? `\\n_Menunjukkan 10 hasil pertama dari ${results.length}_`\n      : `\\n_Showing first 10 results of ${results.length}_`;\n  }\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_products_menu')]);\n  \n  await ctx.reply(text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n  \n  return true;\n}\n\nasync function handleProductFilter(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const text = lang === 'ms'\n    ? 'üîç *Tapis Produk*\\n\\nPilih kriteria penapisan:'\n    : 'üîç *Filter Products*\\n\\nSelect filter criteria:';\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? '‚úÖ Produk Aktif' : '‚úÖ Active Products', 'filter_active')],\n    [Markup.button.callback(lang === 'ms' ? '‚ùå Produk Tidak Aktif' : '‚ùå Inactive Products', 'filter_inactive')],\n    [Markup.button.callback(lang === 'ms' ? '‚ö†Ô∏è Stok Rendah (<5)' : '‚ö†Ô∏è Low Stock (<5)', 'filter_low_stock')],\n    [Markup.button.callback(lang === 'ms' ? 'üì¶ Stok Habis (0)' : 'üì¶ Out of Stock (0)', 'filter_out_stock')],\n    [Markup.button.callback(lang === 'ms' ? 'üí∞ Harga Tertinggi' : 'üí∞ Highest Price', 'filter_high_price')],\n    [Markup.button.callback(lang === 'ms' ? 'üíµ Harga Terendah' : 'üíµ Lowest Price', 'filter_low_price')],\n    [Markup.button.callback(lang === 'ms' ? 'üìÖ Terbaru' : 'üìÖ Newest', 'filter_newest')],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_products_menu')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleFilterCallback(ctx, filterType) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  let products = await db.getProducts();\n  const categories = await db.getCategories();\n  let filterName = '';\n  \n  switch(filterType) {\n    case 'active':\n      products = products.filter(p => p.active);\n      filterName = lang === 'ms' ? 'Produk Aktif' : 'Active Products';\n      break;\n    case 'inactive':\n      products = products.filter(p => !p.active);\n      filterName = lang === 'ms' ? 'Produk Tidak Aktif' : 'Inactive Products';\n      break;\n    case 'low_stock':\n      products = products.filter(p => p.stock > 0 && p.stock < 5);\n      filterName = lang === 'ms' ? 'Stok Rendah' : 'Low Stock';\n      break;\n    case 'out_stock':\n      products = products.filter(p => p.stock === 0);\n      filterName = lang === 'ms' ? 'Stok Habis' : 'Out of Stock';\n      break;\n    case 'high_price':\n      products = products.sort((a, b) => b.price - a.price).slice(0, 20);\n      filterName = lang === 'ms' ? 'Harga Tertinggi' : 'Highest Price';\n      break;\n    case 'low_price':\n      products = products.sort((a, b) => a.price - b.price).slice(0, 20);\n      filterName = lang === 'ms' ? 'Harga Terendah' : 'Lowest Price';\n      break;\n    case 'newest':\n      products = products.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 20);\n      filterName = lang === 'ms' ? 'Terbaru' : 'Newest';\n      break;\n  }\n  \n  if (products.length === 0) {\n    await ctx.answerCbQuery(lang === 'ms' ? '‚ùå Tiada produk dijumpai' : '‚ùå No products found');\n    return;\n  }\n  \n  let text = lang === 'ms'\n    ? `üîç *${filterName}*\\n\\nDijumpai ${products.length} produk:\\n\\n`\n    : `üîç *${filterName}*\\n\\nFound ${products.length} products:\\n\\n`;\n  \n  const buttons = [];\n  \n  products.slice(0, 10).forEach(prod => {\n    const cat = categories.find(c => c.id === prod.categoryId);\n    const status = prod.active ? '‚úÖ' : '‚ùå';\n    text += `${status} \\`${prod.id}\\`\\n`;\n    text += `üì¶ ${prod.name.ms}\\n`;\n    text += `üí∞ RM${prod.price} | üìä ${prod.stock}\\n`;\n    text += `üìÇ ${cat?.name.ms || 'Unknown'}\\n\\n`;\n    \n    buttons.push([\n      Markup.button.callback(`${prod.name.ms.substring(0, 30)}...`, `prod_detail_${prod.id}`)\n    ]);\n  });\n  \n  if (products.length > 10) {\n    text += lang === 'ms'\n      ? `\\n_Menunjukkan 10 hasil pertama dari ${products.length}_`\n      : `\\n_Showing first 10 results of ${products.length}_`;\n  }\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'product_filter')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nmodule.exports = {\n  handleProductSearch,\n  processProductSearch,\n  handleProductFilter,\n  handleFilterCallback,\n  searchState\n};\n","size_bytes":7588},"handlers/quickEditProduct.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { isOwnerOrAdmin } = require('./userManagement');\n\nconst quickEditState = new Map();\n\nasync function handleQuickEditMenu(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const text = lang === 'ms'\n    ? `‚ö° *Edit Pantas Produk*\\n\\n` +\n      `Kemaskini produk dengan cepat tanpa perlu pergi ke menu edit penuh.\\n\\n` +\n      `Pilih tindakan:`\n    : `‚ö° *Quick Edit Product*\\n\\n` +\n      `Quickly update products without going through the full edit flow.\\n\\n` +\n      `Choose action:`;\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üí∞ Edit Harga' : 'üí∞ Edit Price', 'qedit_price')],\n    [Markup.button.callback(lang === 'ms' ? 'üìä Edit Stok' : 'üìä Edit Stock', 'qedit_stock')],\n    [Markup.button.callback(lang === 'ms' ? '‚úèÔ∏è Edit Nama' : '‚úèÔ∏è Edit Name', 'qedit_name')],\n    [Markup.button.callback(lang === 'ms' ? 'üìù Edit Penerangan' : 'üìù Edit Description', 'qedit_desc')],\n    [Markup.button.callback(lang === 'ms' ? 'üîÑ Toggle Status' : 'üîÑ Toggle Status', 'qedit_toggle')],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_products_menu')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleQuickEditAction(ctx, action) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  quickEditState.set(adminId, { action, step: 'product_id' });\n  \n  const prompts = {\n    price: lang === 'ms' \n      ? `üí∞ *Edit Harga Pantas*\\n\\nSila hantar ID produk dan harga baru:\\n\\nFormat: PROD-XXXXX | HARGA\\nContoh: PROD-ABC123 | 25.50`\n      : `üí∞ *Quick Edit Price*\\n\\nPlease send product ID and new price:\\n\\nFormat: PROD-XXXXX | PRICE\\nExample: PROD-ABC123 | 25.50`,\n    stock: lang === 'ms'\n      ? `üìä *Edit Stok Pantas*\\n\\nSila hantar ID produk dan stok baru:\\n\\nFormat: PROD-XXXXX | STOK\\nContoh: PROD-ABC123 | 100`\n      : `üìä *Quick Edit Stock*\\n\\nPlease send product ID and new stock:\\n\\nFormat: PROD-XXXXX | STOCK\\nExample: PROD-ABC123 | 100`,\n    name: lang === 'ms'\n      ? `‚úèÔ∏è *Edit Nama Pantas*\\n\\nSila hantar ID produk dan nama baru:\\n\\nFormat: PROD-XXXXX | Nama Melayu | Nama Inggeris\\nContoh: PROD-ABC123 | Netflix Premium | Netflix Premium`\n      : `‚úèÔ∏è *Quick Edit Name*\\n\\nPlease send product ID and new name:\\n\\nFormat: PROD-XXXXX | Malay Name | English Name\\nExample: PROD-ABC123 | Netflix Premium | Netflix Premium`,\n    desc: lang === 'ms'\n      ? `üìù *Edit Penerangan Pantas*\\n\\nSila hantar ID produk dan penerangan baru:\\n\\nFormat: PROD-XXXXX | Penerangan Melayu | Penerangan Inggeris\\nContoh: PROD-ABC123 | Akaun 1 bulan | 1 month account`\n      : `üìù *Quick Edit Description*\\n\\nPlease send product ID and new description:\\n\\nFormat: PROD-XXXXX | Malay Description | English Description\\nExample: PROD-ABC123 | Akaun 1 bulan | 1 month account`,\n    toggle: lang === 'ms'\n      ? `üîÑ *Toggle Status Pantas*\\n\\nSila hantar ID produk untuk toggle status aktif/tidak aktif:\\n\\nFormat: PROD-XXXXX\\nContoh: PROD-ABC123`\n      : `üîÑ *Quick Toggle Status*\\n\\nPlease send product ID to toggle active/inactive status:\\n\\nFormat: PROD-XXXXX\\nExample: PROD-ABC123`\n  };\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(prompts[action], { parse_mode: 'Markdown' });\n}\n\nasync function processQuickEditInput(ctx) {\n  const userId = ctx.from.id;\n  const state = quickEditState.get(userId);\n  \n  if (!state) return;\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  const text = ctx.message.text.trim();\n  \n  const parts = text.split('|').map(p => p.trim());\n  \n  if (state.action === 'toggle') {\n    if (!parts[0].startsWith('PROD-')) {\n      await ctx.reply(\n        lang === 'ms'\n          ? `‚ùå Format tidak sah! Sila hantar ID produk sahaja.\\nContoh: PROD-ABC123`\n          : `‚ùå Invalid format! Please send product ID only.\\nExample: PROD-ABC123`\n      );\n      return;\n    }\n    \n    const products = await db.getProducts();\n    const productIdx = products.findIndex(p => p.id === parts[0]);\n    \n    if (productIdx === -1) {\n      await ctx.reply(lang === 'ms' ? '‚ùå Produk tidak dijumpai' : '‚ùå Product not found');\n      return;\n    }\n    \n    products[productIdx].active = !products[productIdx].active;\n    await db.saveProducts(products);\n    \n    quickEditState.delete(userId);\n    \n    await ctx.reply(\n      lang === 'ms'\n        ? `‚úÖ *Status dikemaskini!*\\n\\n` +\n          `üì¶ ${products[productIdx].name.ms}\\n` +\n          `Status: ${products[productIdx].active ? '‚úÖ Aktif' : '‚ùå Tidak Aktif'}`\n        : `‚úÖ *Status updated!*\\n\\n` +\n          `üì¶ ${products[productIdx].name.en || products[productIdx].name.ms}\\n` +\n          `Status: ${products[productIdx].active ? '‚úÖ Active' : '‚ùå Inactive'}`,\n      { parse_mode: 'Markdown' }\n    );\n    return;\n  }\n  \n  if (state.action === 'price' && parts.length !== 2) {\n    await ctx.reply(\n      lang === 'ms'\n        ? `‚ùå Format tidak sah!\\n\\nFormat: PROD-XXXXX | HARGA\\nContoh: PROD-ABC123 | 25.50`\n        : `‚ùå Invalid format!\\n\\nFormat: PROD-XXXXX | PRICE\\nExample: PROD-ABC123 | 25.50`\n    );\n    return;\n  }\n  \n  if (state.action === 'stock' && parts.length !== 2) {\n    await ctx.reply(\n      lang === 'ms'\n        ? `‚ùå Format tidak sah!\\n\\nFormat: PROD-XXXXX | STOK\\nContoh: PROD-ABC123 | 100`\n        : `‚ùå Invalid format!\\n\\nFormat: PROD-XXXXX | STOCK\\nExample: PROD-ABC123 | 100`\n    );\n    return;\n  }\n  \n  if ((state.action === 'name' || state.action === 'desc') && parts.length !== 3) {\n    await ctx.reply(\n      lang === 'ms'\n        ? `‚ùå Format tidak sah!\\n\\nFormat: PROD-XXXXX | Melayu | Inggeris`\n        : `‚ùå Invalid format!\\n\\nFormat: PROD-XXXXX | Malay | English`\n    );\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const productIdx = products.findIndex(p => p.id === parts[0]);\n  \n  if (productIdx === -1) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Produk tidak dijumpai' : '‚ùå Product not found');\n    return;\n  }\n  \n  let successMsg = '';\n  \n  switch (state.action) {\n    case 'price':\n      const price = parseFloat(parts[1]);\n      if (isNaN(price) || price < 0) {\n        await ctx.reply(lang === 'ms' ? '‚ùå Harga tidak sah!' : '‚ùå Invalid price!');\n        return;\n      }\n      products[productIdx].price = price;\n      successMsg = lang === 'ms'\n        ? `‚úÖ *Harga dikemaskini!*\\n\\nüì¶ ${products[productIdx].name.ms}\\nüí∞ Harga baru: RM${price}`\n        : `‚úÖ *Price updated!*\\n\\nüì¶ ${products[productIdx].name.en || products[productIdx].name.ms}\\nüí∞ New price: RM${price}`;\n      break;\n      \n    case 'stock':\n      const stock = parseInt(parts[1]);\n      if (isNaN(stock) || stock < 0) {\n        await ctx.reply(lang === 'ms' ? '‚ùå Stok tidak sah!' : '‚ùå Invalid stock!');\n        return;\n      }\n      products[productIdx].stock = stock;\n      successMsg = lang === 'ms'\n        ? `‚úÖ *Stok dikemaskini!*\\n\\nüì¶ ${products[productIdx].name.ms}\\nüìä Stok baru: ${stock}`\n        : `‚úÖ *Stock updated!*\\n\\nüì¶ ${products[productIdx].name.en || products[productIdx].name.ms}\\nüìä New stock: ${stock}`;\n      break;\n      \n    case 'name':\n      products[productIdx].name = { ms: parts[1], en: parts[2] };\n      successMsg = lang === 'ms'\n        ? `‚úÖ *Nama dikemaskini!*\\n\\nüì¶ Nama baru:\\nMelayu: ${parts[1]}\\nInggeris: ${parts[2]}`\n        : `‚úÖ *Name updated!*\\n\\nüì¶ New name:\\nMalay: ${parts[1]}\\nEnglish: ${parts[2]}`;\n      break;\n      \n    case 'desc':\n      products[productIdx].description = { ms: parts[1], en: parts[2] };\n      successMsg = lang === 'ms'\n        ? `‚úÖ *Penerangan dikemaskini!*\\n\\nüì¶ ${products[productIdx].name.ms}\\nüìù Penerangan baru disimpan`\n        : `‚úÖ *Description updated!*\\n\\nüì¶ ${products[productIdx].name.en || products[productIdx].name.ms}\\nüìù New description saved`;\n      break;\n  }\n  \n  await db.saveProducts(products);\n  quickEditState.delete(userId);\n  \n  await ctx.reply(successMsg, { parse_mode: 'Markdown' });\n}\n\nmodule.exports = {\n  handleQuickEditMenu,\n  handleQuickEditAction,\n  processQuickEditInput\n};\n","size_bytes":8573},"handlers/categoryDiscounts.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { isOwnerOrAdmin } = require('./userManagement');\n\nconst discountState = new Map();\n\nasync function handleCategoryDiscounts(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const categories = await db.getCategories();\n  const categoriesWithDiscounts = categories.filter(c => c.discount);\n  \n  const text = lang === 'ms'\n    ? `üè∑Ô∏è *Diskaun Kategori*\\n\\n` +\n      `üìä Kategori dengan diskaun: ${categoriesWithDiscounts.length}/${categories.length}\\n\\n` +\n      (categoriesWithDiscounts.length > 0\n        ? categoriesWithDiscounts.map(c => {\n            const discountText = c.discount.type === 'percentage'\n              ? `${c.discount.value}%`\n              : `RM${c.discount.value}`;\n            return `${c.icon} *${c.name.ms}*\\n   üí∞ Diskaun: ${discountText}`;\n          }).join('\\n\\n')\n        : 'üì≠ Tiada diskaun kategori aktif') +\n      `\\n\\nPilih kategori untuk urus diskaun:`\n    : `üè∑Ô∏è *Category Discounts*\\n\\n` +\n      `üìä Categories with discounts: ${categoriesWithDiscounts.length}/${categories.length}\\n\\n` +\n      (categoriesWithDiscounts.length > 0\n        ? categoriesWithDiscounts.map(c => {\n            const discountText = c.discount.type === 'percentage'\n              ? `${c.discount.value}%`\n              : `RM${c.discount.value}`;\n            return `${c.icon} *${c.name.en || c.name.ms}*\\n   üí∞ Discount: ${discountText}`;\n          }).join('\\n\\n')\n        : 'üì≠ No active category discounts') +\n      `\\n\\nSelect category to manage discount:`;\n  \n  const buttons = categories.map(c => {\n    const hasDiscount = c.discount ? 'üè∑Ô∏è ' : '';\n    return [Markup.button.callback(\n      `${hasDiscount}${c.icon} ${c.name.ms}`,\n      `cat_disc_${c.id}`\n    )];\n  });\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'cat_management')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleCategoryDiscountDetail(ctx, categoryId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const categories = await db.getCategories();\n  const category = categories.find(c => c.id === categoryId);\n  \n  if (!category) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Kategori tidak dijumpai' : 'Category not found');\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const categoryProducts = products.filter(p => p.categoryId === categoryId && p.active);\n  \n  const text = lang === 'ms'\n    ? `üè∑Ô∏è *Diskaun: ${category.icon} ${category.name.ms}*\\n\\n` +\n      `üì¶ Produk dalam kategori: ${categoryProducts.length}\\n\\n` +\n      (category.discount\n        ? `‚úÖ *Diskaun Aktif*\\n` +\n          `Jenis: ${category.discount.type === 'percentage' ? 'Peratusan' : 'Tetap'}\\n` +\n          `Nilai: ${category.discount.type === 'percentage' ? `${category.discount.value}%` : `RM${category.discount.value}`}\\n\\n` +\n          `Semua ${categoryProducts.length} produk dalam kategori ini mendapat diskaun.`\n        : `‚ùå *Tiada Diskaun*\\n\\nTambah diskaun untuk kategori ini.`) +\n      `\\n\\nPilih tindakan:`\n    : `üè∑Ô∏è *Discount: ${category.icon} ${category.name.en || category.name.ms}*\\n\\n` +\n      `üì¶ Products in category: ${categoryProducts.length}\\n\\n` +\n      (category.discount\n        ? `‚úÖ *Active Discount*\\n` +\n          `Type: ${category.discount.type === 'percentage' ? 'Percentage' : 'Fixed'}\\n` +\n          `Value: ${category.discount.type === 'percentage' ? `${category.discount.value}%` : `RM${category.discount.value}`}\\n\\n` +\n          `All ${categoryProducts.length} products in this category get discount.`\n        : `‚ùå *No Discount*\\n\\nAdd discount for this category.`) +\n      `\\n\\nChoose action:`;\n  \n  const buttons = [];\n  \n  if (category.discount) {\n    buttons.push(\n      [Markup.button.callback(lang === 'ms' ? '‚úèÔ∏è Edit Diskaun' : '‚úèÔ∏è Edit Discount', `cat_disc_edit_${categoryId}`)],\n      [Markup.button.callback(lang === 'ms' ? 'üóëÔ∏è Padam Diskaun' : 'üóëÔ∏è Remove Discount', `cat_disc_remove_${categoryId}`)]\n    );\n  } else {\n    buttons.push(\n      [Markup.button.callback(lang === 'ms' ? '‚ûï Diskaun Peratusan' : '‚ûï Percentage Discount', `cat_disc_add_pct_${categoryId}`)],\n      [Markup.button.callback(lang === 'ms' ? '‚ûï Diskaun Tetap' : '‚ûï Fixed Discount', `cat_disc_add_fix_${categoryId}`)]\n    );\n  }\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'category_discounts')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleAddCategoryDiscount(ctx, categoryId, type) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  discountState.set(adminId, { categoryId, type });\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(\n    lang === 'ms'\n      ? `üí∞ *Tambah Diskaun ${type === 'percentage' ? 'Peratusan' : 'Tetap'}*\\n\\n` +\n        (type === 'percentage'\n          ? `Sila hantar peratusan diskaun (1-100)\\nContoh: 10 untuk 10% off\\nContoh: 25 untuk 25% off`\n          : `Sila hantar nilai diskaun dalam RM\\nContoh: 5 untuk RM5 off\\nContoh: 10 untuk RM10 off`)\n      : `üí∞ *Add ${type === 'percentage' ? 'Percentage' : 'Fixed'} Discount*\\n\\n` +\n        (type === 'percentage'\n          ? `Please send discount percentage (1-100)\\nExample: 10 for 10% off\\nExample: 25 for 25% off`\n          : `Please send discount value in RM\\nExample: 5 for RM5 off\\nExample: 10 for RM10 off`),\n    { parse_mode: 'Markdown' }\n  );\n}\n\nasync function processDiscountInput(ctx) {\n  const userId = ctx.from.id;\n  const state = discountState.get(userId);\n  \n  if (!state) return;\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  const value = parseFloat(ctx.message.text.trim());\n  \n  if (isNaN(value) || value <= 0) {\n    await ctx.reply(\n      lang === 'ms'\n        ? '‚ùå Nilai tidak sah! Sila masukkan nombor yang sah.'\n        : '‚ùå Invalid value! Please enter a valid number.'\n    );\n    return;\n  }\n  \n  if (state.type === 'percentage' && value > 100) {\n    await ctx.reply(\n      lang === 'ms'\n        ? '‚ùå Peratusan mesti antara 1-100!'\n        : '‚ùå Percentage must be between 1-100!'\n    );\n    return;\n  }\n  \n  const categories = await db.getCategories();\n  const categoryIdx = categories.findIndex(c => c.id === state.categoryId);\n  \n  if (categoryIdx === -1) {\n    discountState.delete(userId);\n    await ctx.reply(lang === 'ms' ? '‚ùå Kategori tidak dijumpai' : '‚ùå Category not found');\n    return;\n  }\n  \n  categories[categoryIdx].discount = {\n    type: state.type,\n    value: value\n  };\n  \n  await db.saveCategories(categories);\n  discountState.delete(userId);\n  \n  const discountText = state.type === 'percentage' ? `${value}%` : `RM${value}`;\n  \n  await ctx.reply(\n    lang === 'ms'\n      ? `‚úÖ *Diskaun berjaya ditambah!*\\n\\n` +\n        `üè∑Ô∏è Kategori: ${categories[categoryIdx].name.ms}\\n` +\n        `üí∞ Diskaun: ${discountText}\\n\\n` +\n        `Semua produk dalam kategori ini kini mendapat diskaun ini.`\n      : `‚úÖ *Discount successfully added!*\\n\\n` +\n        `üè∑Ô∏è Category: ${categories[categoryIdx].name.en || categories[categoryIdx].name.ms}\\n` +\n        `üí∞ Discount: ${discountText}\\n\\n` +\n        `All products in this category now get this discount.`,\n    { parse_mode: 'Markdown' }\n  );\n}\n\nasync function handleRemoveCategoryDiscount(ctx, categoryId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const categories = await db.getCategories();\n  const categoryIdx = categories.findIndex(c => c.id === categoryId);\n  \n  if (categoryIdx === -1) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Kategori tidak dijumpai' : 'Category not found');\n    return;\n  }\n  \n  delete categories[categoryIdx].discount;\n  await db.saveCategories(categories);\n  \n  await ctx.answerCbQuery(\n    lang === 'ms'\n      ? '‚úÖ Diskaun dipadam'\n      : '‚úÖ Discount removed'\n  );\n  \n  await handleCategoryDiscountDetail(ctx, categoryId);\n}\n\nfunction getDiscountedPrice(product, categories) {\n  const category = categories.find(c => c.id === product.categoryId);\n  \n  if (!category || !category.discount) {\n    return product.price;\n  }\n  \n  if (category.discount.type === 'percentage') {\n    return product.price * (1 - category.discount.value / 100);\n  } else {\n    return Math.max(0, product.price - category.discount.value);\n  }\n}\n\nmodule.exports = {\n  handleCategoryDiscounts,\n  handleCategoryDiscountDetail,\n  handleAddCategoryDiscount,\n  processDiscountInput,\n  handleRemoveCategoryDiscount,\n  getDiscountedPrice\n};\n","size_bytes":9397},"handlers/scheduledPublishing.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { generateId } = require('../utils/helpers');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { isOwnerOrAdmin } = require('./userManagement');\n\nconst scheduleState = new Map();\n\nasync function handleScheduledProducts(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const scheduledProducts = products.filter(p => p.scheduledPublish && new Date(p.scheduledPublish) > new Date());\n  \n  const text = lang === 'ms'\n    ? `üìÖ *Penerbitan Berjadual*\\n\\n` +\n      `üìä Produk berjadual: ${scheduledProducts.length}\\n\\n` +\n      (scheduledProducts.length > 0\n        ? scheduledProducts.map(p => {\n            const publishDate = new Date(p.scheduledPublish);\n            return `üì¶ *${p.name.ms}*\\n` +\n                   `   Terbit: ${publishDate.toLocaleString('ms-MY')}\\n` +\n                   `   Status semasa: ${p.active ? '‚úÖ Aktif' : '‚ùå Tidak Aktif'}`;\n          }).join('\\n\\n')\n        : 'üì≠ Tiada produk berjadual') +\n      `\\n\\nProduk akan diterbitkan secara automatik pada tarikh yang ditetapkan.`\n    : `üìÖ *Scheduled Publishing*\\n\\n` +\n      `üìä Scheduled products: ${scheduledProducts.length}\\n\\n` +\n      (scheduledProducts.length > 0\n        ? scheduledProducts.map(p => {\n            const publishDate = new Date(p.scheduledPublish);\n            return `üì¶ *${p.name.en || p.name.ms}*\\n` +\n                   `   Publish: ${publishDate.toLocaleString('en-US')}\\n` +\n                   `   Current status: ${p.active ? '‚úÖ Active' : '‚ùå Inactive'}`;\n          }).join('\\n\\n')\n        : 'üì≠ No scheduled products') +\n      `\\n\\nProducts will be automatically published on the scheduled date.`;\n  \n  const buttons = scheduledProducts.slice(0, 10).map(p => [\n    Markup.button.callback(\n      `${p.name.ms} - ${new Date(p.scheduledPublish).toLocaleDateString()}`,\n      `sched_detail_${p.id}`\n    )\n  ]);\n  \n  buttons.push([Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_products_menu')]);\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleScheduleProduct(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Produk tidak dijumpai' : 'Product not found');\n    return;\n  }\n  \n  scheduleState.set(adminId, { productId, step: 'datetime' });\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(\n    lang === 'ms'\n      ? `üìÖ *Jadualkan Penerbitan Produk*\\n\\n` +\n        `Produk: ${product.name.ms}\\n\\n` +\n        `Sila hantar tarikh dan masa untuk terbitkan produk secara automatik.\\n\\n` +\n        `Format: DD/MM/YYYY HH:MM\\n` +\n        `Contoh: 31/12/2025 23:59\\n` +\n        `Contoh: 15/11/2025 09:00`\n      : `üìÖ *Schedule Product Publishing*\\n\\n` +\n        `Product: ${product.name.en || product.name.ms}\\n\\n` +\n        `Please send date and time to automatically publish the product.\\n\\n` +\n        `Format: DD/MM/YYYY HH:MM\\n` +\n        `Example: 31/12/2025 23:59\\n` +\n        `Example: 15/11/2025 09:00`,\n    { parse_mode: 'Markdown' }\n  );\n}\n\nasync function processScheduleInput(ctx) {\n  const userId = ctx.from.id;\n  const state = scheduleState.get(userId);\n  \n  if (!state) return;\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  const text = ctx.message.text.trim();\n  \n  const dateRegex = /^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})\\s+(\\d{1,2}):(\\d{2})$/;\n  const match = text.match(dateRegex);\n  \n  if (!match) {\n    await ctx.reply(\n      lang === 'ms'\n        ? `‚ùå Format tarikh tidak sah!\\n\\nFormat: DD/MM/YYYY HH:MM\\nContoh: 31/12/2025 23:59`\n        : `‚ùå Invalid date format!\\n\\nFormat: DD/MM/YYYY HH:MM\\nExample: 31/12/2025 23:59`\n    );\n    return;\n  }\n  \n  const [, day, month, year, hour, minute] = match;\n  const scheduledDate = new Date(year, month - 1, day, hour, minute);\n  \n  if (isNaN(scheduledDate.getTime())) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Tarikh tidak sah!' : '‚ùå Invalid date!');\n    return;\n  }\n  \n  if (scheduledDate <= new Date()) {\n    await ctx.reply(\n      lang === 'ms'\n        ? '‚ùå Tarikh mesti pada masa hadapan!'\n        : '‚ùå Date must be in the future!'\n    );\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const productIdx = products.findIndex(p => p.id === state.productId);\n  \n  if (productIdx === -1) {\n    scheduleState.delete(userId);\n    await ctx.reply(lang === 'ms' ? '‚ùå Produk tidak dijumpai' : '‚ùå Product not found');\n    return;\n  }\n  \n  products[productIdx].scheduledPublish = scheduledDate.toISOString();\n  products[productIdx].active = false;\n  await db.saveProducts(products);\n  \n  scheduleState.delete(userId);\n  \n  await ctx.reply(\n    lang === 'ms'\n      ? `‚úÖ *Penerbitan dijadualkan!*\\n\\n` +\n        `üì¶ Produk: ${products[productIdx].name.ms}\\n` +\n        `üìÖ Akan diterbitkan: ${scheduledDate.toLocaleString('ms-MY')}\\n\\n` +\n        `Produk akan diaktifkan secara automatik pada masa yang ditetapkan.`\n      : `‚úÖ *Publishing scheduled!*\\n\\n` +\n        `üì¶ Product: ${products[productIdx].name.en || products[productIdx].name.ms}\\n` +\n        `üìÖ Will be published: ${scheduledDate.toLocaleString('en-US')}\\n\\n` +\n        `Product will be automatically activated at the scheduled time.`,\n    { parse_mode: 'Markdown' }\n  );\n}\n\nasync function handleCancelSchedule(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const productIdx = products.findIndex(p => p.id === productId);\n  \n  if (productIdx === -1) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Produk tidak dijumpai' : 'Product not found');\n    return;\n  }\n  \n  delete products[productIdx].scheduledPublish;\n  await db.saveProducts(products);\n  \n  await ctx.answerCbQuery(\n    lang === 'ms'\n      ? '‚úÖ Jadual penerbitan dibatalkan'\n      : '‚úÖ Publishing schedule cancelled'\n  );\n  \n  await handleScheduledProducts(ctx);\n}\n\nasync function checkScheduledProducts(bot) {\n  try {\n    const products = await db.getProducts();\n    const now = new Date();\n    \n    let publishedCount = 0;\n    \n    for (let i = 0; i < products.length; i++) {\n      if (products[i].scheduledPublish) {\n        const scheduledDate = new Date(products[i].scheduledPublish);\n        \n        if (scheduledDate <= now && !products[i].active) {\n          products[i].active = true;\n          delete products[i].scheduledPublish;\n          publishedCount++;\n          \n          const admins = await db.getAdmins();\n          const settings = await db.getSettings();\n          const ownerId = settings.ownerId;\n          \n          if (ownerId) {\n            try {\n              await bot.telegram.sendMessage(\n                ownerId,\n                `üìÖ *Produk Diterbitkan Secara Automatik*\\n\\n` +\n                `üì¶ ${products[i].name.ms}\\n` +\n                `üí∞ RM${products[i].price}\\n\\n` +\n                `Produk telah diaktifkan mengikut jadual.`,\n                { parse_mode: 'Markdown' }\n              );\n            } catch (err) {\n              console.log('Could not notify owner:', err.message);\n            }\n          }\n        }\n      }\n    }\n    \n    if (publishedCount > 0) {\n      await db.saveProducts(products);\n      console.log(`‚úÖ ${publishedCount} scheduled product(s) published`);\n    }\n  } catch (error) {\n    console.error('Error checking scheduled products:', error);\n  }\n}\n\nmodule.exports = {\n  handleScheduledProducts,\n  handleScheduleProduct,\n  processScheduleInput,\n  handleCancelSchedule,\n  checkScheduledProducts\n};\n","size_bytes":8311},"handlers/productImageManagement.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { isOwnerOrAdmin } = require('./userManagement');\nconst path = require('path');\nconst fs = require('fs-extra');\n\nconst imageState = new Map();\n\nasync function handleProductImages(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Produk tidak dijumpai' : 'Product not found');\n    return;\n  }\n  \n  const images = product.images || [];\n  \n  const text = lang === 'ms'\n    ? `üñºÔ∏è *Pengurusan Imej: ${product.name.ms}*\\n\\n` +\n      `üì∏ Imej sedia ada: ${images.length}\\n\\n` +\n      (images.length > 0\n        ? `Imej produk:\\n` + images.map((img, i) => `${i + 1}. ${img.filename || 'image.jpg'}`).join('\\n')\n        : 'üì≠ Tiada imej lagi\\n\\n' +\n          'Tambah imej produk untuk menarik pelanggan!') +\n      `\\n\\nPilih tindakan:`\n    : `üñºÔ∏è *Image Management: ${product.name.en || product.name.ms}*\\n\\n` +\n      `üì∏ Existing images: ${images.length}\\n\\n` +\n      (images.length > 0\n        ? `Product images:\\n` + images.map((img, i) => `${i + 1}. ${img.filename || 'image.jpg'}`).join('\\n')\n        : 'üì≠ No images yet\\n\\n' +\n          'Add product images to attract customers!') +\n      `\\n\\nChoose action:`;\n  \n  const buttons = [];\n  \n  if (images.length > 0) {\n    buttons.push([Markup.button.callback(lang === 'ms' ? 'üëÅÔ∏è Lihat Imej' : 'üëÅÔ∏è View Images', `img_view_${productId}`)]);\n    images.forEach((img, index) => {\n      buttons.push([Markup.button.callback(\n        `üóëÔ∏è ${lang === 'ms' ? 'Padam' : 'Delete'} ${index + 1}`,\n        `img_delete_${productId}_${index}`\n      )]);\n    });\n  }\n  \n  buttons.push(\n    [Markup.button.callback(lang === 'ms' ? '‚ûï Tambah Imej' : '‚ûï Add Image', `img_add_${productId}`)],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', `prod_detail_${productId}`)]\n  );\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleAddProductImage(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  imageState.set(adminId, { productId, action: 'add' });\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(\n    lang === 'ms'\n      ? `üì∏ *Tambah Imej Produk*\\n\\n` +\n        `Sila hantar imej produk (format: JPG, PNG)\\n\\n` +\n        `Tips:\\n` +\n        `‚Ä¢ Gunakan imej berkualiti tinggi\\n` +\n        `‚Ä¢ Saiz disyorkan: 800x800px\\n` +\n        `‚Ä¢ Latar belakang bersih\\n` +\n        `‚Ä¢ Tunjukkan produk dengan jelas`\n      : `üì∏ *Add Product Image*\\n\\n` +\n        `Please send product image (format: JPG, PNG)\\n\\n` +\n        `Tips:\\n` +\n        `‚Ä¢ Use high quality images\\n` +\n        `‚Ä¢ Recommended size: 800x800px\\n` +\n        `‚Ä¢ Clean background\\n` +\n        `‚Ä¢ Show product clearly`,\n    { parse_mode: 'Markdown' }\n  );\n}\n\nasync function processProductImage(ctx) {\n  const userId = ctx.from.id;\n  const state = imageState.get(userId);\n  \n  if (!state) return;\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  if (!ctx.message.photo) {\n    await ctx.reply(\n      lang === 'ms'\n        ? '‚ùå Sila hantar imej (foto)'\n        : '‚ùå Please send an image (photo)'\n    );\n    return;\n  }\n  \n  try {\n    const photo = ctx.message.photo[ctx.message.photo.length - 1];\n    const file = await ctx.telegram.getFile(photo.file_id);\n    const fileExtension = file.file_path.split('.').pop();\n    const filename = `${state.productId}_${Date.now()}.${fileExtension}`;\n    const filePath = path.join('./media/products', filename);\n    \n    await fs.ensureDir('./media/products');\n    \n    const fileUrl = `https://api.telegram.org/file/bot${ctx.botInfo.token}/${file.file_path}`;\n    const fetch = require('node-fetch');\n    const response = await fetch(fileUrl);\n    const buffer = await response.buffer();\n    \n    await fs.writeFile(filePath, buffer);\n    \n    const products = await db.getProducts();\n    const productIdx = products.findIndex(p => p.id === state.productId);\n    \n    if (productIdx === -1) {\n      imageState.delete(userId);\n      await ctx.reply(lang === 'ms' ? '‚ùå Produk tidak dijumpai' : '‚ùå Product not found');\n      return;\n    }\n    \n    if (!products[productIdx].images) {\n      products[productIdx].images = [];\n    }\n    \n    products[productIdx].images.push({\n      filename: filename,\n      fileId: photo.file_id,\n      path: filePath,\n      uploadedAt: new Date().toISOString(),\n      uploadedBy: userId\n    });\n    \n    await db.saveProducts(products);\n    imageState.delete(userId);\n    \n    await ctx.reply(\n      lang === 'ms'\n        ? `‚úÖ *Imej berjaya ditambah!*\\n\\n` +\n          `üì¶ Produk: ${products[productIdx].name.ms}\\n` +\n          `üì∏ Jumlah imej: ${products[productIdx].images.length}`\n        : `‚úÖ *Image successfully added!*\\n\\n` +\n          `üì¶ Product: ${products[productIdx].name.en || products[productIdx].name.ms}\\n` +\n          `üì∏ Total images: ${products[productIdx].images.length}`,\n      { parse_mode: 'Markdown' }\n    );\n    \n  } catch (error) {\n    console.error('Error processing image:', error);\n    await ctx.reply(\n      lang === 'ms'\n        ? '‚ùå Ralat memproses imej. Sila cuba lagi.'\n        : '‚ùå Error processing image. Please try again.'\n    );\n  }\n}\n\nasync function handleViewProductImages(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product || !product.images || product.images.length === 0) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Tiada imej' : 'No images');\n    return;\n  }\n  \n  await ctx.answerCbQuery();\n  \n  for (let i = 0; i < product.images.length; i++) {\n    const img = product.images[i];\n    try {\n      await ctx.replyWithPhoto(img.fileId, {\n        caption: lang === 'ms'\n          ? `üì∏ Imej ${i + 1}/${product.images.length}\\nüì¶ ${product.name.ms}`\n          : `üì∏ Image ${i + 1}/${product.images.length}\\nüì¶ ${product.name.en || product.name.ms}`\n      });\n    } catch (error) {\n      console.error('Error sending image:', error);\n    }\n  }\n}\n\nasync function handleDeleteProductImage(ctx, productId, imageIndex) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const productIdx = products.findIndex(p => p.id === productId);\n  \n  if (productIdx === -1 || !products[productIdx].images || !products[productIdx].images[imageIndex]) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Imej tidak dijumpai' : 'Image not found');\n    return;\n  }\n  \n  const image = products[productIdx].images[imageIndex];\n  \n  try {\n    if (image.path && await fs.pathExists(image.path)) {\n      await fs.unlink(image.path);\n    }\n  } catch (error) {\n    console.error('Error deleting image file:', error);\n  }\n  \n  products[productIdx].images.splice(imageIndex, 1);\n  await db.saveProducts(products);\n  \n  await ctx.answerCbQuery(\n    lang === 'ms'\n      ? '‚úÖ Imej dipadam'\n      : '‚úÖ Image deleted'\n  );\n  \n  await handleProductImages(ctx, productId);\n}\n\nmodule.exports = {\n  handleProductImages,\n  handleAddProductImage,\n  processProductImage,\n  handleViewProductImages,\n  handleDeleteProductImage\n};\n","size_bytes":8154},"handlers/advancedOrderFilter.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { isOwnerOrAdmin } = require('./userManagement');\n\nconst filterState = new Map();\n\nasync function handleAdvancedOrderFilters(ctx) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const text = lang === 'ms'\n    ? `üìÖ *Tapis Pesanan Lanjutan*\\n\\n` +\n      `Pilih julat tarikh untuk tapis pesanan:`\n    : `üìÖ *Advanced Order Filters*\\n\\n` +\n      `Select date range to filter orders:`;\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üìÖ Hari Ini' : 'üìÖ Today', 'filter_date_today')],\n    [Markup.button.callback(lang === 'ms' ? 'üìÜ Semalam' : 'üìÜ Yesterday', 'filter_date_yesterday')],\n    [Markup.button.callback(lang === 'ms' ? 'üìÖ Minggu Ini' : 'üìÖ This Week', 'filter_date_week')],\n    [Markup.button.callback(lang === 'ms' ? 'üìÖ Bulan Ini' : 'üìÖ This Month', 'filter_date_month')],\n    [Markup.button.callback(lang === 'ms' ? 'üìÖ 7 Hari Lepas' : 'üìÖ Last 7 Days', 'filter_date_7days')],\n    [Markup.button.callback(lang === 'ms' ? 'üìÖ 30 Hari Lepas' : 'üìÖ Last 30 Days', 'filter_date_30days')],\n    [Markup.button.callback(lang === 'ms' ? 'üìÖ Julat Tersuai' : 'üìÖ Custom Range', 'filter_date_custom')],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'admin_orders')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleDateFilter(ctx, filterType) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  if (filterType === 'custom') {\n    filterState.set(adminId, { step: 'start_date' });\n    \n    await ctx.answerCbQuery();\n    await ctx.reply(\n      lang === 'ms'\n        ? `üìÖ *Julat Tarikh Tersuai*\\n\\n` +\n          `Sila hantar tarikh mula:\\n\\n` +\n          `Format: DD/MM/YYYY\\n` +\n          `Contoh: 01/11/2025`\n        : `üìÖ *Custom Date Range*\\n\\n` +\n          `Please send start date:\\n\\n` +\n          `Format: DD/MM/YYYY\\n` +\n          `Example: 01/11/2025`,\n      { parse_mode: 'Markdown' }\n    );\n    return;\n  }\n  \n  const { startDate, endDate } = getDateRange(filterType);\n  await showFilteredOrders(ctx, startDate, endDate, filterType);\n}\n\nfunction getDateRange(filterType) {\n  const now = new Date();\n  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n  \n  let startDate, endDate;\n  \n  switch (filterType) {\n    case 'today':\n      startDate = today;\n      endDate = new Date(today.getTime() + 24 * 60 * 60 * 1000);\n      break;\n      \n    case 'yesterday':\n      startDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);\n      endDate = today;\n      break;\n      \n    case 'week':\n      const dayOfWeek = today.getDay();\n      const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);\n      startDate = new Date(today.setDate(diff));\n      endDate = new Date();\n      break;\n      \n    case 'month':\n      startDate = new Date(now.getFullYear(), now.getMonth(), 1);\n      endDate = new Date();\n      break;\n      \n    case '7days':\n      startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);\n      endDate = new Date();\n      break;\n      \n    case '30days':\n      startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);\n      endDate = new Date();\n      break;\n      \n    default:\n      startDate = new Date(0);\n      endDate = new Date();\n  }\n  \n  return { startDate, endDate };\n}\n\nasync function showFilteredOrders(ctx, startDate, endDate, filterType) {\n  const adminId = ctx.from.id;\n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const filteredOrders = transactions.filter(t => {\n    const orderDate = new Date(t.createdAt);\n    return orderDate >= startDate && orderDate <= endDate;\n  });\n  \n  const pendingOrders = filteredOrders.filter(t => t.status === 'pending');\n  const verifiedOrders = filteredOrders.filter(t => t.status === 'verified');\n  const rejectedOrders = filteredOrders.filter(t => t.status === 'rejected');\n  \n  const totalRevenue = verifiedOrders.reduce((sum, t) => sum + (t.amount || 0), 0);\n  \n  const filterLabel = {\n    today: lang === 'ms' ? 'Hari Ini' : 'Today',\n    yesterday: lang === 'ms' ? 'Semalam' : 'Yesterday',\n    week: lang === 'ms' ? 'Minggu Ini' : 'This Week',\n    month: lang === 'ms' ? 'Bulan Ini' : 'This Month',\n    '7days': lang === 'ms' ? '7 Hari Lepas' : 'Last 7 Days',\n    '30days': lang === 'ms' ? '30 Hari Lepas' : 'Last 30 Days',\n    custom: lang === 'ms' ? 'Julat Tersuai' : 'Custom Range'\n  }[filterType] || '';\n  \n  const text = lang === 'ms'\n    ? `üìä *Laporan Pesanan: ${filterLabel}*\\n\\n` +\n      `üìÖ Dari: ${startDate.toLocaleDateString('ms-MY')}\\n` +\n      `üìÖ Hingga: ${endDate.toLocaleDateString('ms-MY')}\\n\\n` +\n      `üì¶ *Ringkasan:*\\n` +\n      `Jumlah Pesanan: ${filteredOrders.length}\\n` +\n      `‚è≥ Pending: ${pendingOrders.length}\\n` +\n      `‚úÖ Disahkan: ${verifiedOrders.length}\\n` +\n      `‚ùå Ditolak: ${rejectedOrders.length}\\n\\n` +\n      `üí∞ Jumlah Hasil: RM${totalRevenue.toFixed(2)}\\n\\n` +\n      (filteredOrders.length > 0\n        ? `üìã *Pesanan Terkini:*\\n\\n` +\n          filteredOrders.slice(0, 10).map((order, i) => {\n            const statusIcon = order.status === 'verified' ? '‚úÖ' : order.status === 'pending' ? '‚è≥' : '‚ùå';\n            const date = new Date(order.createdAt).toLocaleString('ms-MY');\n            return `${i + 1}. ${statusIcon} \\`${order.id}\\`\\n   üí∞ RM${order.amount} | ${date}`;\n          }).join('\\n\\n')\n        : 'üì≠ Tiada pesanan dalam julat ini')\n    : `üìä *Order Report: ${filterLabel}*\\n\\n` +\n      `üìÖ From: ${startDate.toLocaleDateString('en-US')}\\n` +\n      `üìÖ To: ${endDate.toLocaleDateString('en-US')}\\n\\n` +\n      `üì¶ *Summary:*\\n` +\n      `Total Orders: ${filteredOrders.length}\\n` +\n      `‚è≥ Pending: ${pendingOrders.length}\\n` +\n      `‚úÖ Verified: ${verifiedOrders.length}\\n` +\n      `‚ùå Rejected: ${rejectedOrders.length}\\n\\n` +\n      `üí∞ Total Revenue: RM${totalRevenue.toFixed(2)}\\n\\n` +\n      (filteredOrders.length > 0\n        ? `üìã *Recent Orders:*\\n\\n` +\n          filteredOrders.slice(0, 10).map((order, i) => {\n            const statusIcon = order.status === 'verified' ? '‚úÖ' : order.status === 'pending' ? '‚è≥' : '‚ùå';\n            const date = new Date(order.createdAt).toLocaleString('en-US');\n            return `${i + 1}. ${statusIcon} \\`${order.id}\\`\\n   üí∞ RM${order.amount} | ${date}`;\n          }).join('\\n\\n')\n        : 'üì≠ No orders in this range');\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üìä Export Data' : 'üìä Export Data', `export_orders_${filterType}`)],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', 'adv_order_filters')]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function processCustomDateInput(ctx) {\n  const userId = ctx.from.id;\n  const state = filterState.get(userId);\n  \n  if (!state) return;\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  const text = ctx.message.text.trim();\n  \n  const dateRegex = /^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})$/;\n  const match = text.match(dateRegex);\n  \n  if (!match) {\n    await ctx.reply(\n      lang === 'ms'\n        ? `‚ùå Format tarikh tidak sah!\\n\\nFormat: DD/MM/YYYY\\nContoh: 01/11/2025`\n        : `‚ùå Invalid date format!\\n\\nFormat: DD/MM/YYYY\\nExample: 01/11/2025`\n    );\n    return;\n  }\n  \n  const [, day, month, year] = match;\n  const date = new Date(year, month - 1, day);\n  \n  if (isNaN(date.getTime())) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Tarikh tidak sah!' : '‚ùå Invalid date!');\n    return;\n  }\n  \n  if (state.step === 'start_date') {\n    state.startDate = date;\n    state.step = 'end_date';\n    \n    await ctx.reply(\n      lang === 'ms'\n        ? `‚úÖ Tarikh mula: ${date.toLocaleDateString('ms-MY')}\\n\\n` +\n          `Sila hantar tarikh akhir:\\n\\n` +\n          `Format: DD/MM/YYYY\\n` +\n          `Contoh: 30/11/2025`\n        : `‚úÖ Start date: ${date.toLocaleDateString('en-US')}\\n\\n` +\n          `Please send end date:\\n\\n` +\n          `Format: DD/MM/YYYY\\n` +\n          `Example: 30/11/2025`\n    );\n    \n  } else if (state.step === 'end_date') {\n    if (date < state.startDate) {\n      await ctx.reply(\n        lang === 'ms'\n          ? '‚ùå Tarikh akhir mestilah selepas tarikh mula!'\n          : '‚ùå End date must be after start date!'\n      );\n      return;\n    }\n    \n    const startDate = state.startDate;\n    const endDate = new Date(date.getTime() + 24 * 60 * 60 * 1000);\n    \n    filterState.delete(userId);\n    \n    await showFilteredOrders(ctx, startDate, endDate, 'custom');\n  }\n}\n\nmodule.exports = {\n  handleAdvancedOrderFilters,\n  handleDateFilter,\n  processCustomDateInput,\n  showFilteredOrders,\n  getDateRange\n};\n","size_bytes":9305},"handlers/reviewRating.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { generateId } = require('../utils/helpers');\nconst { safeEditMessage } = require('../utils/messageHelper');\n\nconst reviewState = new Map();\n\nasync function handleProductReviews(ctx, productId) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Produk tidak dijumpai' : 'Product not found');\n    return;\n  }\n  \n  const reviews = product.reviews || [];\n  const avgRating = reviews.length > 0\n    ? (reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length).toFixed(1)\n    : 0;\n  \n  const ratingDistribution = {\n    5: reviews.filter(r => r.rating === 5).length,\n    4: reviews.filter(r => r.rating === 4).length,\n    3: reviews.filter(r => r.rating === 3).length,\n    2: reviews.filter(r => r.rating === 2).length,\n    1: reviews.filter(r => r.rating === 1).length\n  };\n  \n  const text = lang === 'ms'\n    ? `‚≠ê *Ulasan: ${product.name.ms}*\\n\\n` +\n      `üìä Penilaian Purata: ${avgRating}/5.0 ‚≠ê\\n` +\n      `üìù Jumlah Ulasan: ${reviews.length}\\n\\n` +\n      `üìà *Taburan Penilaian:*\\n` +\n      `‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (${ratingDistribution[5]})\\n` +\n      `‚≠ê‚≠ê‚≠ê‚≠ê (${ratingDistribution[4]})\\n` +\n      `‚≠ê‚≠ê‚≠ê (${ratingDistribution[3]})\\n` +\n      `‚≠ê‚≠ê (${ratingDistribution[2]})\\n` +\n      `‚≠ê (${ratingDistribution[1]})\\n\\n` +\n      (reviews.length > 0\n        ? `üìã *Ulasan Terkini:*\\n\\n` +\n          reviews.slice(0, 5).map((r, i) => {\n            const stars = '‚≠ê'.repeat(r.rating);\n            const userName = r.userName || 'Pengguna';\n            const date = new Date(r.createdAt).toLocaleDateString('ms-MY');\n            return `${i + 1}. ${stars} - ${userName}\\n   \"${r.comment}\"\\n   üìÖ ${date}`;\n          }).join('\\n\\n')\n        : 'üì≠ Tiada ulasan lagi')\n    : `‚≠ê *Reviews: ${product.name.en || product.name.ms}*\\n\\n` +\n      `üìä Average Rating: ${avgRating}/5.0 ‚≠ê\\n` +\n      `üìù Total Reviews: ${reviews.length}\\n\\n` +\n      `üìà *Rating Distribution:*\\n` +\n      `‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (${ratingDistribution[5]})\\n` +\n      `‚≠ê‚≠ê‚≠ê‚≠ê (${ratingDistribution[4]})\\n` +\n      `‚≠ê‚≠ê‚≠ê (${ratingDistribution[3]})\\n` +\n      `‚≠ê‚≠ê (${ratingDistribution[2]})\\n` +\n      `‚≠ê (${ratingDistribution[1]})\\n\\n` +\n      (reviews.length > 0\n        ? `üìã *Recent Reviews:*\\n\\n` +\n          reviews.slice(0, 5).map((r, i) => {\n            const stars = '‚≠ê'.repeat(r.rating);\n            const userName = r.userName || 'User';\n            const date = new Date(r.createdAt).toLocaleDateString('en-US');\n            return `${i + 1}. ${stars} - ${userName}\\n   \"${r.comment}\"\\n   üìÖ ${date}`;\n          }).join('\\n\\n')\n        : 'üì≠ No reviews yet');\n  \n  const buttons = [\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', `prod_view_${productId}`)]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function requestReview(ctx, orderId) {\n  const user = await db.getUser(ctx.from.id);\n  const lang = user?.language || 'ms';\n  \n  const transactions = await db.getTransactions();\n  const order = transactions.find(t => t.id === orderId);\n  \n  if (!order || order.userId !== ctx.from.id) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Pesanan tidak dijumpai' : '‚ùå Order not found');\n    return;\n  }\n  \n  if (order.status !== 'verified') {\n    await ctx.reply(\n      lang === 'ms'\n        ? '‚ùå Anda hanya boleh ulas pesanan yang telah disahkan'\n        : '‚ùå You can only review verified orders'\n    );\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === order.productId);\n  \n  if (!product) {\n    await ctx.reply(lang === 'ms' ? '‚ùå Produk tidak dijumpai' : '‚ùå Product not found');\n    return;\n  }\n  \n  const alreadyReviewed = product.reviews?.some(r => r.orderId === orderId);\n  if (alreadyReviewed) {\n    await ctx.reply(\n      lang === 'ms'\n        ? '‚ùå Anda sudah mengulas pesanan ini'\n        : '‚ùå You have already reviewed this order'\n    );\n    return;\n  }\n  \n  const text = lang === 'ms'\n    ? `‚≠ê *Ulas Produk*\\n\\n` +\n      `üì¶ ${product.name.ms}\\n\\n` +\n      `Bagaimana pengalaman anda dengan produk ini?\\n` +\n      `Pilih penilaian anda:`\n    : `‚≠ê *Review Product*\\n\\n` +\n      `üì¶ ${product.name.en || product.name.ms}\\n\\n` +\n      `How was your experience with this product?\\n` +\n      `Choose your rating:`;\n  \n  const buttons = [\n    [Markup.button.callback('‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)', `review_rate_${orderId}_5`)],\n    [Markup.button.callback('‚≠ê‚≠ê‚≠ê‚≠ê (4)', `review_rate_${orderId}_4`)],\n    [Markup.button.callback('‚≠ê‚≠ê‚≠ê (3)', `review_rate_${orderId}_3`)],\n    [Markup.button.callback('‚≠ê‚≠ê (2)', `review_rate_${orderId}_2`)],\n    [Markup.button.callback('‚≠ê (1)', `review_rate_${orderId}_1`)]\n  ];\n  \n  await ctx.reply(text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleRatingSelect(ctx, orderId, rating) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  reviewState.set(userId, { orderId, rating });\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(\n    lang === 'ms'\n      ? `‚≠ê Penilaian: ${'‚≠ê'.repeat(rating)}\\n\\nüìù Sila hantar ulasan anda (atau hantar 'skip' untuk langkau)`\n      : `‚≠ê Rating: ${'‚≠ê'.repeat(rating)}\\n\\nüìù Please send your review (or send 'skip' to skip)`,\n    { parse_mode: 'Markdown' }\n  );\n}\n\nasync function processReviewComment(ctx) {\n  const userId = ctx.from.id;\n  const state = reviewState.get(userId);\n  \n  if (!state) return;\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  const comment = ctx.message.text.trim();\n  \n  const transactions = await db.getTransactions();\n  const order = transactions.find(t => t.id === state.orderId);\n  \n  if (!order || order.userId !== userId) {\n    reviewState.delete(userId);\n    await ctx.reply(lang === 'ms' ? '‚ùå Pesanan tidak dijumpai' : '‚ùå Order not found');\n    return;\n  }\n  \n  const products = await db.getProducts();\n  const productIdx = products.findIndex(p => p.id === order.productId);\n  \n  if (productIdx === -1) {\n    reviewState.delete(userId);\n    await ctx.reply(lang === 'ms' ? '‚ùå Produk tidak dijumpai' : '‚ùå Product not found');\n    return;\n  }\n  \n  if (!products[productIdx].reviews) {\n    products[productIdx].reviews = [];\n  }\n  \n  const review = {\n    id: generateId('REV'),\n    orderId: state.orderId,\n    userId: userId,\n    userName: user.firstName || 'User',\n    rating: state.rating,\n    comment: comment.toLowerCase() === 'skip' ? '' : comment,\n    createdAt: new Date().toISOString()\n  };\n  \n  products[productIdx].reviews.push(review);\n  await db.saveProducts(products);\n  \n  reviewState.delete(userId);\n  \n  await ctx.reply(\n    lang === 'ms'\n      ? `‚úÖ *Terima kasih atas ulasan anda!*\\n\\n` +\n        `‚≠ê Penilaian: ${'‚≠ê'.repeat(state.rating)}\\n` +\n        (review.comment ? `üìù Ulasan: \"${review.comment}\"\\n\\n` : '\\n') +\n        `Ulasan anda membantu pelanggan lain membuat keputusan yang lebih baik.`\n      : `‚úÖ *Thank you for your review!*\\n\\n` +\n        `‚≠ê Rating: ${'‚≠ê'.repeat(state.rating)}\\n` +\n        (review.comment ? `üìù Review: \"${review.comment}\"\\n\\n` : '\\n') +\n        `Your review helps other customers make better decisions.`,\n    { parse_mode: 'Markdown' }\n  );\n}\n\nasync function handleViewAllReviews(ctx) {\n  const userId = ctx.from.id;\n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const allReviews = [];\n  \n  products.forEach(product => {\n    if (product.reviews && product.reviews.length > 0) {\n      product.reviews.forEach(review => {\n        allReviews.push({\n          ...review,\n          productName: product.name,\n          productId: product.id\n        });\n      });\n    }\n  });\n  \n  allReviews.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\n  \n  const text = lang === 'ms'\n    ? `üìã *Semua Ulasan*\\n\\n` +\n      `Jumlah: ${allReviews.length} ulasan\\n\\n` +\n      (allReviews.length > 0\n        ? allReviews.slice(0, 10).map((r, i) => {\n            const stars = '‚≠ê'.repeat(r.rating);\n            const date = new Date(r.createdAt).toLocaleDateString('ms-MY');\n            return `${i + 1}. ${stars} - ${r.userName}\\n` +\n                   `   üì¶ ${r.productName.ms}\\n` +\n                   (r.comment ? `   \"${r.comment}\"\\n` : '') +\n                   `   üìÖ ${date}`;\n          }).join('\\n\\n')\n        : 'üì≠ Tiada ulasan lagi')\n    : `üìã *All Reviews*\\n\\n` +\n      `Total: ${allReviews.length} reviews\\n\\n` +\n      (allReviews.length > 0\n        ? allReviews.slice(0, 10).map((r, i) => {\n            const stars = '‚≠ê'.repeat(r.rating);\n            const date = new Date(r.createdAt).toLocaleDateString('en-US');\n            return `${i + 1}. ${stars} - ${r.userName}\\n` +\n                   `   üì¶ ${r.productName.en || r.productName.ms}\\n` +\n                   (r.comment ? `   \"${r.comment}\"\\n` : '') +\n                   `   üìÖ ${date}`;\n          }).join('\\n\\n')\n        : 'üì≠ No reviews yet');\n  \n  await ctx.reply(text, { parse_mode: 'Markdown' });\n}\n\nmodule.exports = {\n  handleProductReviews,\n  requestReview,\n  handleRatingSelect,\n  processReviewComment,\n  handleViewAllReviews\n};\n","size_bytes":9558},"handlers/productOptions.js":{"content":"const { Markup } = require('telegraf');\nconst db = require('../utils/database');\nconst { generateId } = require('../utils/helpers');\nconst { safeEditMessage } = require('../utils/messageHelper');\nconst { isOwnerOrAdmin } = require('./userManagement');\n\nconst optionEditState = new Map();\n\nasync function handleProductOptions(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Produk tidak dijumpai' : 'Product not found');\n    return;\n  }\n  \n  const options = product.options || [];\n  \n  const text = lang === 'ms'\n    ? `üé® *Pilihan Produk: ${product.name.ms}*\\n\\n` +\n      `üìã Pilihan sedia ada: ${options.length}\\n\\n` +\n      `Pilihan produk membolehkan pelanggan memilih varian seperti saiz, warna, dll.\\n\\n` +\n      (options.length > 0 \n        ? options.map((opt, i) => `${i + 1}. *${opt.name.ms}*\\n   Pilihan: ${opt.values.join(', ')}\\n   ${opt.required ? '‚ö†Ô∏è Wajib' : 'üìå Opsional'} | ${opt.priceModifier ? `+RM${opt.priceModifier}` : 'Tiada caj tambahan'}`).join('\\n\\n')\n        : 'üì≠ Tiada pilihan lagi') +\n      `\\n\\nPilih tindakan:`\n    : `üé® *Product Options: ${product.name.en || product.name.ms}*\\n\\n` +\n      `üìã Existing options: ${options.length}\\n\\n` +\n      `Product options allow customers to select variants like size, color, etc.\\n\\n` +\n      (options.length > 0 \n        ? options.map((opt, i) => `${i + 1}. *${opt.name.en || opt.name.ms}*\\n   Values: ${opt.values.join(', ')}\\n   ${opt.required ? '‚ö†Ô∏è Required' : 'üìå Optional'} | ${opt.priceModifier ? `+RM${opt.priceModifier}` : 'No extra charge'}`).join('\\n\\n')\n        : 'üì≠ No options yet') +\n      `\\n\\nChoose action:`;\n  \n  const buttons = [];\n  \n  options.forEach((opt, index) => {\n    buttons.push([Markup.button.callback(\n      `${opt.name.ms} - ${lang === 'ms' ? 'Edit/Padam' : 'Edit/Delete'}`,\n      `opt_detail_${productId}_${index}`\n    )]);\n  });\n  \n  buttons.push(\n    [Markup.button.callback(lang === 'ms' ? '‚ûï Tambah Pilihan' : '‚ûï Add Option', `opt_add_${productId}`)],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', `prod_detail_${productId}`)]\n  );\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleAddOption(ctx, productId) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  optionEditState.set(adminId, { productId, step: 'name' });\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(\n    lang === 'ms'\n      ? `‚ûï *Tambah Pilihan Produk*\\n\\nSila hantar nama pilihan (contoh: Saiz, Warna, Tempoh Langganan)\\n\\nFormat: Nama Melayu | Nama Inggeris\\nContoh: Saiz | Size`\n      : `‚ûï *Add Product Option*\\n\\nPlease send option name (example: Size, Color, Subscription Duration)\\n\\nFormat: Malay Name | English Name\\nExample: Saiz | Size`,\n    { parse_mode: 'Markdown' }\n  );\n}\n\nasync function handleOptionDetail(ctx, productId, optionIndex) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const product = products.find(p => p.id === productId);\n  \n  if (!product || !product.options || !product.options[optionIndex]) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Pilihan tidak dijumpai' : 'Option not found');\n    return;\n  }\n  \n  const option = product.options[optionIndex];\n  \n  const text = lang === 'ms'\n    ? `üé® *Detail Pilihan*\\n\\n` +\n      `üìù Nama: ${option.name.ms}\\n` +\n      `üåê Name (EN): ${option.name.en}\\n` +\n      `üìã Nilai: ${option.values.join(', ')}\\n` +\n      `${option.required ? '‚ö†Ô∏è Wajib' : 'üìå Opsional'}\\n` +\n      `üí∞ Tambahan Harga: ${option.priceModifier ? `+RM${option.priceModifier}` : 'Tiada'}\\n\\n` +\n      `Pilih tindakan:`\n    : `üé® *Option Detail*\\n\\n` +\n      `üìù Name (MS): ${option.name.ms}\\n` +\n      `üåê Name: ${option.name.en}\\n` +\n      `üìã Values: ${option.values.join(', ')}\\n` +\n      `${option.required ? '‚ö†Ô∏è Required' : 'üìå Optional'}\\n` +\n      `üí∞ Price Modifier: ${option.priceModifier ? `+RM${option.priceModifier}` : 'None'}\\n\\n` +\n      `Choose action:`;\n  \n  const buttons = [\n    [Markup.button.callback(\n      option.required \n        ? (lang === 'ms' ? 'üìå Set Opsional' : 'üìå Set Optional')\n        : (lang === 'ms' ? '‚ö†Ô∏è Set Wajib' : '‚ö†Ô∏è Set Required'),\n      `opt_toggle_req_${productId}_${optionIndex}`\n    )],\n    [Markup.button.callback(lang === 'ms' ? 'üóëÔ∏è Padam Pilihan' : 'üóëÔ∏è Delete Option', `opt_delete_${productId}_${optionIndex}`)],\n    [Markup.button.callback(lang === 'ms' ? 'üîô Kembali' : 'üîô Back', `prod_options_${productId}`)]\n  ];\n  \n  await safeEditMessage(ctx, text, {\n    parse_mode: 'Markdown',\n    ...Markup.inlineKeyboard(buttons)\n  });\n}\n\nasync function handleToggleOptionRequired(ctx, productId, optionIndex) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const productIdx = products.findIndex(p => p.id === productId);\n  \n  if (productIdx === -1 || !products[productIdx].options || !products[productIdx].options[optionIndex]) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Pilihan tidak dijumpai' : 'Option not found');\n    return;\n  }\n  \n  products[productIdx].options[optionIndex].required = !products[productIdx].options[optionIndex].required;\n  await db.saveProducts(products);\n  \n  await ctx.answerCbQuery(\n    lang === 'ms'\n      ? `‚úÖ Status keutamaan dikemaskini`\n      : `‚úÖ Required status updated`\n  );\n  \n  await handleOptionDetail(ctx, productId, optionIndex);\n}\n\nasync function handleDeleteOption(ctx, productId, optionIndex) {\n  const adminId = ctx.from.id;\n  \n  if (!await isOwnerOrAdmin(adminId)) {\n    await ctx.answerCbQuery('‚ùå Unauthorized');\n    return;\n  }\n  \n  const user = await db.getUser(adminId);\n  const lang = user?.language || 'ms';\n  \n  const products = await db.getProducts();\n  const productIdx = products.findIndex(p => p.id === productId);\n  \n  if (productIdx === -1 || !products[productIdx].options || !products[productIdx].options[optionIndex]) {\n    await ctx.answerCbQuery(lang === 'ms' ? 'Pilihan tidak dijumpai' : 'Option not found');\n    return;\n  }\n  \n  products[productIdx].options.splice(optionIndex, 1);\n  await db.saveProducts(products);\n  \n  await ctx.answerCbQuery(\n    lang === 'ms'\n      ? `‚úÖ Pilihan dipadam`\n      : `‚úÖ Option deleted`\n  );\n  \n  await handleProductOptions(ctx, productId);\n}\n\nasync function processOptionInput(ctx) {\n  const userId = ctx.from.id;\n  const state = optionEditState.get(userId);\n  \n  if (!state) return;\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  const text = ctx.message.text.trim();\n  \n  const products = await db.getProducts();\n  const productIdx = products.findIndex(p => p.id === state.productId);\n  \n  if (productIdx === -1) {\n    optionEditState.delete(userId);\n    await ctx.reply(lang === 'ms' ? '‚ùå Produk tidak dijumpai' : '‚ùå Product not found');\n    return;\n  }\n  \n  if (!products[productIdx].options) {\n    products[productIdx].options = [];\n  }\n  \n  if (state.step === 'name') {\n    const parts = text.split('|').map(p => p.trim());\n    if (parts.length !== 2) {\n      await ctx.reply(\n        lang === 'ms'\n          ? `‚ùå Format salah!\\n\\nFormat: Nama Melayu | Nama Inggeris\\nContoh: Saiz | Size`\n          : `‚ùå Wrong format!\\n\\nFormat: Malay Name | English Name\\nExample: Saiz | Size`\n      );\n      return;\n    }\n    \n    state.name = { ms: parts[0], en: parts[1] };\n    state.step = 'values';\n    \n    await ctx.reply(\n      lang === 'ms'\n        ? `‚úÖ Nama disimpan: ${parts[0]} / ${parts[1]}\\n\\nüìã Sila hantar nilai-nilai pilihan (dipisahkan dengan koma)\\n\\nContoh: Kecil, Sederhana, Besar\\nContoh: Merah, Biru, Hijau`\n        : `‚úÖ Name saved: ${parts[0]} / ${parts[1]}\\n\\nüìã Please send option values (separated by commas)\\n\\nExample: Small, Medium, Large\\nExample: Red, Blue, Green`\n    );\n    \n  } else if (state.step === 'values') {\n    const values = text.split(',').map(v => v.trim()).filter(v => v);\n    \n    if (values.length === 0) {\n      await ctx.reply(\n        lang === 'ms'\n          ? `‚ùå Sila masukkan sekurang-kurangnya satu nilai!`\n          : `‚ùå Please enter at least one value!`\n      );\n      return;\n    }\n    \n    state.values = values;\n    state.step = 'required';\n    \n    const buttons = [\n      [Markup.button.callback(lang === 'ms' ? '‚ö†Ô∏è Wajib' : '‚ö†Ô∏è Required', `opt_req_yes_${state.productId}`)],\n      [Markup.button.callback(lang === 'ms' ? 'üìå Opsional' : 'üìå Optional', `opt_req_no_${state.productId}`)]\n    ];\n    \n    await ctx.reply(\n      lang === 'ms'\n        ? `‚úÖ Nilai disimpan: ${values.join(', ')}\\n\\n‚ö†Ô∏è Adakah pilihan ini wajib?`\n        : `‚úÖ Values saved: ${values.join(', ')}\\n\\n‚ö†Ô∏è Is this option required?`,\n      Markup.inlineKeyboard(buttons)\n    );\n    \n  } else if (state.step === 'priceModifier') {\n    const price = parseFloat(text);\n    \n    if (isNaN(price) && text !== '0') {\n      await ctx.reply(\n        lang === 'ms'\n          ? `‚ùå Harga tidak sah! Sila masukkan nombor atau 0 untuk tiada caj tambahan.`\n          : `‚ùå Invalid price! Please enter a number or 0 for no extra charge.`\n      );\n      return;\n    }\n    \n    const newOption = {\n      id: generateId('OPT'),\n      name: state.name,\n      values: state.values,\n      required: state.required,\n      priceModifier: price === 0 ? null : price\n    };\n    \n    products[productIdx].options.push(newOption);\n    await db.saveProducts(products);\n    \n    optionEditState.delete(userId);\n    \n    await ctx.reply(\n      lang === 'ms'\n        ? `‚úÖ *Pilihan berjaya ditambah!*\\n\\n` +\n          `üìù ${newOption.name.ms}\\n` +\n          `üìã ${newOption.values.join(', ')}\\n` +\n          `${newOption.required ? '‚ö†Ô∏è Wajib' : 'üìå Opsional'}\\n` +\n          `${newOption.priceModifier ? `üí∞ +RM${newOption.priceModifier}` : 'üí∞ Tiada caj tambahan'}`\n        : `‚úÖ *Option successfully added!*\\n\\n` +\n          `üìù ${newOption.name.en}\\n` +\n          `üìã ${newOption.values.join(', ')}\\n` +\n          `${newOption.required ? '‚ö†Ô∏è Required' : 'üìå Optional'}\\n` +\n          `${newOption.priceModifier ? `üí∞ +RM${newOption.priceModifier}` : 'üí∞ No extra charge'}`,\n      { parse_mode: 'Markdown' }\n    );\n  }\n}\n\nasync function handleOptionRequired(ctx, productId, required) {\n  const userId = ctx.from.id;\n  const state = optionEditState.get(userId);\n  \n  if (!state || state.productId !== productId) {\n    await ctx.answerCbQuery('‚ùå Session expired');\n    return;\n  }\n  \n  const user = await db.getUser(userId);\n  const lang = user?.language || 'ms';\n  \n  state.required = required;\n  state.step = 'priceModifier';\n  \n  await ctx.answerCbQuery();\n  await ctx.reply(\n    lang === 'ms'\n      ? `üí∞ Adakah pilihan ini menambah harga?\\n\\nSila hantar tambahan harga (contoh: 5 untuk +RM5)\\nAtau hantar 0 jika tiada caj tambahan`\n      : `üí∞ Does this option add to the price?\\n\\nPlease send price modifier (example: 5 for +RM5)\\nOr send 0 for no extra charge`\n  );\n}\n\nmodule.exports = {\n  handleProductOptions,\n  handleAddOption,\n  handleOptionDetail,\n  handleToggleOptionRequired,\n  handleDeleteOption,\n  processOptionInput,\n  handleOptionRequired\n};\n","size_bytes":12048},"public/customer-style.css":{"content":"* {\n    margin: 0;\n    padding: 0;\n    box-sizing: border-box;\n}\n\n:root {\n    --primary-color: #1a1a1a;\n    --primary-dark: #000000;\n    --secondary-color: #4a4a4a;\n    --success-color: #22c55e;\n    --danger-color: #ef4444;\n    --warning-color: #f59e0b;\n    --text-dark: #1a1a1a;\n    --text-light: #6b7280;\n    --bg-light: #fafafa;\n    --bg-white: #ffffff;\n    --border-color: #e5e7eb;\n    --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n    --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.1);\n}\n\nbody {\n    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n    background-color: var(--bg-light);\n    color: var(--text-dark);\n    line-height: 1.6;\n}\n\n.page {\n    display: none;\n}\n\n.page.active {\n    display: block;\n}\n\n.animated-background {\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: #ffffff;\n    z-index: -1;\n}\n\n.login-container {\n    min-height: 100vh;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    padding: 20px;\n}\n\n.login-card {\n    background: white;\n    border-radius: 20px;\n    padding: 40px;\n    max-width: 450px;\n    width: 100%;\n    box-shadow: var(--shadow-lg);\n    animation: slideUp 0.6s ease;\n}\n\n@keyframes slideUp {\n    from {\n        opacity: 0;\n        transform: translateY(30px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.logo-container {\n    text-align: center;\n    margin-bottom: 30px;\n}\n\n.logo-circle {\n    width: 80px;\n    height: 80px;\n    background: var(--primary-color);\n    border-radius: 12px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    margin: 0 auto 20px;\n    font-size: 40px;\n    color: white;\n}\n\n.login-title {\n    font-size: 28px;\n    color: var(--text-dark);\n    margin-bottom: 10px;\n}\n\n.login-subtitle {\n    color: var(--text-light);\n    font-size: 14px;\n}\n\n.telegram-login-wrapper {\n    margin: 30px 0;\n    text-align: center;\n}\n\n.login-instruction {\n    color: var(--text-light);\n    margin-bottom: 20px;\n    font-size: 14px;\n}\n\n#telegram-login-container {\n    display: flex;\n    justify-content: center;\n    margin: 20px 0;\n}\n\n.login-footer {\n    text-align: center;\n    margin-top: 20px;\n    color: var(--text-light);\n    font-size: 13px;\n}\n\n.header {\n    background: white;\n    box-shadow: var(--shadow);\n    position: sticky;\n    top: 0;\n    z-index: 100;\n}\n\n.header-content {\n    max-width: 1400px;\n    margin: 0 auto;\n    padding: 15px 30px;\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n}\n\n.logo {\n    display: flex;\n    align-items: center;\n    gap: 10px;\n    font-size: 24px;\n    font-weight: bold;\n    color: var(--primary-color);\n}\n\n.logo i {\n    font-size: 28px;\n}\n\n.nav-menu {\n    display: flex;\n    gap: 10px;\n}\n\n.nav-item {\n    background: transparent;\n    border: none;\n    padding: 10px 20px;\n    border-radius: 8px;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    color: var(--text-light);\n    transition: all 0.3s;\n    position: relative;\n}\n\n.nav-item:hover {\n    background: var(--bg-light);\n    color: var(--primary-color);\n}\n\n.nav-item.active {\n    background: var(--primary-color);\n    color: white;\n}\n\n.cart-badge, .chat-badge {\n    position: absolute;\n    top: 5px;\n    right: 5px;\n    background: var(--danger-color);\n    color: white;\n    font-size: 10px;\n    padding: 2px 6px;\n    border-radius: 10px;\n    font-weight: bold;\n}\n\n.cart-badge.hidden, .chat-badge.hidden {\n    display: none;\n}\n\n.user-info {\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n.user-avatar {\n    width: 40px;\n    height: 40px;\n    background: var(--primary-color);\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: white;\n}\n\n.user-name {\n    font-weight: 600;\n    color: var(--text-dark);\n}\n\n.btn-logout {\n    background: var(--danger-color);\n    color: white;\n    border: none;\n    padding: 8px 12px;\n    border-radius: 6px;\n    cursor: pointer;\n    transition: all 0.3s;\n}\n\n.btn-logout:hover {\n    background: #dc2626;\n}\n\n.mobile-nav {\n    display: none;\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    background: white;\n    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);\n    padding: 8px;\n    z-index: 100;\n}\n\n.mobile-nav-item {\n    flex: 1;\n    background: transparent;\n    border: none;\n    padding: 10px;\n    cursor: pointer;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: 4px;\n    color: var(--text-light);\n    font-size: 12px;\n    border-radius: 8px;\n    transition: all 0.3s;\n    position: relative;\n}\n\n.mobile-nav-item.active {\n    background: var(--bg-light);\n    color: var(--primary-color);\n}\n\n.main-content {\n    max-width: 1400px;\n    margin: 0 auto;\n    padding: 30px;\n}\n\n.content-section {\n    display: none;\n}\n\n.content-section.active {\n    display: block;\n    animation: fadeIn 0.4s ease;\n}\n\n@keyframes fadeIn {\n    from {\n        opacity: 0;\n        transform: translateY(10px);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0);\n    }\n}\n\n.section-header {\n    margin-bottom: 30px;\n}\n\n.section-header h2 {\n    font-size: 28px;\n    color: var(--text-dark);\n    margin-bottom: 15px;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n.search-filter {\n    display: flex;\n    gap: 15px;\n    flex-wrap: wrap;\n}\n\n.search-box {\n    flex: 1;\n    min-width: 250px;\n    position: relative;\n}\n\n.search-box i {\n    position: absolute;\n    left: 15px;\n    top: 50%;\n    transform: translateY(-50%);\n    color: var(--text-light);\n}\n\n.search-box input {\n    width: 100%;\n    padding: 12px 15px 12px 45px;\n    border: 2px solid var(--border-color);\n    border-radius: 10px;\n    font-size: 14px;\n    transition: all 0.3s;\n}\n\n.search-box input:focus {\n    outline: none;\n    border-color: var(--primary-color);\n}\n\n.category-select {\n    padding: 12px 20px;\n    border: 2px solid var(--border-color);\n    border-radius: 10px;\n    font-size: 14px;\n    cursor: pointer;\n    transition: all 0.3s;\n}\n\n.category-select:focus {\n    outline: none;\n    border-color: var(--primary-color);\n}\n\n.product-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));\n    gap: 25px;\n}\n\n.product-card {\n    background: white;\n    border-radius: 15px;\n    overflow: hidden;\n    box-shadow: var(--shadow);\n    transition: all 0.3s;\n    cursor: pointer;\n}\n\n.product-card:hover {\n    transform: translateY(-5px);\n    box-shadow: var(--shadow-lg);\n}\n\n.product-image {\n    width: 100%;\n    height: 200px;\n    object-fit: cover;\n    background: var(--bg-light);\n}\n\n.product-info {\n    padding: 15px;\n}\n\n.product-name {\n    font-size: 16px;\n    font-weight: 600;\n    color: var(--text-dark);\n    margin-bottom: 8px;\n}\n\n.product-price {\n    font-size: 20px;\n    font-weight: bold;\n    color: var(--primary-color);\n    margin-bottom: 8px;\n}\n\n.product-stock {\n    font-size: 12px;\n    color: var(--text-light);\n    margin-bottom: 12px;\n}\n\n.product-stock.low {\n    color: var(--warning-color);\n}\n\n.product-stock.out {\n    color: var(--danger-color);\n}\n\n.btn-view-product {\n    width: 100%;\n    padding: 10px;\n    background: var(--primary-color);\n    color: white;\n    border: none;\n    border-radius: 8px;\n    cursor: pointer;\n    transition: all 0.3s;\n}\n\n.btn-view-product:hover {\n    background: var(--primary-dark);\n}\n\n.loading {\n    text-align: center;\n    padding: 60px 20px;\n    color: var(--text-light);\n}\n\n.loading i {\n    font-size: 40px;\n    margin-bottom: 15px;\n    animation: spin 1s linear infinite;\n}\n\n@keyframes spin {\n    from {\n        transform: rotate(0deg);\n    }\n    to {\n        transform: rotate(360deg);\n    }\n}\n\n.empty-state {\n    text-align: center;\n    padding: 80px 20px;\n}\n\n.empty-state i {\n    font-size: 60px;\n    color: var(--text-light);\n    margin-bottom: 20px;\n}\n\n.empty-state h3 {\n    color: var(--text-dark);\n    margin-bottom: 10px;\n}\n\n.empty-state p {\n    color: var(--text-light);\n}\n\n.cart-content {\n    background: white;\n    border-radius: 15px;\n    padding: 20px;\n    margin-bottom: 20px;\n}\n\n.cart-item {\n    display: flex;\n    gap: 15px;\n    padding: 15px;\n    border-bottom: 1px solid var(--border-color);\n}\n\n.cart-item:last-child {\n    border-bottom: none;\n}\n\n.cart-item-image {\n    width: 80px;\n    height: 80px;\n    object-fit: cover;\n    border-radius: 8px;\n}\n\n.cart-item-info {\n    flex: 1;\n}\n\n.cart-item-name {\n    font-weight: 600;\n    color: var(--text-dark);\n    margin-bottom: 5px;\n}\n\n.cart-item-price {\n    color: var(--primary-color);\n    font-weight: bold;\n    margin-bottom: 10px;\n}\n\n.cart-item-controls {\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n.qty-btn-small {\n    width: 30px;\n    height: 30px;\n    border: 1px solid var(--border-color);\n    background: white;\n    border-radius: 5px;\n    cursor: pointer;\n    transition: all 0.3s;\n}\n\n.qty-btn-small:hover {\n    background: var(--bg-light);\n}\n\n.cart-item-qty {\n    min-width: 40px;\n    text-align: center;\n    font-weight: 600;\n}\n\n.btn-remove {\n    background: var(--danger-color);\n    color: white;\n    border: none;\n    padding: 6px 12px;\n    border-radius: 5px;\n    cursor: pointer;\n    font-size: 12px;\n    transition: all 0.3s;\n}\n\n.btn-remove:hover {\n    background: #dc2626;\n}\n\n.cart-summary {\n    background: white;\n    border-radius: 15px;\n    padding: 20px;\n}\n\n.cart-summary.hidden {\n    display: none;\n}\n\n.summary-row {\n    display: flex;\n    justify-content: space-between;\n    padding: 10px 0;\n    border-bottom: 1px solid var(--border-color);\n}\n\n.summary-row.total {\n    border-bottom: none;\n    font-size: 20px;\n    font-weight: bold;\n    color: var(--primary-color);\n    margin-top: 10px;\n}\n\n.btn-checkout {\n    width: 100%;\n    padding: 15px;\n    background: var(--success-color);\n    color: white;\n    border: none;\n    border-radius: 10px;\n    font-size: 16px;\n    font-weight: 600;\n    cursor: pointer;\n    margin-top: 15px;\n    transition: all 0.3s;\n}\n\n.btn-checkout:hover {\n    background: #059669;\n}\n\n.filter-tabs {\n    display: flex;\n    gap: 10px;\n    margin-top: 15px;\n}\n\n.filter-tab {\n    padding: 8px 16px;\n    background: white;\n    border: 2px solid var(--border-color);\n    border-radius: 8px;\n    cursor: pointer;\n    transition: all 0.3s;\n}\n\n.filter-tab.active {\n    background: var(--primary-color);\n    color: white;\n    border-color: var(--primary-color);\n}\n\n.orders-list {\n    display: flex;\n    flex-direction: column;\n    gap: 15px;\n}\n\n.order-card {\n    background: white;\n    border-radius: 15px;\n    padding: 20px;\n    box-shadow: var(--shadow);\n}\n\n.order-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 15px;\n    padding-bottom: 15px;\n    border-bottom: 1px solid var(--border-color);\n}\n\n.order-id {\n    font-weight: 600;\n    color: var(--text-dark);\n}\n\n.order-status {\n    padding: 6px 12px;\n    border-radius: 20px;\n    font-size: 12px;\n    font-weight: 600;\n}\n\n.order-status.pending {\n    background: #fef3c7;\n    color: #92400e;\n}\n\n.order-status.processing {\n    background: #dbeafe;\n    color: #1e40af;\n}\n\n.order-status.completed {\n    background: #d1fae5;\n    color: #065f46;\n}\n\n.order-status.rejected {\n    background: #fee2e2;\n    color: #991b1b;\n}\n\n.order-items {\n    margin: 15px 0;\n}\n\n.order-item {\n    padding: 8px 0;\n    color: var(--text-light);\n    font-size: 14px;\n}\n\n.order-total {\n    font-size: 18px;\n    font-weight: bold;\n    color: var(--primary-color);\n    margin-top: 10px;\n}\n\n.order-date {\n    font-size: 12px;\n    color: var(--text-light);\n    margin-top: 10px;\n}\n\n.chat-container {\n    background: white;\n    border-radius: 15px;\n    height: 600px;\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n}\n\n.chat-messages {\n    flex: 1;\n    overflow-y: auto;\n    padding: 20px;\n}\n\n.chat-welcome {\n    text-align: center;\n    padding: 60px 20px;\n}\n\n.chat-welcome i {\n    font-size: 60px;\n    color: var(--primary-color);\n    margin-bottom: 20px;\n}\n\n.chat-welcome h3 {\n    color: var(--text-dark);\n    margin-bottom: 10px;\n}\n\n.chat-welcome p {\n    color: var(--text-light);\n}\n\n.chat-message {\n    margin-bottom: 15px;\n    display: flex;\n    gap: 10px;\n}\n\n.chat-message.sent {\n    flex-direction: row-reverse;\n}\n\n.chat-avatar {\n    width: 35px;\n    height: 35px;\n    border-radius: 50%;\n    background: var(--primary-color);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: white;\n    font-size: 14px;\n    flex-shrink: 0;\n}\n\n.chat-message.sent .chat-avatar {\n    background: var(--success-color);\n}\n\n.chat-bubble {\n    max-width: 70%;\n    padding: 12px 16px;\n    border-radius: 15px;\n    background: var(--bg-light);\n    color: var(--text-dark);\n}\n\n.chat-message.sent .chat-bubble {\n    background: var(--primary-color);\n    color: white;\n}\n\n.chat-image {\n    max-width: 100%;\n    border-radius: 10px;\n    margin-top: 8px;\n    cursor: pointer;\n}\n\n.chat-time {\n    font-size: 11px;\n    color: var(--text-light);\n    margin-top: 4px;\n}\n\n.chat-message.sent .chat-time {\n    color: rgba(255, 255, 255, 0.7);\n}\n\n.chat-input-area {\n    display: flex;\n    gap: 10px;\n    padding: 15px;\n    border-top: 1px solid var(--border-color);\n}\n\n.btn-attach {\n    background: var(--bg-light);\n    border: none;\n    width: 40px;\n    height: 40px;\n    border-radius: 8px;\n    cursor: pointer;\n    color: var(--text-light);\n    transition: all 0.3s;\n}\n\n.btn-attach:hover {\n    background: var(--border-color);\n}\n\n#chatInput {\n    flex: 1;\n    padding: 10px 15px;\n    border: 2px solid var(--border-color);\n    border-radius: 8px;\n    font-size: 14px;\n}\n\n#chatInput:focus {\n    outline: none;\n    border-color: var(--primary-color);\n}\n\n.btn-send {\n    background: var(--primary-color);\n    color: white;\n    border: none;\n    width: 40px;\n    height: 40px;\n    border-radius: 8px;\n    cursor: pointer;\n    transition: all 0.3s;\n}\n\n.btn-send:hover {\n    background: var(--primary-dark);\n}\n\n.settings-container {\n    display: flex;\n    flex-direction: column;\n    gap: 20px;\n}\n\n.settings-card {\n    background: white;\n    border-radius: 15px;\n    padding: 25px;\n    box-shadow: var(--shadow);\n}\n\n.settings-card.danger {\n    border: 2px solid var(--danger-color);\n}\n\n.settings-card h3 {\n    font-size: 18px;\n    color: var(--text-dark);\n    margin-bottom: 20px;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n.settings-group {\n    display: flex;\n    flex-direction: column;\n    gap: 15px;\n}\n\n.profile-info {\n    display: flex;\n    gap: 20px;\n    align-items: center;\n}\n\n.profile-avatar {\n    width: 80px;\n    height: 80px;\n    border-radius: 50%;\n    background: var(--primary-color);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: white;\n    font-size: 35px;\n}\n\n.profile-details {\n    flex: 1;\n}\n\n.profile-name {\n    font-size: 20px;\n    font-weight: 600;\n    color: var(--text-dark);\n    margin-bottom: 5px;\n}\n\n.profile-id, .profile-joined {\n    font-size: 14px;\n    color: var(--text-light);\n    margin: 3px 0;\n}\n\n.setting-item {\n    display: flex;\n    align-items: center;\n    gap: 10px;\n    padding: 12px;\n    border-radius: 8px;\n    cursor: pointer;\n    transition: all 0.3s;\n}\n\n.setting-item:hover {\n    background: var(--bg-light);\n}\n\n.setting-item.toggle {\n    justify-content: space-between;\n}\n\n.toggle-slider {\n    width: 50px;\n    height: 26px;\n    background: var(--border-color);\n    border-radius: 13px;\n    position: relative;\n    transition: all 0.3s;\n}\n\n.toggle-slider::after {\n    content: '';\n    position: absolute;\n    width: 20px;\n    height: 20px;\n    background: white;\n    border-radius: 50%;\n    top: 3px;\n    left: 3px;\n    transition: all 0.3s;\n}\n\n.setting-item input[type=\"checkbox\"]:checked + .toggle-slider {\n    background: var(--primary-color);\n}\n\n.setting-item input[type=\"checkbox\"]:checked + .toggle-slider::after {\n    left: 27px;\n}\n\n.setting-item input[type=\"checkbox\"],\n.setting-item input[type=\"radio\"] {\n    display: none;\n}\n\n.settings-btn {\n    width: 100%;\n    padding: 12px;\n    background: var(--bg-light);\n    border: none;\n    border-radius: 8px;\n    cursor: pointer;\n    text-align: left;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n    color: var(--text-dark);\n    transition: all 0.3s;\n}\n\n.settings-btn:hover {\n    background: var(--border-color);\n}\n\n.settings-btn.danger {\n    background: var(--danger-color);\n    color: white;\n    justify-content: center;\n}\n\n.settings-btn.danger:hover {\n    background: #dc2626;\n}\n\n.modal {\n    display: none;\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.5);\n    z-index: 1000;\n    align-items: center;\n    justify-content: center;\n    padding: 20px;\n}\n\n.modal.active {\n    display: flex;\n}\n\n.modal-content {\n    background: white;\n    border-radius: 15px;\n    max-width: 800px;\n    width: 100%;\n    max-height: 90vh;\n    overflow-y: auto;\n    position: relative;\n    animation: slideUp 0.3s ease;\n}\n\n.modal-close {\n    position: absolute;\n    top: 15px;\n    right: 15px;\n    background: var(--danger-color);\n    color: white;\n    border: none;\n    width: 35px;\n    height: 35px;\n    border-radius: 50%;\n    font-size: 20px;\n    cursor: pointer;\n    transition: all 0.3s;\n}\n\n.modal-close:hover {\n    background: #dc2626;\n}\n\n.modal-body {\n    padding: 30px;\n}\n\n.modal-body h2 {\n    margin-bottom: 20px;\n    display: flex;\n    align-items: center;\n    gap: 10px;\n}\n\n.product-modal-image {\n    width: 100%;\n    height: 300px;\n    border-radius: 10px;\n    overflow: hidden;\n    margin-bottom: 20px;\n}\n\n.product-modal-image img {\n    width: 100%;\n    height: 100%;\n    object-fit: cover;\n}\n\n.product-modal-info h2 {\n    color: var(--text-dark);\n    margin-bottom: 15px;\n}\n\n.product-modal-price {\n    font-size: 28px;\n    font-weight: bold;\n    color: var(--primary-color);\n    margin-bottom: 10px;\n}\n\n.product-modal-stock {\n    color: var(--text-light);\n    margin-bottom: 15px;\n}\n\n.product-modal-description {\n    color: var(--text-dark);\n    line-height: 1.8;\n    margin-bottom: 20px;\n}\n\n.quantity-selector {\n    margin: 20px 0;\n}\n\n.quantity-selector label {\n    display: block;\n    margin-bottom: 10px;\n    font-weight: 600;\n}\n\n.quantity-controls {\n    display: flex;\n    align-items: center;\n    gap: 15px;\n}\n\n.qty-btn {\n    width: 40px;\n    height: 40px;\n    border: 2px solid var(--border-color);\n    background: white;\n    border-radius: 8px;\n    font-size: 20px;\n    cursor: pointer;\n    transition: all 0.3s;\n}\n\n.qty-btn:hover {\n    background: var(--bg-light);\n}\n\n#quantity {\n    width: 80px;\n    text-align: center;\n    padding: 10px;\n    border: 2px solid var(--border-color);\n    border-radius: 8px;\n    font-size: 16px;\n    font-weight: 600;\n}\n\n.btn-add-cart {\n    width: 100%;\n    padding: 15px;\n    background: var(--primary-color);\n    color: white;\n    border: none;\n    border-radius: 10px;\n    font-size: 16px;\n    font-weight: 600;\n    cursor: pointer;\n    transition: all 0.3s;\n    margin-top: 10px;\n}\n\n.btn-add-cart:hover {\n    background: var(--primary-dark);\n}\n\n.checkout-content {\n    display: grid;\n    gap: 30px;\n}\n\n.checkout-summary h3 {\n    margin-bottom: 15px;\n}\n\n.checkout-items {\n    margin-bottom: 15px;\n}\n\n.checkout-item {\n    display: flex;\n    justify-content: space-between;\n    padding: 10px 0;\n    border-bottom: 1px solid var(--border-color);\n}\n\n.checkout-total {\n    display: flex;\n    justify-content: space-between;\n    font-size: 20px;\n    font-weight: bold;\n    color: var(--primary-color);\n    padding-top: 15px;\n    border-top: 2px solid var(--border-color);\n}\n\n.payment-section h3 {\n    margin-bottom: 15px;\n}\n\n.qr-code-container {\n    text-align: center;\n    padding: 20px;\n    background: var(--bg-light);\n    border-radius: 10px;\n    margin-bottom: 20px;\n}\n\n.qr-code-container img {\n    max-width: 300px;\n    width: 100%;\n    border-radius: 10px;\n}\n\n.qr-code-container p {\n    margin-top: 10px;\n    color: var(--text-light);\n}\n\n.upload-proof {\n    display: flex;\n    flex-direction: column;\n    gap: 15px;\n}\n\n.upload-proof label {\n    font-weight: 600;\n}\n\n.upload-proof input[type=\"file\"] {\n    padding: 10px;\n    border: 2px dashed var(--border-color);\n    border-radius: 10px;\n    cursor: pointer;\n}\n\n.btn-submit-payment {\n    padding: 15px;\n    background: var(--success-color);\n    color: white;\n    border: none;\n    border-radius: 10px;\n    font-size: 16px;\n    font-weight: 600;\n    cursor: pointer;\n    transition: all 0.3s;\n}\n\n.btn-submit-payment:hover {\n    background: #059669;\n}\n\n.toast {\n    position: fixed;\n    bottom: 30px;\n    right: 30px;\n    background: var(--text-dark);\n    color: white;\n    padding: 15px 25px;\n    border-radius: 10px;\n    box-shadow: var(--shadow-lg);\n    transform: translateY(100px);\n    opacity: 0;\n    transition: all 0.3s;\n    z-index: 2000;\n}\n\n.toast.show {\n    transform: translateY(0);\n    opacity: 1;\n}\n\n.toast.success {\n    background: var(--success-color);\n}\n\n.toast.error {\n    background: var(--danger-color);\n}\n\n@media (max-width: 768px) {\n    .header-content {\n        padding: 15px;\n    }\n\n    .logo span {\n        display: none;\n    }\n\n    .nav-menu {\n        display: none;\n    }\n\n    .user-name {\n        display: none;\n    }\n\n    .mobile-nav {\n        display: flex;\n    }\n\n    .main-content {\n        padding: 15px;\n        padding-bottom: 80px;\n    }\n\n    .product-grid {\n        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));\n        gap: 15px;\n    }\n\n    .search-filter {\n        flex-direction: column;\n    }\n\n    .chat-container {\n        height: calc(100vh - 250px);\n    }\n}\n","size_bytes":21525},"public/customer-script.js":{"content":"let currentUser = null;\nlet products = [];\nlet categories = [];\nlet cart = [];\nlet orders = [];\nlet chatMessages = [];\nlet chatPollingInterval = null;\n\nconst API_BASE = window.location.origin;\n\nfunction showToast(message, type = 'success') {\n    const toast = document.getElementById('toast');\n    toast.textContent = message;\n    toast.className = `toast show ${type}`;\n    \n    setTimeout(() => {\n        toast.classList.remove('show');\n    }, 3000);\n}\n\nfunction saveToLocalStorage(key, data) {\n    localStorage.setItem(key, JSON.stringify(data));\n}\n\nfunction getFromLocalStorage(key) {\n    const data = localStorage.getItem(key);\n    return data ? JSON.parse(data) : null;\n}\n\nfunction checkAuth() {\n    const user = getFromLocalStorage('customer_user');\n    if (user) {\n        currentUser = user;\n        showCustomerPortal();\n        loadUserData();\n    } else {\n        showLoginPage();\n    }\n}\n\nfunction showLoginPage() {\n    document.getElementById('loginPage').classList.add('active');\n    document.getElementById('customerPortal').classList.remove('active');\n    initTelegramLogin();\n}\n\nfunction showCustomerPortal() {\n    document.getElementById('loginPage').classList.remove('active');\n    document.getElementById('customerPortal').classList.add('active');\n    \n    if (currentUser) {\n        document.getElementById('userName').textContent = currentUser.first_name || 'Pelanggan';\n        document.getElementById('profileName').textContent = currentUser.first_name || 'Pelanggan';\n        document.getElementById('profileId').textContent = `ID: #${currentUser.id}`;\n        \n        if (currentUser.photo_url) {\n            document.getElementById('userAvatar').innerHTML = `<img src=\"${currentUser.photo_url}\" style=\"width: 100%; height: 100%; border-radius: 50%;\">`;\n            document.getElementById('settingsAvatar').innerHTML = `<img src=\"${currentUser.photo_url}\" style=\"width: 100%; height: 100%; border-radius: 50%;\">`;\n        }\n    }\n    \n    loadProducts();\n    loadCategories();\n    loadOrders();\n    loadCart();\n    startChatPolling();\n}\n\nasync function initTelegramLogin() {\n    try {\n        const response = await fetch(`${API_BASE}/api/customer/config`);\n        const data = await response.json();\n        \n        if (data.success && data.config.botUsername) {\n            const script = document.createElement('script');\n            script.src = 'https://telegram.org/js/telegram-widget.js?22';\n            script.setAttribute('data-telegram-login', data.config.botUsername);\n            script.setAttribute('data-size', 'large');\n            script.setAttribute('data-radius', '10');\n            script.setAttribute('data-onauth', 'onTelegramAuth(user)');\n            script.setAttribute('data-request-access', 'write');\n            script.async = true;\n            \n            const container = document.getElementById('telegram-login-container');\n            container.innerHTML = '';\n            container.appendChild(script);\n        } else {\n            document.getElementById('telegram-login-container').innerHTML = \n                '<p style=\"color: red;\">Unable to load Telegram login. Please contact support.</p>';\n        }\n    } catch (error) {\n        console.error('Error loading Telegram login:', error);\n        document.getElementById('telegram-login-container').innerHTML = \n            '<p style=\"color: red;\">Unable to load Telegram login. Please contact support.</p>';\n    }\n}\n\nwindow.onTelegramAuth = function(user) {\n    currentUser = user;\n    saveToLocalStorage('customer_user', user);\n    registerUser(user);\n    showToast('Log masuk berjaya!', 'success');\n    showCustomerPortal();\n};\n\ndocument.getElementById('simpleLoginForm')?.addEventListener('submit', async (e) => {\n    e.preventDefault();\n    const telegramId = document.getElementById('customerTelegramId').value;\n    \n    if (!telegramId) {\n        showToast('Sila masukkan Telegram ID anda', 'error');\n        return;\n    }\n    \n    try {\n        const response = await fetch(`${API_BASE}/api/customer/user/${telegramId}`);\n        const data = await response.json();\n        \n        if (data.success && data.user) {\n            currentUser = {\n                id: data.user.id,\n                first_name: data.user.firstName || 'Pelanggan',\n                last_name: data.user.lastName || '',\n                username: data.user.username || '',\n                photo_url: data.user.photoUrl || null\n            };\n            \n            saveToLocalStorage('customer_user', currentUser);\n            showToast('Log masuk berjaya!', 'success');\n            showCustomerPortal();\n        } else {\n            currentUser = {\n                id: parseInt(telegramId),\n                first_name: 'Pelanggan',\n                last_name: '',\n                username: '',\n                photo_url: null\n            };\n            \n            await registerUser(currentUser);\n            saveToLocalStorage('customer_user', currentUser);\n            showToast('Akaun baru dibuat! Log masuk berjaya!', 'success');\n            showCustomerPortal();\n        }\n    } catch (error) {\n        console.error('Login error:', error);\n        showToast('Ralat log masuk. Sila cuba lagi.', 'error');\n    }\n});\n\nasync function registerUser(user) {\n    try {\n        const response = await fetch(`${API_BASE}/api/customer/register`, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify(user)\n        });\n        \n        if (!response.ok) {\n            console.error('Failed to register user');\n        }\n    } catch (error) {\n        console.error('Error registering user:', error);\n    }\n}\n\nasync function loadProducts() {\n    try {\n        const response = await fetch(`${API_BASE}/api/customer/products`);\n        const data = await response.json();\n        \n        if (data.success) {\n            products = data.products;\n            renderProducts();\n        }\n    } catch (error) {\n        console.error('Error loading products:', error);\n        showToast('Gagal memuatkan produk', 'error');\n    }\n}\n\nasync function loadCategories() {\n    try {\n        const response = await fetch(`${API_BASE}/api/customer/categories`);\n        const data = await response.json();\n        \n        if (data.success) {\n            categories = data.categories;\n            renderCategories();\n        }\n    } catch (error) {\n        console.error('Error loading categories:', error);\n    }\n}\n\nfunction renderCategories() {\n    const select = document.getElementById('categoryFilter');\n    select.innerHTML = '<option value=\"all\">Semua Kategori</option>';\n    \n    categories.forEach(cat => {\n        const option = document.createElement('option');\n        option.value = cat.id;\n        option.textContent = cat.name;\n        select.appendChild(option);\n    });\n}\n\nfunction renderProducts(filteredProducts = null) {\n    const grid = document.getElementById('productGrid');\n    const productsToRender = filteredProducts || products;\n    \n    if (productsToRender.length === 0) {\n        grid.innerHTML = '<div class=\"empty-state\"><i class=\"fas fa-box-open\"></i><h3>Tiada produk dijumpai</h3></div>';\n        return;\n    }\n    \n    grid.innerHTML = productsToRender.map(product => `\n        <div class=\"product-card\" onclick=\"showProductModal('${product.id}')\">\n            <div class=\"product-info\">\n                <div class=\"product-name\">${product.name}</div>\n                <div class=\"product-price\">RM ${parseFloat(product.price).toFixed(2)}</div>\n                <div class=\"product-stock ${product.stock <= 0 ? 'out' : product.stock < 10 ? 'low' : ''}\">\n                    ${product.stock <= 0 ? 'Habis Stok' : `Stok: ${product.stock}`}\n                </div>\n                ${product.description ? `<div class=\"product-description\">${product.description}</div>` : ''}\n                <button class=\"btn-view-product\" ${product.stock <= 0 ? 'disabled' : ''}>\n                    ${product.stock <= 0 ? 'Habis Stok' : 'Lihat Produk'}\n                </button>\n            </div>\n        </div>\n    `).join('');\n}\n\nfunction showProductModal(productId) {\n    const product = products.find(p => p.id === productId);\n    if (!product || product.stock <= 0) return;\n    \n    document.getElementById('modalProductName').textContent = product.name;\n    document.getElementById('modalProductPrice').textContent = `RM ${parseFloat(product.price).toFixed(2)}`;\n    document.getElementById('modalProductStock').textContent = `Stok: ${product.stock}`;\n    document.getElementById('modalProductDescription').textContent = product.description || 'Tiada keterangan';\n    document.getElementById('quantity').value = 1;\n    document.getElementById('quantity').max = product.stock;\n    \n    const modal = document.getElementById('productModal');\n    modal.classList.add('active');\n    \n    document.getElementById('addToCartBtn').onclick = () => addToCart(product);\n}\n\nfunction addToCart(product) {\n    const quantity = parseInt(document.getElementById('quantity').value);\n    \n    const existingItem = cart.find(item => item.id === product.id);\n    if (existingItem) {\n        existingItem.quantity += quantity;\n    } else {\n        cart.push({\n            ...product,\n            quantity: quantity\n        });\n    }\n    \n    saveCart();\n    updateCartBadge();\n    closeModal('productModal');\n    showToast('Ditambah ke keranjang!', 'success');\n}\n\nfunction saveCart() {\n    saveToLocalStorage('customer_cart', cart);\n}\n\nfunction loadCart() {\n    const savedCart = getFromLocalStorage('customer_cart');\n    if (savedCart) {\n        cart = savedCart;\n        updateCartBadge();\n    }\n}\n\nfunction updateCartBadge() {\n    const count = cart.reduce((sum, item) => sum + item.quantity, 0);\n    document.getElementById('cartBadge').textContent = count;\n    document.getElementById('mobileCartBadge').textContent = count;\n    \n    if (count > 0) {\n        document.getElementById('cartBadge').classList.remove('hidden');\n        document.getElementById('mobileCartBadge').classList.remove('hidden');\n    } else {\n        document.getElementById('cartBadge').classList.add('hidden');\n        document.getElementById('mobileCartBadge').classList.add('hidden');\n    }\n}\n\nfunction renderCart() {\n    const container = document.getElementById('cartContent');\n    const summary = document.getElementById('cartSummary');\n    \n    if (cart.length === 0) {\n        container.innerHTML = `\n            <div class=\"empty-state\">\n                <i class=\"fas fa-shopping-cart\"></i>\n                <h3>Keranjang Kosong</h3>\n                <p>Tambah produk ke keranjang untuk mula membeli</p>\n            </div>\n        `;\n        summary.classList.add('hidden');\n        return;\n    }\n    \n    container.innerHTML = cart.map(item => `\n        <div class=\"cart-item\">\n            <div class=\"cart-item-info\">\n                <div class=\"cart-item-name\">${item.name}</div>\n                <div class=\"cart-item-price\">RM ${parseFloat(item.price).toFixed(2)}</div>\n                <div class=\"cart-item-controls\">\n                    <button class=\"qty-btn-small\" onclick=\"updateCartQuantity('${item.id}', -1)\">-</button>\n                    <span class=\"cart-item-qty\">${item.quantity}</span>\n                    <button class=\"qty-btn-small\" onclick=\"updateCartQuantity('${item.id}', 1)\">+</button>\n                    <button class=\"btn-remove\" onclick=\"removeFromCart('${item.id}')\">\n                        <i class=\"fas fa-trash\"></i> Buang\n                    </button>\n                </div>\n            </div>\n        </div>\n    `).join('');\n    \n    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);\n    document.getElementById('subtotal').textContent = `RM ${subtotal.toFixed(2)}`;\n    document.getElementById('total').textContent = `RM ${subtotal.toFixed(2)}`;\n    \n    summary.classList.remove('hidden');\n}\n\nfunction updateCartQuantity(productId, change) {\n    const item = cart.find(i => i.id === productId);\n    if (!item) return;\n    \n    item.quantity += change;\n    \n    if (item.quantity <= 0) {\n        removeFromCart(productId);\n        return;\n    }\n    \n    const product = products.find(p => p.id === productId);\n    if (product && item.quantity > product.stock) {\n        item.quantity = product.stock;\n        showToast('Kuantiti melebihi stok tersedia', 'error');\n    }\n    \n    saveCart();\n    updateCartBadge();\n    renderCart();\n}\n\nfunction removeFromCart(productId) {\n    cart = cart.filter(item => item.id !== productId);\n    saveCart();\n    updateCartBadge();\n    renderCart();\n    showToast('Item dibuang dari keranjang', 'success');\n}\n\nfunction showCheckoutModal() {\n    if (cart.length === 0) {\n        showToast('Keranjang kosong', 'error');\n        return;\n    }\n    \n    const itemsHtml = cart.map(item => `\n        <div class=\"checkout-item\">\n            <span>${item.name} (x${item.quantity})</span>\n            <span>RM ${(item.price * item.quantity).toFixed(2)}</span>\n        </div>\n    `).join('');\n    \n    document.getElementById('checkoutItems').innerHTML = itemsHtml;\n    \n    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);\n    document.getElementById('checkoutTotal').textContent = `RM ${total.toFixed(2)}`;\n    \n    document.getElementById('checkoutModal').classList.add('active');\n}\n\nasync function submitOrder() {\n    const paymentProof = document.getElementById('paymentProof').files[0];\n    \n    if (!paymentProof) {\n        showToast('Sila muat naik bukti pembayaran', 'error');\n        return;\n    }\n    \n    const formData = new FormData();\n    formData.append('user_id', currentUser.id);\n    formData.append('items', JSON.stringify(cart));\n    formData.append('total', cart.reduce((sum, item) => sum + (item.price * item.quantity), 0));\n    formData.append('payment_proof', paymentProof);\n    \n    try {\n        const response = await fetch(`${API_BASE}/api/customer/orders`, {\n            method: 'POST',\n            body: formData\n        });\n        \n        const data = await response.json();\n        \n        if (data.success) {\n            cart = [];\n            saveCart();\n            updateCartBadge();\n            closeModal('checkoutModal');\n            switchSection('orders');\n            loadOrders();\n            showToast('Pesanan berjaya dihantar!', 'success');\n        } else {\n            showToast(data.message || 'Gagal membuat pesanan', 'error');\n        }\n    } catch (error) {\n        console.error('Error submitting order:', error);\n        showToast('Gagal membuat pesanan', 'error');\n    }\n}\n\nasync function loadOrders() {\n    if (!currentUser) return;\n    \n    try {\n        const response = await fetch(`${API_BASE}/api/customer/orders/${currentUser.id}`);\n        const data = await response.json();\n        \n        if (data.success) {\n            orders = data.orders;\n            renderOrders();\n        }\n    } catch (error) {\n        console.error('Error loading orders:', error);\n    }\n}\n\nfunction renderOrders(status = 'all') {\n    const container = document.getElementById('ordersList');\n    let filteredOrders = orders;\n    \n    if (status !== 'all') {\n        filteredOrders = orders.filter(order => order.status === status);\n    }\n    \n    if (filteredOrders.length === 0) {\n        container.innerHTML = `\n            <div class=\"empty-state\">\n                <i class=\"fas fa-receipt\"></i>\n                <h3>Tiada pesanan</h3>\n                <p>Anda belum membuat sebarang pesanan</p>\n            </div>\n        `;\n        return;\n    }\n    \n    container.innerHTML = filteredOrders.map(order => `\n        <div class=\"order-card\">\n            <div class=\"order-header\">\n                <div class=\"order-id\">#${order.id}</div>\n                <div class=\"order-status ${order.status}\">${getStatusText(order.status)}</div>\n            </div>\n            <div class=\"order-items\">\n                ${order.items.map(item => `\n                    <div class=\"order-item\">${item.name} (x${item.quantity})</div>\n                `).join('')}\n            </div>\n            <div class=\"order-total\">Jumlah: RM ${parseFloat(order.total).toFixed(2)}</div>\n            <div class=\"order-date\">${new Date(order.createdAt).toLocaleDateString('ms-MY')}</div>\n        </div>\n    `).join('');\n}\n\nfunction getStatusText(status) {\n    const statusMap = {\n        'pending': 'Belum Bayar',\n        'processing': 'Diproses',\n        'completed': 'Selesai',\n        'rejected': 'Ditolak'\n    };\n    return statusMap[status] || status;\n}\n\nasync function sendChatMessage(message, image = null) {\n    if (!currentUser) return;\n    \n    const formData = new FormData();\n    formData.append('user_id', currentUser.id);\n    formData.append('message', message);\n    formData.append('sender', 'customer');\n    \n    if (image) {\n        formData.append('image', image);\n    }\n    \n    try {\n        const response = await fetch(`${API_BASE}/api/customer/chat/send`, {\n            method: 'POST',\n            body: formData\n        });\n        \n        const data = await response.json();\n        \n        if (data.success) {\n            addMessageToChat({\n                sender: 'customer',\n                message: message,\n                image: image ? URL.createObjectURL(image) : null,\n                timestamp: new Date().toISOString()\n            });\n            document.getElementById('chatInput').value = '';\n        }\n    } catch (error) {\n        console.error('Error sending message:', error);\n        showToast('Gagal menghantar mesej', 'error');\n    }\n}\n\nasync function loadChatMessages() {\n    if (!currentUser) return;\n    \n    try {\n        const response = await fetch(`${API_BASE}/api/customer/chat/${currentUser.id}`);\n        const data = await response.json();\n        \n        if (data.success && data.messages) {\n            chatMessages = data.messages;\n            renderChatMessages();\n        }\n    } catch (error) {\n        console.error('Error loading chat messages:', error);\n    }\n}\n\nfunction renderChatMessages() {\n    const container = document.getElementById('chatMessages');\n    \n    if (chatMessages.length === 0) {\n        container.innerHTML = `\n            <div class=\"chat-welcome\">\n                <i class=\"fas fa-headset\"></i>\n                <h3>Selamat Datang ke Sokongan Pelanggan</h3>\n                <p>Hantar mesej untuk berhubung dengan pasukan sokongan kami</p>\n            </div>\n        `;\n        return;\n    }\n    \n    container.innerHTML = chatMessages.map(msg => {\n        const isSent = msg.sender === 'customer';\n        return `\n            <div class=\"chat-message ${isSent ? 'sent' : ''}\">\n                <div class=\"chat-avatar\">\n                    <i class=\"fas fa-${isSent ? 'user' : 'headset'}\"></i>\n                </div>\n                <div class=\"chat-bubble\">\n                    ${msg.message}\n                    ${msg.image ? `<img src=\"${msg.image}\" class=\"chat-image\" alt=\"Image\">` : ''}\n                    <div class=\"chat-time\">${new Date(msg.timestamp).toLocaleTimeString('ms-MY', {hour: '2-digit', minute: '2-digit'})}</div>\n                </div>\n            </div>\n        `;\n    }).join('');\n    \n    container.scrollTop = container.scrollHeight;\n}\n\nfunction addMessageToChat(message) {\n    chatMessages.push(message);\n    renderChatMessages();\n}\n\nfunction startChatPolling() {\n    loadChatMessages();\n    chatPollingInterval = setInterval(loadChatMessages, 5000);\n}\n\nfunction stopChatPolling() {\n    if (chatPollingInterval) {\n        clearInterval(chatPollingInterval);\n        chatPollingInterval = null;\n    }\n}\n\nfunction switchSection(sectionName) {\n    document.querySelectorAll('.content-section').forEach(section => {\n        section.classList.remove('active');\n    });\n    \n    document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(item => {\n        item.classList.remove('active');\n    });\n    \n    document.getElementById(`${sectionName}Section`).classList.add('active');\n    document.querySelectorAll(`[data-section=\"${sectionName}\"]`).forEach(item => {\n        item.classList.add('active');\n    });\n    \n    if (sectionName === 'cart') {\n        renderCart();\n    } else if (sectionName === 'orders') {\n        loadOrders();\n    } else if (sectionName === 'chat') {\n        loadChatMessages();\n    }\n}\n\nfunction closeModal(modalId) {\n    document.getElementById(modalId).classList.remove('active');\n}\n\nfunction logout() {\n    localStorage.removeItem('customer_user');\n    localStorage.removeItem('customer_cart');\n    currentUser = null;\n    cart = [];\n    stopChatPolling();\n    showLoginPage();\n    showToast('Log keluar berjaya', 'success');\n}\n\nfunction loadUserData() {\n    const joinedDate = getFromLocalStorage('customer_joined_date');\n    if (joinedDate) {\n        document.getElementById('profileJoined').textContent = `Bergabung: ${new Date(joinedDate).toLocaleDateString('ms-MY')}`;\n    } else {\n        const now = new Date().toISOString();\n        saveToLocalStorage('customer_joined_date', now);\n        document.getElementById('profileJoined').textContent = `Bergabung: ${new Date(now).toLocaleDateString('ms-MY')}`;\n    }\n}\n\ndocument.addEventListener('DOMContentLoaded', () => {\n    checkAuth();\n    \n    document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(item => {\n        item.addEventListener('click', () => {\n            const section = item.getAttribute('data-section');\n            switchSection(section);\n        });\n    });\n    \n    document.getElementById('logoutBtn').addEventListener('click', logout);\n    document.getElementById('settingsLogoutBtn').addEventListener('click', logout);\n    \n    document.getElementById('productSearch').addEventListener('input', (e) => {\n        const searchTerm = e.target.value.toLowerCase();\n        const filtered = products.filter(p => \n            p.name.toLowerCase().includes(searchTerm) ||\n            (p.description && p.description.toLowerCase().includes(searchTerm))\n        );\n        renderProducts(filtered);\n    });\n    \n    document.getElementById('categoryFilter').addEventListener('change', (e) => {\n        const categoryId = e.target.value;\n        if (categoryId === 'all') {\n            renderProducts();\n        } else {\n            const filtered = products.filter(p => p.category === categoryId || p.categoryId === categoryId);\n            renderProducts(filtered);\n        }\n    });\n    \n    document.getElementById('checkoutBtn').addEventListener('click', showCheckoutModal);\n    \n    document.getElementById('submitPaymentBtn').addEventListener('click', submitOrder);\n    \n    document.querySelectorAll('.filter-tab').forEach(tab => {\n        tab.addEventListener('click', () => {\n            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));\n            tab.classList.add('active');\n            const status = tab.getAttribute('data-status');\n            renderOrders(status);\n        });\n    });\n    \n    document.getElementById('sendBtn').addEventListener('click', () => {\n        const input = document.getElementById('chatInput');\n        const message = input.value.trim();\n        if (message) {\n            sendChatMessage(message);\n        }\n    });\n    \n    document.getElementById('chatInput').addEventListener('keypress', (e) => {\n        if (e.key === 'Enter') {\n            const message = e.target.value.trim();\n            if (message) {\n                sendChatMessage(message);\n            }\n        }\n    });\n    \n    document.getElementById('attachBtn').addEventListener('click', () => {\n        document.getElementById('fileInput').click();\n    });\n    \n    document.getElementById('fileInput').addEventListener('change', (e) => {\n        const file = e.target.files[0];\n        if (file) {\n            sendChatMessage('', file);\n        }\n    });\n    \n    document.querySelectorAll('.modal-close').forEach(btn => {\n        btn.addEventListener('click', () => {\n            btn.closest('.modal').classList.remove('active');\n        });\n    });\n    \n    document.querySelectorAll('.modal').forEach(modal => {\n        modal.addEventListener('click', (e) => {\n            if (e.target === modal) {\n                modal.classList.remove('active');\n            }\n        });\n    });\n    \n    document.getElementById('increaseQty').addEventListener('click', () => {\n        const input = document.getElementById('quantity');\n        const max = parseInt(input.max);\n        const current = parseInt(input.value);\n        if (current < max) {\n            input.value = current + 1;\n        }\n    });\n    \n    document.getElementById('decreaseQty').addEventListener('click', () => {\n        const input = document.getElementById('quantity');\n        const current = parseInt(input.value);\n        if (current > 1) {\n            input.value = current - 1;\n        }\n    });\n    \n    document.querySelectorAll('input[name=\"language\"]').forEach(radio => {\n        radio.addEventListener('change', (e) => {\n            const lang = e.target.value;\n            saveToLocalStorage('customer_language', lang);\n            showToast('Bahasa dikemaskini', 'success');\n        });\n    });\n});\n","size_bytes":25171},"ADMIN_PANEL_SUGGESTIONS.md":{"content":"# üìã 20 Cadangan Fungsi Admin Panel\n\nBerikut adalah 20 cadangan fungsi tambahan untuk Web Admin Panel yang boleh meningkatkan kecekapan pengurusan sistem anda:\n\n## 1. üìä Dashboard Analytics Real-time\n**Fungsi:** Paparan statistik langsung seperti jualan hari ini, pelawat aktif, conversion rate, dan trending products.\n**Manfaat:** Admin dapat melihat prestasi kedai secara real-time tanpa perlu refresh berkali-kali.\n\n## 2. üîî Notification Center\n**Fungsi:** Pusat notifikasi untuk semua aktiviti penting seperti order baru, stok rendah, pembayaran pending, dan mesej customer.\n**Manfaat:** Tidak terlepas pandang notifikasi penting dan boleh bertindak cepat.\n\n## 3. üéØ Customer Segmentation\n**Fungsi:** Kategorikan pelanggan mengikut tier (VIP, Regular, Baru, Inactive) berdasarkan nilai pembelian dan kekerapan.\n**Manfaat:** Boleh buat targeted marketing dan reward program untuk pelanggan setia.\n\n## 4. üí≥ Payment Gateway Integration\n**Fungsi:** Integrasi dengan FPX, Touch n Go eWallet, GrabPay untuk auto-verify payment.\n**Manfiat:** Kurangkan kerja manual verify payment dan faster order processing.\n\n## 5. üìà Sales Forecast & Prediction\n**Fungsi:** AI-based prediction untuk ramalan jualan minggu/bulan akan datang berdasarkan trend history.\n**Manfaat:** Boleh plan stock dan promosi dengan lebih baik.\n\n## 6. üéÅ Loyalty Points System\n**Fungsi:** Sistem reward points untuk pelanggan. Setiap pembelian dapat points yang boleh ditukar dengan diskaun atau produk percuma.\n**Manfaat:** Tingkatkan customer retention dan repeat purchases.\n\n## 7. üì¶ Multi-warehouse Management\n**Fungsi:** Urus stock di berbilang lokasi/warehouse dengan real-time sync.\n**Manfaat:** Untuk bisnes yang berkembang dengan berbilang lokasi stok.\n\n## 8. üîÑ Auto-restock Alert & Purchase Order\n**Fungsi:** Auto create purchase order apabila stock mencapai minimum threshold, dengan vendor management.\n**Manfaat:** Prevent stockout dan streamline procurement process.\n\n## 9. üì± Customer Chat History\n**Fungsi:** Simpan dan display semua chat history dengan setiap pelanggan untuk reference.\n**Manfaat:** Better customer service dengan context dari previous conversations.\n\n## 10. üèÜ Staff Performance Tracking\n**Fungsi:** Track performance admin/staff (orders processed, response time, customer ratings).\n**Manfaat:** Identify top performers dan area untuk improvement.\n\n## 11. üé® Product Bundle Creator\n**Fungsi:** Buat bundle packages (combo deals) dengan harga special dan auto-calculate margins.\n**Manfaat:** Tingkatkan average order value dengan bundle offers.\n\n## 12. üìä Competitor Price Monitoring\n**Fungsi:** Monitor harga competitor untuk produk sama dan dapat alert jika competitor turunkan harga.\n**Manfaat:** Stay competitive dalam pricing strategy.\n\n## 13. üîê 2FA & Security Logs\n**Fungsi:** Two-factor authentication untuk admin login dan detailed security activity logs.\n**Manfaat:** Protect admin panel dari unauthorized access.\n\n## 14. üìß Email Marketing Automation\n**Fungsi:** Auto-send email untuk abandoned cart, birthday discount, new product launch, re-engagement campaigns.\n**Manfaat:** Automate marketing dan increase conversions without manual work.\n\n## 15. üì± WhatsApp Business Integration\n**Fungsi:** Auto-send order confirmations, shipping updates, dan promotional messages via WhatsApp.\n**Manfaat:** Higher engagement rate compared to Telegram sahaja.\n\n## 16. üí∞ Invoice & Receipt Generator\n**Fungsi:** Auto-generate professional invoices dan receipts dalam PDF format dengan company branding.\n**Manfaat:** Lebih professional dan boleh email terus kepada customer.\n\n## 17. üéØ A/B Testing Dashboard\n**Fungsi:** Test berbeza version product description, images, atau pricing untuk optimize conversion.\n**Manfaat:** Data-driven decision making untuk improve sales.\n\n## 18. üì¶ Return & Refund Management\n**Fungsi:** System untuk manage product returns, refund requests, dan exchange dengan approval workflow.\n**Manfaat:** Structured process untuk handle customer complaints dan returns.\n\n## 19. üåê Multi-language Support\n**Fungsi:** Support berbilang bahasa untuk product descriptions dan customer interactions (Malay, English, Chinese, etc).\n**Manfaat:** Reach wider market dan cater to different demographics.\n\n## 20. ü§ñ AI Chatbot Assistant\n**Fungsi:** Chatbot yang boleh jawab FAQ automatically dan hanya escalate kepada human admin jika perlu.\n**Manfaat:** Reduce workload admin dan provide 24/7 instant customer support.\n\n---\n\n## üîí Nota Keselamatan (Security)\n\nSemua fungsi yang dicadangkan di atas **TIDAK akan menjejaskan secrets** kerana:\n\n1. ‚úÖ Authentication & authorization tetap diperlukan untuk semua fungsi\n2. ‚úÖ Secrets (API keys, tokens) disimpan dengan selamat dalam environment variables\n3. ‚úÖ Tiada fungsi yang expose atau log out sensitive information\n4. ‚úÖ Semua payment gateway integration menggunakan secure HTTPS\n5. ‚úÖ Admin activity logs untuk audit trail dan accountability\n\n---\n\n## üí° Cadangan Implementasi\n\n**Priority High (Implement First):**\n- Dashboard Analytics Real-time\n- Customer Segmentation  \n- Payment Gateway Integration\n- Invoice Generator\n- Return & Refund Management\n\n**Priority Medium:**\n- Loyalty Points System\n- WhatsApp Integration\n- Email Marketing Automation\n- Customer Chat History\n- Staff Performance Tracking\n\n**Priority Low (Future Enhancement):**\n- Sales Forecast & Prediction\n- Multi-warehouse Management\n- Competitor Price Monitoring\n- A/B Testing Dashboard\n- AI Chatbot Assistant\n\n---\n\n*Dokumen ini dibuat pada November 2025 untuk membantu perancangan pengembangan Admin Panel.*\n","size_bytes":5592}},"version":2}